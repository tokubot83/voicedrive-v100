# アカウントレベル定義変更 影響範囲調査報告書

**文書番号**: ALIA-YYYY-MMDD-XXX
**調査日**: YYYY-MM-DD
**調査者**: [医療チーム / VoiceDriveチーム]
**対象変更**: [変更提案書番号]（例: ALCP-2025-1010-001）

---

## エグゼクティブサマリー

【3行で影響範囲を要約】

---

## 1. 影響範囲サマリー

### 1.1 影響度マトリックス

| 項目 | 医療システム | VoiceDrive | 影響度 | 工数見積 | リスク |
|------|------------|-----------|--------|---------|--------|
| **DB設計** | ⚠️ 高 | ⚠️ 高 | **高** | 8時間 | データ移行失敗 |
| **API仕様** | ⚠️ 高 | ⚠️ 高 | **高** | 6時間 | 互換性破壊 |
| **権限ロジック** | 🟡 中 | 🟡 中 | **中** | 4時間 | 権限チェック失敗 |
| **UI表示** | - | 🟡 中 | **中** | 3時間 | 表示エラー |
| **ドキュメント** | 🟢 低 | 🟢 低 | **低** | 2時間 | - |
| **合計** | - | - | - | **23時間** | - |

### 1.2 影響ユーザー数

| 対象 | ユーザー数 | 影響内容 |
|------|----------|---------|
| **医療システム利用者** | XXX名 | XXX |
| **VoiceDrive利用者** | YYY名 | YYY |
| **合計** | XXX+YYY名 | - |

---

## 2. データベース影響分析

### 2.1 影響テーブル

#### テーブル1: `unified_staff_master`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **影響カラム** | `voicedrive_account_level`, `can_perform_leader_duty`, etc. |
| **影響レコード数** | 推定XXX件 |
| **マイグレーション必要性** | [要 / 不要] |
| **ダウンタイム** | [要（XX分） / 不要] |

#### マイグレーションSQL（サンプル）

```sql
-- 既存データの移行
UPDATE unified_staff_master
SET voicedrive_account_level = XXX
WHERE position_id = 'YYY' AND facility_id = 'ZZZ';

-- 新カラム追加（必要な場合）
ALTER TABLE unified_staff_master
ADD COLUMN new_field VARCHAR(50);
```

#### テーブル2: `account_integration`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **影響カラム** | XXX |
| **影響レコード数** | 推定XXX件 |
| **マイグレーション必要性** | [要 / 不要] |

### 2.2 データベース変更スケジュール

| ステップ | 実施内容 | 担当 | 所要時間 | リスク |
|---------|---------|------|---------|--------|
| 1. バックアップ | 全テーブルバックアップ | 医療チーム | 10分 | 低 |
| 2. マイグレーション | SQL実行 | 医療チーム | 5分 | 中 |
| 3. 検証 | データ整合性確認 | 両チーム | 15分 | 低 |
| 4. ロールバック（失敗時） | バックアップから復元 | 医療チーム | 10分 | 低 |

---

## 3. API影響分析

### 3.1 影響エンドポイント

#### API1: `POST /api/v1/calculate-level`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **互換性** | [後方互換あり / 破壊的変更] |
| **リクエスト変更** | [あり / なし] |
| **レスポンス変更** | [あり / なし] |
| **影響クライアント** | VoiceDrive, 医療システム内部 |

**変更前のリクエスト**:
```json
{
  "position_id": "chief",
  "profession": "nursing"
}
```

**変更後のリクエスト**:
```json
{
  "position_id": "chief",
  "profession": "nursing",
  "new_field": "XXX"  // 追加
}
```

#### API2: `POST /api/v1/sso/authenticate`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **互換性** | [後方互換あり / 破壊的変更] |
| **JWTペイロード変更** | [あり / なし] |

### 3.2 APIバージョニング戦略

| API | 現行バージョン | 新バージョン | 移行期間 | 廃止予定日 |
|-----|--------------|------------|---------|----------|
| `/api/v1/calculate-level` | v1 | v2 | 3ヶ月 | YYYY-MM-DD |

---

## 4. ロジック影響分析

### 4.1 医療システム側

#### 影響ファイル1: `src/services/accountLevelCalculator.ts`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **変更行数** | XX-YY行目（計ZZ行） |
| **影響関数** | `calculateLevel()`, `isNursingProfession()`, etc. |
| **工数見積** | X時間 |
| **テストケース追加** | XX件 |

**変更箇所（サンプル）**:
```typescript
// Before
if (staff.position === 'chief') {
  return 6;
}

// After
if (staff.position === 'chief') {
  return facilityAdjustmentRequired(staff) ? 7 : 6;
}
```

#### 影響ファイル2: `src/config/accessControl.ts`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **変更行数** | XX-YY行目（計ZZ行） |
| **影響機能** | XXX |
| **工数見積** | X時間 |

### 4.2 VoiceDriveシステム側

#### 影響ファイル1: `src/lib/accountLevelHelpers.ts`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **変更行数** | XX-YY行目（計ZZ行） |
| **影響関数** | `mapLevelToAccountType()`, etc. |
| **工数見積** | X時間 |

#### 影響ファイル2: `src/permissions/config/projectModePermissions.ts`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **変更行数** | XX-YY行目（計ZZ行） |
| **影響権限** | XXX |
| **工数見積** | X時間 |

---

## 5. UI影響分析（VoiceDrive側）

### 5.1 影響ページ/コンポーネント

#### ページ1: `/dashboard`

| 項目 | 詳細 |
|------|------|
| **変更内容** | レベル表示ロジックの更新 |
| **影響コンポーネント** | `AccountLevelBadge`, `PermissionGate`, etc. |
| **工数見積** | X時間 |
| **デザイン変更** | [要 / 不要] |

#### ページ2: `/profile`

| 項目 | 詳細 |
|------|------|
| **変更内容** | XXX |
| **影響コンポーネント** | XXX |
| **工数見積** | X時間 |

### 5.2 表示ロジック変更

**変更前**:
```tsx
<AccountLevelBadge level={user.accountLevel} />
// → "Level 6（主任）"
```

**変更後**:
```tsx
<AccountLevelBadge
  level={user.accountLevel}
  facility={user.facilityId}
/>
// → "Level 7（統括主任 - 立神リハビリ）"
```

---

## 6. テスト影響分析

### 6.1 既存テストケースへの影響

| テストスイート | 影響ケース数 | 修正必要数 | 新規追加数 | 工数見積 |
|-------------|-----------|----------|----------|---------|
| `accountLevel.test.ts` | XX | YY | ZZ | X時間 |
| `permissions.test.ts` | XX | YY | ZZ | X時間 |
| `integration.test.ts` | XX | YY | ZZ | X時間 |

### 6.2 統合テスト計画

| # | テスト内容 | 期待結果 | 優先度 |
|---|----------|---------|--------|
| T001 | 新レベルのマッピング | XXX | 高 |
| T002 | 既存レベルへの影響確認 | XXX | 高 |
| T003 | SSO認証フロー | XXX | 高 |
| T004 | 権限チェックロジック | XXX | 中 |
| T005 | UI表示確認 | XXX | 中 |

---

## 7. パフォーマンス影響分析

### 7.1 影響指標

| 指標 | 現状 | 変更後予測 | 許容値 | 評価 |
|------|------|----------|--------|------|
| API応答時間 | XXX ms | YYY ms | < 200ms | [OK / NG] |
| DB クエリ時間 | XXX ms | YYY ms | < 100ms | [OK / NG] |
| フロントエンド描画時間 | XXX ms | YYY ms | < 300ms | [OK / NG] |

### 7.2 パフォーマンステスト計画

- [ ] 負荷テスト（1000 req/min）
- [ ] ストレステスト（5000 req/min）
- [ ] 長時間稼働テスト（24時間）

---

## 8. セキュリティ影響分析

### 8.1 影響項目

| 項目 | 影響内容 | リスク | 対策 |
|------|---------|--------|------|
| 認証 | XXX | [高/中/低] | XXX |
| 認可 | XXX | [高/中/低] | XXX |
| データ保護 | XXX | [高/中/低] | XXX |

### 8.2 監査ログ

| 項目 | 記録内容 |
|------|---------|
| **変更前レベル** | XXX |
| **変更後レベル** | YYY |
| **変更実施者** | ZZZ |
| **変更日時** | YYYY-MM-DD HH:MM:SS |

---

## 9. ドキュメント影響分析

### 9.1 更新対象ドキュメント

| ドキュメント | 変更内容 | 工数見積 | 担当 |
|------------|---------|---------|------|
| マスタープラン | Phase 0.5更新 | 2時間 | 医療チーム |
| API仕様書 | エンドポイント追加 | 3時間 | 医療チーム |
| ユーザーガイド | 新レベル説明追加 | 2時間 | VDチーム |
| `unified-account-level-definition.json` | レベル追加 | 1時間 | 両チーム |

---

## 10. リスク分析

### 10.1 技術的リスク

| # | リスク | 発生確率 | 影響度 | 対策 | 担当 |
|---|--------|---------|--------|------|------|
| R001 | データ移行失敗 | 中 | 高 | バックアップ＋ロールバック計画 | 医療チーム |
| R002 | API互換性破壊 | 低 | 高 | バージョニング実施 | 医療チーム |
| R003 | 権限チェック失敗 | 中 | 中 | 統合テスト230ケース実施 | 両チーム |
| R004 | UI表示エラー | 低 | 中 | E2Eテスト実施 | VDチーム |

### 10.2 ビジネスリスク

| # | リスク | 発生確率 | 影響度 | 対策 | 担当 |
|---|--------|---------|--------|------|------|
| B001 | ユーザー混乱 | 中 | 中 | 事前通知・ガイド作成 | 両チーム |
| B002 | 運用停止 | 低 | 高 | 深夜メンテナンス実施 | 医療チーム |

---

## 11. ロールバック計画

### 11.1 ロールバック手順

```bash
# Step 1: サービス停止
sudo systemctl stop medical-api
sudo systemctl stop voicedrive

# Step 2: データベースロールバック
mysql -u root -p < backup_YYYYMMDD_HHMMSS.sql

# Step 3: コードロールバック
git revert <commit_hash>
git push origin main

# Step 4: サービス再起動
sudo systemctl start medical-api
sudo systemctl start voicedrive

# Step 5: 動作確認
curl http://localhost:8080/api/health
curl http://localhost:3000/api/health
```

### 11.2 ロールバック判断基準

| 条件 | 判断 |
|------|------|
| データ移行失敗率 > 5% | 即座にロールバック |
| API エラー率 > 1% | 即座にロールバック |
| ユーザークレーム > 10件 | 状況確認後判断 |

---

## 12. 推奨事項

### 12.1 実装順序

1. **Phase 1: DB設計変更**（医療チーム主導）
   - マイグレーションSQL作成
   - ステージング環境でテスト
   - 本番環境反映

2. **Phase 2: API実装**（医療チーム主導）
   - API変更実装
   - バージョニング設定
   - 統合テスト

3. **Phase 3: VoiceDrive実装**（VDチーム主導）
   - 型定義更新
   - ロジック変更
   - UI更新

4. **Phase 4: 統合テスト**（両チーム）
   - 230ケーステスト実施
   - E2Eテスト

### 12.2 テスト重点項目

1. **新レベルのマッピング検証**（最重要）
2. **既存レベルへの影響確認**（重要）
3. **SSO認証フロー**（重要）
4. **権限チェックロジック**（重要）
5. **UI表示確認**（中）

### 12.3 その他推奨事項

- 深夜メンテナンスウィンドウ（AM 2:00-4:00）での実施を推奨
- 事前にユーザー通知（1週間前）
- ロールバック手順の事前リハーサル実施

---

## 13. 結論

### 13.1 実装可否判定

| 項目 | 評価 |
|------|------|
| **技術的実現可能性** | [可能 / 困難 / 不可能] |
| **リスクレベル** | [低 / 中 / 高] |
| **工数** | 合計XX時間（医療XX時間、VDYY時間） |
| **総合判定** | [実装推奨 / 条件付き推奨 / 再検討推奨] |

### 13.2 次のアクション

- [ ] 統合ミーティング開催（YYYY-MM-DD）
- [ ] 変更提案書の承認
- [ ] 実装スケジュール確定
- [ ] テスト計画策定

---

## 14. 承認

| チーム | 承認者 | 日付 | ステータス |
|--------|--------|------|----------|
| 医療チーム | XXX | YYYY-MM-DD | [承認待ち / 承認 / 却下] |
| VoiceDriveチーム | YYY | YYYY-MM-DD | [承認待ち / 承認 / 却下] |

---

**調査者署名**

氏名: ___________
所属: ___________
日付: YYYY-MM-DD
