# 議題モード統合テスト計画

**作成日**: 2025年10月19日

---

## 1. テスト実施可能性

### VoiceDriveシステム単独での実施可否

**結論**: ✅ **単独でテスト可能**（制限あり）

### テスト可能範囲

| 機能 | 単独テスト可否 | 備考 |
|-----|--------------|------|
| 判断処理ロジック | ✅ 可能 | AgendaDecisionService全メソッド |
| DB更新 | ✅ 可能 | Prisma経由でPostテーブル更新 |
| API呼び出し | ✅ 可能 | `/api/agenda/decision`エンドポイント |
| UI表示 | ✅ 可能 | ボタン表示、モーダル表示 |
| 通知送信 | ⚠️ 部分的 | NotificationService呼び出しは動作するが、ユーザーリストが空 |
| 実際の通知配信 | ❌ 未実装 | ユーザー取得ロジックがTODO |

---

## 2. 事前準備

### 2.1 Prisma Migrate実行

```bash
# Schema変更をDBに適用
npm run prisma:migrate

# または
npx prisma migrate dev --name add-agenda-decision-fields
```

### 2.2 テストデータ準備

```sql
-- テストユーザー作成（各レベル）
INSERT INTO User (id, employeeId, email, name, department, facilityId, permissionLevel, accountType)
VALUES
  ('test-supervisor-1', 'SUP001', 'supervisor@test.com', '主任テスト太郎', '看護部A病棟', 'facility-1', 3.5, 'staff'),
  ('test-manager-1', 'MGR001', 'manager@test.com', '師長テスト花子', '看護部A病棟', 'facility-1', 7, 'staff'),
  ('test-deputy-1', 'DEP001', 'deputy@test.com', '副看護部長テスト', '看護部', 'facility-1', 8, 'staff'),
  ('test-affairs-1', 'AFF001', 'affairs@test.com', '事務長テスト', '総務部', 'facility-1', 11, 'staff'),
  ('test-director-1', 'DIR001', 'director@test.com', '法人統括事務局長テスト', '法人本部', 'facility-1', 18, 'executive');

-- テスト投稿作成（50点の投稿）
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus)
VALUES
  ('test-post-50', 'proposal', 'テスト投稿：50点到達', 'test-author-1', 'full', 'active', 50, 'DEPT_AGENDA', 'pending');

-- テスト投稿作成（100点の投稿）
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus)
VALUES
  ('test-post-100', 'proposal', 'テスト投稿：100点到達', 'test-author-1', 'full', 'active', 100, 'FACILITY_AGENDA', 'pending_deputy_director_review');
```

---

## 3. テストケース

### 3.1 Level 3.5（主任）の判断テスト

#### テストケース 1-1: 師長に推薦

**前提条件**:
- 投稿ID: `test-post-50`
- agendaScore: 50
- agendaStatus: `pending`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50",
    "decisionType": "recommend_to_manager",
    "deciderId": "test-supervisor-1",
    "reason": "部署全体で検討する価値があると判断しました。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "師長への推薦が完了しました",
  "post": {
    "id": "test-post-50",
    "agendaStatus": "recommended_to_manager",
    "agendaDecisionBy": "test-supervisor-1",
    "agendaDecisionReason": "部署全体で検討する価値があると判断しました。"
  },
  "notificationsSent": 2
}
```

**検証項目**:
- [ ] `agendaStatus`が`recommended_to_manager`に更新
- [ ] `agendaDecisionBy`が`test-supervisor-1`に設定
- [ ] `agendaDecisionAt`が現在時刻に設定
- [ ] `agendaDecisionReason`が保存
- [ ] 投稿者と師長に通知送信（ログ確認）

---

#### テストケース 1-2: 主任による却下

**前提条件**:
- 投稿ID: `test-post-50-reject`
- agendaScore: 50
- agendaStatus: `pending`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50-reject",
    "decisionType": "reject_by_supervisor",
    "deciderId": "test-supervisor-1",
    "reason": "実現可能性が低いと判断しました。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "却下が完了しました",
  "post": {
    "agendaStatus": "rejected_by_supervisor",
    "status": "rejected"
  },
  "notificationsSent": 1
}
```

**検証項目**:
- [ ] `agendaStatus`が`rejected_by_supervisor`に更新
- [ ] `status`が`rejected`に更新
- [ ] 投稿者のみに通知送信

---

### 3.2 Level 7（師長）の判断テスト

#### テストケース 2-1: 部署議題承認

**前提条件**:
- 投稿ID: `test-post-50-recommended`
- agendaStatus: `recommended_to_manager`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50-recommended",
    "decisionType": "approve_as_dept_agenda",
    "deciderId": "test-manager-1",
    "reason": "部署の重要課題として取り上げます。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "部署議題として承認されました",
  "post": {
    "agendaStatus": "approved_as_dept_agenda",
    "agendaLevel": "DEPT_AGENDA"
  },
  "notificationsSent": 5
}
```

**検証項目**:
- [ ] `agendaStatus`が`approved_as_dept_agenda`に更新
- [ ] `agendaLevel`が`DEPT_AGENDA`に設定
- [ ] 投稿者と部署内全員に通知送信

---

#### テストケース 2-2: 施設議題に昇格

**前提条件**:
- 投稿ID: `test-post-50-escalate`
- agendaStatus: `recommended_to_manager`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50-escalate",
    "decisionType": "escalate_to_facility",
    "deciderId": "test-manager-1",
    "reason": "施設全体で検討すべき重要課題です。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "施設議題に昇格しました",
  "post": {
    "agendaStatus": "escalated_to_facility",
    "agendaLevel": "FACILITY_AGENDA",
    "agendaVotingDeadline": "2026-01-18T..." // 60日後
  }
}
```

**検証項目**:
- [ ] `agendaStatus`が`escalated_to_facility`に更新
- [ ] `agendaLevel`が`FACILITY_AGENDA`に更新
- [ ] `agendaVotingDeadline`が60日後に設定
- [ ] 施設内全職員に通知送信

---

### 3.3 Level 8（副看護部長）の判断テスト

#### テストケース 3-1: 委員会提出承認

**前提条件**:
- 投稿ID: `test-post-100`
- agendaScore: 100
- agendaStatus: `pending_deputy_director_review`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-100",
    "decisionType": "approve_for_committee",
    "deciderId": "test-deputy-1",
    "reason": "医療安全委員会で議論すべき内容です。",
    "committeeId": "safety-committee"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "委員会提出が承認されました",
  "post": {
    "agendaStatus": "approved_for_committee"
  }
}
```

**検証項目**:
- [ ] `agendaStatus`が`approved_for_committee`に更新
- [ ] 施設内全職員に通知送信

---

#### テストケース 3-2: 却下（救済フロー発動）

**前提条件**:
- 投稿ID: `test-post-100-reject`
- agendaScore: 100
- agendaStatus: `pending_deputy_director_review`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-100-reject",
    "decisionType": "reject_by_deputy_director",
    "deciderId": "test-deputy-1",
    "reason": "施設議題としては優先度が低いと判断しました。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "却下されました。師長による救済待ちです",
  "post": {
    "agendaStatus": "pending_rescue_by_manager"
  }
}
```

**検証項目**:
- [ ] `agendaStatus`が`pending_rescue_by_manager`に更新
- [ ] 師長に救済判断の通知送信

---

### 3.4 救済フローテスト

#### テストケース 4-1: 師長による救済承認

**前提条件**:
- 投稿ID: `test-post-100-rescue`
- agendaStatus: `pending_rescue_by_manager`

**実行**:
```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-100-rescue",
    "decisionType": "rescue_as_dept_agenda",
    "deciderId": "test-manager-1",
    "reason": "部署レベルでは重要な課題なので救済します。"
  }'
```

**期待結果**:
```json
{
  "success": true,
  "message": "部署議題として承認されました（救済）",
  "post": {
    "agendaStatus": "approved_as_dept_agenda",
    "agendaLevel": "DEPT_AGENDA",
    "agendaRescueLevel": 7
  }
}
```

**検証項目**:
- [ ] `agendaStatus`が`approved_as_dept_agenda`に更新
- [ ] `agendaRescueLevel`が`7`に設定
- [ ] 部署内全員に通知送信

---

## 4. UIテスト

### 4.1 ボタン表示テスト

#### テストケース 5-1: Level 3.5（主任）のボタン表示

**実行手順**:
1. 主任アカウントでログイン（`test-supervisor-1`）
2. 投稿管理画面を開く
3. 50点の投稿を表示

**期待結果**:
- [ ] ✅ 師長に推薦ボタンが表示される
- [ ] ❌ 却下ボタンが表示される
- [ ] 他のボタンは表示されない

---

#### テストケース 5-2: Level 7（師長）のボタン表示

**実行手順**:
1. 師長アカウントでログイン（`test-manager-1`）
2. 投稿管理画面を開く
3. `recommended_to_manager`ステータスの投稿を表示

**期待結果**:
- [ ] ✅ 部署議題承認ボタンが表示される
- [ ] ⬆️ 施設議題に昇格ボタンが表示される
- [ ] ❌ 却下ボタンが表示される

---

#### テストケース 5-3: 救済フロー時のボタン表示

**実行手順**:
1. 師長アカウントでログイン
2. `pending_rescue_by_manager`ステータスの投稿を表示

**期待結果**:
- [ ] ✅ 部署議題承認ボタンが表示される（救済）
- [ ] ❌ 完全却下ボタンが表示される
- [ ] 🆘 救済判断が必要ですというメッセージが表示される

---

### 4.2 モーダル表示テスト

#### テストケース 6-1: 判断理由入力モーダル

**実行手順**:
1. ✅ 師長に推薦ボタンをクリック
2. モーダルが開く

**期待結果**:
- [ ] モーダルタイトルに「✅ 師長に推薦」が表示
- [ ] 投稿タイトルが表示
- [ ] 判断理由入力欄が表示（必須）
- [ ] キャンセルボタンと送信ボタンが表示

---

#### テストケース 6-2: 委員会選択モーダル（Level 8）

**実行手順**:
1. 副看護部長アカウントでログイン
2. ✅ 委員会提出承認ボタンをクリック

**期待結果**:
- [ ] 判断理由入力欄が表示
- [ ] 提出先委員会の選択肢が表示
  - 医療安全委員会
  - 感染対策委員会
  - 医療の質向上委員会
  - 倫理委員会
  - 運営委員会

---

## 5. 通知送信テスト（制限あり）

### 現在の制限事項

⚠️ **ユーザー取得ロジックが未実装**のため、以下のメソッドは空配列を返却:
- `getManagersByDepartment()`
- `getDepartmentMembersByDept()`
- `getDeputyDirectorsByFacility()`
- `getFacilityMembers()`
- `getGeneralAffairsByFacility()`
- `getCorporationMembers()`

### テスト可能範囲

#### テストケース 7-1: 通知サービス呼び出し確認

**実行手順**:
1. 判断を実行
2. サーバーログを確認

**期待結果**:
```
[AgendaLevelNotification] 主任取得: 看護部A病棟
[AgendaLevelNotification] 部署メンバー取得: 看護部A病棟
```

**検証項目**:
- [ ] 通知メソッドが呼び出されている（ログ確認）
- [ ] `notificationsSent`カウントが返却される（現状は0または投稿者のみ）

---

## 6. 完全なテスト実施のための追加実装

### 6.1 ユーザー取得ロジック実装

**対応が必要なメソッド**:

```typescript
// src/services/AgendaLevelNotificationService.ts

private async getManagersByDepartment(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      permissionLevel: 3.5,
      isRetired: false,
    },
  });
}

private async getDepartmentMembersByDept(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      isRetired: false,
    },
  });
}

private async getDeputyDirectorsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 8,
      isRetired: false,
    },
  });
}

private async getFacilityMembers(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      isRetired: false,
    },
  });
}

private async getGeneralAffairsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 11,
      isRetired: false,
    },
  });
}

private async getCorporationMembers(): Promise<User[]> {
  return await prisma.user.findMany({
    where: {
      isRetired: false,
    },
  });
}
```

---

## 7. テスト実施手順

### ステップ1: 環境準備

```bash
# 1. Prisma Migrate実行
npm run prisma:migrate

# 2. 開発サーバー起動
npm run dev
```

### ステップ2: テストデータ投入

```bash
# 3. テストユーザーと投稿を作成
npx prisma studio
# または SQL直接実行
```

### ステップ3: APIテスト実行

```bash
# 4. curlまたはPostmanでAPIテスト実行
# テストケース 1-1から順に実行
```

### ステップ4: UIテスト実行

```bash
# 5. ブラウザで画面確認
# http://localhost:3001/proposal-management
```

### ステップ5: ログ確認

```bash
# 6. サーバーログで通知送信を確認
# コンソールに通知ログが出力される
```

---

## 8. 医療職員管理システムとの統合テスト

### 統合が必要な機能

現状、VoiceDriveシステム単独では以下は完全にテストできません:

1. **実際の通知配信**: ユーザー取得ロジックが未実装
2. **医療システムとのデータ同期**: MCPサーバー経由のデータ連携

### 統合テスト時に必要な作業

1. **ユーザー取得ロジック実装**: 上記6.1の実装
2. **MCPサーバー連携**: 面談タイプ設定などの同期確認
3. **通知配信確認**: 実際のユーザーに通知が届くか確認

---

## 9. まとめ

### VoiceDrive単独でテスト可能

- ✅ **判断処理ロジック**: 完全テスト可能
- ✅ **DB更新**: 完全テスト可能
- ✅ **API呼び出し**: 完全テスト可能
- ✅ **UI表示**: 完全テスト可能
- ⚠️ **通知送信**: 部分的（ログ確認のみ）

### 完全テストに必要な追加実装

- [ ] ユーザー取得ロジック（6.1）
- [ ] テストデータ投入スクリプト
- [ ] E2Eテストスクリプト

### 推奨テストフロー

1. **Phase 1**: VoiceDrive単独で基本動作確認（現在可能）
2. **Phase 2**: ユーザー取得ロジック実装後、通知配信確認
3. **Phase 3**: 医療システムとの統合テスト

---

**結論**:
- VoiceDriveシステム単独で**基本的な統合テストは実施可能**
- 通知配信の完全テストには**ユーザー取得ロジックの実装が必要**
- **推奨**: まずVoiceDrive単独でロジックを検証し、その後ユーザー取得を実装して完全テスト実施
