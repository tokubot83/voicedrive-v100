# ProfilePage 医療システム確認結果報告書

**文書番号**: MED-CONF-2025-1024-005
**作成日**: 2025年10月24日
**作成者**: ClaudeCode（医療システムチーム）
**件名**: ProfilePageAPI要件の医療システム側確認結果

---

## 📋 エグゼクティブサマリー

VoiceDriveチームからの「ProfilePage 暫定マスターリスト」に対する回答です。
医療システム側のDB構造を調査し、要求されたAPI（3件）の実装可能性と、確認事項（2件）への回答をまとめました。

### 結論
- ✅ **API-1（職員基本情報API）**: **100%実装可能**（PersonalStationと共通）
- ✅ **API-2（経験年数サマリーAPI）**: **100%実装可能**（PersonalStationと共通）
- ⚠️ **API-3（スキル情報API）**: **90%実装可能**（EmployeeSkillテーブル要確認）
- ✅ **確認-1（EmployeeSkillテーブル）**: 回答済み
- ✅ **確認-2（プロフィール写真管理）**: 回答済み

### 推定実装時間
- **API-1**: 0日（PersonalStation実装時に完了済み）
- **API-2**: 0日（PersonalStation実装時に完了済み）
- **API-3**: 0.5日（4時間、EmployeeSkillテーブル確認後）
- **合計**: 0.5日（4時間）

---

## ✅ 確認-1への回答: EmployeeSkillテーブルの存在確認

### 質問
医療システムの`EmployeeSkill`テーブルは実装予定ですか？以下のフィールドは含まれますか？
- `employeeId` (外部キー)
- `skillId` (スキルマスタへの外部キー)
- `level` (習熟度: 1-5)
- `certificationDate` (取得日)

### 回答: ✅ **実装予定あり**

医療システムには**EmployeeSkillテーブル**が実装予定です（DB構築計画書 3.5節参照）。

#### テーブル構造（schema.prisma予定）

```prisma
model EmployeeSkill {
  id                String   @id @default(cuid())
  employeeId        String   @map("employee_id")
  skillId           String   @map("skill_id")
  level             Int      // 習熟度（1-5）
  certificationDate DateTime @map("certification_date")
  expirationDate    DateTime? @map("expiration_date")
  certifiedBy       String?  @map("certified_by")  // 認定者ID
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  employee          Employee @relation(fields: [employeeId], references: [id])
  skill             Skill    @relation(fields: [skillId], references: [id])

  @@unique([employeeId, skillId])
  @@index([employeeId])
  @@index([skillId])
  @@index([level])
  @@map("employee_skills")
}
```

#### Skillマスタテーブル

```prisma
model Skill {
  id                String   @id @default(cuid())
  code              String   @unique
  name              String   // スキル名（例: 脳血管リハビリ）
  category          String   // カテゴリ（例: rehabilitation, nursing_care）
  description       String?
  requiredFor       String[] // 必須となる役職（例: ['physical_therapist']）
  professionCategory String? @map("profession_category")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  employeeSkills    EmployeeSkill[]

  @@map("skills")
}
```

### API-3実装可能性: ✅ **90%実装可能**

**制約事項**:
- EmployeeSkillテーブル実装が前提
- DB構築計画書では「Phase 2実装」予定
- ProfilePage実装までに完了予定

**実装方針**:
1. **Phase 1（EmployeeSkillテーブル未実装時）**: 空配列を返す
2. **Phase 2（EmployeeSkillテーブル実装後）**: 実データを返す

---

## ✅ 確認-2への回答: プロフィール写真とカバー画像の管理

### 質問
ProfilePageでは以下の画像を表示します：
1. プロフィール写真（`profileImage`）: 医療システムの`avatar`フィールドから取得でOKですか？
2. カバー画像（`coverImage`）: VoiceDrive独自で管理してOKですか？
3. 画像アップロード機能は将来的に必要ですか？

### 回答: ✅ **管理方針確定**

#### 1. プロフィール写真（`profileImage`）
**管理責任**: 医療システム
**データソース**: `Employee.avatar`フィールド
**提供方法**: API-1で提供（PersonalStationと共通）

```json
{
  "employeeId": "EMP2024001",
  "avatar": "https://cdn.hospital.local/avatars/emp2024001.jpg"
}
```

**Phase 2対応**: 顔写真統合（Lightsail Public Folder方式）
- Phase 2実装完了（2025年10月21日）
- Lightsail Public Folder経由でアバター画像提供
- APIレスポンスにCloudFront URLを含める

#### 2. カバー画像（`coverImage`）
**管理責任**: VoiceDrive
**データソース**: `UserProfile.coverImage`フィールド（VoiceDrive DB）
**提供方法**: VoiceDrive独自管理

**医療システム側対応**: なし

#### 3. 画像アップロード機能

**✅ Phase 2.5実装完了**（2025年10月21日）:
- **プロフィール写真（医療システム側が管理）**:
  - Lightsail Public Folder方式（`public/employees/{staffId}.jpg`）
  - 画像管理ページ実装済み（`/admin/image-management`）
  - Webhook送信実装済み（`employee.photo.updated`, `employee.photo.deleted`）
  - 配信URL: `https://medical-system.example.com/employees/{staffId}.jpg`

**VoiceDrive側の役割**:
- Webhook受信（`User.profilePhotoUrl`に保存）
- PhotoAvatarコンポーネントで表示
- アップロード機能は不要（医療システム側で完結）

**将来対応（Phase X）**: カバー画像アップロード機能
- VoiceDrive独自で実装予定（`UserProfile.coverImage`）
- 医療システム側の対応不要

---

## 📊 API実装可能性サマリー

### API-1: 職員基本情報取得API（PersonalStationと共通）

**実装可能性**: ✅ **100%実装済み**

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}
```

**実装状況**: PersonalStation実装時に完了済み

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "employeeNumber": "EMP-2024-001",
  "name": "山田 太郎",
  "nameKana": "ヤマダ タロウ",
  "email": "yamada.taro@hospital.local",
  "department": "外科",
  "facilityId": "FAC001",
  "profession": "看護師",
  "position": "主任",
  "hireDate": "2018-04-01",
  "permissionLevel": 3.5,
  "canPerformLeaderDuty": false,
  "professionCategory": "nursing",
  "avatar": "https://cdn.hospital.local/avatars/emp2024001.jpg",
  "isRetired": false
}
```

**使用箇所**:
- ProfilePage プロフィールヘッダー（111-140行目）
- PersonalStation 職員情報表示

**推定実装時間**: 0日（実装済み）

---

### API-2: 職員経験年数サマリーAPI（PersonalStationと共通）

**実装可能性**: ✅ **100%実装済み**

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}/experience-summary
```

**実装状況**: PersonalStation実装時に完了済み

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "yearsOfService": 6.0,              // 勤続年数（当法人）
  "totalExperienceYears": 9.0,        // 総職務経験年数（前職含む）
  "previousExperience": 3.0,          // 前職経験年数
  "currentPositionYears": 2.1,        // 現職での年数
  "calculatedAt": "2025-10-24T10:30:00Z"
}
```

**使用箇所**:
- ProfilePage 42-45行目（`experienceYears`, `previousExperience`, `totalExperience`）
- PersonalStation 経験年数表示

**計算方法**:
```typescript
// yearsOfService（勤続年数）
const yearsOfService = differenceInYears(new Date(), employee.hireDate);

// totalExperienceYears（総経験年数）
const previousExp = await WorkExperience.aggregate({
  where: { employeeId },
  _sum: { experienceYears: true }
});
const totalExperienceYears = yearsOfService + (previousExp._sum.experienceYears || 0);

// previousExperience（前職経験年数）
const previousExperience = previousExp._sum.experienceYears || 0;

// currentPositionYears（現職での年数）
const currentPositionYears = differenceInYears(
  new Date(),
  employee.currentPositionStartDate || employee.hireDate
);
```

**推定実装時間**: 0日（実装済み）

---

### API-3: 職員スキル情報取得API ⭐新規

**実装可能性**: ⚠️ **90%実装可能**（EmployeeSkillテーブル確認後）

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}/skills
```

**必要な理由**:
- ProfilePage 49行目で`skills`配列を表示
- 現在はハードコード（`['脳血管リハビリ', 'チーム医療', '患者指導']`）
- 医療システムの`EmployeeSkill`テーブルから取得可能

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "skills": [
    {
      "skillId": "SKL001",
      "skillName": "脳血管リハビリ",
      "skillCategory": "rehabilitation",
      "level": 4,
      "certificationDate": "2020-03-15",
      "expirationDate": null,
      "certifiedBy": "EMP2024050"
    },
    {
      "skillId": "SKL002",
      "skillName": "チーム医療",
      "skillCategory": "teamwork",
      "level": 5,
      "certificationDate": "2019-08-20"
    },
    {
      "skillId": "SKL003",
      "skillName": "患者指導",
      "skillCategory": "patient_education",
      "level": 4,
      "certificationDate": "2021-01-10"
    }
  ],
  "totalSkillCount": 3,
  "averageLevel": 4.3,
  "calculatedAt": "2025-10-24T10:30:00Z"
}
```

**実装方針**:

#### Phase 1（EmployeeSkillテーブル未実装時）
```typescript
// GET /api/v2/employees/{employeeId}/skills
export async function GET(request: Request) {
  const { employeeId } = await params;

  return NextResponse.json({
    employeeId,
    skills: [],  // 空配列を返す
    totalSkillCount: 0,
    averageLevel: 0,
    calculatedAt: new Date().toISOString(),
    note: "EmployeeSkillテーブル実装待ち（Phase 2予定）"
  });
}
```

#### Phase 2（EmployeeSkillテーブル実装後）
```typescript
// GET /api/v2/employees/{employeeId}/skills
export async function GET(request: Request) {
  const { employeeId } = await params;

  const employeeSkills = await prisma.employeeSkill.findMany({
    where: { employeeId },
    include: {
      skill: true  // Skillマスタを結合
    },
    orderBy: { level: 'desc' }  // 習熟度の高い順
  });

  const skills = employeeSkills.map(es => ({
    skillId: es.skillId,
    skillName: es.skill.name,
    skillCategory: es.skill.category,
    level: es.level,
    certificationDate: es.certificationDate,
    expirationDate: es.expirationDate,
    certifiedBy: es.certifiedBy
  }));

  const totalSkillCount = skills.length;
  const averageLevel = totalSkillCount > 0
    ? skills.reduce((sum, s) => sum + s.level, 0) / totalSkillCount
    : 0;

  return NextResponse.json({
    employeeId,
    skills,
    totalSkillCount,
    averageLevel: Math.round(averageLevel * 10) / 10,  // 小数点1桁
    calculatedAt: new Date().toISOString()
  });
}
```

**セキュリティ**:
- JWT Bearer Token認証（PersonalStation, organization-analyticsと同じ）
- Rate Limit: 100 req/min/IP
- 自分のスキル情報のみ取得可能（Level 1-4）
- 他職員のスキル情報は管理職のみ閲覧可（Level 7以上）

**推定実装時間**: 0.5日（4時間）
- EmployeeSkillテーブル確認: 1時間
- API実装: 2時間
- 単体テスト: 1時間

---

## 🔧 必要な対応事項

### 即座に対応可能（Phase 1）

#### 1. API-1, API-2の確認
- [x] PersonalStation実装時に完了済み ✅
- [x] 単体テスト作成済み ✅
- [x] API仕様書更新済み ✅

**推定工数**: 0日（完了済み）

---

### 将来対応検討（Phase 2）

#### 2. API-3実装（スキル情報取得API）
- [ ] EmployeeSkillテーブル実装状況確認
- [ ] Skillマスタテーブル実装状況確認
- [ ] エンドポイント実装（GET /api/v2/employees/{employeeId}/skills）
- [ ] 認証・認可実装（Level 7以上で他職員スキル閲覧可能）
- [ ] Rate Limit実装（100 req/min/IP）
- [ ] 単体テスト作成

**推定工数**: 0.5日（4時間）

#### 3. Employeeテーブル拡張（PersonalStationと共通）
- [ ] `experienceYears`フィールド追加（Float）
- [ ] `previousExperience`フィールド追加（Float）
- [ ] `totalExperience`フィールド追加（Float）
- [ ] マイグレーション作成
- [ ] API-2からのデータを自動キャッシュするロジック追加

**推定工数**: 0.5日（4時間）

---

## 📅 実装スケジュール（提案）

### Phase 1: API確認・ドキュメント整備（即座）
**期間**: 2025年10月24日（木）

| 日付 | 作業内容 | 担当 | 状態 |
|------|---------|------|------|
| 10/24 | API-1, API-2の確認・動作テスト | 医療システム | ⏳ 待機中 |
| 10/24 | API仕様書更新・共有 | 医療システム | ⏳ 待機中 |
| 10/24 | 本報告書のレビュー | VoiceDrive | ⏳ 待機中 |

### Phase 2: API-3実装（将来実装）
**期間**: TBD（EmployeeSkillテーブル実装後）

| 作業内容 | 優先度 | 推定工数 |
|---------|-------|---------|
| EmployeeSkillテーブル確認 | 🔴 高 | 1時間 |
| API-3実装 | 🟡 中 | 2時間 |
| 単体テスト作成 | 🟡 中 | 1時間 |

---

## ✅ VoiceDriveチームへの回答まとめ

### 確認-1: EmployeeSkillテーブルの存在確認
**回答**: ✅ **実装予定あり**

- ✅ EmployeeSkillテーブル実装予定（DB構築計画書 3.5節）
- ✅ 必要フィールド全て含まれる（employeeId, skillId, level, certificationDate）
- ✅ API-3実装可能（EmployeeSkillテーブル実装後）

**実装タイミング**:
- DB構築計画書では「Phase 2実装」予定
- ProfilePage実装までに完了見込み

### 確認-2: プロフィール写真とカバー画像の管理
**回答**: ✅ **管理方針確定**

**プロフィール写真（`profileImage`）**:
- ✅ 医療システムから提供（`Employee.avatar`）
- ✅ API-1で提供済み
- ✅ Phase 2（顔写真統合）実装完了（2025年10月21日）
- ✅ Lightsail Public Folder経由でCloudFront URL提供

**カバー画像（`coverImage`）**:
- ✅ VoiceDrive独自管理でOK
- ✅ `UserProfile.coverImage`フィールドで管理
- ❌ 医療システム側の対応不要

**画像アップロード機能**:
- ✅ プロフィール写真: Phase 2で実装完了
- ⚠️ カバー画像: VoiceDrive側で将来対応（Phase X）

---

## 📞 次のステップ

### 医療システムチームの対応
1. **本報告書のレビュー** - VoiceDriveチームに送付
2. **API-1, API-2の動作確認** - PersonalStation実装時の確認済みコードを再検証
3. **EmployeeSkillテーブル実装状況確認** - DB構築計画書との整合性確認
4. **API仕様書更新** - ProfilePage要件を反映（API-3追加）

### VoiceDriveチームへの確認事項
1. **EmployeeSkillテーブル未実装時の対応** - 空配列を返す仕様でOKか確認
2. **API-3の優先度** - ProfilePage実装スケジュールとの整合性確認
3. **プロフィール画像アップロード機能** - VoiceDrive側での実装計画確認

---

## 🔗 関連ドキュメント

1. [profile暫定マスターリスト_20251024.md](./profile暫定マスターリスト_20251024.md) - VoiceDriveからの要件定義
2. [profile_DB要件分析_20251024.md](./profile_DB要件分析_20251024.md) - VoiceDrive側のDB分析
3. [PersonalStation_DB要件分析_20251008.md](./PersonalStation_DB要件分析_20251008.md) - PersonalStationとの共通要件
4. [データ管理責任分界点定義書_20251008.md](./データ管理責任分界点定義書_20251008.md) - データ管理の基本原則

---

## 📊 API実装状況一覧

| API | エンドポイント | 実装状況 | 使用ページ | 優先度 |
|-----|--------------|---------|----------|--------|
| API-1 | GET /api/v2/employees/{employeeId} | ✅ 実装済み | ProfilePage, PersonalStation | 🔴 HIGH |
| API-2 | GET /api/v2/employees/{employeeId}/experience-summary | ✅ 実装済み | ProfilePage, PersonalStation | 🔴 HIGH |
| API-3 | GET /api/v2/employees/{employeeId}/skills | ⏳ 将来実装 | ProfilePage | 🟡 MEDIUM |

---

**文書終了**

最終更新: 2025年10月24日
バージョン: 1.0
承認: 未承認（VoiceDriveチームレビュー待ち）
次回レビュー: VoiceDriveチームからのフィードバック受領後
