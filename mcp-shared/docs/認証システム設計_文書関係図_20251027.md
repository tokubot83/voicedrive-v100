# 認証システム設計 - 文書関係図

**作成日**: 2025年10月27日
**目的**: 認証システム関連文書の関係性を明確化

---

## 📚 文書の階層構造

```
┌────────────────────────────────────────────────────────────────┐
│                   認証システム設計 全体像                        │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────┴─────────────────────┐
        │                                             │
        ▼                                             ▼
┌──────────────────┐                        ┌──────────────────┐
│  UX設計文書      │                        │  技術設計文書    │
│  (ユーザー視点)  │                        │  (実装視点)      │
└──────────────────┘                        └──────────────────┘
        │                                             │
        ▼                                             ▼
┌──────────────────────────────────────┐  ┌──────────────────────────────────────┐
│ 認証システム フロー詳細説明書        │  │ 認証システム最終設計_QRコード方式   │
│ (改訂版2)                            │  │                                      │
│                                      │  │                                      │
│ 【内容】                             │  │ 【内容】                             │
│ - 新入職員の視点（鈴木さんの物語）   │  │ - データベーススキーマ              │
│ - 人事部の視点（アカウント情報シート)│  │ - API仕様（医療システム側 4本）      │
│ - QRコード + PWA の使い方            │  │ - API仕様（VoiceDrive側 2本）       │
│ - 3つのログイン方法比較              │  │ - セキュリティ仕様                  │
│ - 実際の画面イメージ                 │  │ - PWA実装コード                     │
│                                      │  │ - 実装スケジュール（9週間）         │
│ 【対象読者】                         │  │ - 成功指標（KPI）                   │
│ - 人事部スタッフ                     │  │                                      │
│ - 経営層                             │  │ 【対象読者】                         │
│ - 医療職員（エンドユーザー）         │  │ - 医療システム開発チーム            │
│                                      │  │ - VoiceDrive開発チーム              │
│ 【目的】                             │  │                                      │
│ ✅ ユーザー体験を可視化              │  │ 【目的】                             │
│ ✅ 操作手順を理解してもらう          │  │ ✅ 実装に必要な詳細仕様を提供       │
│ ✅ QRコード方式のメリットを説明      │  │ ✅ 開発者が迷わず実装できる          │
│                                      │  │ ✅ テストケースを明確化              │
└──────────────────────────────────────┘  └──────────────────────────────────────┘
```

---

## 🎯 基本方式の確認

### ✅ 採用方式: **QRコード + PWA（改訂版2）**

改訂版2で提案された以下のフローが**基本方式**として確定しています：

```
【Day 1: 初回セットアップ】
人事部から受け取ったQRコード読み取り
  ↓
自動ログイン（トークン検証）
  ↓
パスワード設定のみ（初期PW入力不要）
  ↓
PWAインストール（ホーム画面に追加）
  ↓
完了！

【Day 2以降: 超簡単ログイン】
ホーム画面のアイコンをタップ
  ↓
自動ログイン（セッション30日間有効）
  ↓
すぐに使える！
```

---

## 📄 各文書の詳細比較

### 文書1: 認証システム フロー詳細説明書（改訂版2）

**ファイル**: `認証システム フロー詳細説明書（改訂版2）`（ユーザー提供）

| 項目 | 内容 |
|-----|------|
| **文書タイプ** | UX設計書 |
| **ページ数** | 約15ページ（推定） |
| **記述スタイル** | ストーリー形式、画面モックアップ |
| **キャラクター** | 鈴木 花子さん（パート看護助手） |
| **重点** | ユーザー体験の可視化 |

**主要セクション**:
1. 改善ポイント（従来 vs 新方式）
2. 新入職員の視点（Day 1, Day 2+）
3. 人事部の視点（アカウント情報シート）
4. 技術仕様（セッション管理、PWA設定）
5. 3つのログイン方法比較

**特徴**:
- 📱 実際の画面イメージが豊富
- 🎭 ユーザーの気持ちに寄り添った説明
- 💡 「なぜQRコード + PWAが良いのか」を説得的に説明

---

### 文書2: 認証システム最終設計_QRコード方式_20251027.md

**ファイル**: `mcp-shared/docs/認証システム最終設計_QRコード方式_20251027.md`

| 項目 | 内容 |
|-----|------|
| **文書タイプ** | 技術設計書 |
| **ページ数** | 約60ページ（1627行） |
| **記述スタイル** | 技術仕様、コード例、API定義 |
| **キャラクター** | なし（技術者向け） |
| **重点** | 実装可能な詳細仕様 |

**主要セクション**:
1. 認証フロー設計（Pattern 1, Pattern 2）
2. データベーススキーマ（4テーブル詳細）
3. API仕様（6本のAPI実装例）
4. PWA実装（manifest.json、Service Worker、コンポーネント）
5. セキュリティ仕様（bcrypt、トークン、Rate Limit）
6. 実装スケジュール（9週間、Phase 1-6）
7. 成功指標（KPI）
8. チェックリスト

**特徴**:
- 💻 実装可能なコード例が豊富
- 🗄️ データベーススキーマが詳細
- 📊 KPI・成功指標まで網羅
- ✅ 実装チェックリストで進捗管理可能

---

## 🔗 文書間の相互参照

### 改訂版2 → 最終設計書

| 改訂版2の内容 | 最終設計書での対応箇所 |
|-------------|---------------------|
| **QRコード読み取り** | Pattern 1: Step 3 |
| **自動ログイン** | Pattern 1: Step 4（API-2実装） |
| **パスワード設定** | Pattern 1: Step 4（API-4実装） |
| **PWAインストール** | Pattern 1: Step 5（PWA実装セクション） |
| **30日間セッション** | セキュリティ仕様 - セッション管理 |
| **アカウント情報シート** | Pattern 1: Step 2 |

### 最終設計書 → 改訂版2

| 最終設計書の内容 | 改訂版2での対応箇所 |
|----------------|-------------------|
| **API-1: generate-onetime-token** | 人事部の視点 - QRコード生成 |
| **API-2: verify-onetime-token** | Step 3: 自動ログイン |
| **API-4: change-password** | Step 2: パスワード設定 |
| **PWAInstallPrompt** | Step 3: PWAインストール案内 |
| **manifest.json** | 技術仕様 - PWA設定 |

---

## 🎯 使い分けガイド

### 改訂版2を使うべき場面

1. **人事部への説明会**
   - 「新入職員にどう説明すればいいか？」
   - 「アカウント情報シートはどう作るか？」

2. **経営層へのプレゼン**
   - 「なぜQRコード + PWAが必要なのか？」
   - 「従来方式との違いは？」

3. **医療職員向けマニュアル**
   - 「初めてVoiceDriveを使う人向けの説明」
   - 「スマホでの操作手順」

4. **ユーザビリティテストの準備**
   - 「テストシナリオ作成」
   - 「期待されるユーザー行動の定義」

---

### 最終設計書を使うべき場面

1. **医療システムチームとの技術協議**
   - 「APIの仕様は？」
   - 「データベーススキーマは？」

2. **VoiceDrive開発チームの実装**
   - 「useAuthフックの実装方法」
   - 「PWAの設定手順」

3. **コードレビュー**
   - 「セキュリティ仕様に準拠しているか？」
   - 「エラーハンドリングは適切か？」

4. **進捗管理**
   - 「Phase 2のタスクは完了したか？」
   - 「チェックリストの確認」

5. **統合テスト計画**
   - 「E2Eテストシナリオ作成」
   - 「KPI測定方法の確認」

---

## 📊 フロー対応表

改訂版2と最終設計書のフローがどう対応しているかを図示：

```
【改訂版2: 新入職員の視点】        【最終設計書: Pattern 1】

Step 1: QRコード読み取り      →   Step 1: 人事部でのアカウント作成
                                  Step 2: アカウント情報シート印刷
                                  Step 3: QRコードスキャン

Step 2: 自動ログイン           →   Step 4: VoiceDrive側処理
                                  - verify-onetime-token API
                                  - Userテーブル作成
                                  - セッション作成

Step 3: パスワード設定         →   Step 4: 続き
                                  - パスワード設定画面表示
                                  - change-password API（省略可能）

Step 4: PWAインストール        →   Step 5: PWAインストール案内
                                  - PWAInstallPrompt表示
                                  - beforeinstallprompt イベント

Step 5: ホーム画面に追加       →   Step 6: ホーム画面にアイコン追加
                                  - manifest.json
                                  - Service Worker

【Day 2以降】                   【セッション管理】
アイコンタップ                 →   autoLogin middleware
自動ログイン                   →   セッション確認（30日間有効）
ダッシュボード表示             →   GET /api/auth/me
```

---

## ✅ 確認事項

### 基本方式の確定事項

1. **QRコード + PWA方式を採用** ✅
2. **初期パスワード入力は不要**（QRコードで自動認証） ✅
3. **パスワード設定のみ必須**（8文字以上、複雑性要件） ✅
4. **セッション有効期限: 30日間** ✅
5. **ホーム画面追加（PWA）を推奨** ✅

### 改訂版2で明示されている重要ポイント

| ポイント | 最終設計書での対応 |
|---------|-----------------|
| **所要時間: 約2分（初回）** | Pattern 1: 約3分 |
| **職員IDは自動入力済み** | セッション管理で実現 |
| **「ログイン状態を保持する」デフォルトON** | cookie.maxAge = 30日 |
| **QRコード有効期限: 24時間** | expiresAt = +24h ✅ |
| **アカウント情報シートは破棄** | セキュリティ仕様に記載 ✅ |

---

## 🎉 まとめ

### 2つの文書の関係性

```
改訂版2（UX設計）
  ↓ 「なぜ・何を」
  │
  │ ユーザー体験を技術仕様に変換
  │
  ↓ 「どのように・詳細に」
最終設計書（技術設計）
```

### 両文書の統合性

✅ **完全に整合している**
- 改訂版2で描かれたUXフローは、最終設計書で技術的に実現可能
- 最終設計書は改訂版2のビジョンを実装レベルで詳細化したもの
- 2つの文書を組み合わせることで、エンドユーザーから開発者までカバー可能

---

## 📞 次のアクション

### 推奨される文書の使い方

1. **医療システムチームへの共有**
   - **主**: 最終設計書
   - **副**: 改訂版2（UX理解のため）

2. **人事部への説明**
   - **主**: 改訂版2
   - **副**: 最終設計書（技術的な質問があった場合）

3. **経営層への報告**
   - **改訂版2のみ**（技術詳細は不要）

4. **開発チームの実装**
   - **最終設計書のみ**（UXは理解済み前提）

---

**作成者**: VoiceDrive開発チーム
**作成日**: 2025年10月27日
**目的**: 2つの認証システム設計文書の関係性を明確化し、適切な使い分けを促進

---

**文書終了**
