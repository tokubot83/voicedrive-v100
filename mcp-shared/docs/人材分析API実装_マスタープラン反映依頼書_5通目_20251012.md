# 人材分析API実装 - マスタープラン反映依頼書

**文書番号**: VD-REQ-2025-1012-005
**作成日**: 2025年10月12日
**作成者**: VoiceDrive開発チーム
**宛先**: 医療職員管理システム開発チーム
**件名**: ProjectTalentAnalyticsPage実装に伴うAPI実装計画のマスタープラン反映依頼

---

## 📋 エグゼクティブサマリー

### 背景

本日（2025年10月12日）、VoiceDrive側で**ProjectTalentAnalyticsPage**（プロジェクト人材分析ページ）のDB要件分析を完了しました。

医療システムチーム様からは「**医療システムチーム確認回答書_4通目_20251012.md**」にて、以下の3つのAPI実装を**Phase 1（2025年10月末まで）**に実施いただける旨のご承認をいただきました：

1. ✅ **API-1: 職種マスタ取得API** (`GET /api/v2/professions`)
2. ✅ **API-2: 部門別人数取得API** (`GET /api/v2/departments/headcount`)
3. ✅ **API-3: 年齢・世代取得API** (`GET /api/v2/employees/{id}/age` + データ同意連携)

### 依頼内容

これらのAPI実装計画を、**共通DB構築後の作業再開指示書（マスタープラン）**に反映していただきたく、依頼いたします。

### 理由

- ✅ **適切な実装タイミングの確保**: 共通DB構築後に円滑に実装を再開できる
- ✅ **両チーム間の認識統一**: マスタープランへの記載により、実装スケジュールが明確化
- ✅ **依存関係の明確化**: 他のPhase（組織構造拡張等）との実装順序を整理
- ✅ **工数見積もりの精度向上**: 医療システムチーム側での事前計画が可能

---

## 🎯 マスタープランへの反映依頼内容

### 追加箇所

**ドキュメント**: `共通DB構築後_作業再開指示書_20250928.md`
**新規セクション**: 「Phase Y: プロジェクト人材分析API実装」

### 推奨実装タイミング

**Phase X（組織構造マスター統合実装）の後に実施**

**理由**:
- Phase XでJobCategoryマスタが整備される
- Phase Xで部門マスタ（OrganizationStructure）が整備される
- Phase Yでこれらのマスタを活用したAPI実装が可能

---

## 📝 マスタープラン追加内容（案）

### Phase Y: プロジェクト人材分析API実装

**実装タイミング**: Phase X（組織構造マスター統合実装）完了後
**実装期間**: 1週間（5営業日）
**担当**: 医療システムチーム + VoiceDriveチーム
**重要度**: 高
**前提条件**: Phase X完了（JobCategoryマスタ、OrganizationStructureマスタ整備済み）

#### 実装概要

VoiceDriveのProjectTalentAnalyticsPage（プロジェクト人材分析ページ）に必要な、職種・部門・年齢データを提供するAPIを実装します。

**実装方針**:
- 職種マスタ、部門マスタは医療システムが管理（Single Source of Truth）
- VoiceDriveはAPI経由でデータ取得し、キャッシュ + 分析ロジック実装
- **データ同意システム連携**: `analyticsConsent = true`の職員のみ年齢データを提供

#### 実装スコープ

##### 医療システム側（3営業日）

| タスク | 工数 | 担当 | 依存Phase |
|--------|------|------|----------|
| **API-1: 職種マスタ取得API実装** | 0.5日 | バックエンドチーム | Phase X |
| **API-2: 部門別人数取得API実装** | 1日 | バックエンドチーム | Phase X |
| **API-3: 年齢・世代取得API実装** | 1日 | バックエンドチーム | なし |
| **日次更新バッチ実装** | 0.5日 | バックエンドチーム | なし |

**実装API**:

```typescript
// API-1: 職種マスタ取得API
GET /api/v2/professions
Response: [
  {
    professionCode: "nurse",
    professionName: "看護師",
    professionGroup: "nursing",
    requiresLicense: true,
    sortOrder: 1,
    isActive: true
  },
  // ...
]

// API-2: 部門別人数取得API
GET /api/v2/departments/headcount
Response: [
  {
    departmentId: "DEPT-NS",
    departmentName: "看護部",
    facilityId: "obara-hospital",
    facilityName: "小原記念病院",
    totalMembers: 320,
    activeMembers: 298,
    retiredMembers: 22,
    onLeaveMembers: 0,
    calculatedAt: "2025-10-12T00:00:00Z"
  },
  // ...
]

// API-3: 年齢・世代取得API（単一）
GET /api/v2/employees/{employeeId}/age
Response: {
  employeeId: "EMP2024001",
  age: 34,
  generation: "30代",
  generationCode: "30s",
  calculatedAt: "2025-10-12"
}

// API-3: 年齢・世代取得API（バッチ）
POST /api/v2/employees/age-batch
Request Body: {
  "employeeIds": ["EMP001", "EMP002", "EMP003"]  // 同意済み職員IDのみ
}
Response: [
  { "employeeId": "EMP001", "age": 28, "generation": "20代", "generationCode": "20s" },
  { "employeeId": "EMP002", "age": 35, "generation": "30代", "generationCode": "30s" },
  { "employeeId": "EMP003", "age": 42, "generation": "40代", "generationCode": "40s" }
]
```

**世代区分ルール**:
- `20代`: 20-29歳 → generationCode: "20s"
- `30代`: 30-39歳 → generationCode: "30s"
- `40代`: 40-49歳 → generationCode: "40s"
- `50代以上`: 50歳以上 → generationCode: "50s_plus"

**🔐 データ同意システム連携（重要）**:

VoiceDrive側には**データ同意システム**が既に実装済みです：
- `DataConsent`テーブルで同意状況を管理
- `analyticsConsent = true`の職員のみ分析対象
- 初回投稿時（議題モード・プロジェクトモード共通）に同意取得

**医療システム側の責任範囲**:
- VoiceDriveから提供される**同意済み職員IDリストのみ**対象
- 未同意職員のIDがリクエストに含まれることはない（VoiceDrive側で事前フィルタリング）
- 年齢データは同意済み職員のみ提供

**日次更新バッチ**:
- 部門別人数: 深夜1:00に集計更新
- 職員入社・退職時にリアルタイム更新

##### VoiceDrive側（2営業日）

| タスク | 工数 | 担当 |
|--------|------|------|
| **医療システムAPIクライアント実装** | 0.5日 | VoiceDriveチーム |
| **年齢データ同期バッチ実装** | 0.5日 | VoiceDriveチーム |
| **ProjectAnalyticsService実装** | 0.5日 | VoiceDriveチーム |
| **DiversityCalculator実装** | 0.5日 | VoiceDriveチーム |

**実装内容**:
- 医療システムAPIクライアント実装（3つのAPI）
- 年齢データ同期バッチ（週次、日曜深夜2:00）
  - `DataConsent.analyticsConsent = true`の職員のみフィルタリング
  - 医療システムAPIに同意済み職員IDのみ送信
  - `User.age`, `User.generation`, `User.ageUpdatedAt`を更新
- ProjectAnalyticsService実装（集計ロジック）
  - `calculateParticipationStats()`: 全体統計計算
  - `calculateProfessionParticipation()`: 職種別統計計算
  - `calculateDepartmentParticipation()`: 部門別統計計算
- DiversityCalculator実装（多様性スコア計算）
  - Simpson's Diversity Index使用
  - 職種多様性（40%）+ 世代多様性（35%）+ 階層多様性（25%）

##### 統合テスト（1営業日）

| テスト項目 | 工数 | 担当 |
|-----------|------|------|
| **API連携テスト** | 0.25日 | 両チーム |
| **データ同意システム連携テスト** | 0.25日 | 両チーム |
| **集計ロジックテスト** | 0.25日 | VoiceDriveチーム |
| **エンドツーエンドテスト** | 0.25日 | 両チーム |

**テスト項目詳細**:
1. **API連携テスト**
   - 職種マスタAPI呼び出し成功
   - 部門別人数API呼び出し成功
   - 年齢・世代API呼び出し成功（単一 + バッチ）

2. **データ同意システム連携テスト**
   - 同意済み職員のみ年齢データ取得
   - 未同意職員は「データ非公開」として処理
   - 同意取り消し後のデータ削除

3. **集計ロジックテスト**
   - 全体統計の正確性
   - 職種別統計の正確性
   - 部門別統計の正確性
   - 多様性スコアの計算精度

4. **エンドツーエンドテスト**
   - ProjectTalentAnalyticsPageでの表示確認
   - 期間フィルタ（月次・四半期・年次）の動作確認
   - UIレスポンス時間 < 500ms

#### 前提条件

- ✅ **Phase X完了**: JobCategoryマスタ、OrganizationStructureマスタ整備済み
- ✅ **共通DBインフラ構築完了**
- ✅ **医療システムのDB接続確認完了**
- ✅ **VoiceDrive側の準備完了**:
  - `User`テーブル拡張完了（age, generation, ageUpdatedAt追加済み）
  - `ProjectParticipationStats`テーブル追加済み
  - `ProjectParticipationByProfession`テーブル追加済み
  - DataConsentシステム実装済み

#### 成功基準

- [ ] API-1（職種マスタ）が24職種を返却
- [ ] API-2（部門別人数）が23部門のデータを返却
- [ ] API-3（年齢・世代）が同意済み職員のみのデータを返却
- [ ] 年齢データ同期バッチが正常稼働（週次）
- [ ] ProjectTalentAnalyticsPageで実データ表示
- [ ] 多様性スコアが正常計算（Simpson's Index）
- [ ] API応答時間 < 200ms
- [ ] データ整合性チェック成功（同意システム連携）

#### リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| **JobCategoryマスタ未整備** | 🔴 高 | Phase X完了待ち（依存関係明確化） |
| **年齢データの週次更新遅延** | 🟡 中 | エラーアラート + Slack通知 |
| **未同意職員の誤データ提供** | 🔴 高 | VoiceDrive側で二重フィルタリング |
| **多様性スコア計算精度** | 🟢 低 | 医療業界での検証、Phase 2で調整 |
| **API応答時間超過** | 🟡 中 | キャッシュ機構（24時間TTL） |

#### Phase Yとの依存関係

```
Phase X: 組織構造マスター統合実装
  ├─ JobCategoryマスタ整備
  ├─ OrganizationStructureマスタ整備
  └─ FacilityMasterマスタ整備
        ↓
Phase Y: プロジェクト人材分析API実装（本Phase）
  ├─ API-1: JobCategoryマスタを活用
  ├─ API-2: OrganizationStructureマスタを活用
  └─ API-3: 独立（生年月日から計算）
        ↓
Phase Z: TalentAnalyticsPage実装（議題モード用）
  └─ Phase Y完成後に実施
```

#### 実装後の運用

**日次バッチ**:
- 部門別人数集計（深夜1:00）
- 職員入社・退職時のリアルタイム更新

**週次バッチ**:
- 年齢データ同期（日曜深夜2:00）
- 同意状況の変更反映
- VoiceDrive `User`テーブル更新

**月次バッチ**:
- プロジェクト参加統計集計
- 多様性スコア再計算
- `ProjectParticipationStats`テーブル更新

**監視項目**:
- API応答時間
- バッチ処理成功率
- データ同意率（モニタリングのみ）
- 多様性スコアの推移

---

## 📊 実装計画の詳細

### 実装スケジュール（Phase Y開始後）

| 日数 | 医療システム側タスク | VoiceDrive側タスク |
|------|-------------------|------------------|
| **1日目** | API-1実装開始（職種マスタ） | APIクライアント設計 |
| **2日目** | API-2実装開始（部門別人数） | 年齢データ同期バッチ設計 |
| **3日目** | API-3実装開始（年齢・世代） | ProjectAnalyticsService実装 |
| **4日目** | 日次更新バッチ実装 | DiversityCalculator実装 |
| **5日目** | 統合テスト | 統合テスト |

### 工数見積もり

| 担当 | 工数 | 内訳 |
|------|------|------|
| **医療システムチーム** | 3営業日 | API実装3日 |
| **VoiceDriveチーム** | 2営業日 | サービス実装2日 |
| **統合テスト** | 1営業日 | 両チーム合同 |
| **合計** | 5営業日 | 1週間 |

---

## 🔗 関連ドキュメント

### VoiceDrive側で既に作成済みのドキュメント

1. **[project-talent-analytics_DB要件分析_20251012.md](./project-talent-analytics_DB要件分析_20251012.md)**
   - 全5章、詳細な技術仕様
   - データ同意システム連携の実装ロジック
   - Simpson's Diversity Index計算ロジック
   - 医療システムチームへの確認事項

2. **[project-talent-analytics暫定マスターリスト_20251012.md](./project-talent-analytics暫定マスターリスト_20251012.md)**
   - 医療システムへのAPI依頼書
   - 実装スケジュール（Phase 1-4）
   - データ同意フィルタリング仕様

3. **[TalentAnalyticsPage_実装メモ_20251012.md](./TalentAnalyticsPage_実装メモ_20251012.md)**
   - 議題モード用の人材分析ページ実装メモ
   - Phase Y完成後に実施予定

### 医療システム側から受領済みのドキュメント

1. **[医療システムチーム確認回答書_4通目_20251012.md](./医療システムチーム確認回答書_4通目_20251012.md)**
   - 3つのAPI実装承認
   - Phase 1（10月末）実装スケジュール
   - Phase 2（12月中旬）兼任職員対応

2. **[組織構造拡張実装_マスタープラン統合回答書_2通目_20251012.md](./組織構造拡張実装_マスタープラン統合回答書_2通目_20251012.md)**
   - Phase X（組織構造マスター統合実装）の詳細
   - 本Phase Yの前提条件となる実装

---

## 🎯 依頼内容まとめ

### 1. マスタープランへの追記

**ドキュメント**: `共通DB構築後_作業再開指示書_20250928.md`

**追加セクション**: 「Phase Y: プロジェクト人材分析API実装」

**実装タイミング**: Phase X完了後

**工数**: 5営業日（医療システム3日 + VoiceDrive2日 + 統合テスト1日）

### 2. Phase X（組織構造マスター統合実装）との関連明記

- Phase XでJobCategoryマスタ整備
- Phase XでOrganizationStructureマスタ整備
- Phase Yでこれらを活用したAPI実装

### 3. データ同意システム連携の記載

- `analyticsConsent = true`の職員のみ年齢データ提供
- VoiceDrive側で事前フィルタリング
- 医療システム側では同意確認不要

---

## 📝 確認事項

### 医療システムチーム様へのご確認

1. **マスタープラン反映可否**
   - 上記の「Phase Y: プロジェクト人材分析API実装」をマスタープランに追記可能でしょうか？

2. **Phase Xとの依存関係**
   - Phase X（組織構造マスター統合実装）完了後にPhase Yを実施する順序で問題ないでしょうか？

3. **工数見積もり**
   - 医療システム側の工数見積もり（3営業日）は妥当でしょうか？

4. **実装タイミング**
   - 共通DB構築完了後、Phase X → Phase Yの順で実施する計画で問題ないでしょうか？

---

## 🚀 期待される効果

### マスタープラン反映による効果

1. **実装スケジュールの明確化**
   - Phase X完了後にPhase Yを実施
   - 両チームで実装タイミングを認識

2. **依存関係の可視化**
   - JobCategoryマスタ → API-1
   - OrganizationStructureマスタ → API-2
   - 独立実装可能 → API-3

3. **工数見積もりの精度向上**
   - 医療システム側: 3営業日
   - VoiceDrive側: 2営業日
   - 統合テスト: 1営業日

4. **リスク管理の強化**
   - 前提条件の明確化
   - リスクと対策の共有

---

## 📞 次のアクション

### VoiceDrive側（現在完了済み）

- ✅ ProjectTalentAnalyticsPage DB要件分析完了
- ✅ schema.prisma更新完了（User拡張、テーブル2件追加）
- ✅ データ同意システムとの連携仕様確定
- ✅ マスタープラン反映依頼書作成完了（本文書）

### 医療システムチーム側（ご確認依頼）

- [ ] 本依頼書のご確認
- [ ] マスタープラン反映可否のご判断
- [ ] Phase Xとの依存関係のご承認
- [ ] 工数見積もりのご確認
- [ ] 反映完了通知（マスタープラン更新後）

### 両チーム合同（共通DB構築後）

- [ ] Phase X実施（組織構造マスター統合実装）
- [ ] Phase Y実施（プロジェクト人材分析API実装）
- [ ] 統合テスト実施
- [ ] Phase Z実施（TalentAnalyticsPage実装）

---

## 📝 まとめ

### 本依頼の目的

ProjectTalentAnalyticsPage実装に必要な3つのAPIを、**共通DB構築後のマスタープラン**に反映していただき、適切なタイミングで円滑に実装を再開できるようにする。

### 医療システムチーム様へのお願い

1. ✅ **マスタープランへの追記承認**
2. ✅ **Phase Xとの依存関係承認**
3. ✅ **工数見積もりの確認**
4. ✅ **実装タイミングの承認**

### 期待される成果

- ✅ 共通DB構築後の円滑な実装再開
- ✅ 両チーム間の認識統一
- ✅ 実装スケジュールの明確化
- ✅ リスク管理の強化

---

**ご確認のほど、よろしくお願いいたします。**

共通DB構築完了後、Phase X → Phase Yの順でスムーズに実装を進められるよう、マスタープランへの反映をお願い申し上げます。

---

**作成日**: 2025-10-12
**バージョン**: 1.0
**ステータス**: 医療システムチーム確認待ち
**確認期限**: 2025年10月18日（金）

**添付資料**:
- [project-talent-analytics_DB要件分析_20251012.md](./project-talent-analytics_DB要件分析_20251012.md)
- [project-talent-analytics暫定マスターリスト_20251012.md](./project-talent-analytics暫定マスターリスト_20251012.md)
- [TalentAnalyticsPage_実装メモ_20251012.md](./TalentAnalyticsPage_実装メモ_20251012.md)
- [医療システムチーム確認回答書_4通目_20251012.md](./医療システムチーム確認回答書_4通目_20251012.md)
- [データ管理責任分界点定義書_20251008.md](./データ管理責任分界点定義書_20251008.md)
