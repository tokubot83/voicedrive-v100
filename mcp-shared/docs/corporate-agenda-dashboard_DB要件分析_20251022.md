# CorporateAgendaDashboardãƒšãƒ¼ã‚¸ DBè¦ä»¶åˆ†æ

**æ–‡æ›¸ç•ªå·**: DB-REQ-2025-1022-002
**ä½œæˆæ—¥**: 2025å¹´10æœˆ22æ—¥
**å¯¾è±¡ãƒšãƒ¼ã‚¸**: https://voicedrive-v100.vercel.app/corporate-agenda-dashboard
**å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ãƒ¬ãƒ™ãƒ«18ï¼ˆç†äº‹é•·ãƒ»æ³•äººäº‹å‹™å±€é•·ï¼‰
**å‚ç…§æ–‡æ›¸**:
- [ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md](./ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md)
- C:\projects\staff-medical-system\docs\DBæ§‹ç¯‰è¨ˆç”»æ›¸å‰æº–å‚™_ä¸è¶³é …ç›®æ•´ç†_20251008.md

---

## ğŸ“‹ åˆ†æã‚µãƒãƒªãƒ¼

### çµè«–
CorporateAgendaDashboardãƒšãƒ¼ã‚¸ã¯**å…¨10æ–½è¨­ã®è­°é¡ŒåŒ–ãƒ—ãƒ­ã‚»ã‚¹ç¨¼åƒçŠ¶æ³**ã‚’çµ±åˆçš„ã«è¡¨ç¤ºã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚ç¾åœ¨ã¯å®Œå…¨ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€**å®Ÿãƒ‡ãƒ¼ã‚¿åŒ–ã«ã¯è¤‡æ•°ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã¨APIãŒå¿…è¦**ã§ã™ã€‚

### ğŸ”´ é‡å¤§ãªä¸è¶³é …ç›®ï¼ˆå³å¯¾å¿œå¿…è¦ï¼‰

1. **æ–½è¨­ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¸è¶³**
   - ç¾åœ¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ10æ–½è¨­ï¼ˆ69-200è¡Œç›®ï¼‰
   - åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã®`FacilityMaster`ã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ã‚ã‚Š

2. **æ–½è¨­åˆ¥çµ±è¨ˆã®é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¸è¶³**
   - ç·æŠ•ç¨¿æ•°ã€å¯¾å¿œä¸­ã€è§£æ±ºæ¸ˆã¿ã€å‚åŠ ç‡ã€å‡¦ç†æ—¥æ•°ã€ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢
   - ç¾åœ¨ã™ã¹ã¦ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆã§ã¯é‡ã™ãã‚‹

3. **æ³•äººå…¨ä½“KPIã®é›†è¨ˆæ©Ÿèƒ½ä¸è¶³**
   - ç·æŠ•ç¨¿æ•°ã€å¹³å‡å‚åŠ ç‡ã€å¹³å‡è§£æ±ºç‡ã€å¹³å‡å‡¦ç†æ—¥æ•°
   - æ–½è¨­æ¨ªæ–­ã§ã®çµ±è¨ˆè¨ˆç®—ãŒå¿…è¦

4. **ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»ç›£è¦–æ©Ÿèƒ½ã®ä¸è¶³**
   - å‚åŠ ç‡ä½ä¸‹ã€å‡¦ç†æ—¥æ•°å¢—åŠ ã€ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ä½ä¸‹ã®æ¤œçŸ¥
   - ç¾åœ¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

---

## ğŸ” è©³ç´°åˆ†æ

### 1. ãƒšãƒ¼ã‚¸æ¦‚è¦ï¼ˆCorporateAgendaDashboardPage.tsxï¼‰

#### å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ãƒ¬ãƒ™ãƒ«18**: ç†äº‹é•·ãƒ»æ³•äººäº‹å‹™å±€é•·
- **ç›®çš„**: å…¨10æ–½è¨­ã®è­°é¡ŒåŒ–ãƒ—ãƒ­ã‚»ã‚¹ç¨¼åƒçŠ¶æ³ã‚’çµ±åˆçš„ã«æŠŠæ¡

#### ä¸»è¦æ©Ÿèƒ½
1. **æ³•äººå…¨ä½“KPIè¡¨ç¤º**ï¼ˆ37-66è¡Œç›®ï¼‰
   - ç·æŠ•ç¨¿æ•°ï¼ˆå…¨æ–½è¨­ï¼‰
   - å¹³å‡å‚åŠ ç‡
   - å¹³å‡è§£æ±ºç‡
   - å¹³å‡å‡¦ç†æ—¥æ•°

2. **æ–½è¨­åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º**ï¼ˆ69-200è¡Œç›®ï¼‰
   - 10æ–½è¨­ãã‚Œãã‚Œã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
   - ç·æŠ•ç¨¿æ•°ã€å¯¾å¿œä¸­ã€è§£æ±ºæ¸ˆã¿
   - å‚åŠ ç‡ã€å‡¦ç†æ—¥æ•°ã€ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢
   - ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆup/down/stableï¼‰

3. **ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»æ³¨æ„äº‹é …**ï¼ˆ242-264è¡Œç›®ï¼‰
   - å‚åŠ ç‡ä½ä¸‹è­¦å‘Š
   - å‡¦ç†æ—¥æ•°å¢—åŠ è­¦å‘Š
   - ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ä½ä¸‹è­¦å‘Š

4. **æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ**ï¼ˆ203-239è¡Œç›®ï¼‰
   - ç·åˆç—…é™¢ã€åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼ã€ãƒªãƒãƒ“ãƒªç—…é™¢ã€ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã€ä»‹è­·æ–½è¨­
   - ã‚¿ã‚¤ãƒ—ã”ã¨ã®å¹³å‡ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã€å¹³å‡å‚åŠ ç‡ã€ç·æŠ•ç¨¿æ•°

5. **ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°**ï¼ˆ378-412è¡Œç›®ï¼‰
   - å…¨æ–½è¨­ã‚’ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
   - Top 5æ–½è¨­ã‚’è¡¨ç¤º

6. **å…¨æ–½è¨­è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«**ï¼ˆ414-466è¡Œç›®ï¼‰
   - å…¨10æ–½è¨­ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€è¦§è¡¨ç¤º

---

### 2. æ³•äººå…¨ä½“KPIï¼ˆ37-66è¡Œç›®ï¼‰

#### è¡¨ç¤ºå†…å®¹
```typescript
const corporateKPIs: KPISummary[] = [
  {
    label: 'ç·æŠ•ç¨¿æ•°ï¼ˆå…¨æ–½è¨­ï¼‰',
    value: '12,847',        // ãƒ€ãƒŸãƒ¼
    change: '+8.2%',        // ãƒ€ãƒŸãƒ¼
    trend: 'up',
    status: 'good'
  },
  {
    label: 'å¹³å‡å‚åŠ ç‡',
    value: '64.3%',         // ãƒ€ãƒŸãƒ¼
    change: '+2.1%',
    trend: 'up',
    status: 'good'
  },
  {
    label: 'å¹³å‡è§£æ±ºç‡',
    value: '58.7%',         // ãƒ€ãƒŸãƒ¼
    change: '-1.3%',
    trend: 'down',
    status: 'warning'
  },
  {
    label: 'å¹³å‡å‡¦ç†æ—¥æ•°',
    value: '26.4æ—¥',        // ãƒ€ãƒŸãƒ¼
    change: '-3.8æ—¥',
    trend: 'up',
    status: 'good'
  }
];
```

#### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

| è¡¨ç¤ºé …ç›® | ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»» | ç¾åœ¨ã®çŠ¶æ…‹ | å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«/API | çŠ¶æ…‹ |
|---------|--------------|-----------|------------------|------|
| ç·æŠ•ç¨¿æ•° | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| å¹³å‡å‚åŠ ç‡ | VoiceDrive + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  | âŒ ãƒ€ãƒŸãƒ¼ | `User`é›†è¨ˆ + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API | ğŸ”´ **è¦å®Ÿè£…** |
| å¹³å‡è§£æ±ºç‡ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| å¹³å‡å‡¦ç†æ—¥æ•° | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`æ—¥ä»˜è¨ˆç®— | ğŸ”´ **è¦å®Ÿè£…** |
| å‰æœˆæ¯”è¼ƒ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ | ğŸ”´ **è¦å®Ÿè£…** |

#### è§£æ±ºç­–1: æ³•äººå…¨ä½“KPIé›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `CorporateKPI`**
```prisma
model CorporateKPI {
  id                    String    @id @default(cuid())

  // æœŸé–“
  periodStart           DateTime  @map("period_start")
  periodEnd             DateTime  @map("period_end")
  periodType            String    @map("period_type")
  // "daily", "weekly", "monthly", "quarterly", "yearly"

  // æŠ•ç¨¿çµ±è¨ˆ
  totalPosts            Int       @default(0) @map("total_posts")
  totalPostsPrevious    Int       @default(0) @map("total_posts_previous")
  totalPostsChange      Float     @default(0) @map("total_posts_change")

  // å‚åŠ ç‡çµ±è¨ˆ
  avgParticipationRate  Float     @default(0) @map("avg_participation_rate")
  avgParticipationPrev  Float     @default(0) @map("avg_participation_prev")
  participationChange   Float     @default(0) @map("participation_change")

  // è§£æ±ºç‡çµ±è¨ˆ
  avgResolutionRate     Float     @default(0) @map("avg_resolution_rate")
  avgResolutionPrev     Float     @default(0) @map("avg_resolution_prev")
  resolutionChange      Float     @default(0) @map("resolution_change")

  // å‡¦ç†æ—¥æ•°çµ±è¨ˆ
  avgProcessDays        Float     @default(0) @map("avg_process_days")
  avgProcessDaysPrev    Float     @default(0) @map("avg_process_days_prev")
  processDaysChange     Float     @default(0) @map("process_days_change")

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  calculatedAt          DateTime  @default(now()) @map("calculated_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([periodStart, periodEnd, periodType])
  @@index([periodStart])
  @@index([periodType])
  @@map("corporate_kpi")
}
```

**é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// src/services/CorporateKPIService.ts
export async function calculateCorporateKPI(
  periodStart: Date,
  periodEnd: Date
): Promise<CorporateKPISummary> {
  // å…¨æ–½è¨­ã®æŠ•ç¨¿ã‚’é›†è¨ˆ
  const posts = await prisma.post.findMany({
    where: {
      createdAt: {
        gte: periodStart,
        lte: periodEnd
      }
    },
    include: {
      author: {
        select: { facilityId: true }
      }
    }
  });

  const totalPosts = posts.length;

  // è§£æ±ºæ¸ˆã¿æŠ•ç¨¿
  const resolvedPosts = posts.filter(p =>
    p.status === 'CLOSED' || p.resolvedAt !== null
  ).length;

  const avgResolutionRate = totalPosts > 0
    ? (resolvedPosts / totalPosts) * 100
    : 0;

  // å‡¦ç†æ—¥æ•°è¨ˆç®—
  const processedPosts = posts.filter(p => p.resolvedAt !== null);
  const avgProcessDays = processedPosts.length > 0
    ? processedPosts.reduce((sum, p) => {
        const days = (p.resolvedAt!.getTime() - p.createdAt.getTime())
          / (1000 * 60 * 60 * 24);
        return sum + days;
      }, 0) / processedPosts.length
    : 0;

  // å‚åŠ ç‡è¨ˆç®—ï¼ˆå…¨è·å“¡æ•°ãŒå¿…è¦ - åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å–å¾—ï¼‰
  const totalEmployees = await getTotalEmployeeCount(); // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API
  const activeUsers = await prisma.user.count({
    where: {
      lastLoginAt: {
        gte: periodStart
      }
    }
  });

  const avgParticipationRate = totalEmployees > 0
    ? (activeUsers / totalEmployees) * 100
    : 0;

  return {
    totalPosts,
    avgParticipationRate,
    avgResolutionRate,
    avgProcessDays
  };
}
```

---

### 3. æ–½è¨­åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ69-200è¡Œç›®ï¼‰

#### è¡¨ç¤ºå†…å®¹
```typescript
interface FacilityStatus {
  id: string;
  name: string;
  type: string;
  totalVoices: number;      // ç·æŠ•ç¨¿æ•°
  activeVoices: number;     // å¯¾å¿œä¸­
  resolvedVoices: number;   // è§£æ±ºæ¸ˆã¿
  participationRate: number; // å‚åŠ ç‡ï¼ˆ%ï¼‰
  avgProcessTime: number;    // å¹³å‡å‡¦ç†æ—¥æ•°
  healthScore: number;       // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
  lastUpdated: string;
  trend: 'up' | 'down' | 'stable';
}

// ç¾åœ¨ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ10æ–½è¨­
const facilities: FacilityStatus[] = [
  {
    id: 'F001',
    name: 'ä¸­å¤®ç·åˆç—…é™¢',
    type: 'ç·åˆç—…é™¢',
    totalVoices: 3247,      // ãƒ€ãƒŸãƒ¼
    activeVoices: 487,
    resolvedVoices: 1842,
    participationRate: 72,
    avgProcessTime: 24,
    healthScore: 85,
    lastUpdated: '2æ™‚é–“å‰',
    trend: 'up'
  },
  // ... ä»¥ä¸‹9æ–½è¨­
];
```

#### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

| ãƒ‡ãƒ¼ã‚¿é …ç›® | ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»» | ç¾åœ¨ã®çŠ¶æ…‹ | å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«/API | çŠ¶æ…‹ |
|-----------|--------------|-----------|------------------|------|
| æ–½è¨­ãƒã‚¹ã‚¿ | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  | âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `FacilityMaster` | ğŸ”´ **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIå¿…è¦** |
| ç·æŠ•ç¨¿æ•° | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| å¯¾å¿œä¸­ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| è§£æ±ºæ¸ˆã¿ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| å‚åŠ ç‡ | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  + VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | è·å“¡æ•°API + ãƒ­ã‚°ã‚¤ãƒ³çµ±è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |
| å‡¦ç†æ—¥æ•° | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `Post`æ—¥ä»˜è¨ˆç®— | ğŸ”´ **è¦å®Ÿè£…** |
| ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | ç‹¬è‡ªè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ | ğŸ”´ **è¦å®Ÿè£…** |
| ãƒˆãƒ¬ãƒ³ãƒ‰ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | æ™‚ç³»åˆ—æ¯”è¼ƒ | ğŸ”´ **è¦å®Ÿè£…** |

#### è§£æ±ºç­–2: æ–½è¨­åˆ¥çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `FacilityStatistics`**
```prisma
model FacilityStatistics {
  id                    String    @id @default(cuid())
  facilityId            String    @map("facility_id")

  // æœŸé–“
  periodStart           DateTime  @map("period_start")
  periodEnd             DateTime  @map("period_end")
  periodType            String    @map("period_type")
  // "daily", "weekly", "monthly"

  // æŠ•ç¨¿çµ±è¨ˆ
  totalPosts            Int       @default(0) @map("total_posts")
  activePosts           Int       @default(0) @map("active_posts")
  resolvedPosts         Int       @default(0) @map("resolved_posts")

  // å‚åŠ çµ±è¨ˆ
  totalEmployees        Int       @default(0) @map("total_employees")
  activeUsers           Int       @default(0) @map("active_users")
  participationRate     Float     @default(0) @map("participation_rate")

  // å‡¦ç†çµ±è¨ˆ
  avgProcessDays        Float     @default(0) @map("avg_process_days")
  medianProcessDays     Float     @default(0) @map("median_process_days")
  maxProcessDays        Int       @default(0) @map("max_process_days")

  // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰
  healthScore           Float     @default(0) @map("health_score")
  healthScorePrevious   Float     @default(0) @map("health_score_previous")

  // ãƒˆãƒ¬ãƒ³ãƒ‰
  trend                 String    @default("stable") @map("trend")
  // "up", "down", "stable"

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  calculatedAt          DateTime  @default(now()) @map("calculated_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([facilityId, periodStart, periodEnd, periodType])
  @@index([facilityId])
  @@index([periodStart])
  @@index([healthScore])
  @@map("facility_statistics")
}
```

**ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// src/services/FacilityHealthScoreService.ts
export function calculateHealthScore(stats: {
  participationRate: number;
  avgProcessDays: number;
  totalPosts: number;
  resolvedPosts: number;
}): number {
  // å‚åŠ ç‡ã‚¹ã‚³ã‚¢ï¼ˆ40ç‚¹æº€ç‚¹ï¼‰
  const participationScore = Math.min(40, (stats.participationRate / 80) * 40);

  // è§£æ±ºç‡ã‚¹ã‚³ã‚¢ï¼ˆ30ç‚¹æº€ç‚¹ï¼‰
  const resolutionRate = stats.totalPosts > 0
    ? (stats.resolvedPosts / stats.totalPosts) * 100
    : 0;
  const resolutionScore = Math.min(30, (resolutionRate / 70) * 30);

  // å‡¦ç†é€Ÿåº¦ã‚¹ã‚³ã‚¢ï¼ˆ30ç‚¹æº€ç‚¹ã€30æ—¥ä»¥å†…ãŒæº€ç‚¹ï¼‰
  const processScore = stats.avgProcessDays <= 30
    ? 30 - (stats.avgProcessDays / 30) * 10
    : 20 - Math.min(10, (stats.avgProcessDays - 30) / 10);

  return Math.round(participationScore + resolutionScore + processScore);
}
```

---

### 4. æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆï¼ˆ203-239è¡Œç›®ï¼‰

#### è¡¨ç¤ºå†…å®¹
```typescript
const facilityTypeStats = [
  {
    type: 'ç·åˆç—…é™¢',
    count: 2,
    avgHealthScore: 83,
    avgParticipation: 70.5,
    totalVoices: 5381
  },
  // ... ä»–4ã‚¿ã‚¤ãƒ—
];
```

#### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

| ãƒ‡ãƒ¼ã‚¿é …ç›® | ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»» | ç¾åœ¨ã®çŠ¶æ…‹ | å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«/API | çŠ¶æ…‹ |
|-----------|--------------|-----------|------------------|------|
| æ–½è¨­ã‚¿ã‚¤ãƒ— | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  | âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `FacilityMaster.type` | ğŸ”´ **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIå¿…è¦** |
| ã‚¿ã‚¤ãƒ—åˆ¥é›†è¨ˆ | VoiceDrive | âŒ ãƒ€ãƒŸãƒ¼ | `FacilityStatistics`é›†è¨ˆ | ğŸ”´ **è¦å®Ÿè£…** |

#### è§£æ±ºç­–3: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–½è¨­ãƒã‚¹ã‚¿ã‚’å–å¾—

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API**:
```typescript
// åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ : GET /api/facilities
{
  "facilities": [
    {
      "id": "facility-001",
      "code": "OH",
      "name": "å°åŸç—…é™¢",
      "type": "ç·åˆç—…é™¢",
      "address": "...",
      "totalEmployees": 450,
      "isActive": true
    },
    // ... å…¨10æ–½è¨­
  ]
}
```

**VoiceDriveå´ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«**:
```prisma
model Facility {
  id              String    @id @default(cuid())
  facilityCode    String    @unique @map("facility_code")
  facilityName    String    @map("facility_name")
  facilityType    String    @map("facility_type")
  // "ç·åˆç—…é™¢", "åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼", "ãƒªãƒãƒ“ãƒªç—…é™¢", "ã‚¯ãƒªãƒ‹ãƒƒã‚¯", "ä»‹è­·æ–½è¨­"

  totalEmployees  Int       @default(0) @map("total_employees")
  isActive        Boolean   @default(true) @map("is_active")

  // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®åŒæœŸ
  syncedAt        DateTime  @default(now()) @map("synced_at")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("facilities")
}
```

---

### 5. ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»æ³¨æ„äº‹é …ï¼ˆ242-264è¡Œç›®ï¼‰

#### è¡¨ç¤ºå†…å®¹
```typescript
const alerts = [
  {
    id: 'alert-1',
    facility: 'è¥¿éƒ¨ä»‹è­·æ–½è¨­',
    type: 'warning',
    message: 'å‚åŠ ç‡ãŒ51%ã«ä½ä¸‹ï¼ˆç›®æ¨™60%ï¼‰',
    timestamp: '2æ™‚é–“å‰'
  },
  {
    id: 'alert-2',
    facility: 'ç·‘ã®æ£®ä»‹è­·ã‚»ãƒ³ã‚¿ãƒ¼',
    type: 'critical',
    message: 'å¹³å‡å‡¦ç†æ—¥æ•°ãŒ38æ—¥ã«å¢—åŠ ï¼ˆç›®æ¨™30æ—¥ä»¥å†…ï¼‰',
    timestamp: '3æ™‚é–“å‰'
  },
  // ...
];
```

#### å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹

| ãƒ‡ãƒ¼ã‚¿é …ç›® | ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»» | ç¾åœ¨ã®çŠ¶æ…‹ | å¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«/API | çŠ¶æ…‹ |
|-----------|--------------|-----------|------------------|------|
| ã‚¢ãƒ©ãƒ¼ãƒˆ | VoiceDrive | âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `FacilityAlert`ï¼ˆæ–°è¦ï¼‰ | ğŸ”´ **è¦å®Ÿè£…** |
| ã—ãã„å€¤ | VoiceDrive | âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | `AlertThreshold`ï¼ˆæ–°è¦ï¼‰ | ğŸ”´ **è¦å®Ÿè£…** |

#### è§£æ±ºç­–4: ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«: `FacilityAlert`**
```prisma
model FacilityAlert {
  id              String    @id @default(cuid())
  facilityId      String    @map("facility_id")

  // ã‚¢ãƒ©ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—
  alertType       String    @map("alert_type")
  // "participation_low", "process_time_high", "health_score_low"

  // é‡è¦åº¦
  severity        String    @map("severity")
  // "info", "warning", "critical"

  // å†…å®¹
  message         String    @db.Text
  currentValue    Float     @map("current_value")
  thresholdValue  Float     @map("threshold_value")

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  isAcknowledged  Boolean   @default(false) @map("is_acknowledged")
  acknowledgedBy  String?   @map("acknowledged_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  detectedAt      DateTime  @default(now()) @map("detected_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([facilityId])
  @@index([alertType])
  @@index([severity])
  @@index([isAcknowledged])
  @@map("facility_alerts")
}

model AlertThreshold {
  id                        String    @id @default(cuid())

  // ã—ãã„å€¤è¨­å®š
  participationRateMin      Float     @default(60) @map("participation_rate_min")
  processTimeDaysMax        Int       @default(30) @map("process_time_days_max")
  healthScoreMin            Float     @default(60) @map("health_score_min")
  resolutionRateMin         Float     @default(50) @map("resolution_rate_min")

  // é©ç”¨ç¯„å›²
  applicableScope           String    @default("all") @map("applicable_scope")
  // "all", "hospital", "clinic", "nursing_home"

  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  @@map("alert_thresholds")
}
```

**ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
// src/services/AlertDetectionService.ts
export async function detectFacilityAlerts(
  facilityId: string,
  stats: FacilityStatistics
): Promise<FacilityAlert[]> {
  const thresholds = await prisma.alertThreshold.findFirst({
    where: { applicableScope: 'all' }
  });

  if (!thresholds) return [];

  const alerts: FacilityAlert[] = [];

  // å‚åŠ ç‡ãƒã‚§ãƒƒã‚¯
  if (stats.participationRate < thresholds.participationRateMin) {
    alerts.push({
      facilityId,
      alertType: 'participation_low',
      severity: stats.participationRate < 40 ? 'critical' : 'warning',
      message: `å‚åŠ ç‡ãŒ${stats.participationRate.toFixed(1)}%ã«ä½ä¸‹ï¼ˆç›®æ¨™${thresholds.participationRateMin}%ï¼‰`,
      currentValue: stats.participationRate,
      thresholdValue: thresholds.participationRateMin
    });
  }

  // å‡¦ç†æ—¥æ•°ãƒã‚§ãƒƒã‚¯
  if (stats.avgProcessDays > thresholds.processTimeDaysMax) {
    alerts.push({
      facilityId,
      alertType: 'process_time_high',
      severity: stats.avgProcessDays > 45 ? 'critical' : 'warning',
      message: `å¹³å‡å‡¦ç†æ—¥æ•°ãŒ${Math.round(stats.avgProcessDays)}æ—¥ã«å¢—åŠ ï¼ˆç›®æ¨™${thresholds.processTimeDaysMax}æ—¥ä»¥å†…ï¼‰`,
      currentValue: stats.avgProcessDays,
      thresholdValue: thresholds.processTimeDaysMax
    });
  }

  // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯
  if (stats.healthScore < thresholds.healthScoreMin) {
    alerts.push({
      facilityId,
      alertType: 'health_score_low',
      severity: stats.healthScore < 40 ? 'critical' : 'warning',
      message: `ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãŒ${Math.round(stats.healthScore)}ã«ä½ä¸‹`,
      currentValue: stats.healthScore,
      thresholdValue: thresholds.healthScoreMin
    });
  }

  return alerts;
}
```

---

## ğŸ“‹ å¿…è¦ãªè¿½åŠ ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

### 1. VoiceDriveå´ã§è¿½åŠ ãŒå¿…è¦

#### ğŸ”´ å„ªå…ˆåº¦: é«˜ï¼ˆå³å¯¾å¿œï¼‰

**A. FacilityStatisticsï¼ˆæ–½è¨­åˆ¥çµ±è¨ˆï¼‰**
```prisma
model FacilityStatistics {
  id                  String    @id @default(cuid())
  facilityId          String
  periodStart         DateTime
  periodEnd           DateTime
  periodType          String
  totalPosts          Int       @default(0)
  activePosts         Int       @default(0)
  resolvedPosts       Int       @default(0)
  totalEmployees      Int       @default(0)
  activeUsers         Int       @default(0)
  participationRate   Float     @default(0)
  avgProcessDays      Float     @default(0)
  healthScore         Float     @default(0)
  trend               String    @default("stable")
  calculatedAt        DateTime  @default(now())

  @@unique([facilityId, periodStart, periodEnd, periodType])
  @@map("facility_statistics")
}
```

**ç†ç”±**:
- CorporateAgendaDashboardã®ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é›†è¨ˆã§ã¯é‡ã™ãã‚‹
- æ—¥æ¬¡ãƒãƒƒãƒã§æ›´æ–°

**B. CorporateKPIï¼ˆæ³•äººå…¨ä½“KPIï¼‰**
```prisma
model CorporateKPI {
  id                    String    @id @default(cuid())
  periodStart           DateTime
  periodEnd             DateTime
  periodType            String
  totalPosts            Int       @default(0)
  totalPostsChange      Float     @default(0)
  avgParticipationRate  Float     @default(0)
  participationChange   Float     @default(0)
  avgResolutionRate     Float     @default(0)
  resolutionChange      Float     @default(0)
  avgProcessDays        Float     @default(0)
  processDaysChange     Float     @default(0)
  calculatedAt          DateTime  @default(now())

  @@unique([periodStart, periodEnd, periodType])
  @@map("corporate_kpi")
}
```

**ç†ç”±**:
- æ³•äººå…¨ä½“KPIè¡¨ç¤ºã«å¿…é ˆ
- å‰æœˆæ¯”è¼ƒè¨ˆç®—ã«å¿…é ˆ

**C. Facilityï¼ˆæ–½è¨­ãƒã‚¹ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰**
```prisma
model Facility {
  id              String    @id @default(cuid())
  facilityCode    String    @unique
  facilityName    String
  facilityType    String
  totalEmployees  Int       @default(0)
  isActive        Boolean   @default(true)
  syncedAt        DateTime  @default(now())

  @@map("facilities")
}
```

**ç†ç”±**:
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã®æ–½è¨­ãƒã‚¹ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤

**D. FacilityAlertï¼ˆæ–½è¨­ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰**
```prisma
model FacilityAlert {
  id              String    @id @default(cuid())
  facilityId      String
  alertType       String
  severity        String
  message         String    @db.Text
  currentValue    Float
  thresholdValue  Float
  isAcknowledged  Boolean   @default(false)
  detectedAt      DateTime  @default(now())

  @@map("facility_alerts")
}
```

**ç†ç”±**:
- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã«å¿…é ˆ
- ç›£è¦–æ©Ÿèƒ½ã®åŸºç›¤

**E. AlertThresholdï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã—ãã„å€¤ï¼‰**
```prisma
model AlertThreshold {
  id                    String    @id @default(cuid())
  participationRateMin  Float     @default(60)
  processTimeDaysMax    Int       @default(30)
  healthScoreMin        Float     @default(60)
  resolutionRateMin     Float     @default(50)
  applicableScope       String    @default("all")

  @@map("alert_thresholds")
}
```

**ç†ç”±**:
- ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã®è¨­å®šç®¡ç†
- æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥ã®ã—ãã„å€¤è¨­å®š

---

### 2. åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã§è¿½åŠ ãŒå¿…è¦

#### ğŸ”´ å„ªå…ˆåº¦: é«˜ï¼ˆå³å¯¾å¿œï¼‰

**F. æ–½è¨­ãƒã‚¹ã‚¿API**
```typescript
// GET /api/facilities
// å…¨æ–½è¨­ã®åŸºæœ¬æƒ…å ±ã‚’æä¾›
{
  "facilities": [
    {
      "id": "facility-001",
      "code": "OH",
      "name": "å°åŸç—…é™¢",
      "type": "ç·åˆç—…é™¢",
      "totalEmployees": 450,
      "isActive": true
    }
  ]
}
```

**G. æ–½è¨­åˆ¥è·å“¡æ•°API**
```typescript
// GET /api/facilities/:id/employee-count
// æ–½è¨­ã”ã¨ã®ç·è·å“¡æ•°ï¼ˆå‚åŠ ç‡è¨ˆç®—ç”¨ï¼‰
{
  "facilityId": "facility-001",
  "totalEmployees": 450,
  "activeEmployees": 420,
  "retiredEmployees": 30
}
```

---

## ğŸ¯ å®Ÿè£…å„ªå…ˆé †ä½

### Phase 1: æ–½è¨­ãƒã‚¹ã‚¿ã¨KPIåŸºç›¤ï¼ˆ2-3æ—¥ï¼‰

**ç›®æ¨™**: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‹ã‚‰å–å¾—

1. ğŸ”´ **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ : æ–½è¨­ãƒã‚¹ã‚¿APIå®Ÿè£…**
   - GET /api/facilities
   - å…¨10æ–½è¨­ã®åŸºæœ¬æƒ…å ±ã‚’è¿”ã™

2. ğŸ”´ **VoiceDrive: Facilityãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ **
   ```bash
   npx prisma migrate dev --name add_facility_master
   ```

3. ğŸ”´ **VoiceDrive: æ–½è¨­ãƒã‚¹ã‚¿åŒæœŸæ©Ÿèƒ½å®Ÿè£…**
   ```typescript
   // src/services/FacilitySyncService.ts
   export async function syncFacilities() {
     const response = await fetch('/api/medical/facilities');
     const { facilities } = await response.json();

     for (const facility of facilities) {
       await prisma.facility.upsert({
         where: { facilityCode: facility.code },
         create: {
           facilityCode: facility.code,
           facilityName: facility.name,
           facilityType: facility.type,
           totalEmployees: facility.totalEmployees,
           isActive: facility.isActive
         },
         update: {
           facilityName: facility.name,
           facilityType: facility.type,
           totalEmployees: facility.totalEmployees,
           isActive: facility.isActive,
           syncedAt: new Date()
         }
       });
     }
   }
   ```

**ã“ã®Phaseã§å‹•ä½œã™ã‚‹æ©Ÿèƒ½**:
- âœ… æ–½è¨­ãƒã‚¹ã‚¿ãŒDBç®¡ç†ã•ã‚Œã‚‹ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
- âš ï¸ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ãƒ€ãƒŸãƒ¼

---

### Phase 2: æ–½è¨­åˆ¥çµ±è¨ˆã®å®Ÿè£…ï¼ˆ3-5æ—¥ï¼‰

**ç›®æ¨™**: æ–½è¨­åˆ¥çµ±è¨ˆã‚’å®Ÿãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º

1. ğŸ”´ **FacilityStatisticsãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ **
   ```bash
   npx prisma migrate dev --name add_facility_statistics
   ```

2. ğŸ”´ **çµ±è¨ˆè¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…**
   ```typescript
   // src/services/FacilityStatisticsService.ts
   export async function calculateFacilityStatistics(
     facilityId: string,
     periodStart: Date,
     periodEnd: Date
   ) {
     // æŠ•ç¨¿çµ±è¨ˆ
     const posts = await prisma.post.findMany({
       where: {
         author: { facilityId },
         createdAt: { gte: periodStart, lte: periodEnd }
       },
       include: { author: true }
     });

     const totalPosts = posts.length;
     const activePosts = posts.filter(p =>
       p.status !== 'CLOSED' && p.resolvedAt === null
     ).length;
     const resolvedPosts = posts.filter(p => p.resolvedAt !== null).length;

     // å‚åŠ ç‡è¨ˆç®—
     const facility = await prisma.facility.findUnique({
       where: { facilityId }
     });
     const totalEmployees = facility?.totalEmployees || 0;

     const activeUsers = await prisma.user.count({
       where: {
         facilityId,
         lastLoginAt: { gte: periodStart }
       }
     });

     const participationRate = totalEmployees > 0
       ? (activeUsers / totalEmployees) * 100
       : 0;

     // å‡¦ç†æ—¥æ•°è¨ˆç®—
     const processedPosts = posts.filter(p => p.resolvedAt !== null);
     const avgProcessDays = processedPosts.length > 0
       ? processedPosts.reduce((sum, p) => {
           const days = (p.resolvedAt!.getTime() - p.createdAt.getTime())
             / (1000 * 60 * 60 * 24);
           return sum + days;
         }, 0) / processedPosts.length
       : 0;

     // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—
     const healthScore = calculateHealthScore({
       participationRate,
       avgProcessDays,
       totalPosts,
       resolvedPosts
     });

     // ä¿å­˜
     await prisma.facilityStatistics.upsert({
       where: {
         facilityId_periodStart_periodEnd_periodType: {
           facilityId,
           periodStart,
           periodEnd,
           periodType: 'daily'
         }
       },
       create: {
         facilityId,
         periodStart,
         periodEnd,
         periodType: 'daily',
         totalPosts,
         activePosts,
         resolvedPosts,
         totalEmployees,
         activeUsers,
         participationRate,
         avgProcessDays,
         healthScore
       },
       update: {
         totalPosts,
         activePosts,
         resolvedPosts,
         totalEmployees,
         activeUsers,
         participationRate,
         avgProcessDays,
         healthScore,
         calculatedAt: new Date()
       }
     });
   }
   ```

3. ğŸ”´ **æ—¥æ¬¡ãƒãƒƒãƒå®Ÿè£…**
   ```typescript
   // src/jobs/calculateFacilityStatistics.ts
   export async function runDailyFacilityStatistics() {
     const facilities = await prisma.facility.findMany({
       where: { isActive: true }
     });

     const today = new Date();
     const yesterday = new Date(today);
     yesterday.setDate(yesterday.getDate() - 1);

     for (const facility of facilities) {
       await calculateFacilityStatistics(
         facility.facilityCode,
         yesterday,
         today
       );
     }
   }
   ```

4. ğŸ”´ **CorporateAgendaDashboardãƒšãƒ¼ã‚¸ä¿®æ­£**
   - ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
   - `FacilityStatistics`ã‹ã‚‰å–å¾—

**ã“ã®Phaseã§å‹•ä½œã™ã‚‹æ©Ÿèƒ½**:
- âœ… æ–½è¨­åˆ¥çµ±è¨ˆãŒå®Ÿãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
- âœ… ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãŒæ­£ç¢ºã«è¨ˆç®—ã•ã‚Œã‚‹
- âœ… ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºï¼ˆå‰æ—¥æ¯”è¼ƒï¼‰

---

### Phase 3: æ³•äººå…¨ä½“KPIã¨ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆ2-3æ—¥ï¼‰

**ç›®æ¨™**: æ³•äººå…¨ä½“KPIã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…

1. ğŸ”´ **CorporateKPIãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ **
   ```bash
   npx prisma migrate dev --name add_corporate_kpi
   ```

2. ğŸ”´ **æ³•äººå…¨ä½“KPIè¨ˆç®—å®Ÿè£…**
   ```typescript
   // src/services/CorporateKPIService.ts
   export async function calculateCorporateKPI(
     periodStart: Date,
     periodEnd: Date
   ) {
     // å…¨æ–½è¨­ã®çµ±è¨ˆã‚’é›†è¨ˆ
     const facilityStats = await prisma.facilityStatistics.findMany({
       where: {
         periodStart,
         periodEnd,
         periodType: 'daily'
       }
     });

     const totalPosts = facilityStats.reduce((sum, s) => sum + s.totalPosts, 0);
     const avgParticipation = facilityStats.reduce((sum, s) =>
       sum + s.participationRate, 0) / facilityStats.length;

     // ... ä»–ã®KPIè¨ˆç®—

     await prisma.corporateKPI.create({
       data: {
         periodStart,
         periodEnd,
         periodType: 'daily',
         totalPosts,
         avgParticipationRate: avgParticipation,
         // ...
       }
     });
   }
   ```

3. ğŸ”´ **ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥å®Ÿè£…**
   ```typescript
   // src/services/AlertDetectionService.ts
   export async function runAlertDetection() {
     const facilities = await prisma.facility.findMany({
       where: { isActive: true }
     });

     for (const facility of facilities) {
       const latestStats = await prisma.facilityStatistics.findFirst({
         where: { facilityId: facility.facilityCode },
         orderBy: { calculatedAt: 'desc' }
       });

       if (!latestStats) continue;

       const alerts = await detectFacilityAlerts(
         facility.facilityCode,
         latestStats
       );

       for (const alert of alerts) {
         await prisma.facilityAlert.create({
           data: alert
         });
       }
     }
   }
   ```

**ã“ã®Phaseã§å‹•ä½œã™ã‚‹æ©Ÿèƒ½**:
- âœ… æ³•äººå…¨ä½“KPIè¡¨ç¤ºï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
- âœ… å‰æœˆæ¯”è¼ƒè¡¨ç¤º
- âœ… ã‚¢ãƒ©ãƒ¼ãƒˆè‡ªå‹•æ¤œçŸ¥
- âœ… ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤º

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

### ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆPhase 0ï¼‰
```
CorporateAgendaDashboard
  â†“ è¡¨ç¤º
ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
  - 10æ–½è¨­ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
  - KPIï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
  - ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
```

### Phase 1å®Œäº†å¾Œ
```
CorporateAgendaDashboard
  â†“ è¡¨ç¤º
Facilityï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ â† åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  Facility Master API
çµ±è¨ˆãƒ‡ãƒ¼ã‚¿: ãƒ€ãƒŸãƒ¼ã®ã¾ã¾
```

### Phase 2å®Œäº†å¾Œ
```
CorporateAgendaDashboard
  â†“ è¡¨ç¤º
Facilityï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ â† åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  API
FacilityStatisticsï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ â† æ—¥æ¬¡ãƒãƒƒãƒ â† Post + User
```

### Phase 3å®Œäº†å¾Œ
```
CorporateAgendaDashboard
  â†“ è¡¨ç¤º
Facilityï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ â† åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  API
FacilityStatisticsï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ â† æ—¥æ¬¡ãƒãƒƒãƒ
CorporateKPIï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ â† æ—¥æ¬¡ãƒãƒƒãƒ â† FacilityStatisticsé›†è¨ˆ
FacilityAlertï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ â† ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ãƒãƒƒãƒ â† FacilityStatistics
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å®Ÿè£…

#### Phase 1
- [ ] FacilityMasterãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèªï¼ˆDBæ§‹ç¯‰è¨ˆç”»æ›¸ã«æ—¢å­˜ï¼‰
- [ ] GET /api/facilities å®Ÿè£…
- [ ] GET /api/facilities/:id/employee-count å®Ÿè£…
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] APIä»•æ§˜æ›¸æ›´æ–°

### VoiceDriveå´ã®å®Ÿè£…

#### Phase 1
- [ ] Facilityãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] æ–½è¨­ãƒã‚¹ã‚¿åŒæœŸæ©Ÿèƒ½å®Ÿè£…
- [ ] CorporateAgendaDashboardãƒšãƒ¼ã‚¸ã§è¡¨ç¤ºç¢ºèª

#### Phase 2
- [ ] FacilityStatisticsãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] çµ±è¨ˆè¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…
- [ ] æ—¥æ¬¡ãƒãƒƒãƒå®Ÿè£…
- [ ] CorporateAgendaDashboardãƒšãƒ¼ã‚¸ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
- [ ] å®Ÿãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã«å¤‰æ›´

#### Phase 3
- [ ] CorporateKPIãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [ ] FacilityAlertãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [ ] AlertThresholdãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] æ³•äººå…¨ä½“KPIè¨ˆç®—å®Ÿè£…
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥å®Ÿè£…
- [ ] CorporateAgendaDashboardãƒšãƒ¼ã‚¸æœ€çµ‚èª¿æ•´

### ãƒ†ã‚¹ãƒˆ
- [ ] æ–½è¨­ãƒã‚¹ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ
- [ ] çµ±è¨ˆè¨ˆç®—ç²¾åº¦ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ10æ–½è¨­Ã—1å¹´åˆ†ãƒ‡ãƒ¼ã‚¿ï¼‰
- [ ] E2Eãƒ†ã‚¹ãƒˆï¼ˆCorporateAgendaDashboardå…¨æ©Ÿèƒ½ï¼‰

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸](./ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md)
- [PersonalStation_DBè¦ä»¶åˆ†æ_20251008.md](./PersonalStation_DBè¦ä»¶åˆ†æ_20251008.md)
- [å…±é€šDBæ§‹ç¯‰å¾Œçµ±åˆä½œæ¥­å†é–‹è¨ˆç”»æ›¸](./å…±é€šDBæ§‹ç¯‰å¾Œçµ±åˆä½œæ¥­å†é–‹è¨ˆç”»æ›¸_20251008.md)

---

**æ–‡æ›¸çµ‚äº†**

æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ22æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0
æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼: Phase 1å®Ÿè£…å¾Œ
