# 議題モード実装完了報告

**作成日**: 2025年10月19日
**ステータス**: ✅ 実装完了（テスト待ち）

---

## 1. 実装概要

議題モード（部署議題モード～法人議題モード）の完全なワークフロー実装が完了しました。

### 実装範囲

- ✅ **30点**: 主任・師長への早期通知
- ✅ **50点**: 主任推薦 → 師長承認の2段階フロー
- ✅ **100点**: 副看護部長判断（委員会提出/法人検討昇格/却下）
- ✅ **300点**: 事務長判断（法人議題承認/600点目標昇格/却下）
- ✅ **600点**: 法人統括事務局長判断（法人運営会議提出/却下）
- ✅ **救済フロー**: 上位レベル却下時の下位レベル救済オプション

---

## 2. 実装ファイル一覧

### バックエンド

#### 2.1 Prisma Schema更新

**ファイル**: `prisma/schema.prisma`

```prisma
// 🆕 議題モード管理フィールド
agendaStatus                 String?   @default("pending") @map("agenda_status")
agendaDecisionBy             String?   @map("agenda_decision_by")
agendaDecisionAt             DateTime? @map("agenda_decision_at")
agendaDecisionReason         String?   @map("agenda_decision_reason")
agendaRescueLevel            Int?      @map("agenda_rescue_level")
agendaVotingDeadline         DateTime? @map("agenda_voting_deadline")
```

**目的**: 投稿テーブルに議題モードの詳細状態を追跡するフィールドを追加

---

#### 2.2 AgendaDecisionService

**ファイル**: `src/services/AgendaDecisionService.ts` (新規作成)

**主な機能**:
- 各レベル（3.5, 7, 8, 11, 18）の判断処理を統合管理
- 承認/却下/昇格の判断タイプを17種類定義
- 救済フロー処理を実装
- 通知サービスとの統合

**主要メソッド**:
```typescript
async executeDecision(input: AgendaDecisionInput): Promise<AgendaDecisionResult>

// Level 3.5
- handleRecommendToManager()
- handleRejectBySupervisor()

// Level 7
- handleApproveAsDeptAgenda()
- handleEscalateToFacility()
- handleRejectByManager()
- handleRescueAsDeptAgenda() // 救済
- handleCompleteRejection()

// Level 8
- handleApproveForCommittee()
- handleEscalateToCorpReview()
- handleRejectByDeputyDirector()

// Level 11
- handleApproveAsCorpAgenda()
- handleEscalateToCorpAgenda()
- handleRejectByGeneralAffairs()
- handleRescueAsFacilityAgenda() // 救済

// Level 18
- handleApproveForCorpMeeting()
- handleRejectByGeneralAffairsDirector()
```

---

#### 2.3 AgendaLevelNotificationService拡張

**ファイル**: `src/services/AgendaLevelNotificationService.ts` (拡張)

**追加メソッド**: 17個の通知メソッドを追加

主な通知先:
- **投稿者**: 全ての判断結果
- **主任/師長**: 推薦・承認要求
- **部署内全員**: 部署議題承認/却下
- **施設内全員**: 施設議題昇格/法人検討昇格
- **法人内全員**: 法人議題承認（600点）

**救済フロー通知**:
```typescript
async notifyDeputyDirectorRejection()  // → 師長に救済オプション通知
async notifyGeneralAffairsRejection()  // → 副看護部長に救済オプション通知
async notifyGeneralAffairsDirectorRejection() // → 事務長に救済オプション通知
```

---

#### 2.4 APIエンドポイント

**ファイル**: `src/pages/api/agenda/decision.ts` (新規作成)

**エンドポイント**: `POST /api/agenda/decision`

**リクエスト**:
```typescript
{
  postId: string;
  decisionType: AgendaDecisionType;
  deciderId: string;
  reason: string;
  committeeId?: string; // Level 8承認時のみ
}
```

**レスポンス**:
```typescript
{
  success: boolean;
  message: string;
  post?: any;
  notificationsSent?: number;
}
```

---

### フロントエンド

#### 2.5 AgendaDecisionModal

**ファイル**: `src/components/agenda/AgendaDecisionModal.tsx` (新規作成)

**機能**:
- 判断理由入力フォーム
- 委員会選択（Level 8承認時）
- 昇格時の確認メッセージ表示
- 判断タイプごとの色分け（緑/青/赤）

**表示内容**:
- 投稿タイトル
- 判断理由入力欄（必須）
- 委員会選択（Level 8のみ）
- 昇格時の警告メッセージ

---

#### 2.6 AgendaDecisionButtons

**ファイル**: `src/components/agenda/AgendaDecisionButtons.tsx` (新規作成)

**機能**:
- ユーザーレベルとスコアに応じて適切なボタンを表示
- モーダル表示制御
- API呼び出し処理

**ボタン表示条件**:

| レベル | スコア | ステータス | ボタン |
|--------|--------|-----------|--------|
| 3.5 | 50+ | pending | ✅ 師長に推薦 / ❌ 却下 |
| 7 | - | recommended_to_manager | ✅ 部署議題承認 / ⬆️ 施設議題昇格 / ❌ 却下 |
| 7 | - | pending_rescue_by_manager | ✅ 部署議題承認 / ❌ 完全却下 |
| 8 | 100+ | pending_deputy_director_review | ✅ 委員会提出 / ⬆️ 法人検討昇格 / ❌ 却下 |
| 11 | 300+ | pending_general_affairs_review | ✅ 法人議題承認 / ⬆️ 600点目標昇格 / ❌ 却下 |
| 11 | - | pending_rescue_by_deputy_director | ✅ 施設議題承認 / ❌ 完全却下 |
| 18 | 600+ | pending_general_affairs_director_review | ✅ 法人運営会議提出 / ❌ 却下 |

---

## 3. ワークフロー詳細

### 3.1 部署議題レベル（30-99点）

#### 30点到達

**自動処理**:
- 投稿ステータス: `pending_supervisor_review`

**通知先**:
- 主任（Level 3.5）- 早期警告
- 師長（Level 7）- 早期警告
- 投稿者 - 30点到達のお知らせ

---

#### 50点到達

**自動処理**:
- 主任に判断要求通知

**主任の選択肢**:
1. **✅ 師長に推薦**:
   - ステータス: `recommended_to_manager`
   - 通知: 投稿者 + 師長

2. **❌ 却下**:
   - ステータス: `rejected_by_supervisor`
   - 投稿ステータス: `rejected`
   - 通知: 投稿者のみ

---

#### 師長の判断

**主任推薦後の選択肢**:

1. **✅ 部署議題承認**:
   - ステータス: `approved_as_dept_agenda`
   - agendaLevel: `DEPT_AGENDA`
   - 通知: 投稿者 + 部署内全員

2. **⬆️ 施設議題に昇格**:
   - ステータス: `escalated_to_facility`
   - agendaLevel: `FACILITY_AGENDA`
   - 投票期限: 60日延長
   - 公開範囲: 施設内全職員
   - 通知: 投稿者 + 主任 + Level 8 + 施設内全職員

3. **❌ 却下**:
   - ステータス: `rejected_by_manager`
   - 投稿ステータス: `rejected`
   - 通知: 投稿者 + 部署内全員 + 施設内全職員

---

### 3.2 施設議題レベル（100-299点）

#### 100点到達

**自動処理**:
- 投稿ステータス: `pending_deputy_director_review`

**通知先**:
- 副看護部長（Level 8）- 判断要求
- 師長（Level 7）- 情報共有
- 主任（Level 3.5）- 情報共有
- 投稿者 - 100点到達のお知らせ
- 施設内全職員 - 施設議題到達のお知らせ

---

#### 副看護部長の判断

**選択肢**:

1. **✅ 委員会提出承認**:
   - ステータス: `approved_for_committee`
   - agendaLevel: `FACILITY_AGENDA`
   - 通知: 投稿者 + 施設内全職員

2. **⬆️ 法人検討に昇格（300点目標）**:
   - ステータス: `escalated_to_corp_review`
   - agendaLevel: `CORP_REVIEW`
   - 投票期限: 90日延長
   - 通知: 投稿者 + 施設内全職員

3. **❌ 却下**:
   - ステータス: `pending_rescue_by_manager` (救済待ち)
   - 通知: 投稿者 + 師長（救済判断要求）

---

#### 救済フロー（Level 8却下後）

**師長の選択肢**:

1. **✅ 部署議題承認（救済）**:
   - ステータス: `approved_as_dept_agenda`
   - agendaLevel: `DEPT_AGENDA`
   - agendaRescueLevel: `7`
   - 通知: 投稿者 + 部署内全員

2. **❌ 完全却下**:
   - ステータス: `rejected_by_manager`
   - 投稿ステータス: `rejected`
   - 通知: 投稿者 + 部署内全員

---

### 3.3 法人検討レベル（300-599点）

#### 300点到達

**自動処理**:
- 投稿ステータス: `pending_general_affairs_review`

**通知先**:
- 事務長（Level 11）- 判断要求
- 副看護部長（Level 8）- 情報共有
- 投稿者 - 300点到達のお知らせ
- 施設内全職員 - 法人検討到達のお知らせ

---

#### 事務長の判断

**選択肢**:

1. **✅ 法人議題承認**:
   - ステータス: `approved_as_corp_agenda`
   - agendaLevel: `CORP_AGENDA`
   - 通知: 投稿者 + 施設内全職員

2. **⬆️ 法人議題に昇格（600点目標）**:
   - ステータス: `escalated_to_corp_agenda`
   - agendaLevel: `CORP_AGENDA`
   - 投票期限: 120日延長
   - 通知: 投稿者 + 施設内全職員

3. **❌ 却下**:
   - ステータス: `pending_rescue_by_deputy_director` (救済待ち)
   - 通知: 投稿者 + 副看護部長（救済判断要求）

---

#### 救済フロー（Level 11却下後）

**副看護部長の選択肢**:

1. **✅ 施設議題承認（救済）**:
   - ステータス: `approved_for_committee`
   - agendaLevel: `FACILITY_AGENDA`
   - agendaRescueLevel: `11`
   - 通知: 投稿者 + 施設内全職員

2. **❌ 完全却下**:
   - ステータス: `rejected_by_deputy_director`
   - 投稿ステータス: `rejected`
   - 通知: 投稿者 + 施設内全職員

---

### 3.4 法人議題レベル（600点以上）

#### 600点到達

**自動処理**:
- 投稿公開範囲: **法人内全職員に拡大**
- 投稿表示: 施設名 + 投稿者名を記載
- 投稿ステータス: `pending_general_affairs_director_review`

**通知先**:
- 法人統括事務局長（Level 18）- 判断要求
- 全施設の事務長（Level 11）- 情報共有
- **法人内全職員** - 法人議題到達のお知らせ

---

#### 法人統括事務局長の判断

**選択肢**:

1. **✅ 法人運営会議提出承認**:
   - ステータス: `approved_for_corp_meeting`
   - agendaLevel: `CORP_AGENDA`
   - 通知: 投稿者 + **法人内全職員**（施設名・投稿者名付き）

2. **❌ 却下**:
   - ステータス: `pending_rescue_by_deputy_director` (救済待ち)
   - 通知: 投稿者 + 事務長（救済判断要求）

---

#### 救済フロー（Level 18却下後）

**事務長の選択肢**:

1. **✅ 施設議題承認（救済）**:
   - ステータス: `approved_for_committee`
   - agendaLevel: `FACILITY_AGENDA`
   - agendaRescueLevel: `11`
   - 公開範囲: 施設内に縮小
   - 通知: 投稿者 + 施設内全職員

2. **❌ 完全却下**:
   - ステータス: `rejected_by_general_affairs`
   - 投稿ステータス: `rejected`
   - 公開範囲: 施設内に縮小
   - 通知: 投稿者 + 施設内全職員

---

## 4. 救済フロー一覧

| 却下レベル | 救済者 | 救済範囲 | 救済後ステータス |
|-----------|--------|---------|----------------|
| Level 8（副看護部長） | Level 7（師長） | 部署議題 | `approved_as_dept_agenda` |
| Level 11（事務長） | Level 8（副看護部長） | 施設議題 | `approved_for_committee` |
| Level 18（法人統括事務局長） | Level 11（事務長） | 施設議題 | `approved_for_committee` |

---

## 5. 組織診断機能としての価値

このワークフローシステムは、単なる議題管理ツールではなく、**組織診断ツール**としても機能します。

### 診断可能な組織課題

1. **承認率の偏り**: 特定の部署や管理者が極端に承認率が低い/高い
2. **却下理由の分析**: 却下理由から組織の問題を特定
3. **昇格/降格パターン**: 不自然な昇格・救済の頻発
4. **判断遅延**: 判断までの時間が長い管理者や部署

### メトリクス例

```typescript
// 部署別承認率
const deptApprovalRate = {
  "看護部A病棟": 75%,
  "看護部B病棟": 45%, // ← 低すぎる？
  "リハビリ科": 90%,
}

// 管理者別判断遅延
const managerDecisionDelay = {
  "師長A": 2.5日,
  "師長B": 7.8日, // ← 遅すぎる？
  "師長C": 1.2日,
}

// 救済フロー発生率
const rescueFlowRate = {
  "施設A": 5%,
  "施設B": 25%, // ← 高すぎる？上位レベルとの不一致
}
```

---

## 6. 今後の実装タスク

### 6.1 即時対応が必要

- [ ] **Prisma Migrate**: Schema変更を本番DBに適用
- [ ] **ユーザー取得ロジック**: AgendaLevelNotificationServiceのTODO実装
  - `getManagersByDepartment()`
  - `getDepartmentMembersByDept()`
  - `getDeputyDirectorsByFacility()`
  - `getFacilityMembers()`
  - `getGeneralAffairsByFacility()`
  - `getCorporationMembers()`

### 6.2 機能追加

- [ ] **コメント機能**: 判断時のディスカッション機能
- [ ] **期限管理**: 判断期限の設定と通知
- [ ] **履歴表示**: 判断履歴の詳細表示
- [ ] **組織診断ダッシュボード**: メトリクス可視化

### 6.3 テスト

- [ ] **単体テスト**: AgendaDecisionServiceの各メソッド
- [ ] **統合テスト**: APIエンドポイントのE2Eテスト
- [ ] **UIテスト**: ボタン表示と判断フロー

---

## 7. 使用方法

### 7.1 既存の投稿管理画面への組み込み

```tsx
import { AgendaDecisionButtons } from '@/components/agenda/AgendaDecisionButtons';
import { AgendaDecisionType } from '@/services/AgendaDecisionService';

const ProposalManagementPage = () => {
  const { user } = useAuth();

  const handleDecision = async (
    decisionType: AgendaDecisionType,
    reason: string,
    committeeId?: string
  ) => {
    const response = await fetch('/api/agenda/decision', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        postId: post.id,
        decisionType,
        deciderId: user.id,
        reason,
        committeeId,
      }),
    });

    const result = await response.json();

    if (result.success) {
      alert(`${result.message}\n${result.notificationsSent}名に通知を送信しました`);
      // 画面更新処理
    }
  };

  return (
    <div>
      {/* 既存のUI */}

      {/* 判断ボタンを表示 */}
      <AgendaDecisionButtons
        postId={post.id}
        postTitle={post.content}
        userLevel={user.permissionLevel}
        agendaScore={post.agendaScore}
        agendaStatus={post.agendaStatus}
        onDecision={handleDecision}
      />
    </div>
  );
};
```

---

## 8. まとめ

- ✅ **完全実装**: 30点～600点の全階層ワークフロー
- ✅ **救済フロー**: 3段階の救済メカニズム
- ✅ **通知システム**: 17種類の通知パターン
- ✅ **UIコンポーネント**: モーダル + 動的ボタン表示
- ✅ **API**: RESTful APIエンドポイント
- ⚠️ **Prisma統合**: ユーザー取得ロジックがTODO

**次のステップ**: Prisma Migrateとユーザー取得ロジックの実装

---

**作成者**: Claude Code
**レビュー**: 未実施
**承認**: 未実施
