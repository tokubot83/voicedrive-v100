# 議題モード通知機能 実装状況まとめ

**作成日**: 2025年10月19日

---

## 質問: これが全部完了したら議題化された際の通知機能が全て実装完了となるということだよね？

### 回答: ⚠️ **部分的に正しい**

議題モードの通知機能には**2つのタイプ**があります：

1. **✅ 判断時の通知（今回実装完了）**
2. **⚠️ スコア到達時の自動通知（一部未実装）**

---

## 1. 通知機能の全体像

### 1.1 判断時の通知（Manual Triggers）

**トリガー**: 管理者がボタンを押して判断した時

**実装状況**: ✅ **今回実装完了**

| 判断タイプ | 通知先 | 実装状況 |
|-----------|--------|---------|
| 主任が師長に推薦 | 投稿者 + 師長 | ✅ 完了 |
| 主任が却下 | 投稿者 | ✅ 完了 |
| 師長が部署議題承認 | 投稿者 + 部署内全員 | ✅ 完了 |
| 師長が施設議題に昇格 | 投稿者 + 主任 + Level 8 + 施設内全職員 | ✅ 完了 |
| 師長が却下 | 投稿者 + 部署内全員 | ✅ 完了 |
| 副看護部長が委員会提出承認 | 投稿者 + 施設内全職員 | ✅ 完了 |
| 副看護部長が法人検討に昇格 | 投稿者 + 施設内全職員 | ✅ 完了 |
| 副看護部長が却下（救済待ち） | 投稿者 + 師長 | ✅ 完了 |
| 事務長が法人議題承認 | 投稿者 + 施設内全職員 | ✅ 完了 |
| 事務長が法人議題に昇格 | 投稿者 + 施設内全職員 | ✅ 完了 |
| 事務長が却下（救済待ち） | 投稿者 + 副看護部長 | ✅ 完了 |
| 法人統括事務局長が法人運営会議提出承認 | 投稿者 + 法人内全職員 | ✅ 完了 |
| 法人統括事務局長が却下（救済待ち） | 投稿者 + 事務長 | ✅ 完了 |

**これらは全て AgendaDecisionService と AgendaLevelNotificationService で実装済み**

---

### 1.2 スコア到達時の自動通知（Auto Triggers）

**トリガー**: 投票によってスコアが閾値に到達した時（自動）

**実装状況**: ⚠️ **一部未実装**

| スコア | 通知内容 | 通知先 | 実装状況 |
|-------|---------|--------|---------|
| 30点到達 | 部署検討開始のお知らせ | 投稿者 + 主任 + 師長 | ❌ 未実装 |
| 50点到達 | 主任判断要求 | 投稿者 + 主任 | ❌ 未実装 |
| 100点到達 | 副看護部長判断要求 | 投稿者 + 主任 + 師長 + 副看護部長 + 施設内全職員 | ❌ 未実装 |
| 300点到達 | 事務長判断要求 | 投稿者 + 副看護部長 + 事務長 + 施設内全職員 | ❌ 未実装 |
| 600点到達 | 法人統括事務局長判断要求 | 投稿者 + 全施設事務長 + 法人統括事務局長 + 法人内全職員 | ❌ 未実装 |

**これらは AgendaLevelNotificationService.notifyLevelChange() で一部実装されているが、統合が未完了**

---

## 2. 詳細な実装状況

### 2.1 判断時の通知（✅ 完了）

#### 実装済みの機能

1. **AgendaDecisionService**: 判断処理と通知送信を統合
   - ファイル: `src/services/AgendaDecisionService.ts`
   - 各判断タイプごとに適切な通知メソッドを呼び出し

2. **AgendaLevelNotificationService**: 通知送信処理
   - ファイル: `src/services/AgendaLevelNotificationService.ts`
   - 17個の判断時通知メソッドを実装
   - NotificationServiceとの統合完了

3. **API**: 判断実行エンドポイント
   - ファイル: `src/pages/api/agenda/decision.ts`
   - POST `/api/agenda/decision`

4. **UI**: 判断ボタンとモーダル
   - ファイル: `src/components/agenda/AgendaDecisionButtons.tsx`
   - ファイル: `src/components/agenda/AgendaDecisionModal.tsx`

#### 制限事項

⚠️ **ユーザー取得ロジックが未実装**のため、通知送信はログ出力のみ
- `getManagersByDepartment()` → 空配列
- `getDepartmentMembersByDept()` → 空配列
- `getFacilityMembers()` → 空配列
- `getCorporationMembers()` → 空配列

**解決方法**: ユーザー取得メソッドにPrismaクエリを実装（後述）

---

### 2.2 スコア到達時の自動通知（⚠️ 一部実装）

#### 既存実装の確認

```typescript
// src/services/AgendaLevelNotificationService.ts (既存)

public async notifyLevelChange(config: LevelChangeNotificationConfig): Promise<void> {
  const { post, previousLevel, newLevel, currentScore } = config;

  console.log(`[AgendaLevelNotification] レベル変更検出: ${previousLevel} → ${newLevel} (${currentScore}点)`);

  // レベルごとの通知先を決定
  const recipients = this.determineRecipients(newLevel, post);

  if (recipients.length === 0) {
    console.log('[AgendaLevelNotification] 通知対象者なし');
    return;
  }

  // AgendaModeNotificationsから通知メッセージを生成
  const notificationContent = agendaModeNotifications.getLevelUpNotification(
    newLevel,
    currentScore,
    post.title
  );

  // 各受信者に通知送信
  for (const recipient of recipients) {
    await this.sendNotificationToUser(recipient, notificationContent, post, newLevel);
  }
}
```

**この `notifyLevelChange()` メソッドは実装済みですが、呼び出し元が未実装です。**

---

#### 未実装の部分: スコア更新時の自動呼び出し

**問題**: 投票時にスコアが更新されても、`notifyLevelChange()` が呼び出されていない

**必要な実装**:

1. **投票処理にフックを追加**
2. **スコアが閾値を超えた時に自動通知**
3. **30点、50点、100点、300点、600点の各閾値で処理を分岐**

---

## 3. 完全実装に必要な追加作業

### 3.1 ユーザー取得ロジックの実装（必須）

**ファイル**: `src/services/AgendaLevelNotificationService.ts`

**実装内容**:

```typescript
import { prisma } from '@/lib/prisma';

// 主任（Level 3.5）を部署で取得
private async getManagersByDepartment(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      permissionLevel: 3.5,
      isRetired: false,
    },
  });
}

// 部署メンバーを取得
private async getDepartmentMembersByDept(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      isRetired: false,
    },
  });
}

// 副看護部長（Level 8）を施設で取得
private async getDeputyDirectorsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 8,
      isRetired: false,
    },
  });
}

// 施設メンバーを取得
private async getFacilityMembers(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      isRetired: false,
    },
  });
}

// 事務長（Level 11）を施設で取得
private async getGeneralAffairsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 11,
      isRetired: false,
    },
  });
}

// 法人内全職員を取得
private async getCorporationMembers(): Promise<User[]> {
  return await prisma.user.findMany({
    where: {
      isRetired: false,
    },
  });
}
```

**優先度**: 🔴 **最高（これがないと通知が送信されない）**

---

### 3.2 スコア到達時の自動通知実装

#### 実装場所の特定

投票処理を行っているファイルを確認する必要があります。

**候補**:
- `src/services/VoteService.ts`（存在する場合）
- `src/pages/api/votes/create.ts`（APIエンドポイント）
- `src/hooks/useVote.ts`（フロントエンド）

**実装内容例**:

```typescript
// src/services/VoteService.ts または投票処理を行っているファイル

import { AgendaLevelNotificationService } from './AgendaLevelNotificationService';
import { AgendaLevelEngine } from '@/systems/agenda/engines/AgendaLevelEngine';

class VoteService {
  private agendaLevelEngine = new AgendaLevelEngine();
  private notificationService = AgendaLevelNotificationService.getInstance();

  async castVote(postId: string, userId: string, voteType: string) {
    // 投票前のスコアとレベルを取得
    const post = await prisma.post.findUnique({ where: { id: postId } });
    const previousScore = post.agendaScore || 0;
    const previousLevel = this.agendaLevelEngine.getAgendaLevel(previousScore);

    // 投票を記録
    await prisma.vote.create({
      data: {
        postId,
        userId,
        voteType,
      },
    });

    // 新しいスコアを計算
    const newScore = await this.calculateScore(postId);

    // 投稿のスコアを更新
    await prisma.post.update({
      where: { id: postId },
      data: { agendaScore: newScore },
    });

    // 新しいレベルを取得
    const newLevel = this.agendaLevelEngine.getAgendaLevel(newScore);

    // レベルが変わった場合、通知送信
    if (previousLevel !== newLevel) {
      console.log(`[VoteService] レベル変更検出: ${previousLevel} → ${newLevel}`);

      await this.notificationService.notifyLevelChange({
        post: await prisma.post.findUnique({
          where: { id: postId },
          include: { author: true }
        }),
        previousLevel,
        newLevel,
        currentScore: newScore,
        triggeredBy: await prisma.user.findUnique({ where: { id: userId } }),
      });
    }

    // 🆕 特定スコア到達時の処理
    await this.handleScoreThresholds(postId, previousScore, newScore);

    return { newScore, newLevel };
  }

  /**
   * スコア閾値到達時の処理
   */
  private async handleScoreThresholds(
    postId: string,
    previousScore: number,
    newScore: number
  ) {
    const post = await prisma.post.findUnique({
      where: { id: postId },
      include: { author: true },
    });

    // 30点到達（主任・師長への早期警告）
    if (previousScore < 30 && newScore >= 30) {
      await this.notificationService.notifyScoreThreshold30(post);

      // ステータス更新
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_supervisor_review' },
      });
    }

    // 50点到達（主任判断要求）
    if (previousScore < 50 && newScore >= 50) {
      await this.notificationService.notifyScoreThreshold50(post);
    }

    // 100点到達（副看護部長判断要求）
    if (previousScore < 100 && newScore >= 100) {
      await this.notificationService.notifyScoreThreshold100(post);

      // ステータス更新
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_deputy_director_review' },
      });
    }

    // 300点到達（事務長判断要求）
    if (previousScore < 300 && newScore >= 300) {
      await this.notificationService.notifyScoreThreshold300(post);

      // ステータス更新
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_review' },
      });
    }

    // 600点到達（法人統括事務局長判断要求）
    if (previousScore < 600 && newScore >= 600) {
      await this.notificationService.notifyScoreThreshold600(post);

      // ステータス更新
      await prisma.post.update({
        where: { id: postId },
        data: {
          agendaStatus: 'pending_general_affairs_director_review',
          // 公開範囲を法人内全職員に拡大
        },
      });
    }
  }
}
```

---

#### AgendaLevelNotificationServiceに追加が必要なメソッド

```typescript
// src/services/AgendaLevelNotificationService.ts

/**
 * 30点到達時の通知
 */
async notifyScoreThreshold30(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎯 30点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が30点に到達しました。主任と師長が注目しています。`,
    urgency: 'normal',
    postId: post.id,
  });
  count++;

  // 主任に通知
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: '📊 30点到達の投稿があります',
      message: `「${post.content.substring(0, 30)}...」が30点に到達しました。注意して経過を見守ってください。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // 師長に通知
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const manager of managers) {
    await this.sendSimpleNotification({
      userId: manager.id,
      title: '📊 30点到達の投稿があります',
      message: `「${post.content.substring(0, 30)}...」が30点に到達しました。注意して経過を見守ってください。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 50点到達時の通知
 */
async notifyScoreThreshold50(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎉 50点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が50点に到達しました。主任の判断をお待ちください。`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // 主任に判断要求通知
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: '📋 判断が必要です（50点到達）',
      message: `「${post.content.substring(0, 30)}...」が50点に到達しました。師長への推薦または却下の判断をお願いします。`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  return count;
}

/**
 * 100点到達時の通知
 */
async notifyScoreThreshold100(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎉 100点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が100点に到達しました。副看護部長の判断をお待ちください。`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // 副看護部長に判断要求通知
  const deputyDirectors = await this.getDeputyDirectorsByFacility(post.author?.facilityId);
  for (const dd of deputyDirectors) {
    await this.sendSimpleNotification({
      userId: dd.id,
      title: '📋 判断が必要です（100点到達）',
      message: `「${post.content.substring(0, 30)}...」が100点に到達しました。委員会提出承認、法人検討昇格、または却下の判断をお願いします。`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // 主任・師長に情報共有
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const user of [...supervisors, ...managers]) {
    await this.sendSimpleNotification({
      userId: user.id,
      title: '📊 100点到達',
      message: `「${post.content.substring(0, 30)}...」が100点に到達しました。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // 施設内全職員に通知
  const facilityMembers = await this.getFacilityMembers(post.author?.facilityId);
  for (const member of facilityMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: '🔔 施設議題到達',
      message: `「${post.content.substring(0, 30)}...」が100点に到達しました。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 300点到達時の通知
 */
async notifyScoreThreshold300(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎉 300点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が300点に到達しました。事務長の判断をお待ちください。`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // 事務長に判断要求通知
  const generalAffairs = await this.getGeneralAffairsByFacility(post.author?.facilityId);
  for (const ga of generalAffairs) {
    await this.sendSimpleNotification({
      userId: ga.id,
      title: '📋 判断が必要です（300点到達）',
      message: `「${post.content.substring(0, 30)}...」が300点に到達しました。法人議題承認、600点目標昇格、または却下の判断をお願いします。`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // 副看護部長に情報共有
  const deputyDirectors = await this.getDeputyDirectorsByFacility(post.author?.facilityId);
  for (const dd of deputyDirectors) {
    await this.sendSimpleNotification({
      userId: dd.id,
      title: '📊 300点到達',
      message: `「${post.content.substring(0, 30)}...」が300点に到達しました。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // 施設内全職員に通知
  const facilityMembers = await this.getFacilityMembers(post.author?.facilityId);
  for (const member of facilityMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: '🔔 法人検討到達',
      message: `「${post.content.substring(0, 30)}...」が300点に到達しました。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 600点到達時の通知
 */
async notifyScoreThreshold600(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎉 600点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が600点に到達しました。法人統括事務局長の判断をお待ちください。`,
    urgency: 'urgent',
    postId: post.id,
  });
  count++;

  // 法人統括事務局長に判断要求通知
  const directors = await this.getCorporationMembers(); // Level 18のみフィルタ必要
  const level18Directors = directors.filter(u => u.permissionLevel === 18);
  for (const director of level18Directors) {
    await this.sendSimpleNotification({
      userId: director.id,
      title: '📋 判断が必要です（600点到達）',
      message: `「${post.content.substring(0, 30)}...」が600点に到達しました。法人運営会議提出承認または却下の判断をお願いします。`,
      urgency: 'urgent',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // 全施設の事務長に情報共有
  const allGeneralAffairs = directors.filter(u => u.permissionLevel === 11);
  for (const ga of allGeneralAffairs) {
    await this.sendSimpleNotification({
      userId: ga.id,
      title: '📊 600点到達（法人議題）',
      message: `施設: ${post.author?.facilityId}\n投稿者: ${post.author?.name}\n\n「${post.content.substring(0, 30)}...」が600点に到達しました。`,
      urgency: 'high',
      postId: post.id,
    });
    count++;
  }

  // 法人内全職員に通知
  const corpMembers = await this.getCorporationMembers();
  for (const member of corpMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: '🔔 法人議題到達',
      message: `施設: ${post.author?.facilityId}\n投稿者: ${post.author?.name}\n\n「${post.content.substring(0, 30)}...」が600点に到達しました。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}
```

**優先度**: 🟡 **中（判断時の通知が動けば最低限の運用は可能）**

---

## 4. まとめ

### 質問への回答

> これが全部完了したら議題化された際の通知機能が全て実装完了となるということだよね？

**回答**: ⚠️ **部分的に正しい**

### 実装完了の定義

#### ✅ **今回実装完了した機能**
- 管理者が判断ボタンを押した時の通知（17種類）
- 判断処理ロジック
- UI（ボタン、モーダル）
- API

#### ⚠️ **未実装の機能**
1. **ユーザー取得ロジック**（必須）
   - 優先度: 🔴 **最高**
   - 工数: 1-2時間
   - これがないと通知が実際に送信されない

2. **スコア到達時の自動通知**（推奨）
   - 優先度: 🟡 **中**
   - 工数: 3-4時間
   - 投票処理にフックを追加
   - 30点、50点、100点、300点、600点の各閾値処理

### 最低限の運用開始条件

✅ **3.1 ユーザー取得ロジックの実装のみで運用開始可能**

この実装により：
- 管理者が手動で判断した時の通知が全て動作する
- 投稿者、部署、施設、法人への通知が適切に配信される

### 完全実装の条件

✅ **3.1 + 3.2 の実装で完全実装**

この実装により：
- スコア到達時の自動通知も動作する
- 30点、50点で主任・師長が自動的に気づく
- 100点、300点、600点で判断要求が自動送信される

---

## 5. 次のステップ

### 推奨実装順序

1. **🔴 最優先**: ユーザー取得ロジック実装（3.1）
   - これで判断時の通知が完全に動作

2. **🟡 次**: スコア到達時の自動通知実装（3.2）
   - 投票処理ファイルの特定
   - スコア閾値処理の追加
   - 5つの通知メソッド追加

3. **🟢 最後**: テスト実施
   - 統合テスト計画に沿ってテスト
   - 実際の通知配信確認

---

**結論**:

今回実装した機能により、**判断時の通知機能は完了**しました。

ただし、**完全な議題化通知機能**には以下が必要です：

1. ✅ 判断時の通知（今回実装完了）
2. ⚠️ ユーザー取得ロジック（必須・未実装）
3. ⚠️ スコア到達時の自動通知（推奨・未実装）

**最低限の運用**: 2のみ実装すれば可能
**完全実装**: 2 + 3 の実装が必要
