# è­°é¡Œãƒ¢ãƒ¼ãƒ‰é€šçŸ¥æ©Ÿèƒ½ å®Ÿè£…çŠ¶æ³ã¾ã¨ã‚

**ä½œæˆæ—¥**: 2025å¹´10æœˆ19æ—¥

---

## è³ªå•: ã“ã‚ŒãŒå…¨éƒ¨å®Œäº†ã—ãŸã‚‰è­°é¡ŒåŒ–ã•ã‚ŒãŸéš›ã®é€šçŸ¥æ©Ÿèƒ½ãŒå…¨ã¦å®Ÿè£…å®Œäº†ã¨ãªã‚‹ã¨ã„ã†ã“ã¨ã ã‚ˆã­ï¼Ÿ

### å›ç­”: âš ï¸ **éƒ¨åˆ†çš„ã«æ­£ã—ã„**

è­°é¡Œãƒ¢ãƒ¼ãƒ‰ã®é€šçŸ¥æ©Ÿèƒ½ã«ã¯**2ã¤ã®ã‚¿ã‚¤ãƒ—**ãŒã‚ã‚Šã¾ã™ï¼š

1. **âœ… åˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼ˆä»Šå›å®Ÿè£…å®Œäº†ï¼‰**
2. **âš ï¸ ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆä¸€éƒ¨æœªå®Ÿè£…ï¼‰**

---

## 1. é€šçŸ¥æ©Ÿèƒ½ã®å…¨ä½“åƒ

### 1.1 åˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼ˆManual Triggersï¼‰

**ãƒˆãƒªã‚¬ãƒ¼**: ç®¡ç†è€…ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦åˆ¤æ–­ã—ãŸæ™‚

**å®Ÿè£…çŠ¶æ³**: âœ… **ä»Šå›å®Ÿè£…å®Œäº†**

| åˆ¤æ–­ã‚¿ã‚¤ãƒ— | é€šçŸ¥å…ˆ | å®Ÿè£…çŠ¶æ³ |
|-----------|--------|---------|
| ä¸»ä»»ãŒå¸«é•·ã«æ¨è–¦ | æŠ•ç¨¿è€… + å¸«é•· | âœ… å®Œäº† |
| ä¸»ä»»ãŒå´ä¸‹ | æŠ•ç¨¿è€… | âœ… å®Œäº† |
| å¸«é•·ãŒéƒ¨ç½²è­°é¡Œæ‰¿èª | æŠ•ç¨¿è€… + éƒ¨ç½²å†…å…¨å“¡ | âœ… å®Œäº† |
| å¸«é•·ãŒæ–½è¨­è­°é¡Œã«æ˜‡æ ¼ | æŠ•ç¨¿è€… + ä¸»ä»» + Level 8 + æ–½è¨­å†…å…¨è·å“¡ | âœ… å®Œäº† |
| å¸«é•·ãŒå´ä¸‹ | æŠ•ç¨¿è€… + éƒ¨ç½²å†…å…¨å“¡ | âœ… å®Œäº† |
| å‰¯çœ‹è­·éƒ¨é•·ãŒå§”å“¡ä¼šæå‡ºæ‰¿èª | æŠ•ç¨¿è€… + æ–½è¨­å†…å…¨è·å“¡ | âœ… å®Œäº† |
| å‰¯çœ‹è­·éƒ¨é•·ãŒæ³•äººæ¤œè¨ã«æ˜‡æ ¼ | æŠ•ç¨¿è€… + æ–½è¨­å†…å…¨è·å“¡ | âœ… å®Œäº† |
| å‰¯çœ‹è­·éƒ¨é•·ãŒå´ä¸‹ï¼ˆæ•‘æ¸ˆå¾…ã¡ï¼‰ | æŠ•ç¨¿è€… + å¸«é•· | âœ… å®Œäº† |
| äº‹å‹™é•·ãŒæ³•äººè­°é¡Œæ‰¿èª | æŠ•ç¨¿è€… + æ–½è¨­å†…å…¨è·å“¡ | âœ… å®Œäº† |
| äº‹å‹™é•·ãŒæ³•äººè­°é¡Œã«æ˜‡æ ¼ | æŠ•ç¨¿è€… + æ–½è¨­å†…å…¨è·å“¡ | âœ… å®Œäº† |
| äº‹å‹™é•·ãŒå´ä¸‹ï¼ˆæ•‘æ¸ˆå¾…ã¡ï¼‰ | æŠ•ç¨¿è€… + å‰¯çœ‹è­·éƒ¨é•· | âœ… å®Œäº† |
| æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ãŒæ³•äººé‹å–¶ä¼šè­°æå‡ºæ‰¿èª | æŠ•ç¨¿è€… + æ³•äººå†…å…¨è·å“¡ | âœ… å®Œäº† |
| æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ãŒå´ä¸‹ï¼ˆæ•‘æ¸ˆå¾…ã¡ï¼‰ | æŠ•ç¨¿è€… + äº‹å‹™é•· | âœ… å®Œäº† |

**ã“ã‚Œã‚‰ã¯å…¨ã¦ AgendaDecisionService ã¨ AgendaLevelNotificationService ã§å®Ÿè£…æ¸ˆã¿**

---

### 1.2 ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆAuto Triggersï¼‰

**ãƒˆãƒªã‚¬ãƒ¼**: æŠ•ç¥¨ã«ã‚ˆã£ã¦ã‚¹ã‚³ã‚¢ãŒé–¾å€¤ã«åˆ°é”ã—ãŸæ™‚ï¼ˆè‡ªå‹•ï¼‰

**å®Ÿè£…çŠ¶æ³**: âš ï¸ **ä¸€éƒ¨æœªå®Ÿè£…**

| ã‚¹ã‚³ã‚¢ | é€šçŸ¥å†…å®¹ | é€šçŸ¥å…ˆ | å®Ÿè£…çŠ¶æ³ |
|-------|---------|--------|---------|
| 30ç‚¹åˆ°é” | éƒ¨ç½²æ¤œè¨é–‹å§‹ã®ãŠçŸ¥ã‚‰ã› | æŠ•ç¨¿è€… + ä¸»ä»» + å¸«é•· | âŒ æœªå®Ÿè£… |
| 50ç‚¹åˆ°é” | ä¸»ä»»åˆ¤æ–­è¦æ±‚ | æŠ•ç¨¿è€… + ä¸»ä»» | âŒ æœªå®Ÿè£… |
| 100ç‚¹åˆ°é” | å‰¯çœ‹è­·éƒ¨é•·åˆ¤æ–­è¦æ±‚ | æŠ•ç¨¿è€… + ä¸»ä»» + å¸«é•· + å‰¯çœ‹è­·éƒ¨é•· + æ–½è¨­å†…å…¨è·å“¡ | âŒ æœªå®Ÿè£… |
| 300ç‚¹åˆ°é” | äº‹å‹™é•·åˆ¤æ–­è¦æ±‚ | æŠ•ç¨¿è€… + å‰¯çœ‹è­·éƒ¨é•· + äº‹å‹™é•· + æ–½è¨­å†…å…¨è·å“¡ | âŒ æœªå®Ÿè£… |
| 600ç‚¹åˆ°é” | æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·åˆ¤æ–­è¦æ±‚ | æŠ•ç¨¿è€… + å…¨æ–½è¨­äº‹å‹™é•· + æ³•äººçµ±æ‹¬äº‹å‹™å±€é•· + æ³•äººå†…å…¨è·å“¡ | âŒ æœªå®Ÿè£… |

**ã“ã‚Œã‚‰ã¯ AgendaLevelNotificationService.notifyLevelChange() ã§ä¸€éƒ¨å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒã€çµ±åˆãŒæœªå®Œäº†**

---

## 2. è©³ç´°ãªå®Ÿè£…çŠ¶æ³

### 2.1 åˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼ˆâœ… å®Œäº†ï¼‰

#### å®Ÿè£…æ¸ˆã¿ã®æ©Ÿèƒ½

1. **AgendaDecisionService**: åˆ¤æ–­å‡¦ç†ã¨é€šçŸ¥é€ä¿¡ã‚’çµ±åˆ
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/services/AgendaDecisionService.ts`
   - å„åˆ¤æ–­ã‚¿ã‚¤ãƒ—ã”ã¨ã«é©åˆ‡ãªé€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—

2. **AgendaLevelNotificationService**: é€šçŸ¥é€ä¿¡å‡¦ç†
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/services/AgendaLevelNotificationService.ts`
   - 17å€‹ã®åˆ¤æ–­æ™‚é€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…
   - NotificationServiceã¨ã®çµ±åˆå®Œäº†

3. **API**: åˆ¤æ–­å®Ÿè¡Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/pages/api/agenda/decision.ts`
   - POST `/api/agenda/decision`

4. **UI**: åˆ¤æ–­ãƒœã‚¿ãƒ³ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/components/agenda/AgendaDecisionButtons.tsx`
   - ãƒ•ã‚¡ã‚¤ãƒ«: `src/components/agenda/AgendaDecisionModal.tsx`

#### åˆ¶é™äº‹é …

âš ï¸ **ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ãŒæœªå®Ÿè£…**ã®ãŸã‚ã€é€šçŸ¥é€ä¿¡ã¯ãƒ­ã‚°å‡ºåŠ›ã®ã¿
- `getManagersByDepartment()` â†’ ç©ºé…åˆ—
- `getDepartmentMembersByDept()` â†’ ç©ºé…åˆ—
- `getFacilityMembers()` â†’ ç©ºé…åˆ—
- `getCorporationMembers()` â†’ ç©ºé…åˆ—

**è§£æ±ºæ–¹æ³•**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰ã«Prismaã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ï¼ˆå¾Œè¿°ï¼‰

---

### 2.2 ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆâš ï¸ ä¸€éƒ¨å®Ÿè£…ï¼‰

#### æ—¢å­˜å®Ÿè£…ã®ç¢ºèª

```typescript
// src/services/AgendaLevelNotificationService.ts (æ—¢å­˜)

public async notifyLevelChange(config: LevelChangeNotificationConfig): Promise<void> {
  const { post, previousLevel, newLevel, currentScore } = config;

  console.log(`[AgendaLevelNotification] ãƒ¬ãƒ™ãƒ«å¤‰æ›´æ¤œå‡º: ${previousLevel} â†’ ${newLevel} (${currentScore}ç‚¹)`);

  // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®é€šçŸ¥å…ˆã‚’æ±ºå®š
  const recipients = this.determineRecipients(newLevel, post);

  if (recipients.length === 0) {
    console.log('[AgendaLevelNotification] é€šçŸ¥å¯¾è±¡è€…ãªã—');
    return;
  }

  // AgendaModeNotificationsã‹ã‚‰é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
  const notificationContent = agendaModeNotifications.getLevelUpNotification(
    newLevel,
    currentScore,
    post.title
  );

  // å„å—ä¿¡è€…ã«é€šçŸ¥é€ä¿¡
  for (const recipient of recipients) {
    await this.sendNotificationToUser(recipient, notificationContent, post, newLevel);
  }
}
```

**ã“ã® `notifyLevelChange()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®Ÿè£…æ¸ˆã¿ã§ã™ãŒã€å‘¼ã³å‡ºã—å…ƒãŒæœªå®Ÿè£…ã§ã™ã€‚**

---

#### æœªå®Ÿè£…ã®éƒ¨åˆ†: ã‚¹ã‚³ã‚¢æ›´æ–°æ™‚ã®è‡ªå‹•å‘¼ã³å‡ºã—

**å•é¡Œ**: æŠ•ç¥¨æ™‚ã«ã‚¹ã‚³ã‚¢ãŒæ›´æ–°ã•ã‚Œã¦ã‚‚ã€`notifyLevelChange()` ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ãªã„

**å¿…è¦ãªå®Ÿè£…**:

1. **æŠ•ç¥¨å‡¦ç†ã«ãƒ•ãƒƒã‚¯ã‚’è¿½åŠ **
2. **ã‚¹ã‚³ã‚¢ãŒé–¾å€¤ã‚’è¶…ãˆãŸæ™‚ã«è‡ªå‹•é€šçŸ¥**
3. **30ç‚¹ã€50ç‚¹ã€100ç‚¹ã€300ç‚¹ã€600ç‚¹ã®å„é–¾å€¤ã§å‡¦ç†ã‚’åˆ†å²**

---

## 3. å®Œå…¨å®Ÿè£…ã«å¿…è¦ãªè¿½åŠ ä½œæ¥­

### 3.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ï¼ˆå¿…é ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AgendaLevelNotificationService.ts`

**å®Ÿè£…å†…å®¹**:

```typescript
import { prisma } from '@/lib/prisma';

// ä¸»ä»»ï¼ˆLevel 3.5ï¼‰ã‚’éƒ¨ç½²ã§å–å¾—
private async getManagersByDepartment(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      permissionLevel: 3.5,
      isRetired: false,
    },
  });
}

// éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
private async getDepartmentMembersByDept(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  return await prisma.user.findMany({
    where: {
      department,
      isRetired: false,
    },
  });
}

// å‰¯çœ‹è­·éƒ¨é•·ï¼ˆLevel 8ï¼‰ã‚’æ–½è¨­ã§å–å¾—
private async getDeputyDirectorsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 8,
      isRetired: false,
    },
  });
}

// æ–½è¨­ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
private async getFacilityMembers(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      isRetired: false,
    },
  });
}

// äº‹å‹™é•·ï¼ˆLevel 11ï¼‰ã‚’æ–½è¨­ã§å–å¾—
private async getGeneralAffairsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  return await prisma.user.findMany({
    where: {
      facilityId,
      permissionLevel: 11,
      isRetired: false,
    },
  });
}

// æ³•äººå†…å…¨è·å“¡ã‚’å–å¾—
private async getCorporationMembers(): Promise<User[]> {
  return await prisma.user.findMany({
    where: {
      isRetired: false,
    },
  });
}
```

**å„ªå…ˆåº¦**: ğŸ”´ **æœ€é«˜ï¼ˆã“ã‚ŒãŒãªã„ã¨é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„ï¼‰**

---

### 3.2 ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥å®Ÿè£…

#### å®Ÿè£…å ´æ‰€ã®ç‰¹å®š

æŠ•ç¥¨å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**å€™è£œ**:
- `src/services/VoteService.ts`ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
- `src/pages/api/votes/create.ts`ï¼ˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
- `src/hooks/useVote.ts`ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰

**å®Ÿè£…å†…å®¹ä¾‹**:

```typescript
// src/services/VoteService.ts ã¾ãŸã¯æŠ•ç¥¨å‡¦ç†ã‚’è¡Œã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

import { AgendaLevelNotificationService } from './AgendaLevelNotificationService';
import { AgendaLevelEngine } from '@/systems/agenda/engines/AgendaLevelEngine';

class VoteService {
  private agendaLevelEngine = new AgendaLevelEngine();
  private notificationService = AgendaLevelNotificationService.getInstance();

  async castVote(postId: string, userId: string, voteType: string) {
    // æŠ•ç¥¨å‰ã®ã‚¹ã‚³ã‚¢ã¨ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
    const post = await prisma.post.findUnique({ where: { id: postId } });
    const previousScore = post.agendaScore || 0;
    const previousLevel = this.agendaLevelEngine.getAgendaLevel(previousScore);

    // æŠ•ç¥¨ã‚’è¨˜éŒ²
    await prisma.vote.create({
      data: {
        postId,
        userId,
        voteType,
      },
    });

    // æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
    const newScore = await this.calculateScore(postId);

    // æŠ•ç¨¿ã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
    await prisma.post.update({
      where: { id: postId },
      data: { agendaScore: newScore },
    });

    // æ–°ã—ã„ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
    const newLevel = this.agendaLevelEngine.getAgendaLevel(newScore);

    // ãƒ¬ãƒ™ãƒ«ãŒå¤‰ã‚ã£ãŸå ´åˆã€é€šçŸ¥é€ä¿¡
    if (previousLevel !== newLevel) {
      console.log(`[VoteService] ãƒ¬ãƒ™ãƒ«å¤‰æ›´æ¤œå‡º: ${previousLevel} â†’ ${newLevel}`);

      await this.notificationService.notifyLevelChange({
        post: await prisma.post.findUnique({
          where: { id: postId },
          include: { author: true }
        }),
        previousLevel,
        newLevel,
        currentScore: newScore,
        triggeredBy: await prisma.user.findUnique({ where: { id: userId } }),
      });
    }

    // ğŸ†• ç‰¹å®šã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®å‡¦ç†
    await this.handleScoreThresholds(postId, previousScore, newScore);

    return { newScore, newLevel };
  }

  /**
   * ã‚¹ã‚³ã‚¢é–¾å€¤åˆ°é”æ™‚ã®å‡¦ç†
   */
  private async handleScoreThresholds(
    postId: string,
    previousScore: number,
    newScore: number
  ) {
    const post = await prisma.post.findUnique({
      where: { id: postId },
      include: { author: true },
    });

    // 30ç‚¹åˆ°é”ï¼ˆä¸»ä»»ãƒ»å¸«é•·ã¸ã®æ—©æœŸè­¦å‘Šï¼‰
    if (previousScore < 30 && newScore >= 30) {
      await this.notificationService.notifyScoreThreshold30(post);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_supervisor_review' },
      });
    }

    // 50ç‚¹åˆ°é”ï¼ˆä¸»ä»»åˆ¤æ–­è¦æ±‚ï¼‰
    if (previousScore < 50 && newScore >= 50) {
      await this.notificationService.notifyScoreThreshold50(post);
    }

    // 100ç‚¹åˆ°é”ï¼ˆå‰¯çœ‹è­·éƒ¨é•·åˆ¤æ–­è¦æ±‚ï¼‰
    if (previousScore < 100 && newScore >= 100) {
      await this.notificationService.notifyScoreThreshold100(post);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_deputy_director_review' },
      });
    }

    // 300ç‚¹åˆ°é”ï¼ˆäº‹å‹™é•·åˆ¤æ–­è¦æ±‚ï¼‰
    if (previousScore < 300 && newScore >= 300) {
      await this.notificationService.notifyScoreThreshold300(post);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_review' },
      });
    }

    // 600ç‚¹åˆ°é”ï¼ˆæ³•äººçµ±æ‹¬äº‹å‹™å±€é•·åˆ¤æ–­è¦æ±‚ï¼‰
    if (previousScore < 600 && newScore >= 600) {
      await this.notificationService.notifyScoreThreshold600(post);

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await prisma.post.update({
        where: { id: postId },
        data: {
          agendaStatus: 'pending_general_affairs_director_review',
          // å…¬é–‹ç¯„å›²ã‚’æ³•äººå†…å…¨è·å“¡ã«æ‹¡å¤§
        },
      });
    }
  }
}
```

---

#### AgendaLevelNotificationServiceã«è¿½åŠ ãŒå¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰

```typescript
// src/services/AgendaLevelNotificationService.ts

/**
 * 30ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold30(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ¯ 30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚ä¸»ä»»ã¨å¸«é•·ãŒæ³¨ç›®ã—ã¦ã„ã¾ã™ã€‚`,
    urgency: 'normal',
    postId: post.id,
  });
  count++;

  // ä¸»ä»»ã«é€šçŸ¥
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: 'ğŸ“Š 30ç‚¹åˆ°é”ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³¨æ„ã—ã¦çµŒéã‚’è¦‹å®ˆã£ã¦ãã ã•ã„ã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // å¸«é•·ã«é€šçŸ¥
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const manager of managers) {
    await this.sendSimpleNotification({
      userId: manager.id,
      title: 'ğŸ“Š 30ç‚¹åˆ°é”ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³¨æ„ã—ã¦çµŒéã‚’è¦‹å®ˆã£ã¦ãã ã•ã„ã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 50ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold50(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ‰ 50ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ50ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚ä¸»ä»»ã®åˆ¤æ–­ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // ä¸»ä»»ã«åˆ¤æ–­è¦æ±‚é€šçŸ¥
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: 'ğŸ“‹ åˆ¤æ–­ãŒå¿…è¦ã§ã™ï¼ˆ50ç‚¹åˆ°é”ï¼‰',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ50ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚å¸«é•·ã¸ã®æ¨è–¦ã¾ãŸã¯å´ä¸‹ã®åˆ¤æ–­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  return count;
}

/**
 * 100ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold100(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ‰ 100ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ100ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚å‰¯çœ‹è­·éƒ¨é•·ã®åˆ¤æ–­ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // å‰¯çœ‹è­·éƒ¨é•·ã«åˆ¤æ–­è¦æ±‚é€šçŸ¥
  const deputyDirectors = await this.getDeputyDirectorsByFacility(post.author?.facilityId);
  for (const dd of deputyDirectors) {
    await this.sendSimpleNotification({
      userId: dd.id,
      title: 'ğŸ“‹ åˆ¤æ–­ãŒå¿…è¦ã§ã™ï¼ˆ100ç‚¹åˆ°é”ï¼‰',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ100ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚å§”å“¡ä¼šæå‡ºæ‰¿èªã€æ³•äººæ¤œè¨æ˜‡æ ¼ã€ã¾ãŸã¯å´ä¸‹ã®åˆ¤æ–­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // ä¸»ä»»ãƒ»å¸«é•·ã«æƒ…å ±å…±æœ‰
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const user of [...supervisors, ...managers]) {
    await this.sendSimpleNotification({
      userId: user.id,
      title: 'ğŸ“Š 100ç‚¹åˆ°é”',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ100ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // æ–½è¨­å†…å…¨è·å“¡ã«é€šçŸ¥
  const facilityMembers = await this.getFacilityMembers(post.author?.facilityId);
  for (const member of facilityMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: 'ğŸ”” æ–½è¨­è­°é¡Œåˆ°é”',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ100ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 300ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold300(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ‰ 300ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ300ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚äº‹å‹™é•·ã®åˆ¤æ–­ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚`,
    urgency: 'high',
    postId: post.id,
  });
  count++;

  // äº‹å‹™é•·ã«åˆ¤æ–­è¦æ±‚é€šçŸ¥
  const generalAffairs = await this.getGeneralAffairsByFacility(post.author?.facilityId);
  for (const ga of generalAffairs) {
    await this.sendSimpleNotification({
      userId: ga.id,
      title: 'ğŸ“‹ åˆ¤æ–­ãŒå¿…è¦ã§ã™ï¼ˆ300ç‚¹åˆ°é”ï¼‰',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ300ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³•äººè­°é¡Œæ‰¿èªã€600ç‚¹ç›®æ¨™æ˜‡æ ¼ã€ã¾ãŸã¯å´ä¸‹ã®åˆ¤æ–­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
      urgency: 'high',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // å‰¯çœ‹è­·éƒ¨é•·ã«æƒ…å ±å…±æœ‰
  const deputyDirectors = await this.getDeputyDirectorsByFacility(post.author?.facilityId);
  for (const dd of deputyDirectors) {
    await this.sendSimpleNotification({
      userId: dd.id,
      title: 'ğŸ“Š 300ç‚¹åˆ°é”',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ300ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // æ–½è¨­å†…å…¨è·å“¡ã«é€šçŸ¥
  const facilityMembers = await this.getFacilityMembers(post.author?.facilityId);
  for (const member of facilityMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: 'ğŸ”” æ³•äººæ¤œè¨åˆ°é”',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ300ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

/**
 * 600ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold600(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ‰ 600ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ600ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ã®åˆ¤æ–­ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚`,
    urgency: 'urgent',
    postId: post.id,
  });
  count++;

  // æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ã«åˆ¤æ–­è¦æ±‚é€šçŸ¥
  const directors = await this.getCorporationMembers(); // Level 18ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿å¿…è¦
  const level18Directors = directors.filter(u => u.permissionLevel === 18);
  for (const director of level18Directors) {
    await this.sendSimpleNotification({
      userId: director.id,
      title: 'ğŸ“‹ åˆ¤æ–­ãŒå¿…è¦ã§ã™ï¼ˆ600ç‚¹åˆ°é”ï¼‰',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ600ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³•äººé‹å–¶ä¼šè­°æå‡ºæ‰¿èªã¾ãŸã¯å´ä¸‹ã®åˆ¤æ–­ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
      urgency: 'urgent',
      postId: post.id,
      actionUrl: `/proposal-management/review/${post.id}`,
      actionRequired: true,
    });
    count++;
  }

  // å…¨æ–½è¨­ã®äº‹å‹™é•·ã«æƒ…å ±å…±æœ‰
  const allGeneralAffairs = directors.filter(u => u.permissionLevel === 11);
  for (const ga of allGeneralAffairs) {
    await this.sendSimpleNotification({
      userId: ga.id,
      title: 'ğŸ“Š 600ç‚¹åˆ°é”ï¼ˆæ³•äººè­°é¡Œï¼‰',
      message: `æ–½è¨­: ${post.author?.facilityId}\næŠ•ç¨¿è€…: ${post.author?.name}\n\nã€Œ${post.content.substring(0, 30)}...ã€ãŒ600ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'high',
      postId: post.id,
    });
    count++;
  }

  // æ³•äººå†…å…¨è·å“¡ã«é€šçŸ¥
  const corpMembers = await this.getCorporationMembers();
  for (const member of corpMembers) {
    if (member.id === post.authorId) continue;

    await this.sendSimpleNotification({
      userId: member.id,
      title: 'ğŸ”” æ³•äººè­°é¡Œåˆ°é”',
      message: `æ–½è¨­: ${post.author?.facilityId}\næŠ•ç¨¿è€…: ${post.author?.name}\n\nã€Œ${post.content.substring(0, 30)}...ã€ãŒ600ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}
```

**å„ªå…ˆåº¦**: ğŸŸ¡ **ä¸­ï¼ˆåˆ¤æ–­æ™‚ã®é€šçŸ¥ãŒå‹•ã‘ã°æœ€ä½é™ã®é‹ç”¨ã¯å¯èƒ½ï¼‰**

---

## 4. ã¾ã¨ã‚

### è³ªå•ã¸ã®å›ç­”

> ã“ã‚ŒãŒå…¨éƒ¨å®Œäº†ã—ãŸã‚‰è­°é¡ŒåŒ–ã•ã‚ŒãŸéš›ã®é€šçŸ¥æ©Ÿèƒ½ãŒå…¨ã¦å®Ÿè£…å®Œäº†ã¨ãªã‚‹ã¨ã„ã†ã“ã¨ã ã‚ˆã­ï¼Ÿ

**å›ç­”**: âš ï¸ **éƒ¨åˆ†çš„ã«æ­£ã—ã„**

### å®Ÿè£…å®Œäº†ã®å®šç¾©

#### âœ… **ä»Šå›å®Ÿè£…å®Œäº†ã—ãŸæ©Ÿèƒ½**
- ç®¡ç†è€…ãŒåˆ¤æ–­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®é€šçŸ¥ï¼ˆ17ç¨®é¡ï¼‰
- åˆ¤æ–­å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
- UIï¼ˆãƒœã‚¿ãƒ³ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
- API

#### âš ï¸ **æœªå®Ÿè£…ã®æ©Ÿèƒ½**
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯**ï¼ˆå¿…é ˆï¼‰
   - å„ªå…ˆåº¦: ğŸ”´ **æœ€é«˜**
   - å·¥æ•°: 1-2æ™‚é–“
   - ã“ã‚ŒãŒãªã„ã¨é€šçŸ¥ãŒå®Ÿéš›ã«é€ä¿¡ã•ã‚Œãªã„

2. **ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥**ï¼ˆæ¨å¥¨ï¼‰
   - å„ªå…ˆåº¦: ğŸŸ¡ **ä¸­**
   - å·¥æ•°: 3-4æ™‚é–“
   - æŠ•ç¥¨å‡¦ç†ã«ãƒ•ãƒƒã‚¯ã‚’è¿½åŠ 
   - 30ç‚¹ã€50ç‚¹ã€100ç‚¹ã€300ç‚¹ã€600ç‚¹ã®å„é–¾å€¤å‡¦ç†

### æœ€ä½é™ã®é‹ç”¨é–‹å§‹æ¡ä»¶

âœ… **3.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…ã®ã¿ã§é‹ç”¨é–‹å§‹å¯èƒ½**

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šï¼š
- ç®¡ç†è€…ãŒæ‰‹å‹•ã§åˆ¤æ–­ã—ãŸæ™‚ã®é€šçŸ¥ãŒå…¨ã¦å‹•ä½œã™ã‚‹
- æŠ•ç¨¿è€…ã€éƒ¨ç½²ã€æ–½è¨­ã€æ³•äººã¸ã®é€šçŸ¥ãŒé©åˆ‡ã«é…ä¿¡ã•ã‚Œã‚‹

### å®Œå…¨å®Ÿè£…ã®æ¡ä»¶

âœ… **3.1 + 3.2 ã®å®Ÿè£…ã§å®Œå…¨å®Ÿè£…**

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šï¼š
- ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ã‚‚å‹•ä½œã™ã‚‹
- 30ç‚¹ã€50ç‚¹ã§ä¸»ä»»ãƒ»å¸«é•·ãŒè‡ªå‹•çš„ã«æ°—ã¥ã
- 100ç‚¹ã€300ç‚¹ã€600ç‚¹ã§åˆ¤æ–­è¦æ±‚ãŒè‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹

---

## 5. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æ¨å¥¨å®Ÿè£…é †åº

1. **ğŸ”´ æœ€å„ªå…ˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆ3.1ï¼‰
   - ã“ã‚Œã§åˆ¤æ–­æ™‚ã®é€šçŸ¥ãŒå®Œå…¨ã«å‹•ä½œ

2. **ğŸŸ¡ æ¬¡**: ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥å®Ÿè£…ï¼ˆ3.2ï¼‰
   - æŠ•ç¥¨å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹å®š
   - ã‚¹ã‚³ã‚¢é–¾å€¤å‡¦ç†ã®è¿½åŠ 
   - 5ã¤ã®é€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

3. **ğŸŸ¢ æœ€å¾Œ**: ãƒ†ã‚¹ãƒˆå®Ÿæ–½
   - çµ±åˆãƒ†ã‚¹ãƒˆè¨ˆç”»ã«æ²¿ã£ã¦ãƒ†ã‚¹ãƒˆ
   - å®Ÿéš›ã®é€šçŸ¥é…ä¿¡ç¢ºèª

---

**çµè«–**:

ä»Šå›å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã«ã‚ˆã‚Šã€**åˆ¤æ–­æ™‚ã®é€šçŸ¥æ©Ÿèƒ½ã¯å®Œäº†**ã—ã¾ã—ãŸã€‚

ãŸã ã—ã€**å®Œå…¨ãªè­°é¡ŒåŒ–é€šçŸ¥æ©Ÿèƒ½**ã«ã¯ä»¥ä¸‹ãŒå¿…è¦ã§ã™ï¼š

1. âœ… åˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼ˆä»Šå›å®Ÿè£…å®Œäº†ï¼‰
2. âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¿…é ˆãƒ»æœªå®Ÿè£…ï¼‰
3. âš ï¸ ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆæ¨å¥¨ãƒ»æœªå®Ÿè£…ï¼‰

**æœ€ä½é™ã®é‹ç”¨**: 2ã®ã¿å®Ÿè£…ã™ã‚Œã°å¯èƒ½
**å®Œå…¨å®Ÿè£…**: 2 + 3 ã®å®Ÿè£…ãŒå¿…è¦
