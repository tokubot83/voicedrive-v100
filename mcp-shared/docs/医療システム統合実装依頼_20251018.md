# 医療職員管理システム統合実装依頼

**送付日**: 2025年10月18日
**送付元**: VoiceDrive開発チーム
**送付先**: 医療職員管理システム開発チーム
**件名**: VoiceDrive Phase 2統合機能の実装依頼（2機能）

---

## 📋 概要

VoiceDriveの以下の2機能について、医療職員管理システムとの統合実装をお願いいたします。

| # | 機能名 | 優先度 | 工数見積 | 完了希望日 |
|---|--------|--------|---------|----------|
| 1 | キャリア選択ステーション | 高 | 17-24人日 | 2025年11月末 |
| 2 | 退職処理・緊急アカウント停止 | 中 | 10.5-15.5人日 | 2025年12月末 |

**総工数**: 27.5-39.5人日（約6-8週間）

---

## 🎯 機能1: キャリア選択ステーション

### 機能概要

医療職員のキャリアコース選択・変更申請システム

**4つのコース**:
- **Aコース（全面協力型）**: 施設間異動・管理職昇進・夜勤あり（給与1.2倍）
- **Bコース（施設内協力型）**: 施設内異動・夜勤あり（給与1.1倍）
- **Cコース（専門職型）**: 異動なし・専門性重視（給与1.0倍）
- **Dコース（時短・制約あり型）**: 育児・介護等の制約あり（給与0.9倍）

**変更ルール**:
- 通常変更: 年1回（毎年3月）
- 特別変更: 妊娠・介護・疾病時は随時可能（証明書必要）

### 医療システム側で必要な実装

#### 1. データベーステーブル（3テーブル新規作成）

| テーブル名 | 目的 | レコード数見積 |
|-----------|------|--------------|
| `career_course_definitions` | コース定義マスタ | 4レコード（固定） |
| `career_course_selections` | コース選択履歴 | 250名 × 5年 = 1,250レコード |
| `career_course_change_requests` | 変更申請 | 年間50件 × 5年 = 250レコード |

**データ保持期間**: **全期間保存（削除なし）**
- 理由: 長期的なキャリア開発分析、組織開発効果測定に必須

#### 2. API実装（4エンドポイント）

| エンドポイント | メソッド | 目的 | 認証 |
|--------------|---------|------|------|
| `/api/v2/employees/{employeeId}/career-course` | GET | マイページデータ取得 | JWT（本人のみ） |
| `/api/v2/career-course/definitions` | GET | コース定義一覧 | JWT（全職員） |
| `/api/v2/career-course/change-request` | POST | 変更申請送信 | JWT（本人のみ） |
| `/api/v2/career-course/my-requests` | GET | 申請履歴取得 | JWT（本人のみ） |

#### 3. Webhook送信（2種類）

| イベント | 送信先 | トリガー |
|---------|-------|---------|
| `career_course.change_approved` | VoiceDrive | 人事部門が申請承認時 |
| `career_course.change_rejected` | VoiceDrive | 人事部門が申請却下時 |

#### 4. ファイルストレージ（AWS S3）

**バケット名**: `medical-system-career-course-attachments`
**用途**: 妊娠証明書、介護認定書、医療証明書等の添付ファイル保存
**暗号化**: AES-256
**保持期間**: 全期間保存

### 関連ドキュメント

1. 📄 [career-selection-station_DB要件分析_20251018.md](./career-selection-station_DB要件分析_20251018.md)
   - 500行の詳細分析ドキュメント
   - データベーススキーマ、API仕様、Webhook仕様

2. 📋 [career-selection-station暫定マスターリスト_20251018.md](./career-selection-station暫定マスターリスト_20251018.md)
   - 実装ガイド（医療チーム向け）
   - 工数見積、実装チェックリスト、セキュリティ要件

### 工数見積（医療システム側）

| Phase | タスク | 工数（人日） |
|-------|--------|------------|
| Phase 1 | DB設計・マイグレーション | 3-4 |
| Phase 2 | API実装（4エンドポイント） | 7-9 |
| Phase 3 | Webhook実装（2種類） | 2-4 |
| Phase 5 | 統合テスト | 2-3 |
| バッファ | 予備日（20%） | 3-4 |
| **合計** | | **17-24人日** |

**実装期間**: 約4-5週間
**リソース**: 2名体制推奨

---

## 🚨 機能2: 退職処理・緊急アカウント停止

### 機能概要

医療職員管理システム障害時の緊急対応機能

**2つの機能**:
1. **緊急退職処理**: 職員退職時の4ステップ処理（障害時のみ）
   - Step 1: アカウント無効化
   - Step 2: 権限剥奪
   - Step 3: 投稿匿名化
   - Step 4: 完了通知

2. **緊急アカウント停止**: 一時的なアカウント停止（障害時のみ）

**通常フロー（Phase 4実装予定）**:
- 医療システムで退職登録 → Webhook自動通知 → VoiceDrive自動処理

**緊急フロー（本実装対象）**:
- 医療システム障害時 → VoiceDrive手動処理 → 復旧後に同期

### 医療システム側で必要な実装

#### 1. データベーステーブル（1テーブル新規作成）

| テーブル名 | 目的 | レコード数見積 |
|-----------|------|--------------|
| `employee_account_status_history` | アカウント状態変更履歴（VoiceDrive緊急処理含む） | 年間20件 × 5年 = 100レコード |

**重要機能**:
- VoiceDriveの緊急処理を医療システムで追跡
- `voicedrive_deactivation_id`で緊急停止記録と紐付け
- 正式退職処理時に既存の緊急処理を検出し、**二重処理を回避**

**データ保持期間**: **退職後10年**（法定保存義務）

#### 2. Webhook受信（2エンドポイント）

| エンドポイント | 目的 | トリガー |
|--------------|------|---------|
| `/api/webhooks/voicedrive-emergency-retirement` | VoiceDrive緊急退職処理通知 | VoiceDriveで緊急退職処理完了時 |
| `/api/webhooks/voicedrive-emergency-deactivation` | VoiceDrive緊急アカウント停止通知 | VoiceDriveで緊急停止実行時 |

#### 3. Webhook送信（1エンドポイント）

| イベント | 送信先 | トリガー |
|---------|-------|---------|
| `employee.retired` | VoiceDrive | 医療システムで正式退職処理完了時 |

**重要な機能**:
- 緊急処理が既にある場合、`hasEmergencyProcess: true`を含めて通知
- VoiceDrive側で「緊急処理→正式退職」へのアップグレード処理を実施

#### 4. 正式退職処理の拡張

**実装内容**:
```typescript
// 正式退職処理時に緊急処理記録を検索
const emergencyProcess = await prisma.employeeAccountStatusHistory.findFirst({
  where: {
    employeeId: employeeId,
    sourceSystem: 'voicedrive_emergency',
    isEmergencyChange: true
  }
});

if (emergencyProcess) {
  // 緊急処理が既にある場合、二重処理を回避
  // VoiceDriveに「hasEmergencyProcess: true」を通知
}
```

### 関連ドキュメント

1. 📄 [retirement-emergency-deactivation_DB要件分析_20251018.md](./retirement-emergency-deactivation_DB要件分析_20251018.md)
   - 809行の詳細分析ドキュメント
   - データフロー図、同期機構、セキュリティ要件

2. 📋 [retirement-emergency-deactivation暫定マスターリスト_20251018.md](./retirement-emergency-deactivation暫定マスターリスト_20251018.md)
   - 実装ガイド（医療チーム向け）
   - Webhook仕様、正式退職処理拡張方法、ロールバック計画

### 工数見積（医療システム側）

| Phase | タスク | 工数（人日） |
|-------|--------|------------|
| Phase 1 | DB設計・マイグレーション | 1.5 |
| Phase 2 | Webhook受信実装（2エンドポイント） | 2-3 |
| Phase 2 | Webhook送信実装（1エンドポイント） | 1-2 |
| Phase 2 | 正式退職処理の拡張 | 2-3 |
| Phase 3 | 統合テスト | 2-3 |
| バッファ | 予備日（20%） | 2-3 |
| **合計** | | **10.5-15.5人日** |

**実装期間**: 約3-4週間
**リソース**: 2名体制推奨

---

## 📊 統合スケジュール案

### 推奨実装順序

**Phase A: キャリア選択ステーション**（優先度: 高）
- 期間: 2025年10月下旬 - 11月末（4-5週間）
- 理由: 年度末のキャリアコース変更申請（2026年3月）に間に合わせる必要がある

**Phase B: 退職処理・緊急アカウント停止**（優先度: 中）
- 期間: 2025年11月下旬 - 12月末（3-4週間）
- 理由: 緊急対応機能のため、Phase Aの後でも問題ない

### 並行実施の場合

両機能を並行実施する場合の体制:

| チーム | Phase A担当 | Phase B担当 | 期間 |
|-------|-----------|-----------|------|
| シニアエンジニア1名 | キャリア選択（API設計、Webhook） | - | Week 1-5 |
| エンジニア1名 | キャリア選択（DB、API実装） | - | Week 1-5 |
| シニアエンジニア2名 | - | 退職処理（DB、Webhook、拡張） | Week 3-7 |
| エンジニア2名 | - | 退職処理（テスト、検証） | Week 4-7 |

**総工数**: 27.5-39.5人日
**総期間**: 約7週間（10月下旬 - 12月中旬）

---

## 🔐 セキュリティ要件

### 共通要件

1. **認証**: JWT Bearer Token（医療システム発行）
2. **Webhook署名検証**: HMAC-SHA256
3. **通信暗号化**: TLS 1.3以上必須
4. **個人情報保護**: GDPR/個人情報保護法準拠
5. **アクセスログ**: 全API・Webhookのアクセスログ記録

### キャリア選択ステーション固有

- **添付ファイル暗号化**: S3バケットAES-256暗号化
- **署名付きURL**: ダウンロード専用、24時間有効
- **機微情報管理**: 医療証明書、妊娠証明書等の厳格な管理

### 退職処理固有

- **監査ログ**: 全緊急処理をAuditLogに記録（無期限保存）
- **権限制御**: Level 14+（人事部門）のみ実行可能
- **二重処理防止**: employee_account_status_historyで追跡

---

## ✅ VoiceDrive側の実装状況

### キャリア選択ステーション

- ✅ **ページコンポーネント**: 3ページすべて実装済み
  - CareerSelectionStationPage（マイキャリア）
  - ChangeRequestPage（変更申請）
  - MyRequestsPage（申請履歴）

- ✅ **型定義**: 完全実装済み（career-course.ts）
- ✅ **サービスレイヤー**: APIクライアント実装済み（現在はモック）
- ✅ **ルーティング**: 3ページのルート設定済み

- 🔲 **未実装（医療システムAPI実装後に対応）**:
  - 環境変数設定（医療システムAPIのURL等）
  - モックデータの削除・実APIへの切り替え
  - Webhook受信エンドポイント

### 退職処理・緊急アカウント停止

- ✅ **データベーステーブル**: 3テーブルすべて実装済み
  - EmergencyDeactivation
  - RetirementProcess
  - StaffSystemSyncQueue

- ✅ **Webhook受信**: 基本的なエンドポイント実装済み
  - `/api/webhook/employee-retired`
  - `/api/webhook/staff-system/retirement`

- 🔲 **未実装（医療システムAPI実装後に対応）**:
  - LocalStorage削除・Prisma対応
  - Webhook送信機能
  - 自動同期ワーカー

---

## 📞 次のステップ

### 1. 医療システムチーム側での作業

**即時**:
- [ ] 本ドキュメントと関連ドキュメント（4ファイル）の確認
- [ ] 不明点・懸念点のリストアップ
- [ ] 実装可否の判断

**1週間以内**:
- [ ] マスタープランへの統合（Phase番号の割り当て）
- [ ] 実装スケジュールの確定
- [ ] 担当者アサイン

**実装開始前**:
- [ ] キックオフミーティング設定
- [ ] 統合テスト環境のセットアップ
- [ ] Slackチャンネル作成（#career-course-integration, #retirement-integration）

### 2. 質問・確認事項の受付

**連絡方法**:
- **Slack**: `#voicedrive-medical-integration`（既存チャンネル）
- **Email**: voicedrive-dev@example.com
- **MCPサーバー共有フォルダ**: `mcp-shared/docs/`

**確認が必要な項目**:
1. データ保持期間の方針（キャリア選択: 全期間保存 / 退職処理: 退職後10年）
2. AWS S3バケット名・リージョンの最終確定
3. Webhook署名検証用の共有秘密鍵の生成方法
4. 統合テスト環境のセットアップ方法

### 3. 並行作業（VoiceDrive側）

医療システム側のDB構築中、VoiceDrive側では以下を準備:
- [ ] 環境変数テンプレート作成
- [ ] 統合テスト用のテストデータ準備
- [ ] Webhook送信機能の実装（送信先はモック）
- [ ] ドキュメント更新（統合手順書）

---

## 📚 添付ドキュメント一覧

### キャリア選択ステーション

1. **career-selection-station_DB要件分析_20251018.md** (28KB)
   - データベーススキーマ詳細
   - API仕様（リクエスト/レスポンス例）
   - Webhook仕様（ペイロード例）
   - データフロー図
   - セキュリティ要件

2. **career-selection-station暫定マスターリスト_20251018.md** (25KB)
   - 実装チェックリスト
   - 工数見積詳細
   - 統合タイムライン
   - セキュリティチェックリスト
   - ロールバック計画

### 退職処理・緊急アカウント停止

3. **retirement-emergency-deactivation_DB要件分析_20251018.md** (31KB)
   - データベーススキーマ詳細
   - Webhook仕様（双方向）
   - 緊急処理→正式退職のアップグレードフロー
   - 同期キュー機構
   - 監査要件

4. **retirement-emergency-deactivation暫定マスターリスト_20251018.md** (19KB)
   - 実装チェックリスト
   - Webhook実装例（TypeScript）
   - 正式退職処理の拡張方法
   - セキュリティ・監査要件
   - ロールバック計画

---

## 🙏 謝辞

本実装依頼は、VoiceDriveと医療職員管理システムの統合により、医療職員のキャリア開発支援と適切な退職処理の実現を目指すものです。

両チームの協力により、医療職員のワークライフバランスとキャリア開発の両立、そして安全で確実な退職処理が実現できることを期待しています。

ご不明な点がございましたら、お気軽にお問い合わせください。

---

**送付元**:
VoiceDrive開発チーム
Email: voicedrive-dev@example.com
Slack: #voicedrive-medical-integration

**最終更新**: 2025年10月18日
**バージョン**: 1.0
**次回レビュー**: 医療システムチーム確認後
