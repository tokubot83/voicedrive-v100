# 議題モード 残作業と実装手順

**作成日**: 2025年10月19日

---

## 質問: 統合テストからして残りの通知機能を実装？どういう手順がいいの？

### 推奨手順

以下の順序で実装することをお勧めします：

---

## 📋 推奨実装手順

### Phase 1: DB準備とユーザー取得ロジック実装（必須）

**優先度**: 🔴 **最高**
**工数**: 1-2時間
**理由**: これがないと通知が実際に送信されない

#### ステップ1-1: Prisma Migrate実行

```bash
# Schema変更をDBに適用
npx prisma migrate dev --name add-agenda-decision-fields

# または
npm run prisma:migrate
```

**確認事項**:
- [ ] `agenda_status`フィールドが追加された
- [ ] `agenda_decision_by`フィールドが追加された
- [ ] `agenda_decision_at`フィールドが追加された
- [ ] `agenda_decision_reason`フィールドが追加された
- [ ] `agenda_rescue_level`フィールドが追加された
- [ ] `agenda_voting_deadline`フィールドが追加された

---

#### ステップ1-2: テストユーザー作成

```sql
-- 各レベルのテストユーザーを作成
INSERT INTO User (id, employeeId, email, name, department, facilityId, permissionLevel, accountType, isRetired)
VALUES
  -- 投稿者
  ('test-author-1', 'AUT001', 'author@test.com', 'テスト投稿者', '看護部A病棟', 'facility-1', 1, 'staff', false),

  -- 主任（Level 3.5）
  ('test-supervisor-1', 'SUP001', 'supervisor@test.com', '主任テスト太郎', '看護部A病棟', 'facility-1', 3.5, 'staff', false),

  -- 師長（Level 7）
  ('test-manager-1', 'MGR001', 'manager@test.com', '師長テスト花子', '看護部A病棟', 'facility-1', 7, 'staff', false),

  -- 副看護部長（Level 8）
  ('test-deputy-1', 'DEP001', 'deputy@test.com', '副看護部長テスト', '看護部', 'facility-1', 8, 'staff', false),

  -- 事務長（Level 11）
  ('test-affairs-1', 'AFF001', 'affairs@test.com', '事務長テスト', '総務部', 'facility-1', 11, 'staff', false),

  -- 法人統括事務局長（Level 18）
  ('test-director-1', 'DIR001', 'director@test.com', '法人統括事務局長テスト', '法人本部', 'facility-1', 18, 'executive', false),

  -- 部署メンバー（3名）
  ('test-member-1', 'MEM001', 'member1@test.com', 'メンバー1', '看護部A病棟', 'facility-1', 1, 'staff', false),
  ('test-member-2', 'MEM002', 'member2@test.com', 'メンバー2', '看護部A病棟', 'facility-1', 1, 'staff', false),
  ('test-member-3', 'MEM003', 'member3@test.com', 'メンバー3', '看護部A病棟', 'facility-1', 1, 'staff', false);

-- テスト投稿を作成
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  -- 50点の投稿（主任判断待ち）
  ('test-post-50', 'proposal', 'テスト投稿：50点到達 - 業務効率化のための新システム導入提案', 'test-author-1', 'full', 'active', 50, 'DEPT_AGENDA', 'pending', datetime('now')),

  -- 主任推薦済みの投稿（師長判断待ち）
  ('test-post-50-rec', 'proposal', 'テスト投稿：主任推薦済み - 患者サービス向上提案', 'test-author-1', 'full', 'active', 52, 'DEPT_AGENDA', 'recommended_to_manager', datetime('now')),

  -- 100点の投稿（副看護部長判断待ち）
  ('test-post-100', 'proposal', 'テスト投稿：100点到達 - 医療安全改善提案', 'test-author-1', 'full', 'active', 100, 'FACILITY_AGENDA', 'pending_deputy_director_review', datetime('now')),

  -- 300点の投稿（事務長判断待ち）
  ('test-post-300', 'proposal', 'テスト投稿：300点到達 - 施設横断的な業務改善', 'test-author-1', 'full', 'active', 300, 'CORP_REVIEW', 'pending_general_affairs_review', datetime('now')),

  -- 600点の投稿（法人統括事務局長判断待ち）
  ('test-post-600', 'proposal', 'テスト投稿：600点到達 - 法人全体の経営改革提案', 'test-author-1', 'full', 'active', 600, 'CORP_AGENDA', 'pending_general_affairs_director_review', datetime('now'));
```

---

#### ステップ1-3: ユーザー取得ロジック実装

**ファイル**: `src/services/AgendaLevelNotificationService.ts`

**実装内容**:

```typescript
import { prisma } from '@/lib/prisma';

// ========== Prisma統合済みユーザー取得メソッド ==========

/**
 * 主任（Level 3.5）を部署で取得
 */
private async getManagersByDepartment(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        department,
        permissionLevel: 3.5,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 主任取得: ${department} → ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 主任取得エラー:', error);
    return [];
  }
}

/**
 * 部署メンバーを取得
 */
private async getDepartmentMembersByDept(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        department,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 部署メンバー取得: ${department} → ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 部署メンバー取得エラー:', error);
    return [];
  }
}

/**
 * 副看護部長（Level 8）を施設で取得
 */
private async getDeputyDirectorsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        permissionLevel: 8,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 副看護部長取得: ${facilityId} → ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 副看護部長取得エラー:', error);
    return [];
  }
}

/**
 * 施設メンバーを取得
 */
private async getFacilityMembers(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 施設メンバー取得: ${facilityId} → ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 施設メンバー取得エラー:', error);
    return [];
  }
}

/**
 * 事務長（Level 11）を施設で取得
 */
private async getGeneralAffairsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        permissionLevel: 11,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 事務長取得: ${facilityId} → ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 事務長取得エラー:', error);
    return [];
  }
}

/**
 * 法人内全職員を取得
 */
private async getCorporationMembers(): Promise<User[]> {
  try {
    const users = await prisma.user.findMany({
      where: {
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] 法人内全職員取得: ${users.length}名`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] 法人内全職員取得エラー:', error);
    return [];
  }
}
```

**確認事項**:
- [ ] 既存のTODOメソッドを上記コードで置き換える
- [ ] `prisma`のimportを追加
- [ ] エラーハンドリングを追加
- [ ] ログ出力を追加（取得件数確認用）

---

### Phase 2: 統合テスト実施（判断時の通知）

**優先度**: 🔴 **最高**
**工数**: 1-2時間
**理由**: Phase 1の実装が正しく動作するか確認

#### ステップ2-1: 開発サーバー起動

```bash
npm run dev
```

**アクセス**: http://localhost:3001

---

#### ステップ2-2: APIテスト（主任の判断）

**テストケース**: 主任が師長に推薦

```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50",
    "decisionType": "recommend_to_manager",
    "deciderId": "test-supervisor-1",
    "reason": "部署全体で検討する価値があると判断しました。"
  }'
```

**期待結果**:

```json
{
  "success": true,
  "message": "師長への推薦が完了しました",
  "post": {
    "id": "test-post-50",
    "agendaStatus": "recommended_to_manager",
    "agendaDecisionBy": "test-supervisor-1",
    "agendaDecisionReason": "部署全体で検討する価値があると判断しました。"
  },
  "notificationsSent": 2
}
```

**確認項目**:
- [ ] `notificationsSent`が2以上（投稿者 + 師長）
- [ ] サーバーログに以下が出力される
  ```
  [AgendaLevelNotification] 主任取得: 看護部A病棟 → 1名
  [NotificationService] 通知送信: test-author-1
  [NotificationService] 通知送信: test-manager-1
  ```
- [ ] DBの`Post`テーブルで`agendaStatus`が`recommended_to_manager`に更新

---

#### ステップ2-3: APIテスト（師長の判断）

**テストケース**: 師長が部署議題承認

```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50-rec",
    "decisionType": "approve_as_dept_agenda",
    "deciderId": "test-manager-1",
    "reason": "部署の重要課題として取り上げます。"
  }'
```

**期待結果**:

```json
{
  "success": true,
  "message": "部署議題として承認されました",
  "notificationsSent": 5
}
```

**確認項目**:
- [ ] `notificationsSent`が5以上（投稿者 + 部署メンバー4名）
- [ ] サーバーログに以下が出力される
  ```
  [AgendaLevelNotification] 部署メンバー取得: 看護部A病棟 → 5名
  ```

---

#### ステップ2-4: UIテスト

**実行手順**:

1. ブラウザで http://localhost:3001/proposal-management を開く
2. 主任アカウント（`test-supervisor-1`）でログイン
3. 50点の投稿を表示
4. ボタンが正しく表示されるか確認

**確認項目**:
- [ ] ✅ 師長に推薦ボタンが表示される
- [ ] ❌ 却下ボタンが表示される
- [ ] クリックするとモーダルが開く
- [ ] 判断理由を入力して送信できる
- [ ] 送信後、投稿のステータスが更新される

---

### Phase 3: スコア到達時の自動通知実装（推奨）

**優先度**: 🟡 **中**
**工数**: 3-4時間
**理由**: 投票時の自動通知を実装

#### ステップ3-1: 投票処理ファイルの確認

**調査**: 投票処理がどこで行われているか確認

```bash
# 投票関連ファイルを検索
grep -r "agendaScore" src/ --include="*.ts" --include="*.tsx"
grep -r "Vote" src/ --include="*.ts" --include="*.tsx"
```

**候補ファイル**:
- `src/services/VoteService.ts`
- `src/pages/api/votes/create.ts`
- `src/hooks/useVote.ts`

---

#### ステップ3-2: スコア閾値通知メソッド追加

**ファイル**: `src/services/AgendaLevelNotificationService.ts`

**追加メソッド**:

```typescript
/**
 * 30点到達時の通知
 */
async notifyScoreThreshold30(post: any): Promise<number> {
  let count = 0;

  // 投稿者に通知
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: '🎯 30点に到達しました',
    message: `あなたの投稿「${post.content.substring(0, 30)}...」が30点に到達しました。主任と師長が注目しています。`,
    urgency: 'normal',
    postId: post.id,
  });
  count++;

  // 主任に通知
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: '📊 30点到達の投稿があります',
      message: `「${post.content.substring(0, 30)}...」が30点に到達しました。注意して経過を見守ってください。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // 師長に通知
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const manager of managers) {
    await this.sendSimpleNotification({
      userId: manager.id,
      title: '📊 30点到達の投稿があります',
      message: `「${post.content.substring(0, 30)}...」が30点に到達しました。注意して経過を見守ってください。`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

// 50点、100点、300点、600点も同様に実装
// （詳細は議題モード通知機能実装状況_20251019.md を参照）
```

---

#### ステップ3-3: 投票処理にフック追加

**例**: `src/services/VoteService.ts`（実際のファイル名は異なる可能性あり）

```typescript
import { AgendaLevelNotificationService } from './AgendaLevelNotificationService';

class VoteService {
  private notificationService = AgendaLevelNotificationService.getInstance();

  async castVote(postId: string, userId: string, voteType: string) {
    // 投票前のスコアを取得
    const post = await prisma.post.findUnique({ where: { id: postId } });
    const previousScore = post.agendaScore || 0;

    // 投票を記録
    // ... (既存の投票処理)

    // 新しいスコアを計算
    const newScore = await this.calculateScore(postId);

    // 投稿のスコアを更新
    await prisma.post.update({
      where: { id: postId },
      data: { agendaScore: newScore },
    });

    // スコア閾値到達時の処理
    await this.handleScoreThresholds(postId, previousScore, newScore);

    return { newScore };
  }

  /**
   * スコア閾値到達時の処理
   */
  private async handleScoreThresholds(
    postId: string,
    previousScore: number,
    newScore: number
  ) {
    const post = await prisma.post.findUnique({
      where: { id: postId },
      include: { author: true },
    });

    // 30点到達
    if (previousScore < 30 && newScore >= 30) {
      await this.notificationService.notifyScoreThreshold30(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_supervisor_review' },
      });
    }

    // 50点到達
    if (previousScore < 50 && newScore >= 50) {
      await this.notificationService.notifyScoreThreshold50(post);
    }

    // 100点到達
    if (previousScore < 100 && newScore >= 100) {
      await this.notificationService.notifyScoreThreshold100(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_deputy_director_review' },
      });
    }

    // 300点到達
    if (previousScore < 300 && newScore >= 300) {
      await this.notificationService.notifyScoreThreshold300(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_review' },
      });
    }

    // 600点到達
    if (previousScore < 600 && newScore >= 600) {
      await this.notificationService.notifyScoreThreshold600(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_director_review' },
      });
    }
  }
}
```

---

### Phase 4: 統合テスト実施（スコア到達時の通知）

**優先度**: 🟡 **中**
**工数**: 1時間

#### ステップ4-1: テスト投稿作成

```sql
-- 29点の投稿（30点到達テスト用）
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  ('test-post-29', 'proposal', 'テスト投稿：29点 - 30点到達テスト用', 'test-author-1', 'full', 'active', 29, 'DEPT_REVIEW', 'pending', datetime('now'));

-- 49点の投稿（50点到達テスト用）
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  ('test-post-49', 'proposal', 'テスト投稿：49点 - 50点到達テスト用', 'test-author-1', 'full', 'active', 49, 'DEPT_REVIEW', 'pending_supervisor_review', datetime('now'));
```

---

#### ステップ4-2: 投票APIテスト

**テストケース**: 29点 → 30点到達

```bash
# 投票APIを呼び出して30点到達させる
curl -X POST http://localhost:3001/api/votes/create \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-29",
    "userId": "test-member-1",
    "voteType": "strongly_support"
  }'
```

**期待結果**:
- [ ] サーバーログに以下が出力される
  ```
  [VoteService] 30点到達検出
  [AgendaLevelNotification] 主任取得: 看護部A病棟 → 1名
  [NotificationService] 通知送信: test-author-1
  [NotificationService] 通知送信: test-supervisor-1
  [NotificationService] 通知送信: test-manager-1
  ```
- [ ] `agendaStatus`が`pending_supervisor_review`に更新

---

### Phase 5: E2Eテスト

**優先度**: 🟢 **低**
**工数**: 2-3時間

#### ステップ5-1: E2Eテストシナリオ作成

**シナリオ**: 投稿作成 → 投票 → 30点到達 → 50点到達 → 主任推薦 → 師長承認

**ツール**: Playwright または Cypress

---

## 📊 まとめ

### 最小限の実装（運用開始可能）

**Phase 1 + Phase 2** のみ実装

- ✅ 判断時の通知が動作
- ✅ 管理者が手動で判断できる
- ⚠️ スコア到達時の自動通知はなし

**工数**: 2-4時間

---

### 完全実装

**Phase 1 + Phase 2 + Phase 3 + Phase 4** を実装

- ✅ 判断時の通知が動作
- ✅ スコア到達時の自動通知も動作
- ✅ 完全な議題モードワークフロー

**工数**: 6-10時間

---

## 🎯 推奨アプローチ

### 段階的実装

1. **まず Phase 1 + Phase 2 を実装** → 運用開始可能
2. **運用しながら Phase 3 を実装** → 完全実装

### 理由

- Phase 1+2 だけでも十分運用可能
- スコア到達時の自動通知は「あると便利」だが必須ではない
- 実際の運用フィードバックを得てから Phase 3 を実装する方が効率的

---

## ✅ 実装チェックリスト

### Phase 1: DB準備とユーザー取得ロジック

- [ ] Prisma Migrate実行
- [ ] テストユーザー作成
- [ ] テスト投稿作成
- [ ] `getManagersByDepartment()`実装
- [ ] `getDepartmentMembersByDept()`実装
- [ ] `getDeputyDirectorsByFacility()`実装
- [ ] `getFacilityMembers()`実装
- [ ] `getGeneralAffairsByFacility()`実装
- [ ] `getCorporationMembers()`実装

### Phase 2: 統合テスト（判断時の通知）

- [ ] 開発サーバー起動
- [ ] 主任の判断APIテスト
- [ ] 師長の判断APIテスト
- [ ] 副看護部長の判断APIテスト
- [ ] UIボタン表示テスト
- [ ] モーダル表示テスト
- [ ] 通知送信ログ確認

### Phase 3: スコア到達時の自動通知（オプション）

- [ ] 投票処理ファイル特定
- [ ] `notifyScoreThreshold30()`実装
- [ ] `notifyScoreThreshold50()`実装
- [ ] `notifyScoreThreshold100()`実装
- [ ] `notifyScoreThreshold300()`実装
- [ ] `notifyScoreThreshold600()`実装
- [ ] 投票処理にフック追加

### Phase 4: 統合テスト（スコア到達時の通知）（オプション）

- [ ] テスト投稿作成（29点、49点）
- [ ] 30点到達テスト
- [ ] 50点到達テスト
- [ ] 100点到達テスト
- [ ] 通知送信ログ確認

---

**結論**:

まずは **Phase 1 + Phase 2** を実装して、判断時の通知を完全に動作させることをお勧めします。

これで最低限の運用は開始できます。その後、必要に応じて **Phase 3** を実装してください。
