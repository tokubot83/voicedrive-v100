# è­°é¡Œãƒ¢ãƒ¼ãƒ‰ æ®‹ä½œæ¥­ã¨å®Ÿè£…æ‰‹é †

**ä½œæˆæ—¥**: 2025å¹´10æœˆ19æ—¥

---

## è³ªå•: çµ±åˆãƒ†ã‚¹ãƒˆã‹ã‚‰ã—ã¦æ®‹ã‚Šã®é€šçŸ¥æ©Ÿèƒ½ã‚’å®Ÿè£…ï¼Ÿã©ã†ã„ã†æ‰‹é †ãŒã„ã„ã®ï¼Ÿ

### æ¨å¥¨æ‰‹é †

ä»¥ä¸‹ã®é †åºã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼š

---

## ğŸ“‹ æ¨å¥¨å®Ÿè£…æ‰‹é †

### Phase 1: DBæº–å‚™ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆå¿…é ˆï¼‰

**å„ªå…ˆåº¦**: ğŸ”´ **æœ€é«˜**
**å·¥æ•°**: 1-2æ™‚é–“
**ç†ç”±**: ã“ã‚ŒãŒãªã„ã¨é€šçŸ¥ãŒå®Ÿéš›ã«é€ä¿¡ã•ã‚Œãªã„

#### ã‚¹ãƒ†ãƒƒãƒ—1-1: Prisma Migrateå®Ÿè¡Œ

```bash
# Schemaå¤‰æ›´ã‚’DBã«é©ç”¨
npx prisma migrate dev --name add-agenda-decision-fields

# ã¾ãŸã¯
npm run prisma:migrate
```

**ç¢ºèªäº‹é …**:
- [ ] `agenda_status`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ
- [ ] `agenda_decision_by`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ
- [ ] `agenda_decision_at`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ
- [ ] `agenda_decision_reason`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ
- [ ] `agenda_rescue_level`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ
- [ ] `agenda_voting_deadline`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸ

---

#### ã‚¹ãƒ†ãƒƒãƒ—1-2: ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ

```sql
-- å„ãƒ¬ãƒ™ãƒ«ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
INSERT INTO User (id, employeeId, email, name, department, facilityId, permissionLevel, accountType, isRetired)
VALUES
  -- æŠ•ç¨¿è€…
  ('test-author-1', 'AUT001', 'author@test.com', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿è€…', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 1, 'staff', false),

  -- ä¸»ä»»ï¼ˆLevel 3.5ï¼‰
  ('test-supervisor-1', 'SUP001', 'supervisor@test.com', 'ä¸»ä»»ãƒ†ã‚¹ãƒˆå¤ªéƒ', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 3.5, 'staff', false),

  -- å¸«é•·ï¼ˆLevel 7ï¼‰
  ('test-manager-1', 'MGR001', 'manager@test.com', 'å¸«é•·ãƒ†ã‚¹ãƒˆèŠ±å­', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 7, 'staff', false),

  -- å‰¯çœ‹è­·éƒ¨é•·ï¼ˆLevel 8ï¼‰
  ('test-deputy-1', 'DEP001', 'deputy@test.com', 'å‰¯çœ‹è­·éƒ¨é•·ãƒ†ã‚¹ãƒˆ', 'çœ‹è­·éƒ¨', 'facility-1', 8, 'staff', false),

  -- äº‹å‹™é•·ï¼ˆLevel 11ï¼‰
  ('test-affairs-1', 'AFF001', 'affairs@test.com', 'äº‹å‹™é•·ãƒ†ã‚¹ãƒˆ', 'ç·å‹™éƒ¨', 'facility-1', 11, 'staff', false),

  -- æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ï¼ˆLevel 18ï¼‰
  ('test-director-1', 'DIR001', 'director@test.com', 'æ³•äººçµ±æ‹¬äº‹å‹™å±€é•·ãƒ†ã‚¹ãƒˆ', 'æ³•äººæœ¬éƒ¨', 'facility-1', 18, 'executive', false),

  -- éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ3åï¼‰
  ('test-member-1', 'MEM001', 'member1@test.com', 'ãƒ¡ãƒ³ãƒãƒ¼1', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 1, 'staff', false),
  ('test-member-2', 'MEM002', 'member2@test.com', 'ãƒ¡ãƒ³ãƒãƒ¼2', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 1, 'staff', false),
  ('test-member-3', 'MEM003', 'member3@test.com', 'ãƒ¡ãƒ³ãƒãƒ¼3', 'çœ‹è­·éƒ¨Aç—…æ£Ÿ', 'facility-1', 1, 'staff', false);

-- ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ã‚’ä½œæˆ
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  -- 50ç‚¹ã®æŠ•ç¨¿ï¼ˆä¸»ä»»åˆ¤æ–­å¾…ã¡ï¼‰
  ('test-post-50', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š50ç‚¹åˆ°é” - æ¥­å‹™åŠ¹ç‡åŒ–ã®ãŸã‚ã®æ–°ã‚·ã‚¹ãƒ†ãƒ å°å…¥ææ¡ˆ', 'test-author-1', 'full', 'active', 50, 'DEPT_AGENDA', 'pending', datetime('now')),

  -- ä¸»ä»»æ¨è–¦æ¸ˆã¿ã®æŠ•ç¨¿ï¼ˆå¸«é•·åˆ¤æ–­å¾…ã¡ï¼‰
  ('test-post-50-rec', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼šä¸»ä»»æ¨è–¦æ¸ˆã¿ - æ‚£è€…ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šææ¡ˆ', 'test-author-1', 'full', 'active', 52, 'DEPT_AGENDA', 'recommended_to_manager', datetime('now')),

  -- 100ç‚¹ã®æŠ•ç¨¿ï¼ˆå‰¯çœ‹è­·éƒ¨é•·åˆ¤æ–­å¾…ã¡ï¼‰
  ('test-post-100', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š100ç‚¹åˆ°é” - åŒ»ç™‚å®‰å…¨æ”¹å–„ææ¡ˆ', 'test-author-1', 'full', 'active', 100, 'FACILITY_AGENDA', 'pending_deputy_director_review', datetime('now')),

  -- 300ç‚¹ã®æŠ•ç¨¿ï¼ˆäº‹å‹™é•·åˆ¤æ–­å¾…ã¡ï¼‰
  ('test-post-300', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š300ç‚¹åˆ°é” - æ–½è¨­æ¨ªæ–­çš„ãªæ¥­å‹™æ”¹å–„', 'test-author-1', 'full', 'active', 300, 'CORP_REVIEW', 'pending_general_affairs_review', datetime('now')),

  -- 600ç‚¹ã®æŠ•ç¨¿ï¼ˆæ³•äººçµ±æ‹¬äº‹å‹™å±€é•·åˆ¤æ–­å¾…ã¡ï¼‰
  ('test-post-600', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š600ç‚¹åˆ°é” - æ³•äººå…¨ä½“ã®çµŒå–¶æ”¹é©ææ¡ˆ', 'test-author-1', 'full', 'active', 600, 'CORP_AGENDA', 'pending_general_affairs_director_review', datetime('now'));
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—1-3: ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AgendaLevelNotificationService.ts`

**å®Ÿè£…å†…å®¹**:

```typescript
import { prisma } from '@/lib/prisma';

// ========== Prismaçµ±åˆæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ¡ã‚½ãƒƒãƒ‰ ==========

/**
 * ä¸»ä»»ï¼ˆLevel 3.5ï¼‰ã‚’éƒ¨ç½²ã§å–å¾—
 */
private async getManagersByDepartment(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        department,
        permissionLevel: 3.5,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] ä¸»ä»»å–å¾—: ${department} â†’ ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] ä¸»ä»»å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

/**
 * éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
 */
private async getDepartmentMembersByDept(department: string | undefined): Promise<User[]> {
  if (!department) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        department,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼å–å¾—: ${department} â†’ ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

/**
 * å‰¯çœ‹è­·éƒ¨é•·ï¼ˆLevel 8ï¼‰ã‚’æ–½è¨­ã§å–å¾—
 */
private async getDeputyDirectorsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        permissionLevel: 8,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] å‰¯çœ‹è­·éƒ¨é•·å–å¾—: ${facilityId} â†’ ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] å‰¯çœ‹è­·éƒ¨é•·å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

/**
 * æ–½è¨­ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—
 */
private async getFacilityMembers(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] æ–½è¨­ãƒ¡ãƒ³ãƒãƒ¼å–å¾—: ${facilityId} â†’ ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] æ–½è¨­ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

/**
 * äº‹å‹™é•·ï¼ˆLevel 11ï¼‰ã‚’æ–½è¨­ã§å–å¾—
 */
private async getGeneralAffairsByFacility(facilityId: string | undefined): Promise<User[]> {
  if (!facilityId) return [];

  try {
    const users = await prisma.user.findMany({
      where: {
        facilityId,
        permissionLevel: 11,
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] äº‹å‹™é•·å–å¾—: ${facilityId} â†’ ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] äº‹å‹™é•·å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}

/**
 * æ³•äººå†…å…¨è·å“¡ã‚’å–å¾—
 */
private async getCorporationMembers(): Promise<User[]> {
  try {
    const users = await prisma.user.findMany({
      where: {
        isRetired: false,
      },
    });
    console.log(`[AgendaLevelNotification] æ³•äººå†…å…¨è·å“¡å–å¾—: ${users.length}å`);
    return users as User[];
  } catch (error) {
    console.error('[AgendaLevelNotification] æ³•äººå†…å…¨è·å“¡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return [];
  }
}
```

**ç¢ºèªäº‹é …**:
- [ ] æ—¢å­˜ã®TODOãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã§ç½®ãæ›ãˆã‚‹
- [ ] `prisma`ã®importã‚’è¿½åŠ 
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
- [ ] ãƒ­ã‚°å‡ºåŠ›ã‚’è¿½åŠ ï¼ˆå–å¾—ä»¶æ•°ç¢ºèªç”¨ï¼‰

---

### Phase 2: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆåˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼‰

**å„ªå…ˆåº¦**: ğŸ”´ **æœ€é«˜**
**å·¥æ•°**: 1-2æ™‚é–“
**ç†ç”±**: Phase 1ã®å®Ÿè£…ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèª

#### ã‚¹ãƒ†ãƒƒãƒ—2-1: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•

```bash
npm run dev
```

**ã‚¢ã‚¯ã‚»ã‚¹**: http://localhost:3001

---

#### ã‚¹ãƒ†ãƒƒãƒ—2-2: APIãƒ†ã‚¹ãƒˆï¼ˆä¸»ä»»ã®åˆ¤æ–­ï¼‰

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: ä¸»ä»»ãŒå¸«é•·ã«æ¨è–¦

```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50",
    "decisionType": "recommend_to_manager",
    "deciderId": "test-supervisor-1",
    "reason": "éƒ¨ç½²å…¨ä½“ã§æ¤œè¨ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚"
  }'
```

**æœŸå¾…çµæœ**:

```json
{
  "success": true,
  "message": "å¸«é•·ã¸ã®æ¨è–¦ãŒå®Œäº†ã—ã¾ã—ãŸ",
  "post": {
    "id": "test-post-50",
    "agendaStatus": "recommended_to_manager",
    "agendaDecisionBy": "test-supervisor-1",
    "agendaDecisionReason": "éƒ¨ç½²å…¨ä½“ã§æ¤œè¨ã™ã‚‹ä¾¡å€¤ãŒã‚ã‚‹ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚"
  },
  "notificationsSent": 2
}
```

**ç¢ºèªé …ç›®**:
- [ ] `notificationsSent`ãŒ2ä»¥ä¸Šï¼ˆæŠ•ç¨¿è€… + å¸«é•·ï¼‰
- [ ] ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«ä»¥ä¸‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹
  ```
  [AgendaLevelNotification] ä¸»ä»»å–å¾—: çœ‹è­·éƒ¨Aç—…æ£Ÿ â†’ 1å
  [NotificationService] é€šçŸ¥é€ä¿¡: test-author-1
  [NotificationService] é€šçŸ¥é€ä¿¡: test-manager-1
  ```
- [ ] DBã®`Post`ãƒ†ãƒ¼ãƒ–ãƒ«ã§`agendaStatus`ãŒ`recommended_to_manager`ã«æ›´æ–°

---

#### ã‚¹ãƒ†ãƒƒãƒ—2-3: APIãƒ†ã‚¹ãƒˆï¼ˆå¸«é•·ã®åˆ¤æ–­ï¼‰

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: å¸«é•·ãŒéƒ¨ç½²è­°é¡Œæ‰¿èª

```bash
curl -X POST http://localhost:3001/api/agenda/decision \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-50-rec",
    "decisionType": "approve_as_dept_agenda",
    "deciderId": "test-manager-1",
    "reason": "éƒ¨ç½²ã®é‡è¦èª²é¡Œã¨ã—ã¦å–ã‚Šä¸Šã’ã¾ã™ã€‚"
  }'
```

**æœŸå¾…çµæœ**:

```json
{
  "success": true,
  "message": "éƒ¨ç½²è­°é¡Œã¨ã—ã¦æ‰¿èªã•ã‚Œã¾ã—ãŸ",
  "notificationsSent": 5
}
```

**ç¢ºèªé …ç›®**:
- [ ] `notificationsSent`ãŒ5ä»¥ä¸Šï¼ˆæŠ•ç¨¿è€… + éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼4åï¼‰
- [ ] ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«ä»¥ä¸‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹
  ```
  [AgendaLevelNotification] éƒ¨ç½²ãƒ¡ãƒ³ãƒãƒ¼å–å¾—: çœ‹è­·éƒ¨Aç—…æ£Ÿ â†’ 5å
  ```

---

#### ã‚¹ãƒ†ãƒƒãƒ—2-4: UIãƒ†ã‚¹ãƒˆ

**å®Ÿè¡Œæ‰‹é †**:

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3001/proposal-management ã‚’é–‹ã
2. ä¸»ä»»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ`test-supervisor-1`ï¼‰ã§ãƒ­ã‚°ã‚¤ãƒ³
3. 50ç‚¹ã®æŠ•ç¨¿ã‚’è¡¨ç¤º
4. ãƒœã‚¿ãƒ³ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª

**ç¢ºèªé …ç›®**:
- [ ] âœ… å¸«é•·ã«æ¨è–¦ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] âŒ å´ä¸‹ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã
- [ ] åˆ¤æ–­ç†ç”±ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã§ãã‚‹
- [ ] é€ä¿¡å¾Œã€æŠ•ç¨¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ›´æ–°ã•ã‚Œã‚‹

---

### Phase 3: ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥å®Ÿè£…ï¼ˆæ¨å¥¨ï¼‰

**å„ªå…ˆåº¦**: ğŸŸ¡ **ä¸­**
**å·¥æ•°**: 3-4æ™‚é–“
**ç†ç”±**: æŠ•ç¥¨æ™‚ã®è‡ªå‹•é€šçŸ¥ã‚’å®Ÿè£…

#### ã‚¹ãƒ†ãƒƒãƒ—3-1: æŠ•ç¥¨å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª

**èª¿æŸ»**: æŠ•ç¥¨å‡¦ç†ãŒã©ã“ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

```bash
# æŠ•ç¥¨é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
grep -r "agendaScore" src/ --include="*.ts" --include="*.tsx"
grep -r "Vote" src/ --include="*.ts" --include="*.tsx"
```

**å€™è£œãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/services/VoteService.ts`
- `src/pages/api/votes/create.ts`
- `src/hooks/useVote.ts`

---

#### ã‚¹ãƒ†ãƒƒãƒ—3-2: ã‚¹ã‚³ã‚¢é–¾å€¤é€šçŸ¥ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AgendaLevelNotificationService.ts`

**è¿½åŠ ãƒ¡ã‚½ãƒƒãƒ‰**:

```typescript
/**
 * 30ç‚¹åˆ°é”æ™‚ã®é€šçŸ¥
 */
async notifyScoreThreshold30(post: any): Promise<number> {
  let count = 0;

  // æŠ•ç¨¿è€…ã«é€šçŸ¥
  await this.sendSimpleNotification({
    userId: post.authorId,
    title: 'ğŸ¯ 30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸ',
    message: `ã‚ãªãŸã®æŠ•ç¨¿ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚ä¸»ä»»ã¨å¸«é•·ãŒæ³¨ç›®ã—ã¦ã„ã¾ã™ã€‚`,
    urgency: 'normal',
    postId: post.id,
  });
  count++;

  // ä¸»ä»»ã«é€šçŸ¥
  const supervisors = await this.getManagersByDepartment(post.author?.department);
  for (const supervisor of supervisors) {
    await this.sendSimpleNotification({
      userId: supervisor.id,
      title: 'ğŸ“Š 30ç‚¹åˆ°é”ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³¨æ„ã—ã¦çµŒéã‚’è¦‹å®ˆã£ã¦ãã ã•ã„ã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  // å¸«é•·ã«é€šçŸ¥
  const managers = await this.getManagersByDepartment(post.author?.department);
  for (const manager of managers) {
    await this.sendSimpleNotification({
      userId: manager.id,
      title: 'ğŸ“Š 30ç‚¹åˆ°é”ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã™',
      message: `ã€Œ${post.content.substring(0, 30)}...ã€ãŒ30ç‚¹ã«åˆ°é”ã—ã¾ã—ãŸã€‚æ³¨æ„ã—ã¦çµŒéã‚’è¦‹å®ˆã£ã¦ãã ã•ã„ã€‚`,
      urgency: 'normal',
      postId: post.id,
    });
    count++;
  }

  return count;
}

// 50ç‚¹ã€100ç‚¹ã€300ç‚¹ã€600ç‚¹ã‚‚åŒæ§˜ã«å®Ÿè£…
// ï¼ˆè©³ç´°ã¯è­°é¡Œãƒ¢ãƒ¼ãƒ‰é€šçŸ¥æ©Ÿèƒ½å®Ÿè£…çŠ¶æ³_20251019.md ã‚’å‚ç…§ï¼‰
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—3-3: æŠ•ç¥¨å‡¦ç†ã«ãƒ•ãƒƒã‚¯è¿½åŠ 

**ä¾‹**: `src/services/VoteService.ts`ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ç•°ãªã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰

```typescript
import { AgendaLevelNotificationService } from './AgendaLevelNotificationService';

class VoteService {
  private notificationService = AgendaLevelNotificationService.getInstance();

  async castVote(postId: string, userId: string, voteType: string) {
    // æŠ•ç¥¨å‰ã®ã‚¹ã‚³ã‚¢ã‚’å–å¾—
    const post = await prisma.post.findUnique({ where: { id: postId } });
    const previousScore = post.agendaScore || 0;

    // æŠ•ç¥¨ã‚’è¨˜éŒ²
    // ... (æ—¢å­˜ã®æŠ•ç¥¨å‡¦ç†)

    // æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
    const newScore = await this.calculateScore(postId);

    // æŠ•ç¨¿ã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
    await prisma.post.update({
      where: { id: postId },
      data: { agendaScore: newScore },
    });

    // ã‚¹ã‚³ã‚¢é–¾å€¤åˆ°é”æ™‚ã®å‡¦ç†
    await this.handleScoreThresholds(postId, previousScore, newScore);

    return { newScore };
  }

  /**
   * ã‚¹ã‚³ã‚¢é–¾å€¤åˆ°é”æ™‚ã®å‡¦ç†
   */
  private async handleScoreThresholds(
    postId: string,
    previousScore: number,
    newScore: number
  ) {
    const post = await prisma.post.findUnique({
      where: { id: postId },
      include: { author: true },
    });

    // 30ç‚¹åˆ°é”
    if (previousScore < 30 && newScore >= 30) {
      await this.notificationService.notifyScoreThreshold30(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_supervisor_review' },
      });
    }

    // 50ç‚¹åˆ°é”
    if (previousScore < 50 && newScore >= 50) {
      await this.notificationService.notifyScoreThreshold50(post);
    }

    // 100ç‚¹åˆ°é”
    if (previousScore < 100 && newScore >= 100) {
      await this.notificationService.notifyScoreThreshold100(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_deputy_director_review' },
      });
    }

    // 300ç‚¹åˆ°é”
    if (previousScore < 300 && newScore >= 300) {
      await this.notificationService.notifyScoreThreshold300(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_review' },
      });
    }

    // 600ç‚¹åˆ°é”
    if (previousScore < 600 && newScore >= 600) {
      await this.notificationService.notifyScoreThreshold600(post);
      await prisma.post.update({
        where: { id: postId },
        data: { agendaStatus: 'pending_general_affairs_director_review' },
      });
    }
  }
}
```

---

### Phase 4: çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½ï¼ˆã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®é€šçŸ¥ï¼‰

**å„ªå…ˆåº¦**: ğŸŸ¡ **ä¸­**
**å·¥æ•°**: 1æ™‚é–“

#### ã‚¹ãƒ†ãƒƒãƒ—4-1: ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ä½œæˆ

```sql
-- 29ç‚¹ã®æŠ•ç¨¿ï¼ˆ30ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆç”¨ï¼‰
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  ('test-post-29', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š29ç‚¹ - 30ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆç”¨', 'test-author-1', 'full', 'active', 29, 'DEPT_REVIEW', 'pending', datetime('now'));

-- 49ç‚¹ã®æŠ•ç¨¿ï¼ˆ50ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆç”¨ï¼‰
INSERT INTO Post (id, type, content, authorId, anonymityLevel, status, agendaScore, agendaLevel, agendaStatus, createdAt)
VALUES
  ('test-post-49', 'proposal', 'ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ï¼š49ç‚¹ - 50ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆç”¨', 'test-author-1', 'full', 'active', 49, 'DEPT_REVIEW', 'pending_supervisor_review', datetime('now'));
```

---

#### ã‚¹ãƒ†ãƒƒãƒ—4-2: æŠ•ç¥¨APIãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**: 29ç‚¹ â†’ 30ç‚¹åˆ°é”

```bash
# æŠ•ç¥¨APIã‚’å‘¼ã³å‡ºã—ã¦30ç‚¹åˆ°é”ã•ã›ã‚‹
curl -X POST http://localhost:3001/api/votes/create \
  -H "Content-Type: application/json" \
  -d '{
    "postId": "test-post-29",
    "userId": "test-member-1",
    "voteType": "strongly_support"
  }'
```

**æœŸå¾…çµæœ**:
- [ ] ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«ä»¥ä¸‹ãŒå‡ºåŠ›ã•ã‚Œã‚‹
  ```
  [VoteService] 30ç‚¹åˆ°é”æ¤œå‡º
  [AgendaLevelNotification] ä¸»ä»»å–å¾—: çœ‹è­·éƒ¨Aç—…æ£Ÿ â†’ 1å
  [NotificationService] é€šçŸ¥é€ä¿¡: test-author-1
  [NotificationService] é€šçŸ¥é€ä¿¡: test-supervisor-1
  [NotificationService] é€šçŸ¥é€ä¿¡: test-manager-1
  ```
- [ ] `agendaStatus`ãŒ`pending_supervisor_review`ã«æ›´æ–°

---

### Phase 5: E2Eãƒ†ã‚¹ãƒˆ

**å„ªå…ˆåº¦**: ğŸŸ¢ **ä½**
**å·¥æ•°**: 2-3æ™‚é–“

#### ã‚¹ãƒ†ãƒƒãƒ—5-1: E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä½œæˆ

**ã‚·ãƒŠãƒªã‚ª**: æŠ•ç¨¿ä½œæˆ â†’ æŠ•ç¥¨ â†’ 30ç‚¹åˆ°é” â†’ 50ç‚¹åˆ°é” â†’ ä¸»ä»»æ¨è–¦ â†’ å¸«é•·æ‰¿èª

**ãƒ„ãƒ¼ãƒ«**: Playwright ã¾ãŸã¯ Cypress

---

## ğŸ“Š ã¾ã¨ã‚

### æœ€å°é™ã®å®Ÿè£…ï¼ˆé‹ç”¨é–‹å§‹å¯èƒ½ï¼‰

**Phase 1 + Phase 2** ã®ã¿å®Ÿè£…

- âœ… åˆ¤æ–­æ™‚ã®é€šçŸ¥ãŒå‹•ä½œ
- âœ… ç®¡ç†è€…ãŒæ‰‹å‹•ã§åˆ¤æ–­ã§ãã‚‹
- âš ï¸ ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ã¯ãªã—

**å·¥æ•°**: 2-4æ™‚é–“

---

### å®Œå…¨å®Ÿè£…

**Phase 1 + Phase 2 + Phase 3 + Phase 4** ã‚’å®Ÿè£…

- âœ… åˆ¤æ–­æ™‚ã®é€šçŸ¥ãŒå‹•ä½œ
- âœ… ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ã‚‚å‹•ä½œ
- âœ… å®Œå…¨ãªè­°é¡Œãƒ¢ãƒ¼ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

**å·¥æ•°**: 6-10æ™‚é–“

---

## ğŸ¯ æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### æ®µéšçš„å®Ÿè£…

1. **ã¾ãš Phase 1 + Phase 2 ã‚’å®Ÿè£…** â†’ é‹ç”¨é–‹å§‹å¯èƒ½
2. **é‹ç”¨ã—ãªãŒã‚‰ Phase 3 ã‚’å®Ÿè£…** â†’ å®Œå…¨å®Ÿè£…

### ç†ç”±

- Phase 1+2 ã ã‘ã§ã‚‚ååˆ†é‹ç”¨å¯èƒ½
- ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ã¯ã€Œã‚ã‚‹ã¨ä¾¿åˆ©ã€ã ãŒå¿…é ˆã§ã¯ãªã„
- å®Ÿéš›ã®é‹ç”¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾—ã¦ã‹ã‚‰ Phase 3 ã‚’å®Ÿè£…ã™ã‚‹æ–¹ãŒåŠ¹ç‡çš„

---

## âœ… å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: DBæº–å‚™ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

- [ ] Prisma Migrateå®Ÿè¡Œ
- [ ] ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
- [ ] ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ä½œæˆ
- [ ] `getManagersByDepartment()`å®Ÿè£…
- [ ] `getDepartmentMembersByDept()`å®Ÿè£…
- [ ] `getDeputyDirectorsByFacility()`å®Ÿè£…
- [ ] `getFacilityMembers()`å®Ÿè£…
- [ ] `getGeneralAffairsByFacility()`å®Ÿè£…
- [ ] `getCorporationMembers()`å®Ÿè£…

### Phase 2: çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆåˆ¤æ–­æ™‚ã®é€šçŸ¥ï¼‰

- [ ] é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
- [ ] ä¸»ä»»ã®åˆ¤æ–­APIãƒ†ã‚¹ãƒˆ
- [ ] å¸«é•·ã®åˆ¤æ–­APIãƒ†ã‚¹ãƒˆ
- [ ] å‰¯çœ‹è­·éƒ¨é•·ã®åˆ¤æ–­APIãƒ†ã‚¹ãƒˆ
- [ ] UIãƒœã‚¿ãƒ³è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
- [ ] é€šçŸ¥é€ä¿¡ãƒ­ã‚°ç¢ºèª

### Phase 3: ã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®è‡ªå‹•é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

- [ ] æŠ•ç¥¨å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ç‰¹å®š
- [ ] `notifyScoreThreshold30()`å®Ÿè£…
- [ ] `notifyScoreThreshold50()`å®Ÿè£…
- [ ] `notifyScoreThreshold100()`å®Ÿè£…
- [ ] `notifyScoreThreshold300()`å®Ÿè£…
- [ ] `notifyScoreThreshold600()`å®Ÿè£…
- [ ] æŠ•ç¥¨å‡¦ç†ã«ãƒ•ãƒƒã‚¯è¿½åŠ 

### Phase 4: çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆã‚¹ã‚³ã‚¢åˆ°é”æ™‚ã®é€šçŸ¥ï¼‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

- [ ] ãƒ†ã‚¹ãƒˆæŠ•ç¨¿ä½œæˆï¼ˆ29ç‚¹ã€49ç‚¹ï¼‰
- [ ] 30ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆ
- [ ] 50ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆ
- [ ] 100ç‚¹åˆ°é”ãƒ†ã‚¹ãƒˆ
- [ ] é€šçŸ¥é€ä¿¡ãƒ­ã‚°ç¢ºèª

---

**çµè«–**:

ã¾ãšã¯ **Phase 1 + Phase 2** ã‚’å®Ÿè£…ã—ã¦ã€åˆ¤æ–­æ™‚ã®é€šçŸ¥ã‚’å®Œå…¨ã«å‹•ä½œã•ã›ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

ã“ã‚Œã§æœ€ä½é™ã®é‹ç”¨ã¯é–‹å§‹ã§ãã¾ã™ã€‚ãã®å¾Œã€å¿…è¦ã«å¿œã˜ã¦ **Phase 3** ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚
