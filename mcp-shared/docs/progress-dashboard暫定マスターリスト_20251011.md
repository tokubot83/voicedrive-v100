# ProgressDashboardï¼ˆé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ç¢ºèªçµæœ

**ä½œæˆæ—¥**: 2025å¹´10æœˆ11æ—¥
**å¯¾è±¡ãƒšãƒ¼ã‚¸**: ProgressDashboardï¼ˆé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰
**ç¢ºèªè€…**: Claude Code
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ç¢ºèªå®Œäº† âœ…

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

ProgressDashboardï¼ˆé€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ãƒšãƒ¼ã‚¸ã¯ã€è¤‡æ•°éƒ¨ç½²ãƒ»æ–½è¨­å…¨ä½“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã‚’ä¿¯ç°çš„ã«å¯è¦–åŒ–ã™ã‚‹æ©Ÿèƒ½ã§ã™ï¼ˆLevel 10+ï¼šéƒ¨é•·ä»¥ä¸Šï¼‰ã€‚

**çµè«–**: åŒ»ç™‚è·å“¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã®**æ–°è¦APIå®Ÿè£…ã¯ä¸è¦**ã§ã™ã€‚

- âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ æ—¢å­˜APIï¼ˆfacilities/departments/employeesï¼‰ã®ã¿ä½¿ç”¨
- âš ï¸ VoiceDriveå´ã§**2ã¤ã®æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãŒå¿…è¦**ï¼ˆProjectMilestone/ProjectTeamMemberï¼‰
- âš ï¸ Postãƒ†ãƒ¼ãƒ–ãƒ«ã«**3ã¤ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ãŒå¿…è¦**ï¼ˆprojectDueDate/projectLevel/projectProgressï¼‰
- ğŸ”§ VoiceDriveå´ã§**3ã¤ã®APIå®Ÿè£…ãŒå¿…è¦**

---

## 1. æš«å®šãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆåˆ†æçµæœ

### 1.1 ãƒšãƒ¼ã‚¸æ¦‚è¦
- **å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼**: Level 10+ï¼ˆéƒ¨é•·ä»¥ä¸Šï¼‰
- **ä¸»è¦æ©Ÿèƒ½**:
  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ä»˜ãï¼‰
  - çµ±è¨ˆã‚µãƒãƒªãƒ¼è¡¨ç¤ºï¼ˆç·æ•°/é€²è¡Œä¸­/å®Œäº†/é…å»¶/å¹³å‡é€²æ—ï¼‰
  - ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—å¯è¦–åŒ–
  - ãƒãƒ¼ãƒ ã‚µã‚¤ã‚ºè¡¨ç¤º

### 1.2 ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«/API | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ |
|-----------|----------------|----------------|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ± | VoiceDrive.Post | âŒ ä¸è¦ |
| ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æƒ…å ± | VoiceDrive.ProjectMilestoneï¼ˆæ–°è¦ï¼‰ | âŒ ä¸è¦ |
| ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ± | VoiceDrive.ProjectTeamMemberï¼ˆæ–°è¦ï¼‰ | âŒ ä¸è¦ |
| æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼ | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API `/api/v2/facilities` | âœ… æ—¢å­˜APIä½¿ç”¨ |
| éƒ¨é–€ãƒã‚¹ã‚¿ãƒ¼ | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API `/api/v2/departments` | âœ… æ—¢å­˜APIä½¿ç”¨ |
| è·å“¡æƒ…å ± | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API `/api/v2/employees/{id}` | âœ… æ—¢å­˜APIä½¿ç”¨ |

**çµè«–**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã¯VoiceDriveå†…éƒ¨ã§å®Œçµã—ã€æ–½è¨­ãƒ»éƒ¨é–€ãƒ»è·å“¡æƒ…å ±ã®ã¿æ—¢å­˜åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### 1.3 ãƒ†ãƒ¼ãƒ–ãƒ«è¦ä»¶åˆ†æ

#### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«1: ProjectMilestoneï¼ˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ï¼‰

```prisma
model ProjectMilestone {
  id                String    @id @default(cuid())
  projectId         String    @map("project_id")
  title             String
  description       String?   @db.Text
  dueDate           DateTime  @map("due_date")
  completedAt       DateTime? @map("completed_at")
  completedBy       String?   @map("completed_by")
  status            String    @default("pending") // 'pending' | 'in_progress' | 'completed' | 'cancelled'
  order             Int       @default(0)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  project           Post      @relation("ProjectMilestones", fields: [projectId], references: [id], onDelete: Cascade)
  completedByUser   User?     @relation("MilestoneCompletedBy", fields: [completedBy], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@map("project_milestones")
}
```

#### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«2: ProjectTeamMemberï¼ˆãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ï¼‰

```prisma
model ProjectTeamMember {
  id                String    @id @default(cuid())
  projectId         String    @map("project_id")
  userId            String    @map("user_id")
  role              String    @default("member") // 'leader' | 'sub_leader' | 'member' | 'observer'
  joinedAt          DateTime  @default(now()) @map("joined_at")
  leftAt            DateTime? @map("left_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  project           Post      @relation("ProjectTeamMembers", fields: [projectId], references: [id], onDelete: Cascade)
  user              User      @relation("ProjectMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([role])
  @@map("project_team_members")
}
```

#### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ: Post

```prisma
model Post {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  // ProgressDashboardçµ±åˆå®Ÿè£…ï¼ˆ2025-10-11ï¼‰
  projectDueDate      DateTime? @map("project_due_date")      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé™
  projectLevel        String?   @map("project_level")         // 'team' | 'department' | 'facility' | 'organization'
  projectProgress     Int?      @default(0) @map("project_progress")  // é€²æ—ç‡ï¼ˆ0-100ï¼‰

  // Relations
  milestones          ProjectMilestone[]   @relation("ProjectMilestones")
  teamMembers         ProjectTeamMember[]  @relation("ProjectTeamMembers")

  // æ–°è¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  @@index([type, status, createdAt])  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—ç”¨
  @@index([projectDueDate])            // æœŸé™ã‚½ãƒ¼ãƒˆãƒ»é…å»¶åˆ¤å®šç”¨
  @@index([projectLevel])              // ãƒ¬ãƒ™ãƒ«åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨
}
```

#### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ: User

```prisma
model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  // ProgressDashboardçµ±åˆå®Ÿè£…ï¼ˆ2025-10-11ï¼‰
  projectMemberships      ProjectTeamMember[]   @relation("ProjectMemberships")
  completedMilestones     ProjectMilestone[]    @relation("MilestoneCompletedBy")
}
```

---

## 2. åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œä¸è¦é …ç›®

### 2.1 æ–°è¦APIä¸è¦

ProgressDashboardãƒšãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®æ—¢å­˜APIã®ã¿ä½¿ç”¨ã—ã¾ã™ï¼š

âœ… **æ—¢å­˜APIï¼ˆãã®ã¾ã¾ä½¿ç”¨ï¼‰**:
- `GET /api/v2/facilities` - æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼å–å¾—
- `GET /api/v2/departments` - éƒ¨é–€ãƒã‚¹ã‚¿ãƒ¼å–å¾—
- `GET /api/v2/employees/{employeeId}` - è·å“¡æƒ…å ±å–å¾—

âŒ **æ–°è¦APIä¸è¦**:
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†é–¢é€£APIï¼ˆã™ã¹ã¦VoiceDriveå†…éƒ¨ã§å®Ÿè£…ï¼‰

### 2.2 æ—¢å­˜APIã®ä½¿ç”¨ç›®çš„

#### GET /api/v2/facilities
**ç”¨é€”**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«åˆ¤å®šã¨æ–½è¨­åè¡¨ç¤º

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// æ–½è¨­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–½è¨­åè¡¨ç¤º
const facility = await medicalSystemAPI.getFacility(project.facilityId);
console.log(`æ–½è¨­: ${facility.name}`);
```

#### GET /api/v2/departments
**ç”¨é€”**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«åˆ¤å®šã¨éƒ¨é–€åè¡¨ç¤º

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// éƒ¨é–€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®éƒ¨é–€åè¡¨ç¤º
const department = await medicalSystemAPI.getDepartment(project.departmentId);
console.log(`éƒ¨é–€: ${department.name}`);
```

#### GET /api/v2/employees/{id}
**ç”¨é€”**: ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°æƒ…å ±å–å¾—ã€æ¨©é™ãƒ¬ãƒ™ãƒ«ç¢ºèª

**ä½¿ç”¨ç®‡æ‰€**:
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ãƒã‚§ãƒƒã‚¯
const employee = await medicalSystemAPI.getEmployee(userId);
if (employee.level < 10) {
  throw new Error('Level 10+ required');
}
```

---

## 3. VoiceDriveå´å®Ÿè£…æ¨å¥¨äº‹é …

### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³1: Postãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

```sql
-- Migration: add_progress_dashboard_fields_to_post
-- Description: ProgressDashboardç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 

ALTER TABLE "Post"
ADD COLUMN "project_due_date" TIMESTAMP,
ADD COLUMN "project_level" TEXT,
ADD COLUMN "project_progress" INTEGER DEFAULT 0;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
CREATE INDEX "Post_type_status_createdAt_idx"
ON "Post"("type", "status", "createdAt" DESC);

CREATE INDEX "Post_projectDueDate_idx"
ON "Post"("project_due_date");

CREATE INDEX "Post_projectLevel_idx"
ON "Post"("project_level");

-- æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
UPDATE "Post"
SET
  "project_due_date" = "createdAt" + INTERVAL '3 months',
  "project_level" = 'team',
  "project_progress" = 0
WHERE "type" = 'project'
  AND "project_due_date" IS NULL;
```

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: Phase 1å®Ÿè£…å‰ï¼ˆå¿…é ˆï¼‰

**å½±éŸ¿ç¯„å›²**:
- ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ï¼‰
- æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è‡ªå‹•è¨­å®š

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³2: ProjectMilestoneãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
-- Migration: create_project_milestones_table
-- Description: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

CREATE TABLE "project_milestones" (
  "id" TEXT PRIMARY KEY,
  "project_id" TEXT NOT NULL,
  "title" TEXT NOT NULL,
  "description" TEXT,
  "due_date" TIMESTAMP NOT NULL,
  "completed_at" TIMESTAMP,
  "completed_by" TEXT,
  "status" TEXT NOT NULL DEFAULT 'pending',
  "order" INTEGER NOT NULL DEFAULT 0,
  "created_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT "fk_project_milestones_project"
    FOREIGN KEY ("project_id") REFERENCES "Post"("id") ON DELETE CASCADE,
  CONSTRAINT "fk_project_milestones_completed_by"
    FOREIGN KEY ("completed_by") REFERENCES "User"("id") ON DELETE SET NULL
);

CREATE INDEX "ProjectMilestone_projectId_idx"
ON "project_milestones"("project_id");

CREATE INDEX "ProjectMilestone_status_idx"
ON "project_milestones"("status");

CREATE INDEX "ProjectMilestone_dueDate_idx"
ON "project_milestones"("due_date");
```

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: Phase 1å®Ÿè£…å‰ï¼ˆå¿…é ˆï¼‰

**å½±éŸ¿ç¯„å›²**:
- æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãªã—ï¼‰
- ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: æœ€å°ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³3: ProjectTeamMemberãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
-- Migration: create_project_team_members_table
-- Description: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

CREATE TABLE "project_team_members" (
  "id" TEXT PRIMARY KEY,
  "project_id" TEXT NOT NULL,
  "user_id" TEXT NOT NULL,
  "role" TEXT NOT NULL DEFAULT 'member',
  "joined_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "left_at" TIMESTAMP,
  "created_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT "fk_project_team_members_project"
    FOREIGN KEY ("project_id") REFERENCES "Post"("id") ON DELETE CASCADE,
  CONSTRAINT "fk_project_team_members_user"
    FOREIGN KEY ("user_id") REFERENCES "User"("id") ON DELETE CASCADE,
  CONSTRAINT "uq_project_team_members_project_user"
    UNIQUE ("project_id", "user_id")
);

CREATE INDEX "ProjectTeamMember_projectId_idx"
ON "project_team_members"("project_id");

CREATE INDEX "ProjectTeamMember_userId_idx"
ON "project_team_members"("user_id");

CREATE INDEX "ProjectTeamMember_role_idx"
ON "project_team_members"("role");
```

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: Phase 1å®Ÿè£…å‰ï¼ˆå¿…é ˆï¼‰

**å½±éŸ¿ç¯„å›²**:
- æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«å½±éŸ¿ãªã—ï¼‰
- UNIQUEåˆ¶ç´„ã«ã‚ˆã‚Šé‡è¤‡å‚åŠ ã‚’é˜²æ­¢

### 3.2 ã‚µãƒ¼ãƒ“ã‚¹å±¤å®Ÿè£…ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### ProgressDashboardServiceå®Ÿè£…ä¾‹

```typescript
// src/services/ProgressDashboardService.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export class ProgressDashboardService {
  /**
   * ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
   */
  async getAccessibleProjects(userId: string, options: {
    filter?: 'all' | 'active' | 'completed' | 'delayed';
    facilityId?: string;
    departmentId?: string;
    limit?: number;
    offset?: number;
  }) {
    const { filter = 'all', limit = 20, offset = 0 } = options;

    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å–å¾—
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true, level: true, facilityId: true, departmentId: true }
    });

    if (!user) {
      throw new Error('User not found');
    }

    if (user.level < 10) {
      throw new Error('Level 10+ required for ProgressDashboard');
    }

    // 2. WHEREæ¡ä»¶æ§‹ç¯‰
    const where: any = { type: 'project' };

    // 2.1 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    if (filter === 'active') {
      where.status = 'active';
    } else if (filter === 'completed') {
      where.status = 'completed';
    }

    // 2.2 æ¨©é™ãƒ™ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (user.level < 13) {
      // Level 10-12: è‡ªæ–½è¨­ã®ã¿
      where.author = {
        facilityId: options.facilityId || user.facilityId
      };

      if (user.level === 10) {
        // Level 10 (éƒ¨é•·): è‡ªéƒ¨é–€ã®ã¿
        where.author = {
          ...where.author,
          departmentId: options.departmentId || user.departmentId
        };
      }
    }
    // Level 13+: å…¨æ–½è¨­ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰

    // 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
    const projects = await prisma.post.findMany({
      where,
      include: {
        author: {
          select: {
            id: true,
            name: true,
            facilityId: true,
            departmentId: true
          }
        },
        milestones: {
          select: {
            id: true,
            status: true
          }
        },
        teamMembers: {
          where: { leftAt: null },
          select: {
            id: true,
            userId: true,
            role: true
          }
        },
        _count: {
          select: {
            milestones: true,
            teamMembers: true
          }
        }
      },
      orderBy: { createdAt: 'desc' },
      skip: offset,
      take: limit
    });

    // 4. ç·ä»¶æ•°å–å¾—
    const totalCount = await prisma.post.count({ where });

    // 5. ãƒ‡ãƒ¼ã‚¿åŠ å·¥ï¼ˆé…å»¶åˆ¤å®šãƒ»é€²æ—è¨ˆç®—ï¼‰
    const now = new Date();
    const result = projects.map(project => {
      const completedMilestones = project.milestones.filter(m => m.status === 'completed').length;
      const totalMilestones = project.milestones.length;

      // é€²æ—è¨ˆç®—
      const progress = totalMilestones > 0
        ? Math.round((completedMilestones / totalMilestones) * 100)
        : project.projectProgress || 0;

      // é…å»¶åˆ¤å®š
      const isDelayed = project.projectDueDate &&
                       project.projectDueDate < now &&
                       project.status !== 'completed';

      return {
        id: project.id,
        title: project.title || 'ç„¡é¡Œã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
        description: project.content,
        status: project.status,
        progress,
        teamSize: project._count.teamMembers,
        completedMilestones,
        totalMilestones,
        dueDate: project.projectDueDate?.toISOString(),
        isDelayed,
        level: project.projectLevel,
        createdAt: project.createdAt.toISOString()
      };
    });

    // 6. é…å»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¿…è¦ãªå ´åˆï¼‰
    const filteredResult = filter === 'delayed'
      ? result.filter(p => p.isDelayed)
      : result;

    return {
      projects: filteredResult,
      pagination: {
        total: totalCount,
        limit,
        offset,
        hasMore: offset + limit < totalCount
      }
    };
  }

  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆå–å¾—
   */
  async getProjectStats(userId: string, options: {
    facilityId?: string;
    departmentId?: string;
  }) {
    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™å–å¾—
    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { id: true, level: true, facilityId: true, departmentId: true }
    });

    if (!user || user.level < 10) {
      throw new Error('Insufficient permissions');
    }

    // 2. WHEREæ¡ä»¶æ§‹ç¯‰ï¼ˆgetAccessibleProjectsã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const where: any = { type: 'project' };

    if (user.level < 13) {
      where.author = {
        facilityId: options.facilityId || user.facilityId
      };
      if (user.level === 10) {
        where.author = {
          ...where.author,
          departmentId: options.departmentId || user.departmentId
        };
      }
    }

    // 3. ä¸¦åˆ—ã‚¯ã‚¨ãƒªã§çµ±è¨ˆå–å¾—
    const [total, active, completed, allProjects] = await Promise.all([
      prisma.post.count({ where }),
      prisma.post.count({ where: { ...where, status: 'active' } }),
      prisma.post.count({ where: { ...where, status: 'completed' } }),
      prisma.post.findMany({
        where,
        include: {
          milestones: {
            select: { status: true }
          }
        }
      })
    ]);

    // 4. é…å»¶åˆ¤å®š
    const now = new Date();
    const delayed = allProjects.filter(p =>
      p.projectDueDate && p.projectDueDate < now && p.status !== 'completed'
    ).length;

    // 5. å¹³å‡é€²æ—è¨ˆç®—
    const avgProgress = allProjects.length > 0
      ? Math.round(
          allProjects.reduce((sum, p) => {
            const completedMilestones = p.milestones.filter(m => m.status === 'completed').length;
            const totalMilestones = p.milestones.length;
            const progress = totalMilestones > 0
              ? (completedMilestones / totalMilestones) * 100
              : p.projectProgress || 0;
            return sum + progress;
          }, 0) / allProjects.length
        )
      : 0;

    return {
      total,
      active,
      completed,
      delayed,
      avgProgress
    };
  }

  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§å–å¾—
   */
  async getProjectMilestones(projectId: string, userId: string) {
    // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª
    const project = await prisma.post.findUnique({
      where: { id: projectId },
      include: {
        author: {
          select: { facilityId: true, departmentId: true }
        }
      }
    });

    if (!project) {
      throw new Error('Project not found');
    }

    const user = await prisma.user.findUnique({
      where: { id: userId },
      select: { level: true, facilityId: true, departmentId: true }
    });

    if (!user || user.level < 10) {
      throw new Error('Insufficient permissions');
    }

    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    if (user.level < 13) {
      if (user.facilityId !== project.author.facilityId) {
        throw new Error('Access denied: different facility');
      }
      if (user.level === 10 && user.departmentId !== project.author.departmentId) {
        throw new Error('Access denied: different department');
      }
    }

    // 2. ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å–å¾—
    const milestones = await prisma.projectMilestone.findMany({
      where: { projectId },
      include: {
        completedByUser: {
          select: {
            id: true,
            name: true
          }
        }
      },
      orderBy: { order: 'asc' }
    });

    return milestones.map(m => ({
      id: m.id,
      title: m.title,
      description: m.description,
      dueDate: m.dueDate.toISOString(),
      completedAt: m.completedAt?.toISOString(),
      completedBy: m.completedByUser ? {
        id: m.completedByUser.id,
        name: m.completedByUser.name
      } : null,
      status: m.status,
      order: m.order
    }));
  }
}
```

### 3.3 APIå®Ÿè£…ï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### API 1: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—

```typescript
// src/app/api/progress-dashboard/projects/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProgressDashboardService } from '@/services/ProgressDashboardService';
import { authenticateUser } from '@/lib/auth';

const service = new ProgressDashboardService();

export async function GET(request: NextRequest) {
  try {
    // èªè¨¼
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    // Level 10+ãƒã‚§ãƒƒã‚¯
    if (user.level < 10) {
      return NextResponse.json(
        {
          error: {
            code: 'FORBIDDEN',
            message: 'ã“ã®ãƒšãƒ¼ã‚¸ã¯éƒ¨é•·ä»¥ä¸Šã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™',
            details: `User level: ${user.level}, Required: 10+`
          }
        },
        { status: 403 }
      );
    }

    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    const searchParams = request.nextUrl.searchParams;
    const filter = searchParams.get('filter') as 'all' | 'active' | 'completed' | 'delayed' | undefined;
    const facilityId = searchParams.get('facilityId') || undefined;
    const departmentId = searchParams.get('departmentId') || undefined;
    const limit = parseInt(searchParams.get('limit') || '20', 10);
    const offset = parseInt(searchParams.get('offset') || '0', 10);

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (filter && !['all', 'active', 'completed', 'delayed'].includes(filter)) {
      return NextResponse.json(
        {
          error: {
            code: 'INVALID_PARAMETER',
            message: 'Invalid filter parameter',
            details: 'filter must be one of: all, active, completed, delayed'
          }
        },
        { status: 400 }
      );
    }

    if (limit < 1 || limit > 100) {
      return NextResponse.json(
        { error: { code: 'INVALID_PARAMETER', message: 'limit must be between 1-100' } },
        { status: 400 }
      );
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    const result = await service.getAccessibleProjects(user.id, {
      filter,
      facilityId,
      departmentId,
      limit,
      offset
    });

    return NextResponse.json({
      data: result.projects,
      pagination: result.pagination,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/progress-dashboard/projects error:', error);

    if (error.message.includes('permissions')) {
      return NextResponse.json(
        { error: { code: 'FORBIDDEN', message: error.message } },
        { status: 403 }
      );
    }

    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch projects',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

#### API 2: çµ±è¨ˆã‚µãƒãƒªãƒ¼å–å¾—

```typescript
// src/app/api/progress-dashboard/stats/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProgressDashboardService } from '@/services/ProgressDashboardService';
import { authenticateUser } from '@/lib/auth';

const service = new ProgressDashboardService();

export async function GET(request: NextRequest) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    if (user.level < 10) {
      return NextResponse.json(
        { error: { code: 'FORBIDDEN', message: 'Level 10+ required' } },
        { status: 403 }
      );
    }

    const searchParams = request.nextUrl.searchParams;
    const facilityId = searchParams.get('facilityId') || undefined;
    const departmentId = searchParams.get('departmentId') || undefined;

    const stats = await service.getProjectStats(user.id, {
      facilityId,
      departmentId
    });

    return NextResponse.json({
      data: stats,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/progress-dashboard/stats error:', error);
    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch stats',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

#### API 3: ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ä¸€è¦§å–å¾—

```typescript
// src/app/api/progress-dashboard/projects/[projectId]/milestones/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { ProgressDashboardService } from '@/services/ProgressDashboardService';
import { authenticateUser } from '@/lib/auth';

const service = new ProgressDashboardService();

export async function GET(
  request: NextRequest,
  { params }: { params: { projectId: string } }
) {
  try {
    const user = await authenticateUser(request);
    if (!user) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      );
    }

    const milestones = await service.getProjectMilestones(params.projectId, user.id);

    return NextResponse.json({
      data: milestones,
      meta: {
        timestamp: new Date().toISOString()
      }
    });

  } catch (error: any) {
    console.error('GET /api/progress-dashboard/projects/:id/milestones error:', error);

    if (error.message.includes('not found')) {
      return NextResponse.json(
        { error: { code: 'NOT_FOUND', message: 'Project not found' } },
        { status: 404 }
      );
    }

    if (error.message.includes('denied')) {
      return NextResponse.json(
        { error: { code: 'FORBIDDEN', message: error.message } },
        { status: 403 }
      );
    }

    return NextResponse.json(
      {
        error: {
          code: 'INTERNAL_SERVER_ERROR',
          message: 'Failed to fetch milestones',
          details: error.message
        }
      },
      { status: 500 }
    );
  }
}
```

### 3.4 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

#### useProgressDashboardãƒ•ãƒƒã‚¯å®Ÿè£…ä¾‹

```typescript
// src/hooks/useProgressDashboard.ts

import useSWR from 'swr';

interface Project {
  id: string;
  title: string;
  description: string;
  status: string;
  progress: number;
  teamSize: number;
  completedMilestones: number;
  totalMilestones: number;
  dueDate: string;
  isDelayed: boolean;
  level: string;
  createdAt: string;
}

interface ProjectStats {
  total: number;
  active: number;
  completed: number;
  delayed: number;
  avgProgress: number;
}

export function useProgressDashboard(
  filter: 'all' | 'active' | 'completed' | 'delayed',
  options?: {
    facilityId?: string;
    departmentId?: string;
  }
) {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
  const queryParams = new URLSearchParams({
    filter,
    ...(options?.facilityId && { facilityId: options.facilityId }),
    ...(options?.departmentId && { departmentId: options.departmentId })
  });

  const { data: projectsData, error: projectsError, isLoading: projectsLoading } = useSWR<{
    data: Project[];
    pagination: {
      total: number;
      limit: number;
      offset: number;
      hasMore: boolean;
    };
  }>(`/api/progress-dashboard/projects?${queryParams.toString()}`);

  // çµ±è¨ˆã‚µãƒãƒªãƒ¼å–å¾—
  const statsQueryParams = new URLSearchParams({
    ...(options?.facilityId && { facilityId: options.facilityId }),
    ...(options?.departmentId && { departmentId: options.departmentId })
  });

  const { data: statsData, error: statsError, isLoading: statsLoading } = useSWR<{
    data: ProjectStats;
  }>(`/api/progress-dashboard/stats?${statsQueryParams.toString()}`, {
    refreshInterval: 60000  // 1åˆ†ã”ã¨ã«å†å–å¾—
  });

  return {
    projects: projectsData?.data || [],
    pagination: projectsData?.pagination,
    stats: statsData?.data,
    isLoading: projectsLoading || statsLoading,
    error: projectsError || statsError
  };
}
```

#### ProgressDashboardPageå®Ÿè£…ä¾‹

```typescript
// src/app/progress-dashboard/page.tsx

'use client';

import { useState } from 'react';
import { useProgressDashboard } from '@/hooks/useProgressDashboard';

export default function ProgressDashboardPage() {
  const [filter, setFilter] = useState<'all' | 'active' | 'completed' | 'delayed'>('all');
  const { projects, stats, isLoading } = useProgressDashboard(filter);

  if (isLoading) {
    return <div className="text-center py-12">èª­ã¿è¾¼ã¿ä¸­...</div>;
  }

  return (
    <div className="min-h-screen bg-gray-900">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-gradient-to-r from-blue-900/50 to-cyan-900/50 rounded-2xl p-6 m-6">
        <h1 className="text-3xl font-bold text-white mb-2">é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p className="text-gray-300">è¤‡æ•°éƒ¨ç½²ãƒ»æ–½è¨­å…¨ä½“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã‚’ä¿¯ç°çš„ã«ç®¡ç†ï¼ˆéƒ¨é•·ä»¥ä¸Šï¼‰</p>
      </div>

      {/* çµ±è¨ˆã‚µãƒãƒªãƒ¼ */}
      {stats && (
        <div className="mx-6 mb-6 grid grid-cols-2 md:grid-cols-5 gap-4">
          <StatCard label="ç·ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°" count={stats.total} />
          <StatCard label="é€²è¡Œä¸­" count={stats.active} color="blue" />
          <StatCard label="å®Œäº†" count={stats.completed} color="green" />
          <StatCard label="é…å»¶" count={stats.delayed} color="red" />
          <StatCard label="å¹³å‡é€²æ—" count={`${stats.avgProgress}%`} color="purple" />
        </div>
      )}

      {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
      <div className="mx-6 mb-6 flex gap-2 bg-gray-800/50 rounded-xl p-2">
        {['all', 'active', 'completed', 'delayed'].map(f => (
          <button
            key={f}
            onClick={() => setFilter(f as any)}
            className={`px-4 py-2 rounded-lg font-medium transition-all ${
              filter === f ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700/50'
            }`}
          >
            {f === 'all' ? 'ã™ã¹ã¦' : f === 'active' ? 'é€²è¡Œä¸­' : f === 'completed' ? 'å®Œäº†' : 'é…å»¶'}
          </button>
        ))}
      </div>

      {/* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ */}
      <div className="mx-6 pb-24 space-y-4">
        {projects.map(project => (
          <ProjectCard key={project.id} project={project} />
        ))}
      </div>
    </div>
  );
}
```

---

## 4. ãƒ†ã‚¹ãƒˆæ¨å¥¨äº‹é …

### 4.1 APIãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰

```typescript
describe('ProgressDashboard API Tests', () => {
  it('GET /api/progress-dashboard/projects - æ­£å¸¸ç³»', async () => {
    const response = await fetch('/api/progress-dashboard/projects?filter=all&limit=10', {
      headers: { Authorization: `Bearer ${level10Token}` }
    });

    expect(response.status).toBe(200);
    const data = await response.json();
    expect(data.data).toBeInstanceOf(Array);
    expect(data.pagination.total).toBeGreaterThanOrEqual(0);
  });

  it('GET /api/progress-dashboard/stats - çµ±è¨ˆå–å¾—', async () => {
    const response = await fetch('/api/progress-dashboard/stats', {
      headers: { Authorization: `Bearer ${level10Token}` }
    });

    expect(response.status).toBe(200);
    const data = await response.json();
    expect(data.data).toHaveProperty('total');
    expect(data.data).toHaveProperty('avgProgress');
  });

  it('Level 9ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯', async () => {
    const response = await fetch('/api/progress-dashboard/projects', {
      headers: { Authorization: `Bearer ${level9Token}` }
    });

    expect(response.status).toBe(403);
  });
});
```

### 4.2 æ¨©é™ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰

```typescript
describe('ProgressDashboard Permission Tests', () => {
  it('Level 10ã¯è‡ªéƒ¨é–€ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½', async () => {
    const response = await fetch('/api/progress-dashboard/projects', {
      headers: { Authorization: `Bearer ${level10DeptAToken}` }
    });

    expect(response.status).toBe(200);
    const data = await response.json();

    // ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè‡ªéƒ¨é–€ã®ã‚‚ã®
    data.data.forEach((project: any) => {
      expect(project.author.departmentId).toBe('dept-A');
    });
  });

  it('Level 13ã¯å…¨æ–½è¨­ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½', async () => {
    const response = await fetch('/api/progress-dashboard/projects', {
      headers: { Authorization: `Bearer ${level13Token}` }
    });

    expect(response.status).toBe(200);
    const data = await response.json();

    // è¤‡æ•°æ–½è¨­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã‚‹
    const facilities = [...new Set(data.data.map((p: any) => p.author.facilityId))];
    expect(facilities.length).toBeGreaterThan(1);
  });
});
```

---

## 5. ãƒªã‚¹ã‚¯ãƒ»æ³¨æ„äº‹é …

### 5.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒªã‚¹ã‚¯ï¼ˆä¸­ï¼‰

**ãƒªã‚¹ã‚¯**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°å¢—åŠ ã«ä¼´ã†ä¸€è¦§å–å¾—ã‚¯ã‚¨ãƒªã®é…å»¶

**å½±éŸ¿**:
- 1,000ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¶…éæ™‚: 500ms-1ç§’ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 
- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³/ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®N+1ã‚¯ã‚¨ãƒªç™ºç”Ÿãƒªã‚¹ã‚¯

**å¯¾ç­–**:
```typescript
// âœ… includeä½¿ç”¨ã§N+1å›é¿
const projects = await prisma.post.findMany({
  where: { type: 'project' },
  include: {
    milestones: true,  // ä¸€æ‹¬å–å¾—
    teamMembers: true,
    _count: { select: { milestones: true, teamMembers: true } }
  }
});
```

### 5.2 æ¨©é™åˆ¶å¾¡ãƒªã‚¹ã‚¯ï¼ˆé«˜ï¼‰

**ãƒªã‚¹ã‚¯**: Level 10ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»–éƒ¨é–€ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–²è¦§

**å½±éŸ¿**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³

**å¯¾ç­–**:
```typescript
// WHEREæ¡ä»¶ã«å¿…ãšæ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ã‚’å«ã‚ã‚‹
if (user.level === 10) {
  where.author = {
    facilityId: user.facilityId,
    departmentId: user.departmentId  // å¿…é ˆ
  };
}
```

### 5.3 é…å»¶åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ãƒªã‚¹ã‚¯ï¼ˆä½ï¼‰

**ãƒªã‚¹ã‚¯**: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å·®ç•°ã«ã‚ˆã‚‹èª¤åˆ¤å®š

**å¯¾ç­–**:
```typescript
// UTCã§çµ±ä¸€æ¯”è¼ƒ
const now = new Date();
const isDelayed = project.projectDueDate.getTime() < now.getTime();
```

---

## 6. å°†æ¥æ‹¡å¼µææ¡ˆ

### 6.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½

```typescript
model ProjectTemplate {
  id               String    @id @default(cuid())
  name             String
  description      String?
  category         String    // 'education' | 'system' | 'workflow' | 'other'
  defaultDuration  Int       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“ï¼ˆæ—¥æ•°ï¼‰

  milestoneTemplates ProjectMilestoneTemplate[]
}

model ProjectMilestoneTemplate {
  id                String    @id @default(cuid())
  templateId        String
  title             String
  description       String?
  daysFromStart     Int       // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹ã‹ã‚‰ã®æ—¥æ•°
  order             Int

  template          ProjectTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
}
```

### 6.2 æ–½è¨­æ¨ªæ–­æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ

```typescript
async generateCrossFacilityReport(): Promise<{
  facilityId: string;
  facilityName: string;
  totalProjects: number;
  completionRate: number;
  avgProgress: number;
}[]> {
  // æ–½è¨­ã”ã¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆã‚’é›†è¨ˆ
}
```

### 6.3 è‡ªå‹•é…å»¶ã‚¢ãƒ©ãƒ¼ãƒˆ

```typescript
// ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã§æ¯æ—¥å®Ÿè¡Œ
async function sendDelayedProjectAlerts() {
  const delayedProjects = await prisma.post.findMany({
    where: {
      type: 'project',
      status: 'active',
      projectDueDate: { lt: new Date() }
    },
    include: {
      teamMembers: {
        where: { role: 'leader' }
      }
    }
  });

  for (const project of delayedProjects) {
    await sendEmail({
      to: project.teamMembers.map(m => m.user.email),
      subject: `[é…å»¶è­¦å‘Š] ${project.title}`,
      body: `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæœŸé™ã‚’éãã¦ã„ã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
    });
  }
}
```

---

## 7. ã¾ã¨ã‚

### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œ

- âœ… **è¿½åŠ å®Ÿè£…ä¸è¦**: æ—¢å­˜APIï¼ˆfacilities/departments/employeesï¼‰ã§å¯¾å¿œå¯èƒ½
- âœ… **æ—¢å­˜æ©Ÿèƒ½ã§å¯¾å¿œ**: æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ã¯ä¸è¦ã§ã™

### VoiceDriveå´ã®å®Ÿè£…è¦ä»¶

- ğŸ”§ **æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**: ProjectMilestone/ProjectTeamMemberï¼ˆå¿…é ˆï¼‰
- ğŸ”§ **Postãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ**: projectDueDate/projectLevel/projectProgressï¼ˆå¿…é ˆï¼‰
- ğŸ”§ **APIå®Ÿè£…**: 3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå¿…é ˆï¼‰
- ğŸ“Š **ãƒ†ã‚¹ãƒˆå®Ÿè£…**: æ¨©é™ãƒ†ã‚¹ãƒˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰

### å®Ÿè£…å„ªå…ˆåº¦

1. **Phase 1ï¼ˆå¿…é ˆï¼‰**: ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
2. **Phase 2ï¼ˆå¿…é ˆï¼‰**: Serviceå±¤ãƒ»APIå®Ÿè£…
3. **Phase 3ï¼ˆæ¨å¥¨ï¼‰**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆ
4. **Phase 4ï¼ˆå°†æ¥ï¼‰**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½

**æ¨å®šå·¥æ•°**: 9æ—¥é–“ï¼ˆPhase 1-3ã®ã¿ï¼‰

---

**æ‰¿èªçŠ¶æ…‹**: VoiceDriveãƒãƒ¼ãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: VoiceDriveãƒãƒ¼ãƒ ã«ã‚ˆã‚‹å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºå®š

---

**æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«**:
- ãªã—

**é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
- `progress-dashboard_DBè¦ä»¶åˆ†æ_20251011.md`ï¼ˆå‚ç…§å…ƒï¼‰
- `å…±é€šDBæ§‹ç¯‰å¾Œ_ä½œæ¥­å†é–‹æŒ‡ç¤ºæ›¸_20250928.md`ï¼ˆæ›´æ–°å¯¾è±¡ï¼‰
