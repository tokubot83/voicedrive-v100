# 既存機能確認：投票期限延長機能
作成日: 2025年10月19日

## 既存実装の確認結果

### ✅ 実装済みファイル

1. **AgendaDeadlineManager.ts** - 期限管理クラス
2. **useAgendaDeadline.ts** - 期限管理フック

---

## AgendaDeadlineManager.ts の機能

### 1. レベル別標準期限設定

| 議題レベル | 標準期限 | 最大期限 | 延長可能 | 自動延長 |
|---|---|---|---|---|
| PENDING | 14日 | 30日 | ✅ | ✅ |
| DEPT_REVIEW | 14日 | 30日 | ✅ | ✅ |
| DEPT_AGENDA | 30日 | 60日 | ✅ | ✅ |
| **FACILITY_AGENDA** | **60日** | **90日** | ✅ | ❌ |
| CORP_REVIEW | 90日 | 180日 | ✅ | ❌ |
| CORP_AGENDA | 90日 | 180日 | ✅ | ❌ |

**重要**: 施設議題（FACILITY_AGENDA）は標準60日、最大90日まで延長可能

### 2. 期限延長メソッド

```typescript
AgendaDeadlineManager.extendDeadline(
  currentDeadline: Date,      // 現在の期限
  agendaLevel: AgendaLevel,   // 議題レベル
  createdAt: Date,            // 投稿作成日
  extensionDays: number = 30  // 延長日数（デフォルト30日）
): Date
```

**特徴**:
- デフォルトで30日延長
- 最大期限を超えないように自動制限
- 例: 施設議題で60日の期限を30日延長 → 90日（最大期限）

### 3. 最大期限チェック

```typescript
AgendaDeadlineManager.hasReachedMaxDeadline(
  currentDeadline: Date,
  agendaLevel: AgendaLevel,
  createdAt: Date
): boolean
```

**用途**: 延長ボタンを表示するかどうかの判定

### 4. 自動延長判定

```typescript
AgendaDeadlineManager.shouldAutoExtend(
  agendaLevel: AgendaLevel,
  lastActivityDate: Date,
  currentDeadline: Date
): boolean
```

**条件**:
- 直近30日以内に活動あり
- 期限まで14日以内
- `autoExtendOnActivity: true` のレベルのみ

**注意**: FACILITY_AGENDA は `autoExtendOnActivity: false` なので自動延長されない

---

## useAgendaDeadline.ts の機能

### 1. 期限監視

```typescript
monitorDeadline(
  post: Post,
  scope: 'department' | 'facility' | 'corporation'
): void
```

**通知タイミング**:
- 72時間前（3日前）
- 24時間前（1日前）

### 2. 手動延長

```typescript
extendDeadline(
  post: Post,
  extensionDays: number = 7  // デフォルト7日
): Promise<void>
```

**処理フロー**:
1. 最大期限チェック
2. 最大期限に達している場合 → エラー
3. 延長実行（AgendaDeadlineManager.extendDeadline() 呼び出し）
4. 通知発火（agendaNotificationIntegration.notifyDeadlineExtension()）

---

## 部署議題モードへの適用

### 師長が施設昇格した場合のフロー

```
師長が「施設議題に昇格」ボタンを押す
  ↓
【自動処理】
- 議題レベル: FACILITY_AGENDA
- 投票期限: 標準60日（AgendaDeadlineManager.calculateInitialDeadline()）
- 投稿公開範囲: 施設内全職員
- 投票範囲: 施設内全職員
  ↓
投票期限到達（例: 85点）
  ↓
師長に通知 → 3つの選択肢:
  ├─ 部署議題承認
  ├─ 却下
  └─ **投票期限延長（+30日）** ← 既存機能を活用！
```

### 延長ボタンの実装案

```typescript
// 師長の判断画面で延長ボタンを表示
const { extendDeadline, isExtending } = useAgendaDeadline(allUsers);

const handleExtendDeadline = async () => {
  try {
    await extendDeadline(post, 30); // +30日延長
    alert('投票期限を30日間延長しました');
  } catch (error) {
    alert('延長できませんでした: ' + error.message);
  }
};

// 最大期限チェック
const canExtend = !AgendaDeadlineManager.hasReachedMaxDeadline(
  new Date(post.agendaDeadline),
  'FACILITY_AGENDA',
  new Date(post.createdAt)
);

// UIボタン
{canExtend && (
  <button onClick={handleExtendDeadline} disabled={isExtending}>
    ⏰ 投票期限延長（+30日）
  </button>
)}
```

---

## ワークフロー文書への反映内容

### 師長の選択肢（100点未達時）

**現行案（2択）**:
1. 部署議題承認
2. 却下

**修正案（3択）**: 既存機能を活用
1. 部署議題承認
2. 却下
3. **投票期限延長（+30日、最大90日まで）**

### 延長後のフロー

```
師長が「投票期限延長」ボタンを押す
  ↓
【自動処理】（useAgendaDeadline.extendDeadline() 実行）
- AgendaDeadlineManager.extendDeadline() 呼び出し
- 新しい期限 = 現在の期限 + 30日（最大90日まで）
- 延長回数カウント増加

【通知】施設内全職員に通知
  タイトル: 「⏰ 投票期限が延長されました」
  メッセージ: 「『夜勤看護師3名体制の提案』の投票期限を30日間延長しました。

              現在のスコア: 85点
              目標: 100点（残り15点）
              新しい期限: 2025年11月25日

              引き続きご投票をお願いします。」

延長後も100点未達
  ↓
- 最大期限（90日）に達していない → 再度延長可能
- 最大期限に達している → 「部署議題承認」または「却下」のみ
```

---

## 実装時の注意点

### 1. 延長日数の設定

**現在の実装**:
- `AgendaDeadlineManager.extendDeadline()`: デフォルト30日
- `useAgendaDeadline.extendDeadline()`: デフォルト7日

**推奨**: 施設議題では30日延長が適切（標準60日 + 延長30日 = 最大90日）

### 2. 最大期限制限

**施設議題の場合**:
- 投稿作成日から90日が絶対的な最大期限
- 例: 作成日から80日後に延長 → 90日までしか延長されない（+10日のみ）

### 3. 通知との連携

**既存実装**:
- `agendaNotificationIntegration.notifyDeadlineExtension()` が用意済み
- 施設内全職員に通知される

---

## まとめ

✅ **投票期限延長機能は既に実装済み**
✅ **師長の100点未達時の選択肢に「延長」を追加可能**
✅ **既存の AgendaDeadlineManager と useAgendaDeadline を活用**
✅ **最大期限（90日）の制限により無限延長を防げる**

**次のステップ**:
1. 師長の判断画面に「投票期限延長」ボタンを追加
2. `useAgendaDeadline.extendDeadline()` を呼び出す処理を実装
3. 最大期限チェックによるボタン表示制御を実装
