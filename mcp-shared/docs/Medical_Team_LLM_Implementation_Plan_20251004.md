# LLMコンテンツモデレーションAPI実装計画書

**文書番号**: IMPL-2025-1004-002
**作成日**: 2025年10月4日
**作成者**: 医療職員管理システムチーム
**宛先**: VoiceDriveチーム 様
**返信先**: VoiceDrive統合テスト連携作業依頼書

---

## エグゼクティブサマリー

VoiceDriveチームからの統合テスト連携作業依頼書を拝受いたしました。貴チームのPhase 1（クライアント側モデレーション）およびPhase 2（LLM API連携基盤）の実装完了、誠におめでとうございます。

医療システムチームは、**Week 5-8（4週間）でLLM APIエンドポイントの実装を完了**し、Week 9より統合テストを開始できる体制を整えます。

本文書では、実装計画、技術仕様の確認、スケジュール調整、および合意事項の回答を記載いたします。

---

## 目次

1. [合意事項の回答](#合意事項の回答)
2. [実装計画（Week 5-8）](#実装計画week-5-8)
3. [API技術仕様の確認](#api技術仕様の確認)
4. [開発環境情報](#開発環境情報)
5. [統合テスト計画への対応](#統合テスト計画への対応)
6. [連絡体制の確立](#連絡体制の確立)
7. [次のアクション](#次のアクション)

---

## 合意事項の回答

### ✅ 技術仕様

| 項目 | 合意 | 備考 |
|------|------|------|
| API仕様書の内容に合意 | ✅ 合意 | 一部補足あり（後述） |
| パフォーマンス要件に合意 | ✅ 合意 | 平均2秒以内、P95 3秒以内達成可能 |
| セキュリティ要件に合意 | ✅ 合意 | API Key認証、投稿内容非保持 |
| エラーハンドリング方式に合意 | ✅ 合意 | タイムアウト3秒、リトライ戦略対応 |

### ✅ スケジュール

| フェーズ | 期間 | 合意 | 医療チーム状況 |
|---------|------|------|---------------|
| Week 5-8: API実装完了 | 10/7 - 11/1 | ✅ 合意 | リソース確保済み |
| Week 9: 接続テスト | 11/4 - 11/8 | ✅ 合意 | 全面協力体制 |
| Week 10: 機能テスト | 11/11 - 11/15 | ✅ 合意 | QA担当者アサイン済み |
| Week 11-12: 負荷・受入テスト | 11/18 - 11/29 | ✅ 合意 | インフラ担当者待機 |

### ✅ 体制

| 項目 | 合意 | 医療チーム対応 |
|------|------|---------------|
| 連絡窓口の設定 | ✅ 合意 | 後述の連絡体制参照 |
| 定例会議の開催 | ✅ 合意 | 毎週月曜 10:00-11:00参加 |
| 緊急時対応体制 | ✅ 合意 | 24/7オンコール体制構築 |

### ✅ その他

| 項目 | 合意 | 医療チーム方針 |
|------|------|---------------|
| データプライバシーポリシー | ✅ 合意 | 投稿内容は処理後即座に削除 |
| 運用・保守方針 | ✅ 合意 | 99%可用性目標、週次メンテナンス |
| ドキュメント管理方法 | ✅ 合意 | mcp-shared/docs/ 共有フォルダ利用 |

---

## 実装計画（Week 5-8）

### Week 5（10/7 - 10/11）: 基盤構築

#### Day 1-2（10/7-10/8）: 環境構築

**作業内容**:
- [ ] AWS Lightsail インスタンス起動（8GB RAM, 4vCPU）
- [ ] Ollama インストール・設定
- [ ] Llama 3.2 8B モデルダウンロード
- [ ] 基本推論テスト

**成果物**:
- Lightsail インスタンス（起動済み）
- Ollama 稼働確認
- テスト結果

#### Day 3-5（10/9-10/11）: APIサーバー基盤実装

**作業内容**:
- [ ] FastAPI プロジェクト初期化
- [ ] `/api/moderate` エンドポイント作成
- [ ] リクエスト/レスポンスバリデーション実装
- [ ] エラーハンドリング基盤実装

**成果物**:
- FastAPI サーバー（基本動作確認済み）
- エンドポイント仕様書 v1.0
- ローカルテスト結果

**技術スタック**:
```python
# requirements.txt
fastapi==0.104.1
uvicorn==0.24.0
pydantic==2.5.0
httpx==0.25.1
python-dotenv==1.0.0
ollama-python==0.1.0
```

### Week 6（10/14 - 10/18）: コア機能実装

#### Day 6-8（10/14-10/16）: LLMプロンプトエンジニアリング

**作業内容**:
- [ ] 11種類の違反タイプ検出プロンプト作成
- [ ] 医療現場特有表現の辞書作成（1000パターン）
- [ ] Few-shot Learning サンプル準備（100件）
- [ ] 信頼度スコア計算ロジック実装

**成果物**:
- プロンプトテンプレート（11種類）
- 医療表現辞書（JSON形式）
- Few-shot サンプルデータセット

**プロンプト例**:
```python
MODERATION_PROMPT = """
あなたは医療法人のSNS投稿モデレーターです。
以下の投稿内容を分析し、11種類の違反タイプを検出してください。

医療現場特有の表現（「この手技は厳しい」「夜勤は過酷」等）は
業務の難易度や労働環境の記述として正常と判定してください。

投稿内容:
{content}

コンテキスト:
- 投稿タイプ: {post_type}
- 投稿者レベル: {author_level}
- 部署: {department}

以下のJSON形式で回答してください:
{
  "allowed": true/false,
  "severity": "none/low/medium/high/critical",
  "confidence": 0-100,
  "violations": [...],
  "explanation": "...",
  "suggestedEdits": [...]
}
"""
```

#### Day 9-10（10/17-10/18）: 違反検出ロジック実装

**作業内容**:
- [ ] 個人攻撃検出（personal_attack）
- [ ] 誹謗中傷検出（defamation）
- [ ] ハラスメント検出（harassment）
- [ ] 差別的表現検出（discrimination）
- [ ] プライバシー侵害検出（privacy_violation）
- [ ] 脅迫的表現検出（threatening）
- [ ] ヘイトスピーチ検出（hate_speech）
- [ ] 誤情報検出（misinformation）
- [ ] スパム検出（spam）
- [ ] 不適切コンテンツ検出（inappropriate_content）
- [ ] その他検出（other）

**成果物**:
- 違反検出モジュール（Python）
- 単体テスト（各検出タイプ10件）

### Week 7（10/21 - 10/25）: パフォーマンス最適化

#### Day 11-13（10/21-10/23）: 処理速度最適化

**作業内容**:
- [ ] レスポンスキャッシュ実装（Redis）
- [ ] バッチ処理対応
- [ ] 非同期処理実装
- [ ] プロンプト最適化（トークン数削減）

**目標パフォーマンス**:
- 平均応答時間: 1.5秒
- P95応答時間: 2.5秒
- P99応答時間: 3.0秒

#### Day 14-15（10/24-10/25）: 負荷対策

**作業内容**:
- [ ] レート制限実装（100 req/min）
- [ ] リクエストキュー実装
- [ ] スケーリング戦略策定
- [ ] ヘルスチェックエンドポイント実装

**成果物**:
- 負荷テスト結果レポート
- スケーリング設定ドキュメント

### Week 8（10/28 - 11/1）: セキュリティ・最終調整

#### Day 16-18（10/28-10/30）: セキュリティ実装

**作業内容**:
- [ ] API Key認証実装
- [ ] IPアドレス制限実装
- [ ] HTTPS設定（Let's Encrypt）
- [ ] データ保持ポリシー実装（即時削除）

**成果物**:
- セキュリティ監査レポート
- API Key（VoiceDrive用）

#### Day 19-20（10/31-11/1）: ドキュメント作成・テスト

**作業内容**:
- [ ] API仕様書完成版
- [ ] エラーコード一覧
- [ ] 運用マニュアル
- [ ] 監視ダッシュボード構築
- [ ] 内部受入テスト実施

**成果物**:
- 完全版ドキュメント
- 内部受入テスト完了報告書
- VoiceDriveチームへの提供資料パッケージ

---

## API技術仕様の確認

### ✅ エンドポイント仕様（確定版）

**基本情報**:
```
URL: https://medical-llm-api.lightsail.aws/api/moderate
Method: POST
Content-Type: application/json
Authorization: Bearer {VOICEDRIVE_API_KEY}
```

### ✅ リクエストスキーマ（VoiceDrive提案を承認）

```typescript
interface ModerationRequest {
  content: string;  // 必須、1-10000文字
  context?: {
    postType?: 'improvement' | 'community' | 'report';  // 必須
    authorLevel?: number;  // 1-99
    department?: string;
  };
  options?: {
    checkSensitivity?: 'low' | 'medium' | 'high';  // デフォルト: medium
    language?: 'ja' | 'en';  // デフォルト: ja
    includeExplanation?: boolean;  // デフォルト: true
  };
}
```

### ✅ レスポンススキーマ（VoiceDrive提案を承認）

```typescript
interface ModerationResponse {
  allowed: boolean;
  severity: 'none' | 'low' | 'medium' | 'high' | 'critical';
  confidence: number;  // 0-100
  violations: ViolationDetail[];
  explanation: string;
  suggestedEdits: string[];
  metadata: {
    modelVersion: string;  // "llama-3.2-8b-v1.0"
    processingTime: number;  // ミリ秒
    timestamp: string;  // ISO 8601
  };
}

interface ViolationDetail {
  type: ViolationType;
  severity: 'low' | 'medium' | 'high' | 'critical';
  description: string;
  extractedText?: string;
  startIndex?: number;
  endIndex?: number;
  confidence: number;  // 0-100
}

type ViolationType =
  | 'personal_attack'
  | 'defamation'
  | 'harassment'
  | 'discrimination'
  | 'privacy_violation'
  | 'inappropriate_content'
  | 'threatening'
  | 'hate_speech'
  | 'misinformation'
  | 'spam'
  | 'other';
```

### ✅ エラーレスポンススキーマ（追加提案）

```typescript
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: string;
    timestamp: string;
  };
}
```

**エラーコード一覧**:

| コード | HTTPステータス | 説明 | 対処方法 |
|--------|---------------|------|----------|
| `INVALID_REQUEST` | 400 | リクエストボディの形式が不正 | スキーマを確認 |
| `UNAUTHORIZED` | 401 | API Key が無効 | API Key を確認 |
| `FORBIDDEN` | 403 | IPアドレス制限違反 | 許可IPから接続 |
| `RATE_LIMIT_EXCEEDED` | 429 | レート制限超過 | リトライ（Retry-After参照） |
| `CONTENT_TOO_LONG` | 413 | 投稿内容が長すぎる（>10000文字） | 内容を分割 |
| `INTERNAL_ERROR` | 500 | サーバー内部エラー | リトライ（最大2回） |
| `SERVICE_UNAVAILABLE` | 503 | サービス一時停止 | メンテナンス情報確認 |
| `TIMEOUT` | 504 | 処理タイムアウト | リトライ |

### ✅ パフォーマンス保証値

| 指標 | VoiceDrive要求 | 医療チーム保証値 | 達成方法 |
|------|---------------|-----------------|---------|
| 平均応答時間 | 2秒以内 | **1.5秒** | プロンプト最適化、キャッシュ |
| P95応答時間 | 3秒以内 | **2.5秒** | 非同期処理、バッチ対応 |
| タイムアウト | 3秒 | **3秒** | アプリケーションレベルタイムアウト |
| 信頼度 | 70-95% | **75-95%** | Few-shot Learning、継続学習 |
| 可用性 | 99% | **99.5%** | 自動復旧、ヘルスチェック |
| 同時接続数 | 100接続 | **150接続** | 非同期ワーカー、キュー |

---

## 開発環境情報

### 医療チーム開発環境

**インフラ**:
```
プロバイダー: AWS Lightsail
リージョン: ap-northeast-1（東京）
インスタンスタイプ: 8GB RAM, 4vCPU, 160GB SSD
OS: Ubuntu 22.04 LTS
```

**エンドポイント**:
```
開発環境: https://dev-medical-llm-api.lightsail.aws/api/moderate
ステージング環境: https://stg-medical-llm-api.lightsail.aws/api/moderate
本番環境: https://medical-llm-api.lightsail.aws/api/moderate
```

**モデル**:
```
名称: Llama 3.2 8B Instruct
量子化: Q4_K_M（4-bit量子化、メモリ効率重視）
推論エンジン: llama.cpp
コンテキストウィンドウ: 4096トークン
```

**API仕様**:
```
フレームワーク: FastAPI 0.104.1
言語: Python 3.11
ランタイム: Uvicorn (ASGI)
キャッシュ: Redis 7.0
```

**監視**:
```
ダッシュボード: https://medical-llm-monitor.lightsail.aws
メトリクス: Prometheus + Grafana
ログ: CloudWatch Logs
アラート: SNS（メール・Slack連携）
```

---

## 統合テスト計画への対応

### Week 9（11/4 - 11/8）: 接続テスト

#### 医療チーム作業

**Day 1（11/4）: 環境準備**
- [ ] 開発環境デプロイ完了確認
- [ ] API Key発行（VoiceDrive用）
- [ ] IPアドレス制限設定（VoiceDriveサーバー追加）
- [ ] エンドポイントURL・認証情報提供

**Day 2-3（11/5-11/6）: 接続確認**
- [ ] VoiceDriveからの初回接続テスト立会い
- [ ] 基本的なリクエスト/レスポンス確認
- [ ] エラーハンドリング確認

**Day 4-5（11/7-11/8）: 問題対応**
- [ ] 発見された問題の即時修正
- [ ] ログ分析・デバッグサポート
- [ ] パフォーマンス初期測定

#### 合同作業

**接続テストチェックリスト**:
- [ ] 正常系: 問題ない投稿 → `allowed: true`
- [ ] 正常系: 建設的提案 → `severity: none`
- [ ] 異常系: 個人攻撃 → `personal_attack` 検出
- [ ] 異常系: 誹謗中傷 → `defamation` 検出
- [ ] エラー系: 不正なAPI Key → 401エラー
- [ ] エラー系: タイムアウト → 504エラー＋リトライ
- [ ] 境界値: 10000文字の投稿
- [ ] パフォーマンス: レスポンス時間測定

### Week 10（11/11 - 11/15）: 機能テスト

#### 医療チーム作業

**テストケース提供**:
- [ ] 正常系テストデータ（100件）
- [ ] 異常系テストデータ（50件）
- [ ] 境界値テストデータ（30件）
- [ ] 医療現場特有表現テストデータ（50件）

**サポート体制**:
- [ ] 全日QA担当者待機
- [ ] 問題発見時の即時対応
- [ ] パフォーマンスチューニング

**医療現場特有表現テスト**:
- [ ] 「夜勤は体力的にきつい」 → 正常判定
- [ ] 「急性期病棟は過酷」 → 正常判定
- [ ] 「○○医師の指示が不明確」 → 警告（修正提案）
- [ ] 「人手不足で限界」 → 正常判定（業務改善提案）

### Week 11（11/18 - 11/22）: 負荷テスト

#### 医療チーム作業

**負荷テスト環境準備**:
- [ ] ステージング環境にテスト用インスタンス追加
- [ ] モニタリング強化
- [ ] オートスケーリング設定

**負荷シナリオ**:

1. **通常負荷**（1時間）
   - 同時ユーザー: 100
   - リクエスト/分: 150
   - 期待結果: 平均1.5秒以内、エラー率<1%

2. **ピーク負荷**（30分）
   - 同時ユーザー: 150
   - リクエスト/分: 300
   - 期待結果: 全て正常応答、キュー動作

3. **スパイク負荷**（10分）
   - 同時ユーザー: 200（瞬間的）
   - リクエスト/分: 500
   - 期待結果: レート制限発動、一部429エラー

4. **長時間稼働**（24時間）
   - 同時ユーザー: 50-100（変動）
   - リクエスト/分: 150-300（変動）
   - 期待結果: メモリリーク無し、安定稼働

### Week 12（11/25 - 11/29）: 統合受入テスト

#### 医療チーム作業

**最終確認事項**:
- [ ] 全機能正常動作確認
- [ ] パフォーマンス要件達成確認
- [ ] セキュリティ監査実施・合格
- [ ] ドキュメント完全版提供
- [ ] 運用手順書完成
- [ ] 監視・アラート動作確認
- [ ] バックアップ・復旧手順確認

**本番環境準備**:
- [ ] 本番環境デプロイ
- [ ] 本番API Key発行
- [ ] 本番IPアドレス制限設定
- [ ] 本番監視設定
- [ ] 障害対応体制確立

#### 合同作業

**Go/No-Go判定会議**（11/29）:
- [ ] 全テスト結果レビュー
- [ ] 未解決問題の確認
- [ ] 本番リリース可否判定
- [ ] リリース日程決定

---

## 連絡体制の確立

### 医療チーム窓口

| 役割 | 担当者 | 連絡先 | 対応時間 |
|------|--------|--------|---------|
| プロジェクトリード | 山田太郎 | medical-lead@example.com | 平日9-18時 |
| API開発責任者 | 佐藤花子 | medical-api-dev@example.com | 平日9-20時 |
| インフラ担当 | 鈴木一郎 | medical-infra@example.com | 平日9-18時 |
| QA担当 | 田中美香 | medical-qa@example.com | 平日9-18時（Week 10-12） |
| 緊急対応 | 当番制 | medical-emergency@example.com | 24/7 |

### コミュニケーション手段

**日常連絡**:
- Slack: #llm-integration チャンネル参加
- レスポンス目標: 営業時間内2時間以内

**定例会議**:
- 日時: 毎週月曜 10:00-11:00（VoiceDrive提案を承認）
- 場所: Zoom（リンクは医療チームから送付）
- 議題: 進捗共有、課題報告、次週計画

**技術相談**:
- Zoom即時ミーティング（営業時間内）
- 事前予約不要、Slackで呼びかけ

**緊急連絡**:
- 電話: 03-XXXX-XXXX（当番制）
- SMS: 090-XXXX-XXXX（当番制）
- 対応目標: 15分以内に初回応答

### エスカレーションフロー

```
Level 1: 開発担当者間で解決（目標: 2時間）
    ↓（解決不可）
Level 2: 技術責任者間で協議（目標: 4時間）
    ↓（解決不可）
Level 3: プロジェクトリード間で協議（目標: 8時間）
    ↓（解決不可）
Level 4: 経営層判断（目標: 24時間）
```

---

## 次のアクション

### 今週中（10/4-10/6）

#### 医療チーム作業

1. **本依頼書への正式回答**（10/4）
   - ✅ 本文書の送付
   - [ ] 合意事項の最終確認

2. **開発環境準備開始**（10/5-10/6）
   - [ ] Lightsailインスタンス申請
   - [ ] 開発チーム体制確立
   - [ ] 技術スタック最終確認

3. **サンプルデータ受領確認**（10/6）
   - [ ] VoiceDriveからのテストケース受領
   - [ ] 期待値データの確認

#### VoiceDriveチーム作業（依頼）

1. **本回答書のレビュー**（10/5）
   - API仕様の最終確認
   - スケジュールの調整
   - 不明点の質問

2. **サンプルデータ提供**（10/6）
   - 正常系テストケース（100件）
   - 異常系テストケース（50件）
   - 境界値テストケース（30件）

3. **定例会議初回開催**（10/7 月曜 10:00）
   - ZoomリンクはVoiceDriveから送付
   - キックオフアジェンダ確認

### Week 5開始前（10/4-10/6）

#### 医療チームから提供

1. **技術情報**
   - [ ] 開発環境URL（準備でき次第）
   - [ ] API仕様書 v1.0（暫定版）
   - [ ] 技術スタック詳細

2. **ドキュメント**
   - [ ] 実装計画書 v1.0（本文書）
   - [ ] アーキテクチャ図
   - [ ] データフロー図

### Week 8終了時（11/1）

#### 医療チームから提供

1. **API情報**
   - [ ] エンドポイントURL（開発環境）
   - [ ] API Key（VoiceDrive専用）
   - [ ] レート制限情報
   - [ ] メンテナンス予定

2. **技術情報**
   - [ ] API仕様書 v2.0（完全版）
   - [ ] エラーコード一覧
   - [ ] モデルバージョン情報（llama-3.2-8b-v1.0）
   - [ ] 処理時間目安（平均1.5秒）

3. **運用情報**
   - [ ] 監視ダッシュボードURL
   - [ ] 障害時連絡先（24/7）
   - [ ] エスカレーションフロー
   - [ ] 運用マニュアル

4. **開発支援**
   - [ ] Postmanコレクション（API例）
   - [ ] curlサンプルスクリプト
   - [ ] 統合サンプルコード（Python/TypeScript）

### VoiceDriveチームから受領済み（感謝）

- ✅ `docs/PHASE2_LLM_INTEGRATION.md` - 詳細統合ガイド
- ✅ `src/types/llmModeration.ts` - TypeScript型定義
- ✅ `.env.example` - 環境変数テンプレート
- ✅ `src/services/MockLLMAPIServer.ts` - モック実装参考

---

## 補足事項

### API仕様の補足

#### 1. バッチ処理対応（追加提案）

VoiceDriveチームからのバッチチェックAPI要求に対応します：

```typescript
POST /api/moderate/batch

Request:
{
  "posts": [
    {
      "postId": "POST-001",
      "content": "...",
      "context": { ... }
    },
    {
      "postId": "POST-002",
      "content": "...",
      "context": { ... }
    }
  ],
  "options": { ... }
}

Response:
{
  "results": [
    {
      "postId": "POST-001",
      "allowed": true,
      ...
    },
    {
      "postId": "POST-002",
      "allowed": false,
      ...
    }
  ],
  "totalProcessingTime": 3500,  // ミリ秒
  "metadata": {
    "batchSize": 2,
    "successCount": 2,
    "failureCount": 0
  }
}
```

**パフォーマンス**:
- バッチサイズ上限: 10件
- 処理時間: 単一処理の60-70%（並列化効果）

#### 2. ヘルスチェックエンドポイント（追加提案）

```typescript
GET /api/health

Response:
{
  "status": "healthy" | "degraded" | "unhealthy",
  "checks": {
    "llm": "ok",
    "cache": "ok",
    "database": "ok"
  },
  "version": "1.0.0",
  "uptime": 86400,  // 秒
  "timestamp": "2025-10-04T12:34:56Z"
}
```

#### 3. メトリクスエンドポイント（追加提案）

```typescript
GET /api/metrics

Response:
{
  "requests": {
    "total": 12345,
    "successful": 12100,
    "failed": 245
  },
  "performance": {
    "avgResponseTime": 1487,  // ミリ秒
    "p95ResponseTime": 2345,
    "p99ResponseTime": 2987
  },
  "detections": {
    "personal_attack": 45,
    "defamation": 23,
    ...
  },
  "period": "last_24h"
}
```

---

## 結びに

VoiceDriveチームの迅速かつ高品質な実装に心より敬意を表します。貴チームのPhase 1・Phase 2の完成度の高さは、本統合プロジェクトの成功を確信させるものです。

医療システムチームは、**Week 5-8（4週間）でLLM APIエンドポイントを完成**させ、Week 9より統合テストを開始できるよう全力で取り組みます。

本プロジェクトにより、医療法人における安全で建設的なSNS環境が実現し、職員の皆様の心理的安全性向上と組織改善の促進に貢献できることを、チーム一同楽しみにしております。

ご不明な点やご要望がございましたら、お気軽にお問い合わせください。今後とも、どうぞよろしくお願い申し上げます。

---

**医療職員管理システムチーム一同**

**作成日**: 2025年10月4日
**ドキュメントバージョン**: v1.0
**連絡先**: medical-lead@example.com

---

## 📎 添付資料（作成予定）

### Week 8終了時に提供

1. **API仕様書 v2.0**（完全版）
2. **エラーコード一覧**
3. **運用マニュアル**
4. **統合サンプルコード**
5. **監視ダッシュボード利用ガイド**

### Week 9開始時に提供

1. **開発環境アクセス情報**
2. **API Key（VoiceDrive専用）**
3. **テストデータセット**

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| 医療システムチーム リーダー | 山田太郎 | 2025-10-04 | ✅ |
| API開発責任者 | 佐藤花子 | 2025-10-04 | ✅ |
| インフラ担当 | 鈴木一郎 | 2025-10-04 | ✅ |

---

**文書終了**
