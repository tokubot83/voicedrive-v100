# Analytics API監視ダッシュボード設計書

**日付**: 2025年10月9日
**バージョン**: 1.0.0（設計段階）
**公開予定日**: 2025年11月18日
**担当**: VoiceDrive開発チーム

---

## 📋 概要

VoiceDrive Analytics APIの監視ダッシュボードの設計書です。
API使用状況、パフォーマンス、異常アラートをリアルタイムで可視化します。

---

## 🎯 目的

1. **リアルタイム監視**
   - APIリクエスト数の推移
   - レスポンスタイムの監視
   - エラー率の確認

2. **異常検知の可視化**
   - アラート一覧表示
   - 異常パターンの可視化
   - 対応状況の追跡

3. **運用状況の把握**
   - リソース使用状況
   - ユーザー別統計
   - 職員カルテシステムの利用状況

---

## 🖼️ ダッシュボード画面構成

### メイン画面

```
┌─────────────────────────────────────────────────────────────────────────┐
│ VoiceDrive Analytics API - Monitoring Dashboard                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  📊 リアルタイムメトリクス                    🔴 アクティブアラート: 2  │
│  ┌──────────────────┬──────────────────┬──────────────────┐           │
│  │  リクエスト数     │  平均レスポンス   │  エラー率         │           │
│  │  1,234 req/h     │  45.2ms          │  0.8%            │           │
│  │  ↗ +12% (1h前比) │  ↘ -5ms (1h前比) │  ↗ +0.2% (1h前比)│           │
│  └──────────────────┴──────────────────┴──────────────────┘           │
│                                                                          │
│  📈 リクエスト数トレンド（過去24時間）                                    │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  1,500 ┤                                             ╭─╮        │  │
│  │  1,000 ┤                        ╭─╮         ╭───╮  │ │╭─╮    │  │
│  │    500 ┤    ╭─╮  ╭───╮  ╭──╮  │ │╭───╮╭──╮│   │╭─╯ ││ │    │  │
│  │      0 ┼────┴─┴──┴───┴──┴──┴──┴─┴┴───┴┴──┴┴───┴┴───┴┴─┴───→ │  │
│  │         00:00   06:00   12:00   18:00   22:00                  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ⚠️ アクティブアラート                                                    │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ 🔴 レート制限警告                   2025-10-09 14:35             │  │
│  │    IP: 203.0.113.10 | 250 req/h (警告閾値: 200)                 │  │
│  │    [詳細] [対応済みにする]                                        │  │
│  │                                                                   │  │
│  │ 🟡 レスポンスタイム劣化              2025-10-09 14:20             │  │
│  │    平均: 520ms (閾値: 500ms)                                     │  │
│  │    [詳細] [対応済みにする]                                        │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  📊 エンドポイント別統計                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │ Endpoint                       │ Requests │ Avg Time │ Error % │  │
│  ├────────────────────────────────┼──────────┼──────────┼─────────┤  │
│  │ GET /aggregated-stats          │ 850      │ 42ms     │ 0.5%    │  │
│  │ POST /group-data               │ 384      │ 51ms     │ 1.2%    │  │
│  │ GET /health                    │ 12,450   │ 2ms      │ 0.0%    │  │
│  └────────────────────────────────┴──────────┴──────────┴─────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### サブページ

#### 1. アラート履歴

```
┌─────────────────────────────────────────────────────────────────────────┐
│ アラート履歴                                                              │
├─────────────────────────────────────────────────────────────────────────┤
│  フィルタ: [全て ▼] [過去24時間 ▼] [検索...]                             │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 🔴 レート制限超過（自動ブロック実施） 2025-10-09 14:35           │   │
│  │    IP: 203.0.113.10 | 450 req/h                                  │   │
│  │    対応状況: ✅ 自動ブロック完了 | 対応者: system                 │   │
│  │    [詳細を見る]                                                   │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ 🟡 レスポンスタイム劣化            2025-10-09 14:20              │   │
│  │    平均: 520ms (閾値: 500ms)                                      │   │
│  │    対応状況: 🔄 調査中 | 対応者: admin@example.com              │   │
│  │    [詳細を見る]                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2. ユーザー別統計

```
┌─────────────────────────────────────────────────────────────────────────┐
│ ユーザー別統計（職員カルテシステム）                                       │
├─────────────────────────────────────────────────────────────────────────┤
│  期間: [過去7日 ▼]                                                       │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Staff ID                │ Requests │ Avg Time │ Last Access      │   │
│  ├─────────────────────────┼──────────┼──────────┼──────────────────┤   │
│  │ analytics-system-test   │ 1,234    │ 45ms     │ 2025-10-09 14:35 │   │
│  │ batch-processor-01      │ 856      │ 52ms     │ 2025-10-09 02:00 │   │
│  │ llm-analysis-service    │ 345      │ 125ms    │ 2025-10-09 03:15 │   │
│  └─────────────────────────┴──────────┴──────────┴──────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3. システムリソース

```
┌─────────────────────────────────────────────────────────────────────────┐
│ システムリソース                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│  サーバー: voicedrive-api-01                                             │
│                                                                           │
│  CPU使用率            メモリ使用率            ディスク使用率              │
│  ┌────────────┐      ┌────────────┐       ┌────────────┐              │
│  │    45%     │      │    62%     │       │    35%     │              │
│  │  ████░░░   │      │  ██████░░  │       │  ███░░░░   │              │
│  └────────────┘      └────────────┘       └────────────┘              │
│                                                                           │
│  ネットワーク                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Inbound:  125.3 MB/s        Outbound: 89.7 MB/s                 │   │
│  │ ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓       ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 表示メトリクス詳細

### 1. リアルタイムメトリクス

| メトリクス | 更新間隔 | 説明 |
|----------|---------|------|
| **リクエスト数** | 10秒 | 現在の時間帯のリクエスト数（req/h） |
| **平均レスポンスタイム** | 10秒 | 過去1分間の平均レスポンスタイム（ms） |
| **エラー率** | 10秒 | 過去1分間のエラー率（%） |

### 2. トレンドグラフ

| グラフ | 表示期間 | データポイント |
|-------|---------|--------------|
| **リクエスト数トレンド** | 過去24時間 | 5分間隔 |
| **レスポンスタイムトレンド** | 過去24時間 | 5分間隔 |
| **エラー率トレンド** | 過去24時間 | 5分間隔 |

### 3. エンドポイント別統計

| 列 | 説明 |
|----|------|
| **Endpoint** | エンドポイント名 |
| **Requests** | リクエスト数（過去1時間） |
| **Avg Time** | 平均レスポンスタイム（ms） |
| **Error %** | エラー率（%） |

---

## 🛠️ 技術スタック

### フロントエンド

| 技術 | 用途 |
|------|------|
| **React** | UIフレームワーク |
| **Recharts** | グラフ描画ライブラリ |
| **Material-UI** | UIコンポーネント |
| **WebSocket** | リアルタイムデータ更新 |

### バックエンド

| 技術 | 用途 |
|------|------|
| **Express** | APIサーバー |
| **WebSocket** | リアルタイム通信 |
| **Redis** | キャッシュ・リアルタイムデータ |
| **PostgreSQL** | メトリクスデータ保存 |

### 監視・分析

| 技術 | 用途 |
|------|------|
| **Prometheus** | メトリクス収集（検討中） |
| **Grafana** | 高度な可視化（検討中） |

---

## 🏗️ アーキテクチャ

### データフロー

```
┌──────────────────────────────────────────────────────────────────┐
│                     Analytics API Server                          │
│  ┌──────────────────┐   ┌──────────────────┐                    │
│  │   API Routes     │ → │  Metrics         │                    │
│  │                  │   │  Collector       │                    │
│  └──────────────────┘   └──────────────────┘                    │
│                                  ↓                                │
│                          ┌──────────────────┐                    │
│                          │     Redis        │                    │
│                          │  (Real-time)     │                    │
│                          └──────────────────┘                    │
│                                  ↓                                │
└──────────────────────────────────┼───────────────────────────────┘
                                   ↓
┌──────────────────────────────────┼───────────────────────────────┐
│                     Dashboard Server                              │
│                          ┌──────────────────┐                    │
│                          │   WebSocket      │                    │
│                          │   Server         │                    │
│                          └──────────────────┘                    │
│                                  ↓                                │
│                          ┌──────────────────┐                    │
│                          │   Dashboard      │                    │
│                          │   API            │                    │
│                          └──────────────────┘                    │
└──────────────────────────────────┼───────────────────────────────┘
                                   ↓
┌──────────────────────────────────┼───────────────────────────────┐
│                     Browser (Client)                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    React Dashboard                        │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐            │   │
│  │  │ Metrics   │  │ Alerts    │  │  Graphs   │            │   │
│  │  │ Cards     │  │  List     │  │ (Recharts)│            │   │
│  │  └───────────┘  └───────────┘  └───────────┘            │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────────┘
```

### API設計

#### 1. メトリクス取得API

```
GET /api/dashboard/metrics/realtime
GET /api/dashboard/metrics/trend?period=24h
GET /api/dashboard/endpoints/stats
GET /api/dashboard/alerts/active
GET /api/dashboard/alerts/history?limit=50
GET /api/dashboard/users/stats
GET /api/dashboard/system/resources
```

#### 2. WebSocket API

```
ws://localhost:8080/ws/dashboard

# 接続後、リアルタイムでメトリクスを受信
{
  "type": "metrics_update",
  "data": {
    "requestCount": 1234,
    "avgResponseTime": 45.2,
    "errorRate": 0.8
  },
  "timestamp": "2025-10-09T14:35:00Z"
}
```

---

## 📱 レスポンシブデザイン

### デスクトップ（1920x1080以上）

- 3カラムレイアウト
- グラフ大きく表示
- 詳細情報を一画面に表示

### タブレット（768x1024）

- 2カラムレイアウト
- グラフサイズ調整
- スクロールで詳細表示

### モバイル（375x667）

- 1カラムレイアウト
- 主要メトリクスのみ表示
- タブ切り替えで詳細表示

---

## 🔐 アクセス制御

### 認証

- **VoiceDrive管理者**: フルアクセス
- **職員カルテ管理者**: 読み取りのみ
- **一般ユーザー**: アクセス不可

### 権限レベル

| ユーザー | 閲覧 | アラート対応 | 設定変更 |
|---------|------|------------|---------|
| VoiceDrive管理者 | ✅ | ✅ | ✅ |
| 職員カルテ管理者 | ✅ | ❌ | ❌ |

---

## 🛠️ 実装計画

### Phase 1: 基本ダッシュボード（11月18日-11月20日）

- [  ] React Dashboard UI実装
- [  ] リアルタイムメトリクス表示
- [  ] トレンドグラフ表示
- [  ] WebSocket通信実装

### Phase 2: アラート機能（11月20日-11月22日）

- [  ] アクティブアラート表示
- [  ] アラート履歴表示
- [  ] アラート対応機能
- [  ] フィルタリング・検索機能

### Phase 3: 統計・分析機能（11月22日）

- [  ] エンドポイント別統計
- [  ] ユーザー別統計
- [  ] システムリソース監視
- [  ] エクスポート機能

---

## 📊 期待効果

### 定量的効果

| 指標 | 現状 | 目標 |
|------|------|------|
| **問題発見時間** | 数時間 | 数分 |
| **対応時間** | 30分-1時間 | 5-10分 |
| **可視化範囲** | ログのみ | 全メトリクス |

### 定性的効果

1. **運用負荷削減**: 手動確認が不要に
2. **透明性向上**: 職員カルテチームもステータス確認可能
3. **意思決定支援**: データに基づいた改善

---

## 📝 設定ファイル

### 環境変数（.env）

```env
# Dashboard設定
DASHBOARD_PORT=8080
DASHBOARD_BASE_URL=http://localhost:8080

# WebSocket設定
WEBSOCKET_PORT=8081
WEBSOCKET_PATH=/ws/dashboard

# メトリクス設定
METRICS_UPDATE_INTERVAL=10000
METRICS_RETENTION_HOURS=24
```

---

## 🧪 テスト計画

### 単体テスト

```typescript
describe('Dashboard Components', () => {
  it('メトリクスカードを正しく表示する', () => {
    // テストコード
  });

  it('グラフをリアルタイムで更新する', () => {
    // テストコード
  });
});
```

### E2Eテスト

```typescript
describe('Dashboard E2E', () => {
  it('ダッシュボードにアクセスできる', async () => {
    // Puppeteerでテスト
  });

  it('WebSocketでリアルタイム更新される', async () => {
    // テストコード
  });
});
```

---

## 📚 参考資料

- [Recharts Documentation](https://recharts.org/)
- [Material-UI Dashboard Template](https://mui.com/material-ui/getting-started/templates/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

---

**VoiceDrive開発チーム**
2025年10月9日

---

## 🔄 更新履歴

| 日付 | 更新内容 | 更新者 |
|------|---------|--------|
| 2025-10-09 | 初版作成（設計段階） | VoiceDrive開発チーム |
| 2025-11-18 | 公開予定 | - |
