# 医療システムチーム宛 - 認証システム承認依頼

**送信日**: 2025年10月27日
**送信元**: VoiceDrive開発チーム
**宛先**: 医療職員管理システム開発チーム（ClaudeCode様）
**件名**: 【承認依頼】VoiceDrive認証システム - QRコード + PWA方式の採用について

---

## 📧 メール本文

```
件名: 【承認依頼】VoiceDrive認証システム - QRコード + PWA方式の採用について

医療職員管理システム開発チーム
ClaudeCode 様

いつもお世話になっております。
VoiceDrive開発チームです。

先日ご提案いただきました「QRコード初回認証 + PWA方式」について、
UX観点から検討した結果、**この方式を正式に採用することを決定**いたしました。

貴チームから頂いた評価書（⭐⭐⭐⭐⭐）の通り、高齢職員やパートタイム職員に
とって最も使いやすい方式であると判断いたしました。

つきましては、下記の実装要件につきまして、ご確認・ご承認をお願いいたします。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 採用決定: QRコード + PWA方式 ⭐⭐⭐⭐⭐
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【採用理由（UX観点）】

1. 高齢職員・パートタイム職員にとって最も使いやすい
   ✅ キーボード入力不要
   ✅ パスワード記憶不要
   ✅ QRコードスキャン → 以降はアイコンタップのみ

2. 緊急時の迅速なアクセス
   ✅ 夜勤帯での迅速な情報アクセス
   ✅ ホーム画面アイコンタップで即起動

3. 初回セットアップの簡単さ
   ✅ 所要時間: 約2-3分
   ✅ 人事部から受け取ったQRコードをスキャンするだけ
   ✅ 次回からアイコンタップのみ（30日間自動ログイン）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🗄️ 医療システム側の実装要件サマリー
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【1. データベーススキーマ変更】

■ Employeeテーブル拡張（3フィールド追加）
  - passwordHash (String): bcryptハッシュ化されたパスワード
  - passwordUpdatedAt (DateTime): 最終変更日時
  - passwordMustChange (Boolean): 初回変更フラグ（デフォルト: true）

■ OnetimeTokenテーブル（新規作成）
  - id, token, employeeId, purpose, expiresAt
  - used, usedAt, usedIpAddress, usedUserAgent
  - createdAt
  ※ QRコード用のワンタイムトークン管理

■ LoginHistoryテーブル（新規作成）
  - id, employeeId, loginAt, ipAddress, userAgent
  - loginMethod, success, failureReason
  ※ 監査ログ・セキュリティ分析用

■ LoginAttemptテーブル（新規作成）
  - id, employeeId, attemptAt, ipAddress, success
  ※ アカウントロック判定用（5回失敗で30分ロック）


【2. API実装（4本）】

■ API-1: QRコード用トークン生成
  POST /api/v2/auth/generate-onetime-token
  - 権限: 人事部管理者のみ（permissionLevel >= 9.0）
  - 処理: 64文字のランダムトークン生成、QRコード画像生成
  - レスポンス: token, qrCodeUrl, qrCodeImage(Data URL), expiresAt

■ API-2: トークン検証
  POST /api/v2/auth/verify-onetime-token
  - 処理: トークン検証、職員情報返却、使用済みフラグ更新
  - エラーコード: TOKEN_EXPIRED, TOKEN_ALREADY_USED等

■ API-3: 従来型認証（バックアップ手段）
  POST /api/v2/auth/authenticate
  - 処理: 職員ID + パスワード検証、アカウントロック判定
  - レスポンス: passwordMustChange フラグ含む

■ API-4: パスワード変更
  PUT /api/v2/auth/change-password
  - 処理: 現在のパスワード検証、新パスワードのポリシー検証
  - ポリシー: 8文字以上、大文字・小文字・数字・記号を含む


【3. セキュリティ仕様】

■ パスワードハッシュ
  - 方式: bcrypt (cost factor = 10)

■ トークン生成
  - 方式: crypto.randomBytes(32).toString('hex')
  - 長さ: 64文字（256ビット）
  - 有効期限: 24時間
  - 単一使用: used = true で無効化

■ Rate Limiting
  - 認証API: 5回/15分/IP
  - QRコード生成: 10回/1時間/ユーザー

■ アカウントロック
  - 条件: 過去30分間に5回以上失敗
  - ロック期間: 30分間
  - 実装方式: LoginAttemptテーブル（Redis不要）

■ CORS設定
  - origin: process.env.VOICEDRIVE_URL
  - credentials: true


【4. 実装工数見積もり】

| 項目 | 工数 | 備考 |
|-----|------|------|
| データベーススキーマ変更 | 1日 | マイグレーション含む |
| API-1, API-2 実装 | 2日 | QRコード認証 |
| API-3, API-4 実装 | 2日 | 従来型認証 |
| セキュリティ機能実装 | 1日 | Rate Limit、アカウントロック |
| 単体テスト | 0.5日 | 各API |
| **合計** | **6.5日** | 約1.5週間 |


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📅 実装スケジュール案
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【Phase 1: 基盤実装（Week 1）】
Day 1: Employeeテーブル拡張
Day 2: OnetimeToken、LoginHistory、LoginAttemptテーブル作成
Day 3: マイグレーション実行、初期データ投入
Day 4-5: バッファ

【Phase 2: QRコード認証実装（Week 2）】
Day 1: API-1 (generate-onetime-token) 実装
Day 2: API-2 (verify-onetime-token) 実装
Day 3: QRコード生成ライブラリ統合（qrcode npm package）
Day 4: アカウント情報シート印刷機能
Day 5: 単体テスト

【Phase 3: 従来型認証実装（Week 3）】
Day 1-2: API-3 (authenticate) 実装
Day 3: API-4 (change-password) 実装
Day 4: アカウントロックロジック実装
Day 5: 単体テスト

【Phase 4: 統合テスト（Week 4）】
Day 1-2: VoiceDriveとの統合テストE2E
Day 3: セキュリティ監査
Day 4: パフォーマンステスト
Day 5: バグ修正

【Phase 5: 本番リリース（Week 5）】
Day 1: ステージング環境デプロイ
Day 2-3: 人事部による受け入れテスト
Day 4: 本番環境デプロイ
Day 5: 段階的ロールアウト

**合計**: 約5週間（医療システム側）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 VoiceDrive側の実装予定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

医療システム側の実装と並行して、VoiceDrive側では以下を実装します：

【Week 1-2: 認証基盤】
- useAuthフック実装
- express-session + Redis セットアップ
- GET /api/auth/me 実装
- POST /api/auth/verify-onetime-token プロキシ

【Week 3-4: 認証UI】
- QRコードログインフロー実装
- 従来型ログイン画面
- パスワード変更画面

【Week 5: PWA対応】
- manifest.json作成
- Service Worker実装
- PWAインストール促進UI

**VoiceDrive側工数**: 約16日（約3週間）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ ご確認・ご承認いただきたい事項
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【1. 実装要件の承認】
上記のデータベーススキーマ変更、API仕様、セキュリティ仕様について、
ご承認いただけますでしょうか？

【2. 実装スケジュールの確認】
- 医療システム側: 約5週間（6.5日の実装 + テスト）
- VoiceDrive側: 約3週間（16日）
- 統合テスト: Week 4
上記スケジュールで進行可能でしょうか？

【3. Phase 1.6（共通DB構築）との同時実施について】
貴チームから提案いただいた「Phase 1.6と同時実施」について、
以下の点を確認させてください：

- Phase 1.6の開始時期: 2025年11月1日～11月27日（4週間）
- 認証システム実装を同時並行で進める場合のリソース配分
- 優先度の調整が必要か

【4. QRコード生成ライブラリ】
以下のライブラリを使用予定ですが、問題ないでしょうか？
- npm package: `qrcode` (v1.5.0以上)
- Data URL形式での画像生成

【5. 初期パスワードの扱い】
貴チームからの回答で「初期パスワード: {employeeId}_InitPass2025」
と決定していますが、QRコード方式では初期パスワードは不要です。
ただし、バックアップ手段として従来型ログインでも使えるように
しておく必要があるため、以下の運用でよろしいでしょうか？

- 新規職員登録時: 初期パスワードを設定（passwordMustChange = true）
- QRコードでログイン: 初期パスワード入力不要（トークン検証のみ）
- 従来型ログイン: 初期パスワード入力必須 → 即座にパスワード変更画面


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📎 添付資料
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

本メールには以下の詳細設計書を添付しております：

1. **認証システム最終設計_QRコード方式_20251027.md**
   - データベーススキーマ詳細
   - API仕様（実装例コード含む）
   - セキュリティ仕様
   - PWA実装コード
   - 実装スケジュール（Phase 1-6）
   - 成功指標（KPI）
   - 全1627行の技術設計書

2. **認証システム設計_文書関係図_20251027.md**
   - UX設計（改訂版2）と技術設計の関係性
   - 文書の使い分けガイド

3. **参考: 認証システム フロー詳細説明書（改訂版2）**
   - 新入職員視点のUXフロー（鈴木さんの物語）
   - 人事部視点のアカウント情報シート
   - ※UX理解のための参考資料


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 期待される効果
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

今回採用するQRコード + PWA方式により、以下の効果が期待されます：

【ユーザビリティ】
✅ 初回ログイン成功率: 95%以上（目標）
✅ QRコード利用率: 70%以上（目標）
✅ PWAインストール率: 60%以上（目標）
✅ 平均ログイン時間: 30秒以内（QRコード方式）
✅ ヘルプデスク問い合わせ: 月10件以下（目標）

【セキュリティ】
✅ 暗号学的に安全なトークン（256ビット）
✅ 単一使用（再利用不可）
✅ 24時間の有効期限
✅ アカウントロック機能（ブルートフォース対策）
✅ Rate Limiting（DDoS対策）

【特に効果的な対象ユーザー】
- 50代～60代の医療職員（キーボード入力が苦手）
- パートタイム職員（頻繁にログインしない）
- 夜勤帯の看護師（緊急時の迅速なアクセス）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📞 お問い合わせ・ご質問
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ご不明な点やご質問がございましたら、お気軽にお問い合わせください。

【VoiceDrive開発チーム】
Email: dev@voicedrive.hospital.local
Slack: #voicedrive-dev

また、技術的な詳細についてのディスカッションが必要な場合は、
オンラインミーティングを設定させていただきます。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🙏 次のステップ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ご確認いただき次第、以下についてご回答をお願いできますでしょうか：

1. ✅ 実装要件の承認可否
2. ✅ 実装スケジュールの調整が必要か
3. ✅ Phase 1.6との同時実施について
4. ✅ その他、懸念事項やご要望

お忙しいところ恐縮ですが、**11月1日（金）までに**ご回答いただけますと、
スムーズに開発着手できますので、ご協力のほどよろしくお願いいたします。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

貴チームとの連携を通じて、医療職員の皆様にとって
使いやすく安全な認証システムを実現できることを楽しみにしております。

引き続き、よろしくお願いいたします。


VoiceDrive開発チーム一同

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


---
【添付ファイル】
1. 認証システム最終設計_QRコード方式_20251027.md (60ページ, 1627行)
2. 認証システム設計_文書関係図_20251027.md (10ページ)
3. 認証システム フロー詳細説明書（改訂版2）(参考資料)
---
```

---

## 📋 メール送信チェックリスト

送信前に以下を確認してください：

### 添付ファイルの確認
- [ ] `認証システム最終設計_QRコード方式_20251027.md` を添付
- [ ] `認証システム設計_文書関係図_20251027.md` を添付
- [ ] `認証システム フロー詳細説明書（改訂版2）` を添付（参考資料）

### 内容の確認
- [ ] 採用方式（QRコード + PWA）が明記されている
- [ ] 実装要件サマリーが網羅されている
- [ ] 工数見積もり（6.5日）が記載されている
- [ ] 実装スケジュール（5週間）が記載されている
- [ ] 確認事項（5項目）が明確に記載されている
- [ ] 回答期限（11月1日）が記載されている

### 宛先の確認
- [ ] 医療職員管理システム開発チーム（ClaudeCode様）
- [ ] CCに関係者を追加（人事部、プロジェクトマネージャー等）

### トーンの確認
- [ ] 丁寧かつ明確な文面
- [ ] 技術的な詳細が適切に説明されている
- [ ] 期待される効果が明確に記載されている
- [ ] 協力的な姿勢が伝わる

---

## 📝 補足情報

### メール送信後の想定スケジュール

```
Day 0 (10/27): メール送信
  ↓
Day 1-4 (10/28-10/31): 医療システムチームでの検討
  ↓
Day 5 (11/1): 回答受領（期限）
  ↓
Day 6-7 (11/2-11/3): 詳細協議（必要に応じてミーティング）
  ↓
Week 2 (11/4-): Phase 1 実装開始
```

### 想定される医療システムチームからの質問

以下の質問が来る可能性があるため、事前に回答を準備しておくことを推奨します：

1. **QRコード生成のパフォーマンス**
   - 回答準備: qrcodeライブラリは同期処理で約50ms、許容範囲内

2. **トークンの保存期間**
   - 回答準備: 使用後7日間は監査ログとして保持、その後削除

3. **Redisの必要性**
   - 回答準備: セッション管理でRedisを使用、アカウントロックはDBで実装

4. **初期パスワードの運用**
   - 回答準備: QRコードが主、初期パスワードはバックアップ手段

5. **PWAの対応ブラウザ**
   - 回答準備: iOS Safari 11.3+, Android Chrome 40+, Edge 17+

---

## 🎯 承認後の次のステップ

医療システムチームから承認を得た後の流れ：

### 1. キックオフミーティング（Week 1 Day 1）
- 両チームの実装担当者が参加
- 詳細な技術仕様の確認
- 開発環境の準備
- コミュニケーション方法の確認（Slack、GitHub等）

### 2. 開発環境準備（Week 1）
- 医療システム側: ステージング環境にテーブル作成
- VoiceDrive側: 開発環境にRedisセットアップ
- APIのモックサーバー準備（並行開発用）

### 3. 定期進捗報告（毎週金曜）
- 実装進捗の報告
- 問題点の共有
- 次週の予定確認

### 4. 統合テスト（Week 4）
- 両チーム合同でE2Eテスト
- セキュリティ監査
- パフォーマンステスト

### 5. 受け入れテスト（Week 5）
- 人事部による実際の運用シミュレーション
- フィードバック収集
- 最終調整

---

**作成日**: 2025年10月27日
**作成者**: VoiceDrive開発チーム
**文書番号**: EMAIL-AUTH-REQUEST-2025-1027-001

---

**文書終了**
