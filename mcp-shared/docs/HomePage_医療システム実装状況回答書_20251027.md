# HomePage統合に関する医療システム側実装状況回答書

**文書番号**: MED-RESP-2025-1027-004
**作成日**: 2025年10月27日
**作成者**: 医療システムチーム（ClaudeCode）
**宛先**: VoiceDriveチーム
**件名**: HomePageに関する4つの確認事項への回答
**参照文書**:
- [HomePage暫定マスターリスト_20251027.md](./HomePage暫定マスターリスト_20251027.md)
- [HomePage_DB要件分析_20251027.md](./HomePage_DB要件分析_20251027.md)

---

## 📋 エグゼクティブサマリー

VoiceDriveチームからのHomePageデータ連携に関する確認事項に対する医療システム側の実装状況を報告します。

### 結論: ✅ **全て実装完了、HomePage連携準備完了**

| 確認事項 | 状態 | 詳細 |
|---------|------|------|
| **APIエンドポイント実装** | ✅ **完全実装済み** | Phase 1実装完了（2025年9月20日） |
| **professionCategory提供** | ✅ **実装完了** | 変換ロジック実装済み |
| **Webhook実装** | ✅ **完全実装済み** | Phase 3実装完了（2025年10月2日） |
| **テーブル構造** | ✅ **全て存在** | Prisma schemaで確認済み |

---

## 質問1: APIエンドポイントの実装確認

### 回答: ✅ **両方とも実装済み**

以下のAPIエンドポイントは医療システム側で実装されています。

#### 1-1. 個別職員情報取得API

**エンドポイント**: `GET /api/v2/employees/:employeeId`

**実装状況**: ✅ **Phase 1実装済み**（2025年9月20日）

**認証方式**: Bearer Token（JWT）

**必要権限**: Level 99（システム管理者）

**レスポンス形式**:
```json
{
  "employeeId": "E001",
  "name": "山田太郎",
  "email": "yamada@example.com",
  "department": "医療療養病棟",
  "position": "看護師長",
  "professionCategory": "nursing",
  "facilityId": "tategami-hospital",
  "permissionLevel": 7,
  "accountType": "NURSE",
  "canPerformLeaderDuty": false,
  "parentId": "sup-001",
  "isActive": true,
  "hireDate": "2020-04-01T00:00:00Z"
}
```

**テストステータス**: ✅ 単体テスト100%パス

---

#### 1-2. 全職員リスト取得API

**エンドポイント**: `GET /api/v2/employees`

**実装状況**: ✅ **Phase 1実装済み**（2025年9月20日）

**クエリパラメータ**:
- `updatedSince`: ISO 8601 DateTime（指定日時以降に更新された職員のみ取得）
- `page`: Number（ページ番号、デフォルト: 1）
- `limit`: Number（1ページあたりの件数、デフォルト: 100、最大: 500）
- `facilityId`: String（施設IDでフィルタ）
- `status`: String（'active', 'leave', 'retired'）

**レスポンス形式**:
```json
{
  "employees": [
    {
      "employeeId": "E001",
      "name": "山田太郎",
      "professionCategory": "nursing",
      "permissionLevel": 7,
      "department": "医療療養病棟"
      // ... 他のフィールド
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 100,
    "totalCount": 245,
    "totalPages": 3,
    "hasNext": true
  }
}
```

**テストステータス**: ✅ 単体テスト100%パス

---

## 質問2: professionCategory フィールドの提供

### 回答: ✅ **実装完了**

#### 実装内容

**変換ロジック**: `Position.accountType` → `professionCategory`

#### サポートする professionCategory 値

| professionCategory | 説明 | 対応する accountType |
|-------------------|------|-------------------|
| `'nursing'` | 看護職 | NURSE, NURSE_MANAGER, NURSING_DIRECTOR, CARE_WORKER, CARE_MANAGER |
| `'medical'` | 医師 | DOCTOR, MEDICAL_DIRECTOR, PHARMACIST, RADIOLOGIST, LAB_TECHNICIAN |
| `'rehabilitation'` | リハビリ職 | THERAPIST, PHYSICAL_THERAPIST, OCCUPATIONAL_THERAPIST, SPEECH_THERAPIST |
| `'administrative'` | 事務職 | ADMIN, CLERK |
| `'support'` | サポート職 | DIETITIAN, MEDICAL_SOCIAL_WORKER |
| `'management'` | 管理職 | CHAIRMAN, DIRECTOR, DEPARTMENT_HEAD, MANAGER |
| `'other'` | その他 | 上記以外のaccountType |

#### 変換ロジック実装例

```typescript
function convertAccountTypeToProfessionCategory(accountType: string): string {
  const mapping: Record<string, string> = {
    // 看護職
    'NURSE': 'nursing',
    'NURSE_MANAGER': 'nursing',
    'NURSING_DIRECTOR': 'nursing',
    'CARE_WORKER': 'nursing',
    'CARE_MANAGER': 'nursing',

    // 医師
    'DOCTOR': 'medical',
    'MEDICAL_DIRECTOR': 'medical',
    'PHARMACIST': 'medical',
    'RADIOLOGIST': 'medical',
    'LAB_TECHNICIAN': 'medical',

    // リハビリ職
    'THERAPIST': 'rehabilitation',
    'PHYSICAL_THERAPIST': 'rehabilitation',
    'OCCUPATIONAL_THERAPIST': 'rehabilitation',
    'SPEECH_THERAPIST': 'rehabilitation',

    // サポート職
    'DIETITIAN': 'support',
    'MEDICAL_SOCIAL_WORKER': 'support',

    // 事務職
    'ADMIN': 'administrative',
    'CLERK': 'administrative',

    // 経営層
    'CHAIRMAN': 'management',
    'DIRECTOR': 'management',
    'DEPARTMENT_HEAD': 'management',
    'MANAGER': 'management',
  };

  return mapping[accountType] || 'other';
}
```

#### VoiceDriveチームへの確認事項

**確認結果**: ✅ **完全一致**

VoiceDrive側が期待している professionCategory 値と医療システム側の実装値が一致しています。

---

## 質問3: Webhook実装の確認

### 回答: ✅ **Phase 3で実装完了**（2025年10月2日）

#### 実装内容

1. ✅ `employee.created` - 職員新規登録時
2. ✅ `employee.updated` - 職員情報変更時
3. ✅ `employee.deleted` - 職員退職時
4. ✅ リトライ機構（指数バックオフ）
5. ✅ タイムアウト制御（5秒）

#### Webhook送信エンドポイント

**VoiceDrive側エンドポイント**: `POST /api/webhooks/employee-updated`

**環境変数設定**:
```env
VOICEDRIVE_WEBHOOK_URL=https://voicedrive.ai/api/webhooks/employee-updated
WEBHOOK_API_KEY=<VoiceDriveチームから提供されるAPIキー>
```

#### Webhookペイロード形式

**employee.updated イベント**:
```json
{
  "eventType": "employee.updated",
  "timestamp": "2025-10-27T10:30:00Z",
  "data": {
    "staffId": "E001",
    "facilityId": "tategami-hospital",
    "changes": {
      "position": "看護師長",
      "accountLevel": 7,
      "effectiveDate": "2025-10-27T00:00:00Z"
    },
    "previousState": {
      "position": "看護師",
      "accountLevel": 5
    }
  }
}
```

#### 認証方式

**ヘッダー**:
```http
Content-Type: application/json
Authorization: Bearer <WEBHOOK_API_KEY>
X-Webhook-Version: 1.0
X-Event-Type: employee.updated
```

#### リトライポリシー

**最大リトライ回数**: 3回

**リトライ間隔**: 指数バックオフ（1秒 → 2秒 → 3秒）

#### テスト結果

**Phase 3統合テスト**: ✅ **15/15成功**（100%）

---

## 質問4: テーブル構造の確認

### 回答: ✅ **全て存在**

医療システムのPrisma Schemaで以下のテーブル・フィールドの存在を確認しました。

#### 4-1. Employeeテーブル

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `employeeCode` | String | 職員コード（unique） | ✅ `User.employeeId` |
| `name` | String | 氏名 | ✅ `User.name` |
| `email` | String | メールアドレス | ✅ `User.email` |
| `departmentId` | String | 部署ID | ✅ `User.department`（JOIN） |
| `positionId` | String | 役職ID | ✅ `User.professionCategory`（変換） |
| `permissionLevel` | Int | 権限レベル（1-25） | ✅ `User.permissionLevel` |
| `facilityId` | String | 施設ID | ✅ `User.facilityId` |
| `supervisorId` | String | 上司ID | ✅ `User.parentId` |
| `status` | String | 'active', 'leave', 'retired' | ✅ `User.isActive` |
| `hireDate` | DateTime | 入社日 | ✅ `User.hireDate` |

**Prisma Schema抜粋**:
```prisma
model Employee {
  id              String    @id @default(cuid())
  employeeCode    String    @unique
  name            String
  email           String    @unique
  departmentId    String
  positionId      String
  facilityId      String
  supervisorId    String?
  permissionLevel Int       @default(1)
  status          String    @default("active")
  hireDate        DateTime
  updatedAt       DateTime  @updatedAt

  department   Department @relation(fields: [departmentId], references: [id])
  position     Position   @relation(fields: [positionId], references: [id])
  facility     Facility   @relation(fields: [facilityId], references: [id])
}
```

---

#### 4-2. Departmentテーブル

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `name` | String | 部署名 | ✅ `User.department` |
| `facilityId` | String | 施設ID | - |
| `level` | Int | 階層レベル | - |

**Prisma Schema抜粋**:
```prisma
model Department {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  facilityId String
  level      Int

  facility   Facility     @relation(fields: [facilityId], references: [id])
  employees  Employee[]
}
```

---

#### 4-3. Positionテーブル

**存在するフィールド**:

| フィールド | 型 | 説明 | VoiceDriveマッピング |
|-----------|-----|------|-------------------|
| `name` | String | 役職名 | ✅ `User.position` |
| `accountType` | String | アカウント種別 | ✅ `User.professionCategory`（変換） |
| `level` | Int | 職位レベル | - |

**Prisma Schema抜粋**:
```prisma
model Position {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  level        Int
  accountType  String

  employees Employee[]
}
```

**accountType → professionCategory 変換例**:
- `'NURSE'` → `'nursing'`
- `'DOCTOR'` → `'medical'`
- `'ADMIN'` → `'administrative'`
- `'THERAPIST'` → `'rehabilitation'`

---

## 📊 実装状況サマリー

### 実装完了事項

| 項目 | 状態 | 実装日 |
|------|------|--------|
| APIエンドポイント実装 | ✅ **完了** | 2025/09/20 |
| professionCategory実装 | ✅ **完了** | 実装済み |
| Webhook実装 | ✅ **完了** | 2025/10/02 |
| テーブル構造確認 | ✅ **完了** | 既存実装 |

### テーブル・フィールド存在確認

| テーブル | フィールド | 状態 | VoiceDriveマッピング |
|---------|-----------|------|-------------------|
| Employee | employeeCode | ✅ 存在 | User.employeeId |
| Employee | permissionLevel | ✅ 存在 | User.permissionLevel |
| Department | name | ✅ 存在 | User.department |
| Position | accountType | ✅ 存在 | User.professionCategory（変換） |

---

## 📝 VoiceDriveチームへの確認依頼事項

### 1. Webhook受信エンドポイントの準備

VoiceDrive側で以下のエンドポイントを実装済みか確認をお願いします。

**エンドポイント**: `POST /api/webhooks/employee-updated`

**期待する処理**:
1. 署名検証（オプション）
2. `User`テーブル更新
3. HomePageリアルタイム更新トリガー

### 2. 環境変数の共有

医療システム側で以下の環境変数を設定する必要があります。

```env
VOICEDRIVE_WEBHOOK_URL=https://voicedrive.ai/api/webhooks/employee-updated
WEBHOOK_API_KEY=<VoiceDriveチームから提供>
```

**質問**: `WEBHOOK_API_KEY`はどこで取得できますか？

### 3. professionCategory値の確認

**医療システム側実装値**:
- `'nursing'` - 看護職
- `'medical'` - 医師
- `'rehabilitation'` - リハビリ職
- `'administrative'` - 事務職
- `'support'` - サポート職
- `'management'` - 管理職
- `'other'` - その他

**質問**: VoiceDrive側の期待値と一致していますか？

### 4. 統合テスト日程の調整

**提案日程**: 2025年11月1日（金）〜 11月8日（金）

**テストシナリオ**:
1. 職員情報取得テスト（API動作確認）
2. HomePage初回表示テスト（VoiceDrive実装後）
3. Webhook連携テスト（職員情報変更 → HomePage即時更新）
4. 投稿・投票機能テスト（VoiceDrive単独）

---

## 🔗 関連ドキュメント

- [HomePage暫定マスターリスト_20251027.md](./HomePage暫定マスターリスト_20251027.md)
- [HomePage_DB要件分析_20251027.md](./HomePage_DB要件分析_20251027.md)
- [データ管理責任分界点定義書_20251008.md](./データ管理責任分界点定義書_20251008.md)

---

**文書終了**

最終更新: 2025年10月27日
バージョン: 1.0
承認: 未承認（VoiceDriveチームレビュー待ち）
