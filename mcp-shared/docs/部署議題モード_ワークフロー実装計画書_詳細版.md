# 部署議題モード ワークフロー実装計画書（詳細版）

**作成日**: 2025年10月20日
**対象**: 部署議題モード 30点/50点/100点到達時の承認/却下フロー
**ステータス**: 未着手
**関連ドキュメント**: `部署議題モード_正式ワークフロー_20251019.md`

---

## 📋 概要

部署議題モードの正式なワークフローを実装します。
30点、50点、100点の各スコア到達時に、権限レベルに応じた承認/却下判断フローを追加します。

---

## 🎯 実装範囲

### 必要な実装項目

1. **Prisma Schema拡張** - PostStatus追加
2. **主任承認画面の実装** - 3つの判断ボタン
3. **師長承認画面の実装** - 3つの判断ボタン
4. **副看護部長承認画面の実装** - 2つの判断ボタン
5. **通知サービスの実装** - 6つの通知パターン
6. **ProposalDocument自動生成** - 承認時の文書作成
7. **投稿公開範囲の動的変更** - 部署内⇔施設内

---

## 📊 詳細実装内容

### Phase 1: Prisma Schema拡張（見積もり: 0.5日）

#### Step 1: PostStatusの追加

**ファイル**: `prisma/schema.prisma`

**変更内容**:
```prisma
enum PostStatus {
  // 既存
  ACTIVE                           // 通常
  UNDER_REVIEW                     // レビュー中
  ARCHIVED                         // アーカイブ済み

  // 新規追加: 部署議題フロー
  UNDER_DEPT_REVIEW                // 部署検討中 (30点到達)
  PENDING_SUPERVISOR_REVIEW        // 主任の判断待ち (50点到達)
  RECOMMENDED_TO_MANAGER           // 師長に推薦済み
  APPROVED_AS_DEPT_AGENDA          // 部署議題として承認済み
  REJECTED_BY_SUPERVISOR           // 主任が却下
  REJECTED_BY_MANAGER              // 師長が却下

  // 新規追加: 施設議題フロー
  PENDING_DEPUTY_DIRECTOR_REVIEW   // 副看護部長の判断待ち (100点到達)
  APPROVED_FOR_COMMITTEE           // 委員会提出承認済み
  REJECTED_BY_DEPUTY_DIRECTOR      // 副看護部長が却下

  // 新規追加: 期限到達フロー
  FACILITY_VOTE_EXPIRED_PENDING_MANAGER_DECISION  // 施設投票期限終了・師長判断待ち
  DOWNGRADED_TO_DEPT_AGENDA                       // 施設→部署に降格
  REJECTED_BY_MANAGER_AFTER_FACILITY_VOTE        // 施設投票後に師長が却下

  // その他
  CLOSED                           // 終了
}
```

**実装手順**:
```bash
# 1. schema.prisma編集
# 2. マイグレーション作成
npx prisma migrate dev --name add_dept_agenda_workflow_statuses

# 3. Prisma Client再生成
npx prisma generate
```

**テスト項目**:
- [ ] マイグレーション成功確認
- [ ] 新しいステータスがTypeScriptで使えるか確認

---

### Phase 2: 主任承認画面の実装（見積もり: 2日）

#### Step 1: 主任承認画面UI作成（1日）

**ファイル**: `src/pages/ProposalReviewPage.tsx`（新規作成）

**URL**: `/proposal-management/review/:postId`

**機能**:
- 提案内容の詳細表示
- スコア・投票状況の表示
- 3つの判断ボタン（承認/施設昇格/却下）

**実装内容**:
```typescript
import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import {
  CheckCircle,
  TrendingUp,
  XCircle,
  Users,
  ThumbsUp,
  ThumbsDown,
  Minus,
  AlertCircle
} from 'lucide-react';

interface ProposalReviewPageProps {}

export const ProposalReviewPage: React.FC<ProposalReviewPageProps> = () => {
  const { postId } = useParams<{ postId: string }>();
  const { user } = useAuth();
  const navigate = useNavigate();

  const [post, setPost] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedAction, setSelectedAction] = useState<string>('');
  const [reason, setReason] = useState('');
  const [comment, setComment] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    fetchPostDetails();
  }, [postId]);

  const fetchPostDetails = async () => {
    try {
      const response = await fetch(`/api/posts/${postId}`);
      const data = await response.json();
      setPost(data);
    } catch (error) {
      console.error('Error fetching post:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // 権限チェック
  useEffect(() => {
    if (user && post) {
      // 主任（LEVEL_3.5）または師長（LEVEL_7）のみアクセス可能
      if (user.permissionLevel < 3.5) {
        navigate('/unauthorized');
      }
    }
  }, [user, post]);

  const handleSubmit = async () => {
    if (!selectedAction || !reason.trim()) {
      alert('判断と理由を入力してください');
      return;
    }

    setIsSubmitting(true);

    try {
      const response = await fetch(`/api/proposal-review/${postId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: selectedAction,
          reason: reason.trim(),
          comment: comment.trim(),
          reviewerId: user!.id
        })
      });

      if (response.ok) {
        alert('判断を送信しました');
        navigate('/proposal-management');
      } else {
        alert('判断の送信に失敗しました');
      }
    } catch (error) {
      console.error('Error submitting review:', error);
      alert('エラーが発生しました');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">読み込み中...</p>
        </div>
      </div>
    );
  }

  if (!post) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <p className="text-gray-600">投稿が見つかりません</p>
      </div>
    );
  }

  const voteData = post.pollResult || {};
  const approveVotes = voteData.results?.find((r: any) => r.option.text === '賛成')?.votes || 0;
  const neutralVotes = voteData.results?.find((r: any) => r.option.text === '中立')?.votes || 0;
  const opposeVotes = voteData.results?.find((r: any) => r.option.text === '反対')?.votes || 0;

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-4xl mx-auto px-4">
        {/* ヘッダー */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <div className="flex items-center gap-2 mb-4">
            <FileText className="w-6 h-6 text-blue-600" />
            <h1 className="text-2xl font-bold text-gray-900">部署議題 承認/却下</h1>
          </div>

          {/* 警告バナー */}
          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div className="flex items-start gap-2">
              <AlertCircle className="w-5 h-5 text-yellow-600 mt-0.5" />
              <div>
                <p className="font-medium text-yellow-900">判断が必要です</p>
                <p className="text-sm text-yellow-700 mt-1">
                  この提案は50点に到達しました。部署議題として承認するか、施設議題に昇格するか、却下するかを判断してください。
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* 投稿内容 */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 className="text-xl font-bold text-gray-900 mb-4">{post.content}</h2>

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-gray-50 p-4 rounded-lg">
              <p className="text-sm text-gray-600">投稿者</p>
              <p className="font-semibold text-gray-900">{post.author.name}</p>
              <p className="text-sm text-gray-600">{post.department || '不明'}</p>
            </div>

            <div className="bg-gray-50 p-4 rounded-lg">
              <p className="text-sm text-gray-600">現在スコア</p>
              <p className="text-3xl font-bold text-blue-600">{post.score || 0}点</p>
            </div>
          </div>

          {/* 投票状況 */}
          <div className="border-t pt-4">
            <h3 className="font-semibold text-gray-900 mb-3">投票状況</h3>
            <div className="grid grid-cols-3 gap-4">
              <div className="text-center">
                <ThumbsUp className="w-8 h-8 text-green-600 mx-auto mb-2" />
                <p className="text-2xl font-bold text-green-600">{approveVotes}</p>
                <p className="text-sm text-gray-600">賛成</p>
              </div>
              <div className="text-center">
                <Minus className="w-8 h-8 text-gray-600 mx-auto mb-2" />
                <p className="text-2xl font-bold text-gray-600">{neutralVotes}</p>
                <p className="text-sm text-gray-600">中立</p>
              </div>
              <div className="text-center">
                <ThumbsDown className="w-8 h-8 text-red-600 mx-auto mb-2" />
                <p className="text-2xl font-bold text-red-600">{opposeVotes}</p>
                <p className="text-sm text-gray-600">反対</p>
              </div>
            </div>
          </div>
        </div>

        {/* 判断選択 */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 className="text-lg font-bold text-gray-900 mb-4">判断を選択</h2>

          <div className="space-y-3">
            {/* 部署議題として承認 */}
            <button
              onClick={() => setSelectedAction('approve_as_dept_agenda')}
              className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                selectedAction === 'approve_as_dept_agenda'
                  ? 'border-green-500 bg-green-50'
                  : 'border-gray-200 hover:border-green-300'
              }`}
            >
              <div className="flex items-center gap-3">
                <CheckCircle className={`w-6 h-6 ${
                  selectedAction === 'approve_as_dept_agenda' ? 'text-green-600' : 'text-gray-400'
                }`} />
                <div>
                  <p className="font-medium text-gray-900">部署議題として承認</p>
                  <p className="text-sm text-gray-600">
                    部署の正式議題として承認し、部署ミーティングで議論する
                  </p>
                </div>
              </div>
            </button>

            {/* 施設議題に昇格 */}
            <button
              onClick={() => setSelectedAction('escalate_to_facility')}
              className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                selectedAction === 'escalate_to_facility'
                  ? 'border-blue-500 bg-blue-50'
                  : 'border-gray-200 hover:border-blue-300'
              }`}
            >
              <div className="flex items-center gap-3">
                <TrendingUp className={`w-6 h-6 ${
                  selectedAction === 'escalate_to_facility' ? 'text-blue-600' : 'text-gray-400'
                }`} />
                <div>
                  <p className="font-medium text-gray-900">施設議題に昇格</p>
                  <p className="text-sm text-gray-600">
                    施設全体で検討すべき重要な提案として昇格する
                  </p>
                </div>
              </div>
            </button>

            {/* 却下 */}
            <button
              onClick={() => setSelectedAction('reject')}
              className={`w-full p-4 rounded-lg border-2 text-left transition-all ${
                selectedAction === 'reject'
                  ? 'border-red-500 bg-red-50'
                  : 'border-gray-200 hover:border-red-300'
              }`}
            >
              <div className="flex items-center gap-3">
                <XCircle className={`w-6 h-6 ${
                  selectedAction === 'reject' ? 'text-red-600' : 'text-gray-400'
                }`} />
                <div>
                  <p className="font-medium text-gray-900">却下</p>
                  <p className="text-sm text-gray-600">
                    この提案を採用しない
                  </p>
                </div>
              </div>
            </button>
          </div>
        </div>

        {/* 理由・コメント入力 */}
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <div className="mb-4">
            <label className="block font-semibold text-gray-900 mb-2">
              判断理由 <span className="text-red-600">*</span>
            </label>
            <textarea
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              placeholder="判断理由を入力してください（必須）"
              className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              rows={4}
              maxLength={500}
            />
            <p className="text-sm text-gray-500 mt-1">{reason.length} / 500文字</p>
          </div>

          {selectedAction === 'approve_as_dept_agenda' && (
            <div>
              <label className="block font-semibold text-gray-900 mb-2">
                承認コメント（任意）
              </label>
              <textarea
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                placeholder="職員に向けたメッセージを入力してください"
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows={3}
                maxLength={300}
              />
              <p className="text-sm text-gray-500 mt-1">{comment.length} / 300文字</p>
            </div>
          )}
        </div>

        {/* アクションボタン */}
        <div className="flex gap-3 justify-end">
          <button
            onClick={() => navigate(-1)}
            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100"
          >
            キャンセル
          </button>
          <button
            onClick={handleSubmit}
            disabled={!selectedAction || !reason.trim() || isSubmitting}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            {isSubmitting ? '送信中...' : '判断を送信'}
          </button>
        </div>
      </div>
    </div>
  );
};
```

**テスト項目**:
- [ ] 提案詳細が正しく表示されるか
- [ ] 3つのボタンが正しく動作するか
- [ ] 理由入力のバリデーションが動作するか
- [ ] 権限チェックが動作するか

---

#### Step 2: バックエンドAPI実装（1日）

**ファイル**: `src/server.ts`（既存ファイルに追加）

**新規APIルート**:
```typescript
// 主任・師長の提案レビュー
app.post('/api/proposal-review/:postId',
  authenticateToken,
  async (req: AuthRequest, res: Response) => {
    try {
      const { postId } = req.params;
      const { action, reason, comment, reviewerId } = req.body;

      // 権限チェック
      const reviewer = await prisma.user.findUnique({
        where: { id: reviewerId },
        select: { permissionLevel: true, name: true, department: true }
      });

      if (!reviewer || reviewer.permissionLevel < 3.5) {
        return res.status(403).json({
          success: false,
          error: '権限がありません'
        });
      }

      // 投稿取得
      const post = await prisma.post.findUnique({
        where: { id: postId },
        include: {
          author: { select: { id: true, name: true } }
        }
      });

      if (!post) {
        return res.status(404).json({
          success: false,
          error: '投稿が見つかりません'
        });
      }

      // アクション別処理
      switch (action) {
        case 'approve_as_dept_agenda':
          await handleApproveDeptAgenda(post, reviewer, reason, comment);
          break;

        case 'escalate_to_facility':
          await handleEscalateToFacility(post, reviewer, reason);
          break;

        case 'reject':
          await handleReject(post, reviewer, reason);
          break;

        default:
          return res.status(400).json({
            success: false,
            error: '不正なアクションです'
          });
      }

      res.json({ success: true });

    } catch (error) {
      console.error('Error in proposal-review:', error);
      res.status(500).json({
        success: false,
        error: 'サーバーエラーが発生しました'
      });
    }
  }
);

// ヘルパー関数
async function handleApproveDeptAgenda(
  post: any,
  reviewer: any,
  reason: string,
  comment?: string
): Promise<void> {
  // 1. 投稿ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      status: 'APPROVED_AS_DEPT_AGENDA'
    }
  });

  // 2. ProposalDocument自動生成
  await prisma.proposalDocument.create({
    data: {
      postId: post.id,
      title: post.content.substring(0, 100),
      background: `この提案は部署内で${post.score}点のスコアを獲得し、部署議題として承認されました。`,
      status: 'draft',
      creatorId: reviewer.id
    }
  });

  // 3. 通知送信
  // 投稿者への通知
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'proposal_approved',
      title: '部署議題として承認されました',
      message: `あなたの提案「${post.content.substring(0, 50)}...」が部署議題として承認されました。\n\n承認理由:\n${reason}\n\n${comment ? `コメント:\n${comment}` : ''}`,
      relatedPostId: post.id,
      senderId: reviewer.id
    }
  });

  // 部署全員への通知
  const deptUsers = await prisma.user.findMany({
    where: { department: post.department },
    select: { id: true }
  });

  await Promise.all(deptUsers.map(user =>
    prisma.notification.create({
      data: {
        userId: user.id,
        type: 'dept_agenda_announced',
        title: '部署議題が正式決定しました',
        message: `「${post.content.substring(0, 50)}...」が部署の正式議題になりました。\n\n${comment || ''}`,
        relatedPostId: post.id,
        senderId: reviewer.id
      }
    })
  ));
}

async function handleEscalateToFacility(
  post: any,
  reviewer: any,
  reason: string
): Promise<void> {
  // 1. 議題レベル・ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      agendaLevel: 'FACILITY_AGENDA',
      status: 'PENDING_DEPUTY_DIRECTOR_REVIEW',
      // 投稿公開範囲を施設内に拡大
      visibility: 'facility'
    }
  });

  // 2. 投票期限延長
  const newDeadline = new Date();
  newDeadline.setDate(newDeadline.getDate() + 7);

  await prisma.post.update({
    where: { id: post.id },
    data: {
      votingDeadline: newDeadline
    }
  });

  // 3. ProposalDocument自動生成（施設レベル用）
  await prisma.proposalDocument.create({
    data: {
      postId: post.id,
      title: post.content.substring(0, 100),
      background: `この提案は部署内で${post.score}点を獲得し、${reviewer.name}により施設議題に昇格されました。`,
      status: 'draft',
      creatorId: reviewer.id
    }
  });

  // 4. 通知送信
  // 投稿者への通知
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'escalated_to_facility',
      title: '施設議題に昇格しました',
      message: `あなたの提案「${post.content.substring(0, 50)}...」が施設議題に昇格しました。\n\n昇格理由:\n${reason}`,
      relatedPostId: post.id,
      senderId: reviewer.id
    }
  });

  // 副看護部長への通知
  const deputyDirectors = await prisma.user.findMany({
    where: {
      permissionLevel: { gte: 8 },
      facilityId: post.facilityId
    },
    select: { id: true }
  });

  await Promise.all(deputyDirectors.map(user =>
    prisma.notification.create({
      data: {
        userId: user.id,
        type: 'facility_agenda_review_required',
        title: '施設議題の承認依頼',
        message: `「${post.content.substring(0, 50)}...」が施設議題に昇格しました。委員会提出の承認/却下を判断してください。`,
        relatedPostId: post.id,
        senderId: reviewer.id
      }
    })
  ));

  // 施設内全職員への通知
  const facilityUsers = await prisma.user.findMany({
    where: { facilityId: post.facilityId },
    select: { id: true }
  });

  await Promise.all(facilityUsers.map(user =>
    prisma.notification.create({
      data: {
        userId: user.id,
        type: 'facility_agenda_announced',
        title: '新しい施設議題',
        message: `「${post.content.substring(0, 50)}...」が施設議題になりました。投票期限: ${newDeadline.toLocaleDateString('ja-JP')}まで`,
        relatedPostId: post.id,
        senderId: reviewer.id
      }
    })
  ));
}

async function handleReject(
  post: any,
  reviewer: any,
  reason: string
): Promise<void> {
  // 1. 投稿ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      status: reviewer.permissionLevel >= 7 ? 'REJECTED_BY_MANAGER' : 'REJECTED_BY_SUPERVISOR',
      visibility: 'private' // 投稿者のみ閲覧可能
    }
  });

  // 2. 投票終了
  // (pollのendDateを現在時刻に設定など)

  // 3. 通知送信
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'proposal_rejected',
      title: '投稿が却下されました',
      message: `あなたの提案「${post.content.substring(0, 50)}...」は却下されました。\n\n却下理由:\n${reason}`,
      relatedPostId: post.id,
      senderId: reviewer.id
    }
  });
}
```

**テスト項目**:
- [ ] 承認処理が正しく動作するか
- [ ] 施設昇格処理が正しく動作するか
- [ ] 却下処理が正しく動作するか
- [ ] 通知が正しく送信されるか
- [ ] ProposalDocumentが自動生成されるか

---

### Phase 3: 通知サービスの拡張（見積もり: 1.5日）

#### スコア到達時の自動通知

**ファイル**: `src/services/agendaLevelNotificationService.ts`（既存ファイル修正）

**追加実装**:
```typescript
/**
 * 30点到達時の通知
 */
export async function notify30PointsReached(post: any): Promise<void> {
  // 投稿ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      agendaLevel: 'DEPT_REVIEW',
      status: 'UNDER_DEPT_REVIEW'
    }
  });

  // 投稿者への通知
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'score_milestone',
      title: '投稿が30点に到達しました',
      message: `あなたの投稿が30点を突破し、部署内で本格的な検討が始まりました。50点に達すると主任の判断対象になります。`,
      relatedPostId: post.id
    }
  });

  // 主任への通知
  const supervisors = await prisma.user.findMany({
    where: {
      department: post.department,
      permissionLevel: { gte: 3.5, lt: 7 }
    }
  });

  await Promise.all(supervisors.map(supervisor =>
    prisma.notification.create({
      data: {
        userId: supervisor.id,
        type: 'dept_review_alert',
        title: '部署内で注目されている投稿があります',
        message: `「${post.content.substring(0, 50)}...」が30点を突破しました。50点に達すると、あなたの承認/却下判断が必要になります。事前に内容を確認しておくことをお勧めします。`,
        relatedPostId: post.id
      }
    })
  ));

  // 師長への通知
  const managers = await prisma.user.findMany({
    where: {
      department: post.department,
      permissionLevel: { gte: 7, lt: 9 }
    }
  });

  await Promise.all(managers.map(manager =>
    prisma.notification.create({
      data: {
        userId: manager.id,
        type: 'dept_review_alert',
        title: '部署内で注目されている投稿があります',
        message: `「${post.content.substring(0, 50)}...」が30点を突破しました。50点に達すると主任の推薦対象になり、その後あなたの最終判断が必要になります。`,
        relatedPostId: post.id
      }
    })
  ));
}

/**
 * 50点到達時の通知
 */
export async function notify50PointsReached(post: any): Promise<void> {
  // 投稿ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      agendaLevel: 'DEPT_AGENDA',
      status: 'PENDING_SUPERVISOR_REVIEW'
    }
  });

  // 投稿者への通知
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'score_milestone',
      title: '投稿が50点に到達しました',
      message: `あなたの投稿が50点を突破し、部署議題候補になりました。主任の判断をお待ちください。`,
      relatedPostId: post.id
    }
  });

  // 主任への通知（判断要求）
  const supervisors = await prisma.user.findMany({
    where: {
      department: post.department,
      permissionLevel: { gte: 3.5, lt: 7 }
    }
  });

  await Promise.all(supervisors.map(supervisor =>
    prisma.notification.create({
      data: {
        userId: supervisor.id,
        type: 'review_required',
        title: '部署議題の承認/却下をお願いします',
        message: `「${post.content.substring(0, 50)}...」が50点を突破しました。部署議題として師長に推薦するか、却下するかを判断してください。`,
        relatedPostId: post.id,
        actionUrl: `/proposal-management/review/${post.id}`
      }
    })
  ));
}

/**
 * 100点到達時の通知
 */
export async function notify100PointsReached(post: any): Promise<void> {
  // 投稿ステータス更新
  await prisma.post.update({
    where: { id: post.id },
    data: {
      agendaLevel: 'FACILITY_AGENDA',
      status: 'PENDING_DEPUTY_DIRECTOR_REVIEW',
      visibility: 'facility' // 施設内全職員に公開
    }
  });

  // ProposalDocument自動生成
  await prisma.proposalDocument.create({
    data: {
      postId: post.id,
      title: post.content.substring(0, 100),
      background: `この提案は施設内で100点を突破し、施設議題候補になりました。`,
      status: 'draft',
      creatorId: post.authorId
    }
  });

  // 投稿者への通知
  await prisma.notification.create({
    data: {
      userId: post.authorId,
      type: 'score_milestone',
      title: '投稿が100点に到達しました',
      message: `あなたの投稿が100点を突破し、施設議題になりました。副看護部長/看護部長の判断をお待ちください。`,
      relatedPostId: post.id
    }
  });

  // 副看護部長/看護部長への通知
  const deputyDirectors = await prisma.user.findMany({
    where: {
      permissionLevel: { gte: 8, lt: 9 },
      facilityId: post.facilityId
    }
  });

  await Promise.all(deputyDirectors.map(director =>
    prisma.notification.create({
      data: {
        userId: director.id,
        type: 'review_required',
        title: '施設議題の承認/却下をお願いします',
        message: `「${post.content.substring(0, 50)}...」が100点を突破しました。委員会提出の承認/却下を判断してください。`,
        relatedPostId: post.id,
        actionUrl: `/proposal-management/review/${post.id}`
      }
    })
  ));

  // 施設内全職員への通知
  const facilityUsers = await prisma.user.findMany({
    where: { facilityId: post.facilityId },
    select: { id: true }
  });

  await Promise.all(facilityUsers.map(user =>
    prisma.notification.create({
      data: {
        userId: user.id,
        type: 'facility_agenda_announced',
        title: '施設議題到達のお知らせ',
        message: `「${post.content.substring(0, 50)}...」が施設議題になりました。`,
        relatedPostId: post.id
      }
    })
  ));
}
```

**統合箇所**:
`src/api/voting.ts`の投票処理内でスコア到達時に通知関数を呼び出す。

```typescript
// 投票後のスコア計算
const newScore = calculateScore(post.id);

if (newScore >= 100 && post.score < 100) {
  await notify100PointsReached(post);
} else if (newScore >= 50 && post.score < 50) {
  await notify50PointsReached(post);
} else if (newScore >= 30 && post.score < 30) {
  await notify30PointsReached(post);
}
```

---

### Phase 4: ProposalDocument自動生成（見積もり: 1日）

**実装内容**:
- 50点到達時（主任承認後）
- 100点到達時（自動）
- 施設昇格時

**自動生成テンプレート**:
```typescript
interface ProposalDocumentTemplate {
  title: string;
  background: string;
  objectives: string;
  expectedEffects: string;
  implementationPlan: string;
}

function generateProposalDocumentTemplate(post: any, context: string): ProposalDocumentTemplate {
  return {
    title: post.content.substring(0, 100),
    background: `この提案は${context}、正式議題として検討されることになりました。\n\n【提案内容】\n${post.content}`,
    objectives: '（記入してください）',
    expectedEffects: '（記入してください）',
    implementationPlan: '（記入してください）'
  };
}
```

---

## 📅 実装スケジュール

### Week 1: 基盤実装（2日）
| 日 | タスク | 見積 |
|----|--------|------|
| Day 1 AM | Prisma Schema拡張 + マイグレーション | 0.5日 |
| Day 1 PM - Day 2 | 主任承認画面UI + バックエンドAPI | 1.5日 |

### Week 2: 通知・自動化（2.5日）
| 日 | タスク | 見積 |
|----|--------|------|
| Day 3-4 | 通知サービス拡張（30/50/100点） | 1.5日 |
| Day 5 | ProposalDocument自動生成 | 1日 |

### Week 3: 師長・副看護部長画面（1.5日）
| 日 | タスク | 見積 |
|----|--------|------|
| Day 6 | 師長承認画面（主任画面のコピー） | 0.5日 |
| Day 7 | 副看護部長承認画面 | 1日 |

### Week 4: テスト・統合（1日）
| 日 | タスク | 見積 |
|----|--------|------|
| Day 8 | 統合テスト + バグ修正 | 1日 |

**合計見積もり**: 7日

---

## ✅ 完了条件

- [ ] 30点到達時の通知が送信されるか
- [ ] 50点到達時に主任に通知が届くか
- [ ] 主任承認画面が正しく動作するか
- [ ] 師長承認画面が正しく動作するか
- [ ] 100点到達時に施設議題に昇格するか
- [ ] ProposalDocumentが自動生成されるか
- [ ] 投稿公開範囲が正しく変更されるか
- [ ] 全通知パターンが実装されているか

---

**最終更新**: 2025年10月20日
**バージョン**: 2.0
**ステータス**: 未着手
