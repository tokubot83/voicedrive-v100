# ProfilePage 暫定マスターリスト

**作成日**: 2025年10月24日
**対象ページ**: ProfilePage (`src/pages/ProfilePage.tsx`)
**目的**: 医療職員管理システムとの連携要件を明確化し、議題モード・プロジェクトモード両方に対応したプロフィールページを実現する

---

## 📋 エグゼクティブサマリー

### 現状
- ProfilePageは職員個人のプロフィール、活動統計、投稿履歴、投票履歴、設定を表示
- 議題モードとプロジェクトモードで表示内容が動的に切り替わる
- 現在はダミーデータで動作（プロフィール詳細、経験年数、統計データ）
- 医療システムからの職員マスタデータ受信とVoiceDrive独自データの管理が必要

### 必要な対応
1. **医療システムからのAPI提供**: 3件
2. **医療システムからのWebhook通知**: 2件（PersonalStationと共通）
3. **VoiceDrive DB追加**: テーブル5件、フィールド3件
4. **確認事項**: 2件

### 優先度
**Priority: HIGH（グループ1: コアページ）**

---

## 🔗 医療システムへの依頼内容

### A. API提供依頼（3件）

#### API-1: 職員基本情報取得API（PersonalStationと共通）

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}
```

**必要な理由**:
- ProfilePageのプロフィールヘッダー表示（名前、部署、役職、権限レベル等）
- VoiceDriveの`User`テーブルはキャッシュ専用

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "employeeNumber": "EMP-2024-001",
  "name": "山田 太郎",
  "nameKana": "ヤマダ タロウ",
  "email": "yamada.taro@hospital.local",
  "department": "外科",
  "facilityId": "FAC001",
  "profession": "看護師",
  "position": "主任",
  "hireDate": "2018-04-01",
  "permissionLevel": 3.5,
  "canPerformLeaderDuty": false,
  "professionCategory": "nursing",
  "avatar": "https://cdn.hospital.local/avatars/emp2024001.jpg",
  "isRetired": false
}
```

---

#### API-2: 職員経験年数サマリーAPI（PersonalStationと共通）

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}/experience-summary
```

**必要な理由**:
- ProfilePage 42-45行目で`hireDate`, `experienceYears`, `previousExperience`, `totalExperience`を表示
- 現在はハードコード
- 医療システムの`WorkExperience`テーブルから計算可能

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "yearsOfService": 6.0,              // 勤続年数（当法人）
  "totalExperienceYears": 9.0,        // 総職務経験年数（前職含む）
  "previousExperience": 3.0,          // 前職経験年数
  "currentPositionYears": 2.1,        // 現職での年数
  "calculatedAt": "2025-10-24T10:30:00Z"
}
```

---

#### API-3: 職員スキル情報取得API ⭐新規

**エンドポイント**:
```
GET /api/v2/employees/{employeeId}/skills
```

**必要な理由**:
- ProfilePage 49行目で`skills`配列を表示
- 現在はハードコード（`['脳血管リハビリ', 'チーム医療', '患者指導']`）
- 医療システムの`EmployeeSkill`テーブルから取得可能

**レスポンス例**:
```json
{
  "employeeId": "EMP2024001",
  "skills": [
    {
      "skillId": "SKL001",
      "skillName": "脳血管リハビリ",
      "level": 4,
      "certificationDate": "2020-03-15"
    },
    {
      "skillId": "SKL002",
      "skillName": "チーム医療",
      "level": 5,
      "certificationDate": "2019-08-20"
    },
    {
      "skillId": "SKL003",
      "skillName": "患者指導",
      "level": 4,
      "certificationDate": "2021-01-10"
    }
  ]
}
```

**セキュリティ**:
- JWT Bearer Token認証
- Rate Limit: 100 req/min/IP

---

### B. Webhook通知依頼（2件）

#### Webhook-1: 職員情報更新通知（PersonalStationと共通）

**トリガー**:
- 医療システムの`Employee`テーブル更新時

**送信先**:
```
POST https://voicedrive.ai/api/webhooks/employee-updated
```

**ペイロード例**:
```json
{
  "eventType": "employee.updated",
  "timestamp": "2025-10-24T10:30:00Z",
  "employeeId": "EMP2024001",
  "changes": {
    "department": {
      "old": "内科",
      "new": "外科"
    },
    "permissionLevel": {
      "old": 3.0,
      "new": 3.5
    }
  },
  "signature": "abc123..."
}
```

---

#### Webhook-2: 職員経験年数更新通知（PersonalStationと共通）

**トリガー**:
- `WorkExperience`テーブル更新時
- 月次バッチで経験年数再計算時

**送信先**:
```
POST https://voicedrive.ai/api/webhooks/employee-experience-updated
```

**ペイロード例**:
```json
{
  "eventType": "employee.experience.updated",
  "timestamp": "2025-10-24T10:30:00Z",
  "employeeId": "EMP2024001",
  "experienceSummary": {
    "yearsOfService": 6.0,
    "totalExperienceYears": 9.0,
    "previousExperience": 3.0
  },
  "signature": "abc123..."
}
```

---

## 🗄️ VoiceDrive DB構築計画書への追加内容

### C. 新規テーブル追加（5件）

#### Table-1: UserProfile（ユーザープロフィール詳細）⭐新規

**優先度**: 🔴 **CRITICAL**

**理由**:
- ProfilePage 46-48行目で`motto`, `selfIntroduction`, `hobbies`を表示
- ProfilePage 51行目で`coverImage`を表示
- ProfilePage 58行目で`profileCompleteRate`を表示
- ProfilePage 464-516行目でプライバシー設定を保存
- 現在は全てハードコードまたはUI設定のみ

**スキーマ定義**:
```prisma
model UserProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique @map("user_id")

  // プロフィール情報（VoiceDrive独自）
  motto                 String?   @db.Text  // モットー・座右の銘
  selfIntroduction      String?   @db.Text  // 自己紹介
  hobbies               String[]  // 趣味（配列）
  coverImage            String?   @map("cover_image")  // カバー画像URL

  // プロフィール完成度
  profileCompleteRate   Int       @default(0) @map("profile_complete_rate")  // 0-100

  // プライバシー設定
  privacyLevel          String    @default("private") @map("privacy_level")
  // private, department, public

  // メタデータ
  lastProfileUpdate     DateTime  @default(now()) @map("last_profile_update")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}
```

**使用例**:
```typescript
// ProfilePage.tsx でプロフィール詳細を取得
const userProfile = await prisma.userProfile.findUnique({
  where: { userId: currentUser.id }
});

profile.motto = userProfile?.motto || '';
profile.selfIntroduction = userProfile?.selfIntroduction || '';
profile.hobbies = userProfile?.hobbies || [];
profile.coverImage = userProfile?.coverImage || 'linear-gradient(...)';
profile.profileCompleteRate = userProfile?.profileCompleteRate || 0;
```

**マイグレーション**:
```bash
npx prisma migrate dev --name add_user_profile
```

---

#### Table-2: VoteHistory（投票履歴）（PersonalStationと共通）

**優先度**: 🔴 **CRITICAL**

**理由**:
- ProfilePage 428-449行目で投票履歴タブを実装予定（Phase 7）
- PersonalStationと同じデータを使用

**スキーマ定義**:
```prisma
model VoteHistory {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  postId        String    @map("post_id")
  voteOption    String    @map("vote_option")
  voteWeight    Float     @default(1.0) @map("vote_weight")
  votedAt       DateTime  @default(now()) @map("voted_at")
  postCategory  String?   @map("post_category")
  postType      String?   @map("post_type")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([votedAt])
  @@map("vote_history")
}
```

---

#### Table-3: PostLike（いいね履歴）⭐新規

**優先度**: 🔴 **CRITICAL**

**理由**:
- ProfilePage 244-247行目で「総いいね数」を表示
- 現在はダミーデータ（156）
- いいね機能の永続化が必要

**スキーマ定義**:
```prisma
model PostLike {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  postId    String    @map("post_id")
  likedAt   DateTime  @default(now()) @map("liked_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_likes")
}
```

**使用例**:
```typescript
// ProfilePage.tsx で総いいね数を集計
const totalLikes = await prisma.postLike.count({
  where: {
    post: { authorId: currentUser.id }
  }
});
```

---

#### Table-4: AgendaDecision（議題採択決定）⭐新規

**優先度**: 🔴 **CRITICAL**

**理由**:
- ProfilePage 272-281行目で「委員会で採択」数を表示
- 現在はダミーデータ（5）
- 議題モード統計の正確性に必須

**スキーマ定義**:
```prisma
model AgendaDecision {
  id                String    @id @default(cuid())
  postId            String    @unique @map("post_id")

  // 採択情報
  isAdopted         Boolean   @default(false) @map("is_adopted")
  adoptedAt         DateTime? @map("adopted_at")
  decidedBy         String?   @map("decided_by")  // 承認者ID

  // 委員会情報
  committeeType     String    @map("committee_type")
  committeeLevel    String    @map("committee_level")

  // 決定理由
  decisionReason    String?   @db.Text @map("decision_reason")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([postId])
  @@index([isAdopted])
  @@map("agenda_decisions")
}
```

**使用例**:
```typescript
// ProfilePage.tsx で採択数を集計
const adoptedAgendas = await prisma.agendaDecision.count({
  where: {
    isAdopted: true,
    post: { authorId: currentUser.id }
  }
});
```

---

#### Table-5: AgendaImplementation（改善活動実施状況）⭐新規

**優先度**: 🔴 **CRITICAL**

**理由**:
- ProfilePage 286-303行目で「実施中の改善活動」「完了した改善活動」を表示
- 現在はダミーデータ（3, 12）
- 議題モードの進捗管理に必須

**スキーマ定義**:
```prisma
model AgendaImplementation {
  id                String    @id @default(cuid())
  postId            String    @unique @map("post_id")
  agendaDecisionId  String    @map("agenda_decision_id")

  // 実施状況
  status            String    @map("status")  // planning, implementing, completed, canceled
  progress          Int       @default(0)  // 0-100

  // 実施期間
  plannedStartDate  DateTime? @map("planned_start_date")
  plannedEndDate    DateTime? @map("planned_end_date")
  actualStartDate   DateTime? @map("actual_start_date")
  actualEndDate     DateTime? @map("actual_end_date")

  // 実施内容
  implementationPlan String?  @db.Text @map("implementation_plan")
  results           String?   @db.Text

  // 責任者
  responsibleUserId String?   @map("responsible_user_id")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([postId])
  @@index([status])
  @@map("agenda_implementations")
}
```

**使用例**:
```typescript
// ProfilePage.tsx で実施中・完了数を集計
const implementingAgendas = await prisma.agendaImplementation.count({
  where: {
    status: 'implementing',
    post: { authorId: currentUser.id }
  }
});

const completedAgendas = await prisma.agendaImplementation.count({
  where: {
    status: 'completed',
    post: { authorId: currentUser.id }
  }
});
```

---

### D. 既存テーブル修正（1件）

#### Modify-1: Userテーブルに経験年数フィールド追加

**対象テーブル**: `User`

**追加フィールド**:
```prisma
model User {
  // ... 既存フィールド
  experienceYears       Float?    @map("experience_years")     // 🆕 当法人での経験年数
  previousExperience    Float?    @map("previous_experience")  // 🆕 前職経験年数
  totalExperience       Float?    @map("total_experience")     // 🆕 総経験年数

  // 🆕 新規リレーション
  profile               UserProfile?
  voteHistory           VoteHistory[]
  postLikes             PostLike[]
}
```

**データソース**:
- 医療システムAPI-2（`/api/v2/employees/{employeeId}/experience-summary`）から取得
- Webhook-2で更新通知を受け取り、キャッシュを更新

**マイグレーション**:
```sql
ALTER TABLE users ADD COLUMN experience_years DECIMAL(4,1) NULL;
ALTER TABLE users ADD COLUMN previous_experience DECIMAL(4,1) NULL;
ALTER TABLE users ADD COLUMN total_experience DECIMAL(4,1) NULL;
```

---

## ❓ 医療システムチームへの確認事項

### 確認-1: EmployeeSkillテーブルの存在確認

**質問**:
> DB構築計画書には`EmployeeSkill`テーブルが記載されていると認識していますが、以下を確認させてください：
>
> 1. `EmployeeSkill`テーブルは確実に実装予定ですか？
> 2. 以下のフィールドは含まれますか？
>    - `employeeId` (外部キー)
>    - `skillId` (スキルマスタへの外部キー)
>    - `level` (習熟度: 1-5)
>    - `certificationDate` (取得日)
> 3. API-3（スキル情報取得API）の実装は可能ですか？

**期待回答**:
- ✅ EmployeeSkillテーブル実装確定
- ✅ 必要フィールド全て含まれる
- ✅ API-3実装可能

---

### 確認-2: プロフィール写真とカバー画像の管理

**質問**:
> ProfilePageでは以下の画像を表示します：
>
> 1. プロフィール写真（`profileImage`）: 医療システムの`avatar`フィールドから取得でOKですか？
> 2. カバー画像（`coverImage`）: VoiceDrive独自で管理してOKですか？
> 3. 画像アップロード機能は将来的に必要ですか？

**期待回答**:
- ✅ プロフィール写真は医療システムから提供
- ✅ カバー画像はVoiceDrive独自管理でOK
- ⚠️ 画像アップロード機能は将来対応（Phase X）

---

## 📅 想定スケジュール

### Phase 1: 基本プロフィール表示（2-3日）
- **Day 1-2**: UserProfile, PostLikeテーブル追加、経験年数フィールド追加
- **Day 3**: 医療システムAPI連携、ProfilePageハードコード削除

**完了基準**:
- ✅ プロフィールヘッダー（名前、部署、経験年数）が実データ表示
- ✅ プロフィール詳細（モットー、自己紹介、趣味）が保存・表示可能
- ✅ プライバシー設定が保存可能

### Phase 2: 議題モード統計実装（3-4日）
- **Day 4-6**: AgendaDecision, AgendaImplementationテーブル追加
- **Day 7**: 統計集計サービス実装、ProfilePageダミーデータ削除

**完了基準**:
- ✅ 議題提出数・採択数が実データ表示
- ✅ 実施中・完了の改善活動数が実データ表示
- ✅ 委員会貢献度スコアが計算値表示

### Phase 3: 投票履歴実装（2-3日）
- **Day 8-9**: VoteHistoryテーブル追加（PersonalStationと共通）
- **Day 10**: 投票履歴タブ有効化、統計表示

**完了基準**:
- ✅ 投票履歴タブが動作
- ✅ カテゴリ別投票実績が表示
- ✅ 投票傾向分析が表示

### Phase 4: パフォーマンス最適化（1-2日）
- **Day 11-12**: UserActivitySummaryテーブル追加、日次バッチ実装

**完了基準**:
- ✅ ページ読み込み時間 <500ms
- ✅ 統計データが事前集計済み

---

## 📊 データフロー図

```
┌─────────────────────────────────────────────────────────────┐
│                    医療職員管理システム                       │
│                                                               │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │Employee  │  │WorkExperience│  │EmployeeSkill │          │
│  │(Master)  │──│   (履歴)     │  │  (スキル)    │          │
│  └──────────┘  └──────────────┘  └──────────────┘          │
│       │               │                  │                   │
│       │ ①API提供      │ ②経験年数計算    │ ③スキル取得     │
│       ▼               ▼                  ▼                   │
│  ┌────────────────────────────────────────────┐             │
│  │  API-1: 職員基本情報                       │             │
│  │  API-2: 経験年数サマリー                   │             │
│  │  API-3: スキル情報                         │             │
│  └────────────────────────────────────────────┘             │
│         │                                                     │
│         │ ④Webhook通知（変更時）                            │
│         ▼                                                     │
└─────────────────────────────────────────────────────────────┘
         │
         │ HTTPS + JWT Auth
         │ HMAC-SHA256 Signature
         ▼
┌─────────────────────────────────────────────────────────────┐
│                      VoiceDrive                              │
│                                                               │
│  ┌──────────────────────────────────────────┐               │
│  │  Webhook受信: /api/webhooks/employee-*   │               │
│  └──────────────────────────────────────────┘               │
│         │                                                     │
│         │ ⑤キャッシュ更新 + VD独自データ管理                │
│         ▼                                                     │
│  ┌────────┐  ┌───────────┐  ┌──────────┐  ┌─────────┐     │
│  │  User  │  │UserProfile│  │VoteHist  │  │PostLike │     │
│  │(cache) │  │(VD専用)   │  │(VD専用)  │  │(VD専用) │     │
│  └────────┘  └───────────┘  └──────────┘  └─────────┘     │
│       │            │               │             │           │
│       └────────────┴───────────────┴─────────────┘           │
│                           │                                   │
│  ┌─────────────────┐     │  ┌──────────────────┐           │
│  │AgendaDecision   │     │  │AgendaImpl        │           │
│  │(議題採択)       │     │  │(改善活動実施)    │           │
│  └─────────────────┘     │  └──────────────────┘           │
│                           │                                   │
│                           │ ⑥統計表示 + モード切り替え      │
│                           ▼                                   │
│                ┌──────────────────────┐                      │
│                │    ProfilePage       │                      │
│                │  - プロフィール      │                      │
│                │  - 議題モード統計    │                      │
│                │  - プロジェクト統計  │                      │
│                │  - 投票履歴          │                      │
│                │  - 設定              │                      │
│                └──────────────────────┘                      │
└─────────────────────────────────────────────────────────────┘
```

---

## ✅ チェックリスト

### 医療システム側作業

- [ ] **確認-1**: EmployeeSkillテーブル仕様確認
- [ ] **確認-2**: プロフィール写真管理方針確認
- [ ] **API-1**: 職員基本情報取得API実装（PersonalStationと共通）
- [ ] **API-2**: 経験年数サマリーAPI実装（PersonalStationと共通）
- [ ] **API-3**: スキル情報取得API実装 ⭐新規
- [ ] **Webhook-1**: 職員情報更新通知実装
- [ ] **Webhook-2**: 経験年数更新通知実装
- [ ] テスト環境でのAPI動作確認

### VoiceDrive側作業

#### Phase 1
- [ ] **Table-1**: UserProfileテーブル追加 ⭐新規
- [ ] **Modify-1**: User.experienceYears等追加
- [ ] マイグレーション実行
- [ ] ProfilePageのハードコード削除

#### Phase 2
- [ ] **Table-2**: PostLikeテーブル追加 ⭐新規
- [ ] **Table-3**: AgendaDecisionテーブル追加 ⭐新規
- [ ] **Table-4**: AgendaImplementationテーブル追加 ⭐新規
- [ ] マイグレーション実行
- [ ] 統計集計サービス実装
- [ ] ProfilePageのダミー統計を実データに置き換え

#### Phase 3
- [ ] **Table-5**: VoteHistoryテーブル追加（PersonalStationと共通）
- [ ] 投票履歴タブ有効化
- [ ] カテゴリ別投票実績表示実装
- [ ] 投票傾向分析実装

#### Phase 4
- [ ] UserActivitySummaryテーブル追加
- [ ] 日次バッチ実装
- [ ] ProfilePageの最適化

### テスト
- [ ] プロフィール表示の単体テスト
- [ ] プライバシー設定保存のテスト
- [ ] 議題統計集計の精度テスト
- [ ] 投票履歴の統合テスト
- [ ] モード切り替えのE2Eテスト
- [ ] パフォーマンステスト（1000ユーザー）

---

## 📝 補足資料

### 参照ドキュメント

1. **データ管理責任分界点定義書**
   `mcp-shared/docs/データ管理責任分界点定義書_20251008.md`

2. **ProfilePage DB要件分析**
   `mcp-shared/docs/profile_DB要件分析_20251024.md`

3. **PersonalStation暫定マスターリスト**（参考）
   `mcp-shared/docs/PersonalStation暫定マスターリスト_20251008.md`

4. **ProjectModeAnalytics実装**
   `src/systems/project/analytics/ProjectModeAnalytics.ts`

### 技術スタック

**VoiceDrive**:
- MySQL 8.0 (AWS Lightsail 16GB)
- Prisma ORM
- TypeScript + React
- systemModeManager（モード切り替え管理）

**医療システム**:
- MySQL 8.0 (AWS Lightsail 16GB)
- Prisma ORM
- TypeScript + Next.js

---

**作成者**: AI (Claude Code)
**承認待ち**: 医療システムチームからの確認事項回答
**次のステップ**: VoiceDrive schema.prisma更新 → 医療チームへ送付

---

## 🔄 更新履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2025-10-24 | 初版作成 | AI (Claude Code) |
