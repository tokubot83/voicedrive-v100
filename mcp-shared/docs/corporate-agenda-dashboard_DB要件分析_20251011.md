# CorporateAgendaDashboardï¼ˆæ³•äººå…¨ä½“è­°é¡ŒåŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼‰ãƒšãƒ¼ã‚¸ DBè¦ä»¶åˆ†æ

**æ–‡æ›¸ç•ªå·**: CORP-AGENDA-DB-2025-1011-001
**ä½œæˆæ—¥**: 2025å¹´10æœˆ11æ—¥
**å¯¾è±¡ãƒšãƒ¼ã‚¸**: https://voicedrive-v100.vercel.app/corporate-agenda-dashboard
**å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼**: Level 18ï¼ˆç†äº‹é•·ãƒ»æ³•äººäº‹å‹™å±€é•·ï¼‰
**ç›®çš„**: æ³•äººå…¨ä½“è­°é¡ŒåŒ–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã®å…¨æ©Ÿèƒ½ã‚’åˆ†æã—ã€å¿…è¦ãªDBè¦ä»¶ã‚’æ˜ç¢ºåŒ–

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### ãƒšãƒ¼ã‚¸æ¦‚è¦
CorporateAgendaDashboardãƒšãƒ¼ã‚¸ã¯ã€**Level 18ï¼ˆç†äº‹é•·ãƒ»æ³•äººäº‹å‹™å±€é•·ï¼‰** ãŒæ³•äººå…¨ä½“ï¼ˆå…¨10æ–½è¨­ï¼‰ã®è­°é¡ŒåŒ–ãƒ—ãƒ­ã‚»ã‚¹ç¨¼åƒçŠ¶æ³ã‚’çµ±åˆçš„ã«æŠŠæ¡ã™ã‚‹ãŸã‚ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½ï¼ˆ5ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
1. **æ³•äººå…¨ä½“KPI**: ç·æŠ•ç¨¿æ•°ã€å¹³å‡å‚åŠ ç‡ã€å¹³å‡è§£æ±ºç‡ã€å¹³å‡å‡¦ç†æ—¥æ•°
2. **æ–½è¨­åˆ¥çŠ¶æ³**: å…¨10æ–½è¨­ã®è©³ç´°çµ±è¨ˆ
3. **ã‚¢ãƒ©ãƒ¼ãƒˆ**: å‚åŠ ç‡ä½ä¸‹ã€å‡¦ç†æ—¥æ•°å¢—åŠ ã€ã‚¹ã‚³ã‚¢ä½ä¸‹ã®è­¦å‘Š
4. **æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆ**: ç·åˆç—…é™¢ã€åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼ã€ãƒªãƒãƒ“ãƒªç­‰5ã‚¿ã‚¤ãƒ—ã®é›†è¨ˆ
5. **å…¨æ–½è¨­è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«**: 10æ–½è¨­ã®ä¸€è¦§è¡¨ç¤º

### ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»
- **VoiceDrive**: 100%ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆè¡¨ç¤ºã®ã¿ï¼‰
- **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ **: æ–½è¨­ãƒã‚¹ã‚¿APIæä¾›ã®ã¿

### å¿…è¦ãªDBå¤‰æ›´
- **æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«**: âŒ ä¸è¦
- **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ**: âŒ ä¸è¦
- **æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**: âŒ ä¸è¦

**ç†ç”±**: å…¨ã¦æ—¢å­˜ã®Postã€Userã€Voteãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰é›†è¨ˆå¯èƒ½

---

## ğŸ¯ ãƒšãƒ¼ã‚¸æ©Ÿèƒ½è©³ç´°åˆ†æ

### 1. æ³•äººå…¨ä½“KPIï¼ˆcorporateKPIsï¼‰

#### è¡¨ç¤ºå†…å®¹ï¼ˆlines 37-66ï¼‰
```typescript
const corporateKPIs: KPISummary[] = [
  {
    label: 'ç·æŠ•ç¨¿æ•°ï¼ˆå…¨æ–½è¨­ï¼‰',
    value: '12,847',
    change: '+8.2%',
    trend: 'up',
    status: 'good'
  },
  {
    label: 'å¹³å‡å‚åŠ ç‡',
    value: '64.3%',
    change: '+2.1%',
    trend: 'up',
    status: 'good'
  },
  {
    label: 'å¹³å‡è§£æ±ºç‡',
    value: '58.7%',
    change: '-1.3%',
    trend: 'down',
    status: 'warning'
  },
  {
    label: 'å¹³å‡å‡¦ç†æ—¥æ•°',
    value: '26.4æ—¥',
    change: '-3.8æ—¥',
    trend: 'up',
    status: 'good'
  }
];
```

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

| KPIé …ç›® | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ | ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« |
|---------|------------|------------|
| **ç·æŠ•ç¨¿æ•°** | COUNT(Post) | Post |
| **å¹³å‡å‚åŠ ç‡** | UNIQUE(authorId) / totalEmployees * 100ã®å…¨æ–½è¨­å¹³å‡ | Post, Userï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIï¼‰ |
| **å¹³å‡è§£æ±ºç‡** | COUNT(Post WHERE status = 'RESOLVED') / COUNT(Post) * 100ã®å…¨æ–½è¨­å¹³å‡ | Post |
| **å¹³å‡å‡¦ç†æ—¥æ•°** | AVG(resolvedAt - createdAt)ã®å…¨æ–½è¨­å¹³å‡ | Post |

**çµè«–**: âœ… **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã§å¯¾å¿œå¯èƒ½ï¼ˆæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸è¦ï¼‰**

---

### 2. æ–½è¨­åˆ¥çŠ¶æ³ï¼ˆfacilitiesï¼‰

#### è¡¨ç¤ºå†…å®¹ï¼ˆlines 69-200ï¼‰
```typescript
const facilities: FacilityStatus[] = [
  {
    id: 'F001',
    name: 'ä¸­å¤®ç·åˆç—…é™¢',
    type: 'ç·åˆç—…é™¢',
    totalVoices: 3247,
    activeVoices: 487,
    resolvedVoices: 1842,
    participationRate: 72,
    avgProcessTime: 24,
    healthScore: 85,
    lastUpdated: '2æ™‚é–“å‰',
    trend: 'up'
  },
  // ... å…¨10æ–½è¨­
];
```

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ | ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« |
|-----------|------------|------------|
| **id** | æ–½è¨­ID | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **name** | æ–½è¨­å | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **type** | æ–½è¨­ã‚¿ã‚¤ãƒ— | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **totalVoices** | COUNT(Post WHERE User.facilityId = ?) | Post, User |
| **activeVoices** | COUNT(Post WHERE status = 'ACTIVE' AND User.facilityId = ?) | Post, User |
| **resolvedVoices** | COUNT(Post WHERE status = 'RESOLVED' AND User.facilityId = ?) | Post, User |
| **participationRate** | UNIQUE(authorId) / facilityEmployeeCount * 100 | Post, User, åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **avgProcessTime** | AVG(resolvedAt - createdAt) WHERE facilityId = ? | Post, User |
| **healthScore** | è¨ˆç®—å¼ï¼ˆå‚åŠ ç‡ * 0.4 + è§£æ±ºç‡ * 0.3 + å‡¦ç†é€Ÿåº¦ã‚¹ã‚³ã‚¢ * 0.3ï¼‰ | è¨ˆç®—å€¤ |
| **lastUpdated** | MAX(updatedAt) WHERE facilityId = ? | Post, User |
| **trend** | å‰æœˆæ¯”è¼ƒ | è¨ˆç®—å€¤ |

**çµè«–**: âœ… **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ« + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIï¼ˆæ–½è¨­ãƒã‚¹ã‚¿ï¼‰ã§å¯¾å¿œå¯èƒ½**

---

### 3. ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆalertsï¼‰

#### è¡¨ç¤ºå†…å®¹ï¼ˆlines 242-264ï¼‰
```typescript
const alerts = [
  {
    id: 'alert-1',
    facility: 'è¥¿éƒ¨ä»‹è­·æ–½è¨­',
    type: 'warning',
    message: 'å‚åŠ ç‡ãŒ51%ã«ä½ä¸‹ï¼ˆç›®æ¨™60%ï¼‰',
    timestamp: '2æ™‚é–“å‰'
  },
  {
    id: 'alert-2',
    facility: 'ç·‘ã®æ£®ä»‹è­·ã‚»ãƒ³ã‚¿ãƒ¼',
    type: 'critical',
    message: 'å¹³å‡å‡¦ç†æ—¥æ•°ãŒ38æ—¥ã«å¢—åŠ ï¼ˆç›®æ¨™30æ—¥ä»¥å†…ï¼‰',
    timestamp: '3æ™‚é–“å‰'
  },
  {
    id: 'alert-3',
    facility: 'å—éƒ¨ã‚¯ãƒªãƒ‹ãƒƒã‚¯',
    type: 'warning',
    message: 'ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãŒ65ã«ä½ä¸‹ï¼ˆå‰æœˆæ¯”-8ï¼‰',
    timestamp: '5æ™‚é–“å‰'
  }
];
```

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

ã‚¢ãƒ©ãƒ¼ãƒˆã¯ **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—** ã¾ãŸã¯ **ãƒãƒƒãƒå‡¦ç†ã§ç”Ÿæˆ**:

| ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ | ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« |
|------------|------------|------------|
| **å‚åŠ ç‡ä½ä¸‹** | participationRate < 60% | Post, User |
| **å‡¦ç†æ—¥æ•°å¢—åŠ ** | avgProcessTime > 30æ—¥ | Post |
| **ã‚¹ã‚³ã‚¢ä½ä¸‹** | healthScore < 70 ã¾ãŸã¯ å‰æœˆæ¯”-5ä»¥ä¸Š | è¨ˆç®—å€¤ |

**çµè«–**: âœ… **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã§å¯¾å¿œå¯èƒ½ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ï¼‰**

---

### 4. æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆï¼ˆfacilityTypeStatsï¼‰

#### è¡¨ç¤ºå†…å®¹ï¼ˆlines 203-239ï¼‰
```typescript
const facilityTypeStats = [
  {
    type: 'ç·åˆç—…é™¢',
    count: 2,
    avgHealthScore: 83,
    avgParticipation: 70.5,
    totalVoices: 5381
  },
  {
    type: 'åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼',
    count: 2,
    avgHealthScore: 76.5,
    avgParticipation: 65.5,
    totalVoices: 3184
  },
  // ... 5ã‚¿ã‚¤ãƒ—
];
```

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ | ä½¿ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« |
|-----------|------------|------------|
| **type** | æ–½è¨­ã‚¿ã‚¤ãƒ— | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **count** | COUNT(DISTINCT facilityId) WHERE facilityType = ? | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API |
| **avgHealthScore** | AVG(healthScore) GROUP BY facilityType | è¨ˆç®—å€¤ |
| **avgParticipation** | AVG(participationRate) GROUP BY facilityType | è¨ˆç®—å€¤ |
| **totalVoices** | SUM(totalVoices) GROUP BY facilityType | Post, User |

**çµè«–**: âœ… **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ« + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIï¼ˆæ–½è¨­ãƒã‚¹ã‚¿ï¼‰ã§å¯¾å¿œå¯èƒ½**

---

### 5. å…¨æ–½è¨­è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆfacilities tableï¼‰

#### è¡¨ç¤ºå†…å®¹ï¼ˆlines 414-466ï¼‰

å…¨10æ–½è¨­ã®è©³ç´°æƒ…å ±ã‚’è¡¨å½¢å¼ã§è¡¨ç¤ºï¼š
- æ–½è¨­åã€ã‚¿ã‚¤ãƒ—ã€ç·æŠ•ç¨¿æ•°ã€å¯¾å¿œä¸­ã€è§£æ±ºæ¸ˆã€å‚åŠ ç‡ã€å‡¦ç†æ—¥æ•°ã€ã‚¹ã‚³ã‚¢ã€ãƒˆãƒ¬ãƒ³ãƒ‰

#### ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ†æ

**æ–½è¨­åˆ¥çŠ¶æ³ï¼ˆSection 2ï¼‰ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**

**çµè«–**: âœ… **æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ« + åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIï¼ˆæ–½è¨­ãƒã‚¹ã‚¿ï¼‰ã§å¯¾å¿œå¯èƒ½**

---

## ğŸ—‚ï¸ å¿…è¦ãªDBå¤‰æ›´ã¾ã¨ã‚

### æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

âŒ **ãªã—**

### æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

âŒ **ãªã—**

### æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

âŒ **ãªã—**

**ç†ç”±**:
1. å…¨ã¦æ—¢å­˜ã®Postã€Userã€Voteã€Commentãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰é›†è¨ˆå¯èƒ½
2. æ–½è¨­æƒ…å ±ã¯åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‹ã‚‰å–å¾—
3. ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã€ãƒˆãƒ¬ãƒ³ãƒ‰ç­‰ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆç®—ã§å¯¾å¿œ

---

## ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹å±¤è¨­è¨ˆ

### CorporateAgendaDashboardService

```typescript
export class CorporateAgendaDashboardService {
  /**
   * æ³•äººå…¨ä½“KPIã‚’å–å¾—
   */
  async getCorporateKPIs() {
    // ç·æŠ•ç¨¿æ•°
    const totalPosts = await prisma.post.count();

    // å‰æœˆã®ç·æŠ•ç¨¿æ•°ï¼ˆå‰æœˆæ¯”è¨ˆç®—ç”¨ï¼‰
    const lastMonthStart = new Date();
    lastMonthStart.setMonth(lastMonthStart.getMonth() - 1);
    const lastMonthPosts = await prisma.post.count({
      where: { createdAt: { gte: lastMonthStart } }
    });
    const postChange = ((totalPosts - lastMonthPosts) / lastMonthPosts) * 100;

    // å¹³å‡å‚åŠ ç‡ï¼ˆå…¨æ–½è¨­ï¼‰
    const facilities = await this.getFacilities();
    let totalParticipationRate = 0;
    for (const facility of facilities) {
      const rate = await this.calculateParticipationRate(facility.id);
      totalParticipationRate += rate;
    }
    const avgParticipationRate = totalParticipationRate / facilities.length;

    // å¹³å‡è§£æ±ºç‡
    const resolvedPosts = await prisma.post.count({
      where: { postStatus: 'RESOLVED' }
    });
    const avgResolutionRate = (resolvedPosts / totalPosts) * 100;

    // å¹³å‡å‡¦ç†æ—¥æ•°
    const resolvedPostsWithDates = await prisma.post.findMany({
      where: {
        postStatus: 'RESOLVED',
        resolvedAt: { not: null }
      },
      select: { createdAt: true, resolvedAt: true }
    });
    const avgDays = resolvedPostsWithDates.reduce((sum, post) => {
      const days = Math.floor(
        (post.resolvedAt.getTime() - post.createdAt.getTime()) / (1000 * 60 * 60 * 24)
      );
      return sum + days;
    }, 0) / resolvedPostsWithDates.length;

    return {
      totalPosts: {
        value: totalPosts.toLocaleString(),
        change: `+${postChange.toFixed(1)}%`,
        trend: postChange > 0 ? 'up' : 'down',
        status: postChange > 5 ? 'good' : 'warning'
      },
      avgParticipationRate: {
        value: `${avgParticipationRate.toFixed(1)}%`,
        change: `+2.1%`, // å‰æœˆæ¯”è¨ˆç®—
        trend: 'up',
        status: avgParticipationRate >= 60 ? 'good' : 'warning'
      },
      avgResolutionRate: {
        value: `${avgResolutionRate.toFixed(1)}%`,
        change: `-1.3%`,
        trend: 'down',
        status: avgResolutionRate >= 60 ? 'good' : 'warning'
      },
      avgProcessTime: {
        value: `${avgDays.toFixed(1)}æ—¥`,
        change: `-3.8æ—¥`,
        trend: 'up',
        status: avgDays <= 30 ? 'good' : 'warning'
      }
    };
  }

  /**
   * æ–½è¨­åˆ¥çŠ¶æ³ã‚’å–å¾—
   */
  async getFacilityStatuses(): Promise<FacilityStatus[]> {
    const facilities = await this.getFacilities(); // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ API

    const statuses = await Promise.all(
      facilities.map(async (facility) => {
        // ç·æŠ•ç¨¿æ•°
        const totalVoices = await prisma.post.count({
          where: {
            author: { facilityId: facility.id }
          }
        });

        // å¯¾å¿œä¸­
        const activeVoices = await prisma.post.count({
          where: {
            author: { facilityId: facility.id },
            postStatus: 'ACTIVE'
          }
        });

        // è§£æ±ºæ¸ˆ
        const resolvedVoices = await prisma.post.count({
          where: {
            author: { facilityId: facility.id },
            postStatus: 'RESOLVED'
          }
        });

        // å‚åŠ ç‡
        const participationRate = await this.calculateParticipationRate(facility.id);

        // å¹³å‡å‡¦ç†æ—¥æ•°
        const avgProcessTime = await this.calculateAvgProcessTime(facility.id);

        // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢
        const healthScore = this.calculateHealthScore(
          participationRate,
          (resolvedVoices / totalVoices) * 100,
          avgProcessTime
        );

        // æœ€çµ‚æ›´æ–°
        const latestPost = await prisma.post.findFirst({
          where: {
            author: { facilityId: facility.id }
          },
          orderBy: { updatedAt: 'desc' },
          select: { updatedAt: true }
        });

        return {
          id: facility.id,
          name: facility.name,
          type: facility.type,
          totalVoices,
          activeVoices,
          resolvedVoices,
          participationRate: Math.round(participationRate),
          avgProcessTime: Math.round(avgProcessTime),
          healthScore: Math.round(healthScore),
          lastUpdated: this.formatRelativeTime(latestPost?.updatedAt),
          trend: 'stable' // å‰æœˆæ¯”è¨ˆç®—ã§åˆ¤å®š
        };
      })
    );

    return statuses;
  }

  /**
   * ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç”Ÿæˆ
   */
  async generateAlerts(): Promise<Alert[]> {
    const facilities = await this.getFacilityStatuses();
    const alerts: Alert[] = [];

    for (const facility of facilities) {
      // å‚åŠ ç‡ä½ä¸‹ã‚¢ãƒ©ãƒ¼ãƒˆ
      if (facility.participationRate < 60) {
        alerts.push({
          id: `alert-participation-${facility.id}`,
          facility: facility.name,
          type: facility.participationRate < 50 ? 'critical' : 'warning',
          message: `å‚åŠ ç‡ãŒ${facility.participationRate}%ã«ä½ä¸‹ï¼ˆç›®æ¨™60%ï¼‰`,
          timestamp: this.formatRelativeTime(new Date())
        });
      }

      // å‡¦ç†æ—¥æ•°å¢—åŠ ã‚¢ãƒ©ãƒ¼ãƒˆ
      if (facility.avgProcessTime > 30) {
        alerts.push({
          id: `alert-processtime-${facility.id}`,
          facility: facility.name,
          type: facility.avgProcessTime > 35 ? 'critical' : 'warning',
          message: `å¹³å‡å‡¦ç†æ—¥æ•°ãŒ${facility.avgProcessTime}æ—¥ã«å¢—åŠ ï¼ˆç›®æ¨™30æ—¥ä»¥å†…ï¼‰`,
          timestamp: this.formatRelativeTime(new Date())
        });
      }

      // ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ä½ä¸‹ã‚¢ãƒ©ãƒ¼ãƒˆ
      if (facility.healthScore < 70) {
        alerts.push({
          id: `alert-health-${facility.id}`,
          facility: facility.name,
          type: facility.healthScore < 60 ? 'critical' : 'warning',
          message: `ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ãŒ${facility.healthScore}ã«ä½ä¸‹`,
          timestamp: this.formatRelativeTime(new Date())
        });
      }
    }

    return alerts;
  }

  /**
   * æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆã‚’å–å¾—
   */
  async getFacilityTypeStats() {
    const facilities = await this.getFacilityStatuses();
    const facilitiesMaster = await this.getFacilities();

    // æ–½è¨­ã‚¿ã‚¤ãƒ—ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const typeGroups = facilities.reduce((acc, facility) => {
      const master = facilitiesMaster.find(f => f.id === facility.id);
      const type = master?.type || 'ä¸æ˜';

      if (!acc[type]) {
        acc[type] = [];
      }
      acc[type].push(facility);
      return acc;
    }, {} as Record<string, FacilityStatus[]>);

    return Object.entries(typeGroups).map(([type, facilities]) => ({
      type,
      count: facilities.length,
      avgHealthScore: Math.round(
        facilities.reduce((sum, f) => sum + f.healthScore, 0) / facilities.length
      ),
      avgParticipation: Math.round(
        facilities.reduce((sum, f) => sum + f.participationRate, 0) / facilities.length
      ),
      totalVoices: facilities.reduce((sum, f) => sum + f.totalVoices, 0)
    }));
  }

  /**
   * å‚åŠ ç‡ã‚’è¨ˆç®—ï¼ˆæ–½è¨­åˆ¥ï¼‰
   */
  private async calculateParticipationRate(facilityId: string): Promise<number> {
    const uniqueAuthors = await prisma.post.findMany({
      where: {
        author: { facilityId }
      },
      select: { authorId: true },
      distinct: ['authorId']
    });

    const facilityEmployeeCount = await this.getFacilityEmployeeCount(facilityId);

    return (uniqueAuthors.length / facilityEmployeeCount) * 100;
  }

  /**
   * å¹³å‡å‡¦ç†æ—¥æ•°ã‚’è¨ˆç®—ï¼ˆæ–½è¨­åˆ¥ï¼‰
   */
  private async calculateAvgProcessTime(facilityId: string): Promise<number> {
    const resolvedPosts = await prisma.post.findMany({
      where: {
        author: { facilityId },
        postStatus: 'RESOLVED',
        resolvedAt: { not: null }
      },
      select: { createdAt: true, resolvedAt: true }
    });

    if (resolvedPosts.length === 0) return 0;

    const avgDays = resolvedPosts.reduce((sum, post) => {
      const days = Math.floor(
        (post.resolvedAt.getTime() - post.createdAt.getTime()) / (1000 * 60 * 60 * 24)
      );
      return sum + days;
    }, 0) / resolvedPosts.length;

    return avgDays;
  }

  /**
   * ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
   */
  private calculateHealthScore(
    participationRate: number,
    resolutionRate: number,
    avgProcessTime: number
  ): number {
    // å‚åŠ ç‡ã‚¹ã‚³ã‚¢ï¼ˆ40%ï¼‰: 0-100
    const participationScore = participationRate;

    // è§£æ±ºç‡ã‚¹ã‚³ã‚¢ï¼ˆ30%ï¼‰: 0-100
    const resolutionScore = resolutionRate;

    // å‡¦ç†é€Ÿåº¦ã‚¹ã‚³ã‚¢ï¼ˆ30%ï¼‰: 30æ—¥ä»¥å†…=100, 60æ—¥ä»¥ä¸Š=0
    const processScore = Math.max(0, 100 - ((avgProcessTime - 30) / 30) * 100);

    return (
      participationScore * 0.4 +
      resolutionScore * 0.3 +
      processScore * 0.3
    );
  }

  /**
   * åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–½è¨­ãƒã‚¹ã‚¿ã‚’å–å¾—
   */
  private async getFacilities() {
    // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‚’å‘¼ã³å‡ºã—
    // GET /api/v2/facilities
    return [
      { id: 'F001', name: 'ä¸­å¤®ç·åˆç—…é™¢', type: 'ç·åˆç—…é™¢' },
      { id: 'F002', name: 'åŒ—éƒ¨åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼', type: 'åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼' },
      // ... å…¨10æ–½è¨­
    ];
  }

  /**
   * åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–½è¨­åˆ¥è·å“¡æ•°ã‚’å–å¾—
   */
  private async getFacilityEmployeeCount(facilityId: string): Promise<number> {
    // åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIã‚’å‘¼ã³å‡ºã—
    // GET /api/v2/employees/count?facility={facilityId}
    return 150; // ä»®ã®å€¤
  }

  /**
   * ç›¸å¯¾æ™‚åˆ»ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
   */
  private formatRelativeTime(date: Date): string {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));

    if (hours < 1) return `${Math.floor(diff / (1000 * 60))}åˆ†å‰`;
    if (hours < 24) return `${hours}æ™‚é–“å‰`;
    return `${Math.floor(hours / 24)}æ—¥å‰`;
  }
}
```

---

## ğŸ”Œ å¿…è¦ãªAPI

### VoiceDriveå´APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 1. GET /api/corporate-agenda-dashboard/kpis
æ³•äººå…¨ä½“KPIã‚’å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "corporateKPIs": [
    {
      "label": "ç·æŠ•ç¨¿æ•°ï¼ˆå…¨æ–½è¨­ï¼‰",
      "value": "12,847",
      "change": "+8.2%",
      "trend": "up",
      "status": "good"
    },
    {
      "label": "å¹³å‡å‚åŠ ç‡",
      "value": "64.3%",
      "change": "+2.1%",
      "trend": "up",
      "status": "good"
    },
    {
      "label": "å¹³å‡è§£æ±ºç‡",
      "value": "58.7%",
      "change": "-1.3%",
      "trend": "down",
      "status": "warning"
    },
    {
      "label": "å¹³å‡å‡¦ç†æ—¥æ•°",
      "value": "26.4æ—¥",
      "change": "-3.8æ—¥",
      "trend": "up",
      "status": "good"
    }
  ]
}
```

#### 2. GET /api/corporate-agenda-dashboard/facilities
æ–½è¨­åˆ¥çŠ¶æ³ã‚’å–å¾—

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "facilities": [
    {
      "id": "F001",
      "name": "ä¸­å¤®ç·åˆç—…é™¢",
      "type": "ç·åˆç—…é™¢",
      "totalVoices": 3247,
      "activeVoices": 487,
      "resolvedVoices": 1842,
      "participationRate": 72,
      "avgProcessTime": 24,
      "healthScore": 85,
      "lastUpdated": "2æ™‚é–“å‰",
      "trend": "up"
    }
  ]
}
```

#### 3. GET /api/corporate-agenda-dashboard/alerts
ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—

#### 4. GET /api/corporate-agenda-dashboard/facility-type-stats
æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆã‚’å–å¾—

### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´API

#### 1. GET /api/v2/facilities
æ–½è¨­ãƒã‚¹ã‚¿å–å¾—

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```http
GET /api/v2/facilities
Authorization: Bearer {jwt_token}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "facilities": [
    {
      "id": "F001",
      "code": "CC-HOSP",
      "name": "ä¸­å¤®ç·åˆç—…é™¢",
      "type": "ç·åˆç—…é™¢",
      "address": "...",
      "isActive": true
    },
    {
      "id": "F002",
      "code": "NM-CENTER",
      "name": "åŒ—éƒ¨åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼",
      "type": "åœ°åŸŸåŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼",
      "address": "...",
      "isActive": true
    }
  ],
  "totalCount": 10,
  "timestamp": "2025-10-11T00:00:00Z"
}
```

#### 2. GET /api/v2/employees/count?facility={id}
æ–½è¨­åˆ¥è·å“¡æ•°å–å¾—ï¼ˆæ—¢å­˜APIï¼‰

**å®Ÿè£…çŠ¶æ³**: âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**ï¼ˆOrganizationAnalytics Phase 1ï¼‰

---

## ğŸ“… å®Ÿè£…è¨ˆç”»

### Phase 1: ã‚µãƒ¼ãƒ“ã‚¹å±¤å®Ÿè£…ï¼ˆ3æ—¥ï¼‰

**Day 1: CorporateAgendaDashboardServiceå®Ÿè£…**
- `getCorporateKPIs()`
- `getFacilityStatuses()`

**Day 2: ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»çµ±è¨ˆæ©Ÿèƒ½å®Ÿè£…**
- `generateAlerts()`
- `getFacilityTypeStats()`
- ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

**Day 3: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**
- ã‚µãƒ¼ãƒ“ã‚¹å±¤ãƒ†ã‚¹ãƒˆ
- é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

---

### Phase 2: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…ï¼ˆ2æ—¥ï¼‰

**Day 4: GET APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**
- `/api/corporate-agenda-dashboard/kpis`
- `/api/corporate-agenda-dashboard/facilities`
- `/api/corporate-agenda-dashboard/alerts`
- `/api/corporate-agenda-dashboard/facility-type-stats`

**Day 5: çµ±åˆãƒ†ã‚¹ãƒˆ**
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIé€£æºãƒ†ã‚¹ãƒˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

---

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆï¼ˆ3æ—¥ï¼‰

**Day 6-7: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒå®Ÿè£…**
- ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’APIå‘¼ã³å‡ºã—ã«ç½®ãæ›ãˆ
- React Queryã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

**Day 8: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´**
- E2Eãƒ†ã‚¹ãƒˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

---

### æ¨å®šå·¥æ•°ã¾ã¨ã‚

| Phase | å†…å®¹ | å·¥æ•° |
|-------|------|------|
| Phase 1 | ã‚µãƒ¼ãƒ“ã‚¹å±¤å®Ÿè£… | 3æ—¥ |
| Phase 2 | APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£… | 2æ—¥ |
| Phase 3 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ | 3æ—¥ |
| **åˆè¨ˆ** | | **8æ—¥ï¼ˆç´„1.5é€±é–“ï¼‰** |

---

## âš ï¸ æ³¨æ„äº‹é …ãƒ»èª²é¡Œ

### 1. åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIä¾å­˜

**æ–½è¨­ãƒã‚¹ã‚¿APIï¼ˆGET /api/v2/facilitiesï¼‰ãŒæœªå®Ÿè£…**

**å¯¾å¿œ**:
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã«å®Ÿè£…ä¾é ¼
- å®Ÿè£…å®Œäº†ã¾ã§ã¯VoiceDriveå´ã§æš«å®šçš„ã«æ–½è¨­ãƒã‚¹ã‚¿ã‚’ç®¡ç†

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

æ³•äººå…¨ä½“ï¼ˆå…¨10æ–½è¨­ï¼‰ã®é›†è¨ˆå‡¦ç†ã¯è² è·ãŒé«˜ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å¿œ**:
- é›†è¨ˆçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆRedisï¼‰
- ãƒãƒƒãƒå‡¦ç†ã§äº‹å‰é›†è¨ˆï¼ˆæ¯æ™‚å®Ÿè¡Œï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–

### 3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

**å¯¾å¿œ**:
- WebSocketã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥
- ã¾ãŸã¯ã€å®šæœŸçš„ãªãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ1åˆ†ã”ã¨ï¼‰

---

## ğŸ¯ æˆåŠŸæŒ‡æ¨™ï¼ˆKPIï¼‰

### æ©Ÿèƒ½è¦ä»¶

- âœ… æ³•äººå…¨ä½“KPIãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… æ–½è¨­åˆ¥çŠ¶æ³ãŒä¸€è¦§è¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚¢ãƒ©ãƒ¼ãƒˆãŒé©åˆ‡ã«ç”Ÿæˆã•ã‚Œã‚‹
- âœ… æ–½è¨­ã‚¿ã‚¤ãƒ—åˆ¥çµ±è¨ˆãŒæ­£ç¢º
- âœ… å…¨æ–½è¨­è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‹•ä½œã™ã‚‹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

- å„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : < 2ç§’
- ãƒšãƒ¼ã‚¸åˆæœŸè¡¨ç¤ºæ™‚é–“: < 3ç§’
- æ–½è¨­åˆ¥é›†è¨ˆå‡¦ç†: < 1ç§’/æ–½è¨­

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§

- æ–½è¨­åˆ¥é›†è¨ˆã®åˆè¨ˆ = æ³•äººå…¨ä½“KPI
- ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ãŒæ­£ç¢ºã«åˆ¤å®šã•ã‚Œã‚‹
- ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—ãŒæ­£ç¢º

---

## ğŸ“ é€£çµ¡å…ˆ

### é–‹ç™ºãƒãƒ¼ãƒ 
- Slack: #corporate-agenda-dashboard-dev
- æ‹…å½“: VoiceDriveé–‹ç™ºãƒãƒ¼ãƒ 

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md](./ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸_20251008.md)
- [organization-analytics_DBè¦ä»¶åˆ†æ_20251010.md](./organization-analytics_DBè¦ä»¶åˆ†æ_20251010.md)

---

**æ–‡æ›¸çµ‚äº†**

æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ11æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0
æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼: Phase 1å®Œäº†å¾Œ
