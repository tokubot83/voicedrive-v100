# HomePage統合テスト計画書

**文書番号**: TEST-PLAN-2025-1027-001
**作成日**: 2025年10月27日
**作成者**: VoiceDrive & 医療システム統合チーム
**対象**: https://voicedrive-v100.vercel.app/ (HomePage)
**テスト期間**: 2025年11月1日（金）〜 11月8日（金）
**参照文書**:
- [HomePage_DB要件分析_20251027.md](./HomePage_DB要件分析_20251027.md)
- [HomePage_医療システム実装状況回答書_20251027.md](./HomePage_医療システム実装状況回答書_20251027.md)

---

## 📋 テスト概要

### 目的

HomePageと医療システムAPI（Phase 1/3実装）の連携動作を確認し、本番環境での安定稼働を保証する。

### テスト範囲

| テスト対象 | 内容 |
|-----------|------|
| **医療システムAPI** | 職員情報取得API（GET /api/v2/employees/:id） |
| **Webhook連携** | 職員情報変更通知（employee.updated） |
| **VoiceDrive機能** | 投稿表示・投票・コメント機能 |
| **統合動作** | HomePage初期表示〜投稿操作の一連のフロー |

### テスト環境

| 項目 | 環境 |
|------|------|
| **VoiceDrive** | Vercel本番環境（https://voicedrive-v100.vercel.app） |
| **医療システム** | AWS Lightsail本番環境 |
| **データベース** | MySQL統合環境（16GB） |
| **認証** | JWT Bearer Token |

---

## 🎯 テストシナリオ

### シナリオ1: API連携テスト（医療システム単独）

**目的**: 医療システムAPIの単体動作確認

**前提条件**:
- 医療システムが起動している
- テスト用職員データが登録されている（employeeId: TEST001）

**テスト手順**:

#### 1-1. 個別職員情報取得API

```bash
# リクエスト
curl -X GET https://medical-system.example.com/api/v2/employees/TEST001 \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json"
```

**期待するレスポンス**:
```json
{
  "employeeId": "TEST001",
  "name": "山田太郎",
  "email": "test001@example.com",
  "department": "医療療養病棟",
  "position": "看護師長",
  "professionCategory": "nursing",
  "facilityId": "tategami-hospital",
  "permissionLevel": 7,
  "isActive": true
}
```

**検証項目**:
- [ ] HTTPステータス 200 OK
- [ ] `professionCategory` フィールドが存在する
- [ ] `professionCategory` の値が nursing/medical/rehabilitation/administrative/support/management/other のいずれか
- [ ] `permissionLevel` が 1〜25 の範囲内
- [ ] レスポンスタイム < 500ms

---

#### 1-2. 全職員リスト取得API

```bash
# リクエスト
curl -X GET "https://medical-system.example.com/api/v2/employees?page=1&limit=10" \
  -H "Authorization: Bearer ${JWT_TOKEN}" \
  -H "Content-Type: application/json"
```

**期待するレスポンス**:
```json
{
  "employees": [
    {
      "employeeId": "TEST001",
      "name": "山田太郎",
      "professionCategory": "nursing",
      "permissionLevel": 7
      // ... 他のフィールド
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "totalCount": 245,
    "totalPages": 25,
    "hasNext": true
  }
}
```

**検証項目**:
- [ ] HTTPステータス 200 OK
- [ ] `employees` 配列が存在する
- [ ] 各職員データに `professionCategory` が含まれている
- [ ] `pagination` 情報が正確
- [ ] レスポンスタイム < 1000ms

---

### シナリオ2: HomePage初期表示テスト（VoiceDrive単独）

**目的**: HomePageの基本表示動作確認

**前提条件**:
- VoiceDriveが起動している
- テスト用ユーザーでログイン済み
- 医療システムAPIが利用可能

**テスト手順**:

#### 2-1. HomePage初回アクセス

1. ブラウザで `https://voicedrive-v100.vercel.app/` にアクセス
2. ログイン画面が表示される
3. テスト用ユーザーでログイン（employeeId: TEST001）
4. HomePageが表示される

**検証項目**:
- [ ] タブが表示される（improvement/community/freevoice/urgent）
- [ ] デフォルトタブが `improvement` である
- [ ] 投稿作成カードが4つ表示される（面談/アイデア/フリー/コンプライアンス）
- [ ] 投稿一覧（Timeline）が表示される
- [ ] 投稿が0件の場合、適切なメッセージが表示される

---

#### 2-2. タブ切り替え

1. `community` タブをクリック
2. URLパラメータが `?tab=community` に変わる
3. コミュニティ投稿が表示される

**検証項目**:
- [ ] タブの切り替えがスムーズ（< 500ms）
- [ ] URLパラメータが正しく更新される
- [ ] フィルタされた投稿のみが表示される
- [ ] タブのハイライト表示が正しい

---

#### 2-3. 投稿表示

1. `improvement` タブの投稿一覧を確認
2. 各投稿カードに以下が表示される:
   - 投稿者名（または匿名表示）
   - 投稿内容
   - 投票ボタン（5段階）
   - 投票数集計
   - コメント数
   - 投稿日時

**検証項目**:
- [ ] 投稿が時系列順にソートされている
- [ ] 投票ボタンが5段階表示される（強い反対〜強い賛成）
- [ ] 投票数が正確に表示される
- [ ] 匿名レベルに応じた投稿者表示が正しい
- [ ] 議題スコア・議題レベルが表示される（50点以上の場合）

---

### シナリオ3: 投票機能テスト（VoiceDrive単独）

**目的**: 投票機能の動作確認

**前提条件**:
- HomePageが表示されている
- テスト用投稿が1件以上存在する

**テスト手順**:

#### 3-1. 投票実行

1. 投稿の「賛成」ボタンをクリック
2. 投票数が +1 される
3. 投票ボタンの色が変わる（選択済み表示）
4. 同じ投稿に再投票できないことを確認

**検証項目**:
- [ ] 投票ボタンクリック時にローディング表示される
- [ ] 投票数がリアルタイムで更新される
- [ ] 投票後、ボタンが非活性化される
- [ ] LocalStorageに投票履歴が保存される
- [ ] DBに投票記録が保存される（VoteHistoryテーブル）

---

#### 3-2. 投票履歴確認

1. PersonalStationページに遷移
2. 「投票履歴」セクションを確認
3. 先ほど投票した投稿が表示される

**検証項目**:
- [ ] 投票した投稿がリストに表示される
- [ ] 投票オプション（賛成）が表示される
- [ ] 投票日時が表示される

---

### シナリオ4: コメント機能テスト（VoiceDrive単独）

**目的**: コメント投稿機能の動作確認

**前提条件**:
- HomePageが表示されている
- テスト用投稿が1件以上存在する

**テスト手順**:

#### 4-1. コメント投稿

1. 投稿の「コメント」ボタンをクリック
2. コメント入力フォームが表示される
3. テキストを入力（例: "良い提案だと思います"）
4. コメント種別を選択（support/question/concern/information）
5. 「送信」ボタンをクリック

**検証項目**:
- [ ] コメント入力フォームが表示される
- [ ] コメント種別が選択できる
- [ ] 匿名レベルが選択できる
- [ ] 送信後、コメント一覧に即座に表示される
- [ ] DBにコメントが保存される（Commentテーブル）

---

### シナリオ5: Webhook連携テスト（統合）

**目的**: 医療システムからVoiceDriveへのWebhook通知動作確認

**前提条件**:
- VoiceDriveのWebhook受信エンドポイントが実装されている
- 医療システムのWebhook送信機能が有効
- 環境変数 `VOICEDRIVE_WEBHOOK_URL` と `WEBHOOK_API_KEY` が設定されている

**テスト手順**:

#### 5-1. 職員情報変更 → Webhook送信

1. 医療システムで職員情報を変更（TEST001の部署を変更）
2. 医療システムがWebhookを送信
3. VoiceDriveがWebhookを受信
4. VoiceDrive `User`テーブルが更新される
5. HomePageで投稿者情報が更新される

**検証項目**:
- [ ] 医療システムがWebhookを送信する（ログ確認）
- [ ] VoiceDriveがWebhookを受信する（ログ確認）
- [ ] `User`テーブルが更新される（DB確認）
- [ ] HomePageの投稿者情報が即座に更新される
- [ ] 更新所要時間 < 5秒

---

#### 5-2. Webhookペイロード検証

**送信ペイロード**:
```json
{
  "eventType": "employee.updated",
  "timestamp": "2025-11-01T10:30:00Z",
  "data": {
    "staffId": "TEST001",
    "facilityId": "tategami-hospital",
    "changes": {
      "position": "看護師長",
      "accountLevel": 8
    },
    "previousState": {
      "position": "看護師",
      "accountLevel": 7
    }
  }
}
```

**検証項目**:
- [ ] ペイロードの形式が正しい
- [ ] `Authorization` ヘッダーが含まれている
- [ ] `X-Webhook-Version` ヘッダーが `1.0`
- [ ] `X-Event-Type` ヘッダーが `employee.updated`

---

#### 5-3. Webhookリトライテスト

1. VoiceDriveのWebhook受信エンドポイントを一時停止
2. 医療システムで職員情報を変更
3. Webhookが失敗する
4. 医療システムが自動リトライする（1秒 → 2秒 → 3秒後）

**検証項目**:
- [ ] リトライ回数が3回である
- [ ] リトライ間隔が指数バックオフに従う（1秒 → 2秒 → 3秒）
- [ ] 3回失敗後、エラーログが記録される
- [ ] VoiceDrive復旧後、次回の変更で正常に通知される

---

### シナリオ6: エンドツーエンドテスト（統合）

**目的**: 実際のユーザー利用フローを再現

**テストフロー**:

#### 6-1. ユーザーストーリー：新規投稿から投票まで

**登場人物**:
- ユーザーA（TEST001）: 投稿者
- ユーザーB（TEST002）: 投票者

**ステップ**:

1. **ユーザーA: HomePageアクセス**
   - ログイン（employeeId: TEST001）
   - HomePageが表示される
   - 医療システムAPIから職員情報が取得される

2. **ユーザーA: アイデアボイス投稿**
   - 「アイデアボイス」カードをクリック
   - `/compose/improvement` に遷移
   - 投稿内容を入力
   - 匿名レベルを選択（実名）
   - 「投稿」ボタンをクリック
   - HomePageに戻る

3. **ユーザーB: HomePageアクセス**
   - ログイン（employeeId: TEST002）
   - HomePageが表示される
   - ユーザーAの投稿が表示される

4. **ユーザーB: 投票**
   - ユーザーAの投稿に「賛成」投票
   - 投票数が +1 される
   - 投票履歴に記録される

5. **ユーザーB: コメント**
   - ユーザーAの投稿にコメント投稿
   - コメント種別: support
   - コメント内容: "良い提案だと思います"

6. **ユーザーA: 通知確認**
   - 投票・コメントの通知を受信
   - PersonalStationで統計を確認
   - 投票数が増えていることを確認

**検証項目**:
- [ ] 全ステップがエラーなく完了する
- [ ] 投稿がリアルタイムで反映される（< 5秒）
- [ ] 投票数が正確に集計される
- [ ] コメントが即座に表示される
- [ ] 通知が適切に送信される
- [ ] 統計データが正確に更新される

---

## 📊 テスト実施計画

### テストスケジュール

| 日付 | 時間 | テスト内容 | 担当 |
|------|------|----------|------|
| **11/1（金）** | 10:00-12:00 | シナリオ1: API連携テスト | 医療システムチーム |
| | 13:00-15:00 | シナリオ2: HomePage初期表示テスト | VoiceDriveチーム |
| | 15:00-17:00 | シナリオ3: 投票機能テスト | VoiceDriveチーム |
| **11/4（月）** | 10:00-12:00 | シナリオ4: コメント機能テスト | VoiceDriveチーム |
| | 13:00-15:00 | シナリオ5: Webhook連携テスト | 両チーム合同 |
| **11/5（火）** | 10:00-12:00 | シナリオ6: E2Eテスト | 両チーム合同 |
| | 13:00-15:00 | 不具合修正 | 該当チーム |
| **11/6（水）** | 10:00-17:00 | リグレッションテスト | 両チーム合同 |
| **11/7（木）** | 10:00-12:00 | 最終確認テスト | 両チーム合同 |
| | 13:00-15:00 | テスト報告書作成 | 統合チーム |
| **11/8（金）** | 10:00-12:00 | 本番環境デプロイ準備 | 両チーム合同 |

---

### テスト環境準備

#### VoiceDrive側

**必要な設定**:
```env
# .env.production
DATABASE_URL="mysql://user:password@lightsail.example.com:3306/voicedrive"
MEDICAL_SYSTEM_API_URL="https://medical-system.example.com/api/v2"
MEDICAL_SYSTEM_API_KEY="xxxxxxxxxxxxxxxx"
WEBHOOK_SECRET="yyyyyyyyyyyyyyyy"
```

**確認事項**:
- [ ] Webhook受信エンドポイント実装完了（`POST /api/webhooks/employee-updated`）
- [ ] 医療システムAPIクライアント実装完了（`MedicalSystemClient.ts`）
- [ ] UserSyncService実装完了

---

#### 医療システム側

**必要な設定**:
```env
# .env.production
VOICEDRIVE_WEBHOOK_URL="https://voicedrive-v100.vercel.app/api/webhooks/employee-updated"
WEBHOOK_API_KEY="zzzzzzzzzzzzzzzz"
```

**確認事項**:
- [ ] APIエンドポイント実装完了（`GET /api/v2/employees/:id`）
- [ ] professionCategory変換ロジック実装完了
- [ ] Webhook送信機能実装完了（`webhook-notification.service.ts`）
- [ ] リトライ機構実装完了

---

### テストデータ準備

#### テスト用職員データ

| employeeId | name | department | position | professionCategory | permissionLevel |
|-----------|------|-----------|---------|-------------------|----------------|
| TEST001 | 山田太郎 | 医療療養病棟 | 看護師長 | nursing | 7 |
| TEST002 | 田中花子 | 外来・健診センター | 看護師 | nursing | 5 |
| TEST003 | 鈴木一郎 | 医療療養病棟 | 医師 | medical | 15 |

#### テスト用投稿データ

| postId | authorId | type | content | priority |
|--------|---------|------|---------|---------|
| POST001 | TEST001 | improvement | 休憩室の環境改善提案 | medium |
| POST002 | TEST002 | community | チームビルディングイベント告知 | low |
| POST003 | TEST003 | improvement | 電子カルテシステム改善提案 | high |

---

## 📋 テスト結果記録

### シナリオ1: API連携テスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 1-1. 個別職員情報取得API | - | ⏳ 未実施 | - |
| 1-2. 全職員リスト取得API | - | ⏳ 未実施 | - |

### シナリオ2: HomePage初期表示テスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 2-1. HomePage初回アクセス | - | ⏳ 未実施 | - |
| 2-2. タブ切り替え | - | ⏳ 未実施 | - |
| 2-3. 投稿表示 | - | ⏳ 未実施 | - |

### シナリオ3: 投票機能テスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 3-1. 投票実行 | - | ⏳ 未実施 | - |
| 3-2. 投票履歴確認 | - | ⏳ 未実施 | - |

### シナリオ4: コメント機能テスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 4-1. コメント投稿 | - | ⏳ 未実施 | - |

### シナリオ5: Webhook連携テスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 5-1. 職員情報変更 → Webhook送信 | - | ⏳ 未実施 | - |
| 5-2. Webhookペイロード検証 | - | ⏳ 未実施 | - |
| 5-3. Webhookリトライテスト | - | ⏳ 未実施 | - |

### シナリオ6: エンドツーエンドテスト

| テストケース | 実施日時 | 結果 | 備考 |
|------------|---------|------|------|
| 6-1. 新規投稿から投票まで | - | ⏳ 未実施 | - |

---

## 🚨 不具合管理

### 不具合報告フォーマット

| 項目 | 内容 |
|------|------|
| **不具合ID** | BUG-HP-001 |
| **発見日** | 2025/11/1 |
| **重要度** | 高/中/低 |
| **シナリオ** | シナリオ1-1 |
| **現象** | professionCategoryフィールドが空 |
| **再現手順** | 1. API呼び出し、2. レスポンス確認 |
| **期待値** | professionCategory: "nursing" |
| **実際の値** | professionCategory: null |
| **担当** | 医療システムチーム |
| **ステータス** | Open/In Progress/Resolved |

---

## ✅ テスト完了条件

### 必須条件（全て✅で合格）

- [ ] シナリオ1: API連携テスト 100%成功
- [ ] シナリオ2: HomePage初期表示テスト 100%成功
- [ ] シナリオ3: 投票機能テスト 100%成功
- [ ] シナリオ4: コメント機能テスト 100%成功
- [ ] シナリオ5: Webhook連携テスト 100%成功
- [ ] シナリオ6: E2Eテスト 100%成功
- [ ] 重大な不具合（重要度: 高）が0件
- [ ] パフォーマンス要件達成（レスポンスタイム < 1秒）

---

## 🔗 関連ドキュメント

- [HomePage_DB要件分析_20251027.md](./HomePage_DB要件分析_20251027.md)
- [HomePage暫定マスターリスト_20251027.md](./HomePage暫定マスターリスト_20251027.md)
- [HomePage_医療システム実装状況回答書_20251027.md](./HomePage_医療システム実装状況回答書_20251027.md)

---

**文書終了**

最終更新: 2025年10月27日
バージョン: 1.0
承認: 未承認（両チームレビュー待ち）
