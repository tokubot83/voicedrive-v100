# 認証システム最終設計書（QRコード + PWA方式）

**文書番号**: AUTH-DESIGN-2025-1027-001
**作成日**: 2025年10月27日
**決定事項**: 医療システム認証API + QRコード + PWA方式を採用
**参照文書**:
- [UnauthorizedPage_DB要件分析_20251027.md](./UnauthorizedPage_DB要件分析_20251027.md)
- [UnauthorizedPage暫定マスターリスト_20251027.md](./UnauthorizedPage暫定マスターリスト_20251027.md)

---

## 📋 エグゼクティブサマリー

### 採用決定: QRコード + PWA方式 ⭐⭐⭐⭐⭐

**決定理由（UX観点）**:
1. **高齢職員・パートタイム職員にとって最も使いやすい**
   - キーボード入力不要
   - パスワード記憶不要
   - QRコードをスキャンするだけでログイン完了

2. **緊急時の迅速なアクセス**
   - 夜勤帯での迅速な情報アクセス
   - ホーム画面アイコンタップだけで即起動

3. **初回セットアップの簡単さ**
   - 人事部から受け取った用紙のQRコードをスキャン
   - ホーム画面に追加するだけ
   - 以降はアイコンタップのみ

### 実装スコープ

| 項目 | 医療システム側 | VoiceDrive側 | 工数 |
|-----|--------------|-------------|-----|
| **QRコード認証** | OneTimeToken生成API | トークン検証フロー | 医療: 2日<br>VD: 3日 |
| **基本認証** | 認証API実装 | useAuth実装 | 医療: 2日<br>VD: 5日 |
| **パスワード管理** | パスワード変更API | パスワード変更画面 | 医療: 1日<br>VD: 2日 |
| **セッション管理** | LoginHistory記録 | Cookie/Session管理 | 医療: 1日<br>VD: 3日 |
| **PWA対応** | - | manifest.json等 | VD: 2日 |
| **アカウントロック** | LoginAttempt管理 | エラーハンドリング | 医療: 0.5日<br>VD: 1日 |
| **合計工数** | **6.5日** | **16日** | **22.5日** |

---

## 🎯 認証フロー設計

### Pattern 1: QRコード初回セットアップ（推奨フロー）

```
┌──────────────────────────────────────────────────────────────┐
│ Step 1: 人事部での新入職員アカウント作成                       │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ 医療システム側処理:                                             │
│                                                                │
│ POST /api/v2/auth/generate-onetime-token                      │
│ {                                                              │
│   "employeeId": "EMP2024123",                                 │
│   "purpose": "initial_setup",                                 │
│   "validityHours": 24                                         │
│ }                                                              │
│                                                                │
│ ↓ レスポンス                                                   │
│                                                                │
│ {                                                              │
│   "token": "a3f7c2e1d9b4...",  // 64文字のランダム文字列       │
│   "qrCodeUrl": "https://voicedrive.hospital.local/login?token=...", │
│   "qrCodeImage": "data:image/png;base64,...",  // Data URL    │
│   "expiresAt": "2025-10-28T15:30:00Z"                         │
│ }                                                              │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 2: アカウント情報シート印刷                                │
│                                                                │
│ ┌──────────────────────────────────────────────────────┐     │
│ │    大原記念病院 VoiceDrive アカウント情報            │     │
│ │                                                        │     │
│ │    職員ID: EMP2024123                                 │     │
│ │    氏名: 山田 太郎                                     │     │
│ │    所属: 外科                                          │     │
│ │                                                        │     │
│ │    【初回ログイン用QRコード】                          │     │
│ │    ┌──────────────────┐                              │     │
│ │    │  ██████  ██  ██  │  ← QRコードをスキャン        │     │
│ │    │  ██  ██  ████    │                              │     │
│ │    │  ██████  ██████  │                              │     │
│ │    └──────────────────┘                              │     │
│ │                                                        │     │
│ │    有効期限: 2025年10月28日 15:30まで                 │     │
│ │    発行日: 2025年10月27日                             │     │
│ └──────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 3: 新入職員がQRコードをスキャン                           │
│                                                                │
│ スマートフォンのカメラでQRコードを読み取る                      │
│ → ブラウザが自動起動                                           │
│ → https://voicedrive.hospital.local/login?token=a3f7c2e1d9b4...│
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 4: VoiceDrive側処理（自動ログイン）                       │
│                                                                │
│ VoiceDriveフロントエンド:                                      │
│ - URLパラメータからtoken取得                                   │
│ - POST /api/auth/verify-onetime-token                         │
│   {                                                            │
│     "token": "a3f7c2e1d9b4...",                               │
│     "ipAddress": "192.168.1.100",                             │
│     "userAgent": "Mozilla/5.0..."                             │
│   }                                                            │
│                                                                │
│ ↓ 医療システムに転送                                           │
│                                                                │
│ POST /api/v2/auth/verify-onetime-token                        │
│                                                                │
│ ↓ 医療システム側処理                                           │
│ - OneTimeTokenテーブル確認                                     │
│ - 有効期限チェック（24時間以内）                               │
│ - used = false 確認                                           │
│ - Employeeテーブルから職員情報取得                             │
│ - used = true, usedAt = NOW(), usedIpAddress, usedUserAgent更新│
│                                                                │
│ ↓ レスポンス                                                   │
│                                                                │
│ {                                                              │
│   "success": true,                                            │
│   "employee": {                                               │
│     "employeeId": "EMP2024123",                               │
│     "name": "山田 太郎",                                       │
│     "email": "yamada.taro@hospital.local",                    │
│     "permissionLevel": 3.5,                                   │
│     "accountType": "STAFF",                                   │
│     "role": "nurse",                                          │
│     "department": "外科"                                       │
│   }                                                            │
│ }                                                              │
│                                                                │
│ ↓ VoiceDrive側処理                                            │
│ - Userテーブル検索（employeeId = "EMP2024123"）               │
│ - User存在しない → 新規作成                                    │
│ - セッション作成（30日間有効、Cookie保存）                      │
│ - ログイン成功画面表示                                          │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 5: PWAインストール案内                                    │
│                                                                │
│ ┌──────────────────────────────────────────────────────┐     │
│ │  ✅ ログインに成功しました！                           │     │
│ │                                                        │     │
│ │  より便利に使うために、ホーム画面に追加しませんか？   │     │
│ │                                                        │     │
│ │  ┌────────────────────────────────┐                   │     │
│ │  │ 📱 ホーム画面に追加                │  ← タップ      │     │
│ │  └────────────────────────────────┘                   │     │
│ │                                                        │     │
│ │  ホーム画面に追加すると...                             │     │
│ │  ✅ アプリのようにアイコンから起動できます             │     │
│ │  ✅ 毎回ログインする必要がありません                   │     │
│ │  ✅ オフラインでも一部機能が使えます                   │     │
│ │                                                        │     │
│ │  [後で] [追加する]                                     │     │
│ └──────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 6: ホーム画面にアイコン追加完了                           │
│                                                                │
│ スマートフォンのホーム画面:                                     │
│ ┌────┐ ┌────┐ ┌────┐ ┌────┐                             │
│ │📧  │ │📷  │ │⚕️  │ │🎵  │                             │
│ │Mail│ │Photo│ │VD  │ │Music│  ← VoiceDriveアイコン       │
│ └────┘ └────┘ └────┘ └────┘                             │
│                                                                │
│ 以降のアクセス:                                                 │
│ ① アイコンをタップ                                             │
│ ② 自動ログイン（セッション30日間有効）                          │
│ ③ すぐに使える！                                               │
└──────────────────────────────────────────────────────────────┘
```

**所要時間**: 約3分（QRコードスキャン + PWAインストール）

---

### Pattern 2: 従来型ログイン（バックアップ手段）

QRコードが利用できない場合のフォールバック：

```
┌──────────────────────────────────────────────────────────────┐
│ Step 1: ログイン画面                                           │
│                                                                │
│ ┌──────────────────────────────────────────────────────┐     │
│ │  VoiceDrive ログイン                                  │     │
│ │                                                        │     │
│ │  職員ID:   [EMP2024123        ]                       │     │
│ │  パスワード: [****************  ]                       │     │
│ │                                                        │     │
│ │  [ログイン]                                            │     │
│ │                                                        │     │
│ │  ※初回ログイン時は初期パスワードを入力してください     │     │
│ │  初期パスワード形式: {職員ID}_InitPass2025            │     │
│ │  例: EMP2024123_InitPass2025                          │     │
│ └──────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 2: 医療システム認証API呼び出し                            │
│                                                                │
│ POST /api/v2/auth/authenticate                                │
│ {                                                              │
│   "employeeId": "EMP2024123",                                 │
│   "password": "EMP2024123_InitPass2025"                       │
│ }                                                              │
│                                                                │
│ ↓ レスポンス                                                   │
│                                                                │
│ {                                                              │
│   "success": true,                                            │
│   "passwordMustChange": true,  // 初回ログイン検知             │
│   "employee": { ... }                                         │
│ }                                                              │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 3: パスワード変更画面（初回のみ）                          │
│                                                                │
│ ┌──────────────────────────────────────────────────────┐     │
│ │  🔒 パスワード変更が必要です                          │     │
│ │                                                        │     │
│ │  セキュリティのため、初回ログイン時にパスワードを      │     │
│ │  変更してください。                                    │     │
│ │                                                        │     │
│ │  現在のパスワード: [****************  ]                 │     │
│ │  新しいパスワード: [****************  ]                 │     │
│ │  パスワード確認:   [****************  ]                 │     │
│ │                                                        │     │
│ │  パスワード要件:                                       │     │
│ │  ✅ 8文字以上                                          │     │
│ │  ✅ 大文字・小文字・数字を含む                          │     │
│ │  ✅ 記号を1つ以上含む（推奨）                          │     │
│ │                                                        │     │
│ │  [変更する]                                            │     │
│ └──────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 4: パスワード変更API呼び出し                              │
│                                                                │
│ PUT /api/v2/auth/change-password                              │
│ {                                                              │
│   "employeeId": "EMP2024123",                                 │
│   "currentPassword": "EMP2024123_InitPass2025",               │
│   "newPassword": "MySecurePass123!"                           │
│ }                                                              │
│                                                                │
│ ↓ 医療システム側処理                                           │
│ - 現在のパスワード検証                                         │
│ - 新パスワードのポリシー検証                                    │
│ - passwordHash更新（bcrypt cost=10）                          │
│ - passwordMustChange = false 設定                             │
│ - passwordUpdatedAt = NOW()                                   │
│                                                                │
│ ↓ レスポンス                                                   │
│                                                                │
│ {                                                              │
│   "success": true,                                            │
│   "message": "パスワードを変更しました"                        │
│ }                                                              │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 5: ログイン完了 → PWAインストール案内                     │
│                                                                │
│ （Pattern 1の Step 5 と同じ）                                 │
└──────────────────────────────────────────────────────────────┘
```

**所要時間**: 約5分（初回パスワード変更を含む）

---

## 🗄️ データベーススキーマ

### 医療システム側（マスタDB）

#### 1. Employeeテーブル（既存 + 拡張）

```prisma
model Employee {
  employeeId          String    @id @map("employee_id")
  name                String
  email               String    @unique
  permissionLevel     Float     @map("permission_level")
  accountType         String    @map("account_type")  // 'ADMIN' | 'STAFF' | 'LIMITED'
  role                String?   // 'doctor' | 'nurse' | 'admin_staff' | etc.
  department          String?
  facilityId          String?   @map("facility_id")

  // 🆕 認証関連フィールド（追加）
  passwordHash        String    @map("password_hash")           // bcrypt hash
  passwordUpdatedAt   DateTime? @map("password_updated_at")    // 最終変更日時
  passwordMustChange  Boolean   @default(true) @map("password_must_change")  // 初回変更フラグ

  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // リレーション
  onetimeTokens       OnetimeToken[]
  loginHistory        LoginHistory[]
  loginAttempts       LoginAttempt[]

  @@map("employees")
}
```

**追加フィールド説明**:
- `passwordHash`: bcrypt(cost=10)でハッシュ化されたパスワード
- `passwordUpdatedAt`: 最終変更日時（90日後に期限切れ警告に使用）
- `passwordMustChange`: 初回ログイン時 `true`、パスワード変更後 `false`

---

#### 2. OnetimeToken テーブル（新規）

```prisma
model OnetimeToken {
  id              String    @id @default(cuid())
  token           String    @unique  // crypto.randomBytes(32).toString('hex')
  employeeId      String    @map("employee_id")
  purpose         String    // 'initial_setup' | 'password_reset'
  expiresAt       DateTime  @map("expires_at")  // 発行から24時間
  used            Boolean   @default(false)
  usedAt          DateTime? @map("used_at")
  usedIpAddress   String?   @map("used_ip_address")
  usedUserAgent   String?   @map("used_user_agent")
  createdAt       DateTime  @default(now()) @map("created_at")

  employee        Employee  @relation(fields: [employeeId], references: [employeeId])

  @@map("onetime_tokens")
  @@index([employeeId])
  @@index([expiresAt])
  @@index([used])
}
```

**使用方法**:
1. 人事部がアカウント作成時に `generate-onetime-token` API呼び出し
2. QRコードを印刷してアカウント情報シートに添付
3. 新入職員がQRコードスキャン → トークン消費（`used = true`）
4. 24時間後に自動的に無効化（cronジョブで削除）

---

#### 3. LoginHistory テーブル（新規）

```prisma
model LoginHistory {
  id              String    @id @default(cuid())
  employeeId      String    @map("employee_id")
  loginAt         DateTime  @default(now()) @map("login_at")
  ipAddress       String    @map("ip_address")
  userAgent       String    @map("user_agent")
  loginMethod     String    @map("login_method")  // 'password' | 'onetime_token'
  success         Boolean   @default(true)
  failureReason   String?   @map("failure_reason")  // 'invalid_credentials' | 'account_locked' | etc.

  employee        Employee  @relation(fields: [employeeId], references: [employeeId])

  @@map("login_history")
  @@index([employeeId])
  @@index([loginAt])
}
```

**目的**: 監査ログ、セキュリティ分析、アカウント侵害検知

---

#### 4. LoginAttempt テーブル（新規）

```prisma
model LoginAttempt {
  id              String    @id @default(cuid())
  employeeId      String    @map("employee_id")
  attemptAt       DateTime  @default(now()) @map("attempt_at")
  ipAddress       String    @map("ip_address")
  success         Boolean   @default(false)

  employee        Employee  @relation(fields: [employeeId], references: [employeeId])

  @@map("login_attempts")
  @@index([employeeId, attemptAt])
}
```

**アカウントロックロジック**:
```typescript
// 過去30分間の失敗回数をカウント
const failedAttempts = await prisma.loginAttempt.count({
  where: {
    employeeId: 'EMP2024123',
    success: false,
    attemptAt: { gte: new Date(Date.now() - 30 * 60 * 1000) }
  }
});

if (failedAttempts >= 5) {
  throw new Error('ACCOUNT_LOCKED'); // 30分間ロック
}
```

---

### VoiceDrive側（キャッシュDB）

#### User テーブル（既存）

```prisma
model User {
  id              String      @id @default(cuid())
  employeeId      String      @unique @map("employee_id")

  // 医療システムから同期されるフィールド
  name            String
  email           String      @unique
  permissionLevel Float       @map("permission_level")
  accountType     String      @map("account_type")
  role            String?

  // VoiceDrive固有のフィールド
  lastLoginAt     DateTime?   @map("last_login_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("users")
}
```

**変更不要**: 既存のUserテーブルで対応可能

---

## 🔌 API仕様

### 医療システム側API

#### API-1: QRコード用トークン生成

**エンドポイント**: `POST /api/v2/auth/generate-onetime-token`

**権限**: 人事部管理者のみ（permissionLevel >= 9.0）

**リクエスト**:
```json
{
  "employeeId": "EMP2024123",
  "purpose": "initial_setup",
  "validityHours": 24
}
```

**レスポンス**:
```json
{
  "success": true,
  "token": "a3f7c2e1d9b4f8e6c1a5d7b9e3f1c8d2a4f6e8c0b2d4f6a8e0c2d4f6a8e0c2d4",
  "qrCodeUrl": "https://voicedrive.hospital.local/login?token=a3f7c2e1d9b4...",
  "qrCodeImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
  "expiresAt": "2025-10-28T15:30:00Z"
}
```

**実装例**:
```typescript
import crypto from 'crypto';
import QRCode from 'qrcode';
import { prisma } from './prisma';

export async function generateOnetimeToken(req: Request, res: Response) {
  const { employeeId, purpose = 'initial_setup', validityHours = 24 } = req.body;

  // 権限チェック（人事部管理者のみ）
  if (req.session.user.permissionLevel < 9.0) {
    return res.status(403).json({ error: 'INSUFFICIENT_PERMISSION' });
  }

  // 職員存在確認
  const employee = await prisma.employee.findUnique({
    where: { employeeId }
  });

  if (!employee) {
    return res.status(404).json({ error: 'EMPLOYEE_NOT_FOUND' });
  }

  // 既存の未使用トークンがあれば削除
  await prisma.onetimeToken.deleteMany({
    where: {
      employeeId,
      used: false,
      expiresAt: { gt: new Date() }
    }
  });

  // 新規トークン生成（64文字のランダム文字列）
  const token = crypto.randomBytes(32).toString('hex');

  // 有効期限設定
  const expiresAt = new Date();
  expiresAt.setHours(expiresAt.getHours() + validityHours);

  // DBに保存
  await prisma.onetimeToken.create({
    data: {
      token,
      employeeId,
      purpose,
      expiresAt,
      used: false
    }
  });

  // QRコード生成
  const qrCodeUrl = `${process.env.VOICEDRIVE_URL}/login?token=${token}`;
  const qrCodeImage = await QRCode.toDataURL(qrCodeUrl, {
    width: 300,
    margin: 2,
    color: {
      dark: '#000000',
      light: '#FFFFFF'
    }
  });

  res.json({
    success: true,
    token,
    qrCodeUrl,
    qrCodeImage,
    expiresAt: expiresAt.toISOString()
  });
}
```

---

#### API-2: トークン検証

**エンドポイント**: `POST /api/v2/auth/verify-onetime-token`

**リクエスト**:
```json
{
  "token": "a3f7c2e1d9b4f8e6c1a5d7b9e3f1c8d2a4f6e8c0b2d4f6a8e0c2d4f6a8e0c2d4",
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X)"
}
```

**レスポンス（成功）**:
```json
{
  "success": true,
  "employee": {
    "employeeId": "EMP2024123",
    "name": "山田 太郎",
    "email": "yamada.taro@hospital.local",
    "permissionLevel": 3.5,
    "accountType": "STAFF",
    "role": "nurse",
    "department": "外科"
  }
}
```

**レスポンス（エラー）**:
```json
{
  "success": false,
  "error": "TOKEN_EXPIRED",
  "message": "このQRコードは有効期限切れです"
}
```

**エラーコード**:
- `TOKEN_NOT_FOUND`: トークンが存在しない
- `TOKEN_EXPIRED`: 有効期限切れ（24時間経過）
- `TOKEN_ALREADY_USED`: すでに使用済み
- `EMPLOYEE_NOT_FOUND`: 職員が存在しない
- `EMPLOYEE_INACTIVE`: 退職済み

**実装例**:
```typescript
export async function verifyOnetimeToken(req: Request, res: Response) {
  const { token, ipAddress, userAgent } = req.body;

  // トークン検索
  const onetimeToken = await prisma.onetimeToken.findUnique({
    where: { token },
    include: { employee: true }
  });

  if (!onetimeToken) {
    return res.status(404).json({
      success: false,
      error: 'TOKEN_NOT_FOUND',
      message: 'QRコードが無効です'
    });
  }

  // 有効期限チェック
  if (new Date() > onetimeToken.expiresAt) {
    return res.status(400).json({
      success: false,
      error: 'TOKEN_EXPIRED',
      message: 'このQRコードは有効期限切れです（発行から24時間以内に使用してください）'
    });
  }

  // 使用済みチェック
  if (onetimeToken.used) {
    return res.status(400).json({
      success: false,
      error: 'TOKEN_ALREADY_USED',
      message: 'このQRコードはすでに使用されています'
    });
  }

  // 職員の有効性チェック
  if (!onetimeToken.employee.isActive) {
    return res.status(403).json({
      success: false,
      error: 'EMPLOYEE_INACTIVE',
      message: 'このアカウントは無効化されています'
    });
  }

  // トークンを使用済みにする
  await prisma.onetimeToken.update({
    where: { id: onetimeToken.id },
    data: {
      used: true,
      usedAt: new Date(),
      usedIpAddress: ipAddress,
      usedUserAgent: userAgent
    }
  });

  // ログイン履歴を記録
  await prisma.loginHistory.create({
    data: {
      employeeId: onetimeToken.employeeId,
      ipAddress,
      userAgent,
      loginMethod: 'onetime_token',
      success: true
    }
  });

  // 職員情報を返却
  res.json({
    success: true,
    employee: {
      employeeId: onetimeToken.employee.employeeId,
      name: onetimeToken.employee.name,
      email: onetimeToken.employee.email,
      permissionLevel: onetimeToken.employee.permissionLevel,
      accountType: onetimeToken.employee.accountType,
      role: onetimeToken.employee.role,
      department: onetimeToken.employee.department
    }
  });
}
```

---

#### API-3: 従来型認証

**エンドポイント**: `POST /api/v2/auth/authenticate`

**リクエスト**:
```json
{
  "employeeId": "EMP2024123",
  "password": "EMP2024123_InitPass2025"
}
```

**レスポンス**:
```json
{
  "success": true,
  "passwordMustChange": true,
  "employee": {
    "employeeId": "EMP2024123",
    "name": "山田 太郎",
    "email": "yamada.taro@hospital.local",
    "permissionLevel": 3.5,
    "accountType": "STAFF",
    "role": "nurse",
    "department": "外科"
  }
}
```

**実装例**:
```typescript
import bcrypt from 'bcryptjs';

export async function authenticate(req: Request, res: Response) {
  const { employeeId, password } = req.body;

  // アカウントロックチェック（過去30分間に5回以上失敗）
  const failedAttempts = await prisma.loginAttempt.count({
    where: {
      employeeId,
      success: false,
      attemptAt: { gte: new Date(Date.now() - 30 * 60 * 1000) }
    }
  });

  if (failedAttempts >= 5) {
    return res.status(403).json({
      success: false,
      error: 'ACCOUNT_LOCKED',
      message: 'アカウントがロックされています（30分後に再試行してください）'
    });
  }

  // 職員検索
  const employee = await prisma.employee.findUnique({
    where: { employeeId }
  });

  if (!employee || !employee.isActive) {
    // 失敗を記録
    await prisma.loginAttempt.create({
      data: {
        employeeId,
        ipAddress: req.ip,
        success: false
      }
    });

    return res.status(401).json({
      success: false,
      error: 'INVALID_CREDENTIALS',
      message: '職員IDまたはパスワードが正しくありません'
    });
  }

  // パスワード検証
  const passwordMatch = await bcrypt.compare(password, employee.passwordHash);

  if (!passwordMatch) {
    // 失敗を記録
    await prisma.loginAttempt.create({
      data: {
        employeeId,
        ipAddress: req.ip,
        success: false
      }
    });

    return res.status(401).json({
      success: false,
      error: 'INVALID_CREDENTIALS',
      message: '職員IDまたはパスワードが正しくありません'
    });
  }

  // 成功を記録
  await prisma.loginAttempt.create({
    data: {
      employeeId,
      ipAddress: req.ip,
      success: true
    }
  });

  await prisma.loginHistory.create({
    data: {
      employeeId,
      ipAddress: req.ip,
      userAgent: req.headers['user-agent'] || '',
      loginMethod: 'password',
      success: true
    }
  });

  // 認証成功
  res.json({
    success: true,
    passwordMustChange: employee.passwordMustChange,
    employee: {
      employeeId: employee.employeeId,
      name: employee.name,
      email: employee.email,
      permissionLevel: employee.permissionLevel,
      accountType: employee.accountType,
      role: employee.role,
      department: employee.department
    }
  });
}
```

---

#### API-4: パスワード変更

**エンドポイント**: `PUT /api/v2/auth/change-password`

**リクエスト**:
```json
{
  "employeeId": "EMP2024123",
  "currentPassword": "EMP2024123_InitPass2025",
  "newPassword": "MySecurePass123!"
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "パスワードを変更しました"
}
```

**パスワードポリシー**:
- 8文字以上
- 大文字・小文字を含む
- 数字を含む
- 記号を1つ以上含む（推奨）

**実装例**:
```typescript
export async function changePassword(req: Request, res: Response) {
  const { employeeId, currentPassword, newPassword } = req.body;

  // 職員検索
  const employee = await prisma.employee.findUnique({
    where: { employeeId }
  });

  if (!employee) {
    return res.status(404).json({ error: 'EMPLOYEE_NOT_FOUND' });
  }

  // 現在のパスワード検証
  const passwordMatch = await bcrypt.compare(currentPassword, employee.passwordHash);

  if (!passwordMatch) {
    return res.status(401).json({
      success: false,
      error: 'INVALID_CURRENT_PASSWORD',
      message: '現在のパスワードが正しくありません'
    });
  }

  // 新パスワードのポリシー検証
  const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#])[A-Za-z\d@$!%*?&#]{8,}$/;

  if (!passwordRegex.test(newPassword)) {
    return res.status(400).json({
      success: false,
      error: 'WEAK_PASSWORD',
      message: 'パスワードは8文字以上で、大文字・小文字・数字・記号を含む必要があります'
    });
  }

  // 新パスワードをハッシュ化（bcrypt cost=10）
  const newPasswordHash = await bcrypt.hash(newPassword, 10);

  // DBを更新
  await prisma.employee.update({
    where: { employeeId },
    data: {
      passwordHash: newPasswordHash,
      passwordUpdatedAt: new Date(),
      passwordMustChange: false
    }
  });

  res.json({
    success: true,
    message: 'パスワードを変更しました'
  });
}
```

---

### VoiceDrive側API

#### API-5: トークンログイン（VoiceDrive側プロキシ）

**エンドポイント**: `POST /api/auth/verify-onetime-token`

**処理フロー**:
1. リクエストを受信
2. 医療システムの `POST /api/v2/auth/verify-onetime-token` を呼び出し
3. レスポンスを受信
4. Userテーブルを検索/作成
5. セッション作成（30日間有効）
6. クライアントにレスポンス

**実装例**:
```typescript
import axios from 'axios';

export async function verifyOnetimeTokenProxy(req: Request, res: Response) {
  const { token } = req.body;

  try {
    // 医療システムの認証APIを呼び出し
    const authResponse = await axios.post(
      `${process.env.MEDICAL_SYSTEM_API}/api/v2/auth/verify-onetime-token`,
      {
        token,
        ipAddress: req.ip,
        userAgent: req.headers['user-agent']
      }
    );

    if (!authResponse.data.success) {
      return res.status(401).json(authResponse.data);
    }

    const employeeData = authResponse.data.employee;

    // VoiceDriveのUserテーブルを検索または作成
    let user = await prisma.user.findUnique({
      where: { employeeId: employeeData.employeeId }
    });

    if (!user) {
      // 初回ログイン時: Userを作成
      user = await prisma.user.create({
        data: {
          employeeId: employeeData.employeeId,
          name: employeeData.name,
          email: employeeData.email,
          permissionLevel: employeeData.permissionLevel,
          accountType: employeeData.accountType,
          role: employeeData.role,
          lastLoginAt: new Date()
        }
      });
    } else {
      // 既存ユーザー: 最終ログイン日時を更新
      await prisma.user.update({
        where: { id: user.id },
        data: { lastLoginAt: new Date() }
      });
    }

    // セッション作成（30日間有効）
    req.session.userId = user.id;
    req.session.employeeId = user.employeeId;
    req.session.cookie.maxAge = 30 * 24 * 60 * 60 * 1000; // 30日

    await new Promise<void>((resolve, reject) => {
      req.session.save((err) => {
        if (err) reject(err);
        else resolve();
      });
    });

    res.json({
      success: true,
      user: {
        id: user.id,
        employeeId: user.employeeId,
        name: user.name,
        email: user.email,
        permissionLevel: user.permissionLevel,
        accountType: user.accountType,
        role: user.role
      }
    });
  } catch (error) {
    console.error('Token verification failed:', error);
    res.status(500).json({
      success: false,
      error: 'INTERNAL_ERROR',
      message: '認証処理中にエラーが発生しました'
    });
  }
}
```

---

#### API-6: 現在のユーザー取得

**エンドポイント**: `GET /api/auth/me`

**レスポンス**:
```json
{
  "id": "clxyz123abc",
  "employeeId": "EMP2024123",
  "name": "山田 太郎",
  "email": "yamada.taro@hospital.local",
  "permissionLevel": 3.5,
  "accountType": "STAFF",
  "role": "nurse",
  "lastLoginAt": "2025-10-27T10:30:00Z"
}
```

**実装例**:
```typescript
export async function getCurrentUser(req: Request, res: Response) {
  if (!req.session.userId) {
    return res.status(401).json({ error: 'NOT_AUTHENTICATED' });
  }

  const user = await prisma.user.findUnique({
    where: { id: req.session.userId },
    select: {
      id: true,
      employeeId: true,
      name: true,
      email: true,
      permissionLevel: true,
      accountType: true,
      role: true,
      lastLoginAt: true
    }
  });

  if (!user) {
    return res.status(404).json({ error: 'USER_NOT_FOUND' });
  }

  res.json(user);
}
```

---

## 📱 PWA (Progressive Web App) 実装

### manifest.json

**ファイルパス**: `public/manifest.json`

```json
{
  "name": "VoiceDrive - 大原記念病院",
  "short_name": "VoiceDrive",
  "description": "大原記念病院 職員ポータル - 音声投稿システム",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#3b82f6",
  "background_color": "#1f2937",
  "orientation": "portrait-primary",
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "screenshots": [
    {
      "src": "/screenshots/home.png",
      "sizes": "540x720",
      "type": "image/png",
      "form_factor": "narrow"
    },
    {
      "src": "/screenshots/voice-post.png",
      "sizes": "540x720",
      "type": "image/png",
      "form_factor": "narrow"
    }
  ]
}
```

---

### Service Worker

**ファイルパス**: `public/service-worker.js`

```javascript
const CACHE_NAME = 'voicedrive-v1.0.0';
const urlsToCache = [
  '/',
  '/login',
  '/static/css/main.css',
  '/static/js/main.js',
  '/icons/icon-192x192.png',
  '/icons/icon-512x512.png'
];

// インストール時にキャッシュ
self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => cache.addAll(urlsToCache))
  );
});

// リクエスト時にキャッシュを使用
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        // キャッシュがあればそれを返し、なければネットワークから取得
        return response || fetch(event.request);
      })
  );
});

// 古いキャッシュを削除
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          if (cacheName !== CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
```

---

### PWAインストール促進UI

**コンポーネント**: `src/components/PWAInstallPrompt.tsx`

```typescript
import React, { useState, useEffect } from 'react';

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>;
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
}

export const PWAInstallPrompt: React.FC = () => {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [showPrompt, setShowPrompt] = useState(false);

  useEffect(() => {
    const handler = (e: Event) => {
      e.preventDefault();
      setDeferredPrompt(e as BeforeInstallPromptEvent);
      setShowPrompt(true);
    };

    window.addEventListener('beforeinstallprompt', handler);

    return () => {
      window.removeEventListener('beforeinstallprompt', handler);
    };
  }, []);

  const handleInstallClick = async () => {
    if (!deferredPrompt) return;

    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;

    if (outcome === 'accepted') {
      console.log('User accepted the install prompt');
    }

    setDeferredPrompt(null);
    setShowPrompt(false);
  };

  const handleDismiss = () => {
    setShowPrompt(false);
    // 1週間後に再度表示
    localStorage.setItem('pwa-prompt-dismissed', Date.now().toString());
  };

  if (!showPrompt) return null;

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 shadow-lg z-50">
      <div className="max-w-lg mx-auto flex items-center justify-between">
        <div className="flex-1">
          <h3 className="font-bold text-lg mb-1">📱 ホーム画面に追加</h3>
          <p className="text-sm text-blue-100">
            アプリのように使えて、毎回ログイン不要！
          </p>
        </div>
        <div className="flex gap-2 ml-4">
          <button
            onClick={handleDismiss}
            className="px-4 py-2 text-sm text-white hover:bg-blue-800 rounded"
          >
            後で
          </button>
          <button
            onClick={handleInstallClick}
            className="px-4 py-2 text-sm bg-white text-blue-600 font-bold rounded hover:bg-blue-50"
          >
            追加する
          </button>
        </div>
      </div>
    </div>
  );
};
```

---

## 🔒 セキュリティ仕様

### 1. トークンのセキュリティ

**生成方法**:
```typescript
import crypto from 'crypto';

// 暗号学的に安全な64文字のランダム文字列
const token = crypto.randomBytes(32).toString('hex');
```

**特徴**:
- 64文字（256ビット）のエントロピー
- 推測不可能
- 単一使用（`used = true`で無効化）
- 24時間の有効期限

---

### 2. パスワードハッシュ

**方式**: bcrypt (cost factor = 10)

```typescript
import bcrypt from 'bcryptjs';

// ハッシュ化
const passwordHash = await bcrypt.hash(password, 10);

// 検証
const isValid = await bcrypt.compare(inputPassword, passwordHash);
```

---

### 3. セッション管理

**ライブラリ**: `express-session` + `connect-redis`

**設定**:
```typescript
import session from 'express-session';
import RedisStore from 'connect-redis';
import { createClient } from 'redis';

const redisClient = createClient({
  url: process.env.REDIS_URL || 'redis://localhost:6379'
});

await redisClient.connect();

app.use(session({
  store: new RedisStore({ client: redisClient }),
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: process.env.NODE_ENV === 'production', // HTTPS only
    httpOnly: true,                                  // JavaScript経由でアクセス不可
    maxAge: 30 * 24 * 60 * 60 * 1000,               // 30日
    sameSite: 'lax'                                  // CSRF対策
  }
}));
```

---

### 4. CORS設定

**VoiceDrive側**:
```typescript
import cors from 'cors';

app.use(cors({
  origin: process.env.MEDICAL_SYSTEM_URL,  // 医療システムのドメイン
  credentials: true                          // Cookieを含める
}));
```

---

### 5. Rate Limiting

**認証API用**:
```typescript
import rateLimit from 'express-rate-limit';

const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 5,                    // 最大5回
  message: {
    error: 'TOO_MANY_REQUESTS',
    message: 'ログイン試行回数が多すぎます。15分後に再試行してください。'
  },
  standardHeaders: true,
  legacyHeaders: false
});

app.post('/api/auth/login', authLimiter, login);
app.post('/api/auth/verify-onetime-token', authLimiter, verifyOnetimeTokenProxy);
```

---

## 📅 実装スケジュール

### Phase 1: 基盤実装（Week 1-2）

#### 医療システム側（Week 1）
- [ ] **Day 1**: Employeeテーブル拡張（3フィールド追加）
- [ ] **Day 2**: OnetimeTokenテーブル作成
- [ ] **Day 3**: LoginHistoryテーブル作成
- [ ] **Day 4**: LoginAttemptテーブル作成
- [ ] **Day 5**: マイグレーション実行、初期データ投入

#### VoiceDrive側（Week 2）
- [ ] **Day 1-2**: Redisセットアップ、express-session実装
- [ ] **Day 3-4**: useAuthフック実装
- [ ] **Day 5**: GET /api/auth/me 実装

---

### Phase 2: QRコード認証実装（Week 3-4）

#### 医療システム側（Week 3）
- [ ] **Day 1**: POST /api/v2/auth/generate-onetime-token 実装
- [ ] **Day 2**: POST /api/v2/auth/verify-onetime-token 実装
- [ ] **Day 3**: QRコード生成ライブラリ統合（qrcode npm package）
- [ ] **Day 4**: アカウント情報シート印刷機能
- [ ] **Day 5**: 単体テスト

#### VoiceDrive側（Week 4）
- [ ] **Day 1-2**: POST /api/auth/verify-onetime-token プロキシ実装
- [ ] **Day 3**: QRコードログインフロー実装
- [ ] **Day 4-5**: エラーハンドリング、E2Eテスト

---

### Phase 3: PWA実装（Week 5）

#### VoiceDrive側のみ
- [ ] **Day 1**: manifest.json作成、アイコン準備
- [ ] **Day 2**: Service Worker実装
- [ ] **Day 3**: PWAInstallPromptコンポーネント実装
- [ ] **Day 4**: iOS Safari、Android Chrome動作確認
- [ ] **Day 5**: PWA監査（Lighthouse等）

---

### Phase 4: 従来型認証実装（Week 6-7）

#### 医療システム側（Week 6）
- [ ] **Day 1-2**: POST /api/v2/auth/authenticate 実装
- [ ] **Day 3**: PUT /api/v2/auth/change-password 実装
- [ ] **Day 4**: アカウントロックロジック実装
- [ ] **Day 5**: 単体テスト

#### VoiceDrive側（Week 7）
- [ ] **Day 1-2**: ログイン画面実装
- [ ] **Day 3**: パスワード変更画面実装
- [ ] **Day 4**: usePermissionsフック修正
- [ ] **Day 5**: E2Eテスト

---

### Phase 5: 統合テスト（Week 8）

#### 両システム合同
- [ ] **Day 1**: QRコード認証フローE2Eテスト
- [ ] **Day 2**: 従来型認証フローE2Eテスト
- [ ] **Day 3**: セキュリティ監査
- [ ] **Day 4**: パフォーマンステスト
- [ ] **Day 5**: バグ修正

---

### Phase 6: 本番リリース（Week 9）

- [ ] **Day 1**: ステージング環境デプロイ
- [ ] **Day 2-3**: 人事部スタッフによる受け入れテスト
- [ ] **Day 4**: 本番環境デプロイ
- [ ] **Day 5**: 段階的ロールアウト（部署単位）

**合計**: 約9週間（2ヶ月）

---

## 🎯 成功指標（KPI）

### ユーザビリティ

| 指標 | 目標 | 測定方法 |
|-----|------|---------|
| **初回ログイン成功率** | 95%以上 | LoginHistoryテーブル分析 |
| **QRコード利用率** | 70%以上 | loginMethod = 'onetime_token' の割合 |
| **PWAインストール率** | 60%以上 | PWAインストールイベント追跡 |
| **平均ログイン時間（QRコード）** | 30秒以内 | フロントエンド分析 |
| **平均ログイン時間（従来型）** | 2分以内 | フロントエンド分析 |
| **ヘルプデスク問い合わせ件数** | 月10件以下 | ヘルプデスク記録 |

### セキュリティ

| 指標 | 目標 | 測定方法 |
|-----|------|---------|
| **不正ログイン試行検知率** | 100% | LoginAttemptテーブル監視 |
| **アカウントロック発動率** | 1%未満 | LoginAttemptテーブル分析 |
| **QRコード有効期限内使用率** | 98%以上 | OnetimeTokenテーブル分析 |
| **パスワード変更完了率（初回）** | 95%以上 | Employee.passwordMustChange分析 |

### パフォーマンス

| 指標 | 目標 | 測定方法 |
|-----|------|---------|
| **認証API応答時間** | 500ms以内 | APM（Application Performance Monitoring） |
| **QRコード生成時間** | 2秒以内 | API応答時間監視 |
| **PWA起動時間** | 1秒以内 | Lighthouse PWA監査 |

---

## ✅ チェックリスト

### 医療システム側

#### データベース
- [ ] Employeeテーブルに3フィールド追加（passwordHash, passwordUpdatedAt, passwordMustChange）
- [ ] OnetimeTokenテーブル作成
- [ ] LoginHistoryテーブル作成
- [ ] LoginAttemptテーブル作成

#### API実装
- [ ] POST /api/v2/auth/generate-onetime-token
- [ ] POST /api/v2/auth/verify-onetime-token
- [ ] POST /api/v2/auth/authenticate
- [ ] PUT /api/v2/auth/change-password

#### セキュリティ
- [ ] bcrypt統合（cost=10）
- [ ] Rate Limit設定（5 req/15min）
- [ ] アカウントロックロジック（5回失敗で30分）
- [ ] CORS設定

#### 機能実装
- [ ] QRコード生成機能（qrcode npm package）
- [ ] アカウント情報シート印刷機能
- [ ] トークン期限切れ自動削除（cronジョブ）

---

### VoiceDrive側

#### 認証基盤
- [ ] useAuthフック実装
- [ ] express-session + Redis セットアップ
- [ ] GET /api/auth/me 実装
- [ ] POST /api/auth/verify-onetime-token プロキシ
- [ ] POST /api/auth/login プロキシ

#### UI実装
- [ ] QRコードログイン画面
- [ ] 従来型ログイン画面
- [ ] パスワード変更画面
- [ ] PWAインストール促進UI

#### PWA対応
- [ ] manifest.json作成
- [ ] Service Worker実装
- [ ] アイコン準備（8サイズ: 72x72 ~ 512x512）
- [ ] iOS Safari動作確認
- [ ] Android Chrome動作確認

#### フック修正
- [ ] usePermissionsをuseAuthベースに変更
- [ ] デモモード/本番モード切り替え機能

---

### テスト

#### 単体テスト
- [ ] 医療システム: 各API単体テスト
- [ ] VoiceDrive: useAuthフック単体テスト

#### 統合テスト
- [ ] QRコード認証フローE2E
- [ ] 従来型認証フローE2E
- [ ] パスワード変更フローE2E
- [ ] アカウントロックE2E

#### セキュリティテスト
- [ ] SQLインジェクション対策確認
- [ ] XSS対策確認
- [ ] CSRF対策確認
- [ ] Rate Limit動作確認
- [ ] トークン再利用攻撃対策確認

#### ユーザビリティテスト
- [ ] 人事部スタッフによる受け入れテスト
- [ ] 医療職員（高齢者含む）による実地テスト
- [ ] PWAインストールフローのユーザビリティ確認

---

## 📝 補足資料

### 参照ドキュメント

1. **UnauthorizedPage DB要件分析**
   `mcp-shared/docs/UnauthorizedPage_DB要件分析_20251027.md`

2. **UnauthorizedPage 暫定マスターリスト**
   `mcp-shared/docs/UnauthorizedPage暫定マスターリスト_20251027.md`

3. **データ管理責任分界点定義書**
   `mcp-shared/docs/データ管理責任分界点定義書_20251008.md`

---

## 🔄 更新履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2025-10-27 | 初版作成（QRコード + PWA方式採用決定） | VoiceDrive開発チーム |

---

## 📞 連絡先

**VoiceDrive開発チーム**
Email: dev@voicedrive.hospital.local
Slack: #voicedrive-dev

**医療システムチーム**
Email: medical-it@hospital.local
Slack: #medical-system-integration

---

**作成者**: VoiceDrive開発チーム
**承認待ち**: 医療システムチームからの実装可否回答
**次のステップ**: Phase 1（Week 1-2）の着手

---

**文書終了**
