# 投票グループ承認者機能実装 - 医療システム確認回答書

**文書番号**: MS-RESP-2025-1012-003
**作成日**: 2025年10月12日
**作成者**: 医療職員管理システム開発チーム
**宛先**: VoiceDrive開発チーム
**件名**: Re: 投票グループ承認者機能実装完了通知

---

## 📋 エグゼクティブサマリー

VoiceDriveチームの「投票グループ承認者指定機能」実装内容を確認しました。

### ✅ 結論

**医療システム側での対応は不要です。実装内容を全面的に承認します。**

---

## 🎯 確認事項への回答

### ✅ 確認1: 医療システム側での対応は不要か？

**回答**: ✅ **対応不要です**

**理由**:

```yaml
データ管理責任分界点の遵守:
  ✅ 組織の基本情報: 医療システムが管理（部門・施設・職員）
  ✅ 投票運用ルール: VoiceDriveが管理（投票グループ・承認者）

設計原則の遵守:
  ✅ Single Source of Truth:
     - 組織マスター → 医療システム
     - 投票ルール → VoiceDrive
  ✅ Separation of Concerns:
     - 明確な責任分界
     - システム間の疎結合維持

実装影響分析:
  ✅ 医療システムのDBテーブル: 影響なし
  ✅ 医療システムのAPI: 変更不要
  ✅ 既存Phase 3実装: 影響なし
```

**医療システム側で維持する責任範囲**:

| データ項目 | 医療システムの役割 | 変更有無 |
|-----------|------------------|---------|
| **施設マスター** | API提供 | ❌ 変更なし |
| **部門マスター** | API提供 | ❌ 変更なし |
| **職員マスター** | API提供 | ❌ 変更なし |
| **権限レベル** | 計算・提供 | ❌ 変更なし |

**VoiceDrive側で新規に管理する範囲**:

| データ項目 | VoiceDriveの役割 | 医療システムへの影響 |
|-----------|-----------------|-------------------|
| **投票グループ** | マスター管理 | ❌ なし |
| **代表承認者** | 指定・管理 | ❌ なし |
| **ローテーション設定** | 設定・管理 | ❌ なし |

### 補足説明

#### 具体例で理解する責任分界

**ケース**: 診療支援・薬剤・事務グループ（16名）

```
【医療システムの責任】
✅ 田中部長:
   - 所属: 診療支援部
   - 役職: 部長
   - 権限レベル: Level 10
   → API経由でVoiceDriveに提供

✅ 鈴木部長:
   - 所属: 薬剤部
   - 役職: 部長
   - 権限レベル: Level 10
   → API経由でVoiceDriveに提供

✅ 佐藤部長:
   - 所属: 事務部
   - 役職: 部長
   - 権限レベル: Level 10
   → API経由でVoiceDriveに提供

【VoiceDriveの責任】
✅ 投票グループ設定:
   - グループ名: 診療支援・薬剤・事務グループ
   - メンバー部門: 診療支援部・薬剤部・事務部
   - 代表承認者: 田中部長（診療支援部）
   - ローテーション: 月次、3名で順番
   → VoiceDrive内部で管理

✅ 承認権限ロジック:
   - 田中部長（10月）: 承認権限あり ✅
   - 鈴木部長（10月）: 閲覧・助言のみ 👥
   - 佐藤部長（10月）: 閲覧・助言のみ 👥
   - 11月: 鈴木部長に承認権限切替
   → VoiceDrive内部で制御
```

**重要なポイント**:
- 医療システムは「田中・鈴木・佐藤の3名ともLevel 10」という**事実**を提供
- VoiceDriveは「3名の中で田中部長を代表承認者に指定」という**運用ルール**を管理
- 役割分担が明確で混乱なし ✅

---

### ✅ 確認2: データ管理責任の理解は正しいか？

**回答**: ✅ **完全に正しいです**

**データ管理責任マトリクスの承認**:

| データ項目 | 管理責任 | 医療システム側の見解 |
|-----------|---------|-------------------|
| **部門マスター** | 医療システム | ✅ 正しい |
| **職員マスター** | 医療システム | ✅ 正しい |
| **投票グループ** | VoiceDrive | ✅ 正しい |
| **代表承認者** | VoiceDrive | ✅ 正しい |
| **ローテーション設定** | VoiceDrive | ✅ 正しい |

**理由**:

```yaml
設計原則の完全遵守:
  ✅ Single Source of Truth:
     - 組織の真実: 医療システム
     - 投票の真実: VoiceDrive

  ✅ Bounded Context（DDD原則）:
     - 人事管理コンテキスト: 医療システム
     - 投票管理コンテキスト: VoiceDrive
     - 境界が明確

  ✅ Separation of Concerns:
     - 組織構造: 医療システム
     - 投票ルール: VoiceDrive
     - 疎結合維持
```

**データ管理責任分界点定義書の更新承認**:

VoiceDriveチームが更新した以下の内容を**承認**します：

```markdown
### カテゴリ2: 組織情報

| データ項目 | 管理責任 | 連携方法 | 更新頻度 |
|-----------|---------|---------|---------|
| 施設マスター | 医療システム | API | 日次 |
| 部門マスター | 医療システム | API | 日次 |
| **投票グループ** | **VoiceDrive** | **なし** | **手動** |
| **代表承認者** | **VoiceDrive** | **なし** | **手動** |
| **ローテーション設定** | **VoiceDrive** | **なし** | **自動（月次）** |
```

**追加の提案**:

ドキュメントに以下を明記することを推奨します：

```markdown
### データフロー図

医療システム（マスターDB）
  ↓ API提供（日次バッチ）
  ↓ GET /api/v2/departments
  ↓ GET /api/v2/employees
  ↓
VoiceDrive（キャッシュ + 投票ルール）
  ├─ 組織マスター（キャッシュ）
  │   └─ 田中部長: Level 10, 診療支援部
  │       鈴木部長: Level 10, 薬剤部
  │       佐藤部長: Level 10, 事務部
  │
  └─ 投票グループ（独自管理）
      └─ 診療支援・薬剤・事務グループ
          ├─ メンバー部門: [診療支援部, 薬剤部, 事務部]
          ├─ 代表承認者: 田中部長
          └─ ローテーション: 月次、3名順番
```

---

### ✅ 確認3: 共通DB構築時の影響は？

**回答**: ✅ **影響なし、VoiceDrive側の判断で問題ありません**

**共通DB構築時のテーブル配置**:

```sql
-- 医療システム領域
CREATE SCHEMA medical_system;

-- 医療システム管理テーブル
CREATE TABLE medical_system.facilities (...);        -- 施設マスター
CREATE TABLE medical_system.departments (...);       -- 部門マスター
CREATE TABLE medical_system.employees (...);         -- 職員マスター
CREATE TABLE medical_system.position_mappings (...); -- 役職マッピング

-- VoiceDrive領域
CREATE SCHEMA voicedrive;

-- VoiceDrive管理テーブル
CREATE TABLE voicedrive.voting_groups (...);         -- 投票グループ
CREATE TABLE voicedrive.posts (...);                 -- 投稿
CREATE TABLE voicedrive.votes (...);                 -- 投票
CREATE TABLE voicedrive.project_approvals (...);     -- プロジェクト承認

-- 🆕 VoiceDrive投票グループテーブル（新規）
CREATE TABLE voicedrive.voting_groups (
  id VARCHAR(50) PRIMARY KEY,
  group_name VARCHAR(200) NOT NULL,
  facility_id VARCHAR(50) NOT NULL,  -- 医療システムの施設ID参照
  member_department_ids JSON,        -- 医療システムの部門ID配列
  primary_approver_id VARCHAR(50),   -- VoiceDriveのユーザーID
  approver_rotation JSON,
  created_at TIMESTAMP,
  FOREIGN KEY (facility_id) REFERENCES medical_system.facilities(id)
);
```

**テーブル配置の方針**:

| テーブル | 配置スキーマ | 理由 |
|---------|-------------|------|
| **facilities** | `medical_system` | 医療システム管理 |
| **departments** | `medical_system` | 医療システム管理 |
| **employees** | `medical_system` | 医療システム管理 |
| **voting_groups** | `voicedrive` | VoiceDrive管理 |
| **posts** | `voicedrive` | VoiceDrive管理 |
| **votes** | `voicedrive` | VoiceDrive管理 |

**外部キー制約**:

```sql
-- VoiceDriveのテーブルから医療システムのテーブルへの参照
ALTER TABLE voicedrive.voting_groups
  ADD CONSTRAINT fk_voting_groups_facility
  FOREIGN KEY (facility_id)
  REFERENCES medical_system.facilities(id);

-- member_department_idsはJSON配列のため外部キー制約なし
-- アプリケーションレベルでの整合性チェック
```

**API連携の変更**:

| API | 変更有無 | 理由 |
|-----|---------|------|
| GET /api/v2/facilities | ❌ 変更なし | 既存API継続使用 |
| GET /api/v2/departments | ❌ 変更なし | 既存API継続使用 |
| GET /api/v2/employees | ❌ 変更なし | 既存API継続使用 |

**影響分析結果**:

```yaml
医療システム側:
  ✅ テーブル設計: 変更不要
  ✅ API設計: 変更不要
  ✅ 既存実装: 影響なし

VoiceDrive側:
  ✅ 新規テーブル追加: voting_groups拡張
  ✅ アプリケーションロジック: 承認者指定機能
  ✅ 外部キー参照: facility_idのみ

共通DB構築時の作業:
  ✅ 医療システム側: 既存計画通り実装
  ✅ VoiceDrive側: voting_groupsテーブル追加
  ✅ 外部キー制約: 最小限（facility_idのみ）
```

---

## 📊 追加確認事項（医療システム側から）

### ❓ 確認A: 医療システムが提供すべき追加情報はないか？

**回答**: ✅ **現状のAPI提供で十分です**

**VoiceDriveが必要とする情報**:

| 情報 | 現状のAPI | 状態 |
|-----|----------|------|
| 部門一覧 | GET /api/v2/departments | ✅ 提供済み |
| 部門所属職員 | GET /api/v2/departments/{id}/members | 🔜 実装予定 |
| 職員の権限レベル | GET /api/v1/calculate-level | ✅ 提供済み |
| 職員の部門異動 | Webhook: staff.transferred | ✅ 実装済み |

**追加API不要の理由**:

投票グループの承認者指定は**VoiceDrive内部の運用設定**のため、医療システムからの追加データ提供は不要です。

### ❓ 確認B: Level 99での管理画面UIは医療システム側？

**回答**: ❌ **VoiceDrive側で実装**

**理由**:

```yaml
設計原則:
  - 投票グループはVoiceDrive管轄
  - 管理UIもVoiceDrive側で実装
  - Level 99はVoiceDriveにログインして設定

医療システムの役割:
  - Level 99職員のマスターデータ管理
  - Level 99の権限レベル計算
  - Level 99のAPI提供

VoiceDriveの役割:
  - Level 99専用管理画面UI
  - 投票グループCRUD機能
  - 承認者指定UI
```

### ❓ 確認C: ローテーション時の通知は？

**回答**: 💡 **VoiceDrive側で実装推奨**

**提案**:

ローテーションで承認者が変更された際、**VoiceDrive側から医療システムのメール機能を利用**することを推奨します。

**実装案**:

```typescript
// VoiceDrive側
async function rotateApproverAndNotify(votingGroup: VotingGroup) {
  // 承認者ローテーション
  const newGroup = await this.rotateApprover(votingGroup);
  const newApprover = await this.getApproverUser(newGroup.primaryApproverId);

  // 医療システムのメール送信APIを呼び出し
  await fetch(`${MEDICAL_SYSTEM_API}/api/v2/notifications/email`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${JWT_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      to: newApprover.email,
      subject: '【VoiceDrive】投票グループ承認者ローテーション通知',
      body: `
${newApprover.name} 様

今月から「${votingGroup.groupName}」の代表承認者を担当いただきます。

対象グループ: ${votingGroup.groupName}
担当期間: ${new Date().getMonth() + 1}月（月次ローテーション）
承認権限: プロジェクト承認、委員会提出等

VoiceDriveログイン: https://voicedrive.example.com

よろしくお願いいたします。
      `
    })
  });
}
```

**医療システム側で提供すべきAPI**:

```typescript
// POST /api/v2/notifications/email
// 認証: JWT Bearer Token
// 権限: Level 99以上、またはシステム連携用トークン
{
  "to": "tanaka@example.com",
  "subject": "件名",
  "body": "本文",
  "priority": "normal" | "high"
}
```

**実装時期**: 共通DB構築時に検討

---

## ✅ 最終確認結果

### 確認事項への回答まとめ

| 確認事項 | 回答 | 追加対応 |
|---------|------|---------|
| **確認1: 医療システム側対応は不要か？** | ✅ 不要 | なし |
| **確認2: データ管理責任の理解は正しいか？** | ✅ 正しい | なし |
| **確認3: 共通DB構築時の影響は？** | ✅ 影響なし | なし |
| **確認A: 追加API提供は必要か？** | ✅ 不要 | なし |
| **確認B: 管理UIは医療システム側？** | ❌ VoiceDrive側 | なし |
| **確認C: ローテーション通知は？** | 💡 VoiceDrive側 | メールAPI検討 |

### 実装承認

✅ **VoiceDriveチームの実装内容を全面的に承認します**

**承認理由**:
1. データ管理責任分界点の完全遵守
2. 医療システムへの影響ゼロ
3. 設計原則（Single Source of Truth、Separation of Concerns）の遵守
4. テーブル配置・外部キー制約の適切性
5. API連携の変更不要

---

## 📅 次のステップ

### 医療システム側

- ✅ 実装承認完了（本回答書）
- ⏸️ 追加対応不要（待機）
- 🔜 共通DB構築時：既存計画通り実装

### VoiceDrive側

- ✅ 実装完了報告受領確認
- 🔜 共通DB構築時：
  - Level 99管理画面UI実装
  - 自動ローテーションバッチ実装
  - 通知機能実装
  - 監査ログ記録

### 両チーム合同

- ⏸️ 共通DB構築待機
- 🔜 DB構築時：統合テスト実施

---

## 📄 ドキュメント更新

### 更新完了ドキュメント

- ✅ 本回答書（`投票グループ承認者機能_医療システム確認回答_3通目_20251012.md`）

### 更新推奨ドキュメント（VoiceDrive側）

- 📝 `データ管理責任分界点定義書_20251008.md`
  - 投票グループ関連の記載を更新済み（確認済み）

- 📝 `AI_SUMMARY.md`
  - 本回答書の要約を追加推奨

---

## 🎉 まとめ

### 医療システムチームの見解

**VoiceDriveチームの実装は完璧です。全面的に承認します。**

#### 承認理由

1. **データ管理責任が明確**
   - 組織マスター: 医療システム
   - 投票ルール: VoiceDrive
   - 境界線が明確

2. **医療システムへの影響ゼロ**
   - テーブル設計: 変更不要
   - API設計: 変更不要
   - 既存実装: 影響なし

3. **設計原則の完全遵守**
   - Single Source of Truth
   - Separation of Concerns
   - Bounded Context（DDD）

4. **実装品質が高い**
   - ローテーション機能の充実
   - 柔軟な承認者指定
   - 将来的な拡張性確保

### 次のアクション

- ✅ 医療システム側: 追加対応不要
- ⏸️ 両チーム: 共通DB構築待機
- 🔜 共通DB構築後: 統合テスト実施

---

**ご実装お疲れ様でした！**

慎重な設計と明確な責任分界により、両システムの疎結合が維持されています。
共通DB構築時に速やかに統合できる準備が整いました。

---

**作成日**: 2025-10-12
**バージョン**: 1.0
**ステータス**: VoiceDriveチーム提出済み
**回答期限**: 2025年10月15日（火）→ **2025年10月12日に前倒し完了** ✅

**添付資料**:
- [データ管理責任分界点定義書_20251008.md](データ管理責任分界点定義書_20251008.md)
- [組織構造拡張実装_マスタープラン統合回答書_2通目_20251012.md](組織構造拡張実装_マスタープラン統合回答書_2通目_20251012.md)
- [組織情報収集依頼_医療システム返信書_1通目_20251012.md](組織情報収集依頼_医療システム返信書_1通目_20251012.md)
- [医療システムチーム質問回答書_20251012.md](医療システムチーム質問回答書_20251012.md)
