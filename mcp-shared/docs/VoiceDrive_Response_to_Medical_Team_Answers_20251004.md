# VoiceDrive 医療システムチーム様回答への返信

**発信**: VoiceDrive開発チーム
**宛先**: 医療職員管理システム開発チーム
**日時**: 2025年10月4日 01:00
**件名**: 【返信】医療チーム様回答への確認と実装計画

---

## 🙏 ご丁寧な回答ありがとうございます

医療システムチーム様

お世話になっております。VoiceDrive開発チームです。

迅速かつ詳細なご回答、誠にありがとうございます。
ご質問への回答と、追加のご質問への返信をさせていただきます。

---

## 📋 医療チーム様からの追加ご質問への回答

### 質問1: ルーティング問題の解決状況

**回答**: 10月4日中に解決し、夕方17:00までに進捗報告いたします

#### 現状分析
- ✅ Webhookハンドラーの実装は完了
- ✅ 署名検証サービスは正常動作
- 🔧 Express.jsのルーティング設定に問題あり

#### 解決アプローチ（優先順位順）
1. **アプローチA**: 別ファイル（webhookRoutes.ts）のマウント方法を修正
   - 予定時間: 2時間
   - 成功確率: 80%

2. **アプローチB**: apiRoutes.tsへの直接実装（現在の方法）を継続
   - 予定時間: 1時間
   - 成功確率: 95%
   - **現在この方法で実装済み**

3. **アプローチC**: サーバー設定（server.ts）の見直し
   - 予定時間: 3時間
   - 成功確率: 60%

#### タイムライン
```
10月4日 09:00-12:00: デバッグと修正作業
10月4日 13:00-15:00: 動作確認とテスト
10月4日 15:00-17:00: ドキュメント更新と報告書作成
10月4日 17:00: 進捗報告（Slack: #phase2-integration）
```

---

### 質問2: データベース保存処理の詳細

**回答**: 以下の仕様で実装いたします

#### 保存フィールド

**テーブル名**: `ComplianceAcknowledgement`（新規作成）

| フィールド名 | 型 | 説明 | インデックス |
|------------|----|----|------------|
| id | String | 内部ID（CUID） | PRIMARY |
| reportId | String | VoiceDrive通報ID | INDEX |
| caseNumber | String | 医療システムケース番号 | INDEX |
| anonymousId | String | 匿名ID | INDEX |
| severity | String | 緊急度 | - |
| category | String | カテゴリ | - |
| receivedAt | DateTime | 医療システム受信日時 | - |
| estimatedResponseTime | String | 対応予定時間 | - |
| requiresImmediateAction | Boolean | 即時対応フラグ | - |
| currentStatus | String | 現在のステータス | - |
| nextSteps | String? | 次のステップ（任意） | - |
| notificationId | String | 受信通知ID | UNIQUE |
| webhookReceivedAt | DateTime | Webhook受信日時 | INDEX |
| processingTime | Int | 処理時間（ミリ秒） | - |
| createdAt | DateTime | レコード作成日時 | INDEX |
| updatedAt | DateTime | レコード更新日時 | - |

#### 保存期間
**5年間保存**（医療チーム様のご推奨通り）

- 自動削除機能: 5年経過後に自動削除（バッチ処理）
- バックアップ: 月次バックアップを実施
- 監査ログ: 保存・削除操作をすべて監査ログに記録

#### リレーション
```typescript
// 通報レコードとの紐付け
WhistleblowingReport {
  id: string
  acknowledgements: ComplianceAcknowledgement[]
  // ...
}

ComplianceAcknowledgement {
  id: string
  reportId: string
  report: WhistleblowingReport (relation)
  // ...
}
```

#### 実装スケジュール
- 10月4日: Prismaスキーマ定義
- 10月5日: マイグレーション実行
- 10月6日: サービス層実装とテスト

---

### 質問3: 画面表示機能の仕様

**回答**: 以下の2つの画面を実装いたします

#### 3-1. 通報者向け画面（マイレポートページ）

**画面**: `/my-reports`

**表示内容**:
```
┌─────────────────────────────────────────────────┐
│ あなたの通報                                      │
├─────────────────────────────────────────────────┤
│ 📝 通報ID: VD-2025-0123                          │
│ 📅 通報日時: 2025年10月3日 15:30                  │
│ 🏷️ カテゴリ: ハラスメント                         │
│ 📊 ステータス: 受付完了                           │
│                                                  │
│ ✅ 受付確認通知                                   │
│ ┌───────────────────────────────────────────┐   │
│ │ 医療システムケース番号: MED-2025-0123       │   │
│ │ 受付日時: 2025年10月3日 15:31              │   │
│ │ 緊急度: 🔴 Critical                        │   │
│ │ 対応予定: 1時間以内                        │   │
│ │                                            │   │
│ │ 現在の状況:                                │   │
│ │ 受付が完了しました。専門チームが確認中です。 │   │
│ │                                            │   │
│ │ 次のステップ:                              │   │
│ │ • 2営業日以内に調査担当者から連絡          │   │
│ │ • 匿名IDで進捗確認が可能                   │   │
│ └───────────────────────────────────────────┘   │
│                                                  │
│ 📞 匿名ID: ANON-MED-2025-0123                    │
│ ℹ️ この匿名IDで進捗を確認できます                 │
└─────────────────────────────────────────────────┘
```

**UI要件**:
- ✅ 受付確認通知は通報詳細の下に表示
- ✅ 緊急度は色分け表示（Critical=赤、High=オレンジ、Medium=黄、Low=緑）
- ✅ 対応予定時間を明確に表示
- ✅ 匿名IDは常に表示（コピーボタン付き）

#### 3-2. 管理者向け画面（管理ダッシュボード）

**画面**: `/admin/compliance/acknowledgements`

**表示内容**:
```
┌───────────────────────────────────────────────────────────────────────┐
│ コンプライアンス通報 受付確認通知一覧                                    │
├───────────────────────────────────────────────────────────────────────┤
│ 📊 統計                                                                 │
│ • 本日受付: 12件  • 今週受付: 45件  • Critical: 3件                      │
├───────────────────────────────────────────────────────────────────────┤
│ フィルター: [全て▼] [緊急度▼] [カテゴリ▼] [日付範囲▼]  🔍検索        │
├───────────────────────────────────────────────────────────────────────┤
│ ケース番号       │ 通報ID      │ 緊急度 │ 対応予定    │ 受付日時           │
├─────────────────┼────────────┼────────┼────────────┼───────────────────┤
│ MED-2025-0123   │ VD-2025-123│ 🔴 Crit│ 1時間以内   │ 2025-10-03 15:31  │
│ MED-2025-0122   │ VD-2025-122│ 🟠 High│ 当日中      │ 2025-10-03 14:20  │
│ MED-2025-0121   │ VD-2025-121│ 🟡 Med │ 3営業日以内 │ 2025-10-03 10:15  │
│ MED-2025-0120   │ VD-2025-120│ 🟢 Low │ 1週間以内   │ 2025-10-02 16:45  │
└───────────────────────────────────────────────────────────────────────┘
```

**機能要件**:
- ✅ ページネーション（1ページ20件）
- ✅ ソート機能（受付日時、緊急度、ケース番号）
- ✅ フィルター機能（緊急度、カテゴリ、日付範囲）
- ✅ CSV/Excelエクスポート機能
- ✅ 詳細表示（クリックで詳細モーダル表示）

#### 実装スケジュール
- 10月5日: 通報者向け画面実装
- 10月6日: 管理者向け画面実装
- 10月7日: UIテストとブラッシュアップ

---

### 質問4: エンドツーエンドテストの詳細

**回答**: 以下の手順で実施いたします

#### テスト環境
- **VoiceDrive**: http://localhost:3001
- **VoiceDrive API**: http://localhost:3003
- **医療システム**: http://localhost:3002
- **モックWebhook**: http://localhost:3100

#### E2Eテストシナリオ（10月7日実施）

**シナリオ1: 通常フロー（Critical案件）**
```
1. VoiceDriveで通報作成
   → reportId: VD-E2E-001
   → category: harassment
   → severity: critical

2. 医療システムAPI呼び出し
   POST /api/v3/compliance/receive
   → 200 OK
   → caseNumber: MED-E2E-001

3. 医療システムからWebhook送信（1-3秒後）
   POST /api/webhook/compliance/acknowledgement
   → 署名検証: ✅
   → タイムスタンプ検証: ✅
   → ペイロード検証: ✅
   → 200 OK

4. VoiceDrive画面確認
   → マイレポートページで受付確認通知表示: ✅
   → ケース番号表示: MED-E2E-001
   → 緊急度表示: 🔴 Critical
   → 対応予定表示: 1時間以内

5. 管理画面確認
   → 受付確認通知一覧に表示: ✅
   → フィルター動作: ✅
   → ソート動作: ✅
```

**シナリオ2: エラーハンドリング（不正署名）**
```
1. 医療システムから不正署名でWebhook送信
   → 401 Unauthorized
   → エラーログ記録: ✅
   → 医療システムにエラーレスポンス返却: ✅

2. 医療システムがリトライ
   → 5秒後にリトライ（正しい署名）
   → 200 OK
   → 通常フロー継続: ✅
```

**シナリオ3: タイムスタンプ期限切れ**
```
1. 医療システムから古いタイムスタンプでWebhook送信
   → タイムスタンプ: 10分前
   → 401 Unauthorized (TIMESTAMP_EXPIRED)
   → エラーログ記録: ✅

2. 医療システムがリトライ
   → 15秒後にリトライ（新しいタイムスタンプ）
   → 200 OK
   → 通常フロー継続: ✅
```

#### テスト自動化
- ✅ Playwrightを使用したE2Eテスト自動化
- ✅ テストレポート自動生成
- ✅ スクリーンショット自動保存

#### テスト実施時間
```
10月7日
09:00-10:00: テスト環境セットアップ
10:00-12:00: E2Eテストシナリオ1-3実施
13:00-15:00: 10件のテストケース実施
15:00-17:00: 結果レポート作成
17:00: 医療チーム様へ報告
```

---

## 📊 統合テスト準備状況の更新

### VoiceDrive側 🔧 実装進捗

| 項目 | 状態 | 予定完了日 |
|------|------|-----------|
| ルーティング問題解決 | 🔧 作業中 | 10月4日 |
| データベーススキーマ | 📝 設計完了 | 10月4日 |
| データベース保存処理 | 📅 未着手 | 10月5-6日 |
| 通報者向け画面 | 📅 未着手 | 10月5日 |
| 管理者向け画面 | 📅 未着手 | 10月6日 |
| エンドツーエンドテスト | 📅 未着手 | 10月7日 |

### 残タスク詳細

**10月4日（本日）**
- [x] データベーススキーマ設計（回答書作成で完了）
- [ ] ルーティング問題解決（進行中）
- [ ] Prismaマイグレーション準備

**10月5日**
- [ ] Prismaマイグレーション実行
- [ ] データベース保存サービス実装
- [ ] 通報者向け画面実装

**10月6日**
- [ ] 管理者向け画面実装
- [ ] UIテスト実施
- [ ] パフォーマンステスト

**10月7日**
- [ ] エンドツーエンドテスト実施
- [ ] 10件のテストケース実施
- [ ] テスト結果レポート作成

**10月8日 09:00-09:30（統合テスト前）**
- [ ] システム起動確認
- [ ] Webhookエンドポイント稼働確認
- [ ] 環境変数確認

---

## ✅ 医療チーム様からのご提案への同意事項

### デプロイスケジュール
✅ **完全に同意いたします**

| 日付 | 内容 |
|------|------|
| 10月8日 | 統合テスト実施・合格 |
| 10月9日 | 統合テスト結果レビュー・最終調整 |
| 10月10日 | 本番環境デプロイ（段階的リリース） |

### 段階的リリース計画
✅ **完全に同意いたします**

```
10月10日 09:00: カナリアリリース（10%）
          ↓ 2時間監視
10月10日 11:00: 50%のトラフィック
          ↓ 3時間監視
10月10日 14:00: 100%のトラフィック
          ↓ 継続監視
```

### 監視項目
✅ **以下の項目を監視いたします**

**VoiceDrive側監視項目**:
1. Webhook受信成功率（目標: 95%以上）
2. 署名検証成功率（目標: 99%以上）
3. レスポンスタイム（目標: 500ms以内）
4. データベース保存成功率（目標: 99.9%以上）
5. エラー発生率（目標: 5%以下）

**アラート設定**:
- Webhook受信失敗が5分間で5件以上 → Slack通知
- 署名検証失敗が10分間で10件以上 → 緊急アラート
- レスポンスタイムが1秒超過 → 警告通知
- データベース保存失敗 → 即座にアラート

---

## 📞 緊急連絡体制

### VoiceDrive側緊急連絡先

**統合テスト期間中（10月8日）**
- 📱 プロジェクトリード: [社内連絡先]
- 📱 技術リード: [社内連絡先]
- 📧 Email: voicedrive-dev@example.com
- 💬 Slack: #phase2-integration （常時監視）

**本番環境デプロイ時（10月10日）**
- 🚨 オンコール体制: 24時間対応
- 📱 緊急連絡先: [社内連絡先]（24時間対応）
- 📧 緊急Email: emergency@voicedrive.ai

### ロールバック基準

以下の場合、即座にロールバックを実施します:

1. **クリティカル**:
   - Webhook受信失敗率が20%を超過
   - システムダウン
   - データ消失

2. **重大**:
   - 署名検証失敗率が10%を超過
   - レスポンスタイムが3秒を超過
   - データベース保存失敗率が5%を超過

**ロールバック実行時間**: 5分以内

---

## 🎯 統合テスト合格基準の確認

医療チーム様のご提案に**完全に同意**いたします。

### 合格基準
✅ **10テストケース中 8件以上成功（80%以上）**

### テストケース別重要度の理解

**必須成功（6ケース）**:
- ⭐ TC-001（Critical案件）
- ⭐ TC-002（High案件）
- ⭐ TC-005（不正署名）
- ⭐ TC-007（バリデーションエラー）
- ⭐ TC-009（バッチ処理）
- ⭐ TC-010（ステータス確認）

**成功推奨（4ケース）**:
- TC-003（Medium案件）
- TC-004（Low案件）
- TC-006（ネットワークエラー）
- TC-008（タイムアウト）

### VoiceDrive側の目標
🎯 **10テストケース中 10件成功（100%）を目指します**

---

## 📝 次のアクション

### 今日（10月4日）
- [x] 医療チーム様への返信書作成（完了）
- [ ] ルーティング問題解決（17:00まで）
- [ ] 進捗報告（17:00、Slack）
- [ ] Prismaスキーマ定義

### 明日以降
- **10月5日**: データベース実装 + 通報者向け画面
- **10月6日**: 管理者向け画面 + UIテスト
- **10月7日**: E2Eテスト + テストケース10件実施 + 結果報告（17:00）
- **10月8日 09:30**: 統合テスト準備完了報告

---

## 💬 追加のご質問・ご確認

医療チーム様へ追加でご確認させていただきたい点がございます。

### 質問1: 本番環境URLの確認
統合テスト後の本番環境デプロイに向けて、以下をご確認させてください。

**VoiceDrive側Webhookエンドポイント（本番）**:
- 予定URL: `https://voicedrive.ai/api/webhook/compliance/acknowledgement`
- IP制限: 不要（署名検証で対応）

**医療システム側送信元（本番）**:
- URL: `https://medical.system.jp`
- IPアドレス: （ファイアウォール設定用）

### 質問2: シークレットキーの受け渡し方法
本番環境用のWebhookシークレットキーの受け渡し方法について、以下のいずれかをご希望でしょうか？

1. **PGP暗号化メール**（推奨）
2. **社内セキュアファイル共有**
3. **対面での受け渡し**（統合テスト時）
4. **その他の方法**

### 質問3: 監査ログの保存期間
医療システム側の監査ログ保存期間に合わせたいと考えております。

- VoiceDrive側の提案: 5年間
- 医療システム側の保存期間: ？

### 質問4: 障害発生時の報告フロー
本番環境で障害が発生した場合の報告フローをご確認させてください。

**VoiceDrive側の提案**:
1. 障害検知（自動監視）
2. 即座にSlack通知（#phase2-integration）
3. 15分以内に影響範囲評価
4. 30分以内に医療チーム様へ第一報
5. 1時間ごとに進捗報告

---

## 🙏 結びに

医療チーム様からの詳細かつ丁寧なご回答、本当にありがとうございます。

ご提供いただいた情報をもとに、VoiceDrive側の実装を着実に進めてまいります。

10月8日の統合テストに向けて、全力で準備を進めさせていただきます。

引き続き、よろしくお願いいたします。

---

**VoiceDrive開発チーム**
**2025年10月4日 01:00**

**次回報告**: 10月4日 17:00（ルーティング問題解決状況）
