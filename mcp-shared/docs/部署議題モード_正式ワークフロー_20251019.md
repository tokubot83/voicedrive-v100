# 部署議題モード 正式ワークフロー
作成日: 2025年10月19日

## ユーザー確認による正式なワークフロー

### 部署検討（30点到達）時のフロー

#### ステップ1: 30点到達
```
投稿スコアが30点に到達
↓
【自動処理】
- 議題レベル: DEPT_REVIEW に自動昇格
- 投稿ステータス: 'under_dept_review' (部署検討中)
```

#### ステップ2: 通知送信（情報共有のみ）
```
【通知先1】投稿者本人
  タイトル: 「投稿が30点に到達しました」
  メッセージ: 「あなたの投稿が30点を突破し、部署内で本格的な検討が始まりました。
              50点に達すると主任の判断対象になります。」
  アクション: [投稿詳細を見る]

【通知先2】主任（Level 3.5）
  タイトル: 「📋 部署内で注目されている投稿があります」
  メッセージ: 「『夜勤看護師3名体制の提案』が30点を突破しました。

              50点に達すると、あなたの承認/却下判断が必要になります。
              事前に内容を確認しておくことをお勧めします。」
  アクション: [投稿詳細を見る]

【通知先3】師長（Level 7）
  タイトル: 「📋 部署内で注目されている投稿があります」
  メッセージ: 「『夜勤看護師3名体制の提案』が30点を突破しました。

              50点に達すると主任の推薦対象になり、その後あなたの最終判断が必要になります。
              事前に内容を確認しておくことをお勧めします。」
  アクション: [投稿詳細を見る]
```

**重要**: 30点段階では承認/却下の判断は不要。情報共有のみ。

---

### 部署議題（50-99点）到達時のフロー

#### ステップ1: 50点到達
```
投稿スコアが50点に到達
↓
【自動処理】
- 議題レベル: DEPT_AGENDA に自動昇格
- 投稿ステータス: 'pending_supervisor_review' (主任の判断待ち)
```

#### ステップ2: 通知送信（主任への通知）
```
【通知先1】投稿者本人
  タイトル: 「投稿が50点に到達しました」
  メッセージ: 「あなたの投稿が50点を突破し、部署議題候補になりました。
              主任の判断をお待ちください。」
  アクション: なし（待機のみ）

【通知先2】主任（Level 3.5）
  タイトル: 「部署議題の承認/却下をお願いします」
  メッセージ: 「『夜勤看護師3名体制の提案』が50点を突破しました。
              部署議題として師長に推薦するか、却下するかを判断してください。」
  アクション: [承認/却下画面を開く]
```

#### ステップ3: 主任の判断（2つの選択肢）

##### 選択肢A: 却下ボタンを押す
```
主任が却下理由を入力して却下
↓
【自動処理】
- 投稿ステータス: 'rejected_by_supervisor'
- 投稿を非公開化（投稿者のみ閲覧可能）
- 投票終了

【通知】投稿者に通知
  タイトル: 「投稿が却下されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は主任により却下されました。

              却下理由:
              現在の人員配置では実現が困難です。来年度の予算編成時に再検討します。」

→ 投稿はここで終了（再投稿は可能）
```

##### 選択肢B: 師長に推薦ボタンを押す
```
主任が「師長に推薦」ボタンを押す
↓
【自動処理】
- 投稿ステータス: 'recommended_to_manager' (師長の判断待ち)
- ProposalDocument自動生成（下書き）

【通知1】投稿者に通知
  タイトル: 「主任が師長に推薦しました」
  メッセージ: 「『夜勤看護師3名体制の提案』が主任により師長に推薦されました。
              師長の判断をお待ちください。」

【通知2】師長（Level 7）に通知
  タイトル: 「部署議題の承認依頼」
  メッセージ: 「主任が『夜勤看護師3名体制の提案』を部署議題として推薦しました。
              部署議題として承認するか、施設議題に昇格するか、却下するかを判断してください。」
  アクション: [承認/昇格/却下画面を開く]
```

#### ステップ4: 師長の判断（3つの選択肢）

##### 選択肢A: 却下ボタンを押す
```
師長が却下理由を入力して却下
↓
【自動処理】
- 投稿ステータス: 'rejected_by_manager'
- 投稿を非公開化（投稿者のみ閲覧可能）
- 投票終了

【通知1】投稿者に通知
  タイトル: 「投稿が却下されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は師長により却下されました。

              却下理由:
              現在の予算状況では実現困難です。」

【通知2】主任に通知（情報共有）
  タイトル: 「推薦した議題が却下されました」
  メッセージ: 「あなたが推薦した『夜勤看護師3名体制の提案』が師長により却下されました。」

→ 投稿はここで終了
```

##### 選択肢B: 部署議題として承認ボタンを押す
```
師長が承認ボタンを押す
↓
【画面遷移】議題提案書編集画面に遷移
  - 自動生成されたProposalDocumentを編集
  - 師長が背景・期待効果・実施方針を記入
  - 保存ボタンを押す

【自動処理】
- 投稿ステータス: 'approved_as_dept_agenda'
- 投票は継続（100点を目指す）
- 投稿範囲: 部署内のまま（50-99点のため）

【通知1】投稿者に通知
  タイトル: 「部署議題として承認されました」
  メッセージ: 「『夜勤看護師3名体制の提案』が師長により部署議題として承認されました。

              師長コメント:
              夜勤帯の安全確保のため、3名体制を試験的に導入します。
              次回の部署ミーティングで詳細を議論します。」
  アクション: [議題詳細を見る]

【通知2】主任に通知
  タイトル: 「推薦した議題が承認されました」
  メッセージ: 「あなたが推薦した『夜勤看護師3名体制の提案』が師長により承認されました。」

【通知3】所属部署職員全員に通知
  タイトル: 「部署議題が正式決定しました」
  メッセージ: 「『夜勤看護師3名体制の提案』が部署の正式議題になりました。

              師長コメント:
              夜勤帯の安全確保のため、3名体制を試験的に導入します。
              次回の部署ミーティングで詳細を議論します。」
  アクション: [議題詳細を見る]
```

##### 選択肢C: 施設議題に昇格ボタンを押す
```
師長が「施設議題に昇格」ボタンを押す
↓
【自動処理】
- 議題レベル: FACILITY_AGENDA に強制昇格（スコア50点でも）
- 投稿公開範囲: 施設内全職員に拡大
- 投票範囲: 施設内全職員に拡大
- 投票期限: 規定に基づき再設定（例: 7日間）
- 投稿ステータス: 'pending_deputy_director_review'
- ProposalDocument自動生成（施設レベル用）

【通知1】投稿者に通知
  タイトル: 「施設議題に昇格しました」
  メッセージ: 「『夜勤看護師3名体制の提案』が師長の判断により施設議題に昇格しました。
              施設内全職員が投票できるようになりました。
              副看護部長/看護部長の承認をお待ちください。」

【通知2】主任に通知
  タイトル: 「推薦した議題が施設議題に昇格しました」
  メッセージ: 「あなたが推薦した『夜勤看護師3名体制の提案』が師長により施設議題に昇格しました。」

【通知3】副看護部長/看護部長（Level 8）に通知
  タイトル: 「施設議題の承認依頼」
  メッセージ: 「師長が『夜勤看護師3名体制の提案』を施設議題に昇格しました。
              委員会提出の承認/却下を判断してください。」
  アクション: [承認/却下画面を開く]

【通知4】施設内全職員に通知（オプション）
  タイトル: 「新しい施設議題」
  メッセージ: 「『夜勤看護師3名体制の提案』が施設議題になりました。
              投票期限: 2025年10月26日まで」
  アクション: [投票する]

→ 施設議題フローに移行（100点到達時と同様）
```

#### ステップ5: 投票期限到達（100点未達の場合）

##### ケース: スコアが100点に達せず投票期限終了
```
投票期限到達（例: 85点で終了）
  ↓
スコアが100点未満
  ↓
【自動処理】
- 投稿ステータス: 'facility_vote_expired_pending_manager_decision'
- 投票を一時停止

【通知】師長（Level 7）に通知
  タイトル: 「⚠️ 施設議題の投票期限が終了しました」
  メッセージ: 「『夜勤看護師3名体制の提案』の投票期限が終了しました。

              最終スコア: 85点（目標: 100点）
              施設内投票数: 42票

              このまま部署議題として承認するか、却下するかを判断してください。」
  アクション: [部署議題承認/却下画面を開く]
```

##### 選択肢A: 部署議題として承認
```
師長が「部署議題として承認」ボタンを押す
  ↓
【自動処理】
- 議題レベル: FACILITY_AGENDA → DEPT_AGENDA に降格
- 投稿公開範囲: 施設内 → 部署内に縮小
- 投稿ステータス: 'downgraded_to_dept_agenda'
- 投票は終了（再投票なし）

【通知1】部署内全員に通知
  タイトル: 「部署議題として承認されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は施設議題として100点には達しませんでしたが、
              師長により部署議題として承認されました。

              師長コメント:
              施設全体での合意には至りませんでしたが、当部署では必要性が高いため、
              部署独自の取り組みとして進めます。

              最終スコア: 85点
              次回の部署ミーティングで詳細を議論します。」
  アクション: [議題詳細を見る]

【通知2】他部署職員（施設内の部署外職員）に通知
  タイトル: 「施設議題が部署議題になりました」
  メッセージ: 「『夜勤看護師3名体制の提案』は100点に達しなかったため、
              医療療養病棟の部署議題として進められることになりました。

              ご投票ありがとうございました。」

【通知3】投稿者に通知
  タイトル: 「部署議題として承認されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は師長により部署議題として承認されました。

              師長コメント:
              施設全体での合意には至りませんでしたが、当部署では必要性が高いため、
              部署独自の取り組みとして進めます。」

【通知4】主任に通知（情報共有）
  タイトル: 「推薦した議題が部署議題として承認されました」
  メッセージ: 「あなたが推薦した『夜勤看護師3名体制の提案』が師長により部署議題として承認されました。」
```

##### 選択肢B: 却下
```
師長が却下理由を入力して却下
  ↓
【自動処理】
- 投稿ステータス: 'rejected_by_manager_after_facility_vote'
- 投稿を非公開化（投稿者のみ閲覧可能）
- 投票終了

【通知1】施設内全職員に通知
  タイトル: 「施設議題が却下されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は師長により却下されました。

              却下理由:
              施設全体での支持が十分に得られず（最終スコア: 85点/100点）、
              現時点での実施は困難と判断しました。
              将来的な再検討の余地はあります。

              ご投票ありがとうございました。」

【通知2】投稿者に通知
  タイトル: 「投稿が却下されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は師長により却下されました。

              却下理由:
              施設全体での支持が十分に得られず（最終スコア: 85点/100点）、
              現時点での実施は困難と判断しました。
              将来的な再検討の余地はあります。

              ご提案ありがとうございました。」

【通知3】主任に通知（情報共有）
  タイトル: 「推薦した議題が却下されました」
  メッセージ: 「あなたが推薦した『夜勤看護師3名体制の提案』が師長により却下されました。」

→ 投稿はここで終了
```

#### 補足: 追加検討事項

##### 検討1: 投票期限延長オプション
```
現状: 師長の選択肢は「部署議題承認」または「却下」の2択

検討案: 第3の選択肢「投票期限延長」を追加

例: 85点で「あと少し！」という場合
  ↓
師長が「+3日間延長」ボタンを押す
  ↓
【自動処理】
- 投票期限を延長（+3日間）
- 投稿ステータス: 'facility_vote_extended'

【通知】施設内全職員に通知
  タイトル: 「⏰ 投票期限が延長されました」
  メッセージ: 「『夜勤看護師3名体制の提案』の投票期限を3日間延長しました。

              現在のスコア: 85点
              目標: 100点（残り15点）

              引き続きご投票をお願いします。」
  アクション: [投票する]

延長後も100点未達
  ↓
再度、師長に通知 → 「部署議題承認」または「却下」を判断

メリット: 85点と95点では扱いが変わるべき（ギリギリの場合に救済）
デメリット: 延長しすぎると投票疲れ、延長回数の上限設定が必要
```

##### 検討2: 却下時の「再提案の目安」を示す
```
現状: 却下理由のみ記入

検討案: 却下理由 + 改善アドバイス

例:
却下理由:
「施設全体での支持が十分に得られず（最終スコア: 85点/100点）、
現時点での実施は困難と判断しました。」

改善アドバイス:
「次回再提案する際は以下の点を改善すると支持が得られやすいでしょう：
- コスト試算を明確にする
- 他部署への影響を分析する
- 段階的な導入計画を提示する」

メリット: 投稿者が学び、次回の改善に繋がる（建設的なフィードバック）
デメリット: 師長の入力負担が増える
```

##### 検討3: 部署議題承認時の「スコア内訳表示」
```
現状: 最終スコアのみ表示

検討案: 部署内スコアと他部署スコアを分けて表示

例:
部署内通知:
「最終スコア: 85点
  └ 部署内: 52点（賛成率: 87%）
  └ 他部署: 33点（賛成率: 45%）

当部署では高い支持が得られました。部署独自の取り組みとして進めます。」

他部署通知:
「最終スコア: 85点
施設全体での合意には至りませんでしたが、医療療養病棟では高い支持があったため、
部署議題として進められることになりました。」

メリット: 部署内の支持が高かったことを可視化、部署職員の士気維持
デメリット: スコア計算の複雑化
```

##### 検討4: 100点未達時の自動処理タイミング
```
現状案: 投票期限終了 → 即座に師長に通知 → 師長が判断

検討案A: 猶予期間を設ける
投票期限終了（85点）
  ↓
【自動処理】24時間の猶予期間
  ↓
猶予期間中に100点到達 → 通常フローへ
猶予期間終了 → 師長に通知

検討案B: スコアによって自動判定
90点以上: 自動的に投票期限延長（+3日）
70-89点: 師長の判断を仰ぐ
70点未満: 自動的に却下

メリット: 師長の判断負担を軽減
デメリット: 機械的な判定になる（柔軟性が失われる）
```

---

## 施設議題（100点到達）時のフロー

#### ステップ1: 100点到達
```
投稿スコアが100点に到達
↓
【自動処理】
- 議題レベル: FACILITY_AGENDA に自動昇格
- 投稿公開範囲: 施設内全職員に拡大
- 投票範囲: 施設内全職員に拡大
- ProposalDocument自動生成
- 投稿ステータス: 'pending_deputy_director_review'
```

#### ステップ2: 通知送信
```
【通知先1】投稿者本人
  タイトル: 「投稿が100点に到達しました」
  メッセージ: 「あなたの投稿が100点を突破し、施設議題になりました。
              副看護部長/看護部長の判断をお待ちください。」

【通知先2】副看護部長/看護部長（Level 8）
  タイトル: 「施設議題の承認/却下をお願いします」
  メッセージ: 「『夜勤看護師3名体制の提案』が100点を突破しました。
              委員会提出の承認/却下を判断してください。」
  アクション: [承認/却下画面を開く]

【通知先3】委員会メンバー（Level 10+）（オプション）
  タイトル: 「新しい施設議題」
  メッセージ: 「『夜勤看護師3名体制の提案』が施設議題になりました。」
```

#### ステップ3: 副看護部長/看護部長の判断（2つの選択肢）

##### 選択肢A: 却下
```
Level 8が却下理由を入力して却下
↓
【自動処理】
- 投稿ステータス: 'rejected_by_deputy_director'
- 投稿を非公開化（投稿者のみ閲覧可能）
- 投票終了

【通知】投稿者に通知
  タイトル: 「投稿が却下されました」
  メッセージ: 「『夜勤看護師3名体制の提案』は副看護部長により却下されました。

              却下理由:
              現在の予算状況では実現困難です。」

→ 投稿はここで終了
```

##### 選択肢B: 承認（委員会提出）
```
Level 8が承認ボタンを押す
↓
【自動処理】
- 投稿ステータス: 'approved_for_committee'
- 委員会に正式提出

【通知1】投稿者に通知
  タイトル: 「委員会に提出されました」
  メッセージ: 「『夜勤看護師3名体制の提案』が委員会に正式提出されました。
              委員会での審議をお待ちください。」

【通知2】委員会メンバー（Level 10+）全員に通知
  タイトル: 「新しい議題が提出されました」
  メッセージ: 「『夜勤看護師3名体制の提案』が委員会に提出されました。
              次回委員会で審議します。」
  アクション: [議題詳細を見る]

→ 委員会審議フローに移行
```

---

## 投稿の表示状態まとめ

| ステータス | 表示範囲 | 投票可否 | 備考 |
|---|---|---|---|
| `active` (0-29点) | 部署内のみ | 可能 | 通常の投稿 |
| `active` (30-49点) | 部署内のみ | 可能 | 部署検討中 |
| `pending_supervisor_review` (50-99点) | 部署内のみ | 可能 | 主任の判断待ち |
| `approved_as_dept_agenda` (50-99点) | 部署内のみ | 可能 | 部署議題として承認済み |
| `rejected_by_supervisor` | 投稿者のみ | 不可 | 主任が却下（終了） |
| `pending_deputy_director_review` (100点以上) | 施設内全職員 | 可能 | Level 8の判断待ち |
| `approved_for_committee` (100点以上) | 施設内全職員 | 不可 | 委員会提出済み |
| `rejected_by_deputy_director` | 投稿者のみ | 不可 | Level 8が却下（終了） |

---

## 主任の承認画面イメージ

### URL
`/proposal-management/review/{postId}`

### 画面構成
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
部署議題 承認/却下
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【投稿内容】
タイトル: 夜勤看護師3名体制の提案
投稿者: 田中花子（医療療養病棟・看護師）
現在スコア: 52点
投票数: 賛成 15票、中立 3票、反対 2票

【投稿内容詳細】
現在、夜勤帯は看護師2名体制ですが、患者急変時の対応が困難です...

【主任の判断】

┌─────────────────┐
│ [✅ 部署議題として承認]  │ ← クリックで議題提案書作成画面へ
└─────────────────┘

┌─────────────────┐
│ [⬆️ 施設議題に昇格]      │ ← クリックで施設議題に強制昇格
└─────────────────┘

┌─────────────────┐
│ [❌ 却下]                │ ← クリックで却下理由入力ダイアログ
└─────────────────┘
```

---

## 必要な実装

### 1. 投稿ステータスの追加（Prisma Schema）
```prisma
enum PostStatus {
  ACTIVE                           // 通常
  PENDING_SUPERVISOR_REVIEW        // 主任の判断待ち (50点)
  APPROVED_AS_DEPT_AGENDA          // 部署議題承認済み
  REJECTED_BY_SUPERVISOR           // 主任が却下
  PENDING_DEPUTY_DIRECTOR_REVIEW   // Level 8の判断待ち (100点)
  APPROVED_FOR_COMMITTEE           // 委員会提出済み
  REJECTED_BY_DEPUTY_DIRECTOR      // Level 8が却下
  CLOSED                           // 終了
}
```

### 2. 主任承認画面の実装
- `/proposal-management/review/{postId}`
- 3つのボタン: 承認 / 施設昇格 / 却下

### 3. 通知サービスの実装
- AgendaLevelNotificationService の拡張
- 6つの通知パターン実装

### 4. ProposalDocument自動生成
- 50点到達時: 主任承認後に生成
- 100点到達時: 自動生成

### 5. 投稿公開範囲の動的変更
- 施設昇格ボタン押下時: 部署内 → 施設内に拡大
- 100点到達時: 自動的に施設内に拡大

---

## 次のステップ

ユーザー確認:
1. このワークフローで正しいですか？
2. 主任の承認画面の3つのボタンで問題ないですか？
3. 通知内容は適切ですか？

確認後、実装を開始します。
