# ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é€šå ± Webhookèªè¨¼ä»•æ§˜æ›¸ï¼ˆHMAC-SHA256ï¼‰

**ç™ºä¿¡**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**å®›å…ˆ**: VoiceDriveãƒãƒ¼ãƒ 
**æ—¥æ™‚**: 2025å¹´10æœˆ3æ—¥
**ä»¶å**: Webhookèªè¨¼æ–¹å¼ã®è©³ç´°ä»•æ§˜
**é‡è¦åº¦**: ğŸ”´ **å¿…é ˆå®Ÿè£…**

---

## ğŸ“‹ æ¦‚è¦

åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰VoiceDriveã¸é€ä¿¡ã™ã‚‹ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é€šå ±å—ä»˜ç¢ºèªé€šçŸ¥ã®Webhookèªè¨¼æ–¹å¼ã«ã¤ã„ã¦ã€HMAC-SHA256ã‚’ä½¿ç”¨ã—ãŸç½²åæ¤œè¨¼ã®è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ” èªè¨¼æ–¹å¼: HMAC-SHA256

### ãªãœHMAC-SHA256ã‚’ä½¿ç”¨ã™ã‚‹ã®ã‹

1. **æ”¹ã–ã‚“æ¤œçŸ¥**: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ä¿è¨¼
2. **é€ä¿¡å…ƒèªè¨¼**: æ­£å½“ãªé€ä¿¡å…ƒï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼
3. **ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‹’å¦
4. **æ¥­ç•Œæ¨™æº–**: GitHubã€Stripeã€Slackãªã©å¤šãã®ã‚µãƒ¼ãƒ“ã‚¹ã§æ¡ç”¨

---

## ğŸ”§ å®Ÿè£…è©³ç´°

### 1. å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼

**ç’°å¢ƒå¤‰æ•°**:
```bash
# åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´
VOICEDRIVE_WEBHOOK_SECRET=your-secret-key-here-min-32-chars

# VoiceDriveå´
MEDICAL_SYSTEM_WEBHOOK_SECRET=your-secret-key-here-min-32-chars
```

**ã‚­ãƒ¼è¦ä»¶**:
- æœ€ä½32æ–‡å­—ä»¥ä¸Š
- ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ï¼ˆè‹±æ•°å­— + è¨˜å·ï¼‰
- æœ¬ç•ªç’°å¢ƒã¨ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ç•°ãªã‚‹ã‚­ãƒ¼ã‚’ä½¿ç”¨
- å®šæœŸçš„ãªãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¨å¥¨: 90æ—¥ã”ã¨ï¼‰

**ã‚­ãƒ¼ç”Ÿæˆä¾‹**:
```bash
# OpenSSLã§ç”Ÿæˆ
openssl rand -hex 32

# Node.jsã§ç”Ÿæˆ
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# å‡ºåŠ›ä¾‹
# a7f3c9e1b2d8f4a6c9e7b3f1d4a8c2e6f9b7d3a1c5e8f2b6d9a4c7e1f3b8d2a6
```

---

### 2. ç½²åç”Ÿæˆï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ï¼‰

#### 2.1 TypeScript/Node.jså®Ÿè£…

```typescript
import crypto from 'crypto';

// ç½²åç”Ÿæˆé–¢æ•°
function generateWebhookSignature(payload: any, secret: string): string {
  const payloadString = JSON.stringify(payload);

  return crypto
    .createHmac('sha256', secret)
    .update(payloadString)
    .digest('hex');
}

// ä½¿ç”¨ä¾‹
const notificationData = {
  reportId: "VD-2025-1234",
  caseNumber: "MED-2025-0001",
  anonymousId: "ANON-5678",
  // ... ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
};

const secret = process.env.VOICEDRIVE_WEBHOOK_SECRET;
const signature = generateWebhookSignature(notificationData, secret);

// HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
await fetch('https://voicedrive.example.com/api/webhook/compliance/acknowledgement', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Webhook-Signature': signature,
    'X-Webhook-Timestamp': new Date().toISOString(),
    'X-Case-Number': notificationData.caseNumber,
    'X-Anonymous-Id': notificationData.anonymousId,
  },
  body: JSON.stringify(notificationData)
});
```

#### 2.2 ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°

```typescript
// ã‚¹ãƒ†ãƒƒãƒ—1: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’JSONæ–‡å­—åˆ—ã«å¤‰æ›
const payloadString = JSON.stringify(payload);
// ä¾‹: '{"reportId":"VD-2025-1234","caseNumber":"MED-2025-0001",...}'

// ã‚¹ãƒ†ãƒƒãƒ—2: HMAC-SHA256ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
const hmac = crypto.createHmac('sha256', secret);

// ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
hmac.update(payloadString);

// ã‚¹ãƒ†ãƒƒãƒ—4: 16é€²æ•°æ–‡å­—åˆ—ã¨ã—ã¦ç½²åã‚’å–å¾—
const signature = hmac.digest('hex');
// ä¾‹: 'a3f7c9e1b2d8f4a6c9e7b3f1d4a8c2e6f9b7d3a1c5e8f2b6d9a4c7e1f3b8d2a6'
```

---

### 3. ç½²åæ¤œè¨¼ï¼ˆVoiceDriveå´ï¼‰

#### 3.1 TypeScript/Node.jså®Ÿè£…

```typescript
import crypto from 'crypto';

// ç½²åæ¤œè¨¼é–¢æ•°
function verifyWebhookSignature(
  receivedSignature: string,
  payload: any,
  secret: string
): boolean {
  // å—ä¿¡ã—ãŸãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰æœŸå¾…ã•ã‚Œã‚‹ç½²åã‚’ç”Ÿæˆ
  const payloadString = JSON.stringify(payload);
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payloadString)
    .digest('hex');

  // ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ããŸã‚ã€crypto.timingSafeEqualã‚’ä½¿ç”¨
  try {
    const receivedBuffer = Buffer.from(receivedSignature, 'hex');
    const expectedBuffer = Buffer.from(expectedSignature, 'hex');

    return crypto.timingSafeEqual(receivedBuffer, expectedBuffer);
  } catch (error) {
    // é•·ã•ãŒç•°ãªã‚‹å ´åˆãªã©ã¯falseã‚’è¿”ã™
    return false;
  }
}

// Expressã§ã®ä½¿ç”¨ä¾‹
app.post('/api/webhook/compliance/acknowledgement', (req, res) => {
  const receivedSignature = req.headers['x-webhook-signature'] as string;
  const secret = process.env.MEDICAL_SYSTEM_WEBHOOK_SECRET;

  // ç½²åæ¤œè¨¼
  if (!verifyWebhookSignature(receivedSignature, req.body, secret)) {
    return res.status(401).json({
      success: false,
      error: {
        code: 'INVALID_SIGNATURE',
        message: 'Webhook signature verification failed'
      }
    });
  }

  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã ãŒæ¨å¥¨ï¼‰
  const timestamp = req.headers['x-webhook-timestamp'] as string;
  if (!verifyTimestamp(timestamp)) {
    return res.status(401).json({
      success: false,
      error: {
        code: 'TIMESTAMP_EXPIRED',
        message: 'Webhook timestamp is too old'
      }
    });
  }

  // æ­£å¸¸å‡¦ç†
  // ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã€é€šçŸ¥é€ä¿¡ãªã©

  res.status(200).json({
    success: true,
    notificationId: 'NOTIF-12345',
    receivedAt: new Date().toISOString()
  });
});

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼é–¢æ•°ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–ï¼‰
function verifyTimestamp(timestamp: string, maxAgeMinutes: number = 5): boolean {
  try {
    const receivedTime = new Date(timestamp).getTime();
    const currentTime = Date.now();
    const ageMinutes = (currentTime - receivedTime) / 1000 / 60;

    // 5åˆ†ä»¥ä¸Šå¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯æ‹’å¦
    return ageMinutes <= maxAgeMinutes;
  } catch (error) {
    return false;
  }
}
```

#### 3.2 æ¤œè¨¼ãƒ•ãƒ­ãƒ¼

```
1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
   â†“
2. X-Webhook-Signature ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—
   â†“
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆJSONï¼‰ã‹ã‚‰æœŸå¾…ã•ã‚Œã‚‹ç½²åã‚’è¨ˆç®—
   â†“
4. å—ä¿¡ã—ãŸç½²åã¨è¨ˆç®—ã—ãŸç½²åã‚’æ¯”è¼ƒï¼ˆcrypto.timingSafeEqualä½¿ç”¨ï¼‰
   â†“
5a. ä¸€è‡´ â†’ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ã¸
5b. ä¸ä¸€è‡´ â†’ 401 Unauthorizedè¿”å´
   â†“
6. X-Webhook-Timestamp ãŒ5åˆ†ä»¥å†…ã‹ç¢ºèª
   â†“
7a. 5åˆ†ä»¥å†… â†’ æ­£å¸¸å‡¦ç†
7b. 5åˆ†è¶…é â†’ 401 Unauthorizedè¿”å´
```

---

## ğŸ“¨ HTTPãƒ˜ãƒƒãƒ€ãƒ¼ä»•æ§˜

### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰VoiceDriveã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```http
POST /api/webhook/compliance/acknowledgement HTTP/1.1
Host: voicedrive.example.com
Content-Type: application/json
X-Webhook-Signature: a3f7c9e1b2d8f4a6c9e7b3f1d4a8c2e6f9b7d3a1c5e8f2b6d9a4c7e1f3b8d2a6
X-Webhook-Timestamp: 2025-10-03T10:30:00.000Z
X-Case-Number: MED-2025-0001
X-Anonymous-Id: ANON-5678
X-Request-Id: req-uuid-12345

{
  "reportId": "VD-2025-1234",
  "caseNumber": "MED-2025-0001",
  "anonymousId": "ANON-5678",
  ...
}
```

### ãƒ˜ãƒƒãƒ€ãƒ¼è©³ç´°

| ãƒ˜ãƒƒãƒ€ãƒ¼ | å¿…é ˆ | èª¬æ˜ | ä¾‹ |
|---------|------|------|-----|
| `Content-Type` | âœ… | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ | `application/json` |
| `X-Webhook-Signature` | âœ… | HMAC-SHA256ç½²åï¼ˆ16é€²æ•°ï¼‰ | `a3f7c9e1...` |
| `X-Webhook-Timestamp` | âœ… | ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”Ÿæˆæ—¥æ™‚ï¼ˆISO 8601ï¼‰ | `2025-10-03T10:30:00.000Z` |
| `X-Case-Number` | âœ… | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‚±ãƒ¼ã‚¹ç•ªå· | `MED-2025-0001` |
| `X-Anonymous-Id` | âœ… | åŒ¿åID | `ANON-5678` |
| `X-Request-Id` | æ¨å¥¨ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡ç”¨UUID | `req-uuid-12345` |

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ­£å¸¸ãªç½²åæ¤œè¨¼

**ã‚·ãƒŠãƒªã‚ª**: æ­£ã—ã„ç½²åã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã‚‹

```typescript
// ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
const testPayload = {
  reportId: "VD-TEST-001",
  caseNumber: "MED-2025-0001",
  anonymousId: "ANON-TEST-001",
  severity: "high",
  category: "ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ",
  receivedAt: "2025-10-03T10:00:00.000Z",
  estimatedResponseTime: "å½“æ—¥ä¸­"
};

const testSecret = "test-secret-key-for-development-use-only-32chars";

// ç½²åç”Ÿæˆ
const signature = crypto
  .createHmac('sha256', testSecret)
  .update(JSON.stringify(testPayload))
  .digest('hex');

// æœŸå¾…çµæœ
// - ç½²åæ¤œè¨¼: âœ… æˆåŠŸ
// - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 200 OK
// - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: { success: true, ... }
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ä¸æ­£ãªç½²å

**ã‚·ãƒŠãƒªã‚ª**: èª¤ã£ãŸç½²åãŒé€ä¿¡ã•ã‚Œã‚‹

```typescript
const testPayload = { /* åŒä¸Š */ };
const wrongSignature = "0000000000000000000000000000000000000000000000000000000000000000";

// æœŸå¾…çµæœ
// - ç½²åæ¤œè¨¼: âŒ å¤±æ•—
// - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized
// - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: { success: false, error: { code: "INVALID_SIGNATURE", ... } }
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ”¹ã–ã‚“æ¤œçŸ¥

**ã‚·ãƒŠãƒªã‚ª**: ç½²åã¯æ­£ã—ã„ãŒã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ã‚‹

```typescript
const originalPayload = {
  reportId: "VD-TEST-001",
  caseNumber: "MED-2025-0001",
  severity: "medium"
};

// æ­£ã—ã„ç½²åã‚’ç”Ÿæˆ
const validSignature = generateWebhookSignature(originalPayload, testSecret);

// ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ”¹ã–ã‚“
const tamperedPayload = {
  ...originalPayload,
  severity: "critical" // æ”¹ã–ã‚“
};

// æœŸå¾…çµæœ
// - ç½²åæ¤œè¨¼: âŒ å¤±æ•—ï¼ˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
// - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: å¤ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒï¼‰

**ã‚·ãƒŠãƒªã‚ª**: 6åˆ†å‰ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŒã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```typescript
const testPayload = { /* åŒä¸Š */ };
const validSignature = generateWebhookSignature(testPayload, testSecret);
const oldTimestamp = new Date(Date.now() - 6 * 60 * 1000).toISOString(); // 6åˆ†å‰

// æœŸå¾…çµæœ
// - ç½²åæ¤œè¨¼: âœ… æˆåŠŸ
// - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼: âŒ å¤±æ•—ï¼ˆ5åˆ†è¶…éï¼‰
// - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized
// - ãƒ¬ã‚¹ãƒãƒ³ã‚¹: { success: false, error: { code: "TIMESTAMP_EXPIRED", ... } }
```

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: æœªæ¥ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

**ã‚·ãƒŠãƒªã‚ª**: æœªæ¥ã®æ™‚åˆ»ã‚’æŒã¤ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

```typescript
const futureTimestamp = new Date(Date.now() + 10 * 60 * 1000).toISOString(); // 10åˆ†å¾Œ

// æœŸå¾…çµæœ
// - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼: âŒ å¤±æ•—
// - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 401 Unauthorized
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–

**å•é¡Œ**: å˜ç´”ãªæ–‡å­—åˆ—æ¯”è¼ƒï¼ˆ`signature1 === signature2`ï¼‰ã¯ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã«è„†å¼±

**å¯¾ç­–**: `crypto.timingSafeEqual()` ã‚’ä½¿ç”¨

```typescript
// âŒ è„†å¼±ãªã‚³ãƒ¼ãƒ‰
if (receivedSignature === expectedSignature) {
  // å‡¦ç†
}

// âœ… å®‰å…¨ãªã‚³ãƒ¼ãƒ‰
const receivedBuffer = Buffer.from(receivedSignature, 'hex');
const expectedBuffer = Buffer.from(expectedSignature, 'hex');

if (crypto.timingSafeEqual(receivedBuffer, expectedBuffer)) {
  // å‡¦ç†
}
```

### 2. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®ç®¡ç†

**DO**:
- âœ… ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- âœ… å®šæœŸçš„ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ90æ—¥æ¨å¥¨ï¼‰
- âœ… æœ¬ç•ªã¨ãƒ†ã‚¹ãƒˆã§ç•°ãªã‚‹ã‚­ãƒ¼ã‚’ä½¿ç”¨
- âœ… æœ€ä½32æ–‡å­—ä»¥ä¸Šã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—

**DON'T**:
- âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
- âŒ GitHubãªã©ã«ã‚³ãƒŸãƒƒãƒˆ
- âŒ çŸ­ã„ã‚­ãƒ¼ï¼ˆ< 32æ–‡å­—ï¼‰
- âŒ äºˆæ¸¬å¯èƒ½ãªæ–‡å­—åˆ—ï¼ˆ"password"ãªã©ï¼‰

### 3. ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–

**å®Ÿè£…**:
```typescript
function verifyTimestamp(timestamp: string): boolean {
  const receivedTime = new Date(timestamp).getTime();
  const currentTime = Date.now();
  const ageMinutes = Math.abs(currentTime - receivedTime) / 1000 / 60;

  // å‰å¾Œ5åˆ†ä»¥å†…ã®ã¿è¨±å¯
  return ageMinutes <= 5;
}
```

### 4. ãƒ­ã‚°è¨˜éŒ²

**è¨˜éŒ²ã™ã¹ãæƒ…å ±**:
```typescript
// æˆåŠŸæ™‚
logger.info('Webhook received', {
  requestId: req.headers['x-request-id'],
  caseNumber: req.headers['x-case-number'],
  anonymousId: req.headers['x-anonymous-id'],
  timestamp: req.headers['x-webhook-timestamp'],
  signatureValid: true
});

// å¤±æ•—æ™‚
logger.warn('Webhook signature verification failed', {
  requestId: req.headers['x-request-id'],
  ipAddress: req.ip,
  timestamp: req.headers['x-webhook-timestamp'],
  reason: 'INVALID_SIGNATURE'
});
```

**è¨˜éŒ²ã—ã¦ã¯ã„ã‘ãªã„æƒ…å ±**:
- âŒ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼
- âŒ å®Œå…¨ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆå€‹äººæƒ…å ±ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
- âŒ ç½²åã®å®Œå…¨ãªå€¤ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–ã—ãŸã‚‚ã®ãªã‚‰å¯ï¼‰

---

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼1: ç½²åæ¤œè¨¼ãŒå¸¸ã«å¤±æ•—ã™ã‚‹

**åŸå› **:
1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®ä¸ä¸€è‡´
2. ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®JSONæ–‡å­—åˆ—åŒ–ã®é †åºãŒç•°ãªã‚‹
3. æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å•é¡Œ

**è§£æ±ºæ–¹æ³•**:
```typescript
// ãƒ‡ãƒãƒƒã‚°ç”¨: ä¸¡ã‚·ã‚¹ãƒ†ãƒ ã§åŒã˜ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã‚­ãƒ¼ã§ç½²åã‚’ç”Ÿæˆã—ã€æ¯”è¼ƒ
const payload = { test: "data" };
const secret = "test-secret";

// åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´
const medicalSignature = crypto.createHmac('sha256', secret)
  .update(JSON.stringify(payload))
  .digest('hex');
console.log('Medical System Signature:', medicalSignature);

// VoiceDriveå´
const voicedriveSignature = crypto.createHmac('sha256', secret)
  .update(JSON.stringify(payload))
  .digest('hex');
console.log('VoiceDrive Signature:', voicedriveSignature);

// ä¸¡è€…ãŒä¸€è‡´ã™ã‚Œã°ã€å®Ÿè£…ã¯æ­£ã—ã„
```

### ã‚¨ãƒ©ãƒ¼2: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ãŒå¤±æ•—ã™ã‚‹

**åŸå› **:
- ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒ­ãƒƒã‚¯ã®ãšã‚Œ
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å•é¡Œ

**è§£æ±ºæ–¹æ³•**:
```typescript
// ä¸¡ã‚·ã‚¹ãƒ†ãƒ ã®ç¾åœ¨æ™‚åˆ»ã‚’ç¢ºèª
console.log('Current Time:', new Date().toISOString());

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¨±å®¹ç¯„å›²ã‚’åºƒã’ã‚‹ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
const maxAgeMinutes = process.env.NODE_ENV === 'production' ? 5 : 15;
```

---

## ğŸ“¦ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´
- [x] ç½²åç”Ÿæˆé–¢æ•°ã®å®Ÿè£…
- [x] Webhookãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡å‡¦ç†
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
- [x] ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

### VoiceDriveå´
- [ ] ç½²åæ¤œè¨¼é–¢æ•°ã®å®Ÿè£…
- [ ] ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ã®å®Ÿè£…
- [ ] Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å®Ÿè£…
- [ ] ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

---

## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯

### å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Node.js Crypto HMAC](https://nodejs.org/api/crypto.html#crypto_class_hmac)
- [MDN: HMAC](https://developer.mozilla.org/en-US/docs/Glossary/HMAC)

### å®Ÿä¾‹
- [GitHub Webhooks](https://docs.github.com/en/developers/webhooks-and-events/webhooks/securing-your-webhooks)
- [Stripe Webhooks](https://stripe.com/docs/webhooks/signatures)
- [Slack Webhooks](https://api.slack.com/authentication/verifying-requests-from-slack)

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

æŠ€è¡“çš„ãªè³ªå•ã‚„Webhookå®Ÿè£…ã«é–¢ã™ã‚‹ç›¸è«‡ã¯ã€mcp-shared/ãƒ•ã‚©ãƒ«ãƒ€çµŒç”±ã§ã”é€£çµ¡ãã ã•ã„ã€‚

---

**ä½œæˆæ—¥æ™‚**: 2025å¹´10æœˆ3æ—¥
**ä½œæˆè€…**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0

---

*æœ¬ä»•æ§˜æ›¸ã¯ã€ã‚»ã‚­ãƒ¥ã‚¢ãªWebhooké€šä¿¡ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æŠ€è¡“ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚*
