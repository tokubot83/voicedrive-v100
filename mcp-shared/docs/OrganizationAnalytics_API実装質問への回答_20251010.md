# OrganizationAnalytics API実装 質問への回答

**回答日**: 2025年10月10日
**回答者**: VoiceDriveチーム
**文書番号**: VD-A-2025-1010-006
**関連文書**: MED-Q-2025-1010-005（医療システムからの質問書）

---

## 質問-1-A: Phase 1実装（雇用形態区別なし）でOKか？
[X] 選択肢A: Phase 1実装でOK
[ ] 選択肢B: Phase 2実装が必須
[ ] 選択肢C: 暫定的にPosition判定
[ ] その他:

**補足コメント**:
Phase 1実装（全職員をカウント）で問題ありません。OrganizationAnalyticsページの目的は「組織全体の声の活性度」を可視化することであり、雇用形態による精緻な区別は現時点では必須ではありません。

**理由**:
1. **声の活性度**: 派遣職員・外部委託職員も「組織の一員」として声を上げる対象
2. **参加率**: 全職員の参加状況を把握することが重要
3. **優先度**: DB構築フェーズでは基本機能実装を優先し、細かい区別は将来対応

Phase 2（employmentType追加）は、将来的に「正社員のみのエンゲージメント指標」が必要になった際に検討します。

---

## 質問-1-B: Phase 2の優先度と実装時期
[ ] 選択肢A: 即座に実装（API実装前）
[ ] 選択肢B: Phase 1実装後に実装
[X] 選択肢C: 将来実装（時期未定）
[ ] その他:

**補足コメント**:
将来実装（時期未定）とします。Phase 1で運用を開始し、実際の使用状況を見て必要性を判断します。

**判断基準**:
- OrganizationAnalyticsページの利用者（経営層・施設長）から「雇用形態別の分析が必要」という要望が出た場合に実装
- 当面は「共通DB構築後統合作業再開計画書」のPhase 2完了を優先

**実装時期の目安**:
- 早くても2025年11月以降（Phase 1-3完了後）
- VoiceDrive側からの明確な要望があった時点で再検討

---

## 質問-2-A: isActiveフィールドは必要か？
[X] 選択肢A: 不要（全部門を有効とみなす）
[ ] 選択肢B: 必要（フィールド追加してほしい）
[ ] 選択肢C: 将来的に必要（Phase 2で追加）
[ ] その他:

**補足コメント**:
isActiveフィールドは不要です。現実的に部門が無効化されるケース（統廃合等）は稀であり、発生した場合は以下の運用で対応可能です：

**代替案**:
- 統廃合された部門は`name`フィールドに「（廃止）」等の接頭辞を付ける
- または、統廃合された部門のデータを削除せず、`updatedAt`を見て古いデータを判別

将来的に部門管理が複雑化した際に、isActiveフィールドの追加を検討します。

---

## 質問-3-A: API-1のレスポンス構造でOKか？
[X] このレスポンス構造でOK（変更不要）
[ ] 以下の変更をお願いします:
    - フィールド名変更:
    - フィールド追加:
    - フィールド削除:

**補足コメント**:
提案いただいたレスポンス構造で問題ありません。すべてのフィールドが適切です。

**各フィールドの使用目的**:
- `departmentCode`: 部門の一意識別子として使用
- `facilityName`: UI表示で使用（「立神リハビリテーション温泉病院 > 医療療養病棟」）
- `employeeCount`: 部門別の職員数を表示
- `retrievedAt`: キャッシュ管理とデバッグ用

---

## 質問-3-B: API-2のレスポンス構造でOKか？
[X] このレスポンス構造でOK（変更不要）
[ ] 以下の変更をお願いします:
    - byFacilityのキー: [X] facilityId [ ] facilityCode [ ] facilityName
    - byDepartmentのキー: [X] departmentId [ ] departmentCode [ ] departmentName
    - limitations: [X] 必要 [ ] 不要

**補足コメント**:
提案いただいたレスポンス構造で問題ありません。

**キー名について**:
- **byFacility**: `facilityId`（例: "tategami-hospital"）をキーとして使用
  - 理由: VoiceDrive側のPost.facilityIdと一致させるため
- **byDepartment**: `departmentName`（例: "医療療養病棟"）をキーとして使用
  - 理由: UI表示でそのまま使用でき、マッピング処理が不要
- **limitations**: 必要
  - 理由: API利用者（VoiceDrive開発チーム）がPhase 1の制約を理解できる

**ただし、質問書のレスポンス例で既に正しい形式になっているため、変更不要です。**

---

## 質問-4-A: エラーレスポンス構造でOKか？
[X] このエラーレスポンス構造でOK
[ ] 変更希望:

**補足コメント**:
提案いただいたエラーレスポンス構造は完璧です。すべてのエラーケースを網羅しており、VoiceDrive側でのエラーハンドリングが容易です。

**特に評価する点**:
1. **統一された構造**: `error.code`, `error.message`, `error.timestamp`が共通
2. **詳細情報**: `details`配列でフィールド別のエラーを返す（バリデーションエラー）
3. **デバッグ情報**: `requestId`でサーバーログとの紐付けが可能

---

## 質問-5-A: 認証方式の選択
[X] 提案B: API Key認証
    - APIキー発行方法: 医療システム側で発行し、環境変数で共有

[ ] 提案A: JWT Bearer Token認証
    - JWT署名キー:
    - トークンペイロード構造:

[ ] 提案C: OAuth 2.0 Client Credentials
    - クライアントID/シークレット発行方法:

[ ] その他:

**補足コメント**:
**提案B: API Key認証**を採用します。

**理由**:
1. **シンプル**: VoiceDrive⇔医療システム間の固定的な統合には、API Keyが最もシンプル
2. **実装工数**: JWT/OAuth 2.0と比較して実装・運用が容易
3. **セキュリティ**: HTTPS通信前提であれば、API Keyで十分なセキュリティレベル

**APIキー発行・共有方法**:
1. 医療システム側でVoiceDrive用APIキーを発行（例: `vd-med-integration-key-12345`）
2. Slackの非公開チャンネル（#medical-voicedrive-integration-private）で共有
3. VoiceDrive側で環境変数`MEDICAL_SYSTEM_API_KEY`に設定
4. 医療システム側で環境変数`VOICEDRIVE_API_KEY`としてホワイトリスト管理

**リクエスト例**:
```http
GET /api/v2/departments
X-API-Key: vd-med-integration-key-12345
```

**ヘッダー名**: `X-API-Key`で統一

---

## 質問-5-B: Rate Limitの実装方式
[X] この仕様でOK
[ ] Rate Limitの数値を変更: req/min
[ ] Rate Limit不要
[ ] その他:

**補足コメント**:
提案いただいた仕様（100 req/min/IP）で問題ありません。

**VoiceDrive側の使用想定**:
- OrganizationAnalyticsページ: 1ページ表示あたり2 API呼び出し（部門マスタ、職員総数）
- アクセス頻度: 10-20ユーザー/時間（経営層・施設長のみ）
- 最大負荷: 40 req/時間 = 0.67 req/分

**結論**: 100 req/minは十分な余裕があります。

**レスポンスヘッダーの追加要望**:
可能であれば、以下のヘッダーを追加していただけると、VoiceDrive側でのRate Limit管理が容易になります：
```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1696934460
```

---

## 総合コメント

### 1. 実装スケジュール
医療システムチームの提案する**パターンA: Phase 1実装のみ（2.5日）**で進めてください。

**希望スケジュール**:
| 日付 | 作業内容 |
|------|---------|
| 10/14（月） | API-1（部門マスタ）、API-2（職員総数）実装 |
| 10/15（火） | 単体テスト、API仕様書更新 |
| 10/16（水） | 統合テスト |

### 2. 統合テストの準備
VoiceDrive側は以下を準備します：
- [ ] MEDICAL_SYSTEM_API_URL環境変数設定
- [ ] MEDICAL_SYSTEM_API_KEY環境変数設定
- [ ] OrganizationAnalyticsService.tsのテストコード作成
- [ ] テスト用の施設ID・部門IDリスト準備

### 3. API仕様書の共有
統合テスト前に、以下の情報を共有してください：
- [ ] API-1, API-2のエンドポイントURL（例: `https://medical.example.com/api/v2/departments`）
- [ ] VoiceDrive用APIキー
- [ ] テスト環境のベースURL（本番環境と異なる場合）

### 4. その他の要望
特にありません。医療システムチームの提案は非常に詳細かつ実装可能な内容であり、すべて承認します。

### 5. 懸念事項
なし。Phase 1実装でOrganizationAnalyticsページの基本機能は十分に動作します。

---

## 次のアクション

### VoiceDriveチーム側
1. **10/11（金）**: この回答書を医療システムチームに共有
2. **10/12-13（土日）**: （週末）
3. **10/14（月）**: 医療システムAPIの実装状況確認
4. **10/15（火）**: VoiceDrive側の統合準備（環境変数設定、テストコード作成）
5. **10/16（水）**: 統合テスト実施

### 医療システムチーム側
1. **10/11（金）**: 回答確認、実装方針確定
2. **10/14（月）**: API実装開始
3. **10/15（火）**: 単体テスト、API仕様書共有
4. **10/16（水）**: 統合テスト協力

---

## 承認

**VoiceDriveチーム**: 本回答書の内容をすべて承認します。

**署名**: VoiceDrive開発チーム
**日付**: 2025年10月10日

---

## 関連ドキュメント

1. [MED-Q-2025-1010-005: 医療システムからの質問書](./組織分析ページ_医療システムからの質問書.md)
2. [organization-analytics_医療システム確認結果_20251010.md](./organization-analytics_医療システム確認結果_20251010.md)
3. [organization-analytics_医療システム連携要件確認書_20251010.md](./organization-analytics_医療システム連携要件確認書_20251010.md)
4. [共通DB構築後統合作業再開計画書_20251008.md](./共通DB構築後統合作業再開計画書_20251008.md)

---

**文書終了**

最終更新: 2025年10月10日
バージョン: 1.0
次回アクション: 医療システムチームへの共有（10/11）→ API実装開始（10/14）
