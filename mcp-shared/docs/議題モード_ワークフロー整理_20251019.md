# 議題モード ワークフロー整理
作成日: 2025年10月19日

## ユーザーの懸念点
「部署議題になったらそこで公開もストップでは？」
「主任が部署議題 夜勤３名 良かったから再投稿でもしたの?」
「主任の議題化は誰に届くの?」
「部署検討は関係者に通知がイクの?」

## 現在の実装状況まとめ

### 1. スコアによる自動レベル判定（実装済み）

`AgendaLevelEngine.ts` で以下の閾値で **自動的にレベルが変わる**:

| スコア範囲 | 議題レベル | 説明 |
|---|---|---|
| 0-29点 | PENDING | 検討中 |
| 30-49点 | DEPT_REVIEW | 部署検討 |
| 50-99点 | DEPT_AGENDA | 部署議題 |
| 100-299点 | FACILITY_AGENDA | 施設議題 |
| 300-599点 | CORP_REVIEW | 法人検討 |
| 600点以上 | CORP_AGENDA | 法人議題 |

**重要**: スコアが閾値を超えると **自動的に** レベルが昇格する。主任が手動で「昇格ボタン」を押す仕組みは**現在実装されていない**。

---

### 2. 閲覧範囲・投票範囲の制御（実装済み）

`AgendaLevelEngine.ts` で以下のように範囲が制限される:

#### PENDING（0-29点）
- **閲覧**: 投稿者の部署内のみ + 管理職（Level 8+）は閲覧可能
- **投票**: 投稿者の部署内のみ
- **コメント**: 投稿者の部署内のみ

#### DEPT_REVIEW・DEPT_AGENDA（30-99点）
- **閲覧**: 部署内全員 + 管理職は施設内閲覧可能
- **投票**: **部署内のみ**
- **コメント**: **部署内のみ**

#### FACILITY_AGENDA（100-299点）
- **閲覧**: **全職員（他施設からも閲覧可能）**
- **投票**: 施設内全員
- **コメント**: 施設内全員

#### CORP_REVIEW・CORP_AGENDA（300点以上）
- **閲覧**: 法人内全員
- **投票**: 法人内全員
- **コメント**: 法人内全員

**結論**:
- 部署議題（50-99点）では **投票は部署内のみ** に制限される
- 100点に達すると **施設全体に公開される**

---

### 3. 通知の実装状況

#### 実装済みの通知メッセージ（`AgendaModeNotifications.ts`）

通知メッセージの**テンプレート**は以下の通り実装済み:

| トリガー | 通知内容 |
|---|---|
| 30点到達（DEPT_REVIEW） | 「部署検討が開始されました」 |
| 50点到達（DEPT_AGENDA） | 「部署議題に昇格しました」 |
| 100点到達（FACILITY_AGENDA） | 「委員会提出レベルに到達！」 |
| 300点到達（CORP_REVIEW） | 「法人レベルの検討開始」 |
| 600点到達（CORP_AGENDA） | 「理事会提出レベルに到達！」 |

#### ⚠️ 未実装の部分

**通知の送信先が不明確**:
- 30点到達時: **誰に通知が届く？**（主任？部署全員？）
- 50点到達時: **誰に通知が届く？**（師長？主任？）
- 100点到達時: **誰に通知が届く？**（施設長？委員会メンバー？）

**通知の送信処理が未実装**:
- `ProposalEscalationEngine.ts` の398行目:
  ```typescript
  console.log('[ProposalEscalation]', JSON.stringify(notification, null, 2));
  // 関係者へのメール/Slack通知
  // await this.notificationService.send(notification);
  ```
  → **コメントアウトされている = 実際には通知が送られていない**

---

### 4. ProposalDocument（議題提案書）の生成タイミング

`ProposalDocumentGenerator.ts` を確認する必要があるが、現在の理解では:

#### 想定される生成タイミング
- **100点到達時**: 施設議題になったタイミングで自動生成
- Level 3.5+（主任・副主任）が編集可能

#### 不明確な点
- **50点到達時（部署議題）でも生成される？**
- **誰が編集権限を持つ？**（主任のみ？師長も？）

---

## 具体的なワークフローの疑問点

### 医療療養病棟の例

#### ケース: 夜勤看護師3名体制の提案

**ステップ1: 投稿（0点）**
- 看護師Aが投稿
- 閲覧: 医療療養病棟内のみ
- 投票: 医療療養病棟内のみ

**ステップ2: 30点到達（DEPT_REVIEW）**
- スコアが自動的にDEPT_REVIEWに変わる
- 閲覧: 医療療養病棟内 + 管理職は施設内閲覧可能
- 投票: 医療療養病棟内のみ
- **❓ 通知は誰に届く？** → **不明**

**ステップ3: 50点到達（DEPT_AGENDA）**
- スコアが自動的にDEPT_AGENDAに変わる
- 閲覧: 医療療養病棟内 + 管理職は施設内閲覧可能
- 投票: **医療療養病棟内のみ（他部署は投票不可）**
- **❓ 通知は誰に届く？** → **不明**
- **❓ ProposalDocumentは生成される？** → **不明**
- **❓ 主任が何かアクションを取る必要がある？** → **不明**

**ステップ4: 100点到達（FACILITY_AGENDA）**
- スコアが自動的にFACILITY_AGENDAに変わる
- 閲覧: **施設内全職員（他部署も閲覧可能になる）**
- 投票: 施設内全員
- **❓ 通知は誰に届く？** → **不明**
- **ProposalDocumentが自動生成される**（想定）
- Level 3.5+（主任・副主任）が編集可能

**ステップ5: 委員会提出リクエスト**
- Level 7+（師長）が「委員会提出リクエスト」ボタンを押す
- `CommitteeSubmissionService.createSubmissionRequest()` が実行される
- **⚠️ ここで通知が送られるはずだが、実装されていない**（console.logのみ）

---

## 明確にすべき点

### 1. スコア到達時の通知先
| スコア到達 | レベル | 通知先（想定） | 現状 |
|---|---|---|---|
| 30点 | DEPT_REVIEW | 主任（Level 3.5） | ❌ 不明 |
| 50点 | DEPT_AGENDA | 師長（Level 7） | ❌ 不明 |
| 100点 | FACILITY_AGENDA | 副看護部長（Level 8）+ 委員会メンバー | ❌ 不明 |
| 300点 | CORP_REVIEW | 戦略企画部 | ❌ 不明 |
| 600点 | CORP_AGENDA | 理事長 | ❌ 不明 |

### 2. ProposalDocumentの生成タイミング
- **50点で生成？** それとも **100点で生成？**
- 50点で生成する場合、部署内での議題化に使用
- 100点で生成する場合、委員会提出に使用

### 3. 手動昇格ボタンの有無
- **現在の実装**: スコア閾値による自動昇格のみ
- **想定される要望**: 主任が「施設議題に昇格」ボタンを押す？
- **理由**: スコアは50点だけど、緊急性が高いので100点扱いにしたい等

### 4. 部署議題段階でのアクション
- **50-99点の段階で主任・師長が何をする？**
  - 部署ミーティングで議論？
  - ProposalDocumentを編集？
  - 「施設議題に推薦」ボタンを押す？

---

## 推奨される確認事項

### ユーザーへの質問
1. **自動昇格 vs 手動昇格**
   - スコアが100点に達したら自動的にFACILITY_AGENDAに昇格？
   - それとも主任（Level 3.5）が「施設議題に昇格」ボタンを押す？

2. **部署議題段階（50-99点）での処理**
   - ProposalDocumentは50点で自動生成される？それとも100点？
   - 部署ミーティングでの決定後、主任が何かアクションを取る必要がある？

3. **通知フロー**
   - 30点到達時: 主任（Level 3.5）に通知
   - 50点到達時: 師長（Level 7）に通知
   - 100点到達時: 副看護部長（Level 8）+ 委員会メンバーに通知
   - この理解で正しいですか？

4. **想定している具体的なUI/UX**
   - どのような画面・ボタン配置を想定していますか？

---

## 補足: 医療システムWebhook通知（Phase 3）

`ProposalEscalationEngine.ts` の429-461行目に以下の実装がある:

```typescript
async notifyEscalation(
  proposalId: string,
  fromLevel: string,
  toLevel: string,
  currentScore: number,
  requiredScore: number,
  staffId: string
): Promise<boolean> {
  // 医療システムにエスカレーションを通知
  await medicalSystemWebhook.notifyProposalEscalated({
    proposalId,
    fromLevel,
    toLevel,
    currentScore,
    requiredScore,
    staffId
  });
}
```

**これは医療システムへの通知であり、VoiceDrive内部の通知ではない**。

VoiceDrive内部での通知（Level 3.5, 7, 8への通知）は **別途実装が必要**。

---

## まとめ

### 現在実装されているもの
✅ スコアによる自動レベル判定（0-29 → 30-49 → 50-99 → 100-299 → 300-599 → 600+）
✅ レベルに応じた閲覧範囲・投票範囲の制御
✅ 通知メッセージのテンプレート
✅ 医療システムへのWebhook通知（Phase 3）
✅ ProposalDocumentの型定義

### 未実装・不明確なもの
❌ VoiceDrive内部での通知送信処理（Level 3.5, 7, 8への通知）
❌ 通知の送信先の明確化
❌ ProposalDocumentの生成タイミング（50点 or 100点）
❌ 手動昇格ボタンの有無
❌ 部署議題段階（50-99点）での具体的なアクション

---

**次のステップ**: ユーザーに上記の不明点を確認してから、DB設計とワークフロー実装を進める。
