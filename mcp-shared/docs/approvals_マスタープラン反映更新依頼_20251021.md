# 承認・対応管理ページ（Approvals）マスタープラン反映更新のご依頼

**文書番号**: APV-MASTER-PLAN-UPDATE-2025-1021-001
**発信日**: 2025年10月21日
**発信元**: VoiceDriveチーム
**宛先**: 医療職員カルテシステム開発チーム
**件名**: 承認・対応管理ページ実装完了に伴うマスタープラン反映更新のお願い
**参照文書**:
- APV-MEDICAL-2025-1021-001（医療システム確認結果）
- APV-NOTIFY-TO-MEDICAL-2025-1021-001（VoiceDrive実装完了連絡書）

---

## 📋 エグゼクティブサマリー

医療職員カルテシステム開発チーム様

いつもお世話になっております。VoiceDriveチームです。

この度、貴チームから**承認・対応管理ページ（Approvals）の確認結果**（文書番号: APV-MEDICAL-2025-1021-001）をいただき、誠にありがとうございました。

VoiceDrive側の**Phase 1-3実装が完了**しており、貴チームからも**組織階層API（0.5日）とbudgetApprovalLimitフィールド（0.3日）の実装準備が整っている**ことを確認いたしました。

つきましては、**共通DB構築後のPhase 3-4の作業を貴チームのマスタープランに反映・更新していただきたく**、ご依頼申し上げます。

---

## ✅ 現在の状況確認

### VoiceDrive側（完了）

| Phase | 実装内容 | ステータス | 完了日 |
|-------|---------|----------|--------|
| **Phase 1** | データベーススキーマ拡張 | ✅ 完了 | 10/21 |
| **Phase 2** | ActionableNotificationService実装 | ✅ 完了 | 10/21 |
| **Phase 3** | Approvals API実装（5エンドポイント） | ✅ 完了 | 10/21 |

### 医療システム側（確認済み）

| 項目 | 実装内容 | 推定工数 | ステータス |
|------|---------|---------|----------|
| **組織階層API** | `GET /api/v2/employees/:employeeId/hierarchy` | 0.5日 | 🟡 実装準備中 |
| **budgetApprovalLimit** | Employeeテーブルフィールド追加 | 0.3日 | 🟡 実装準備中 |
| **合計** | - | **0.8日** | - |

---

## 🎯 マスタープランへの反映更新依頼

### 依頼内容

貴チームが管理されている**マスタープラン**（参照: 共通DB構築後_作業再開指示書_20250928.md）に、以下のPhase 3-4の作業を追加・反映していただきたく、お願い申し上げます。

---

## 📅 Phase 3-4 実装スケジュール（マスタープラン反映用）

### Phase 3: 医療システム側実装（共通DB構築後）

**実施時期**: 共通DB構築完了後 1-2営業日

**実装項目**:

#### 1. 組織階層API実装 🟡

**エンドポイント**: `GET /api/v2/employees/:employeeId/hierarchy`

**実装場所**: `src/app/api/v2/employees/[employeeId]/hierarchy/route.ts`（新規作成）

**推定工数**: 0.5日（4時間）

**実装内容**:
- Employee.supervisorIdフィールドを使用した階層情報取得
- employee（本人）、parent（上司）、grandparent（上司の上司）を返却
- エスカレーション機能のためにVoiceDrive側から呼び出される

**レスポンス仕様**:
```json
{
  "employee": {
    "id": "OH-NS-2024-020",
    "name": "田中看護師長",
    "permissionLevel": 8.0,
    "supervisorId": "OH-NS-2024-030"
  },
  "parent": {
    "id": "OH-NS-2024-030",
    "name": "山田部長",
    "permissionLevel": 10.0,
    "supervisorId": "OH-NS-2024-040"
  },
  "grandparent": {
    "id": "OH-NS-2024-040",
    "name": "佐藤事務長",
    "permissionLevel": 11.0,
    "supervisorId": null
  }
}
```

**Query Parameters**:
- `depth`: 取得階層数（デフォルト: 2）

**HTTPステータスコード**:
- `200 OK`: 成功
- `404 Not Found`: 職員が存在しない
- `500 Internal Server Error`: サーバーエラー

---

#### 2. budgetApprovalLimitフィールド追加 🟡

**対象テーブル**: Employee

**フィールド定義**:
```prisma
model Employee {
  // ... 既存フィールド
  budgetApprovalLimit Decimal? // 予算承認限度額（円）
}
```

**推定工数**: 0.3日（2-3時間）

**実装内容**:
1. マイグレーションファイル作成
2. マイグレーション実行
3. 既存職員への初期値設定

**初期値設定例**:
```sql
UPDATE Employee
SET budgetApprovalLimit = CASE
  WHEN permissionLevel >= 12 THEN 10000000  -- 理事長・院長クラス: 1000万円
  WHEN permissionLevel >= 11 THEN 5000000   -- 事務長クラス: 500万円
  WHEN permissionLevel >= 10 THEN 2000000   -- 部長クラス: 200万円
  WHEN permissionLevel >= 8  THEN 500000    -- 師長クラス: 50万円
  WHEN permissionLevel >= 6  THEN 100000    -- 主任クラス: 10万円
  ELSE NULL                                  -- 予算承認権限なし
END;
```

**API拡張**:
- 既存の `GET /api/v2/employees/:employeeId` のレスポンスに `budgetApprovalLimit` を追加

---

### Phase 4: 統合テスト（両チーム協力）

**実施時期**: Phase 3完了後 2-3営業日

**実施内容**:

#### VoiceDrive側テスト項目

| テスト項目 | 内容 | 担当 |
|----------|------|------|
| **承認通知作成テスト** | createActionableNotification()の動作確認 | VoiceDrive |
| **通知一覧取得テスト** | getUserNotifications()の動作確認 | VoiceDrive |
| **既読マークテスト** | markAsRead()の動作確認 | VoiceDrive |
| **通知統計取得テスト** | getNotificationStats()の動作確認 | VoiceDrive |
| **アクション実行テスト** | executeNotificationAction()の動作確認 | VoiceDrive |
| **承認フロー統合テスト** | 承認→却下の一連の流れ確認 | VoiceDrive |

#### 医療システム側テスト項目

| テスト項目 | 内容 | 担当 |
|----------|------|------|
| **組織階層API動作確認** | hierarchy APIのレスポンス確認 | 医療システム |
| **budgetApprovalLimit確認** | 既存職員への初期値設定確認 | 医療システム |

#### 統合テスト（両チーム協力）

| テスト項目 | 内容 | 担当 |
|----------|------|------|
| **エスカレーション動作確認** | 期限切れ時の上位承認者への自動移行 | 両チーム |
| **予算承認権限判定確認** | budgetApprovalLimitを使った承認可否判定 | 両チーム |
| **組織階層情報取得確認** | VoiceDrive→医療システムのAPI連携確認 | 両チーム |

**テスト環境**: 共通DB（テスト環境）

**テスト実行方法**:
```bash
# VoiceDrive側
npx tsx src/tests/approvals-integration-test.ts

# 医療システム側
（貴チームのテストスクリプト実行）
```

---

## 📊 マスタープランへの追加項目サマリー

### Phase 3: 医療システム側実装

| 項目 | 実装内容 | 推定工数 | 実施時期 |
|------|---------|---------|---------|
| 組織階層API | `GET /api/v2/employees/:employeeId/hierarchy` | 0.5日 | 共通DB構築後 1-2営業日 |
| budgetApprovalLimit | Employeeテーブルフィールド追加 | 0.3日 | 共通DB構築後 1-2営業日 |
| **合計** | - | **0.8日** | - |

### Phase 4: 統合テスト

| 項目 | 実施内容 | 推定工数 | 実施時期 |
|------|---------|---------|---------|
| VoiceDrive側テスト | 6テストケース実施 | 0.5日 | Phase 3完了後 |
| 医療システム側テスト | 2テストケース実施 | 0.3日 | Phase 3完了後 |
| 統合テスト | 3テストケース実施 | 0.5日 | Phase 3完了後 |
| **合計** | - | **1.3日** | - |

### 総合計推定工数

**Phase 3-4合計**: 2.1日（約17時間）

---

## 🔍 貴チームへのご確認事項

### 1. マスタープランへの反映タイミング

**質問**: 上記のPhase 3-4を、貴チームのマスタープランにいつ反映していただけますでしょうか？

**希望**: 共通DB構築スケジュール確定時（または本文書受領後1週間以内）

---

### 2. 実装スケジュールの調整

**質問**: 上記のスケジュール（共通DB構築後1-2営業日でPhase 3実装）で問題ございませんでしょうか？

貴チームのご都合に合わせて調整いたしますので、ご希望のスケジュールをご教示ください。

---

### 3. 統合テストの実施方法

**質問**: Phase 4統合テストの実施方法について、以下のどちらをご希望でしょうか？

**Option A**: VoiceDrive側・医療システム側が個別にテスト実施後、統合テスト実施
**Option B**: 最初から両チーム合同でテスト実施

---

## 📝 VoiceDrive側の準備完了事項

### 実装完了

- ✅ Phase 1: データベーススキーマ拡張
- ✅ Phase 2: ActionableNotificationService実装
- ✅ Phase 3: Approvals API実装

### テスト準備完了

- ✅ 統合テストスクリプト作成
- ✅ テストケース6件準備完了
- ✅ テストデータ準備完了

### ドキュメント作成完了

- ✅ DB要件分析書
- ✅ 暫定マスターリスト
- ✅ Phase 1-3実装完了報告書
- ✅ 医療チームへの実装完了連絡書
- ✅ 本文書（マスタープラン反映更新依頼書）

**VoiceDrive側の準備は完了しており、共通DB構築後、即座にPhase 4統合テストに進めます。**

---

## 🎯 次のアクション

### VoiceDriveチーム（完了）

- [x] Phase 1-3実装完了
- [x] 医療チームへの実装完了連絡
- [x] マスタープラン反映更新依頼書作成
- [ ] 貴チームからのマスタープラン反映完了報告待ち
- [ ] 共通DB構築待ち
- [ ] Phase 4統合テスト実施（共通DB構築後）

### 医療システムチーム（ご依頼）

- [ ] 本文書のレビュー
- [ ] マスタープランへのPhase 3-4反映・更新
- [ ] マスタープラン反映完了のご報告
- [ ] 共通DB構築後、Phase 3実装開始（0.8日）
- [ ] Phase 4統合テスト実施（両チーム協力）

---

## 🔗 関連ドキュメント

本依頼に関連するドキュメントは以下の通りです（すべて`mcp-shared/docs/`フォルダに保存）：

### VoiceDrive側ドキュメント

| ドキュメント | ファイル名 | 作成日 |
|------------|----------|--------|
| **DB要件分析書** | `approvals_DB要件分析_20251013.md` | 10/13 |
| **暫定マスターリスト** | `approvals暫定マスターリスト_20251013.md` | 10/13 |
| **分析完了報告書** | `approvals_分析完了報告_医療チーム確認依頼_20251021.md` | 10/21 |
| **Phase 1-3実装完了報告書** | `approvals_Phase1-3実装完了報告_20251021.md` | 10/21 |
| **実装完了連絡書** | `approvals_VoiceDrive実装完了連絡書_医療チームへ_20251021.md` | 10/21 |
| **本文書（マスタープラン反映依頼）** | `approvals_マスタープラン反映更新依頼_20251021.md` | 10/21 |

### 医療システム側ドキュメント

| ドキュメント | ファイル名 | 作成日 |
|------------|----------|--------|
| **医療システム確認結果** | `approvals_医療システム確認結果_20251021.md` | 10/21 |
| **マスタープラン** | `共通DB構築後_作業再開指示書_20250928.md` | 参照 |

すべてのドキュメントは貴チームとの自動同期により共有されております。

---

## 🙏 まとめ

医療職員カルテシステム開発チーム様

承認・対応管理ページ（Approvals）のVoiceDrive側実装が完了し、貴チームからの確認結果もいただきました。

つきましては、**共通DB構築後のPhase 3-4の作業を貴チームのマスタープランに反映・更新していただきたく**、お願い申し上げます。

**反映依頼内容**:
- 🟡 **Phase 3**: 組織階層API実装（0.5日）+ budgetApprovalLimitフィールド追加（0.3日）
- 🟡 **Phase 4**: 統合テスト実施（両チーム協力、1.3日）

**VoiceDrive側の準備**:
- ✅ Phase 1-3実装完了
- ✅ 統合テストスクリプト準備完了
- ✅ 共通DB構築後、即座にPhase 4実施可能

貴チームのマスタープランへの反映完了のご報告をお待ちしております。

ご不明な点やご質問がございましたら、お気軽にお申し付けください。

引き続き、何卒よろしくお願い申し上げます。

---

**発信元**: VoiceDriveチーム
プロジェクトリーダー: [氏名]
バックエンドリーダー: [氏名]

**連絡先**:
- Slack: `#phase2-approvals`
- Email: voicedrive-team@example.com

**発信日**: 2025年10月21日

---

## 付録A: Phase 3-4 詳細タイムライン（マスタープラン反映用）

### 共通DB構築完了後のタイムライン

```
Day 0: 共通DB構築完了
  ├─ VoiceDriveチーム: Prismaマイグレーション実行
  └─ 両チーム: Phase 3開始準備

Day 1-2: Phase 3実装（医療システム側）
  ├─ 組織階層API実装（0.5日）
  ├─ budgetApprovalLimitフィールド追加（0.3日）
  └─ 実装完了報告（VoiceDriveチームへ）

Day 3: Phase 4準備
  ├─ VoiceDriveチーム: 統合テストスクリプト最終確認
  └─ 医療システムチーム: テスト環境準備

Day 4-6: Phase 4統合テスト実施
  ├─ Day 4: VoiceDrive側テスト（6テストケース）
  ├─ Day 5: 医療システム側テスト（2テストケース）
  └─ Day 6: 統合テスト（両チーム協力、3テストケース）

Day 7: Phase 2承認・対応管理ページ本番リリース
  ├─ 本番環境デプロイ
  ├─ 本番動作確認
  └─ リリース完了報告
```

### 推定工数内訳

| Day | 作業内容 | VoiceDrive工数 | 医療システム工数 |
|-----|---------|---------------|----------------|
| Day 0 | 共通DB構築完了、マイグレーション | 0.3日 | - |
| Day 1-2 | Phase 3実装 | - | 0.8日 |
| Day 3 | Phase 4準備 | 0.2日 | 0.1日 |
| Day 4-6 | Phase 4統合テスト | 0.5日 | 0.3日 |
| Day 7 | 本番リリース | 0.3日 | 0.1日 |
| **合計** | - | **1.3日** | **1.3日** |

**総合計**: 2.6日（両チーム合計）

---

## 付録B: クイックリファレンス

### マスタープラン反映項目チェックリスト

#### Phase 3: 医療システム側実装

- [ ] 組織階層API実装（`GET /api/v2/employees/:employeeId/hierarchy`）
  - [ ] 実装場所: `src/app/api/v2/employees/[employeeId]/hierarchy/route.ts`
  - [ ] 推定工数: 0.5日
  - [ ] 実施時期: 共通DB構築後1-2営業日

- [ ] budgetApprovalLimitフィールド追加
  - [ ] マイグレーションファイル作成
  - [ ] マイグレーション実行
  - [ ] 既存職員への初期値設定
  - [ ] 推定工数: 0.3日
  - [ ] 実施時期: 共通DB構築後1-2営業日

#### Phase 4: 統合テスト

- [ ] VoiceDrive側テスト（6テストケース、0.5日）
- [ ] 医療システム側テスト（2テストケース、0.3日）
- [ ] 統合テスト（3テストケース、0.5日）
- [ ] 実施時期: Phase 3完了後2-3営業日

#### 総合計推定工数

- [ ] Phase 3-4合計: 2.1日（医療システム側: 1.3日、VoiceDrive側: 0.8日）

---

**END OF DOCUMENT**
