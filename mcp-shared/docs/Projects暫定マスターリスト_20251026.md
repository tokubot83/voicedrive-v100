# EnhancedProjectListPage (/projects) 暫定マスターリスト

**文書番号**: MASTER-2025-1026-003
**作成日**: 2025年10月26日
**対象ページ**: https://voicedrive-v100.vercel.app/projects EnhancedProjectListPage
**参照文書**: [Projects_DB要件分析_20251026.md](./Projects_DB要件分析_20251026.md)

---

## 📋 概要

EnhancedProjectListPage（/projects）の実装に必要なテーブル・フィールド・API・サービスの完全なマスターリストです。

**重要**: 本ページは**Phase 2まで完全実装済み**であり、全てのデータソースとサービスが動作しています。

---

## 🗂️ データ項目カタログ（47項目）

### カテゴリ別分類

1. **基本情報**: 9項目
2. **チーム情報**: 2項目
3. **組織情報**: 2項目
4. **Phase 2拡張**: 6項目
5. **統計サマリー**: 4項目
6. **フィルター**: 4項目
7. **UI状態**: 3項目
8. **内部管理用**: 17項目

---

## 1️⃣ 基本情報（9項目）

### 1.1 プロジェクトID
| 項目名 | `id` |
|--------|------|
| **型** | string |
| **データソース** | Project.id |
| **説明** | プロジェクトの一意識別子 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード（内部使用） |
| **生成方法** | cuid() |

---

### 1.2 プロジェクト名
| 項目名 | `title` |
|--------|------|
| **型** | string |
| **データソース** | Project.title |
| **説明** | プロジェクトのタイトル |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードのヘッダー |
| **検索対象** | ✅ Yes（searchTermで部分一致） |

---

### 1.3 説明文
| 項目名 | `description` |
|--------|------|
| **型** | string |
| **データソース** | Project.description |
| **説明** | プロジェクトの説明文 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードの本文 |
| **検索対象** | ✅ Yes（searchTermで部分一致） |

---

### 1.4 ステータス
| 項目名 | `status` |
|--------|------|
| **型** | enum: 'proposed' \| 'active' \| 'completed' \| 'paused' |
| **データソース** | Project.status |
| **説明** | プロジェクトの現在のステータス |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードの右上（アイコン＋ラベル） |
| **フィルター** | ✅ Yes（filterStatus） |

**ステータス一覧**:
| 値 | 日本語表示 | アイコン | 色 |
|----|----------|---------|-----|
| `proposed` | 提案中 | AlertCircle | blue-400 |
| `active` | 進行中 | Clock | yellow-400 |
| `completed` | 完了 | CheckCircle | green-400 |
| `paused` | 一時停止 | AlertCircle | gray-400 |

---

### 1.5 カテゴリー
| 項目名 | `category` |
|--------|------|
| **型** | enum: 'improvement' \| 'community' \| 'facility' \| 'system' |
| **データソース** | Project.category |
| **説明** | プロジェクトのカテゴリー分類 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードのバッジ |
| **フィルター** | ✅ Yes（filterCategory） |

**カテゴリー一覧**:
| 値 | 日本語表示 | 背景色 | 文字色 |
|----|----------|-------|--------|
| `improvement` | 業務改善 | blue-500/20 | blue-400 |
| `community` | コミュニティ | green-500/20 | green-400 |
| `facility` | 施設管理 | purple-500/20 | purple-400 |
| `system` | システム | orange-500/20 | orange-400 |

---

### 1.6 優先度
| 項目名 | `priority` |
|--------|------|
| **型** | enum?: 'urgent' \| 'high' \| 'medium' \| 'low' \| null |
| **データソース** | Project.priority |
| **説明** | プロジェクトの優先度 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードの下部（TrendingUpアイコン付き） |
| **NULL許可** | ✅ Yes（表示: "未設定"） |

**優先度一覧**:
| 値 | 日本語表示 | 色 |
|----|----------|-----|
| `urgent` | 緊急 | red-500 |
| `high` | 高 | red-400 |
| `medium` | 中 | yellow-400 |
| `low` | 低 | gray-400 |
| `null` | 未設定 | gray-400 |

---

### 1.7 進捗率
| 項目名 | `progress` |
|--------|------|
| **型** | number (0-100) |
| **データソース** | Project.progressRate |
| **説明** | プロジェクトの進捗率（0-100%） |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部のプログレスバー |
| **表示条件** | status === 'active'の場合のみ |

**表示例**:
```tsx
<div className="w-full bg-slate-700 rounded-full h-2">
  <div
    className="bg-gradient-to-r from-blue-500 to-blue-400 h-2 rounded-full"
    style={{ width: `${progress}%` }}
  />
</div>
```

---

### 1.8 開始日
| 項目名 | `startDate` |
|--------|------|
| **型** | string? (ISO 8601形式) |
| **データソース** | Project.startedAt |
| **説明** | プロジェクトの開始日 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部（Calendarアイコン付き） |
| **NULL許可** | ✅ Yes（非表示） |
| **フォーマット** | `new Date().toLocaleDateString('ja-JP')` |

---

### 1.9 完了日
| 項目名 | `endDate` |
|--------|------|
| **型** | string? (ISO 8601形式) |
| **データソース** | Project.completedAt |
| **説明** | プロジェクトの完了日 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部（Calendarアイコン付き） |
| **NULL許可** | ✅ Yes（非表示） |
| **表示条件** | status === 'completed'の場合のみ |

---

## 2️⃣ チーム情報（2項目）

### 2.1 参加者数
| 項目名 | `participants` |
|--------|------|
| **型** | number |
| **データソース** | COUNT(ProjectTeamMember WHERE leftAt IS NULL) + 1 (proposer) |
| **説明** | プロジェクトの現在の参加者数 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部（Usersアイコン付き） |
| **計算方法** | ProjectRoleService.getProjectParticipantCounts() |

**Phase 3最適化**:
- ProjectSummary.activeParticipants を優先使用
- フォールバック: リアルタイム計算

---

### 2.2 ユーザーの役割
| 項目名 | `myRole` |
|--------|------|
| **型** | enum: 'owner' \| 'participant' \| 'viewer' |
| **データソース** | ProjectRoleService.getUserProjectRole() |
| **説明** | 現在のユーザーのプロジェクト内での役割 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードのバッジ（ownerの場合のみ） |
| **判定ロジック** | ProjectRoleService参照 |

**役割判定ロジック**:
1. `Project.proposerId === currentUserId` → `owner`
2. `ProjectTeamMember.role === 'owner'` → `owner`
3. `ProjectTeamMember.role === 'member'` and `leftAt === null` → `participant`
4. その他 → `viewer`

---

## 3️⃣ 組織情報（2項目）

### 3.1 部署名
| 項目名 | `department` |
|--------|------|
| **型** | string |
| **データソース** | User.department (proposer) |
| **説明** | プロジェクト提案者の部署名 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部 |
| **デフォルト値** | "未設定" |

---

### 3.2 施設名
| 項目名 | `facility` |
|--------|------|
| **型** | string |
| **データソース** | MedicalSystemService.getFacilitiesFromDepartments() |
| **説明** | プロジェクト提案者の所属施設名 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード下部（青色表示） |
| **キャッシュ** | 24時間 |
| **API** | GET /api/v2/departments |
| **デフォルト値** | "未設定" or Project.facilityName |

**データ取得フロー**:
```
1. MedicalSystemService.getFacilitiesFromDepartments([department])
   ↓
2. キャッシュ確認（24時間有効）
   ↓ (キャッシュミス)
3. GET https://医療システム/api/v2/departments
   ↓
4. 部署名 → facilityName マッピング作成
   ↓
5. 24時間キャッシュ保存
   ↓
6. facilityMapを返却
```

---

## 4️⃣ Phase 2拡張（6項目）

### 4.1 プロジェクトレベル
| 項目名 | `projectLevel` |
|--------|------|
| **型** | enum?: 'DEPARTMENT' \| 'FACILITY' \| 'CORPORATE' \| 'EMERGENCY' \| null |
| **データソース** | Project.projectLevel |
| **説明** | プロジェクトのスケールレベル |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードのバッジ（アイコン付き） |
| **フィルター** | ✅ Yes（filterLevel） |
| **計算サービス** | ProjectLevelEngine.calculateProjectLevel() |

**レベル一覧**:
| 値 | 日本語表示 | アイコン | 判定条件 |
|----|----------|---------|---------|
| `DEPARTMENT` | 部署レベル | 🏢 | 単一部署内 |
| `FACILITY` | 施設レベル | 🏥 | 単一施設・複数部署 |
| `CORPORATE` | 法人レベル | 🏛️ | 複数施設 |
| `EMERGENCY` | 緊急 | 🚨 | エスカレーション中 |

**自動計算ロジック**:
```typescript
if (isEmergencyEscalated) return 'EMERGENCY';
if (facilitiesCount > 1) return 'CORPORATE';
if (departmentsCount > 1) return 'FACILITY';
return 'DEPARTMENT';
```

---

### 4.2 緊急エスカレーション有無
| 項目名 | `isEmergencyEscalated` |
|--------|------|
| **型** | boolean |
| **データソース** | Project.isEmergencyEscalated |
| **説明** | 緊急エスカレーション状態かどうか |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカード上部（緊急バッジ） |
| **デフォルト値** | false |

**表示例**:
```tsx
{isEmergencyEscalated && (
  <div className="mb-3 flex items-center gap-2">
    <AlertTriangle className="w-5 h-5 text-red-500" />
    <span className="text-red-500 text-sm font-semibold">緊急エスカレーション</span>
  </div>
)}
```

---

### 4.3 エスカレーション実行者ID
| 項目名 | `escalatedBy` |
|--------|------|
| **型** | string? |
| **データソース** | Project.escalatedBy |
| **説明** | エスカレーションを実行したユーザーのID |
| **実装状況** | ✅ 完了 |
| **表示場所** | 詳細ページ（ProjectListPageでは非表示） |
| **NULL許可** | ✅ Yes |

---

### 4.4 エスカレーション日時
| 項目名 | `escalatedDate` |
|--------|------|
| **型** | string? (ISO 8601形式) |
| **データソース** | Project.escalatedDate |
| **説明** | エスカレーションが実行された日時 |
| **実装状況** | ✅ 完了 |
| **表示場所** | 詳細ページ（ProjectListPageでは非表示） |
| **NULL許可** | ✅ Yes |

---

### 4.5 承認状態
| 項目名 | `approvalStatus` |
|--------|------|
| **型** | enum: 'pending' \| 'in_review' \| 'approved' \| 'rejected' |
| **データソース** | Project.approvalStatus |
| **説明** | プロジェクトの承認状態 |
| **実装状況** | ✅ 完了 |
| **表示場所** | プロジェクトカードのバッジ（pending以外） |
| **デフォルト値** | 'pending' |

**承認状態一覧**:
| 値 | 日本語表示 | 色 | 表示条件 |
|----|----------|-----|---------|
| `pending` | 承認待ち | - | 非表示 |
| `in_review` | 審査中 | blue-300 | 表示 |
| `approved` | 承認済み | green-300 | 表示 |
| `rejected` | 却下 | red-300 | 表示 |

**表示例**:
```tsx
{approvalStatus && approvalStatus !== 'pending' && (
  <span className="px-2 py-1 bg-blue-500/20 text-blue-300 rounded-full text-xs flex items-center gap-1">
    <Shield className="w-3 h-3" />
    <span>{getApprovalStatusLabel(approvalStatus)}</span>
  </span>
)}
```

---

### 4.6 現在の承認者ID
| 項目名 | `currentApprover` |
|--------|------|
| **型** | string? |
| **データソース** | Project.currentApprover |
| **説明** | 現在の承認待ちユーザーのID |
| **実装状況** | ✅ 完了 |
| **表示場所** | 詳細ページ（ProjectListPageでは非表示） |
| **NULL許可** | ✅ Yes |

---

## 5️⃣ 統計サマリー（4項目）

### 5.1 参加中のプロジェクト数
| 項目名 | `stats.active` |
|--------|------|
| **型** | number |
| **データソース** | ProjectListService.getProjectStats() |
| **説明** | ユーザーが参加中（active）のプロジェクト数 |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ上部の統計カード（黄色） |

**計算SQL**:
```typescript
await prisma.project.count({
  where: {
    status: 'active',
    OR: [
      { proposerId: currentUserId },
      { teamMembers: { some: { userId: currentUserId, leftAt: null } } }
    ]
  }
})
```

---

### 5.2 完了済みプロジェクト数
| 項目名 | `stats.completed` |
|--------|------|
| **型** | number |
| **データソース** | ProjectListService.getProjectStats() |
| **説明** | 完了済み（completed）のプロジェクト総数 |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ上部の統計カード（緑色） |

**計算SQL**:
```typescript
await prisma.project.count({
  where: { status: 'completed' }
})
```

---

### 5.3 提案中のプロジェクト数
| 項目名 | `stats.proposed` |
|--------|------|
| **型** | number |
| **データソース** | ProjectListService.getProjectStats() |
| **説明** | 提案中（proposed）のプロジェクト総数 |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ上部の統計カード（青色） |

**計算SQL**:
```typescript
await prisma.project.count({
  where: { status: 'proposed' }
})
```

---

### 5.4 オーナープロジェクト数
| 項目名 | `stats.owned` |
|--------|------|
| **型** | number |
| **データソース** | ProjectListService.getProjectStats() |
| **説明** | ユーザーがオーナーのプロジェクト数 |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ上部の統計カード（紫色） |

**計算SQL**:
```typescript
await prisma.project.count({
  where: { proposerId: currentUserId }
})
```

---

## 6️⃣ フィルター（4項目）

### 6.1 検索キーワード
| 項目名 | `searchTerm` |
|--------|------|
| **型** | string |
| **データソース** | React state |
| **説明** | タイトル・説明文の検索キーワード |
| **実装状況** | ✅ 完了 |
| **検索対象** | Project.title, Project.description |
| **検索方式** | 部分一致（大文字小文字区別なし） |

**SQLクエリ**:
```typescript
where: {
  OR: [
    { title: { contains: searchTerm, mode: 'insensitive' } },
    { description: { contains: searchTerm, mode: 'insensitive' } }
  ]
}
```

---

### 6.2 ステータスフィルター
| 項目名 | `filterStatus` |
|--------|------|
| **型** | enum: 'all' \| 'active' \| 'completed' \| 'proposed' |
| **データソース** | React state |
| **説明** | ステータスによるフィルター |
| **実装状況** | ✅ 完了 |
| **デフォルト値** | 'all' |
| **URL連携** | ✅ Yes（?filter=active） |

---

### 6.3 カテゴリーフィルター
| 項目名 | `filterCategory` |
|--------|------|
| **型** | enum: 'all' \| 'improvement' \| 'community' \| 'facility' \| 'system' |
| **データソース** | React state |
| **説明** | カテゴリーによるフィルター |
| **実装状況** | ✅ 完了 |
| **デフォルト値** | 'all' |
| **URL連携** | ✅ Yes（?filter=department/facility/corporate） |

---

### 6.4 レベルフィルター
| 項目名 | `filterLevel` |
|--------|------|
| **型** | enum: 'all' \| 'DEPARTMENT' \| 'FACILITY' \| 'CORPORATE' \| 'EMERGENCY' |
| **データソース** | React state |
| **説明** | プロジェクトレベルによるフィルター |
| **実装状況** | ✅ 完了（Phase 2） |
| **デフォルト値** | 'all' |

---

## 7️⃣ UI状態（3項目）

### 7.1 読み込み中フラグ
| 項目名 | `loading` |
|--------|------|
| **型** | boolean |
| **データソース** | React state |
| **説明** | データ取得中かどうか |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ中央（"読み込み中..."） |

---

### 7.2 エラーメッセージ
| 項目名 | `error` |
|--------|------|
| **型** | string? |
| **データソース** | React state |
| **説明** | エラーメッセージ |
| **実装状況** | ✅ 完了 |
| **表示場所** | ページ上部（赤色背景） |

---

### 7.3 プロジェクト一覧配列
| 項目名 | `projects` |
|--------|------|
| **型** | ProjectListItem[] |
| **データソース** | React state |
| **説明** | 表示するプロジェクト一覧 |
| **実装状況** | ✅ 完了 |
| **初期値** | [] |

---

## 8️⃣ 内部管理用（17項目）

### 8.1 提案者ID
| 項目名 | `proposerId` |
|--------|------|
| **型** | string |
| **データソース** | Project.proposerId |
| **説明** | プロジェクト提案者のユーザーID |
| **実装状況** | ✅ 完了 |
| **用途** | 役割判定（owner判定） |

---

### 8.2 作成日時
| 項目名 | `createdAt` |
|--------|------|
| **型** | DateTime |
| **データソース** | Project.createdAt |
| **説明** | プロジェクト作成日時 |
| **実装状況** | ✅ 完了 |
| **デフォルト値** | now() |

---

### 8.3 更新日時
| 項目名 | `updatedAt` |
|--------|------|
| **型** | DateTime |
| **データソース** | Project.updatedAt |
| **説明** | プロジェクト最終更新日時 |
| **実装状況** | ✅ 完了 |
| **自動更新** | ✅ Yes（Prisma @updatedAt） |

---

### 8.4 エスカレーション理由
| 項目名 | `escalationReason` |
|--------|------|
| **型** | string? |
| **データソース** | Project.escalationReason |
| **説明** | エスカレーションの理由 |
| **実装状況** | ✅ 完了 |
| **NULL許可** | ✅ Yes |

---

### 8.5 施設ID（キャッシュ）
| 項目名 | `facilityId` |
|--------|------|
| **型** | string? |
| **データソース** | Project.facilityId |
| **説明** | 施設ID（キャッシュ用） |
| **実装状況** | ✅ 完了 |
| **NULL許可** | ✅ Yes |
| **用途** | レベル計算の高速化 |

---

### 8.6 施設名（キャッシュ）
| 項目名 | `facilityName` |
|--------|------|
| **型** | string? |
| **データソース** | Project.facilityName |
| **説明** | 施設名（キャッシュ用） |
| **実装状況** | ✅ 完了 |
| **NULL許可** | ✅ Yes |
| **用途** | 医療システムAPI呼び出しの削減 |

---

### 8.7-8.17 その他の内部管理用項目
- ProjectTeamMember関連（id, projectId, userId, role, joinedAt, leftAt等）
- ProjectApproval関連（承認履歴）
- ProjectLevelHistory関連（レベル変更履歴）
- EmergencyDeactivation関連（エスカレーション解除履歴）

---

## 📊 サービス層マスターリスト

### 1. ProjectListService.ts ✅
**ファイルパス**: `src/services/ProjectListService.ts` (368行)

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `getProjectList` | filters, currentUserId | Promise\<ProjectListItem[]\> | プロジェクト一覧取得 |
| `getProjectStats` | currentUserId | Promise\<ProjectStats\> | ユーザー統計取得 |
| `getProjectWithDetails` | projectId, currentUserId | Promise\<ProjectWithDetails?\> | プロジェクト詳細取得 |
| `searchProjects` | searchTerm, limit? | Promise\<Array\<{id, title, description}\>\> | 簡易検索 |

---

### 2. ProjectRoleService.ts ✅
**ファイルパス**: `src/services/ProjectRoleService.ts`

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `getUserProjectRole` | userId, projectId | Promise\<'owner'\|'participant'\|'viewer'\> | 役割判定 |
| `getUserProjectRoles` | userId, projectIds[] | Promise\<Record\<string, ProjectRole\>\> | 一括役割判定 |
| `getProjectParticipantCounts` | projectIds[] | Promise\<Record\<string, number\>\> | 参加者数一括取得 |

---

### 3. MedicalSystemService.ts ✅
**ファイルパス**: `src/services/MedicalSystemService.ts`

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `getFacilitiesFromDepartments` | departments[] | Promise\<Record\<string, string\>\> | 部署→施設名マッピング |

---

### 4. ProjectLevelEngine.ts ✅
**ファイルパス**: `src/services/ProjectLevelEngine.ts` (344行)

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `calculateProjectLevel` | projectId | Promise\<ProjectLevelResult\> | レベル自動計算 |
| `updateProjectLevel` | projectId | Promise\<void\> | レベルDB更新 |
| `trackLevelChange` | projectId, previousLevel, newLevel, reason? | Promise\<void\> | レベル変更履歴記録 |
| `getLevelLabel` | level | string | 日本語ラベル取得 |
| `getLevelIcon` | level | string | アイコン文字列取得 |
| `getProjectLevelStats` | userId? | Promise\<ProjectLevelStats\> | レベル別統計 |

---

### 5. ProjectApprovalService.ts ✅
**ファイルパス**: `src/services/ProjectApprovalService.ts` (380行)

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `getProjectApprovalInfo` | projectId, currentUserId | Promise\<ProjectApprovalInfo\> | 承認情報取得 |
| `createApprovalRequest` | projectId, requesterId | Promise\<ProjectApprovalInfo\> | 承認リクエスト作成 |
| `processApproval` | projectId, approverId, action, comment? | Promise\<ProjectApprovalInfo\> | 承認処理 |
| `getPendingApprovalsCount` | approverId | Promise\<number\> | 承認待ち数 |
| `getPendingApprovals` | approverId | Promise\<ProjectApprovalInfo[]\> | 承認待ち一覧 |
| `getApprovalStats` | userId | Promise\<ApprovalStats\> | 承認統計 |
| `getApprovalStatusLabel` | status | string | 承認状態ラベル |

---

### 6. ProjectEscalationService.ts ✅
**ファイルパス**: `src/services/ProjectEscalationService.ts` (403行)

| メソッド名 | 引数 | 戻り値 | 説明 |
|----------|------|-------|------|
| `getEscalationInfo` | projectId, currentUserId | Promise\<EscalationInfo\> | エスカレーション情報取得 |
| `escalateProject` | request | Promise\<EscalationInfo\> | 緊急エスカレーション実行 |
| `deescalateProject` | request | Promise\<EscalationInfo\> | エスカレーション解除 |
| `getEscalatedProjects` | filters | Promise\<EscalationInfo[]\> | エスカレーション中一覧 |
| `getEscalationStats` | userId? | Promise\<EscalationStats\> | エスカレーション統計 |

---

## 🗄️ テーブル・フィールドマスターリスト

### 1. Projectテーブル
**ファイルパス**: `prisma/schema.prisma` (lines 308-365)

| フィールド名 | 型 | デフォルト値 | NULL許可 | インデックス | 説明 |
|-----------|---|------------|---------|-----------|------|
| `id` | String | cuid() | ❌ | PRIMARY | プロジェクトID |
| `title` | String | - | ❌ | ❌ | プロジェクト名 |
| `description` | String | - | ❌ | ❌ | 説明文 |
| `category` | String | - | ❌ | ✅ | カテゴリー |
| `status` | String | "proposed" | ❌ | ✅ | ステータス |
| `priority` | String? | null | ✅ | ❌ | 優先度 |
| `proposerId` | String | - | ❌ | ✅ | 提案者ID |
| `progressRate` | Float | 0 | ❌ | ❌ | 進捗率 |
| `startedAt` | DateTime? | null | ✅ | ❌ | 開始日 |
| `completedAt` | DateTime? | null | ✅ | ❌ | 完了日 |
| `createdAt` | DateTime | now() | ❌ | ✅ | 作成日時 |
| `updatedAt` | DateTime | - | ❌ | ❌ | 更新日時 |
| **Phase 2拡張** |||||
| `isEmergencyEscalated` | Boolean | false | ❌ | ✅ | 緊急エスカレーション |
| `escalatedBy` | String? | null | ✅ | ❌ | エスカレーション実行者 |
| `escalatedDate` | DateTime? | null | ✅ | ❌ | エスカレーション日時 |
| `escalationReason` | String? | null | ✅ | ❌ | エスカレーション理由 |
| `projectLevel` | String? | null | ✅ | ✅ | プロジェクトレベル |
| `approvalStatus` | String | "pending" | ❌ | ✅ | 承認状態 |
| `currentApprover` | String? | null | ✅ | ❌ | 現在の承認者 |
| `facilityId` | String? | null | ✅ | ✅ | 施設ID（キャッシュ） |
| `facilityName` | String? | null | ✅ | ❌ | 施設名（キャッシュ） |

**評価**: ✅ **全フィールド実装済み**

---

### 2. ProjectTeamMemberテーブル
**ファイルパス**: `prisma/schema.prisma` (lines 1866-1883)

| フィールド名 | 型 | デフォルト値 | NULL許可 | インデックス | 説明 |
|-----------|---|------------|---------|-----------|------|
| `id` | String | cuid() | ❌ | PRIMARY | メンバーID |
| `projectId` | String | - | ❌ | ✅ | プロジェクトID |
| `userId` | String | - | ❌ | ✅ | ユーザーID |
| `role` | String | "member" | ❌ | ✅ | 役割 |
| `joinedAt` | DateTime | now() | ❌ | ❌ | 参加日時 |
| `leftAt` | DateTime? | null | ✅ | ✅ | 退出日時 |
| `createdAt` | DateTime | now() | ❌ | ❌ | 作成日時 |
| `updatedAt` | DateTime | - | ❌ | ❌ | 更新日時 |

**評価**: ✅ **全フィールド実装済み**

---

### 3. ProjectApprovalテーブル
| フィールド名 | 型 | インデックス | 説明 |
|-----------|---|-----------|------|
| `id` | String | PRIMARY | 承認ID |
| `projectId` | String | ✅ | プロジェクトID |
| `requesterId` | String | ❌ | リクエスター |
| `approverId` | String | ✅ | 承認者 |
| `approverLevel` | String | ❌ | 承認者レベル |
| `status` | String | ✅ | 承認状態 |
| `comment` | String? | ❌ | コメント |
| `approvedAt` | DateTime? | ❌ | 承認日時 |
| `createdAt` | DateTime | ❌ | 作成日時 |

**評価**: ✅ **Phase 2で使用中**

---

### 4. ProjectLevelHistoryテーブル
| フィールド名 | 型 | インデックス | 説明 |
|-----------|---|-----------|------|
| `id` | String | PRIMARY | 履歴ID |
| `projectId` | String | ✅ | プロジェクトID |
| `previousLevel` | String? | ❌ | 変更前レベル |
| `newLevel` | String | ❌ | 変更後レベル |
| `changedBy` | String? | ❌ | 変更者 |
| `reason` | String? | ❌ | 変更理由 |
| `changedAt` | DateTime | ❌ | 変更日時 |

**評価**: ✅ **Phase 2で使用中**

---

### 5. EmergencyDeactivationテーブル
| フィールド名 | 型 | インデックス | 説明 |
|-----------|---|-----------|------|
| `id` | String | PRIMARY | 解除ID |
| `projectId` | String | ✅ | プロジェクトID |
| `deescalatedBy` | String | ❌ | 解除者 |
| `reason` | String? | ❌ | 解除理由 |
| `deescalatedAt` | DateTime | ❌ | 解除日時 |

**評価**: ✅ **Phase 2で使用中**

---

### 6. ProjectSummaryテーブル（Phase 3・未実装）
| フィールド名 | 型 | デフォルト値 | インデックス | 説明 |
|-----------|---|------------|-----------|------|
| `id` | String | cuid() | PRIMARY | サマリーID |
| `projectId` | String | - | ✅ UNIQUE | プロジェクトID |
| `totalParticipants` | Int | 0 | ✅ | 総参加者数 |
| `activeParticipants` | Int | 0 | ✅ | アクティブ参加者数 |
| `ownerCount` | Int | 0 | ❌ | オーナー数 |
| `memberCount` | Int | 0 | ❌ | メンバー数 |
| `lastCalculatedAt` | DateTime | now() | ❌ | 最終集計日時 |
| `updatedAt` | DateTime | - | ❌ | 更新日時 |

**評価**: 🟡 **スキーマ定義済み、マイグレーション待ち**

---

## 🔗 医療システムAPI連携

### 部署マスタAPI
**エンドポイント**: `GET /api/v2/departments`
**状態**: ✅ 医療システム側実装済み

| 項目 | 詳細 |
|------|------|
| **認証** | X-API-Key ヘッダー |
| **Rate Limit** | 100 req/min/IP |
| **キャッシュ** | 24時間（VoiceDrive側） |
| **レスポンスフィールド** | departmentId, departmentName, facilityId, facilityName, facilityCode, level等 |
| **VoiceDrive側実装** | MedicalSystemService.getFacilitiesFromDepartments() |

---

## ✅ 実装完了度チェックリスト

### Phase 1: 基本機能（✅ 100%完了）
- [x] Projectテーブル確認
- [x] ProjectTeamMemberテーブル確認
- [x] ProjectListService.ts実装
- [x] ProjectRoleService.ts実装
- [x] MedicalSystemService.ts実装
- [x] ProjectListPage.tsx実装
- [x] 検索・フィルター機能実装
- [x] 統計サマリー実装
- [x] 医療システムAPI統合

### Phase 2: レベル・承認機能（✅ 100%完了）
- [x] Projectテーブル拡張フィールド追加
- [x] ProjectLevelEngine.ts実装
- [x] ProjectApprovalService.ts実装
- [x] ProjectEscalationService.ts実装
- [x] ProjectListPage.tsx拡張（レベル・承認表示）

### Phase 3: パフォーマンス最適化（🟡 20%完了）
- [x] ProjectSummaryテーブルスキーマ定義
- [ ] ProjectSummaryマイグレーション実行
- [ ] 日次バッチ実装
- [ ] ProjectListService最適化

---

## 📝 schema.prisma更新の必要性

**結論**: ❌ **更新不要**

全ての必要フィールドが既に存在しており、schema.prismaの更新は必要ありません。

Phase 3実装時にProjectSummaryテーブルのマイグレーションを実行する必要がありますが、スキーマ定義は既に完了しています。

---

## 🔗 関連ドキュメント

1. [Projects_DB要件分析_20251026.md](./Projects_DB要件分析_20251026.md) - DB要件分析
2. [ProjectListPage_DB要件分析_20251026.md](./ProjectListPage_DB要件分析_20251026.md) - 議題モード分析（参考）
3. [ProjectListPage_医療システム確認結果_20251026.md](./ProjectListPage_医療システム確認結果_20251026.md) - 医療システムAPI確認
4. [ProjectListPage_Phase2実装完了報告_20251026.md](./ProjectListPage_Phase2実装完了報告_20251026.md) - Phase 2実装報告
5. [データ管理責任分界点定義書_20251008.md](./データ管理責任分界点定義書_20251008.md) - データ管理責任

---

**文書終了**

最終更新: 2025年10月26日
バージョン: 1.0
次回レビュー: Phase 3実装開始時
