# admin/audit-logs æœ€çµ‚å®Ÿè£…è¨ˆç”»æ›¸

**æ–‡æ›¸ç•ªå·**: VD-PLAN-2025-1027-010
**ä½œæˆæ—¥**: 2025å¹´10æœˆ27æ—¥
**ä½œæˆè€…**: VoiceDriveãƒãƒ¼ãƒ ï¼ˆClaudeCodeï¼‰
**ä»¶å**: admin/audit-logså®Ÿè£…è¨ˆç”»ï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è¿”ä¿¡åæ˜ ç‰ˆï¼‰
**å‚ç…§æ›¸é¡**:
- admin/audit-logs VoiceDriveç¢ºèªå›ç­”æ›¸ã¸ã®è¿”ä¿¡ï¼ˆMED-RESP-2025-1027-009ï¼‰
- admin/audit-logs VoiceDriveå´ç¢ºèªå›ç­”æ›¸ï¼ˆVD-RESP-2025-1027-009ï¼‰

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã‹ã‚‰ã®è©³ç´°ãªè¿”ä¿¡ã‚’å—é ˜ã—ã€admin/audit-logsã®æœ€çµ‚å®Ÿè£…è¨ˆç”»ã‚’ç­–å®šã—ã¾ã™ã€‚

### ä¸»è¦ãªæ±ºå®šäº‹é …

| é …ç›® | æ±ºå®šå†…å®¹ | æ ¹æ‹  |
|------|---------|------|
| **ä¿å­˜æœŸé–“** | **3å¹´**ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–: 1å¹´å¾Œï¼‰ | VoiceDriveã¯æ³•ä»¤è¦ä»¶æº–æ‹ ã€åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã¯ç•°ãªã‚‹ |
| **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ–¹å¼** | 1å¹´çµŒéå¾Œã«åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ç§»å‹• | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– |
| **å‰Šé™¤ãƒãƒªã‚·ãƒ¼** | 3å¹´çµŒéå¾Œã«è‡ªå‹•å‰Šé™¤ | æ³•ä»¤è¦ä»¶æº–æ‹  |
| **ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé€šçŸ¥** | **Slack + ãƒ¡ãƒ¼ãƒ«**ï¼ˆcritical, highã®ã¿ï¼‰ | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºå¼·åŒ– |

### å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| Phase | æœŸé–“ | çŠ¶æ…‹ | å†…å®¹ |
|-------|------|------|------|
| **Phase 1** | 10/27ï¼ˆå®Œäº†ï¼‰ | âœ… 100% | åŸºæœ¬æ©Ÿèƒ½ï¼ˆseverityè¿½åŠ ï¼‰ |
| **Phase 2** | 10/28-11/1ï¼ˆ4æ—¥ï¼‰ | ğŸ”´ 0% | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½å¼·åŒ– |
| **Phase 3** | 11/4-11/7ï¼ˆ4æ—¥ï¼‰ | ğŸ”´ 0% | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– + é€šçŸ¥å®Ÿè£… |
| **Phase 4** | 11/8-11/10ï¼ˆ3æ—¥ï¼‰ | ğŸ”´ 0% | ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ |

**åˆè¨ˆå·¥æ•°**: 11æ—¥ï¼ˆç´„2é€±é–“ï¼‰

---

## âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è¿”ä¿¡ã®ç¢ºèª

### ç¢ºèª-1: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å‚ç…§

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å›ç­”**: âœ… **å•é¡Œãªã—**ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨ã§ååˆ†ï¼‰

**VoiceDriveå´ã®å¯¾å¿œ**:
- âœ… **åˆæ„**ãƒ»ç¶™ç¶šå®Ÿè£…
- Userãƒ†ãƒ¼ãƒ–ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç©æ¥µçš„ã«æ´»ç”¨
- WebhookåŒæœŸï¼ˆemployee.updatedï¼‰ã‚’ç¶™ç¶š

**å®Ÿè£…ä¸è¦**: ã“ã®é …ç›®ã¯æ—¢å­˜å®Ÿè£…ã§å¯¾å¿œæ¸ˆã¿

---

### ç¢ºèª-2: Level 99æ“ä½œå®šç¾©

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å›ç­”**: âœ… **å•é¡Œãªã—**ï¼ˆVoiceDriveç‹¬è‡ªåŸºæº–ã§ååˆ†ï¼‰

**VoiceDriveå´ã®å¯¾å¿œ**:
- âœ… **åˆæ„**ãƒ»ç¶™ç¶šå®Ÿè£…
- Level 99å®šç¾©ã‚’ç¶™ç¶š
  - permissionLevel >= 20ã®æ“ä½œã¯æœ€ä½ã§ã‚‚high
  - SYSTEM_MODE, PERMISSION_LEVEL: critical
  - EMERGENCY, OVERRIDE: high

**å®Ÿè£…ä¸è¦**: ã“ã®é …ç›®ã¯æ—¢å­˜å®Ÿè£…ã§å¯¾å¿œæ¸ˆã¿ï¼ˆAuditService.calculateSeverityï¼‰

---

### ç¢ºèª-3: ç›£æŸ»ãƒ­ã‚°ä¿å­˜æœŸé–“

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å›ç­”**: âœ… **æ°¸ç¶šä¿å­˜**ï¼ˆåŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã€**3å¹´æ¨å¥¨**ï¼ˆVoiceDriveï¼‰

**VoiceDriveå´ã®æ±ºå®š**:

| é …ç›® | VoiceDrive | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  | ç†ç”± |
|------|-----------|------------|------|
| **ä¿å­˜æœŸé–“** | **3å¹´** | æ°¸ç¶šä¿å­˜ | VoiceDriveã¯æ³•ä»¤è¦ä»¶æº–æ‹  |
| **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ™‚æœŸ** | **1å¹´å¾Œ** | 3å¹´å¾Œ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– |
| **å‰Šé™¤æ™‚æœŸ** | **3å¹´å¾Œ** | å‰Šé™¤ã—ãªã„ | æ³•ä»¤è¦ä»¶æº–æ‹  |

**å®Ÿè£…å¿…è¦**: Phase 3ã§å®Ÿè£…

---

### ç¢ºèª-4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé€£æº

**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å›ç­”**: âœ… **æ¨å¥¨å®Ÿæ–½**ï¼ˆcritical, highã®ã¿ã€Slack + ãƒ¡ãƒ¼ãƒ«ï¼‰

**VoiceDriveå´ã®æ±ºå®š**:
- âœ… **å®Ÿæ–½**
- é€šçŸ¥å¯¾è±¡: critical, highã®ã¿
- é€šçŸ¥æ–¹æ³•: Slackï¼ˆå„ªå…ˆï¼‰+ ãƒ¡ãƒ¼ãƒ«ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
- criticalã®å ´åˆã¯äºŒé‡é€šçŸ¥ï¼ˆSlack + ãƒ¡ãƒ¼ãƒ«ï¼‰

**å®Ÿè£…å¿…è¦**: Phase 3ã§å®Ÿè£…

---

## ğŸ¯ Phase 2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½å¼·åŒ–ï¼ˆ10/28-11/1ï¼‰

### ç›®æ¨™
ãƒ­ã‚°æ”¹ã–ã‚“æ¤œçŸ¥ã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã®å®Ÿè£…

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

#### 1. ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆæ©Ÿèƒ½ï¼ˆ1æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AuditService.ts`

**å®Ÿè£…å†…å®¹**:
```typescript
// æ—¢å­˜ã®generateChecksumãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¼·åŒ–
private async generateChecksum(entry: Partial<AuditLog>): Promise<string> {
  // å‰å›ã®ãƒ­ã‚°ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’å–å¾—
  const previousLog = await prisma.auditLog.findFirst({
    orderBy: { createdAt: 'desc' },
    select: { checksum: true }
  });

  const content = JSON.stringify({
    id: entry.id,
    timestamp: entry.createdAt,
    userId: entry.userId,
    action: entry.action,
    entityId: entry.entityId,
    oldValues: entry.oldValues,
    newValues: entry.newValues,
    previousChecksum: previousLog?.checksum || null
  });

  const encoder = new TextEncoder();
  const dataBuffer = encoder.encode(content);
  const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// logActionãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£ã—ã¦DBä¿å­˜æ™‚ã«ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ
async logAction(actionData: {
  userId: string;
  action: string;
  targetId: string;
  details: any;
  executorLevel?: number;
}): Promise<string> {
  const severity = AuditService.calculateSeverityFromAction(
    actionData.action,
    false,
    actionData.executorLevel
  );

  // å‰å›ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ å–å¾—
  const previousLog = await prisma.auditLog.findFirst({
    orderBy: { createdAt: 'desc' },
    select: { checksum: true }
  });

  // ä»®ã‚¨ãƒ³ãƒˆãƒªä½œæˆ
  const tempEntry = {
    id: cuid(),
    userId: actionData.userId,
    action: actionData.action,
    entityType: 'user_action',
    entityId: actionData.targetId,
    oldValues: null,
    newValues: actionData.details,
    createdAt: new Date(),
    previousChecksum: previousLog?.checksum || null
  };

  // ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ
  const checksum = await this.generateChecksum(tempEntry);

  // DBä¿å­˜
  const entry = await prisma.auditLog.create({
    data: {
      ...tempEntry,
      checksum,
      severity,
      isEmergencyAction: actionData.action.includes('EMERGENCY')
    }
  });

  return entry.id;
}
```

**å·¥æ•°**: 1æ—¥

---

#### 2. å®Œå…¨æ€§æ¤œè¨¼æ©Ÿèƒ½ï¼ˆ0.5æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AuditService.ts`

**å®Ÿè£…å†…å®¹**:
```typescript
// æ—¢å­˜ã®verifyAuditIntegrityãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¼·åŒ–
async verifyAuditIntegrity(logId: string): Promise<boolean> {
  const entry = await prisma.auditLog.findUnique({
    where: { id: logId }
  });

  if (!entry || !entry.checksum) {
    return false;
  }

  const expectedChecksum = await this.generateChecksum(entry);
  return entry.checksum === expectedChecksum;
}

// å…¨ãƒ­ã‚°ã®å®Œå…¨æ€§æ¤œè¨¼
async verifyAllAuditIntegrity(): Promise<{
  total: number;
  valid: number;
  invalid: number;
  invalidIds: string[];
}> {
  const logs = await prisma.auditLog.findMany({
    where: { checksum: { not: null } },
    orderBy: { createdAt: 'asc' }
  });

  const invalidIds: string[] = [];

  for (const log of logs) {
    const isValid = await this.verifyAuditIntegrity(log.id);
    if (!isValid) {
      invalidIds.push(log.id);
    }
  }

  return {
    total: logs.length,
    valid: logs.length - invalidIds.length,
    invalid: invalidIds.length,
    invalidIds
  };
}
```

**å·¥æ•°**: 0.5æ—¥

---

#### 3. ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ¤œçŸ¥ï¼ˆ1.5æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AuditMonitorService.ts`ï¼ˆæ–°è¦ï¼‰

**å®Ÿè£…å†…å®¹**:
```typescript
// src/services/AuditMonitorService.ts

import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export class AuditMonitorService {
  // çŸ­æ™‚é–“ã§ã®å¤§é‡æ“ä½œæ¤œçŸ¥
  async detectRapidActions(userId: string): Promise<void> {
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);

    const recentActions = await prisma.auditLog.count({
      where: {
        userId,
        createdAt: { gte: fiveMinutesAgo }
      }
    });

    if (recentActions >= 10) {
      await this.createAlert({
        type: 'suspicious_activity',
        severity: 'high',
        description: `çŸ­æ™‚é–“ã§ã®å¤§é‡æ“ä½œã‚’æ¤œçŸ¥: ${recentActions}ä»¶/5åˆ† by ${userId}`,
        relatedLogs: await this.getRecentLogIds(userId, fiveMinutesAgo)
      });
    }
  }

  // æ·±å¤œã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥
  async detectUnusualHoursAccess(userId: string, timestamp: Date): Promise<void> {
    const hour = timestamp.getHours();

    if (hour >= 22 || hour <= 6) {
      await this.createAlert({
        type: 'access_anomaly',
        severity: 'medium',
        description: `æ·±å¤œã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œçŸ¥: ${hour}æ™‚å° by ${userId}`,
        relatedLogs: await this.getRecentLogIds(userId, timestamp)
      });
    }
  }

  // é«˜æ¨©é™æ“ä½œã®ç•°å¸¸æ¤œçŸ¥
  async detectHighPrivilegeAnomalies(
    userId: string,
    action: string,
    executorLevel: number
  ): Promise<void> {
    if (executorLevel >= 20) {
      if (action.includes('SYSTEM_MODE') || action.includes('PERMISSION_LEVEL')) {
        await this.createAlert({
          type: 'policy_violation',
          severity: 'critical',
          description: `Level 99é‡è¦æ“ä½œã‚’æ¤œçŸ¥: ${action} by ${userId}`,
          relatedLogs: await this.getUserRecentLogs(userId, 10)
        });
      }
    }
  }

  // ã‚¢ãƒ©ãƒ¼ãƒˆä½œæˆ
  private async createAlert(data: {
    type: string;
    severity: string;
    description: string;
    relatedLogs: string[];
  }): Promise<void> {
    await prisma.auditAlert.create({
      data: {
        type: data.type,
        severity: data.severity,
        description: data.description,
        relatedLogs: data.relatedLogs,
        investigationStatus: 'pending'
      }
    });
  }

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
  private async getRecentLogIds(userId: string, since: Date): Promise<string[]> {
    const logs = await prisma.auditLog.findMany({
      where: {
        userId,
        createdAt: { gte: since }
      },
      select: { id: true },
      take: 20
    });

    return logs.map(log => log.id);
  }

  private async getUserRecentLogs(userId: string, limit: number): Promise<string[]> {
    const logs = await prisma.auditLog.findMany({
      where: { userId },
      orderBy: { createdAt: 'desc' },
      select: { id: true },
      take: limit
    });

    return logs.map(log => log.id);
  }
}
```

**å·¥æ•°**: 1.5æ—¥

---

#### 4. AuditServiceã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã‚’DBé€£æºã«å¤‰æ›´ï¼ˆ0.5æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/AuditService.ts`

**å®Ÿè£…å†…å®¹**:
- Mapç®¡ç†ï¼ˆthis.auditLogs, this.auditAlertsï¼‰ã‚’PrismaçµŒç”±ã®DBç®¡ç†ã«å¤‰æ›´
- getRecentLogs, getAuditAlertsç­‰ã‚’Prisma queryã«å¤‰æ›´

**å·¥æ•°**: 0.5æ—¥

---

### Phase 2åˆè¨ˆå·¥æ•°: 3.5æ—¥ â†’ **4æ—¥**ï¼ˆãƒãƒƒãƒ•ã‚¡å«ã‚€ï¼‰

---

## ğŸ¯ Phase 3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– + é€šçŸ¥å®Ÿè£…ï¼ˆ11/4-11/7ï¼‰

### ç›®æ¨™
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½å®Ÿè£…
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥å®Ÿè£…
- æ—¥æ¬¡é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆå®Ÿè£…

### å®Ÿè£…ã‚¿ã‚¹ã‚¯

#### 1. AuditLogArchiveãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆ0.5æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `prisma/schema.prisma`

**å®Ÿè£…å†…å®¹**:
```prisma
model AuditLogArchive {
  id                String   @id
  userId            String
  action            String
  entityType        String
  entityId          String
  oldValues         Json?
  newValues         Json?
  ipAddress         String?
  userAgent         String?
  severity          String?
  checksum          String?
  previousChecksum  String?  @map("previous_checksum")
  executorLevel     Float?   @map("executor_level")
  targetUserId      String?  @map("target_user_id")
  reason            String?
  isEmergencyAction Boolean  @map("is_emergency_action")

  createdAt         DateTime // å…ƒã®ãƒ­ã‚°ä½œæˆæ—¥æ™‚
  archivedAt        DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([archivedAt])
  @@map("audit_logs_archive")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```bash
npx prisma db push
```

**å·¥æ•°**: 0.5æ—¥

---

#### 2. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»å‰Šé™¤ãƒãƒƒãƒå®Ÿè£…ï¼ˆ1æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/jobs/archiveAuditLogs.ts`ï¼ˆæ–°è¦ï¼‰

**å®Ÿè£…å†…å®¹**:
```typescript
// src/jobs/archiveAuditLogs.ts

import { PrismaClient } from '@prisma/client';
import cron from 'node-cron';

const prisma = new PrismaClient();

// 1å¹´çµŒéå¾Œã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
export async function archiveOldAuditLogs() {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

  console.log(`ğŸ—„ï¸  ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡: ${oneYearAgo.toISOString()} ä»¥å‰ã®ãƒ­ã‚°`);

  // 1å¹´ä»¥ä¸Šå‰ã®ãƒ­ã‚°ã‚’å–å¾—
  const oldLogs = await prisma.auditLog.findMany({
    where: {
      createdAt: { lt: oneYearAgo }
    }
  });

  console.log(`  ğŸ“ ${oldLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã™...`);

  if (oldLogs.length === 0) {
    console.log('  âœ¨ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•
  await prisma.auditLogArchive.createMany({
    data: oldLogs.map(log => ({
      ...log,
      archivedAt: new Date()
    }))
  });

  // å…ƒã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
  await prisma.auditLog.deleteMany({
    where: {
      createdAt: { lt: oneYearAgo }
    }
  });

  console.log(`  âœ… ${oldLogs.length}ä»¶ã®ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ`);
}

// 3å¹´çµŒéå¾Œã«å‰Šé™¤
export async function deleteOldArchivedLogs() {
  const threeYearsAgo = new Date();
  threeYearsAgo.setFullYear(threeYearsAgo.getFullYear() - 3);

  console.log(`ğŸ—‘ï¸  å‰Šé™¤å¯¾è±¡: ${threeYearsAgo.toISOString()} ä»¥å‰ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ­ã‚°`);

  const result = await prisma.auditLogArchive.deleteMany({
    where: {
      createdAt: { lt: threeYearsAgo }
    }
  });

  console.log(`  âœ… ${result.count}ä»¶ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
}

// cronè¨­å®šï¼ˆæ¯æœˆ1æ—¥åˆå‰2æ™‚: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
cron.schedule('0 2 1 * *', async () => {
  console.log('\nğŸ“… æœˆæ¬¡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒƒãƒé–‹å§‹...');
  await archiveOldAuditLogs();
});

// cronè¨­å®šï¼ˆæ¯æœˆ1æ—¥åˆå‰3æ™‚: å‰Šé™¤ï¼‰
cron.schedule('0 3 1 * *', async () => {
  console.log('\nğŸ“… æœˆæ¬¡å‰Šé™¤ãƒãƒƒãƒé–‹å§‹...');
  await deleteOldArchivedLogs();
});
```

**å·¥æ•°**: 1æ—¥

---

#### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥å®Ÿè£…ï¼ˆ1.5æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**:
- `src/services/SecurityNotificationService.ts`ï¼ˆæ–°è¦ï¼‰
- `src/services/SlackNotificationService.ts`ï¼ˆæ–°è¦ï¼‰
- `src/services/EmailNotificationService.ts`ï¼ˆæ–°è¦ï¼‰

**å®Ÿè£…å†…å®¹**:

**A. Slacké€šçŸ¥**:
```typescript
// src/services/SlackNotificationService.ts

export async function sendSlackAlert(alert: AuditAlert) {
  const webhookUrl = process.env.MEDICAL_SYSTEM_SLACK_WEBHOOK_URL;

  if (!webhookUrl) {
    console.warn('âš ï¸  Slack Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  const user = await prisma.user.findUnique({
    where: { id: alert.userId },
    select: { name: true, department: true, facilityId: true }
  });

  await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      channel: process.env.SLACK_ALERT_CHANNEL || '#security-alerts',
      username: "VoiceDrive Security Bot",
      icon_emoji: ":rotating_light:",
      attachments: [
        {
          color: alert.severity === 'critical' ? 'danger' : 'warning',
          title: `ğŸš¨ ${alert.type}`,
          fields: [
            { title: 'ç™ºç”Ÿæ™‚åˆ»', value: alert.detectedAt.toLocaleString('ja-JP'), short: true },
            { title: 'é‡è¦åº¦', value: alert.severity.toUpperCase(), short: true },
            { title: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', value: user?.name || 'ä¸æ˜', short: true },
            { title: 'æ–½è¨­', value: user?.facilityId || 'ä¸æ˜', short: true },
            { title: 'è©³ç´°', value: alert.description, short: false }
          ],
          footer: 'VoiceDrive ç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ',
          ts: Math.floor(Date.now() / 1000)
        }
      ]
    })
  });

  console.log(`âœ… Slacké€šçŸ¥é€ä¿¡: ${alert.type} (${alert.severity})`);
}
```

**B. ãƒ¡ãƒ¼ãƒ«é€šçŸ¥**:
```typescript
// src/services/EmailNotificationService.ts

import nodemailer from 'nodemailer';

export async function sendEmailAlert(alert: AuditAlert) {
  const transporter = nodemailer.createTransporter({
    host: process.env.SMTP_HOST,
    port: parseInt(process.env.SMTP_PORT || '587'),
    secure: false,
    auth: {
      user: process.env.SMTP_USER,
      pass: process.env.SMTP_PASS
    }
  });

  const user = await prisma.user.findUnique({
    where: { id: alert.userId },
    select: { name: true, department: true, facilityId: true }
  });

  await transporter.sendMail({
    to: process.env.SECURITY_EMAIL,
    from: 'VoiceDrive Security <noreply@voicedrive.example.com>',
    subject: `ğŸš¨ [VoiceDrive] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ (${alert.severity})`,
    html: `
      <!DOCTYPE html>
      <html>
      <body>
        <h2>ğŸš¨ VoiceDrive ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
        <table style="border-collapse: collapse; width: 100%;">
          <tr><th>ã‚¢ãƒ©ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</th><td>${alert.type}</td></tr>
          <tr><th>é‡è¦åº¦</th><td><strong>${alert.severity.toUpperCase()}</strong></td></tr>
          <tr><th>ç™ºç”Ÿæ™‚åˆ»</th><td>${alert.detectedAt.toLocaleString('ja-JP')}</td></tr>
          <tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><td>${user?.name || 'ä¸æ˜'}</td></tr>
          <tr><th>æ–½è¨­</th><td>${user?.facilityId || 'ä¸æ˜'}</td></tr>
          <tr><th>è©³ç´°</th><td>${alert.description}</td></tr>
        </table>
        <hr>
        <p>ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯VoiceDriveç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è‡ªå‹•é€ä¿¡ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
      </body>
      </html>
    `
  });

  console.log(`âœ… ãƒ¡ãƒ¼ãƒ«é€šçŸ¥é€ä¿¡: ${alert.type} (${alert.severity})`);
}
```

**C. çµ±åˆé€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹**:
```typescript
// src/services/SecurityNotificationService.ts

export async function notifySecurityIncident(alert: AuditAlert) {
  // critical, highã®ã¿é€šçŸ¥
  if (alert.severity !== 'critical' && alert.severity !== 'high') {
    return;
  }

  // Slacké€šçŸ¥ï¼ˆå„ªå…ˆï¼‰
  try {
    await sendSlackAlert(alert);
  } catch (error) {
    console.error(`âŒ Slacké€šçŸ¥å¤±æ•—: ${error}`);
    // Slackå¤±æ•—æ™‚ã¯ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥
    await sendEmailAlert(alert);
  }

  // criticalã®å ´åˆã¯ãƒ¡ãƒ¼ãƒ«ã‚‚é€ä¿¡ï¼ˆäºŒé‡é€šçŸ¥ï¼‰
  if (alert.severity === 'critical') {
    try {
      await sendEmailAlert(alert);
    } catch (error) {
      console.error(`âŒ ãƒ¡ãƒ¼ãƒ«é€šçŸ¥å¤±æ•—: ${error}`);
    }
  }
}
```

**å·¥æ•°**: 1.5æ—¥

---

#### 4. æ—¥æ¬¡é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆå®Ÿè£…ï¼ˆ1æ—¥ï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `src/jobs/calculateAuditSummary.ts`ï¼ˆæ–°è¦ï¼‰

**å®Ÿè£…å†…å®¹**: åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ è¿”ä¿¡ã®å®Ÿè£…ä¾‹ã‚’å‚è€ƒã«å®Ÿè£…

**å·¥æ•°**: 1æ—¥

---

### Phase 3åˆè¨ˆå·¥æ•°: 4æ—¥

---

## ğŸ¯ Phase 4: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ï¼ˆ11/8-11/10ï¼‰

### ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯

#### 1. ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆ0.5æ—¥ï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆã®æ­£ç¢ºæ€§ç¢ºèª
- ãƒ­ã‚°æ”¹ã–ã‚“æ¤œçŸ¥ã®å‹•ä½œç¢ºèª
- å®Œå…¨æ€§æ¤œè¨¼ã®ç²¾åº¦ç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
```bash
npx tsx scripts/test-checksum-integrity.ts
```

---

#### 2. ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆ0.5æ—¥ï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- çŸ­æ™‚é–“å¤§é‡æ“ä½œæ¤œçŸ¥
- æ·±å¤œã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥
- Level 99æ“ä½œæ¤œçŸ¥

**ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
```bash
npx tsx scripts/test-alert-detection.ts
```

---

#### 3. é€šçŸ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆ1æ—¥ï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- Slacké€šçŸ¥ã®é€ä¿¡ç¢ºèª
- ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®é€ä¿¡ç¢ºèª
- äºŒé‡é€šçŸ¥ã®ç¢ºèªï¼ˆcriticalï¼‰

**ãƒ†ã‚¹ãƒˆæ‰‹é †**:
1. åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã‹ã‚‰Webhook URLå—é ˜
2. ç’°å¢ƒå¤‰æ•°è¨­å®š
3. ãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡
4. åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã§å—ä¿¡ç¢ºèª

---

#### 4. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»å‰Šé™¤ãƒ†ã‚¹ãƒˆï¼ˆ0.5æ—¥ï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- 1å¹´çµŒéãƒ­ã‚°ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç¢ºèª
- 3å¹´çµŒéãƒ­ã‚°ã®å‰Šé™¤ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª

**ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**:
```bash
npx tsx scripts/test-archive-process.ts
```

---

#### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ0.5æ—¥ï¼‰

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- 100ä¸‡ãƒ­ã‚°æƒ³å®šã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é€Ÿåº¦ç¢ºèª
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª

---

### Phase 4åˆè¨ˆå·¥æ•°: 3æ—¥

---

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæœ€çµ‚ç‰ˆï¼‰

| Phase | æœŸé–“ | å·¥æ•° | ä¸»è¦ã‚¿ã‚¹ã‚¯ |
|-------|------|------|----------|
| **Phase 1** | 10/27 | 1æ—¥ | âœ… severityè¿½åŠ ã€ã‚¹ã‚­ãƒ¼ãƒæ›´æ–° |
| **Phase 2** | 10/28-10/31 | 4æ—¥ | ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã€ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ |
| **Phase 3** | 11/1-11/4 | 4æ—¥ | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã€é€šçŸ¥ã€æ—¥æ¬¡é›†è¨ˆ |
| **Phase 4** | 11/5-11/7 | 3æ—¥ | ãƒ†ã‚¹ãƒˆã€èª¿æ•´ |
| **ç›£è¦–æœŸé–“** | 11/8-11/14 | 7æ—¥ | æœ¬ç•ªé‹ç”¨ãƒ»èª¤æ¤œçŸ¥èª¿æ•´ |

**åˆè¨ˆå·¥æ•°**: 12æ—¥ï¼ˆå®Ÿè£…ï¼‰ + 7æ—¥ï¼ˆç›£è¦–ï¼‰= **ç´„3é€±é–“**

---

## âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã¸ã®ä¾é ¼äº‹é …

### ä¾é ¼-1: Slack Webhook URLç™ºè¡Œ

**æœŸæ—¥**: 2025å¹´10æœˆ28æ—¥ï¼ˆæ˜æ—¥ï¼‰

**å†…å®¹**:
1. Slack Incoming Webhook URLã®ç™ºè¡Œ
2. ãƒãƒ£ãƒ³ãƒãƒ«å: `#security-alerts`ï¼ˆæ¨å¥¨ï¼‰
3. URLã‚’VoiceDriveãƒãƒ¼ãƒ ã¸å…±æœ‰

**å…±æœ‰æ–¹æ³•**:
```bash
# mcp-shared/logs/ çµŒç”±
echo "SLACK_WEBHOOK_URL=https://hooks.slack.com/services/..." > mcp-shared/logs/slack-webhook-url.txt
```

---

### ä¾é ¼-2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¨­å®š

**æœŸæ—¥**: 2025å¹´10æœˆ28æ—¥ï¼ˆæ˜æ—¥ï¼‰

**å†…å®¹**:
1. ãƒ¡ãƒ¼ãƒªãƒ³ã‚°ãƒªã‚¹ãƒˆä½œæˆ: `security-team@medical-system.example.com`
2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç™»éŒ²
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’VoiceDriveãƒãƒ¼ãƒ ã¸å…±æœ‰

---

### ä¾é ¼-3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼ç­–å®š

**æœŸæ—¥**: 2025å¹´11æœˆ1æ—¥

**å†…å®¹**:
1. é€šçŸ¥å—ä¿¡å¾Œã®å¯¾å¿œæ‰‹é †æ›¸ä½œæˆ
2. ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åŸºæº–ã®ç­–å®š
3. å¯¾å¿œè²¬ä»»è€…ã®æ˜ç¢ºåŒ–

---

## ğŸ“ ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆVoiceDriveå´ï¼‰

### å¿…è¦ãªç’°å¢ƒå¤‰æ•°

```env
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ 

# Slacké€šçŸ¥è¨­å®š
MEDICAL_SYSTEM_SLACK_WEBHOOK_URL=https://hooks.slack.com/services/... # åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å—é ˜
SLACK_ALERT_CHANNEL=#security-alerts

# ãƒ¡ãƒ¼ãƒ«é€šçŸ¥è¨­å®š
SECURITY_EMAIL=security-team@medical-system.example.com # åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å—é ˜

# SMTPè¨­å®šï¼ˆGmailæ¨å¥¨ï¼‰
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=voicedrive-alerts@example.com
SMTP_PASS=your-app-password # Gmailã‚¢ãƒ—ãƒªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

# ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¨­å®š
ARCHIVE_AFTER_YEARS=1  # 1å¹´å¾Œã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
DELETE_AFTER_YEARS=3   # 3å¹´å¾Œã«å‰Šé™¤
```

---

## ğŸ”— ã¾ã¨ã‚

### å®Ÿè£…å®Œäº†å¾Œã®æ©Ÿèƒ½

| æ©Ÿèƒ½ | Phase | çŠ¶æ…‹ |
|------|-------|------|
| é‡è¦åº¦åˆ†é¡ | Phase 1 | âœ… å®Œäº† |
| ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ | Phase 2 | ğŸ”´ æœªå®Ÿè£… |
| å®Œå…¨æ€§æ¤œè¨¼ | Phase 2 | ğŸ”´ æœªå®Ÿè£… |
| ã‚¢ãƒ©ãƒ¼ãƒˆæ¤œçŸ¥ | Phase 2 | ğŸ”´ æœªå®Ÿè£… |
| ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | Phase 3 | ğŸ”´ æœªå®Ÿè£… |
| é€šçŸ¥ï¼ˆSlack/ãƒ¡ãƒ¼ãƒ«ï¼‰ | Phase 3 | ğŸ”´ æœªå®Ÿè£… |
| æ—¥æ¬¡é›†è¨ˆ | Phase 3 | ğŸ”´ æœªå®Ÿè£… |

### æœ€çµ‚æˆæœç‰©

- âœ… å®Œå…¨ãªç›£æŸ»ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
- âœ… ãƒ­ã‚°æ”¹ã–ã‚“æ¤œçŸ¥æ©Ÿèƒ½
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
- âœ… åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€šçŸ¥é€£æº
- âœ… 3å¹´é–“ã®ç›£æŸ»è¨¼è·¡ä¿å­˜
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

---

**æ–‡æ›¸çµ‚äº†**

æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ27æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0
æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼: Phase 2é–‹å§‹æ™‚ï¼ˆ2025å¹´10æœˆ28æ—¥ï¼‰
