# mode-switcherï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰ç®¡ç†ï¼‰ãƒšãƒ¼ã‚¸ - DBè¦ä»¶åˆ†æ

**æ–‡æ›¸ç•ªå·**: MS-DB-REQ-2025-1021-001
**ä½œæˆæ—¥**: 2025å¹´10æœˆ21æ—¥
**ä½œæˆè€…**: VoiceDriveé–‹ç™ºãƒãƒ¼ãƒ 
**å¯¾è±¡ãƒšãƒ¼ã‚¸**: https://voicedrive-v100.vercel.app/mode-switcher
**åˆ†æåŸºæº–**: ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹å®šç¾©æ›¸ (DM-DEF-2025-1008-001)

---

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### ãƒšãƒ¼ã‚¸æ¦‚è¦
**ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰ç®¡ç†ï¼ˆModeSwitcherï¼‰ãƒšãƒ¼ã‚¸**ã¯ã€ãƒ¬ãƒ™ãƒ«99ï¼ˆã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼‰å°‚ç”¨ã®ãƒšãƒ¼ã‚¸ã§ã‚ã‚Šã€VoiceDriveã®ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å‹•ä½œãƒ¢ãƒ¼ãƒ‰ã‚’**è­°é¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆAGENDA_MODEï¼‰**ã¨**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰ï¼ˆPROJECT_MODEï¼‰**ã®é–“ã§åˆ‡ã‚Šæ›¿ãˆã‚‹ç®¡ç†ç”»é¢ã§ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½
1. **ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º** - è­°é¡Œãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤º
2. **ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå®Ÿè¡Œ** - ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ã‚ˆã‚‹å…¨ç¤¾çš„ãªãƒ¢ãƒ¼ãƒ‰å¤‰æ›´
3. **ç§»è¡Œæº–å‚™çŠ¶æ³è¡¨ç¤º** - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰ã¸ã®ç§»è¡Œæº–å‚™ã®é€²æ—ç¢ºèª
4. **çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰** - æœˆé–“æŠ•ç¨¿æ•°ã€å§”å“¡ä¼šæå‡ºæ•°ã€è·å“¡å‚åŠ ç‡ã®è¡¨ç¤º
5. **ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²** - ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ“ä½œã®è¨˜éŒ²

### ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»ã®çµè«–

| ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒª | VoiceDrive | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ  | åˆ¤å®šç†ç”± |
|--------------|-----------|-------------|---------|
| ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š | âœ… **ãƒã‚¹ã‚¿** | âŒ | VoiceDriveå†…éƒ¨ã®å‹•ä½œåˆ¶å¾¡ |
| ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´å±¥æ­´ | âœ… **ãƒã‚¹ã‚¿** | âŒ | ç›£æŸ»ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ² |
| ç§»è¡Œæº–å‚™çµ±è¨ˆï¼ˆæŠ•ç¨¿æ•°ãƒ»å§”å“¡ä¼šæå‡ºæ•°ï¼‰ | âœ… **ãƒã‚¹ã‚¿** | âŒ | Postãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç®—å‡º |
| è·å“¡å‚åŠ ç‡ï¼ˆlastLoginAtï¼‰ | âœ… **ãƒã‚¹ã‚¿** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | Userãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç®—å‡º |
| ç·è·å“¡æ•° | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… **ãƒã‚¹ã‚¿** | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åŒæœŸ |

**é‡è¦ãªç™ºè¦‹**:
- ã“ã®ãƒšãƒ¼ã‚¸ã¯**100% VoiceDriveå†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã®ã¿**ã§å‹•ä½œ
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¸ã®APIå‘¼ã³å‡ºã—ã¯ä¸è¦
- ãŸã ã—ã€çµ±è¨ˆè¨ˆç®—ã®ãŸã‚ã«DBæ°¸ç¶šåŒ–ãŒå¿…è¦ï¼ˆç¾åœ¨ã¯LocalStorageã®ã¿ï¼‰

---

## ğŸ¯ ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ã®è©³ç´°åˆ†æ

### 1. ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º

**è¡¨ç¤ºå†…å®¹**:
- ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰åï¼ˆè­°é¡Œãƒ¢ãƒ¼ãƒ‰ / ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰
- ãƒ¢ãƒ¼ãƒ‰èª¬æ˜æ–‡
- ãƒ¢ãƒ¼ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³

**ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**:
```typescript
// systemMode.ts (L68-83)
getCurrentMode(): SystemMode {
  const savedConfig = localStorage.getItem('voicedrive_system_mode');
  if (savedConfig) {
    const config: SystemModeConfig = JSON.parse(savedConfig);
    return config.mode;
  }
  return SystemMode.AGENDA; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}
```

**ç¾çŠ¶**: LocalStorageã®ã¿
**å¿…è¦ãªæ”¹å–„**: **SystemConfig** ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ°¸ç¶šåŒ–

---

### 2. ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¬ãƒ™ãƒ«99æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆ`user.permissionLevel === 99`ï¼‰
2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
3. `systemModeManager.setMode(targetMode, user)` å®Ÿè¡Œ
4. ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ï¼ˆ`AuditService.log()`ï¼‰
5. LocalStorageã«ä¿å­˜
6. ç”»é¢æ›´æ–°

**ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**:
```typescript
// systemMode.ts (L132-172)
async setMode(mode: SystemMode, adminUser: User): Promise<void> {
  // æ¨©é™ãƒã‚§ãƒƒã‚¯
  if (adminUser.permissionLevel !== 99) {
    throw new Error('ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ï¼ˆãƒ¬ãƒ™ãƒ«99ï¼‰ã®ã¿ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´å¯èƒ½ã§ã™');
  }

  const config: SystemModeConfig = {
    mode,
    enabledAt: new Date(),
    enabledBy: adminUser.id,
    description: ...,
    migrationStatus: 'in_progress'
  };

  // LocalStorageã«ä¿å­˜
  localStorage.setItem('voicedrive_system_mode', JSON.stringify(config));

  // TODO: Prismaã§system_configãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
}
```

**ç¾çŠ¶**: LocalStorageã®ã¿
**å¿…è¦ãªæ”¹å–„**:
- **SystemConfig** ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ°¸ç¶šåŒ–
- **AuditLog** ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

---

### 3. ç§»è¡Œæº–å‚™çŠ¶æ³ã®çµ±è¨ˆè¡¨ç¤º

**è¡¨ç¤ºçµ±è¨ˆ**:

| çµ±è¨ˆé …ç›® | ç›®æ¨™å€¤ | è¨ˆç®—æ–¹æ³• | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ |
|---------|-------|---------|-------------|
| **æœˆé–“æŠ•ç¨¿æ•°** | 30ä»¶ | éå»1ãƒ¶æœˆã®Postä»¶æ•° | `Post.createdAt >= oneMonthAgo` |
| **å§”å“¡ä¼šæå‡ºæ•°** | 10ä»¶ | ã‚¹ã‚³ã‚¢100ç‚¹ä»¥ä¸Šã®æŠ•ç¨¿ä»¶æ•° | `Post.score >= 100 AND createdAt >= oneMonthAgo` |
| **è·å“¡å‚åŠ ç‡** | 60% | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ / ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼ | `User.lastLoginAt >= oneMonthAgo` |
| **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°** | - | æœˆé–“1å›ä»¥ä¸Šãƒ­ã‚°ã‚¤ãƒ³ | `User.lastLoginAt >= oneMonthAgo` |
| **ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°** | - | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | `User.count()` |

**ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**:
```typescript
// SystemModeStatsService.ts (L48-97)
async getMigrationStats(): Promise<MigrationStats> {
  // TODO: æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã®Prismaã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨
  /*
  const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

  // æœˆé–“æŠ•ç¨¿æ•°
  const monthlyPosts = await prisma.post.count({
    where: { createdAt: { gte: oneMonthAgo } }
  });

  // å§”å“¡ä¼šæå‡ºæ•°ï¼ˆã‚¹ã‚³ã‚¢100ç‚¹ä»¥ä¸Šï¼‰
  const committeeSubmissions = await prisma.post.count({
    where: {
      score: { gte: 100 },
      createdAt: { gte: oneMonthAgo }
    }
  });

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const activeUsers = await prisma.user.count({
    where: { lastLoginAt: { gte: oneMonthAgo } }
  });

  // ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const totalUsers = await prisma.user.count();
  */

  // ç¾çŠ¶: ãƒ‡ãƒ¢ç”¨ã®LocalStorageãƒ‡ãƒ¼ã‚¿
  return this.getDemoStats();
}
```

**ç¾çŠ¶**: ãƒ‡ãƒ¢ç”¨ã®LocalStorageãƒ‡ãƒ¼ã‚¿
**å¿…è¦ãªæ”¹å–„**: Prismaã‚¯ã‚¨ãƒªå®Ÿè£…

---

### 4. ç§»è¡Œæº–å‚™åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

**åˆ¤å®šåŸºæº–**:
```typescript
// SystemModeStatsService.ts (L123-172)
async checkMigrationReadiness(): Promise<MigrationReadiness> {
  const stats = await this.getMigrationStats();

  const postsProgress = (stats.monthlyPosts / 30) * 100;
  const submissionsProgress = (stats.committeeSubmissions / 10) * 100;
  const participationProgress = (stats.participationRate / 60) * 100;

  const overallProgress = Math.round(
    postsProgress * 0.4 +
    submissionsProgress * 0.3 +
    participationProgress * 0.3
  );

  const isReady =
    stats.monthlyPosts >= 30 &&
    stats.committeeSubmissions >= 10 &&
    stats.participationRate >= 60;

  return {
    isReady,
    progress: overallProgress,
    message: isReady ? 'âœ… æº–å‚™å®Œäº†' : 'â³ æº–å‚™ä¸­',
    details: { ... }
  };
}
```

**é‡ã¿ä»˜ã‘**:
- æœˆé–“æŠ•ç¨¿æ•°: 40%
- å§”å“¡ä¼šæå‡ºæ•°: 30%
- è·å“¡å‚åŠ ç‡: 30%

---

## ğŸ“Š å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†æ

### âŒ ä¸è¶³ãƒ†ãƒ¼ãƒ–ãƒ«1: SystemConfig

**ç›®çš„**: ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­å®šã®æ°¸ç¶šåŒ–

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ | ä¾‹ |
|-----------|---|------|---|
| id | String (cuid) | ä¸»ã‚­ãƒ¼ | ckxyz123... |
| configKey | String (unique) | è¨­å®šã‚­ãƒ¼ | "system_mode" |
| configValue | Json | è¨­å®šå€¤ï¼ˆJSONï¼‰ | `{"mode": "AGENDA_MODE", ...}` |
| category | String | ã‚«ãƒ†ã‚´ãƒª | "system" / "feature" / "ui" |
| description | String? | èª¬æ˜ | "ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š" |
| isActive | Boolean | æœ‰åŠ¹ãƒ•ãƒ©ã‚° | true |
| updatedBy | String | æ›´æ–°è€…ID | "user_123" |
| createdAt | DateTime | ä½œæˆæ—¥æ™‚ | 2025-10-21T10:00:00Z |
| updatedAt | DateTime | æ›´æ–°æ—¥æ™‚ | 2025-10-21T15:30:00Z |

**ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**:
```prisma
model SystemConfig {
  id          String   @id @default(cuid())
  configKey   String   @unique
  configValue Json
  category    String   // "system", "feature", "ui"
  description String?
  isActive    Boolean  @default(true)
  updatedBy   String
  updatedByUser User   @relation("SystemConfigUpdater", fields: [updatedBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([configKey])
  @@index([category])
  @@index([updatedAt])
  @@map("system_configs")
}
```

**ä½¿ç”¨ä¾‹**:
```typescript
// ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰ä¿å­˜
await prisma.systemConfig.upsert({
  where: { configKey: 'system_mode' },
  update: {
    configValue: {
      mode: 'PROJECT_MODE',
      enabledAt: new Date(),
      enabledBy: 'user_123',
      description: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰',
      migrationStatus: 'completed'
    },
    updatedBy: 'user_123'
  },
  create: {
    configKey: 'system_mode',
    configValue: { ... },
    category: 'system',
    description: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š',
    updatedBy: 'user_123'
  }
});
```

---

### âœ… æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª: AuditLog

**ç›®çš„**: ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã®ç›£æŸ»è¨˜éŒ²

**ç¢ºèª**: `schema.prisma`ã®æ—¢å­˜AuditLogãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ :

```prisma
model AuditLog {
  id                String   @id @default(cuid())
  userId            String
  action            String   // "SYSTEM_MODE_CHANGED"
  entityType        String
  entityId          String
  oldValues         Json?    // å¤‰æ›´å‰ã®å€¤
  newValues         Json?    // å¤‰æ›´å¾Œã®å€¤
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())
  executorLevel     Float?
  targetUserId      String?
  reason            String?
  isEmergencyAction Boolean  @default(false)
  syncPending       Boolean  @default(false)
  user              User     @relation(fields: [userId], references: [id])

  @@index([action, isEmergencyAction])
  @@index([targetUserId])
}
```

**ä½¿ç”¨ä¾‹**:
```typescript
// ModeSwitcherPage.tsx ã§ã®ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´è¨˜éŒ²
await prisma.auditLog.create({
  data: {
    userId: user.id,
    action: 'SYSTEM_MODE_CHANGED',
    entityType: 'SystemConfig',
    entityId: 'system_mode',
    oldValues: { mode: 'AGENDA_MODE' },
    newValues: { mode: 'PROJECT_MODE' },
    executorLevel: user.permissionLevel,
    isEmergencyAction: false
  }
});
```

---

### âœ… æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª: Post

**ç›®çš„**: ç§»è¡Œæº–å‚™çµ±è¨ˆã®è¨ˆç®—

**å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `createdAt`: æœˆé–“é›†è¨ˆç”¨
- `score`: å§”å“¡ä¼šæå‡ºåˆ¤å®šç”¨ï¼ˆ100ç‚¹ä»¥ä¸Šï¼‰

**ã‚¯ã‚¨ãƒªä¾‹**:
```typescript
// æœˆé–“æŠ•ç¨¿æ•°
const monthlyPosts = await prisma.post.count({
  where: {
    createdAt: {
      gte: new Date(new Date().setMonth(new Date().getMonth() - 1))
    }
  }
});

// å§”å“¡ä¼šæå‡ºæ•°
const committeeSubmissions = await prisma.post.count({
  where: {
    score: { gte: 100 },
    createdAt: { gte: oneMonthAgo }
  }
});
```

**æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```prisma
model Post {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  @@index([createdAt])
  @@index([score, createdAt]) // å§”å“¡ä¼šæå‡ºæ•°ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
}
```

---

### âœ… æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª: User

**ç›®çš„**: è·å“¡å‚åŠ ç‡ã®è¨ˆç®—

**å¿…è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `lastLoginAt`: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¤å®šç”¨
- `permissionLevel`: ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…æ¨©é™ãƒã‚§ãƒƒã‚¯ç”¨ï¼ˆ99ï¼‰

**ã‚¯ã‚¨ãƒªä¾‹**:
```typescript
// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
const activeUsers = await prisma.user.count({
  where: {
    lastLoginAt: {
      gte: new Date(new Date().setMonth(new Date().getMonth() - 1))
    }
  }
});

// ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
const totalUsers = await prisma.user.count();

// å‚åŠ ç‡
const participationRate = (activeUsers / totalUsers) * 100;
```

**æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
```prisma
model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  @@index([lastLoginAt])
  @@index([permissionLevel])
}
```

---

## ğŸ” ãƒ‡ãƒ¼ã‚¿ç®¡ç†è²¬ä»»åˆ†ç•Œç‚¹ã®é©ç”¨

### ã‚«ãƒ†ã‚´ãƒªåˆ†é¡

#### âœ… VoiceDrive 100%ç®¡è½„
| ãƒ‡ãƒ¼ã‚¿é …ç›® | ãƒ†ãƒ¼ãƒ–ãƒ« | ç†ç”± |
|-----------|---------|------|
| ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š | SystemConfig | VoiceDriveå†…éƒ¨ã®å‹•ä½œåˆ¶å¾¡ |
| ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´å±¥æ­´ | AuditLog | ç›£æŸ»ãƒ­ã‚° |
| æœˆé–“æŠ•ç¨¿æ•° | Post | VoiceDriveæ´»å‹•ãƒ‡ãƒ¼ã‚¿ |
| å§”å“¡ä¼šæå‡ºæ•° | Post | VoiceDriveæ´»å‹•ãƒ‡ãƒ¼ã‚¿ |
| ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | User | ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã¯VoiceDriveç®¡ç† |

#### âš ï¸ åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åŒæœŸï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
| ãƒ‡ãƒ¼ã‚¿é …ç›® | ãƒ†ãƒ¼ãƒ–ãƒ« | ç†ç”± |
|-----------|---------|------|
| ç·è·å“¡æ•° | User | åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã®Employeeãƒ†ãƒ¼ãƒ–ãƒ«ãŒçœŸå®Ÿã®æƒ…å ±æº |
| è·å“¡åŸºæœ¬æƒ…å ± | User | æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ç­‰ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |

---

## ğŸ“ ä¸è¶³é …ç›®ã®æ´—ã„å‡ºã—

### âŒ ä¸è¶³ãƒ†ãƒ¼ãƒ–ãƒ«

#### 1. SystemConfig ãƒ†ãƒ¼ãƒ–ãƒ«
**å„ªå…ˆåº¦**: ğŸ”´ **æœ€é‡è¦**

**ç†ç”±**:
- ç¾åœ¨ã¯LocalStorageã®ã¿ã§ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã§è¨­å®šãŒå¤±ã‚ã‚Œã‚‹
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å½±éŸ¿ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“è¨­å®šã§ã‚ã‚‹ãŸã‚ã€DBæ°¸ç¶šåŒ–ãŒå¿…é ˆ
- ç›£æŸ»æ€§ã®è¦³ç‚¹ã‹ã‚‰ã€è¨­å®šå¤‰æ›´å±¥æ­´ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã§ãã‚‹å¿…è¦ãŒã‚ã‚‹

**å½±éŸ¿ç¯„å›²**:
- ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®æ°¸ç¶šåŒ–
- ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´å±¥æ­´ã®è¿½è·¡
- ä»–ã‚¿ãƒ–ãƒ»ä»–ãƒ‡ãƒã‚¤ã‚¹ã§ã®è¨­å®šåŒæœŸ

**å®Ÿè£…å„ªå…ˆåº¦**: Phase 1ï¼ˆå³æ™‚å®Ÿè£…ï¼‰

---

### âœ… æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã§å¯¾å¿œå¯èƒ½

#### 1. AuditLog ãƒ†ãƒ¼ãƒ–ãƒ«
**ç¢ºèªé …ç›®**:
- âœ… `schema.prisma`ã«æ—¢å­˜ã®AuditLogãƒ†ãƒ¼ãƒ–ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- âœ… ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ“ä½œã‚’è¨˜éŒ²ã§ãã‚‹æ§‹é€ 

**ä½¿ç”¨æ–¹æ³•**:
- `action`: "SYSTEM_MODE_CHANGED"
- `oldValues`: å¤‰æ›´å‰ã®ãƒ¢ãƒ¼ãƒ‰æƒ…å ±
- `newValues`: å¤‰æ›´å¾Œã®ãƒ¢ãƒ¼ãƒ‰æƒ…å ±
- `executorLevel`: å¤‰æ›´è€…ã®æ¨©é™ãƒ¬ãƒ™ãƒ«

---

#### 2. Post ãƒ†ãƒ¼ãƒ–ãƒ«
**ç¢ºèªé …ç›®**:
- âœ… `createdAt` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨
- âœ… `score` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨

**æ¨å¥¨æ”¹å–„**:
```prisma
model Post {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  @@index([createdAt])
  @@index([score, createdAt]) // å§”å“¡ä¼šæå‡ºæ•°ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
}
```

---

#### 3. User ãƒ†ãƒ¼ãƒ–ãƒ«
**ç¢ºèªé …ç›®**:
- âœ… `lastLoginAt` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨
- âœ… `permissionLevel` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨

**æ¨å¥¨æ”¹å–„**:
```prisma
model User {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

  @@index([lastLoginAt])
  @@index([permissionLevel])
}
```

---

## ğŸ”„ åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æº

### âŒ åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ APIä¸è¦

**çµè«–**: mode-switcherãƒšãƒ¼ã‚¸ã¯**åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºãŒä¸€åˆ‡ä¸è¦**

**ç†ç”±**:
1. ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®šã¯VoiceDriveå†…éƒ¨ã®å‹•ä½œåˆ¶å¾¡
2. ç§»è¡Œæº–å‚™çµ±è¨ˆã¯VoiceDriveã®Post/Userãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ã§ç®—å‡ºå¯èƒ½
3. ç·è·å“¡æ•°ã¯æ—¢ã«Userãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦ã„ã‚‹

### âœ… VoiceDriveå†…éƒ¨ã§å®Œçµ

**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**:
```
ModeSwitcherPage
  â†“
systemModeManager.setMode()
  â†“
SystemConfig ãƒ†ãƒ¼ãƒ–ãƒ«ä¿å­˜
  â†“
AuditLog ãƒ†ãƒ¼ãƒ–ãƒ«è¨˜éŒ²
  â†“
LocalStorageæ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  â†“
å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åæ˜ 
```

---

## ğŸ“‹ å®Ÿè£…æ¨å¥¨äº‹é …

### Phase 1: ç·Šæ€¥å¯¾å¿œï¼ˆ1-2æ—¥ï¼‰

#### âœ… SystemConfig ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
```prisma
model SystemConfig {
  id          String   @id @default(cuid())
  configKey   String   @unique
  configValue Json
  category    String
  description String?
  isActive    Boolean  @default(true)
  updatedBy   String
  updatedByUser User   @relation("SystemConfigUpdater", fields: [updatedBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([configKey])
  @@index([category])
  @@index([updatedAt])
  @@map("system_configs")
}
```

#### âœ… systemMode.ts ä¿®æ­£
```typescript
private async saveModeConfig(config: SystemModeConfig): Promise<void> {
  // LocalStorageã«ä¿å­˜
  localStorage.setItem('voicedrive_system_mode', JSON.stringify(config));

  // ğŸ†• Prismaã§æ°¸ç¶šåŒ–
  await prisma.systemConfig.upsert({
    where: { configKey: 'system_mode' },
    update: {
      configValue: config,
      updatedBy: config.enabledBy
    },
    create: {
      configKey: 'system_mode',
      configValue: config,
      category: 'system',
      description: 'ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆè­°é¡Œãƒ¢ãƒ¼ãƒ‰/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰',
      updatedBy: config.enabledBy
    }
  });
}
```

#### âœ… AuditLog è¨˜éŒ²å®Ÿè£…
```typescript
// ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ç›£æŸ»ãƒ­ã‚°
await prisma.auditLog.create({
  data: {
    userId: user.id,
    action: 'SYSTEM_MODE_CHANGED',
    entityType: 'SystemConfig',
    entityId: 'system_mode',
    oldValues: { mode: previousMode },
    newValues: { mode: newMode },
    executorLevel: user.permissionLevel,
    isEmergencyAction: false
  }
});
```

---

### Phase 2: çµ±è¨ˆæ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆ3-5æ—¥ï¼‰

#### âœ… SystemModeStatsService å®Ÿè£…
```typescript
async getMigrationStats(): Promise<MigrationStats> {
  const oneMonthAgo = new Date();
  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

  // æœˆé–“æŠ•ç¨¿æ•°
  const monthlyPosts = await prisma.post.count({
    where: { createdAt: { gte: oneMonthAgo } }
  });

  // å§”å“¡ä¼šæå‡ºæ•°
  const committeeSubmissions = await prisma.post.count({
    where: {
      score: { gte: 100 },
      createdAt: { gte: oneMonthAgo }
    }
  });

  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const activeUsers = await prisma.user.count({
    where: { lastLoginAt: { gte: oneMonthAgo } }
  });

  // ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
  const totalUsers = await prisma.user.count();

  const participationRate = totalUsers > 0
    ? (activeUsers / totalUsers) * 100
    : 0;

  return {
    monthlyPosts,
    committeeSubmissions,
    participationRate,
    activeUsers,
    totalUsers
  };
}
```

#### âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
```prisma
// Post ãƒ†ãƒ¼ãƒ–ãƒ«
@@index([score, createdAt]) // å§”å“¡ä¼šæå‡ºæ•°ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–

// User ãƒ†ãƒ¼ãƒ–ãƒ«
@@index([lastLoginAt]) // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
```

---

### Phase 3: ç›£è¦–ãƒ»é‹ç”¨æ”¹å–„ï¼ˆ1é€±é–“ï¼‰

#### âœ… çµ±è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
- çµ±è¨ˆè¨ˆç®—çµæœã‚’ä¸€å®šæœŸé–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ1æ™‚é–“ç¨‹åº¦ï¼‰
- é »ç¹ãªé›†è¨ˆã‚¯ã‚¨ãƒªã«ã‚ˆã‚‹DBè² è·è»½æ¸›

#### âœ… ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´é€šçŸ¥æ©Ÿèƒ½
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã‚’é€šçŸ¥
- WebSocket ã¾ãŸã¯ Server-Sent Events ã§å³æ™‚åæ˜ 

#### âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
- ãƒ¢ãƒ¼ãƒ‰å¤‰æ›´ã®å–ã‚Šæ¶ˆã—æ©Ÿèƒ½
- å¤‰æ›´å±¥æ­´ã‹ã‚‰ã®å¾©å…ƒ

---

## ğŸ¯ å„ªå…ˆåº¦ã¾ã¨ã‚

| é …ç›® | å„ªå…ˆåº¦ | å·¥æ•° | ç†ç”± |
|-----|-------|------|------|
| SystemConfig ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | ğŸ”´ æœ€é‡è¦ | 0.5æ—¥ | è¨­å®šæ°¸ç¶šåŒ–ã®åŸºç›¤ |
| systemMode.ts ã®DBæ°¸ç¶šåŒ–å®Ÿè£… | ğŸ”´ æœ€é‡è¦ | 0.5æ—¥ | LocalStorageã‹ã‚‰ã®è„±å´ |
| AuditLog è¨˜éŒ²å®Ÿè£… | ğŸŸ  é‡è¦ | 0.3æ—¥ | ç›£æŸ»ãƒ­ã‚°è¨˜éŒ² |
| SystemModeStatsServiceå®Ÿè£… | ğŸŸ  é‡è¦ | 1æ—¥ | çµ±è¨ˆæ©Ÿèƒ½ã®å®Ÿè£… |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ– | ğŸŸ¡ æ¨å¥¨ | 0.2æ—¥ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š |
| çµ±è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ | ğŸŸ¢ ä»»æ„ | 0.5æ—¥ | é‹ç”¨æ”¹å–„ |

**åˆè¨ˆå·¥æ•°**: 3æ—¥ï¼ˆPhase 1-2ã®ã¿ï¼‰

---

## ğŸ“Œ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **mode-switcher_DBè¦ä»¶åˆ†æ_20251021.md** ã‚’ä½œæˆï¼ˆå®Œäº†ï¼‰
2. â­ï¸ **mode-switcheræš«å®šãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆ_20251021.md** ã‚’ä½œæˆ
3. â­ï¸ **schema.prisma** ã«SystemConfigãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
4. â­ï¸ **åŒ»ç™‚ãƒãƒ¼ãƒ ã¸ã®é€£çµ¡** - åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ å´ã®å¯¾å¿œã¯ä¸è¦ã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥

---

**æ–‡æ›¸çµ‚äº†**

æœ€çµ‚æ›´æ–°: 2025å¹´10æœˆ21æ—¥
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
