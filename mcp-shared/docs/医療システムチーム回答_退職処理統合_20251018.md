# 医療システムチーム回答書 - 退職処理統合

**文書番号**: MED-RESPONSE-RETIREMENT-2025-1018-001
**作成日**: 2025年10月18日
**対象**: VoiceDrive 緊急退職処理・緊急アカウント停止機能統合
**回答者**: 医療システムチーム

---

## 📋 総合評価

VoiceDriveチームからの要件分析書を確認しました。全体的に非常に良く設計されており、**実装可能**と判断します。

### ✅ 承認事項

以下の項目について、承認します：

1. **データフロー設計**: 緊急処理 → 同期キュー → 正式退職のフローは適切
2. **責任分界点**: 職員カルテシステム（マスタ）/ VoiceDrive（緊急処理記録）の分担は明確
3. **Webhook仕様**: HMAC-SHA256署名、JSON形式、エンドポイント設計は適切
4. **セキュリティ要件**: 監査ログ、アクセス制御、データ保持期間は適切

### ⚠️ 修正提案事項

以下の項目について、修正を提案します：

---

## 🗄️ テーブル設計への修正提案

### EmployeeAccountStatusHistory テーブル

VoiceDriveチームからの提案テーブルを基本的に承認しますが、以下の修正を提案します。

#### 修正提案 1: 外部キー制約の変更

```sql
-- 変更前（VoiceDrive提案）
FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE CASCADE

-- 変更後（医療システム提案）
FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE RESTRICT
```

**理由**: 退職後も履歴を保持する必要があるため、`CASCADE`ではなく`RESTRICT`が適切です。

#### 修正提案 2: フィールド追加

監査要件を満たすため、以下のフィールドを追加します：

```sql
-- 追加フィールド
changed_by_department VARCHAR(100) COMMENT '変更実行者の部署',
changed_by_facility VARCHAR(100) COMMENT '変更実行者の施設',
approval_required BOOLEAN DEFAULT FALSE COMMENT '承認が必要か（緊急処理の場合は事後承認）',
approved_by VARCHAR(50) COMMENT '承認者ID（事後承認の場合）',
approved_by_name VARCHAR(100) COMMENT '承認者名',
approved_at TIMESTAMP COMMENT '承認日時',
```

#### 修正提案 3: インデックス追加

パフォーマンス向上のため、以下のインデックスを追加します：

```sql
INDEX idx_changed_at (changed_at),
INDEX idx_approved_by (approved_by),
```

#### 最終テーブル定義（医療システム承認版）

```sql
CREATE TABLE employee_account_status_history (
  -- 主キー
  id VARCHAR(36) PRIMARY KEY COMMENT 'UUID',

  -- 対象職員
  employee_id VARCHAR(50) NOT NULL COMMENT '職員ID',

  -- 変更内容
  previous_status VARCHAR(50) COMMENT '変更前ステータス',
  new_status VARCHAR(50) NOT NULL COMMENT '変更後ステータス',
  -- 'active' | 'emergency_deactivated' | 'retired' | 'suspended'

  -- 変更元システム
  source_system VARCHAR(50) NOT NULL COMMENT '変更元システム',
  -- 'staff_medical_system' | 'voicedrive_emergency'

  is_emergency_change BOOLEAN DEFAULT FALSE COMMENT '緊急変更フラグ',

  -- VoiceDrive緊急処理との紐付け
  voicedrive_deactivation_id VARCHAR(36) COMMENT 'VoiceDrive EmergencyDeactivation.id',
  voicedrive_retirement_process_id VARCHAR(36) COMMENT 'VoiceDrive RetirementProcess.id',

  -- 実行者情報（拡張）
  changed_by VARCHAR(50) COMMENT '変更実行者ID',
  changed_by_name VARCHAR(100) COMMENT '変更実行者名',
  changed_by_department VARCHAR(100) COMMENT '変更実行者の部署',  -- 🆕 追加
  changed_by_facility VARCHAR(100) COMMENT '変更実行者の施設',    -- 🆕 追加

  -- 承認情報（事後承認用）
  approval_required BOOLEAN DEFAULT FALSE COMMENT '承認が必要か（緊急処理の場合は事後承認）',  -- 🆕 追加
  approved_by VARCHAR(50) COMMENT '承認者ID',                                        -- 🆕 追加
  approved_by_name VARCHAR(100) COMMENT '承認者名',                                   -- 🆕 追加
  approved_at TIMESTAMP COMMENT '承認日時',                                          -- 🆕 追加

  -- 理由
  reason TEXT COMMENT '変更理由',

  -- タイムスタンプ
  changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '変更日時',
  synced_from_voicedrive_at TIMESTAMP COMMENT 'VoiceDriveから同期された日時',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  -- インデックス
  INDEX idx_employee_id (employee_id),
  INDEX idx_source_system (source_system),
  INDEX idx_is_emergency_change (is_emergency_change),
  INDEX idx_voicedrive_deactivation_id (voicedrive_deactivation_id),
  INDEX idx_changed_at (changed_at),          -- 🆕 追加
  INDEX idx_approved_by (approved_by),        -- 🆕 追加

  -- 外部キー（RESTRICT に変更）
  FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE RESTRICT  -- ✏️ 変更
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
COMMENT='アカウント状態変更履歴（VoiceDrive緊急処理含む）';
```

---

## 🔗 Webhook仕様への回答

### 質問1: 認証方式について

**回答**: ✅ HMAC-SHA256署名で承認します

以下の仕様で実装します：

```typescript
// VoiceDrive → 医療システム
headers['X-VoiceDrive-Signature'] = `sha256=${signature}`;

// 医療システム → VoiceDrive
headers['X-Medical-System-Signature'] = `sha256=${signature}`;
```

**共有Secret**: セキュアな方法で両チーム間で共有します（Slack DM、暗号化ファイル等）

### 質問2: リトライポリシーについて

**回答**: 以下のリトライポリシーで実装します：

| 項目 | 設定値 |
|------|--------|
| リトライ回数 | 最大3回 |
| リトライ間隔 | 指数バックオフ（1秒、2秒、4秒） |
| タイムアウト | 5秒/リクエスト |
| 最終失敗時 | 医療システム管理者にメール通知 + Slack通知 |

**実装例**:

```typescript
async function sendWebhookWithRetry(
  url: string,
  payload: any,
  maxRetries: number = 3
): Promise<void> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Medical-System-Signature': generateSignature(payload)
        },
        body: JSON.stringify(payload),
        signal: AbortSignal.timeout(5000) // 5秒タイムアウト
      });

      if (response.ok) {
        console.log('[Webhook] 送信成功');
        return;
      }

      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    } catch (error) {
      const backoffTime = Math.pow(2, attempt) * 1000; // 1秒、2秒、4秒
      console.error(`[Webhook] 送信失敗 (試行 ${attempt + 1}/${maxRetries}): ${error.message}`);

      if (attempt < maxRetries - 1) {
        console.log(`[Webhook] ${backoffTime}ms後にリトライします...`);
        await sleep(backoffTime);
      } else {
        // 最終失敗時
        await sendAlert({
          type: 'webhook_failure',
          url,
          error: error.message,
          payload
        });
        throw new Error(`Webhook送信が最大リトライ回数を超えました: ${error.message}`);
      }
    }
  }
}
```

### 質問3: タイムアウトについて

**回答**: ✅ 5秒/リクエストで承認します

---

## 📅 統合テスト環境について

### テスト環境セットアップ日程

**回答**: 以下のスケジュールで準備可能です：

| フェーズ | 日程 | 担当 | 内容 |
|---------|------|------|------|
| **Phase 1: DB準備** | 10/21-10/23（3日） | 医療システム | EmployeeAccountStatusHistoryテーブル作成 |
| **Phase 2: Webhook実装** | 10/24-10/30（7日） | 両チーム | API・Webhook実装 |
| **Phase 3: 統合テスト** | 10/31-11/2（3日） | 両チーム | 結合テスト、修正 |
| **Phase 4: 本番デプロイ** | 11/4（1日） | 両チーム | 本番環境適用 |

**統合テスト環境**: 2025年10月24日までに構築完了予定

### テストデータ準備

**回答**: 医療システム側で準備します

以下のテストデータを用意します：

| 職員ID | 氏名 | 部署 | 施設 | 用途 |
|--------|------|------|------|------|
| TEST-EMP-001 | テスト太郎 | 看護部 | 小原病院 | 緊急退職処理テスト |
| TEST-EMP-002 | テスト花子 | 医事課 | 立神病院 | 緊急アカウント停止テスト |
| TEST-EMP-003 | テスト次郎 | リハビリ科 | 小原病院 | 正式退職処理テスト（緊急処理あり） |
| TEST-EMP-004 | テスト春子 | 総務部 | 立神病院 | 正式退職処理テスト（緊急処理なし） |

### テストシナリオ

#### シナリオ1: 緊急退職処理テスト

**前提条件**:
- 職員カルテシステムがメンテナンス中（模擬）
- TEST-EMP-001が退職予定

**ステップ**:
1. VoiceDriveで緊急退職処理実行（TEST-HR-001が実行）
   - Step 1: アカウント無効化
   - Step 2: 権限剥奪
   - Step 3: 投稿匿名化
   - Step 4: 完了通知

2. VoiceDrive内部でRetirementProcess、EmergencyDeactivation、SyncQueue作成

3. 職員カルテシステム復旧（模擬）

4. SyncQueue自動処理
   - `POST /api/webhooks/voicedrive-emergency-retirement`送信

5. 職員カルテシステム側処理
   - `EmployeeAccountStatusHistory.create()`
   - `Employee.accountStatus = 'emergency_deactivated'`
   - 確認Webhook送信

6. VoiceDrive側更新
   - `RetirementProcess.syncToStaffSystem = true`
   - `SyncQueue.status = 'completed'`

**期待結果**:
- ✅ 全4ステップ完了
- ✅ 職員カルテシステムに緊急処理記録保存
- ✅ 同期完了

#### シナリオ2: 正式退職処理テスト（緊急処理あり）

**前提条件**:
- シナリオ1が完了している（TEST-EMP-001が緊急処理済み）

**ステップ**:
1. 職員カルテシステムで正式退職処理実行
   - `EmployeeAccountStatusHistory`検索
   - `is_emergency_change=true` のレコード発見
   - `voicedrive_deactivation_id`, `voicedrive_retirement_process_id`取得

2. 既存の緊急処理を「正式退職」にアップグレード
   - `Employee.retirementDate = '2025-10-31'`
   - `Employee.accountStatus = 'retired'`
   - `EmployeeAccountStatusHistory.create(previous_status='emergency_deactivated', new_status='retired')`

3. VoiceDriveに通知Webhook送信
   - `POST /api/webhooks/employee-retired`
   - `hasEmergencyProcess: true`
   - `emergencyDeactivationId`, `emergencyRetirementProcessId`含む

4. VoiceDrive側更新
   - `EmergencyDeactivation.status = 'upgraded_to_formal_retirement'`
   - `EmergencyDeactivation.formalRetirementDate = '2025-10-31'`
   - `User.retirementDate`更新

**期待結果**:
- ✅ 二重処理なし（緊急処理を正式退職にアップグレード）
- ✅ `EmployeeAccountStatusHistory`に2レコード（emergency_deactivated、retired）
- ✅ VoiceDrive側でステータス更新

#### シナリオ3: 緊急アカウント停止テスト

**前提条件**:
- TEST-EMP-002が在職中
- セキュリティインシデント発生（模擬）

**ステップ**:
1. VoiceDriveで緊急アカウント停止実行
   - `EmergencyDeactivation.create(type='emergency')`
   - `User.isRetired = true`（一時的）

2. SyncQueue登録

3. 職員カルテシステムに通知
   - `POST /api/webhooks/voicedrive-emergency-deactivation`

4. 職員カルテシステム側処理
   - `EmployeeAccountStatusHistory.create()`
   - `Employee.accountStatus = 'suspended'`

**期待結果**:
- ✅ アカウント停止完了
- ✅ 職員カルテシステムに記録
- ✅ 復職時に再有効化可能

---

## 🛠️ 実装スケジュール（最終版）

| フェーズ | 期間 | 医療システム側作業 | VoiceDrive側作業 | 成果物 |
|---------|------|------------------|----------------|--------|
| **Phase 1: DB準備** | 10/21-10/23 | - EmployeeAccountStatusHistoryテーブル作成<br>- インデックス作成<br>- テストデータ投入 | - Prismaマイグレーション実行<br>- LocalStorageデータ移行スクリプト作成 | - テーブル作成SQL<br>- マイグレーション完了 |
| **Phase 2: Webhook実装** | 10/24-10/30 | - Webhook受信エンドポイント実装<br>- Webhook送信機能実装<br>- 正式退職処理拡張 | - Webhook送信機能実装<br>- Webhook受信エンドポイント実装<br>- サービス層Prisma対応 | - API実装完了<br>- 単体テスト完了 |
| **Phase 3: 統合テスト** | 10/31-11/2 | - 結合テスト実施<br>- 不具合修正 | - 結合テスト実施<br>- 不具合修正 | - 統合テスト報告書 |
| **Phase 4: 本番デプロイ** | 11/4 | - 本番環境マイグレーション<br>- 本番環境動作確認 | - 本番環境デプロイ<br>- 本番環境動作確認 | - 本番リリース完了 |

**実装開始日**: 2025年10月21日（月）

---

## 📝 実装チェックリスト（医療システム側）

### Phase 1: DB準備（10/21-10/23）

- [ ] EmployeeAccountStatusHistoryテーブル作成
  - [ ] SQL実行（ステージング環境）
  - [ ] インデックス作成確認
  - [ ] 外部キー制約確認
  - [ ] View作成（`v_emergency_deactivation_history`）

- [ ] テストデータ投入
  - [ ] TEST-EMP-001〜004作成
  - [ ] TEST-HR-001作成
  - [ ] データ確認（`v_test_employees`）

- [ ] マイグレーション検証
  - [ ] ステージング環境での動作確認
  - [ ] パフォーマンステスト（1000件挿入）

### Phase 2: Webhook実装（10/24-10/30）

#### Webhook受信エンドポイント

- [ ] `POST /api/webhooks/voicedrive-emergency-retirement`
  - [ ] 署名検証実装
  - [ ] `EmployeeAccountStatusHistory.create()`実装
  - [ ] `Employee.accountStatus`更新実装
  - [ ] 確認Webhook送信実装
  - [ ] エラーハンドリング実装
  - [ ] 単体テスト作成

- [ ] `POST /api/webhooks/voicedrive-emergency-deactivation`
  - [ ] 署名検証実装
  - [ ] `EmployeeAccountStatusHistory.create()`実装
  - [ ] `Employee.accountStatus`更新実装
  - [ ] エラーハンドリング実装
  - [ ] 単体テスト作成

#### Webhook送信機能

- [ ] 正式退職処理拡張
  - [ ] 緊急処理記録検索ロジック実装
  - [ ] 既存処理アップグレード機能実装
  - [ ] 二重処理回避ロジック実装

- [ ] Webhook送信実装
  - [ ] `POST https://voicedrive.ai/api/webhooks/employee-retired`
  - [ ] HMAC-SHA256署名生成実装
  - [ ] リトライ機能実装（最大3回、指数バックオフ）
  - [ ] タイムアウト設定（5秒）
  - [ ] エラーハンドリング実装
  - [ ] 単体テスト作成

### Phase 3: 統合テスト（10/31-11/2）

- [ ] シナリオ1: 緊急退職処理テスト
- [ ] シナリオ2: 正式退職処理テスト（緊急処理あり）
- [ ] シナリオ3: 緊急アカウント停止テスト
- [ ] パフォーマンステスト
- [ ] セキュリティテスト（署名検証、アクセス制御）
- [ ] 不具合修正
- [ ] 統合テスト報告書作成

### Phase 4: 本番デプロイ（11/4）

- [ ] 本番環境マイグレーション実行
- [ ] 本番環境Webhook Secret共有
- [ ] 本番環境動作確認
- [ ] 監視設定（Webhook失敗アラート）
- [ ] 運用マニュアル作成

---

## 🔐 セキュリティ要件への回答

### Webhook Secret共有方法

**提案**: 以下の方法で共有します：

- **ステージング環境**: Slack DMで共有
- **本番環境**: 暗号化ファイルで共有（PGP/GPG）

**Secret生成方法**:
```bash
# 32バイトのランダム文字列生成
openssl rand -hex 32
```

### アクセス制御確認

VoiceDriveチームからの提案アクセス制御を承認します：

| 操作 | 権限レベル | 備考 |
|------|----------|------|
| 緊急退職処理実行 | 14-17 | 人事部門のみ ✅ |
| 緊急アカウント停止実行 | 14-17 | 人事部門のみ ✅ |
| 同期キュー閲覧 | 16+ | 統括管理部門以上 ✅ |
| 手動リトライ実行 | 17+ | 統括管理部門長以上 ✅ |

### データ保持期間確認

VoiceDriveチームからの提案データ保持期間を承認します：

| データ | 保持期間 | 理由 |
|-------|---------|------|
| `EmployeeAccountStatusHistory` | 退職後10年 | 法定保存期間 ✅ |
| 監査ログ | 無期限 | 監査証跡 ✅ |

---

## 📞 次のアクション

### VoiceDriveチームへの依頼事項

1. **マイグレーション実行日の確認**
   - 希望日: 2025年10月23日（水）
   - VoiceDrive側のマイグレーション実行日を教えてください

2. **Webhook Secret共有**
   - ステージング環境Secret: 10月24日までに共有
   - 本番環境Secret: 11月3日までに共有

3. **統合テスト日程調整**
   - 統合テストミーティング（オンライン）
   - 希望日時: 10月31日（木）10:00-12:00

4. **テストデータ確認**
   - 上記のテストデータ（TEST-EMP-001〜004）で問題ないか確認

### 両チーム確認事項

- [ ] テーブル設計最終承認（医療システム修正提案を含む）
- [ ] Webhook仕様最終承認
- [ ] 実装スケジュール最終承認
- [ ] セキュリティ要件最終承認

---

## 📎 関連ドキュメント

1. **VoiceDrive側DB要件分析書**: `retirement-emergency-deactivation_DB要件分析_20251018.md`
2. **VoiceDrive側暫定マスターリスト**: `retirement-emergency-deactivation暫定マスターリスト_20251018.md`
3. **データ管理責任分界点定義書**: `データ管理責任分界点定義書_20251008.md`

---

## 📧 連絡先

- **医療システムチーム**: Slack #medical-system-integration
- **担当**: 技術チームリーダー
- **緊急連絡**: medical-emergency@example.com

---

**作成者**: 医療システムチーム
**承認待ち**: VoiceDriveチームからの最終確認
**次のステップ**: 10月21日（月）Phase 1開始

---

ご確認のほど、よろしくお願いいたします。
