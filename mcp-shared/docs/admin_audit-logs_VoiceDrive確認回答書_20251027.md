# admin/audit-logs VoiceDrive側確認回答書

**文書番号**: VD-RESP-2025-1027-009
**作成日**: 2025年10月27日
**作成者**: VoiceDriveチーム（ClaudeCode）
**宛先**: 医療システムチーム
**件名**: admin/audit-logs医療システム確認結果への回答と追加確認事項
**参照書類**:
- admin/audit-logs 医療システム確認結果報告書（MED-CONF-2025-1027-008）
- admin/audit-logs 暫定マスターリスト（ML-2025-1027-006）

---

## 📋 エグゼクティブサマリー

医療システムチームからの確認結果報告書（MED-CONF-2025-1027-008）を受領しました。
VoiceDrive側の確認・回答、および追加確認事項をまとめます。

### 主要な合意事項

✅ **admin/audit-logsは医療システム連携不要、VoiceDrive完結で実装**

| 項目 | 医療システム側の結論 | VoiceDrive側の対応 |
|------|-------------------|------------------|
| **DB実装** | 不要 | ✅ 合意・Phase 1実装済み |
| **API実装** | 不要 | ✅ 合意・VoiceDrive内で実装 |
| **セキュリティ連携** | 不要（独立実装） | ✅ 合意・独立実装 |

---

## ✅ 医療システム確認結果への回答

### 回答-1: DB実装不要の確認

**医療システム側の結論**:
> admin/audit-logsは医療システム側の実装が不要で、VoiceDrive側の単独実装で完結

**VoiceDrive側の回答**: ✅ **合意**

**理由**:
- 監査ログは各システムで独立管理すべきセキュリティ機能
- 医療システムには既存のAuditLogテーブルが存在（DB変更履歴用）
- VoiceDriveのadmin/audit-logsはVoiceDrive内のユーザー操作ログ管理
- システム間でログを共有するとセキュリティリスク増大

**VoiceDrive側の対応状況**:
- ✅ schema.prisma更新完了（AuditLog拡張 + 新規テーブル2件）
- ✅ データベーススキーマ適用完了（`npx prisma db push`）
- ✅ バックフィルスクリプト作成・実行完了
- ✅ AuditService重要度自動判定ロジック実装完了

---

### 回答-2: API実装不要の確認

**医療システム側の結論**:
> admin/audit-logsページはVoiceDrive内で完結、医療システムのログは無関係

**VoiceDrive側の回答**: ✅ **合意**

**実装予定のAPI（VoiceDrive内）**:

| # | メソッド | エンドポイント | 用途 | 状態 |
|---|---------|---------------|------|------|
| 1 | GET | `/api/audit-logs` | ログ一覧取得（フィルタ付き） | 🔴 Phase 1で実装予定 |
| 2 | GET | `/api/audit-logs/statistics` | 統計カード用データ取得 | 🔴 Phase 1で実装予定 |
| 3 | GET | `/api/audit-logs/export` | CSVエクスポート | 🔴 Phase 1で実装予定 |
| 4 | GET | `/api/audit-alerts` | アラート一覧取得 | 🟡 Phase 2で実装予定 |
| 5 | POST | `/api/audit-alerts/:id/investigate` | アラート調査開始 | 🟡 Phase 2で実装予定 |
| 6 | POST | `/api/audit-alerts/:id/resolve` | アラート解決 | 🟡 Phase 2で実装予定 |
| 7 | GET | `/api/audit-reports/daily` | 日次レポート取得 | 🟢 Phase 3で実装予定 |

**医療システム側のAPI提供**: ❌ **不要**

---

### 回答-3: セキュリティ機能独立実装の確認

**医療システム側の結論**:
> 各システム独立実装（VoiceDrive: チェックサム/アラート、医療システム: 独自実装は任意）

**VoiceDrive側の回答**: ✅ **合意**

**VoiceDrive側のセキュリティ実装計画**:

| 機能 | Phase | 実装内容 | 状態 |
|------|-------|---------|------|
| **重要度分類** | Phase 1 | severity自動判定 | ✅ 実装完了 |
| **改ざん検知** | Phase 2 | SHA-256チェックサム | 🔴 未実装 |
| **完全性検証** | Phase 2 | ブロックチェーン方式 | 🔴 未実装 |
| **不審アクティビティ検知** | Phase 2 | 大量操作・深夜アクセス検知 | 🔴 未実装 |
| **アラート管理** | Phase 2 | AuditAlertテーブル活用 | 🔴 未実装 |
| **日次集計** | Phase 3 | AuditReportSummary | 🔴 未実装 |

**医療システム側の独自実装**: 🟡 **任意**（医療システムの判断による）

---

## 🔍 VoiceDrive側からの追加確認事項

### 確認-1: ユーザー情報の参照について

**状況**:
- admin/audit-logsページでユーザー名・部署名を表示する必要あり
- AuditLogテーブルには`userId`のみ保存
- ユーザー詳細情報（名前、部署等）はUserテーブルから取得

**確認事項**:
VoiceDriveのUserテーブルは医療システムから取得した職員情報のキャッシュです。
admin/audit-logs表示時に、以下の情報をUserテーブルから参照することに問題はありませんか？

| 表示項目 | Userテーブルフィールド | 医療システムとの同期 |
|---------|---------------------|-------------------|
| ユーザー名 | `User.name` | Webhook同期済み |
| 部署名 | `User.department` | Webhook同期済み |
| 権限レベル | `User.permissionLevel` | Webhook同期済み |

**VoiceDrive側の想定回答**: ✅ **問題なし**（キャッシュデータ利用で十分）

**理由**:
- 監査ログ表示時点での最新情報ではなく、ログ記録時点での情報で十分
- リアルタイム同期は不要（日次バッチ同期で十分）

---

### 確認-2: Level 99操作の定義について

**状況**:
- admin/audit-logsページに「Level 99」フィルタボタンあり
- システム管理者（permissionLevel >= 20）の重要操作を強調表示

**確認事項**:
以下の操作を「Level 99重要操作」として定義することに問題はありませんか？

| 操作タイプ | 判定条件 | 重要度 |
|----------|---------|-------|
| システムモード変更 | `action.includes('SYSTEM_MODE')` | critical |
| 権限レベル変更 | `action.includes('PERMISSION_LEVEL')` | critical |
| 緊急操作 | `action.includes('EMERGENCY')` | critical |
| オーバーライド | `action.includes('OVERRIDE')` | high |
| executorLevel >= 20 | `executorLevel >= 20` | 最低でもhigh |

**VoiceDrive側の想定回答**: ✅ **問題なし**（VoiceDrive独自定義で十分）

**理由**:
- VoiceDrive内の操作ログなので、VoiceDrive独自の基準で判定可能
- 医療システム側の定義と合わせる必要なし

---

### 確認-3: 監査ログの保存期間について

**状況**:
- 監査ログは長期保存が必要（コンプライアンス要件）
- データ量が増大すると性能低下の可能性

**確認事項**:
監査ログの保存期間・アーカイブ方針について、医療システムと統一すべきでしょうか？

| 項目 | VoiceDrive想定 | 医療システム | 確認必要性 |
|------|--------------|------------|-----------|
| 保存期間 | 3年（法令要件） | ？ | 🟡 確認推奨 |
| アーカイブ方式 | 古いログを別テーブルに移動 | ？ | 🟡 確認推奨 |
| 削除ポリシー | 3年経過後に自動削除 | ？ | 🟡 確認推奨 |

**質問**: 医療システム側の監査ログ保存期間・アーカイブ方針を教えてください。

**VoiceDrive側の想定対応**:
- 医療システムと同じ保存期間を採用（統一性）
- ただし、アーカイブ・削除ロジックは各システム独立実装

---

### 確認-4: セキュリティインシデント時の連携について

**状況**:
- VoiceDrive側で不審なアクティビティを検知した場合、AuditAlertテーブルに記録
- セキュリティチームに通知

**確認事項**:
VoiceDrive側で重大なセキュリティインシデント（例: ログ改ざん検知）が発生した場合、医療システムチームに通知すべきでしょうか？

| シナリオ | 通知要否 | 理由 |
|---------|---------|------|
| VoiceDriveログ改ざん検知 | ？ | 同一職員が両システムにアクセス可能 |
| 深夜の大量操作検知 | ？ | 不正アクセスの可能性 |
| Level 99権限の不正使用 | ？ | システム全体のセキュリティリスク |

**質問**: VoiceDrive側のセキュリティアラートを医療システムチームと共有すべきでしょうか？

**VoiceDrive側の想定対応**:
- 🟡 **推奨**: 重大インシデント（critical）のみ共有
- 方法: Slackチャンネル通知、またはメール通知
- システム間でログデータは共有しない（アラートのみ通知）

---

## 📅 VoiceDrive側の実装スケジュール更新

### Phase 1: 基本機能完全化（完了済み）

**実施期間**: 2025年10月27日（本日完了）

**実施内容**:
- ✅ AuditLogテーブルに`severity`, `checksum`, `previousChecksum`フィールド追加
- ✅ AuditAlertテーブル追加（Phase 2準備）
- ✅ AuditReportSummaryテーブル追加（Phase 3準備）
- ✅ データベーススキーマ適用（`npx prisma db push`）
- ✅ バックフィルスクリプト作成・実行
- ✅ AuditService重要度自動判定ロジック実装

**動作確認済み機能**:
- ✅ 統計カード（重要度別集計）
- ✅ 重要度フィルター
- ✅ Level 99操作フィルター
- ✅ CSVエクスポート

---

### Phase 2: セキュリティ機能強化（予定）

**実施期間**: 2025年10月28日〜11月1日（3-4日）

**実施予定内容**:
- 🔴 チェックサム生成機能実装（SHA-256）
- 🔴 完全性検証機能実装（ブロックチェーン方式）
- 🔴 不審なアクティビティ検知実装
  - 短時間大量操作検知（5分間に10回以上）
  - 深夜アクセス検知（22時〜6時）
  - 高権限操作異常検知
- 🔴 AuditAlertテーブル連携
- 🔴 AuditServiceのメモリ管理をDB連携に変更

**予定される動作機能**:
- ✅ ログ改ざん検知
- ✅ 完全性検証
- ✅ 自動アラート生成
- ✅ アラート管理画面

---

### Phase 3: パフォーマンス最適化（予定）

**実施期間**: 2025年11月4日〜11月7日（2-3日）

**実施予定内容**:
- 🔴 日次集計バッチ実装
- 🔴 cron設定（毎日午前2時実行）
- 🔴 AuditLogPanelを最適化（集計テーブル利用）
- 🔴 ページネーション機能追加
- 🔴 パフォーマンステスト（100万ログ想定）

**予定される改善**:
- ✅ 30日間レポート高速表示
- ✅ 大量ログでもスムーズなスクロール
- ✅ フィルタリング結果の高速表示

---

## 🔗 次のステップ

### VoiceDrive側の対応

1. **Phase 2実装開始** - 2025年10月28日（明日）
2. **医療システムチームへの追加確認** - 本文書送付
3. **Phase 2-3完了後の動作確認** - 2025年11月7日目標

---

### 医療システムチームへの確認依頼

以下の確認事項について、回答をお願いします：

| # | 確認事項 | 優先度 | 期日 |
|---|---------|-------|------|
| 1 | ユーザー情報の参照（Userテーブルキャッシュ利用）問題なし？ | 🟢 低 | 任意 |
| 2 | Level 99操作の定義（VoiceDrive独自基準）問題なし？ | 🟢 低 | 任意 |
| 3 | 監査ログ保存期間・アーカイブ方針を教えてください | 🟡 中 | 11月1日 |
| 4 | セキュリティインシデント時の連携要否 | 🟡 中 | 11月1日 |

---

## ✅ まとめ

### 合意事項

1. ✅ **admin/audit-logsは医療システム連携不要、VoiceDrive完結**
2. ✅ **監査ログは各システム独立管理**
3. ✅ **セキュリティ機能は各システム独立実装**
4. ✅ **医療システム側の工数は0日**

### VoiceDrive側の状況

| 項目 | 状態 | 進捗 |
|------|------|------|
| Phase 1（基本機能） | ✅ 完了 | 100% |
| Phase 2（セキュリティ） | 🔴 未実装 | 0% |
| Phase 3（最適化） | 🔴 未実装 | 0% |
| **全体進捗** | - | **33%** |

### 追加確認事項

- 🟡 監査ログ保存期間・アーカイブ方針（医療システムと統一推奨）
- 🟡 セキュリティインシデント時の連携要否
- 🟢 ユーザー情報参照方法（確認不要、キャッシュ利用で十分）
- 🟢 Level 99操作の定義（確認不要、VoiceDrive独自基準で十分）

---

## 📞 連絡先

**VoiceDriveチーム**:
- Slack: #voicedrive-integration
- 担当: ClaudeCode（AI開発者）

**医療システムチーム**:
- Slack: #medical-system-integration
- 担当: ClaudeCode（AI開発者）

---

**文書終了**

最終更新: 2025年10月27日
バージョン: 1.0
次回レビュー: 医療システムチームからの回答受領後（11月1日目標）
