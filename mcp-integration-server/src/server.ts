import express from 'express';
import cors from 'cors';
import { createProxyMiddleware } from 'http-proxy-middleware';
import winston from 'winston';
import path from 'path';
import fs from 'fs';

// „É≠„Ç¨„ÉºË®≠ÂÆö
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    new winston.transports.File({ 
      filename: 'logs/combined.log',
      format: winston.format.json()
    })
  ]
});

// Express „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
const app = express();
const PORT = process.env.MCP_PORT || 8080;

// CORSË®≠ÂÆö
app.use(cors({
  origin: [
    'http://localhost:3000',  // ÂåªÁôÇËÅ∑Âì°ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
    'http://localhost:5173',  // VoiceDrive
    'http://localhost:8080'   // MCP„Çµ„Éº„Éê„ÉºËá™Ë∫´
  ],
  credentials: true
}));

// JSON„Éë„Éº„Çµ„Éº
app.use(express.json());

// „É≠„ÇÆ„É≥„Ç∞„Éü„Éâ„É´„Ç¶„Çß„Ç¢
app.use((req, res, next) => {
  logger.info(`${req.method} ${req.path} - ${req.ip}`);
  next();
});

// ÂåªÁôÇËÅ∑Âì°ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Å∏„ÅÆ„Éó„É≠„Ç≠„Ç∑
app.use('/api/medical', createProxyMiddleware({
  target: 'http://localhost:3000',
  changeOrigin: true,
  pathRewrite: {
    '^/api/medical': '/api/v1'
  },
  on: {
    proxyReq: (proxyReq: any, req: any, res: any) => {
      logger.info(`Proxying to Medical System: ${req.method} ${req.path}`);
    },
    error: (err: any, req: any, res: any) => {
      logger.error(`Medical System Proxy Error: ${err.message}`);
      if (!res.headersSent) {
        res.status(502).json({ error: 'Medical System is unavailable' });
      }
    }
  }
}));

// VoiceDrive„Å∏„ÅÆ„Éó„É≠„Ç≠„Ç∑
app.use('/api/voicedrive', createProxyMiddleware({
  target: 'http://localhost:5173',
  changeOrigin: true,
  pathRewrite: {
    '^/api/voicedrive': '/api/v1'
  },
  on: {
    proxyReq: (proxyReq: any, req: any, res: any) => {
      logger.info(`Proxying to VoiceDrive: ${req.method} ${req.path}`);
    },
    error: (err: any, req: any, res: any) => {
      logger.error(`VoiceDrive Proxy Error: ${err.message}`);
      if (!res.headersSent) {
        res.status(502).json({ error: 'VoiceDrive is unavailable' });
      }
    }
  }
}));

// V3 API endpoints - ÂåªÁôÇ„ÉÅ„Éº„É†ÊèêÊ°à„ÅÆÊñ∞„Éï„É≠„ÉºÂØæÂøú
app.post('/api/v3/appeals/submit', (req, res) => {
  logger.info('V3 Appeal submission received:', req.body);
  
  // V3Áï∞Ë≠∞Áî≥Á´ãÂèó‰ø°„ÅÆÊ®°Êì¨„É¨„Çπ„Éù„É≥„Çπ
  const appealId = `APL${Date.now()}`;
  const response = {
    appealId,
    status: 'received',
    assignedTo: 'MGR002',
    estimatedResponseDate: '2025-08-28',
    message: 'V3Áï∞Ë≠∞Áî≥Á´ã„ÇíÂèóÁêÜ„Åó„Åæ„Åó„Åü',
    voiceDriveCallbackUrl: `/api/v3/appeals/${appealId}/status`
  };
  
  logger.info('V3 Appeal response:', response);
  res.json(response);
});

// Áµ±ÂêàAPI - ‰∏°„Ç∑„Çπ„ÉÜ„É†„ÅÆÁä∂ÊÖã„ÇíÂèñÂæó
app.get('/api/status', async (req, res) => {
  const status = {
    mcp: 'running',
    timestamp: new Date().toISOString(),
    services: {
      medical: { url: 'http://localhost:3000', status: 'unknown' },
      voicedrive: { url: 'http://localhost:5173', status: 'unknown' }
    }
  };

  // ÂêÑ„Çµ„Éº„Éì„Çπ„ÅÆÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
  try {
    const medicalResponse = await fetch('http://localhost:3000/api/health');
    status.services.medical.status = medicalResponse.ok ? 'healthy' : 'unhealthy';
  } catch (error) {
    status.services.medical.status = 'offline';
  }

  try {
    const voicedriveResponse = await fetch('http://localhost:5173/api/health');
    status.services.voicedrive.status = voicedriveResponse.ok ? 'healthy' : 'unhealthy';
  } catch (error) {
    status.services.voicedrive.status = 'offline';
  }

  res.json(status);
});

// Áµ±Âêà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÔºàHTMLÔºâ
app.get('/dashboard', (req, res) => {
  const dashboardHTML = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCP Integration Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    .status {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .status-dot.healthy { background: #10b981; }
    .status-dot.unhealthy { background: #f59e0b; }
    .status-dot.offline { background: #ef4444; }
    .status-dot.unknown { background: #6b7280; }
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .metric:last-child {
      border-bottom: none;
    }
    .metric-value {
      font-weight: bold;
      color: #667eea;
    }
    .button {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      margin-top: 15px;
      transition: background 0.3s;
    }
    .button:hover {
      background: #764ba2;
    }
    .logs {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ MCP Integration Dashboard</h1>
    
    <div class="grid">
      <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã -->
      <div class="card">
        <h2>üìä „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h2>
        <div id="system-status">
          <div class="status">
            <span class="status-dot unknown"></span>
            <span>Ë™≠„ÅøËæº„Åø‰∏≠...</span>
          </div>
        </div>
      </div>

      <!-- „É°„Éà„É™„ÇØ„Çπ -->
      <div class="card">
        <h2>üìà „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h2>
        <div class="metric">
          <span>„É¨„Çπ„Éù„É≥„ÇπÊôÇÈñì</span>
          <span class="metric-value">-ms</span>
        </div>
        <div class="metric">
          <span>ÊàêÂäüÁéá</span>
          <span class="metric-value">-%</span>
        </div>
        <div class="metric">
          <span>„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊé•Á∂ö</span>
          <span class="metric-value">-</span>
        </div>
      </div>

      <!-- „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„Çπ -->
      <div class="card">
        <h2>‚ö° „ÇØ„Ç§„ÉÉ„ÇØ„Ç¢„ÇØ„Çª„Çπ</h2>
        <a href="http://localhost:3000" target="_blank" class="button">ÂåªÁôÇ„Ç∑„Çπ„ÉÜ„É† ‚Üí</a>
        <a href="http://localhost:5173" target="_blank" class="button">VoiceDrive ‚Üí</a>
        <a href="/api/status" target="_blank" class="button">API Status ‚Üí</a>
      </div>

      <!-- ÊúÄÊñ∞„É≠„Ç∞ -->
      <div class="card" style="grid-column: 1 / -1;">
        <h2>üìù ÊúÄÊñ∞„É≠„Ç∞</h2>
        <div class="logs" id="logs">
          <div>[2025-08-10 15:00:00] MCP Server started</div>
          <div>[2025-08-10 15:00:01] Medical System: Connected</div>
          <div>[2025-08-10 15:00:02] VoiceDrive: Connected</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Áä∂ÊÖã„ÇíÂÆöÊúüÁöÑ„Å´Êõ¥Êñ∞
    async function updateStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const statusHtml = Object.entries(data.services).map(([name, service]) => {
          const statusClass = service.status === 'healthy' ? 'healthy' : 
                            service.status === 'unhealthy' ? 'unhealthy' : 
                            service.status === 'offline' ? 'offline' : 'unknown';
          return \`
            <div class="status">
              <span class="status-dot \${statusClass}"></span>
              <span>\${name}: \${service.status} (\${service.url})</span>
            </div>
          \`;
        }).join('');
        
        document.getElementById('system-status').innerHTML = statusHtml;
      } catch (error) {
        console.error('Failed to update status:', error);
      }
    }

    // ÂàùÊúüË™≠„ÅøËæº„Åø„Å®ÂÆöÊúüÊõ¥Êñ∞
    updateStatus();
    setInterval(updateStatus, 5000);

    // „É≠„Ç∞„ÅÆËá™ÂãïÊõ¥Êñ∞ÔºàWebSocketÂÆüË£Ö‰∫àÂÆöÔºâ
    setInterval(() => {
      const logsDiv = document.getElementById('logs');
      const time = new Date().toISOString().replace('T', ' ').substr(0, 19);
      const newLog = \`<div>[\${time}] Health check performed</div>\`;
      logsDiv.innerHTML += newLog;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }, 10000);
  </script>
</body>
</html>
  `;
  res.send(dashboardHTML);
});

// V3Ë©ï‰æ°„Ç∑„Çπ„ÉÜ„É†API„É¢„ÉÉ„ÇØ - 100ÁÇπÊ∫ÄÁÇπÂØæÂøú
app.get('/api/v3/evaluation/periods', (req, res) => {
  const v3Data = {
    success: true,
    version: "v3.0.0",
    systemType: "100-point-evaluation",
    periods: [
      {
        id: "2025-H1-V3",
        name: "2025Âπ¥Â∫¶‰∏äÊúüÔºàV3Ôºâ",
        startDate: "2025-04-01",
        endDate: "2025-09-30",
        evaluationStartDate: "2025-09-15",
        evaluationEndDate: "2025-10-15",
        disclosureDate: "2025-10-20",
        appealDeadline: "2025-11-03",
        status: "active",
        evaluationSystem: {
          maxScore: 100,
          minScore: 0,
          gradeSystem: "7-tier",
          gradeBoundaries: [90, 80, 70, 60, 50, 40, 0],
          gradeLabels: ["S", "A+", "A", "B+", "B", "C", "D"]
        }
      },
      {
        id: "2024-H2-V3",
        name: "2024Âπ¥Â∫¶‰∏ãÊúüÔºàV3Ôºâ",
        startDate: "2024-10-01",
        endDate: "2025-03-31",
        evaluationStartDate: "2025-03-15",
        evaluationEndDate: "2025-04-15",
        disclosureDate: "2025-04-20",
        appealDeadline: "2025-05-04",
        status: "active",
        evaluationSystem: {
          maxScore: 100,
          minScore: 0,
          gradeSystem: "7-tier",
          gradeBoundaries: [90, 80, 70, 60, 50, 40, 0],
          gradeLabels: ["S", "A+", "A", "B+", "B", "C", "D"]
        }
      }
    ]
  };
  
  logger.info(`V3 Medical System API: /api/v3/evaluation/periods called`);
  res.json(v3Data);
});

// V3Áï∞Ë≠∞Áî≥„ÅóÁ´ã„Å¶ÈÄÅ‰ø°API„É¢„ÉÉ„ÇØ
app.post('/api/v3/appeals', (req, res) => {
  const { body } = req;
  
  // V3„Éá„Éº„ÇøÊ§úË®º
  if (!body.employeeId || !body.evaluationPeriod || !body.appealReason) {
    return res.status(400).json({
      success: false,
      error: {
        code: "V3_VALIDATION_ERROR",
        message: "ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàV3„Ç∑„Çπ„ÉÜ„É†Ôºâ",
        details: {
          requiredFields: ["employeeId", "evaluationPeriod", "appealReason"],
          receivedFields: Object.keys(body)
        }
      }
    });
  }
  
  // V3ÂÑ™ÂÖàÂ∫¶Âà§ÂÆöÔºà100ÁÇπÊ∫ÄÁÇπ„Ç∑„Çπ„ÉÜ„É†ÂØæÂøúÔºâ
  const determineV3Priority = (request: any) => {
    if (request.appealCategory === 'calculation_error') return 'high';
    
    if (request.originalScore !== undefined && request.requestedScore !== undefined) {
      const diff = request.requestedScore - request.originalScore;
      if (diff >= 15) return 'high';  // V3„Åß„ÅØ15ÁÇπ‰ª•‰∏ä„ÅßÈ´òÂÑ™ÂÖàÂ∫¶
      if (diff >= 8) return 'medium'; // V3„Åß„ÅØ8ÁÇπ‰ª•‰∏ä„Åß‰∏≠ÂÑ™ÂÖàÂ∫¶
    }
    
    if (request.appealCategory === 'achievement_oversight') return 'medium';
    
    return 'low';
  };
  
  const priority = determineV3Priority(body);
  const appealId = `V3-APPEAL-${Date.now()}`;
  
  // V3„É¨„Çπ„Éù„É≥„Çπ
  const v3Response = {
    success: true,
    version: "v3.0.0",
    appealId: appealId,
    message: "V3Ë©ï‰æ°„Ç∑„Çπ„ÉÜ„É†„ÅßÁï∞Ë≠∞Áî≥„ÅóÁ´ã„Å¶„ÇíÂèóÁêÜ„Åó„Åæ„Åó„Åü",
    expectedResponseDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
    details: {
      status: "under_review",
      priority: priority,
      processedAt: new Date().toISOString(),
      assignedTo: priority === 'high' ? 'DEPT_HEAD_V3_001' : 
                  priority === 'medium' ? 'SECTION_CHIEF_V3_001' : 
                  'TEAM_LEADER_V3_001',
      evaluationSystem: "100-point",
      gradingSystem: "7-tier",
      scoreDifference: body.requestedScore - body.originalScore || 0,
      grade: {
        current: getV3Grade(body.originalScore || 0),
        requested: getV3Grade(body.requestedScore || 0)
      }
    }
  };
  
  logger.info(`V3 Appeal submitted: ${appealId}, Priority: ${priority}`);
  res.json(v3Response);
});

// V3„Ç∞„É¨„Éº„ÉâË®àÁÆóÈñ¢Êï∞
function getV3Grade(score: number): string {
  if (score >= 90) return 'S';
  if (score >= 80) return 'A+';
  if (score >= 70) return 'A';
  if (score >= 60) return 'B+';
  if (score >= 50) return 'B';
  if (score >= 40) return 'C';
  return 'D';
}

// V3ÂØ©ÊüªËÄÖÂâ≤„ÇäÂΩì„Å¶Á¢∫Ë™çAPI
app.get('/api/v3/appeals/:appealId/status', (req, res) => {
  const { appealId } = req.params;
  
  const v3Status = {
    success: true,
    version: "v3.0.0",
    appealId: appealId,
    status: "under_review",
    assignedReviewer: {
      id: "DEPT_HEAD_V3_001",
      name: "V3ÈÉ®ÈñÄÈï∑„ÉÜ„Çπ„Éà",
      role: "department_head_v3",
      capacity: "available"
    },
    workflow: {
      currentStep: 2,
      totalSteps: 4,
      estimatedCompletion: "2025-08-27",
      steps: [
        { step: 1, name: "ÂèóÁêÜÁ¢∫Ë™ç", status: "completed", completedAt: "2025-08-20T14:45:00Z" },
        { step: 2, name: "V3Ë©ï‰æ°Ê§úË®º", status: "in_progress", startedAt: "2025-08-20T14:50:00Z" },
        { step: 3, name: "100ÁÇπÊ∫ÄÁÇπÂÜçË®àÁÆó", status: "pending" },
        { step: 4, name: "7ÊÆµÈöé„Ç∞„É¨„Éº„ÉâÁ¢∫ÂÆö", status: "pending" }
      ]
    },
    evaluationDetails: {
      systemVersion: "v3.0.0",
      maxScore: 100,
      gradeSystem: "7-tier"
    }
  };
  
  logger.info(`V3 Appeal status checked: ${appealId}`);
  res.json(v3Status);
});

// „É¨„Ç¨„Ç∑„ÉºV1 API„É¢„ÉÉ„ÇØÔºàÂªÉÊ≠¢‰∫àÂÆöÔºâ
app.get('/api/v1/evaluation/periods', (req, res) => {
  logger.warn(`DEPRECATED: V1 API called - /api/v1/evaluation/periods. Please migrate to V3.`);
  res.status(410).json({
    error: "DEPRECATED_API",
    message: "V1 API„ÅØÂªÉÊ≠¢„Åï„Çå„Åæ„Åó„Åü„ÄÇV3 API„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ",
    migration: {
      oldEndpoint: "/api/v1/evaluation/periods",
      newEndpoint: "/api/v3/evaluation/periods", 
      changes: [
        "100ÁÇπÊ∫ÄÁÇπ„Ç∑„Çπ„ÉÜ„É†ÂØæÂøú",
        "7ÊÆµÈöé„Ç∞„É¨„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†",
        "V3„Éá„Éº„ÇøÊßãÈÄ†„Å∏„ÅÆÂ§âÊõ¥"
      ]
    }
  });
});

// „Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØ
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', timestamp: new Date().toISOString() });
});

// „É≠„Ç∞„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆ‰ΩúÊàê
const logsDir = path.join(__dirname, '..', 'logs');
if (!fs.existsSync(logsDir)) {
  fs.mkdirSync(logsDir, { recursive: true });
}

// „Çµ„Éº„Éê„ÉºËµ∑Âãï
app.listen(PORT, () => {
  logger.info(`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         MCP Integration Server              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ Server: http://localhost:${PORT}            ‚îÇ
‚îÇ ‚úÖ Dashboard: http://localhost:${PORT}/dashboard ‚îÇ
‚îÇ ‚úÖ API Status: http://localhost:${PORT}/api/status ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Proxying:                                   ‚îÇ
‚îÇ ‚Ä¢ Medical System: http://localhost:3000    ‚îÇ
‚îÇ ‚Ä¢ VoiceDrive: http://localhost:5173        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  `);
});

export default app;