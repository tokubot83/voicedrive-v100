# 議題モード統一 - 影響範囲とリスク分析

## 実施概要

**目的**: 現在の混在システムを「議題モード」に統一
**実施日**: 2025-10-04
**実施者**: システム管理者
**リスクレベル**: 🟡 中（慎重な実装が必要）

---

## 1. 影響を受けるファイル

### 🔴 重要な変更が必要（コア機能）

| ファイル | 変更内容 | 影響度 |
|---------|---------|-------|
| `EnhancedPost.tsx` | 議題モード専用に変更 | 高 |
| `ComposeForm.tsx` | 投稿時に議題ステータスを初期化 | 高 |
| `VotingSection.tsx` | 議題モードの権限チェックに統一 | 高 |
| `AgendaLevelIndicator.tsx` | 常に表示するように変更 | 中 |
| `HomePage.tsx` | プロジェクト関連UIを非表示 | 中 |

### 🟡 条件付き変更（モード判定追加）

| ファイル | 変更内容 | 影響度 |
|---------|---------|-------|
| `PersonalStationPage.tsx` | 議題ステータスのみ表示 | 中 |
| `EnhancedSidebar.tsx` | メニュー整理（新規投稿・投票削除） | 中 |
| `ProposalGeneratorPage.tsx` | 議題提案書生成に統一 | 低 |

### 🟢 影響なし（そのまま使用）

| ファイル | 理由 |
|---------|-----|
| `AgendaVisibilityEngine.ts` | 議題モードのコアエンジン |
| `ProposalEscalationEngine.ts` | 議題モードのコアエンジン |
| `AgendaDocumentService.ts` | 議題モードのコアサービス |
| `CommitteeBridge.tsx` | 委員会機能は議題モード専用 |

---

## 2. 機能への影響

### ✅ 使用可能（変更なし）

- ✓ 投稿作成
- ✓ 投票機能
- ✓ コメント機能
- ✓ 議題エスカレーション（30→50→100→300→600点）
- ✓ 委員会への自動提出
- ✓ 議題提案書の自動生成
- ✓ 権限レベル別の閲覧・投票制御

### ⚠️ 一時的に無効化

- ⚠️ プロジェクトチーム編成機能
- ⚠️ プロジェクト進捗管理
- ⚠️ マイルストーン管理
- ⚠️ ProjectUpgradeEngine の緊急昇格機能

### 🔄 動作変更

- 🔄 投票権限: VotingPermissionMatrix → AgendaVisibilityEngine に統一
- 🔄 スコア閾値: プロジェクト基準 → 議題基準に統一
- 🔄 UI表示: プロジェクトバッジ → 議題レベル表示

---

## 3. データへの影響

### データベース変更（不要）

現在のスキーマは両モードに対応可能：

```sql
-- 既存のpostsテーブル
posts {
  id
  content
  projectStatus JSON  -- 現在はプロジェクト用、議題用に転用可能
  ...
}
```

**対応方針**:
- `projectStatus` フィールドを `agendaStatus` として解釈
- スキーマ変更は不要（後方互換性維持）

### 既存投稿の扱い

| 既存データ | 対応方法 |
|-----------|---------|
| プロジェクトスコアがある投稿 | 議題スコアとして読み替え |
| プロジェクトレベル設定済み | 議題レベルにマッピング |
| チームメンバー情報 | 一時的に無視（表示しない） |

**マッピングテーブル**:
```
PENDING      → 検討中（0-29点）
TEAM         → 部署検討（30-49点）
DEPARTMENT   → 部署議題（50-99点）
FACILITY     → 施設議題（100-299点）
ORGANIZATION → 法人議題（600点以上）
```

---

## 4. リスク分析

### 🔴 高リスク

| リスク | 影響 | 対策 |
|-------|-----|-----|
| 投票権限の判定ミス | ユーザーが投票できない | AgendaVisibilityEngine の十分なテスト |
| 既存投稿の表示エラー | データが正しく表示されない | データマッピングロジックの検証 |
| スコア計算の不一致 | 議題レベルが正しく判定されない | スコア閾値の再確認 |

### 🟡 中リスク

| リスク | 影響 | 対策 |
|-------|-----|-----|
| UI表示の混乱 | ユーザーが戸惑う | 明確なラベル表示 |
| サイドバーメニューの変更 | ナビゲーションが変わる | ユーザーへの事前告知 |
| 権限チェックの重複 | パフォーマンス低下 | 不要なコードの削除 |

### 🟢 低リスク

| リスク | 影響 | 対策 |
|-------|-----|-----|
| 一部機能の一時無効化 | プロジェクト機能が使えない | 将来のモード切替で復活可能 |
| ドキュメントの更新 | 古い情報が残る | 段階的にドキュメント更新 |

---

## 5. ロールバック計画

### ロールバックトリガー

以下の場合は即座にロールバック：
- ✗ 投票機能が動作しない
- ✗ 既存投稿が表示されない
- ✗ 権限エラーが多発する
- ✗ スコア計算が異常

### ロールバック手順

1. システムモード設定を元に戻す
   ```typescript
   systemModeManager.setMode(SystemMode.PROJECT, adminUser);
   ```

2. 変更したファイルをGitで戻す
   ```bash
   git checkout main -- src/components/EnhancedPost.tsx
   git checkout main -- src/components/VotingSection.tsx
   ```

3. ブラウザキャッシュをクリア

---

## 6. テスト計画

### 必須テスト項目

#### 1. 投票権限テスト
- [ ] 部署内投稿（0-99点）: 同一部署のみ投票可
- [ ] 施設議題（100-299点）: 同一施設のみ投票可
- [ ] 法人議題（600点以上）: 法人全員投票可

#### 2. 表示テスト
- [ ] 議題レベル表示が正しい
- [ ] スコアが正しく表示される
- [ ] 委員会提出ステータスが表示される

#### 3. エスカレーションテスト
- [ ] 30点で「部署検討」に昇格
- [ ] 100点で「施設議題」に昇格・委員会提出
- [ ] 600点で「法人議題」に昇格・理事会提出

#### 4. 権限レベル別テスト
- [ ] Lv.1（新人）: 部署内のみ投票可
- [ ] Lv.5（副主任）: 議題提案書作成可
- [ ] Lv.8（師長）: 施設内全投稿閲覧可

---

## 7. 実装ステップ（慎重なアプローチ）

### ステップ1: 準備（リスク最小化）
1. ✅ 設計書作成（完了）
2. ✅ 影響範囲分析（完了）
3. [ ] Gitブランチ作成: `feature/agenda-mode-unification`
4. [ ] バックアップ作成

### ステップ2: コア機能実装
1. [ ] SystemModeManager 実装
2. [ ] 議題モードデフォルト設定
3. [ ] AgendaVisibilityEngine を優先使用
4. [ ] 投稿時の議題ステータス初期化

### ステップ3: UI更新
1. [ ] EnhancedPost.tsx を議題モード対応
2. [ ] サイドバーメニュー整理
3. [ ] HomePage でプロジェクトUI非表示

### ステップ4: テスト
1. [ ] 単体テスト実行
2. [ ] 統合テスト実行
3. [ ] 手動テスト（全シナリオ）

### ステップ5: デプロイ
1. [ ] ステージング環境でテスト
2. [ ] 本番デプロイ
3. [ ] モニタリング

---

## 8. 成功基準

### 必須条件
- ✅ 全ての投票機能が正常動作
- ✅ 既存投稿が正しく表示
- ✅ 議題エスカレーションが正常動作
- ✅ 委員会提出が正常動作
- ✅ 権限チェックが正確

### 望ましい条件
- ✅ ページ読み込み速度が維持される
- ✅ ユーザーから混乱の報告がない
- ✅ エラーログが増加しない

---

## 9. モニタリング指標

実装後、以下を監視：

| 指標 | 正常範囲 | アラート条件 |
|-----|---------|-----------|
| 投票成功率 | 95%以上 | 90%未満 |
| ページエラー率 | 1%未満 | 3%以上 |
| API応答時間 | 500ms以下 | 1000ms以上 |
| 権限エラー数 | 5件/日以下 | 20件/日以上 |

---

## 10. 推奨事項

### 🚀 実装を進めるべき理由
1. システムの一貫性が向上
2. バグが削減される
3. 組織の段階的導入に最適
4. コードの保守性が向上

### ⚠️ 注意点
1. 十分なテストを実施
2. ユーザーへの事前説明
3. ロールバック準備を万全に
4. 段階的なデプロイ

### 📋 次のアクション
1. [ ] チーム承認取得
2. [ ] テスト環境準備
3. [ ] 実装開始
4. [ ] ユーザー通知準備

---

**結論**: リスクは管理可能。慎重に実装すれば、大きな問題なく移行可能。

---

最終更新: 2025-10-04
承認待ち: システム管理者
