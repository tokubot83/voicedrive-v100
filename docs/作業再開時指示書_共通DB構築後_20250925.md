# ä½œæ¥­å†é–‹æ™‚æŒ‡ç¤ºæ›¸ - å…±é€šDBæ§‹ç¯‰å¾Œ

**æ–‡æ›¸ç¨®åˆ¥**: ä½œæ¥­æŒ‡ç¤ºæ›¸
**ä½œæˆæ—¥**: 2025å¹´9æœˆ25æ—¥ 01:10
**ä½œæˆè€…**: VoiceDriveé–‹ç™ºãƒãƒ¼ãƒ 
**å¯¾è±¡**: é–‹ç™ºãƒãƒ¼ãƒ ãƒ»æ¬¡å›ä½œæ¥­æ‹…å½“è€…
**é‡è¦åº¦**: ğŸ”´ **å¿…èª­**

---

## ğŸ“‹ ç¾åœ¨ã®çŠ¶æ³ã‚µãƒãƒªãƒ¼

### å®Œäº†æ¸ˆã¿ä½œæ¥­ï¼ˆ2025å¹´9æœˆ25æ—¥ 01:00æ™‚ç‚¹ï¼‰

#### 1. ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹çª“å£æ©Ÿèƒ½çµ±åˆ âœ…
- å…¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤å®Ÿè£…å®Œäº†ï¼ˆ7,160è¡Œï¼‰
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ã¨ã®APIé€£æºå®Ÿè£…æ¸ˆã¿
- ãƒ†ã‚¹ãƒˆ18é …ç›®ã™ã¹ã¦æˆåŠŸ
- **DBæ¥ç¶šéƒ¨åˆ†ã®ã¿æœªå®Ÿè£…**ï¼ˆãƒ¡ãƒ¢ãƒªå®Ÿè£…ã§ä»®å¯¾å¿œï¼‰

#### 2. ç§˜å¯†æƒ…å ±é…ä¿¡ã‚·ã‚¹ãƒ†ãƒ  âœ…
- SecretDeliveryServiceå®Ÿè£…å®Œäº†
- ç®¡ç†ç”»é¢UIå®Ÿè£…å®Œäº†
- CLIãƒ„ãƒ¼ãƒ«å®Ÿè£…ãƒ»å‹•ä½œç¢ºèªæ¸ˆã¿
- **DBä¿å­˜éƒ¨åˆ†ã®ã¿æœªå®Ÿè£…**ï¼ˆMapä½¿ç”¨ã§ä»®å¯¾å¿œï¼‰

#### 3. MySQLæ¥ç¶šæº–å‚™ âœ…
- æ¥ç¶šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å®Ÿè£…å®Œäº†
- ãƒ—ãƒ¼ãƒ«ç®¡ç†å®Ÿè£…æ¸ˆã¿
- **å®ŸDBã¸ã®æ¥ç¶šå¾…ã¡**

---

## ğŸš¨ ä½œæ¥­å†é–‹æ™‚ã®æœ€å„ªå…ˆäº‹é …

### Step 1: ç§˜å¯†æƒ…å ±ã®å–å¾—ï¼ˆ9:00ä»¥é™ï¼‰

```bash
# åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ ã‹ã‚‰é…ä¿¡ã•ã‚Œã‚‹ç§˜å¯†æƒ…å ±ã‚’å–å¾—
npm run secrets:retrieve -- SEC-20250925-MED001 -t <ãƒˆãƒ¼ã‚¯ãƒ³> -o .env.production

# ç¢ºèª
cat .env.production | grep "DB_PASSWORD"
```

### Step 2: å…±é€šDBã¸ã®æ¥ç¶šç¢ºèª

```bash
# MySQLæ¥ç¶šãƒ†ã‚¹ãƒˆ
npx tsx -e "
import { mysqlManager } from './src/config/mysql-connection.config';
(async () => {
  const health = await mysqlManager.healthCheck();
  console.log('DBæ¥ç¶šçŠ¶æ…‹:', health);
})();
"
```

---

## ğŸ—„ï¸ DBæ§‹ç¯‰å¾Œã®å®Ÿè£…ä½œæ¥­ãƒªã‚¹ãƒˆ

### 1. ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é€šå ±ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ

```sql
-- compliance_reports ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE compliance_reports (
  report_id VARCHAR(100) PRIMARY KEY,
  anonymous_id VARCHAR(100) UNIQUE NOT NULL,
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  reporter_disclosure_level ENUM('full_anonymous', 'conditional', 'disclosed'),
  category_main VARCHAR(50),
  category_sub VARCHAR(50),
  incident_description TEXT,
  incident_date DATE,
  severity ENUM('low', 'medium', 'high', 'critical'),
  current_status VARCHAR(50),
  encrypted_data TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_anonymous_id (anonymous_id),
  INDEX idx_status (current_status),
  INDEX idx_severity (severity)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE audit_logs (
  log_id VARCHAR(100) PRIMARY KEY,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  user_id VARCHAR(100),
  user_role VARCHAR(50),
  report_id VARCHAR(100),
  action VARCHAR(100),
  details JSON,
  ip_address VARCHAR(45),
  previous_hash VARCHAR(64),
  current_hash VARCHAR(64) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_report_id (report_id),
  INDEX idx_user_id (user_id),
  INDEX idx_timestamp (timestamp),
  FOREIGN KEY (report_id) REFERENCES compliance_reports(report_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- encrypted_files ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE encrypted_files (
  file_id VARCHAR(100) PRIMARY KEY,
  report_id VARCHAR(100),
  original_name VARCHAR(255),
  encrypted_path VARCHAR(500),
  mime_type VARCHAR(100),
  size BIGINT,
  checksum VARCHAR(64),
  encryption_key_id VARCHAR(50),
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  uploaded_by VARCHAR(100),
  verified BOOLEAN DEFAULT FALSE,
  INDEX idx_report_id (report_id),
  FOREIGN KEY (report_id) REFERENCES compliance_reports(report_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- secret_deliveries ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç§˜å¯†æƒ…å ±é…ä¿¡ç”¨ï¼‰
CREATE TABLE secret_deliveries (
  delivery_id VARCHAR(50) PRIMARY KEY,
  recipient VARCHAR(100) NOT NULL,
  token_hash VARCHAR(64) NOT NULL,
  encrypted_data TEXT NOT NULL,
  iv VARCHAR(100) NOT NULL,
  auth_tag VARCHAR(100) NOT NULL,
  salt VARCHAR(100) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  requires_mfa BOOLEAN DEFAULT TRUE,
  ip_restrictions JSON,
  max_attempts INT DEFAULT 3,
  access_attempts INT DEFAULT 0,
  accessed BOOLEAN DEFAULT FALSE,
  accessed_at TIMESTAMP NULL,
  accessed_by VARCHAR(100),
  accessed_from VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by VARCHAR(100),
  INDEX idx_recipient (recipient),
  INDEX idx_expires_at (expires_at),
  INDEX idx_accessed (accessed)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 2. ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®DBå¯¾å¿œå®Ÿè£…

#### ComplianceSecurityService.ts ã®æ›´æ–°ç®‡æ‰€

```typescript
// ç¾åœ¨ã®å®Ÿè£…ï¼ˆLine 359-360ï¼‰
private async saveAuditLog(log: AuditLog): Promise<void> {
  // TODO: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
  console.log('Saving audit log:', log);
}

// DBæ§‹ç¯‰å¾Œã®å®Ÿè£…
private async saveAuditLog(log: AuditLog): Promise<void> {
  await mysqlManager.executeUpdate(
    `INSERT INTO audit_logs (
      log_id, timestamp, user_id, user_role, report_id,
      action, details, ip_address, previous_hash, current_hash
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      log.id, log.timestamp, log.userId, log.userRole, log.reportId,
      log.action, JSON.stringify(log.details), log.ipAddress,
      log.previousHash, log.currentHash
    ]
  );
}
```

#### SecretDeliveryService.ts ã®æ›´æ–°ç®‡æ‰€

```typescript
// ç¾åœ¨ã®å®Ÿè£…ï¼ˆLine 56ï¼‰
private deliveries: Map<string, SecretDelivery> = new Map();

// DBæ§‹ç¯‰å¾Œã®å®Ÿè£…
// Mapã‚’å‰Šé™¤ã—ã€ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

private async saveDelivery(delivery: SecretDelivery): Promise<void> {
  await mysqlManager.executeUpdate(
    `INSERT INTO secret_deliveries (
      delivery_id, recipient, token_hash, encrypted_data,
      iv, auth_tag, salt, expires_at, requires_mfa,
      ip_restrictions, max_attempts, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      delivery.deliveryId, delivery.recipient, delivery.tokenHash,
      delivery.encrypted, delivery.iv, delivery.authTag, delivery.salt,
      delivery.expiresAt, delivery.requiresMFA,
      JSON.stringify(delivery.ipRestrictions),
      delivery.maxAccessAttempts, delivery.createdBy
    ]
  );
}

private async getDelivery(deliveryId: string): Promise<SecretDelivery | null> {
  const results = await mysqlManager.executeQuery(
    'SELECT * FROM secret_deliveries WHERE delivery_id = ?',
    [deliveryId]
  );

  if (results.length === 0) return null;

  const row = results[0];
  return {
    deliveryId: row.delivery_id,
    recipient: row.recipient,
    tokenHash: row.token_hash,
    encrypted: row.encrypted_data,
    // ... ãƒãƒƒãƒ”ãƒ³ã‚°ç¶šã
  };
}
```

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

```bash
# ãƒ•ã‚¡ã‚¤ãƒ«: src/scripts/migrate-db.ts
import { mysqlManager } from '../config/mysql-connection.config';
import fs from 'fs';
import path from 'path';

async function migrate() {
  console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...');

  // SQLãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
  const sqlPath = path.join(__dirname, '../../migrations/001_initial_schema.sql');
  const sql = fs.readFileSync(sqlPath, 'utf-8');

  // SQLã®å®Ÿè¡Œ
  const statements = sql.split(';').filter(s => s.trim());
  for (const statement of statements) {
    await mysqlManager.executeUpdate(statement);
    console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†');
  }

  console.log('ğŸ‰ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ï¼');
}

migrate().catch(console.error);
```

### 4. æ¥ç¶šãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

```bash
# çµ±åˆãƒ†ã‚¹ãƒˆã®å†å®Ÿè¡Œ
npm run test:integration

# DBæ¥ç¶šã‚’å«ã‚€æ–°ã—ã„ãƒ†ã‚¹ãƒˆã®ä½œæˆ
npm run test:db
```

---

## ğŸ“Š DBå¯¾å¿œã®å½±éŸ¿ç¯„å›²

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´ç®‡æ‰€ | å„ªå…ˆåº¦ | å·¥æ•° |
|---------|---------|--------|------|
| ComplianceSecurityService.ts | 5ç®‡æ‰€ï¼ˆä¿å­˜/å–å¾—ï¼‰ | é«˜ | 2æ™‚é–“ |
| ComplianceTransferService.ts | 3ç®‡æ‰€ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼‰ | é«˜ | 1æ™‚é–“ |
| SecretDeliveryService.ts | 7ç®‡æ‰€ï¼ˆCRUDæ“ä½œï¼‰ | é«˜ | 2æ™‚é–“ |
| EnhancedReportForm.tsx | å¤‰æ›´ãªã— | - | - |
| mysql-connection.config.ts | å¤‰æ›´ãªã—ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰ | - | - |
| æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | å…¨ä½“ | é«˜ | 1æ™‚é–“ |

**æ¨å®šä½œæ¥­æ™‚é–“**: ç´„6æ™‚é–“

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
```typescript
// å¿…ãšãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ä¾‹
await mysqlManager.executeTransaction(async (connection) => {
  // é€šå ±ãƒ‡ãƒ¼ã‚¿ä¿å­˜
  await connection.execute('INSERT INTO compliance_reports ...');

  // ç›£æŸ»ãƒ­ã‚°ä¿å­˜
  await connection.execute('INSERT INTO audit_logs ...');

  // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ä¿å­˜
  await connection.execute('INSERT INTO encrypted_files ...');
});
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
```typescript
try {
  await saveToDatabase(data);
} catch (error) {
  // DBã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¡ãƒ¢ãƒªã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  this.temporaryStorage.set(id, data);
  console.error('DB save failed, using memory:', error);
}
```

### 3. æ–‡å­—ã‚³ãƒ¼ãƒ‰æ³¨æ„
- å¿…ãšutf8mb4ã‚’ä½¿ç”¨ï¼ˆçµµæ–‡å­—å¯¾å¿œï¼‰
- æ—¥æœ¬èªãƒ‡ãƒ¼ã‚¿ã®ãƒ†ã‚¹ãƒˆã‚’å¿…ãšå®Ÿæ–½

---

## ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ä½œæ¥­å†é–‹æ™‚ã¯ä»¥ä¸‹ã®é †ç•ªã§å®Ÿæ–½ï¼š

- [ ] 1. ç§˜å¯†æƒ…å ±ã®å–å¾—ï¼ˆ.env.productionæ›´æ–°ï¼‰
- [ ] 2. MySQLæ¥ç¶šç¢ºèª
- [ ] 3. ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰
- [ ] 4. ComplianceSecurityServiceã®DBå¯¾å¿œ
- [ ] 5. SecretDeliveryServiceã®DBå¯¾å¿œ
- [ ] 6. ComplianceTransferServiceã®DBå¯¾å¿œ
- [ ] 7. çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
- [ ] 8. æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèª
- [ ] 9. è² è·ãƒ†ã‚¹ãƒˆ
- [ ] 10. æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆ
```bash
# 1. æ¥ç¶šæƒ…å ±ç¢ºèª
cat .env.production | grep DB_

# 2. ãƒãƒ¼ãƒˆé–‹æ”¾ç¢ºèª
telnet mysql-primary.medical-system.kosei-kai.jp 3306

# 3. SSLè¨¼æ˜æ›¸ç¢ºèª
ls -la /secure/certs/mysql-ca.crt

# 4. æ¨©é™ç¢ºèª
mysql -h mysql-primary.medical-system.kosei-kai.jp -u voicedrive_prod -p
```

### æ–‡å­—åŒ–ã‘ã®å ´åˆ
```sql
-- æ–‡å­—ã‚³ãƒ¼ãƒ‰ç¢ºèª
SHOW VARIABLES LIKE 'character_set%';
SHOW VARIABLES LIKE 'collation%';

-- å¼·åˆ¶çš„ã«utf8mb4ã«è¨­å®š
SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

## ğŸ“ é€£çµ¡å…ˆ

### æŠ€è¡“çš„ãªè³ªå•
- Slack: #voicedrive-tech
- Email: dev@voicedrive.ai

### DBé–¢é€£ã®å•é¡Œ
- åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ : db-support@medical-system.kosei-kai.jp

### ç·Šæ€¥æ™‚
- ã‚ªãƒ³ã‚³ãƒ¼ãƒ«: 080-xxxx-xxxx

---

## ğŸ¯ æœ€çµ‚ç›®æ¨™

1. **9æœˆ25æ—¥ åˆå‰**: ç§˜å¯†æƒ…å ±å–å¾—ãƒ»DBæ¥ç¶šç¢ºèª
2. **9æœˆ25æ—¥ åˆå¾Œ**: DBå¯¾å¿œå®Ÿè£…å®Œäº†
3. **9æœˆ26æ—¥ åˆå‰**: çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†
4. **9æœˆ26æ—¥ åˆå¾Œ**: è² è·ãƒ†ã‚¹ãƒˆå®Œäº†
5. **9æœˆ27æ—¥**: æœ¬ç•ªã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹

---

**é‡è¦**: ã“ã®æŒ‡ç¤ºæ›¸ã«å¾“ã£ã¦ä½œæ¥­ã‚’é€²ã‚ã‚Œã°ã€ã‚¹ãƒ ãƒ¼ã‚ºã«DBçµ±åˆãŒå®Œäº†ã—ã¾ã™ã€‚
ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ä¸Šè¨˜é€£çµ¡å…ˆã¾ã§ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚

---

**æ–‡æ›¸ä½œæˆæ—¥**: 2025å¹´9æœˆ25æ—¥
**æœ€çµ‚æ›´æ–°**: ä½œæ¥­å†é–‹æ™‚ã«æ›´æ–°äºˆå®š
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: DBæ§‹ç¯‰å®Œäº†å¾Œ

---

*æœ¬æŒ‡ç¤ºæ›¸ã¯VoiceDriveé–‹ç™ºãƒãƒ¼ãƒ ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚*