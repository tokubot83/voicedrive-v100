# 作業再開時指示書 - 共通DB構築後

**文書種別**: 作業指示書
**作成日**: 2025年9月25日 01:10
**作成者**: VoiceDrive開発チーム
**対象**: 開発チーム・次回作業担当者
**重要度**: 🔴 **必読**

---

## 📋 現在の状況サマリー

### 完了済み作業（2025年9月25日 01:00時点）

#### 1. コンプライアンス窓口機能統合 ✅
- 全アプリケーション層実装完了（7,160行）
- 医療システムとのAPI連携実装済み
- テスト18項目すべて成功
- **DB接続部分のみ未実装**（メモリ実装で仮対応）

#### 2. 秘密情報配信システム ✅
- SecretDeliveryService実装完了
- 管理画面UI実装完了
- CLIツール実装・動作確認済み
- **DB保存部分のみ未実装**（Map使用で仮対応）

#### 3. MySQL接続準備 ✅
- 接続マネージャー実装完了
- プール管理実装済み
- **実DBへの接続待ち**

---

## 🚨 作業再開時の最優先事項

### Step 1: 秘密情報の取得（9:00以降）

```bash
# 医療システムチームから配信される秘密情報を取得
npm run secrets:retrieve -- SEC-20250925-MED001 -t <トークン> -o .env.production

# 確認
cat .env.production | grep "DB_PASSWORD"
```

### Step 2: 共通DBへの接続確認

```bash
# MySQL接続テスト
npx tsx -e "
import { mysqlManager } from './src/config/mysql-connection.config';
(async () => {
  const health = await mysqlManager.healthCheck();
  console.log('DB接続状態:', health);
})();
"
```

---

## 🗄️ DB構築後の実装作業リスト

### 1. コンプライアンス通報テーブルの作成

```sql
-- compliance_reports テーブル
CREATE TABLE compliance_reports (
  report_id VARCHAR(100) PRIMARY KEY,
  anonymous_id VARCHAR(100) UNIQUE NOT NULL,
  submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  reporter_disclosure_level ENUM('full_anonymous', 'conditional', 'disclosed'),
  category_main VARCHAR(50),
  category_sub VARCHAR(50),
  incident_description TEXT,
  incident_date DATE,
  severity ENUM('low', 'medium', 'high', 'critical'),
  current_status VARCHAR(50),
  encrypted_data TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_anonymous_id (anonymous_id),
  INDEX idx_status (current_status),
  INDEX idx_severity (severity)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- audit_logs テーブル
CREATE TABLE audit_logs (
  log_id VARCHAR(100) PRIMARY KEY,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  user_id VARCHAR(100),
  user_role VARCHAR(50),
  report_id VARCHAR(100),
  action VARCHAR(100),
  details JSON,
  ip_address VARCHAR(45),
  previous_hash VARCHAR(64),
  current_hash VARCHAR(64) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_report_id (report_id),
  INDEX idx_user_id (user_id),
  INDEX idx_timestamp (timestamp),
  FOREIGN KEY (report_id) REFERENCES compliance_reports(report_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- encrypted_files テーブル
CREATE TABLE encrypted_files (
  file_id VARCHAR(100) PRIMARY KEY,
  report_id VARCHAR(100),
  original_name VARCHAR(255),
  encrypted_path VARCHAR(500),
  mime_type VARCHAR(100),
  size BIGINT,
  checksum VARCHAR(64),
  encryption_key_id VARCHAR(50),
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  uploaded_by VARCHAR(100),
  verified BOOLEAN DEFAULT FALSE,
  INDEX idx_report_id (report_id),
  FOREIGN KEY (report_id) REFERENCES compliance_reports(report_id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- secret_deliveries テーブル（秘密情報配信用）
CREATE TABLE secret_deliveries (
  delivery_id VARCHAR(50) PRIMARY KEY,
  recipient VARCHAR(100) NOT NULL,
  token_hash VARCHAR(64) NOT NULL,
  encrypted_data TEXT NOT NULL,
  iv VARCHAR(100) NOT NULL,
  auth_tag VARCHAR(100) NOT NULL,
  salt VARCHAR(100) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  requires_mfa BOOLEAN DEFAULT TRUE,
  ip_restrictions JSON,
  max_attempts INT DEFAULT 3,
  access_attempts INT DEFAULT 0,
  accessed BOOLEAN DEFAULT FALSE,
  accessed_at TIMESTAMP NULL,
  accessed_by VARCHAR(100),
  accessed_from VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by VARCHAR(100),
  INDEX idx_recipient (recipient),
  INDEX idx_expires_at (expires_at),
  INDEX idx_accessed (accessed)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 2. サービス層のDB対応実装

#### ComplianceSecurityService.ts の更新箇所

```typescript
// 現在の実装（Line 359-360）
private async saveAuditLog(log: AuditLog): Promise<void> {
  // TODO: データベースに保存
  console.log('Saving audit log:', log);
}

// DB構築後の実装
private async saveAuditLog(log: AuditLog): Promise<void> {
  await mysqlManager.executeUpdate(
    `INSERT INTO audit_logs (
      log_id, timestamp, user_id, user_role, report_id,
      action, details, ip_address, previous_hash, current_hash
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      log.id, log.timestamp, log.userId, log.userRole, log.reportId,
      log.action, JSON.stringify(log.details), log.ipAddress,
      log.previousHash, log.currentHash
    ]
  );
}
```

#### SecretDeliveryService.ts の更新箇所

```typescript
// 現在の実装（Line 56）
private deliveries: Map<string, SecretDelivery> = new Map();

// DB構築後の実装
// Mapを削除し、以下のメソッドを追加

private async saveDelivery(delivery: SecretDelivery): Promise<void> {
  await mysqlManager.executeUpdate(
    `INSERT INTO secret_deliveries (
      delivery_id, recipient, token_hash, encrypted_data,
      iv, auth_tag, salt, expires_at, requires_mfa,
      ip_restrictions, max_attempts, created_by
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
    [
      delivery.deliveryId, delivery.recipient, delivery.tokenHash,
      delivery.encrypted, delivery.iv, delivery.authTag, delivery.salt,
      delivery.expiresAt, delivery.requiresMFA,
      JSON.stringify(delivery.ipRestrictions),
      delivery.maxAccessAttempts, delivery.createdBy
    ]
  );
}

private async getDelivery(deliveryId: string): Promise<SecretDelivery | null> {
  const results = await mysqlManager.executeQuery(
    'SELECT * FROM secret_deliveries WHERE delivery_id = ?',
    [deliveryId]
  );

  if (results.length === 0) return null;

  const row = results[0];
  return {
    deliveryId: row.delivery_id,
    recipient: row.recipient,
    tokenHash: row.token_hash,
    encrypted: row.encrypted_data,
    // ... マッピング続き
  };
}
```

### 3. マイグレーションスクリプトの作成

```bash
# ファイル: src/scripts/migrate-db.ts
import { mysqlManager } from '../config/mysql-connection.config';
import fs from 'fs';
import path from 'path';

async function migrate() {
  console.log('🔄 データベースマイグレーション開始...');

  // SQLファイルの読み込み
  const sqlPath = path.join(__dirname, '../../migrations/001_initial_schema.sql');
  const sql = fs.readFileSync(sqlPath, 'utf-8');

  // SQLの実行
  const statements = sql.split(';').filter(s => s.trim());
  for (const statement of statements) {
    await mysqlManager.executeUpdate(statement);
    console.log('✅ テーブル作成完了');
  }

  console.log('🎉 マイグレーション完了！');
}

migrate().catch(console.error);
```

### 4. 接続テストの実施

```bash
# 統合テストの再実行
npm run test:integration

# DB接続を含む新しいテストの作成
npm run test:db
```

---

## 📊 DB対応の影響範囲

| ファイル | 変更箇所 | 優先度 | 工数 |
|---------|---------|--------|------|
| ComplianceSecurityService.ts | 5箇所（保存/取得） | 高 | 2時間 |
| ComplianceTransferService.ts | 3箇所（ステータス更新） | 高 | 1時間 |
| SecretDeliveryService.ts | 7箇所（CRUD操作） | 高 | 2時間 |
| EnhancedReportForm.tsx | 変更なし | - | - |
| mysql-connection.config.ts | 変更なし（実装済み） | - | - |
| 新規マイグレーション | 全体 | 高 | 1時間 |

**推定作業時間**: 約6時間

---

## ⚠️ 注意事項

### 1. トランザクション管理
```typescript
// 必ずトランザクションを使用する例
await mysqlManager.executeTransaction(async (connection) => {
  // 通報データ保存
  await connection.execute('INSERT INTO compliance_reports ...');

  // 監査ログ保存
  await connection.execute('INSERT INTO audit_logs ...');

  // ファイル情報保存
  await connection.execute('INSERT INTO encrypted_files ...');
});
```

### 2. エラーハンドリング
```typescript
try {
  await saveToDatabase(data);
} catch (error) {
  // DBエラー時はメモリにフォールバック
  this.temporaryStorage.set(id, data);
  console.error('DB save failed, using memory:', error);
}
```

### 3. 文字コード注意
- 必ずutf8mb4を使用（絵文字対応）
- 日本語データのテストを必ず実施

---

## 📝 チェックリスト

作業再開時は以下の順番で実施：

- [ ] 1. 秘密情報の取得（.env.production更新）
- [ ] 2. MySQL接続確認
- [ ] 3. テーブル作成（マイグレーション実行）
- [ ] 4. ComplianceSecurityServiceのDB対応
- [ ] 5. SecretDeliveryServiceのDB対応
- [ ] 6. ComplianceTransferServiceのDB対応
- [ ] 7. 統合テストの実行
- [ ] 8. 本番環境での動作確認
- [ ] 9. 負荷テスト
- [ ] 10. 本番サービス開始

---

## 🔧 トラブルシューティング

### DB接続エラーの場合
```bash
# 1. 接続情報確認
cat .env.production | grep DB_

# 2. ポート開放確認
telnet mysql-primary.medical-system.kosei-kai.jp 3306

# 3. SSL証明書確認
ls -la /secure/certs/mysql-ca.crt

# 4. 権限確認
mysql -h mysql-primary.medical-system.kosei-kai.jp -u voicedrive_prod -p
```

### 文字化けの場合
```sql
-- 文字コード確認
SHOW VARIABLES LIKE 'character_set%';
SHOW VARIABLES LIKE 'collation%';

-- 強制的にutf8mb4に設定
SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

## 📞 連絡先

### 技術的な質問
- Slack: #voicedrive-tech
- Email: dev@voicedrive.ai

### DB関連の問題
- 医療システムチーム: db-support@medical-system.kosei-kai.jp

### 緊急時
- オンコール: 080-xxxx-xxxx

---

## 🎯 最終目標

1. **9月25日 午前**: 秘密情報取得・DB接続確認
2. **9月25日 午後**: DB対応実装完了
3. **9月26日 午前**: 統合テスト完了
4. **9月26日 午後**: 負荷テスト完了
5. **9月27日**: 本番サービス開始

---

**重要**: この指示書に従って作業を進めれば、スムーズにDB統合が完了します。
不明な点があれば、上記連絡先までお問い合わせください。

---

**文書作成日**: 2025年9月25日
**最終更新**: 作業再開時に更新予定
**次回レビュー**: DB構築完了後

---

*本指示書はVoiceDrive開発チームにより作成されました。*