# Phase 2: LLMçµ±åˆå®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

Phase 2ã§ã¯ã€åŒ»ç™‚ãƒãƒ¼ãƒ ãŒé–‹ç™ºä¸­ã®Llama 3.2 8B ãƒ­ãƒ¼ã‚«ãƒ«LLM APIã¨VoiceDriveã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ±åˆã—ã¾ã™ã€‚

**å®Ÿè£…æœŸé–“**: Week 5-12 (Phase 1å®Œäº†å¾Œ)
**æ‹…å½“**: VoiceDriveãƒãƒ¼ãƒ  + åŒ»ç™‚è·å“¡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ 

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿
    â†“
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒã‚§ãƒƒã‚¯] (å³åº§ãƒ»300ms debounce)
    â†“
[LLM APIãƒã‚§ãƒƒã‚¯] (è©³ç´°åˆ†æãƒ»2ç§’ä»¥å†…)
    â†“
[çµ±åˆåˆ¤å®š] (æœ€çµ‚æ±ºå®š)
    â†“
æŠ•ç¨¿å¯å¦ã®æ±ºå®š
```

### 3å±¤ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

1. **Layer 1: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒã‚§ãƒƒã‚¯ (Phase 1)**
   - ç¦æ­¢ãƒ•ãƒ¬ãƒ¼ã‚ºæ¤œå‡º
   - ä»£æ›¿è¡¨ç¾ææ¡ˆ
   - å»ºè¨­æ€§ã‚¹ã‚³ã‚¢ç®—å‡º
   - **å‡¦ç†æ™‚é–“**: å³åº§ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹300msï¼‰
   - **ã‚µãƒ¼ãƒãƒ¼è² è·**: ã‚¼ãƒ­

2. **Layer 2: LLM APIè©³ç´°åˆ†æ (Phase 2)**
   - Llama 3.2 8Bã«ã‚ˆã‚‹æ–‡è„ˆç†è§£
   - å¾®å¦™ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹æ¤œå‡º
   - é«˜ç²¾åº¦ãªé•ååˆ¤å®š
   - **å‡¦ç†æ™‚é–“**: 2ç§’ä»¥å†…ï¼ˆç›®æ¨™ï¼‰
   - **ä¿¡é ¼åº¦**: 70-95%

3. **Layer 3: çµ±åˆåˆ¤å®š**
   - ä¸¡çµæœã‚’çµ±åˆ
   - ã‚ˆã‚Šå³ã—ã„åˆ¤å®šã‚’æ¡ç”¨
   - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

---

## ğŸ”§ å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. å‹å®šç¾© (`src/types/llmModeration.ts`)

```typescript
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‹
interface LLMModerationRequest {
  content: string;
  context?: {
    postType?: 'improvement' | 'community' | 'report';
    authorLevel?: number;
    department?: string;
  };
  options?: {
    checkSensitivity?: 'low' | 'medium' | 'high';
    language?: 'ja' | 'en';
    includeExplanation?: boolean;
  };
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
interface LLMModerationResult {
  allowed: boolean;
  severity: 'none' | 'low' | 'medium' | 'high' | 'critical';
  confidence: number;  // 0-100
  violations: LLMViolation[];
  explanation?: string;
  suggestedEdits?: string[];
  metadata: {
    modelVersion: string;
    processingTime: number;
    timestamp: Date;
  };
}
```

### 2. LLM APIã‚µãƒ¼ãƒ“ã‚¹ (`src/services/LLMModerationService.ts`)

**ä¸»ãªæ©Ÿèƒ½**:
- âœ… APIå‘¼ã³å‡ºã—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ5åˆ†é–“ï¼‰
- âœ… çµ±è¨ˆæƒ…å ±åé›†
- âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

**è¨­å®š**:
```typescript
{
  endpoint: 'http://localhost:8000/api/moderate',
  timeout: 3000,           // 3ç§’
  retryAttempts: 2,        // 2å›ãƒªãƒˆãƒ©ã‚¤
  fallbackToLocal: true,   // APIéšœå®³æ™‚ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿
  cacheEnabled: true,      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹
  cacheDuration: 300000    // 5åˆ†é–“
}
```

### 3. ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ (`src/services/HybridModerationService.ts`)

**åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**:
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å³åº§ãƒã‚§ãƒƒã‚¯
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ–ãƒ­ãƒƒã‚¯ â†’ LLMä¸è¦ï¼ˆåŠ¹ç‡åŒ–ï¼‰
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´OK â†’ LLMã§è©³ç´°ãƒã‚§ãƒƒã‚¯
4. ä¸¡çµæœã‚’çµ±åˆã—ã¦æœ€çµ‚åˆ¤å®š

**ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥**:
- LLM APIéšœå®³ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´çµæœã‚’ä½¿ç”¨
- LLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´çµæœã‚’ä½¿ç”¨
- LLMç„¡åŠ¹åŒ–è¨­å®š â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿å‹•ä½œ

### 4. ãƒ¢ãƒƒã‚¯LLM (`src/services/MockLLMAPIServer.ts`)

**é–‹ç™ºç”¨ãƒ¢ãƒƒã‚¯æ©Ÿèƒ½**:
- âœ… Llama 3.2 8Bã®å‹•ä½œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
- âœ… 300-800msã®å‡¦ç†æ™‚é–“å†ç¾
- âœ… é•åæ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…
- âœ… å»ºè¨­æ€§ã‚¹ã‚³ã‚¢è¨ˆç®—
- âœ… ä¿®æ­£ææ¡ˆç”Ÿæˆ

---

## ğŸš€ åŒ»ç™‚ãƒãƒ¼ãƒ  APIå®Ÿè£…è¦ä»¶

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜

**URL**: `POST /api/moderate`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "content": "ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ",
  "context": {
    "postType": "improvement",
    "authorLevel": 3,
    "department": "çœ‹è­·éƒ¨"
  },
  "options": {
    "checkSensitivity": "medium",
    "language": "ja",
    "includeExplanation": true
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "allowed": false,
  "severity": "high",
  "confidence": 87,
  "violations": [
    {
      "type": "personal_attack",
      "severity": "high",
      "description": "ç‰¹å®šã®å€‹äººã¸ã®æ”»æ’ƒçš„ãªè¡¨ç¾ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ",
      "extractedText": "ãƒã‚«",
      "startIndex": 10,
      "endIndex": 12,
      "confidence": 92
    }
  ],
  "explanation": "ä»¥ä¸‹ã®ç†ç”±ã«ã‚ˆã‚ŠæŠ•ç¨¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸï¼šç‰¹å®šã®å€‹äººã¸ã®æ”»æ’ƒçš„ãªè¡¨ç¾ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚",
  "suggestedEdits": [
    "æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ã¨è€ƒãˆã¾ã™"
  ],
  "metadata": {
    "modelVersion": "llama-3.2-8b-v1.0",
    "processingTime": 1847,
    "timestamp": "2025-10-04T12:34:56Z"
  }
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| å¹³å‡å¿œç­”æ™‚é–“ | 2ç§’ä»¥å†… |
| P95å¿œç­”æ™‚é–“ | 3ç§’ä»¥å†… |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | 3ç§’ |
| ä¿¡é ¼åº¦ | 70-95% |
| å¯ç”¨æ€§ | 99% |

### é•åã‚¿ã‚¤ãƒ—

```typescript
type LLMViolationType =
  | 'personal_attack'       // å€‹äººæ”»æ’ƒ
  | 'defamation'            // èª¹è¬—ä¸­å‚·
  | 'harassment'            // ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆ
  | 'discrimination'        // å·®åˆ¥çš„è¡¨ç¾
  | 'privacy_violation'     // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³
  | 'inappropriate_content' // ä¸é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  | 'threatening'           // è„…è¿«çš„è¡¨ç¾
  | 'hate_speech'          // ãƒ˜ã‚¤ãƒˆã‚¹ãƒ”ãƒ¼ãƒ
  | 'misinformation'       // èª¤æƒ…å ±ãƒ»ãƒ‡ãƒ
  | 'spam'                 // ã‚¹ãƒ‘ãƒ 
  | 'other';               // ãã®ä»–
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ‰‹é †

### 1. ãƒ¢ãƒƒã‚¯LLMã§ã®ãƒ†ã‚¹ãƒˆï¼ˆç¾åœ¨ï¼‰

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env
# REACT_APP_USE_MOCK_LLM=true ã«è¨­å®š

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆ
# 1. æŠ•ç¨¿ä½œæˆç”»é¢ã§ã€Œãƒã‚«ã€ãªã©ã®ç¦æ­¢èªã‚’å…¥åŠ›
# 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
# 3. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ¢ãƒƒã‚¯LLMå‹•ä½œã‚’ç¢ºèª
```

### 2. åŒ»ç™‚ãƒãƒ¼ãƒ APIçµ±åˆãƒ†ã‚¹ãƒˆ

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’åŒ»ç™‚ãƒãƒ¼ãƒ APIã«è¨­å®š
REACT_APP_LLM_API_ENDPOINT=http://medical-team-server:8000/api/moderate
REACT_APP_USE_MOCK_LLM=false

# çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:llm-integration

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:3001/api/llm/health
```

### 3. çµ±è¨ˆæƒ…å ±ç¢ºèª

```typescript
import { HybridModerationService } from './services/HybridModerationService';

const service = HybridModerationService.getInstance();
const stats = service.getLLMStats();

console.log('LLMçµ±è¨ˆ:', {
  totalRequests: stats.totalRequests,
  apiSuccessRate: stats.apiSuccessRate,
  averageProcessingTime: stats.averageProcessingTime,
  cacheHitRate: stats.cacheHitRate
});
```

---

## ğŸ“Š ç›£è¦–ãƒ»é‹ç”¨

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé–“**: 5åˆ†é–“
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒãƒƒã‚·ãƒ¥å€¤
- **è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: 10åˆ†ã”ã¨

### çµ±è¨ˆæƒ…å ±

```typescript
interface LLMModerationStats {
  totalRequests: number;
  totalViolations: number;
  averageProcessingTime: number;  // ãƒŸãƒªç§’
  apiSuccessRate: number;         // %
  violationsByType: Record<LLMViolationType, number>;
  cacheHitRate: number;           // %
}
```

### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šï¼ˆæ¨å¥¨ï¼‰

| æ¡ä»¶ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|------|-----------|
| APIæˆåŠŸç‡ < 90% | è­¦å‘Šé€šçŸ¥ |
| å¹³å‡å¿œç­”æ™‚é–“ > 2.5ç§’ | è­¦å‘Šé€šçŸ¥ |
| APIæˆåŠŸç‡ < 50% | LLMç„¡åŠ¹åŒ–ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ï¼‰ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆé€£ç¶š5å› | LLMç„¡åŠ¹åŒ– |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### APIèªè¨¼

```bash
# APIã‚­ãƒ¼è¨­å®šï¼ˆåŒ»ç™‚ãƒãƒ¼ãƒ ã‹ã‚‰æä¾›ï¼‰
REACT_APP_LLM_API_KEY=your-secret-api-key
```

### ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼

- âœ… æŠ•ç¨¿å†…å®¹ã¯ä¸€æ™‚çš„ã«LLM APIã«é€ä¿¡
- âœ… åŒ»ç™‚ãƒãƒ¼ãƒ ã®ãƒ­ãƒ¼ã‚«ãƒ«LLMã§å‡¦ç†ï¼ˆå¤–éƒ¨é€ä¿¡ãªã—ï¼‰
- âœ… APIå´ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãªã—ï¼ˆåŒ»ç™‚ãƒãƒ¼ãƒ ä»•æ§˜ã«æº–æ‹ ï¼‰
- âœ… é€šä¿¡ã¯å…¨ã¦HTTPSï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

---

## ğŸ“… çµ±åˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Week 5-8: åŒ»ç™‚ãƒãƒ¼ãƒ å®Ÿè£…
- [ ] Llama 3.2 8B APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- [ ] AWS Lightsailãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### Week 9-10: VoiceDriveçµ±åˆ
- [ ] ãƒ¢ãƒƒã‚¯ã‹ã‚‰ãƒªã‚¢ãƒ«APIåˆ‡ã‚Šæ›¿ãˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼

### Week 11-12: æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹æº–å‚™
- [ ] è² è·ãƒ†ã‚¹ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Q1: LLM APIã«æ¥ç¶šã§ããªã„

**ç¢ºèªäº‹é …**:
1. ç’°å¢ƒå¤‰æ•° `REACT_APP_LLM_API_ENDPOINT` ãŒæ­£ã—ã„ã‹
2. åŒ»ç™‚ãƒãƒ¼ãƒ ã®APIã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒæ­£å¸¸ã‹

**å¯¾å‡¦**:
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
npm run llm:health

# ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰å¼·åˆ¶æœ‰åŠ¹åŒ–
REACT_APP_DISABLE_LLM=true npm run dev
```

### Q2: å¿œç­”ãŒé…ã„ï¼ˆ3ç§’ä»¥ä¸Šï¼‰

**ç¢ºèªäº‹é …**:
1. åŒ»ç™‚ãƒãƒ¼ãƒ APIã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹ã‹
3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

**å¯¾å‡¦**:
```bash
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·ï¼ˆä¸€æ™‚çš„ï¼‰
REACT_APP_LLM_TIMEOUT=5000 npm run dev

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“å»¶é•·
REACT_APP_LLM_CACHE_DURATION=600000  # 10åˆ†
```

### Q3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ãŒä½ã„

**åŸå› **: åŒã˜å†…å®¹ã®æŠ•ç¨¿ãŒå°‘ãªã„

**å¯¾å‡¦**:
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœŸé–“ã‚’å»¶é•·
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®è¦‹ç›´ã—

---

## ğŸ“ é€£çµ¡å…ˆ

- **VoiceDriveãƒãƒ¼ãƒ **: voicedrive-dev@example.com
- **åŒ»ç™‚ã‚·ã‚¹ãƒ†ãƒ ãƒãƒ¼ãƒ **: medical-system@example.com
- **çµ±åˆãƒ†ã‚¹ãƒˆçª“å£**: integration@example.com

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ4æ—¥
**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Phase 2 v1.0
