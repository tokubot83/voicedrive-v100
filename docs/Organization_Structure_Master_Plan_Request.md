# 組織構造拡張実装 - マスタープラン統合依頼書

**作成日**: 2025-10-12
**作成者**: VoiceDrive開発チーム
**宛先**: 医療職員管理システム開発チーム
**重要度**: 高

---

## 📋 エグゼクティブサマリー

VoiceDriveの議題モード・プロジェクトモードにおいて、**病院組織構造に基づく柔軟な投票スコープ管理**を実装する準備が完了しました。

しかし、**現在の実装タイミングでは本番環境への悪影響（Vercel真っ白/真っ黒）のリスク**があるため、以下を提案します：

### 🎯 提案内容

1. **実装を共通DB構築時まで延期**
2. **マスタープランへの組織構造拡張の記載**
3. **両システムでの同時実装**

---

## 🚨 現在のリスク評価

### なぜ今すぐ実装できないのか？

| リスク項目 | 詳細 | 影響度 |
|-----------|------|--------|
| **Vercelデプロイ破壊** | schema.prisma変更→Prismaマイグレーション→本番DB変更→既存アプリ動作不能 | 🔴 致命的 |
| **データ整合性** | 医療システムとの組織マスター同期前にVoiceDrive側でテーブル作成 | 🟡 中 |
| **ロールバック困難** | 一度実行したマイグレーションは元に戻せない | 🔴 高 |
| **医療システム連携** | 組織マスターは医療システム管理と決定済み（データ管理責任分界点定義書） | 🟡 中 |

### 実装準備状況

✅ **完了済み**:
- Prismaスキーマ拡張設計（8テーブル、190フィールド）
- シードデータスクリプト作成（施設・組織・職種・議題モード設定）
- 医療チームへの組織情報依頼＆回答取得
- 投票スコープパターン設計（A/B/C）

⏸️ **保留中**（リスクのため未実行）:
- Prismaマイグレーション実行
- データベーステーブル作成
- 本番環境デプロイ

---

## 📦 実装成果物（準備完了）

### 1. Prismaスキーマ拡張（`schema.prisma` L2201-2390）

```prisma
// 新規テーブル（8個）
model Facility { ... }                     // 施設マスター
model OrganizationStructure { ... }        // 組織構造マスター
model VotingGroup { ... }                  // 投票グループ
model AgendaModeConfig { ... }             // 議題モード設定
model AgendaModeGroupConfig { ... }        // 議題モードグループ設定
model ProjectModeConfig { ... }            // プロジェクトモード設定
model ProjectModeGroupConfig { ... }       // プロジェクトモードグループ設定
model JobCategory { ... }                  // 職種マスター
```

### 2. シードデータスクリプト

| ファイル | 内容 | データ件数 |
|---------|------|-----------|
| `prisma/seed/01-facilities.ts` | 施設マスター | 3施設 |
| `prisma/seed/02-organization-structure.ts` | 組織構造 | 23部門 |
| `prisma/seed/03-job-categories.ts` | 職種マスター | 24職種（新規5職種含む） |
| `prisma/seed/04-agenda-mode-configs.ts` | 議題モード設定 | 23部門設定 |
| `prisma/seed/index.ts` | 統合実行スクリプト | - |

### 3. 医療チーム確定データ

#### 施設情報（3施設）
- 小原病院（`obara-hospital`）- 80名、10部門
- 立神リハビリテーション温泉病院（`tategami-rehabilitation`）- 100名、7部門
- エスポワール立神（`espoir-tategami`）- 150名、6部門

#### 投票スコープパターン（確定）
- **パターンA** (location_based): 看護部門 - 病棟・外来単位投票
- **パターンB** (profession_based): リハビリ部門 - 職種単位投票（PT/OT/ST）
- **パターンC** (department_based): 小規模部門 - 部門全体投票

#### 新規職種（5職種追加）
1. ケアマネージャー
2. 社会福祉士
3. 介護福祉士
4. 管理栄養士
5. 栄養士

---

## 🎯 マスタープラン統合依頼内容

### 依頼事項1: マスタープランへの記載

以下を医療システム開発マスタープランに追加してください：

#### 追加項目: 「組織構造マスター統合実装」

**実装フェーズ**: 共通DB構築時（Phase X）
**担当**: VoiceDrive開発チーム + 医療システム開発チーム
**期間**: X週間

**実装内容**:
1. **組織マスターテーブル作成**（医療システム側）
   - 施設マスター
   - 部門マスター
   - 職種マスター
   - 職員組織紐付け

2. **VoiceDrive投票ルールテーブル作成**（VoiceDrive側）
   - 投票グループ
   - 議題モード設定
   - プロジェクトモード設定

3. **API連携設定**
   - 日次バッチ同期（組織マスター）
   - Webhook連携（組織変更通知）

**前提条件**:
- [ ] 共通DBインフラ構築完了
- [ ] 医療システム組織マスターAPI完成
- [ ] VoiceDrive開発環境での動作確認完了（✅ 完了済み）

**成功基準**:
- [ ] 3施設23部門のデータ正常登録
- [ ] 投票スコープパターンA/B/C動作確認
- [ ] 医療システムからの組織変更反映テスト成功

### 依頼事項2: データ管理責任分界点の確認

「データ管理責任分界点定義書」に以下を追記：

| データ項目 | 管理責任 | 連携方法 | VoiceDrive側実装 |
|-----------|---------|---------|-----------------|
| **施設マスター** | 医療システム | API（日次バッチ） | キャッシュテーブル |
| **組織構造マスター** | 医療システム | API（日次バッチ） | キャッシュテーブル |
| **職種マスター** | 医療システム | API（日次バッチ） | キャッシュテーブル |
| **投票グループ** | VoiceDrive | - | マスターテーブル |
| **議題モード設定** | VoiceDrive | - | マスターテーブル |
| **プロジェクトモード設定** | VoiceDrive | - | マスターテーブル |

---

## 📅 推奨実装スケジュール

### タイミング: 共通DB構築時

```mermaid
gantt
    title 組織構造拡張実装スケジュール
    dateFormat  YYYY-MM-DD
    section 医療システム側
    組織マスターAPI開発     :a1, 2025-XX-XX, 5d
    API動作確認            :a2, after a1, 2d
    section VoiceDrive側
    スキーママイグレーション  :b1, after a2, 1d
    シードデータ投入         :b2, after b1, 1d
    投票ロジック実装         :b3, after b2, 3d
    section 統合テスト
    連携テスト              :c1, after b3, 2d
    本番デプロイ            :c2, after c1, 1d
```

### 実装手順（共通DB構築時）

#### Phase 1: 環境準備（1日）
1. 共通DB環境確認
2. 医療システムAPI接続確認
3. VoiceDrive開発環境バックアップ

#### Phase 2: データベース構築（2日）
1. **医療システム側**:
   ```sql
   -- 施設マスター
   CREATE TABLE facilities (...);
   -- 組織構造マスター
   CREATE TABLE organization_structures (...);
   -- 職種マスター
   CREATE TABLE job_categories (...);
   ```

2. **VoiceDrive側**:
   ```bash
   # Prismaマイグレーション実行
   npx prisma migrate deploy

   # シードデータ投入
   npm run db:seed
   ```

#### Phase 3: 動作確認（2日）
1. 組織データ同期テスト
2. 投票スコープパターンA/B/Cテスト
3. 医療システム変更→VoiceDrive反映テスト

#### Phase 4: 本番デプロイ（1日）
1. 本番環境マイグレーション
2. 本番データ投入
3. 監視設定

---

## 🔄 代替案: 段階的実装

もし完全延期が難しい場合、以下の段階的実装も可能です：

### Option A: 開発環境のみ先行実装
- **メリット**: 早期検証可能、フィードバック収集
- **デメリット**: 本番環境との差分管理が必要

### Option B: フィーチャーフラグ実装
- **メリット**: 本番環境にコードをマージしても機能無効化可能
- **デメリット**: 実装複雑化

### Option C: 別ブランチでの開発継続
- **メリット**: 本番環境に影響なし
- **デメリット**: マージ時のコンフリクトリスク

---

## 📞 次のアクション

### VoiceDrive開発チームからのお願い

1. **マスタープランへの記載検討**
   - 組織構造拡張実装フェーズの追加
   - 実装タイミングの確定（共通DB構築時）

2. **データ管理責任の再確認**
   - 組織マスター管理主体の明確化
   - API仕様の詳細化

3. **実装スケジュール調整**
   - 共通DB構築スケジュールの共有
   - 組織構造拡張実装期間の確保

### 医療チームへの質問

- [ ] マスタープランへの記載は可能ですか？
- [ ] 共通DB構築の予定時期はいつ頃ですか？
- [ ] 組織マスターAPI開発の工数見積もりは？
- [ ] それまでの間、VoiceDrive側で暫定対応は必要ですか？

---

## 📄 添付ドキュメント

準備完了している実装ドキュメント：

1. ✅ `schema_organization_extension.prisma` - 組織構造拡張スキーマ（850行）
2. ✅ `Organization_Structure_Migration_Plan.md` - マイグレーション計画（600行）
3. ✅ `Medical_Team_Organization_Information_Request_Integrated.md` - 組織情報依頼書（700行）
4. ✅ `Organization_Implementation_Action_Plan.md` - 実装アクションプラン（医療チーム回答反映済み）
5. ✅ `prisma/seed/` - 全シードスクリプト（4ファイル + index）

**すべての実装準備は完了しています。**
**安全な実装タイミング（共通DB構築時）をお待ちしています。**

---

## ✅ 結論

### 現状の判断: **実装延期が最適**

**理由**:
1. Vercel本番環境への影響リスク回避
2. 医療システムとの統合タイミング整合
3. データ管理責任分界点定義書との整合性

### 次のステップ

1. 医療チームへのマスタープラン記載依頼
2. 共通DB構築スケジュール確定待ち
3. その時点での一括実装

### 期待される効果（実装時）

- ✅ 病院組織構造に基づく柔軟な投票管理
- ✅ 部門特性に応じた投票スコープ（location/profession/department）
- ✅ 小規模部門の統合投票グループ対応
- ✅ Level 99による動的組織構造再構成
- ✅ 医療システムとのリアルタイム組織変更同期

---

**作成者**: VoiceDrive開発チーム
**連絡先**: VoiceDrive開発Slack #phase2-integration
**最終更新**: 2025-10-12
