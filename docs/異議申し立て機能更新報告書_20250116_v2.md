# 異議申し立て機能更新報告書（医療チーム回答対応版）

## 更新日: 2025年1月16日 v2
## 実装者: VoiceDriveチーム  
## 宛先: 医療職員管理システムチーム

---

## 1. 更新概要

医療チームからの回答（2025年8月15日付）に基づき、異議申し立て機能を以下の通り更新しました。

### 主な更新内容
- ✅ 評価期間マスタデータ取得APIの実装
- ✅ 優先度判定ロジックの医療チーム基準への準拠
- ✅ 審査者自動割り当て機能の実装
- ✅ エラーハンドリングの強化

---

## 2. 実装詳細

### 2.1 評価期間マスタデータ取得API

#### 実装内容
```typescript
// src/services/appealService.ts
async getEvaluationPeriods(): Promise<EvaluationPeriod[]> {
  const response = await axios.get(`${MEDICAL_SYSTEM_URL}/api/v1/evaluation/periods`);
  
  // appealDeadlineが未来日付のもののみフィルター
  const now = new Date();
  return response.data.periods.filter(p => 
    new Date(p.appealDeadline) > now && p.status === 'active'
  );
}
```

#### 期限チェック機能
- 評価期間IDから自動的に申し立て期限を確認
- 期限切れの場合は適切なエラーメッセージ（E002）を表示
- フォールバック機能でテスト用データを提供

### 2.2 優先度判定ロジック（医療チーム基準準拠）

#### 高優先度（High）判定基準
```typescript
// 以下の条件に該当する場合
- appealCategory === 'calculation_error' // 計算誤り
- appealCategory === 'period_error' // 期間誤り  
- スコア差 >= 10点
- 管理職からの申し立て（jobCategory: manager/director/chief）
```

#### 中優先度（Medium）判定基準
```typescript
- appealCategory === 'achievement_oversight' // 成果見落とし
- スコア差 5〜9点
- 証拠書類が3個以上
```

#### 低優先度（Low）判定基準
```typescript
- スコア差 < 5点
- appealCategory === 'other'
- 上記以外のケース
```

### 2.3 審査者自動割り当て機能

#### 実装内容
```typescript
const assignReviewer = async (appeal: AppealRecord, priority: string) => {
  if (priority === 'high') {
    return 'DEPT_HEAD_001'; // 部門長に割り当て
  } else if (priority === 'medium') {
    return 'SECTION_CHIEF_001'; // 課長に割り当て
  } else {
    return 'TEAM_LEADER_001'; // リーダーに割り当て
  }
  
  // 割り当て失敗時はデフォルト審査者
  // 管理者に手動割り当てを通知
}
```

#### 特徴
- 優先度に応じた自動割り当て
- 高優先度案件は緊急通知を送信
- フォールバック機能（DEFAULT_REVIEWER）
- 手動割り当て失敗時の管理者通知

### 2.4 エラーハンドリングの強化

#### エラーコード定義
```typescript
// src/utils/errorMessages.ts
export const errorMessages = {
  appeal: {
    e002: '有効な評価期間が見つかりません',
    periodExpired: '申し立て期限を過ぎています（評価開示から14日以内）',
    noReviewer: '審査者の割り当てに失敗しました',
    defaultReviewerAssigned: 'デフォルト審査者が割り当てられました'
  }
}
```

#### エラー処理フロー
1. 評価期間が見つからない → E002エラー
2. 審査者割り当て失敗 → DEFAULT_REVIEWER + 管理者通知
3. 期限切れ → 明確な期限表示付きエラー

---

## 3. 統合テスト準備

### 3.1 テスト用データ設定

```javascript
// テスト用評価期間
{
  id: 'TEST-2025',
  name: 'テスト評価期間',
  appealDeadline: '2025-12-31',
  status: 'active'
}

// テスト用審査者
{
  reviewerId: 'TEST-R001',
  reviewerName: 'テスト審査者',
  reviewerRole: 'test_reviewer'
}
```

### 3.2 テストシナリオ

#### シナリオ1: 高優先度案件のフロー
1. 計算誤りカテゴリで申し立て送信
2. 自動的に部門長に割り当て
3. 緊急通知の送信確認

#### シナリオ2: 期限チェック
1. 期限切れ評価期間での申し立て試行
2. E002エラーの表示確認

#### シナリオ3: フォールバック機能
1. 医療システムAPI接続失敗時
2. テスト用データでの動作継続確認

---

## 4. API接続設定

### 環境変数設定
```env
# .env
VITE_API_URL=http://localhost:3001
VITE_MEDICAL_API_URL=http://localhost:3000  # 医療システムAPI
```

### CORS設定確認済み
```javascript
// 許可されているオリジン
allowedOrigins: [
  'http://localhost:5173',  // VoiceDrive
  'http://localhost:3000'   // 医療システム
]
```

---

## 5. 実装ファイル変更一覧

### 更新ファイル
- `src/services/appealService.ts` - 評価期間API連携追加
- `server/src/services/appealService.ts` - 優先度判定・審査者割り当て更新
- `server/src/controllers/appealController.ts` - エラーハンドリング強化
- `src/utils/errorMessages.ts` - 異議申し立て用エラーメッセージ追加

---

## 6. 確認事項

### 医療チームへの確認依頼
1. **APIエンドポイントURL**
   - 本番環境の`/api/v1/evaluation/periods`エンドポイントURL
   - 認証トークンの取得方法

2. **審査者割り当てAPI**
   - PUT `/api/v1/appeals/{appealId}/assign`の動作確認
   - 自動割り当て失敗時の通知先

3. **優先度判定**
   - 管理職判定用のjobCategoryの値確認
   - 追加の優先度判定条件の有無

---

## 7. 統合テスト日程

### 予定日時: 2025年8月20日（月）

### テスト項目
- [ ] 評価期間マスタデータ取得
- [ ] 優先度自動判定
- [ ] 審査者自動割り当て
- [ ] エラーケース処理
- [ ] 通知機能
- [ ] データ同期

---

## 8. 今後の対応

### 即座に対応可能
- 本番環境URLへの切り替え
- 認証トークン実装
- 追加の優先度条件実装

### 要調整事項
- メール/SMS通知の実装
- ダッシュボード統合
- レポート機能

---

**更新完了**: 医療チームの回答に基づく全機能を実装済み  
**次のステップ**: 8月20日の統合テストで動作確認

---

VoiceDriveチーム