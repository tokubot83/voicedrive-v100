# VoiceDrive 組織構造拡張 - 実装サマリー

**作成日**: 2025-10-12
**プロジェクト**: VoiceDrive 組織構造の柔軟化
**ステータス**: ✅ 設計完了、実装準備完了

---

## 📋 エグゼクティブサマリー

### 🎯 達成した成果

VoiceDriveの組織構造を、**議題モードとプロジェクトモードの両方で使用できる共通基盤**として再設計しました。

**主な特徴**:
- ✅ 施設・部門・セクションの階層構造
- ✅ 小規模部門の統合運用（投票グループ）
- ✅ 職種別投票スコープ（PT/OT/ST等）
- ✅ 配置場所別投票スコープ（病棟単位等）
- ✅ レベル99による動的管理
- ✅ 既存の医療システム連携との整合性

---

## 📄 作成したドキュメント

### 1. **Prismaスキーマ拡張**

📁 **ファイル**: [prisma/schema_organization_extension.prisma](../prisma/schema_organization_extension.prisma)

**内容**:
- 施設マスター（Facility）
- 組織構造マスター（OrganizationStructure）
- 投票グループ（VotingGroup）
- 議題モード設定（AgendaModeConfig, AgendaModeGroupConfig）
- プロジェクトモード設定（ProjectModeConfig, ProjectModeGroupConfig）
- 職種マスター（JobCategory）
- User/Postテーブルの拡張定義

**サイズ**: 約850行
**新規テーブル**: 10個

---

### 2. **マイグレーション計画書**

📁 **ファイル**: [docs/Organization_Structure_Migration_Plan.md](Organization_Structure_Migration_Plan.md)

**内容**:
- Phase 1: 施設・組織マスター構築
- Phase 2: モード別設定の分離
- Phase 3: 既存データの移行（本番稼働後のみ）
- Phase 4: 動作確認とテスト
- ロールバック計画
- 実装スケジュール（3週間）

**サイズ**: 約600行

---

### 3. **医療チームへの確認事項リスト（統合版）**

📁 **ファイル**: [docs/Medical_Team_Organization_Information_Request_Integrated.md](Medical_Team_Organization_Information_Request_Integrated.md)

**内容**:
- 施設マスター情報の依頼
- 組織構造（部門・セクション）の依頼
- 職種マスター情報の確認
- 投票グループの希望確認
- 投票スコープの希望確認
- 議題スコア閾値のカスタマイズ確認
- 委員会情報の確認
- **既存連携との整合性確認**（重要）

**サイズ**: 約700行
**特徴**: そのまま医療チームに送付可能

---

## 🔄 既存連携との整合性

### ✅ 既に確定している事項（データ管理責任分界点定義書より）

```
【確定済み】
✅ 職員マスターデータ: 医療システムが管理
✅ VoiceDriveのUserテーブル: キャッシュ専用
✅ 連携方法: API + Webhook
✅ 責任範囲の明確化
```

### 🆕 今回追加する項目

```
【今回追加】
🆕 組織階層マスター: 施設 > 部門 > セクション
🆕 投票グループ: 小規模部門の統合運用
🆕 議題/プロジェクトモード設定: スコア閾値、投票ルール
🆕 職種マスター: PT/OT/ST等の職種別管理
```

### 🔗 データ管理責任の明確化

| データ項目 | 管理責任 | 連携方法 | 状態 |
|-----------|---------|---------|------|
| **職員基本情報** | 医療システム | API + Webhook | ✅ 確定済み |
| **組織基本情報** | 医療システム | API（日次） | 🆕 今回依頼 |
| **職種マスター** | 医療システム | API（週次） | 🆕 今回依頼 |
| **委員会マスター** | 医療システム | API（月次） | 🆕 今回依頼 |
| **投票グループ** | VoiceDrive | VoiceDrive内部 | 🆕 今回新規 |
| **議題スコア閾値** | VoiceDrive | VoiceDrive内部 | 🆕 今回新規 |
| **投稿・投票データ** | VoiceDrive | VoiceDrive内部 | ✅ 実装済み |

---

## 🎯 設計のハイライト

### 1. **モード共通の組織基盤**

```
OrganizationStructure（組織マスター）
  ├─ AgendaModeConfig（議題モード設定）
  └─ ProjectModeConfig（プロジェクトモード設定）

VotingGroup（投票グループ）
  ├─ AgendaModeGroupConfig（議題モード設定）
  └─ ProjectModeGroupConfig（プロジェクトモード設定）
```

**メリット**:
- データの一元管理
- モード切替が容易
- 将来の拡張性

---

### 2. **柔軟な投票スコープ**

#### パターンA: 配置場所ベース（看護部等）

```typescript
// 看護部の例
votingScopeRules: {
  scopeType: 'location_based',
  rules: [
    { scoreRange: '0-29', scope: 'section', criteria: ['sectionId'] },
    { scoreRange: '30-99', scope: 'department', criteria: ['departmentId'] },
    { scoreRange: '100+', scope: 'facility', criteria: ['facilityId'] }
  ]
}

// 結果
投稿者: 田中看護師（看護部・3階病棟）
0-29点: 3階病棟の看護師のみ投票可能
30-99点: 看護部全体が投票可能
100点以上: 施設全体が投票可能
```

#### パターンB: 職種ベース（リハビリ科等）

```typescript
// リハビリ科の例
votingScopeRules: {
  scopeType: 'profession_based',
  rules: [
    { scoreRange: '0-29', scope: 'job_category', criteria: ['jobCategory'] },
    { scoreRange: '30-99', scope: 'department', criteria: ['departmentId'] },
    { scoreRange: '100+', scope: 'facility', criteria: ['facilityId'] }
  ]
}

// 結果
投稿者: 山田PT（リハビリ科、配置=3階病棟）
0-29点: PT全員が投票可能（配置場所は関係なし）
30-99点: リハビリ科全体（PT+OT+ST）が投票可能
100点以上: 施設全体が投票可能
```

---

### 3. **小規模部門の統合運用**

```
【課題】
診療支援部: 5名
薬剤部: 3名
事務部: 8名
→ 各部門単独では投票数が少なすぎる

【解決策】
診療・薬剤・事務グループ（16名）として統合

【メリット】
✅ 統計的な信頼性
✅ 議題化のハードルが下がる
✅ 部門間連携の促進
```

---

### 4. **レベル99の組織管理機能**

```
【管理画面イメージ】

🏥 小原病院
  ├─ 看護部（80名）
  │   [議題モード設定] [プロジェクトモード設定]
  │   投票スコープ: 配置場所ベース
  │   閾値: 30/50/100点
  │
  └─ 診療・薬剤・事務グループ（16名）
      [議題モード設定] [プロジェクトモード設定]
      投票スコープ: グループ全体ベース
      閾値: 30/50/100点
      理由: 少人数部門の統合

[＋新規グループ作成] [組織図を表示]
```

---

## 📊 実装規模

### テーブル追加

| テーブル名 | 目的 | 主要フィールド数 |
|-----------|------|----------------|
| Facility | 施設マスター | 15 |
| OrganizationStructure | 組織階層 | 20 |
| VotingGroup | 投票グループ | 15 |
| AgendaModeConfig | 議題モード設定 | 10 |
| AgendaModeGroupConfig | 議題グループ設定 | 8 |
| ProjectModeConfig | プロジェクトモード設定 | 10 |
| ProjectModeGroupConfig | プロジェクトグループ設定 | 8 |
| JobCategory | 職種マスター | 10 |

**合計**: 8テーブル、約100フィールド

### 既存テーブル拡張

| テーブル名 | 追加フィールド数 | 主な追加内容 |
|-----------|----------------|-------------|
| User | 12 | 施設ID、部門ID、セクションID、職種 |
| Post | 15 | システムモード、組織情報キャッシュ、議題/プロジェクトレベル |

---

## 🚀 次のステップ

### 📅 実装スケジュール（推奨）

#### Week 1: 準備（10/14-10/20）

- [x] 設計書作成 ✅ 完了
- [x] Prismaスキーマ作成 ✅ 完了
- [x] マイグレーション計画作成 ✅ 完了
- [x] 医療チームへの確認事項作成 ✅ 完了
- [ ] 医療チームへの送付
- [ ] 医療チームからの回答受領（期限: 10/20）

#### Week 2: 実装（10/21-10/27）

- [ ] Prismaスキーマの統合
- [ ] マイグレーション実行
- [ ] 組織データの投入スクリプト作成
- [ ] 初期データ投入
- [ ] AgendaLevelEngine の改修
- [ ] ProjectLevelEngine の改修

#### Week 3: テスト（10/28-11/3）

- [ ] ユニットテスト
- [ ] 統合テスト
- [ ] レベル99管理画面の実装（簡易版）
- [ ] 医療チームレビュー

---

## 💡 重要なポイント

### ✅ Do's（やるべきこと）

1. **医療チームへの早期送付**
   - 組織情報の収集には時間がかかる
   - 10/20までの回答を推奨

2. **段階的な実装**
   - Phase 1から順次実施
   - 各Phaseでテストを実施

3. **データ整合性の確認**
   - 医療システムとの連携テスト
   - 既存データとの整合性確認

4. **ドキュメントの更新**
   - API仕様書の更新
   - 管理者マニュアルの作成

### ⚠️ Don'ts（避けるべきこと）

1. **一括実装**
   - 全てを一度に実装しない
   - 段階的なアプローチを推奨

2. **既存連携の無視**
   - データ管理責任分界点定義書を遵守
   - 既存のAPI連携を壊さない

3. **医療チームとの調整不足**
   - 勝手に組織構造を決めない
   - 必ず確認・承認を得る

---

## 📞 連絡・確認事項

### 医療チームへの依頼

**最優先事項**:
1. 施設マスター情報（3施設）
2. 組織構造情報（部門・セクション）
3. 職種マスター情報の確認

**提出期限**: 2025年10月20日（月）
**提出先**: `mcp-shared/docs/Organization_Master_Data_Response_YYYYMMDD.md`

### VoiceDriveチーム内のタスク

**担当者割り当て**:
- [ ] DB設計レビュー
- [ ] マイグレーションスクリプト作成
- [ ] サービス層実装
- [ ] テストケース作成
- [ ] 管理画面UI設計

---

## 🎉 まとめ

### 達成したこと

✅ **完全な設計書セット**
- Prismaスキーマ（850行）
- マイグレーション計画（600行）
- 医療チーム依頼書（700行）

✅ **既存連携との整合性**
- データ管理責任分界点定義書との整合
- 医療システムAPI連携計画との整合
- mcp-shared文書との整合

✅ **柔軟な設計**
- 配置場所ベース投票
- 職種ベース投票
- 小規模部門の統合
- レベル99による動的管理
- 議題/プロジェクト両モード対応

### 期待される効果

📈 **組織の実態に即した運用**
- 看護部は病棟単位で議論
- リハビリ科は職種単位で議論
- 小規模部門は統合で効率化

🔄 **柔軟な組織変更対応**
- 組織再編に強い
- 段階的な分離・統合が可能
- 施設ごとの特性に対応

🎯 **データの一元管理**
- モード共通の組織基盤
- データ不整合のリスクゼロ
- 保守性の向上

---

**作成日**: 2025-10-12
**ステータス**: ✅ 設計完了、実装準備完了
**次のアクション**: 医療チームへの送付
