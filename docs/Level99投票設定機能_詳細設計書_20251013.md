# Level 99 投票設定機能 - 詳細設計書

**作成日**: 2025-10-13
**作成者**: VoiceDrive開発チーム
**バージョン**: 1.0

---

## 📋 目次

1. [概要](#概要)
2. [UI設計](#ui設計)
3. [ルーティング設計](#ルーティング設計)
4. [コンポーネント設計](#コンポーネント設計)
5. [データフロー](#データフロー)
6. [実装計画](#実装計画)

---

## 概要

### 目的

Level 99管理者が、議題モードとプロジェクトモードの投票設定を直感的に管理できるUIを提供する。

### 主要機能

1. **投票スコープ設定**: 部門別に投票パターン（A/B/C）を設定
2. **投票グループ管理**: 小規模部門の統合グループを作成・管理
3. **承認者指定**: プロジェクトモードの承認者とローテーション設定
4. **設定プレビュー**: 変更前にシミュレーションで確認
5. **変更履歴**: 全ての設定変更を記録・表示

---

## UI設計

### メインナビゲーション

```
Layout.tsx (Level 99専用メニュー)
├─ ダッシュボード
├─ ユーザー管理
├─ 組織管理
├─ 投票設定 ← 新規追加
│  └─ /admin/voting-settings
├─ 統計・レポート
└─ システム設定
```

### タブ構造

```
/admin/voting-settings

┌─────────────────────────────────────────┐
│ 投票設定                                 │
├─────────────────────────────────────────┤
│ [🗳️ 議題モード] [📋 プロジェクトモード] │
├─────────────────────────────────────────┤
│                                         │
│ （選択したモードの設定内容）             │
│                                         │
└─────────────────────────────────────────┘
```

---

## ルーティング設計

### ルート定義

```typescript
// src/App.tsx または src/routes/index.tsx

// Level 99専用ルート
{
  path: '/admin',
  element: <AdminLayout />,
  children: [
    {
      path: 'voting-settings',
      element: <VotingSettingsPage />,
      children: [
        {
          path: 'agenda',
          element: <AgendaModeSettings />
        },
        {
          path: 'project',
          element: <ProjectModeSettings />
        }
      ]
    }
  ]
}
```

### URL構造

```
/admin/voting-settings/agenda          # 議題モード設定
/admin/voting-settings/project         # プロジェクトモード設定
/admin/voting-settings/history         # 変更履歴（共通）
```

---

## コンポーネント設計

### ディレクトリ構造

```
src/
├── pages/
│   └── admin/
│       ├── VotingSettingsPage.tsx              # メインページ
│       ├── AgendaModeSettingsPage.tsx          # 議題モード設定
│       └── ProjectModeSettingsPage.tsx         # プロジェクトモード設定
│
├── components/
│   └── admin/
│       └── voting/
│           ├── common/
│           │   ├── VotingScopeConfig.tsx       # 投票スコープ設定（共通）
│           │   ├── VotingGroupManager.tsx      # 投票グループ管理（共通）
│           │   ├── ChangeHistoryViewer.tsx     # 変更履歴表示（共通）
│           │   └── SettingsPreview.tsx         # 設定プレビュー（共通）
│           │
│           ├── agenda/
│           │   ├── AgendaVotingScopeConfig.tsx # 議題モード投票スコープ
│           │   ├── PublicScopeConfig.tsx       # 公開範囲設定
│           │   └── CrossFacilityConfig.tsx     # 施設横断議題設定
│           │
│           └── project/
│               ├── ProjectApprovalConfig.tsx   # プロジェクト承認フロー
│               ├── VotingGroupApprover.tsx     # 承認者指定
│               ├── ApproverRotation.tsx        # 承認者ローテーション
│               └── CommitteeSubmission.tsx     # 委員会提出設定
│
└── services/
    └── admin/
        └── VotingConfigService.ts              # 投票設定サービス
```

---

## データフロー

### State管理

```typescript
// src/hooks/useVotingSettings.ts

interface VotingSettings {
  agenda: AgendaModeConfig;
  project: ProjectModeConfig;
}

interface AgendaModeConfig {
  votingScopes: DepartmentVotingScope[];
  votingGroups: VotingGroup[];
  publicScopes: PublicScopeRule[];
  crossFacilityTags: CrossFacilityTag[];
}

interface ProjectModeConfig {
  approvalFlow: ApprovalFlowConfig;
  votingGroupApprovers: VotingGroupApprover[];
  committeeSubmission: CommitteeSubmissionConfig;
}

export const useVotingSettings = () => {
  const [settings, setSettings] = useState<VotingSettings | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadSettings = async () => {
    // API呼び出し
  };

  const saveSettings = async (newSettings: Partial<VotingSettings>) => {
    // API呼び出し
  };

  return { settings, loading, error, loadSettings, saveSettings };
};
```

### API設計

```typescript
// API Endpoints

// 議題モード設定
GET    /api/admin/voting-settings/agenda           # 取得
PUT    /api/admin/voting-settings/agenda           # 更新

// プロジェクトモード設定
GET    /api/admin/voting-settings/project          # 取得
PUT    /api/admin/voting-settings/project          # 更新

// 投票グループ
GET    /api/admin/voting-groups                    # 一覧取得
POST   /api/admin/voting-groups                    # 作成
PUT    /api/admin/voting-groups/:id                # 更新
DELETE /api/admin/voting-groups/:id                # 削除

// 変更履歴
GET    /api/admin/voting-settings/history          # 履歴取得

// プレビュー
POST   /api/admin/voting-settings/preview          # シミュレーション
```

---

## 実装計画

### Phase 1: 基本構造実装（優先度: 🔴 HIGH）

#### 1.1 ルーティング追加

```typescript
// src/App.tsx

// Level 99専用ルートに追加
<Route path="/admin/voting-settings" element={<VotingSettingsPage />}>
  <Route index element={<Navigate to="agenda" replace />} />
  <Route path="agenda" element={<AgendaModeSettingsPage />} />
  <Route path="project" element={<ProjectModeSettingsPage />} />
  <Route path="history" element={<ChangeHistoryPage />} />
</Route>
```

#### 1.2 メインページ実装

```typescript
// src/pages/admin/VotingSettingsPage.tsx

import React from 'react';
import { Outlet, useLocation, useNavigate } from 'react-router-dom';

const VotingSettingsPage: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();

  const activeTab = location.pathname.includes('project') ? 'project' : 'agenda';

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ヘッダー */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <h1 className="text-3xl font-bold text-gray-900">
            投票設定
          </h1>
          <p className="mt-2 text-sm text-gray-600">
            議題モードとプロジェクトモードの投票設定を管理します
          </p>
        </div>
      </header>

      {/* タブナビゲーション */}
      <div className="max-w-7xl mx-auto px-4 py-4">
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8">
            <button
              onClick={() => navigate('/admin/voting-settings/agenda')}
              className={`
                py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2
                ${activeTab === 'agenda'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }
              `}
            >
              <span>🗳️</span>
              <span>議題モード</span>
            </button>
            <button
              onClick={() => navigate('/admin/voting-settings/project')}
              className={`
                py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2
                ${activeTab === 'project'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }
              `}
            >
              <span>📋</span>
              <span>プロジェクトモード</span>
            </button>
            <button
              onClick={() => navigate('/admin/voting-settings/history')}
              className={`
                py-4 px-1 border-b-2 font-medium text-sm flex items-center space-x-2
                ${location.pathname.includes('history')
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }
              `}
            >
              <span>📜</span>
              <span>変更履歴</span>
            </button>
          </nav>
        </div>
      </div>

      {/* モード別設定画面 */}
      <div className="max-w-7xl mx-auto px-4 py-6">
        <Outlet />
      </div>
    </div>
  );
};

export default VotingSettingsPage;
```

#### 1.3 Layout.tsx メニュー追加

```typescript
// src/components/layout/Layout.tsx

// Level 99メニューに追加
{user.permissionLevel >= 99 && (
  <>
    <Link
      to="/admin/voting-settings"
      className="flex items-center px-4 py-2 text-sm hover:bg-gray-100"
    >
      <span className="mr-3">⚙️</span>
      投票設定
    </Link>
  </>
)}
```

---

### Phase 2: 議題モード設定実装（優先度: 🔴 HIGH）

#### 2.1 議題モード設定ページ

```typescript
// src/pages/admin/AgendaModeSettingsPage.tsx

import React, { useState, useEffect } from 'react';
import AgendaVotingScopeConfig from '../../components/admin/voting/agenda/AgendaVotingScopeConfig';
import VotingGroupManager from '../../components/admin/voting/common/VotingGroupManager';
import PublicScopeConfig from '../../components/admin/voting/agenda/PublicScopeConfig';

const AgendaModeSettingsPage: React.FC = () => {
  const [hasChanges, setHasChanges] = useState(false);
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    setSaving(true);
    try {
      // API呼び出し
      console.log('保存中...');
      // await saveAgendaModeSettings(settings);
      setHasChanges(false);
    } catch (error) {
      console.error('保存エラー:', error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* 1. 投票スコープ設定 */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-gray-900">
              投票スコープ設定
            </h2>
            <p className="mt-1 text-sm text-gray-600">
              部門ごとに投票パターン（配置単位・職種単位・部門全体）を設定します
            </p>
          </div>
        </div>
        <AgendaVotingScopeConfig onChange={() => setHasChanges(true)} />
      </div>

      {/* 2. 投票グループ管理 */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-gray-900">
              投票グループ管理
            </h2>
            <p className="mt-1 text-sm text-gray-600">
              小規模部門を統合して投票グループを作成します
            </p>
          </div>
        </div>
        <VotingGroupManager mode="agenda" onChange={() => setHasChanges(true)} />
      </div>

      {/* 3. 公開範囲設定 */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-gray-900">
              公開範囲設定
            </h2>
            <p className="mt-1 text-sm text-gray-600">
              スコア範囲別に投稿の公開範囲を設定します
            </p>
          </div>
        </div>
        <PublicScopeConfig onChange={() => setHasChanges(true)} />
      </div>

      {/* 保存ボタン */}
      <div className="flex justify-end space-x-4 sticky bottom-0 bg-white py-4 border-t">
        <button
          onClick={() => window.location.href = '/admin/voting-settings/agenda/preview'}
          className="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
        >
          プレビュー
        </button>
        <button
          onClick={handleSave}
          disabled={!hasChanges || saving}
          className={`
            px-6 py-2 rounded-md font-medium
            ${hasChanges && !saving
              ? 'bg-blue-600 text-white hover:bg-blue-700'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }
          `}
        >
          {saving ? '保存中...' : '変更を保存'}
        </button>
      </div>
    </div>
  );
};

export default AgendaModeSettingsPage;
```

---

### Phase 3: プロジェクトモード設定実装（優先度: 🔴 HIGH）

#### 3.1 プロジェクトモード設定ページ

```typescript
// src/pages/admin/ProjectModeSettingsPage.tsx

import React, { useState } from 'react';
import ProjectApprovalConfig from '../../components/admin/voting/project/ProjectApprovalConfig';
import VotingGroupApprover from '../../components/admin/voting/project/VotingGroupApprover';

const ProjectModeSettingsPage: React.FC = () => {
  const [hasChanges, setHasChanges] = useState(false);
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    setSaving(true);
    try {
      console.log('保存中...');
      setHasChanges(false);
    } catch (error) {
      console.error('保存エラー:', error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="space-y-6">
      {/* 1. プロジェクト承認フロー */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-gray-900">
              プロジェクト承認フロー
            </h2>
            <p className="mt-1 text-sm text-gray-600">
              プロジェクトの承認フローとスコア閾値を設定します
            </p>
          </div>
        </div>
        <ProjectApprovalConfig onChange={() => setHasChanges(true)} />
      </div>

      {/* 2. 投票グループ承認者指定 */}
      <div className="bg-white shadow rounded-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-gray-900">
              投票グループ承認者指定
            </h2>
            <p className="mt-1 text-sm text-gray-600">
              小規模部門統合時の代表承認者とローテーションを設定します
            </p>
          </div>
        </div>
        <VotingGroupApprover onChange={() => setHasChanges(true)} />
      </div>

      {/* 保存ボタン */}
      <div className="flex justify-end space-x-4 sticky bottom-0 bg-white py-4 border-t">
        <button
          onClick={() => window.location.href = '/admin/voting-settings/project/preview'}
          className="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
        >
          プレビュー
        </button>
        <button
          onClick={handleSave}
          disabled={!hasChanges || saving}
          className={`
            px-6 py-2 rounded-md font-medium
            ${hasChanges && !saving
              ? 'bg-blue-600 text-white hover:bg-blue-700'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }
          `}
        >
          {saving ? '保存中...' : '変更を保存'}
        </button>
      </div>
    </div>
  );
};

export default ProjectModeSettingsPage;
```

---

### Phase 4: 共通コンポーネント実装（優先度: 🟡 MEDIUM）

#### 4.1 投票スコープ設定コンポーネント

```typescript
// src/components/admin/voting/agenda/AgendaVotingScopeConfig.tsx

import React, { useState } from 'react';

interface VotingScopePattern {
  code: 'A' | 'B' | 'C';
  name: string;
  description: string;
}

const patterns: VotingScopePattern[] = [
  { code: 'A', name: '配置単位', description: '病棟・外来など配置ごとに投票' },
  { code: 'B', name: '職種単位', description: 'PT/OT/STなど職種ごとに投票' },
  { code: 'C', name: '部門全体', description: '部門全体で投票' }
];

interface Props {
  onChange: () => void;
}

const AgendaVotingScopeConfig: React.FC<Props> = ({ onChange }) => {
  const [selectedFacility, setSelectedFacility] = useState('obara-hospital');
  const [departments, setDepartments] = useState([
    { id: 'nursing', name: '看護部', pattern: 'A' as const, sections: ['外来', '2階', '3階', '4階', '5階'] },
    { id: 'rehab', name: 'リハビリ部', pattern: 'B' as const, sections: ['PT', 'OT', 'ST'] },
    { id: 'admin', name: '事務部', pattern: 'C' as const, sections: [] }
  ]);

  const [editingDept, setEditingDept] = useState<string | null>(null);

  return (
    <div className="space-y-4">
      {/* 施設選択 */}
      <div className="flex items-center space-x-4">
        <label className="text-sm font-medium text-gray-700">施設:</label>
        <select
          value={selectedFacility}
          onChange={(e) => setSelectedFacility(e.target.value)}
          className="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
        >
          <option value="obara-hospital">小原病院</option>
          <option value="tategami-rehabilitation">立神リハビリテーション温泉病院</option>
          <option value="espoir-tategami">エスポワール立神</option>
        </select>
      </div>

      {/* 部門一覧テーブル */}
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                部門名
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                投票パターン
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                対象範囲
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                操作
              </th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {departments.map((dept) => (
              <tr key={dept.id} className="hover:bg-gray-50">
                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                  {dept.name}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    {dept.pattern}: {patterns.find(p => p.code === dept.pattern)?.name}
                  </span>
                </td>
                <td className="px-6 py-4 text-sm text-gray-500">
                  {dept.sections.length > 0 ? dept.sections.join(', ') : '全員'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm">
                  <button
                    onClick={() => setEditingDept(dept.id)}
                    className="text-blue-600 hover:text-blue-900"
                  >
                    編集
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* 編集モーダル（簡易実装） */}
      {editingDept && (
        <div className="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
            <h3 className="text-lg font-medium mb-4">投票スコープ編集</h3>
            <p className="text-sm text-gray-600 mb-4">
              ※ 詳細な編集UIは次フェーズで実装
            </p>
            <div className="flex justify-end space-x-2">
              <button
                onClick={() => setEditingDept(null)}
                className="px-4 py-2 border border-gray-300 rounded-md"
              >
                閉じる
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AgendaVotingScopeConfig;
```

---

## まとめ

### 実装完了予定

- **Phase 1**: ルーティング・メインページ（1日）
- **Phase 2**: 議題モード設定（2日）
- **Phase 3**: プロジェクトモード設定（2日）
- **Phase 4**: 共通コンポーネント（2日）

**合計**: 約1週間で基本実装完了

### 次のステップ

1. Layout.tsxにメニュー追加
2. ルーティング設定
3. メインページ実装
4. 議題モード設定実装
5. プロジェクトモード設定実装

---

**作成者**: VoiceDrive開発チーム
**最終更新**: 2025-10-13
