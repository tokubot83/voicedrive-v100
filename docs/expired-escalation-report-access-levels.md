# 期限到達レポート機能 - アカウントレベル別アクセス権限設計

**作成日**: 2025年10月19日
**対象**: Phase 6 - 期限到達・未達成昇格のレポート機能（将来実装）

---

## 📊 正しいpermissionLevel定義

VoiceDriveシステムの実際のpermissionLevel構造：

```typescript
// 一般職員・現場レベル
LEVEL_1 = 1       // 新人（1年目）
LEVEL_2 = 2       // 若手（2-3年目）
LEVEL_3 = 3       // 中堅（4-10年目）
LEVEL_4 = 4       // ベテラン（11年以上）

// 現場管理職レベル
LEVEL_5 = 5       // 副主任
LEVEL_6 = 6       // 主任
LEVEL_7 = 7       // 副師長・副科長・副課長
LEVEL_8 = 8       // 師長・科長・課長・室長
LEVEL_9 = 9       // 副部長
LEVEL_10 = 10     // 部長・医局長
LEVEL_11 = 11     // 事務長

// 施設経営層
LEVEL_12 = 12     // 副院長
LEVEL_13 = 13     // 院長・施設長

// 法人人事・組織開発
LEVEL_14 = 14     // 人事部門員
LEVEL_15 = 15     // 人事各部門長
LEVEL_16 = 16     // 戦略企画・統括管理部門員
LEVEL_17 = 17     // 戦略企画・統括管理部門長

// 法人経営層
LEVEL_18 = 18     // 理事長・法人事務局長

// 特殊権限
LEVEL_97 = 97     // 健診担当者（ストレスチェック実施者）
LEVEL_98 = 98     // 産業医
LEVEL_99 = 99     // システム管理者
```

---

## 🎯 レポート機能のアクセス権限マトリクス

### 期限到達履歴レポート

| 機能 | LEVEL_1-4<br>一般職員 | LEVEL_5-6<br>主任級 | LEVEL_7-8<br>師長級 | LEVEL_9-11<br>部長級 | LEVEL_12-13<br>施設経営層 | LEVEL_14-15<br>人事部門 | LEVEL_16-17<br>組織開発 | LEVEL_18<br>理事長 | LEVEL_99<br>システム管理 |
|------|---------|------|---------|---------|---------|--------|--------|--------|--------|
| **自分の提案履歴** | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **自分の判断履歴** | - | ✅ | ✅ | ✅ | ✅ | - | - | ✅ | ✅ |
| **チーム統計** | - | ✅ | ✅ | ✅ | ✅ | - | - | ✅ | ✅ |
| **部署統計** | - | - | ✅ | ✅ | ✅ | - | - | ✅ | ✅ |
| **施設全体統計** | - | - | - | ✅ | ✅ | - | ✅ | ✅ | ✅ |
| **法人全体統計** | - | - | - | - | - | ✅ | ✅ | ✅ | ✅ |
| **全管理職比較** | - | - | - | - | - | ✅ | ✅ | ✅ | ✅ |
| **詳細分析** | - | - | - | - | - | ✅ | ✅ | ✅ | ✅ |
| **CSVエクスポート** | - | - | - | - | - | ✅ | ✅ | ✅ | ✅ |
| **生データアクセス** | - | - | - | - | - | - | ✅ | - | ✅ |

---

## 👥 レベル別の主要ユーザーと用途

### 🏥 現場管理職（LEVEL_5-13）

#### LEVEL_5-6: 主任級
**アクセス範囲**: 自分の判断履歴 + チーム統計

**用途：**
- 自分の判断を振り返る
- チーム内の提案状況を把握
- 部下への説明材料

**使用例：**
```
主任が月次で確認
↓
「今月、私は5件判断した」
「承認率80%、平均到達率88%」
「チーム全体では10件の提案があった」
```

---

#### LEVEL_7-8: 師長・課長級
**アクセス範囲**: 自分の判断履歴 + チーム統計 + 部署統計

**用途：**
- 部署全体の判断傾向を把握
- 主任たちの判断状況をチェック
- 部署ミーティングで報告

**使用例：**
```
師長が部署ミーティングで報告
↓
「当部署、今月は15件の期限到達提案」
「承認率70%、平均判断日数2.5日」
「A主任が特に迅速（平均1.2日）」
```

---

#### LEVEL_9-13: 部長・院長級
**アクセス範囲**: 施設全体統計

**用途：**
- 施設全体の判断状況を把握
- 経営会議で報告
- 部署間の比較

**使用例：**
```
院長が経営会議で報告
↓
「当院全体で今月30件の期限到達提案」
「看護部: 承認率75%」
「事務部: 承認率65%」
「全体平均判断日数: 2.1日」
```

---

### 🏢 法人人事・組織開発（LEVEL_14-17）

#### LEVEL_14-15: 人事部門
**アクセス範囲**: 法人全体統計 + 全管理職比較 + 詳細分析 + CSVエクスポート

**用途：**
- 法人全体の判断状況を把握
- 管理職の評価データ収集
- 月次・年次レポート作成
- 施設間の比較

**使用例：**
```
人事部が月次レポート作成
↓
1. 法人全体の統計をダウンロード
2. Excelで加工
3. 施設別・部署別に分析
4. 経営会議資料を作成
5. 管理職評価シートに反映
```

---

#### LEVEL_16-17: 組織開発・戦略企画
**アクセス範囲**: 法人全体統計 + 全管理職比較 + 詳細分析 + CSVエクスポート + **生データアクセス**

**用途：**
- 組織改善のためのデータ分析
- ベストプラクティス発見
- システム改善提案
- 詳細な傾向分析

**使用例：**
```
組織開発担当が分析
↓
1. 生データをエクスポート
2. BIツールで詳細分析
3. 判断傾向パターンを発見
   「到達率85%がボーダーライン」
4. システム改善提案
   「75%未満は昇格警告を出そう」
5. ベストプラクティスを共有
```

---

### 👑 経営層（LEVEL_18）

#### LEVEL_18: 理事長・法人事務局長
**アクセス範囲**: 法人全体統計 + 全管理職比較 + 詳細分析 + CSVエクスポート

**用途：**
- 法人全体の意思決定状況を把握
- 理事会での報告
- 経営判断の材料

**使用例：**
```
理事長が四半期ごとに確認
↓
「法人全体で今期180件の期限到達提案」
「承認率68% - 適切な判断が行われている」
「職員の声が活かされている証拠」
「継続して運用する」
```

---

## 🔐 権限チェック実装例

### 職員カルテシステム側（MCPサーバー経由）

```typescript
async function getExpiredEscalationReport(request: {
  requesterId: string;
  permissionLevel: number;
  department?: string;
  facilityId?: string;
}) {
  const { permissionLevel, requesterId, department, facilityId } = request;

  // LEVEL_99: システム管理者 - 全データ
  if (permissionLevel === 99) {
    return await getFullReport();
  }

  // LEVEL_16-17: 組織開発 - 生データ含む全データ
  if (permissionLevel >= 16) {
    return await getOrganizationDevelopmentReport();
  }

  // LEVEL_14-15: 人事部門 - 法人全体統計
  if (permissionLevel >= 14) {
    return await getCorporateReport();
  }

  // LEVEL_12-13: 施設経営層 - 施設全体統計
  if (permissionLevel >= 12) {
    return await getFacilityReport(facilityId);
  }

  // LEVEL_9-11: 部長級 - 施設全体統計
  if (permissionLevel >= 9) {
    return await getFacilityReport(facilityId);
  }

  // LEVEL_7-8: 師長・課長級 - 部署統計
  if (permissionLevel >= 7) {
    return await getDepartmentReport(department);
  }

  // LEVEL_5-6: 主任級 - チーム統計
  if (permissionLevel >= 5) {
    return await getTeamReport(requesterId);
  }

  // LEVEL_1-4: 一般職員 - 自分の提案のみ
  return await getPersonalProposalReport(requesterId);
}
```

---

## 📈 レポート内容の違い

### 一般職員（LEVEL_1-4）
```
【自分の提案履歴のみ】
- 提案ID: 12345
- 提案内容: 業務効率化...
- 到達率: 85%
- 判断: 承認
- 判断者: 田中師長
- 判断理由: 現在のスコアで十分...
```

### 主任級（LEVEL_5-6）
```
【自分の判断履歴】
- 今月の判断: 5件
- 承認: 3件 (60%)
- ダウングレード: 1件 (20%)
- 不採用: 1件 (20%)
- 平均判断日数: 1.8日

【チーム統計】
- チームの期限到達提案: 10件
- チーム全体の承認率: 70%
```

### 師長・課長級（LEVEL_7-8）
```
【部署統計】
- 部署の期限到達提案: 25件
- 部署全体の承認率: 72%
- 主任別の判断状況:
  - A主任: 承認率80%, 平均1.2日
  - B主任: 承認率70%, 平均2.5日
```

### 人事部門（LEVEL_14-15）
```
【法人全体統計】
- 総件数: 180件
- 法人全体承認率: 68%
- 施設別:
  - A病院: 60件, 承認率70%
  - B病院: 50件, 承認率65%
  - Cクリニック: 70件, 承認率68%

【全管理職比較】
- 判断スピードランキング
- 承認率分布
- 施設間比較
```

### 組織開発（LEVEL_16-17）
```
【詳細分析】
+ 法人全体統計
+ 全管理職比較
+ 到達率と判断の相関分析
+ 提案タイプ別分析
+ トレンド分析（月次推移）
+ 生データCSVエクスポート
+ BIツール連携
```

---

## 🎓 データ連携設計（職員カルテシステムとの統合）

### VoiceDrive → 職員カルテ（データ送信）

```typescript
// 判断時に自動送信
await sendToMedicalSystem({
  eventType: 'expired_escalation_decision',
  postId: '...',
  deciderId: '...',
  deciderLevel: user.permissionLevel, // 重要！
  decision: '...',
  department: user.department,
  facilityId: user.facilityId,
  // ...
});
```

### 職員カルテ → VoiceDrive（レポート参照）

```typescript
// VoiceDrive側でレポート表示
const report = await mcpClient.call('voicedrive.expiredEscalation.getReport', {
  requesterId: currentUser.id,
  permissionLevel: currentUser.permissionLevel, // これで権限判定
  department: currentUser.department,
  facilityId: currentUser.facilityId,
});
```

---

## ✅ まとめ

### 主要ユーザー（優先順位）

1. **🏆 LEVEL_14-17（人事部・組織開発）** - メインユーザー
   - 法人全体の統計
   - 管理職評価
   - 月次・年次レポート

2. **🥈 LEVEL_7-13（師長・部長・院長）** - セカンダリユーザー
   - 部署・施設の統計
   - マネジメント判断材料

3. **🥉 LEVEL_5-6（主任級）** - 定期利用
   - 自己振り返り
   - チーム管理

4. **LEVEL_18（理事長）** - 四半期・年次
   - 経営判断材料

5. **LEVEL_1-4（一般職員）** - 時々参照
   - 自分の提案履歴のみ

---

**作成者**: Claude AI Assistant
**最終更新**: 2025年10月19日
**ステータス**: 設計完了・実装待ち
