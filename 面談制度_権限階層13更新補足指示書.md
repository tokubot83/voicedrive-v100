# VoiceDrive面談制度 - 権限階層13レベル更新補足指示書

## 概要
本書は、既に提供済みの「VoiceDrive面談制度_人事システム統合仕様書」に対する補足指示書です。
権限レベル定義を現行の10階層から最新の13階層システムに更新するための具体的な変更内容を記載します。

## 更新対象
- 権限レベル定義（5.1節）
- 権限別機能マトリクス（5.2節）
- 関連するデータベース設計とAPIの権限チェック部分

## 1. 権限レベル定義の更新

### 変更前（10階層）から変更後（13階層）へ

```typescript
// 更新後の権限レベル定義
enum PermissionLevel {
  LEVEL_1 = 1,   // 一般職員
  LEVEL_2 = 2,   // チーフ・主任
  LEVEL_3 = 3,   // 係長・マネージャー
  LEVEL_4 = 4,   // 課長
  LEVEL_5 = 5,   // 人財統括本部 戦略企画・統括管理部門（面談予約1次窓口）
  LEVEL_6 = 6,   // 人財統括本部 キャリア支援部門員（面談実施者）
  LEVEL_7 = 7,   // 人財統括本部 各部門長（面談実施責任者）
  LEVEL_8 = 8,   // 人財統括本部 統括管理部門長
  LEVEL_9 = 9,   // 部長級
  LEVEL_10 = 10, // 本部長級
  LEVEL_11 = 11, // 事業部長級
  LEVEL_12 = 12, // 役員
  LEVEL_13 = 13  // 経営層（代表取締役等）
}
```

### 主な変更点
1. **LEVEL_9**: 「部長・本部長級」から「部長級」のみに変更
2. **LEVEL_10**: 「役員・経営層」から「本部長級」に変更
3. **LEVEL_11**: 新規追加 - 「事業部長級」
4. **LEVEL_12**: 新規追加 - 「役員」
5. **LEVEL_13**: 新規追加 - 「経営層（代表取締役等）」

## 2. 権限別機能マトリクスの更新

### 更新後の機能マトリクス

| 機能 | L1-4 | L5 | L6 | L7-8 | L9-10 | L11 | L12-13 |
|------|------|----|----|------|-------|-----|--------|
| 面談予約申請 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 自分の予約確認 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 予約管理画面 | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| スケジュール変更 | ❌ | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ |
| 時間枠ブロック | ❌ | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ |
| 面談実施 | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 面談記録作成 | ❌ | ❌ | ✅ | ✅ | ❌ | ❌ | ❌ |
| 統計レポート | ❌ | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ |
| 全体統計閲覧 | ❌ | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |
| システム設定 | ❌ | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ |

### 追加権限の特徴
- **L11（事業部長級）**: 統計レポートとシステム設定へのアクセス権を持つが、面談実施は行わない
- **L12-13（役員・経営層）**: 管理・監視機能に特化し、実務的な面談実施は行わない

## 3. データベース更新箇所

### interview_bookings テーブル
```sql
-- interviewer_levelカラムの制約を更新
ALTER TABLE interview_bookings 
  DROP CONSTRAINT IF EXISTS check_interviewer_level,
  ADD CONSTRAINT check_interviewer_level 
    CHECK (interviewer_level BETWEEN 1 AND 13);
```

### 権限チェック関数の更新
```typescript
// 面談実施権限チェック
function canConductInterview(userLevel: number): boolean {
  return userLevel === 6 || userLevel === 7 || userLevel === 8;
}

// 予約管理権限チェック
function canManageBookings(userLevel: number): boolean {
  return userLevel >= 5;
}

// システム設定権限チェック
function canAccessSystemSettings(userLevel: number): boolean {
  return userLevel >= 8;
}

// 全体統計閲覧権限チェック
function canViewOverallStatistics(userLevel: number): boolean {
  return userLevel >= 8;
}
```

## 4. API実装への影響

### 権限チェックミドルウェアの更新
```typescript
// 権限レベルに基づくアクセス制御
const requirePermissionLevel = (minLevel: number) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const userLevel = req.user.permissionLevel;
    
    if (userLevel < minLevel) {
      return res.status(403).json({
        error: 'Insufficient permission level',
        required: minLevel,
        current: userLevel
      });
    }
    
    next();
  };
};

// エンドポイント例
router.get('/bookings/all', requirePermissionLevel(5), getAllBookings);
router.post('/bookings/:id/conduct', requirePermissionLevel(6), conductInterview);
router.get('/statistics/overall', requirePermissionLevel(8), getOverallStatistics);
router.put('/system/settings', requirePermissionLevel(8), updateSystemSettings);
```

## 5. 移行時の注意事項

1. **既存データの権限レベル更新**
   - 現在のL9（部長・本部長級）を適切にL9（部長級）とL10（本部長級）に分離
   - 現在のL10（役員・経営層）をL12（役員）とL13（経営層）に分離

2. **権限チェックロジックの見直し**
   - 各機能の権限チェックで、新しい13階層に対応した条件分岐を実装
   - 特にL11以上の新規追加レベルの権限設定を慎重に行う

3. **テストケースの更新**
   - 13階層すべてに対する権限チェックのテストケースを作成
   - 境界値テスト（L10→L11、L12→L13など）を重点的に実施

## 6. 実装優先順位

1. **Phase 1**: データベーススキーマの更新（制約の変更）
2. **Phase 2**: 権限チェック関数の更新
3. **Phase 3**: APIミドルウェアの更新
4. **Phase 4**: 既存データの移行
5. **Phase 5**: テストとバリデーション

---

本補足指示書に基づいて、権限階層を13レベルに更新してください。
その他の仕様については、既に提供済みの「VoiceDrive面談制度_人事システム統合仕様書」を参照してください。